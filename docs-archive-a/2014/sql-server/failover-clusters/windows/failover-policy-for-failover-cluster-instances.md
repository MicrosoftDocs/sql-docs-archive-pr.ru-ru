---
title: Политика отработки отказа для экземпляров отказоустойчивого кластера | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- flexible failover policy
ms.assetid: 39ceaac5-42fa-4b5d-bfb6-54403d7f0dc9
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 8d441e5627280cb46168d9ff187d7f43da8b26a6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87659278"
---
# <a name="failover-policy-for-failover-cluster-instances"></a>Политика отработки отказа для экземпляров отказоустойчивого кластера
  В экземпляре отказоустойчивого кластера [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (FCI) в каждый момент времени только один узел может быть владельцем группы ресурсов кластера WSFC. Клиентские запросы в FCI обслуживаются через этот узел. В случае сбоя и неуспешного перезапуска владельцем группы становится другой узел WSFC в экземпляре FCI. Этот процесс называется отработкой отказа. [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] повышает надежность обнаружения сбоев и обеспечивает гибкую политику отработки отказов.  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] FCI зависит от возможностей базовой службы WSFC по обнаружению сбоев. Поэтому порядок отработки отказа для FCI определяется двумя механизмами: собственными функциями WSFC и функциями, добавленными в процессе установки [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .  
  
-   Кластер WSFC поддерживает конфигурацию кворума, что гарантирует наличие уникального назначения отработки отказа при автоматическом переходе на другой ресурс. Служба WSFC определяет, всегда ли кластер имеет оптимальную работоспособность кворума, и соответствующим образом переводит группу ресурсов в режим «в сети» и «вне сети».  
  
-   Активный экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] периодически передает набор диагностических параметров компонентов в группу ресурсов WSFC по выделенному соединению. Группа ресурсов WSFC соблюдает политику отработки отказа, в которой определены условия, вызывающие перезапуск и отработку отказа.  
  
 В этом разделе описывается второй из представленных выше механизмов. Дополнительные сведения о работе WSFC для настройки кворума и обнаружения работоспособности см. в статье [Режим кворума и участвующая в голосовании конфигурация WSFC (SQL Server)](wsfc-quorum-modes-and-voting-configuration-sql-server.md).  
  
> [!IMPORTANT]  
>  Автоматический переход на другой ресурс с участием FCI не допускается в группе доступности AlwaysOn. Однако допускается переход на другой ресурс вручную с участием FCI.  
  
##  <a name="failover-policy-overview"></a><a name="Concepts"></a> Общие сведения о политике отработки отказа  
 Процесс отработки отказа можно разделить на следующие этапы.  
  
1.  [Мониторинг состояния работоспособности](failover-policy-for-failover-cluster-instances.md#monitor)  
  
2.  [Определение сбоев](failover-policy-for-failover-cluster-instances.md#determine)  
  
3.  [Действия при сбоях](failover-policy-for-failover-cluster-instances.md#respond)  
  
###  <a name="monitor-the-health-status"></a><a name="monitor"></a>Мониторинг состояния работоспособности  
 Для FCI отслеживаются три типа состояния работоспособности.  
  
-   [Состояние службы SQL Server](failover-policy-for-failover-cluster-instances.md#service)  
  
-   [Скорость ответа экземпляра SQL Server](failover-policy-for-failover-cluster-instances.md#instance)  
  
-   [Диагностика компонентов SQL Server](failover-policy-for-failover-cluster-instances.md#component)  
  
####  <a name="state-of-the-sql-server-service"></a><a name="service"></a>Состояние службы SQL Server  
 Служба WSFC отслеживает начальное состояние службы SQL Server на активном узле FCI, чтобы обнаружить момент ее остановки.  
  
####  <a name="responsiveness-of-the-sql-server-instance"></a><a name="instance"></a>Скорость реагирования экземпляра SQL Server  
 В момент запуска SQL Server служба WSFC использует библиотеку ресурсов компонента ядра СУБД SQL Server для создания нового соединения в отдельном потоке, который используется исключительно для мониторинга состояния работоспособности. Это гарантирует наличие в экземпляре SQL Server необходимых ресурсов для сообщения о собственном состоянии работоспособности в случае высокой загрузки. С помощью этого выделенного соединения SQL Server запускает системную хранимую процедуру [sp_server_diagnostics (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) в режиме повторения для периодической передачи сведений о состоянии работоспособности компонентов SQL Server в библиотеку ресурсов.  
  
 Библиотека DLL ресурсов определяет скорость ответа экземпляра SQL Server, оценивая время ожидания проверки работоспособности. Свойство HealthCheckTimeout определяет, сколько времени библиотека ресурсов будет ожидать получения данных от хранимой процедуры sp_server_diagnostics до того, как экземпляр SQL Server будет признан не отвечающим на запросы службы WSFC. Это свойство настраивается с помощью T-SQL, а также в оснастке «Диспетчер отказоустойчивости кластеров». Дополнительные сведения см. в разделе [Configure HealthCheckTimeout Property Settings](configure-healthchecktimeout-property-settings.md). В следующих пунктах описывается влияние этого свойства на значений времени ожидания и интервала повтора.  
  
-   Библиотека ресурсов вызывает хранимую процедуру sp_server_diagnostics и устанавливает интервал повтора равным одной трети значения параметра HealthCheckTimeout.  
  
-   Если хранимая процедура sp_server_diagnostics выполняется слишком медленно или не возвращает данные, библиотека ресурсов будет ожидать в течение времени, равного интервалу HealthCheckTimeout, а затем сообщит службе WSFC об отсутствии ответа экземпляра SQL Server.  
  
-   Если выделенное соединение теряется, то библиотека ресурсов повторяет подключение к экземпляру SQL Server в течение интервала, указанного в свойстве HealthCheckTimeout, а затем сообщает службе WSFC об отсутствии ответа экземпляра SQL Server.  
  
####  <a name="sql-server-component-diagnostics"></a><a name="component"></a> Диагностика компонентов SQL Server  
 Системная хранимая процедура sp_server_diagnostics периодически собирает диагностические данные о компонентах в экземпляре SQL Server. Собранные диагностические данные отображаются в виде строки для каждого из следующих компонентов и передаются в вызывающий поток.  
  
1.  система  
  
2.  ресурс  
  
3.  обработка запросов  
  
4.  io_subsystem  
  
5.  события  
  
 Система, ресурс и компоненты процесса запроса используются для обнаружения сбоя. Подсистема io_subsytem и компоненты событий используются только для диагностики.  
  
 Каждый набор строк данных также записывается в журнал диагностики кластеров SQL Server. Дополнительные сведения см. в статье [Просмотр и чтение журнала диагностики экземпляра отказоустойчивого кластера](view-and-read-failover-cluster-instance-diagnostics-log.md).  
  
> [!TIP]  
>  Хранимая процедура sp_server_diagnostics применяется в технологии SQL Server AlwaysOn, но также доступна для использования в любом экземпляре SQL Server для обнаружения и устранения проблем.  
  
####  <a name="determining-failures"></a><a name="determine"></a> Определение сбоев  
 Библиотека ресурсов компонент ядра СУБД SQL Server определяет, является ли обнаруженное состояние работоспособности условием сбоя, используя свойство FailureConditionLevel. Свойство FailureConditionLevel определяет, какие обнаруженные состояния работоспособности вызывают перезапуск или отработку отказа. Доступно несколько уровней вариантов, от запрета автоматического перезапуска или отработки отказа до всех возможных условий, приводящих к автоматическому перезапуску или отработке отказа. Дополнительные сведения о настройке этого свойства см. в разделе [Configure FailureConditionLevel Property Settings](configure-failureconditionlevel-property-settings.md).  
  
 Условия сбоя устанавливаются по прогрессирующей шкале. Каждый уровень, с 1 по 5, включает все условия предыдущих уровней, а также собственные дополнительные условия. Это означает, что с каждым уровнем вероятность отработки отказа или перезапуска повышается. Уровни условий сбоя описаны в следующей таблице.  
  
 Ознакомьтесь со статьей [sp_server_diagnostics (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql), поскольку эта системная хранимая процедура играет важную роль в уровнях условий сбоя.  
  
|Level|Условие|Описание|  
|-----------|---------------|-----------------|  
|0|Без автоматической отработки отказа или перезапуска|Указывает, что при любых условиях сбоя отработка отказа или перезапуск не будет выполняться автоматически. Этот уровень предназначен только для обслуживания системы.|  
|1|Отработка отказа или перезапуск при отключении сервера|Указывает, что при возникновении одного из следующих условий будет выполнен перезапуск или отработка отказа.<br /><br /> Служба SQL Server остановлена.|  
|2|Отработка отказа или перезапуск, если сервер не отвечает|Указывает, что сервер перезапускается или вызывается отработка отказа на резервный ресурс при возникновении одного из следующих условий.<br /><br /> Служба SQL Server остановлена.<br /><br /> Экземпляр SQL Server не отвечает (библиотеке ресурсов не удается получить данные от процедуры sp_server_diagnostics в течение времени, заданного HealthCheckTimeout).|  
|3*|Отработка отказа или перезапуск при возникновении критических ошибок сервера|Указывает, что сервер перезапускается или вызывается отработка отказа на резервный ресурс при возникновении одного из следующих условий.<br /><br /> Служба SQL Server остановлена.<br /><br /> Экземпляр SQL Server не отвечает (библиотеке ресурсов не удается получить данные от процедуры sp_server_diagnostics в течение времени, заданного HealthCheckTimeout).<br /><br /> Системная хранимая процедура sp_server_diagnostics возвращает сообщение "системная ошибка".|  
|4|Отработка отказа или перезапуск при возникновении умеренных ошибок сервера|Указывает, что сервер перезапускается или вызывается отработка отказа на резервный ресурс при возникновении одного из следующих условий.<br /><br /> Служба SQL Server остановлена.<br /><br /> Экземпляр SQL Server не отвечает (библиотеке ресурсов не удается получить данные от процедуры sp_server_diagnostics в течение времени, заданного HealthCheckTimeout).<br /><br /> Системная хранимая процедура sp_server_diagnostics возвращает сообщение "системная ошибка".<br /><br /> Системная хранимая процедура sp_server_diagnostics возвращает сообщение "ошибка ресурса".|  
|5|Отработка отказа или перезапуск при всех соответствующих условиях|Указывает, что сервер перезапускается или вызывается отработка отказа на резервный ресурс при возникновении одного из следующих условий.<br /><br /> Служба SQL Server остановлена.<br /><br /> Экземпляр SQL Server не отвечает (библиотеке ресурсов не удается получить данные от процедуры sp_server_diagnostics в течение времени, заданного HealthCheckTimeout).<br /><br /> Системная хранимая процедура sp_server_diagnostics возвращает сообщение "системная ошибка".<br /><br /> Системная хранимая процедура sp_server_diagnostics возвращает сообщение "ошибка ресурса".<br /><br /> Системная хранимая процедура sp_server_diagnostics возвращает сообщение "ошибка обработки запроса".|  
  
 *Значение по умолчанию  
  
####  <a name="responding-to-failures"></a><a name="respond"></a>Реагирование на сбои  
 После обнаружения одного или нескольких условий сбоя реакция службы WSFC зависит от состояния кворума WSFC и параметров перезапуска и отработки отказа для группы ресурсов FCI. Если в FCI потерян кворум WSFC, то весь экземпляр FCI переводится в режим «вне сети» и высокий уровень доступности FCI утрачивается. Если в FCI сохраняется кворум WSFC, то служба WSFC сначала может перезапустить сбойный узел, а затем выполнить отработку отказа, если попытки перезапуска не завершаются успехом. Параметры перезапуска и отработки отказа настраиваются в оснастке «Диспетчер отказоустойчивости кластеров». Дополнительные сведения об этих параметрах см. в разделе [ \<Resource> Свойства: вкладка "политики"](https://technet.microsoft.com/library/cc725685.aspx).  
  
 Дополнительные сведения о поддержании работоспособности кворума см. в статье [Режимы кворума и конфигурация голосования WSFC (SQL Server)](wsfc-quorum-modes-and-voting-configuration-sql-server.md).  
  
## <a name="see-also"></a>См. также:  
 [ALTER SERVER CONFIGURATION (Transact-SQL)](/sql/t-sql/statements/alter-server-configuration-transact-sql)  
  
  
