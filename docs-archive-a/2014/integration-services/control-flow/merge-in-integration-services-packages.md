---
title: Предложение MERGE в пакетах служб Integration Services | Документы Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
helpviewer_keywords:
- MERGE statement [SQL Server]
ms.assetid: 7e44a5c2-e6d6-4fe2-a079-4f95ccdb147b
author: chugugrace
ms.author: chugu
ms.openlocfilehash: cc6de738d44b91a9e2a4885978ba4a46dfede8cf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658329"
---
# <a name="merge-in-integration-services-packages"></a><span data-ttu-id="56da5-102">Предложение MERGE в пакетах служб Integration Services</span><span class="sxs-lookup"><span data-stu-id="56da5-102">MERGE in Integration Services Packages</span></span>
  <span data-ttu-id="56da5-103">Для текущего выпуска [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)]инструкция SQL в задаче "Выполнить SQL" может содержать инструкцию MERGE.</span><span class="sxs-lookup"><span data-stu-id="56da5-103">In the current release of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)], the SQL statement in an Execute SQL task can contain a MERGE statement.</span></span> <span data-ttu-id="56da5-104">Эта инструкция MERGE позволяет выполнять несколько операций INSERT, UPDATE и DELETE в единой инструкции.</span><span class="sxs-lookup"><span data-stu-id="56da5-104">This MERGE statement enables you to accomplish multiple INSERT, UPDATE, and DELETE operations in a single statement.</span></span>  
  
 <span data-ttu-id="56da5-105">Для использования в пакете инструкции MERGE выполните следующее.</span><span class="sxs-lookup"><span data-stu-id="56da5-105">To use the MERGE statement in a package, follow these steps:</span></span>  
  
-   <span data-ttu-id="56da5-106">Создайте задачу потока данных, которая загружает данные из источника, преобразует их и сохраняет во временную или промежуточную таблицу.</span><span class="sxs-lookup"><span data-stu-id="56da5-106">Create a Data Flow task that loads, transforms, and saves the source data to a temporary or staging table.</span></span>  
  
-   <span data-ttu-id="56da5-107">Создайте задачу «Выполнение SQL», содержащую инструкцию MERGE.</span><span class="sxs-lookup"><span data-stu-id="56da5-107">Create an Execute SQL task that contains the MERGE statement.</span></span>  
  
-   <span data-ttu-id="56da5-108">Соедините задачу потока данных с задачей «Выполнение SQL» и используйте данные из промежуточной таблицы в качестве входных данных инструкции MERGE.</span><span class="sxs-lookup"><span data-stu-id="56da5-108">Connect the Data Flow task to the Execute SQL task, and use the data in the staging table as the input for the MERGE statement.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="56da5-109">Хотя инструкции MERGE в этом случае обычно требуется промежуточная таблица, все равно эта инструкция обычно выполняется быстрее, чем уточняющие запросы для всех строк, выполняемые преобразованием «Уточняющий запрос».</span><span class="sxs-lookup"><span data-stu-id="56da5-109">Although a MERGE statement typically requires a staging table in this scenario, the performance of the MERGE statement usually exceeds that of the row-by-row lookup performed by the Lookup transformation.</span></span> <span data-ttu-id="56da5-110">Инструкция MERGE полезна также при большом размере таблицы уточняющих запросов. В этом случае преобразованию «Уточняющий запрос» может не хватить памяти для кэширования ссылочной таблицы.</span><span class="sxs-lookup"><span data-stu-id="56da5-110">MERGE is also useful when the large size of a lookup table would test the memory that is available to the Lookup transformation for caching its reference table.</span></span>  
  
 <span data-ttu-id="56da5-111">В оставшейся части данного раздела обсуждаются некоторые дополнительные способы применения инструкции MERGE.</span><span class="sxs-lookup"><span data-stu-id="56da5-111">The remainder of this topic discusses some additional uses for the MERGE statement.</span></span>  
  
 <span data-ttu-id="56da5-112">Образец целевого компонента, который поддерживает использование инструкции MERGE, см. в примере [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215)сообщества CodePlex.</span><span class="sxs-lookup"><span data-stu-id="56da5-112">For a sample destination component that supports the use of the MERGE statement, see the CodePlex community sample, [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215).</span></span>  
  
## <a name="using-merge"></a><span data-ttu-id="56da5-113">Использование инструкции MERGE</span><span class="sxs-lookup"><span data-stu-id="56da5-113">Using MERGE</span></span>  
 <span data-ttu-id="56da5-114">Обычно инструкция MERGE используется для применения изменений, в том числе операций вставки, редактирования и удаления, выполненных в одной таблице, к другой таблице.</span><span class="sxs-lookup"><span data-stu-id="56da5-114">Typically, you use the MERGE statement when you want to apply changes that include inserts, updates, and deletions from one table to another table.</span></span> <span data-ttu-id="56da5-115">До появления [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]для этого процесса было необходимо преобразование «Уточняющий запрос» и несколько преобразований «Команда OLE DB».</span><span class="sxs-lookup"><span data-stu-id="56da5-115">Prior to [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], this process required both a Lookup transformation and multiple OLE DB Command transformations.</span></span> <span data-ttu-id="56da5-116">Преобразование «Уточняющий запрос» выполняло уточняющие запросы к каждой строке, чтобы определить, какие из них были добавлены или изменены.</span><span class="sxs-lookup"><span data-stu-id="56da5-116">The Lookup transformation performed a row-by-row lookup to determine whether each row was new or changed.</span></span> <span data-ttu-id="56da5-117">Затем преобразования «Команда OLE DB» выполняли необходимые операции INSERT, UPDATE и DELETE.</span><span class="sxs-lookup"><span data-stu-id="56da5-117">The OLE DB Command transformations then performed the necessary INSERT, UPDATE, and DELETE operations.</span></span> <span data-ttu-id="56da5-118">Начиная с [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], и преобразование «Уточняющий запрос», и соответствующие преобразования «Команда OLE DB» заменила единственная инструкция MERGE.</span><span class="sxs-lookup"><span data-stu-id="56da5-118">Beginning in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], a single MERGE statement can replace both the Lookup transformation and the corresponding OLE DB Command transformations.</span></span>  
  
### <a name="merge-with-incremental-loads"></a><span data-ttu-id="56da5-119">Инструкция MERGE с добавочной загрузкой</span><span class="sxs-lookup"><span data-stu-id="56da5-119">MERGE with Incremental Loads</span></span>  
 <span data-ttu-id="56da5-120">В [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] внесены изменения в систему отслеживания измененных данных, поэтому процесс добавочной загрузки в хранилище данных стал проще и безопаснее.</span><span class="sxs-lookup"><span data-stu-id="56da5-120">The change data capture functionality that is new in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] makes it easier to perform incremental loads reliably to a data warehouse.</span></span> <span data-ttu-id="56da5-121">В качестве альтернативы параметризованным преобразованиям «Команда OLE DB», с помощью которых производились вставки и обновления, можно использовать инструкцию MERGE для объединения этих операций.</span><span class="sxs-lookup"><span data-stu-id="56da5-121">As an alternative to using parameterized OLE DB Command transformations to perform the inserts and the updates, you can use the MERGE statement to combine both operations.</span></span>  
  
 <span data-ttu-id="56da5-122">Дополнительные сведения см. в разделе [Применение изменений в назначении](../change-data-capture/apply-the-changes-to-the-destination.md).</span><span class="sxs-lookup"><span data-stu-id="56da5-122">For more information, see [Apply the Changes to the Destination](../change-data-capture/apply-the-changes-to-the-destination.md).</span></span>  
  
#### <a name="merge-in-other-scenarios"></a><span data-ttu-id="56da5-123">Инструкция MERGE в других сценариях</span><span class="sxs-lookup"><span data-stu-id="56da5-123">MERGE in Other Scenarios</span></span>  
 <span data-ttu-id="56da5-124">В следующих сценариях инструкцию MERGE можно использовать как внутри, так и вне пакета служб [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="56da5-124">In the following scenarios, you can use the MERGE statement either outside or inside an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package.</span></span> <span data-ttu-id="56da5-125">Однако пакетам служб [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] часто приходится загружать эти данные из нескольких разнородных источников, а затем объединять их и проводить очистку.</span><span class="sxs-lookup"><span data-stu-id="56da5-125">However, an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package is often required to load this data from multiple heterogeneous sources, and then to combine and cleanse the data.</span></span> <span data-ttu-id="56da5-126">Вместо этого можно использовать в пакете инструкцию MERGE. Это удобно и упрощает поддержку.</span><span class="sxs-lookup"><span data-stu-id="56da5-126">Therefore, you might consider using the MERGE statement in a package for convenience and ease of maintenance.</span></span>  
  
##### <a name="track-buying-habits"></a><span data-ttu-id="56da5-127">Отслеживание привычек покупателей</span><span class="sxs-lookup"><span data-stu-id="56da5-127">Track Buying Habits</span></span>  
 <span data-ttu-id="56da5-128">Предположим, что в хранилище данных существует таблица FactBuyingHabits, в которой отслеживаются последние даты покупки каждым клиентом определенного товара.</span><span class="sxs-lookup"><span data-stu-id="56da5-128">The FactBuyingHabits table in the data warehouse tracks the last date on which a customer bought a given product.</span></span> <span data-ttu-id="56da5-129">Таблица состоит из столбцов ProductID, CustomerID и PurchaseDate.</span><span class="sxs-lookup"><span data-stu-id="56da5-129">The table consists of ProductID, CustomerID and PurchaseDate columns.</span></span> <span data-ttu-id="56da5-130">Каждую неделю транзакционная база данных создает таблицу PurchaseRecords, куда входят покупки этой недели.</span><span class="sxs-lookup"><span data-stu-id="56da5-130">Every week, the transactional database generates a PurchaseRecords table that includes the purchases made during that week.</span></span> <span data-ttu-id="56da5-131">Цель — применить единственную инструкцию MERGE для добавления данных из таблицы PurchaseRecords в таблицу FactBuyingHabits.</span><span class="sxs-lookup"><span data-stu-id="56da5-131">The objective is to use a single MERGE statement to merge the information in the PurchaseRecords table into the FactBuyingHabits table.</span></span> <span data-ttu-id="56da5-132">Для пар товар-заказчик, которые не существовали, инструкция MERGE добавляет новые строки.</span><span class="sxs-lookup"><span data-stu-id="56da5-132">For product-customer pairs that do not exist, the MERGE statement inserts new rows.</span></span> <span data-ttu-id="56da5-133">Для существующих пар товар-заказчик инструкция MERGE изменяет дату последней покупки.</span><span class="sxs-lookup"><span data-stu-id="56da5-133">For product-customer pairs that exist, the MERGE statement updates the most recent date-of-purchase.</span></span>  
  
###### <a name="track-price-history"></a><span data-ttu-id="56da5-134">Отслеживание журнала цен</span><span class="sxs-lookup"><span data-stu-id="56da5-134">Track Price History</span></span>  
 <span data-ttu-id="56da5-135">Таблица DimBook представляет собой список книг на складе продавца книг. В ней содержится журнал цен на каждую книгу.</span><span class="sxs-lookup"><span data-stu-id="56da5-135">The DimBook table represents the list of books in the inventory of a book seller and identifies the price history of each book.</span></span> <span data-ttu-id="56da5-136">Эта таблица содержит следующие столбцы: ISBN, ProductID, Price, Shelf и IsCurrent.</span><span class="sxs-lookup"><span data-stu-id="56da5-136">This table has these columns: ISBN, ProductID, Price, Shelf, and IsCurrent.</span></span> <span data-ttu-id="56da5-137">Таблица содержит по одной строке на каждую цену, которая когда-либо была у книги.</span><span class="sxs-lookup"><span data-stu-id="56da5-137">This table also has one row for each price the book has had.</span></span> <span data-ttu-id="56da5-138">Одна из строк содержит текущую цену.</span><span class="sxs-lookup"><span data-stu-id="56da5-138">One of these rows contains the current price.</span></span> <span data-ttu-id="56da5-139">Чтобы указать, какая именно строка содержит текущую цену, столбец IsCurrent этой строки содержит значение 1.</span><span class="sxs-lookup"><span data-stu-id="56da5-139">To indicate which row contains the current price, the value of the IsCurrent column for that row is set to 1.</span></span>  
  
 <span data-ttu-id="56da5-140">Еженедельно база данных создает таблицу WeeklyChanges, в которой содержатся изменения цен за неделю и новые книги, добавленные за эту неделю.</span><span class="sxs-lookup"><span data-stu-id="56da5-140">Every week, the database generates a WeeklyChanges table that contains price changes for the week and new books that were added during the week.</span></span> <span data-ttu-id="56da5-141">С помощью единственной инструкции MERGE можно перенести изменения таблицы WeeklyChanges в таблицу DimBook.</span><span class="sxs-lookup"><span data-stu-id="56da5-141">By using a single MERGE statement, you can apply the changes in the WeeklyChanges table to the DimBook table.</span></span> <span data-ttu-id="56da5-142">Инструкция MERGE добавляет новые строки для вновь добавленных книг и изменяет столбец IsCurrent на 0 для строк существующих книг, у которых изменились цены.</span><span class="sxs-lookup"><span data-stu-id="56da5-142">The MERGE statement inserts new rows for newly-added books, and updates the IsCurrent column to 0 for rows of existing books whose prices have changed.</span></span> <span data-ttu-id="56da5-143">Инструкция MERGE также добавляет новые строки для книг, у которых изменились цены, и устанавливает для столбца IsCurrent этих строк значение 1.</span><span class="sxs-lookup"><span data-stu-id="56da5-143">The MERGE statement also inserts new rows for books whose prices have changed, and for these new rows, sets the value of the IsCurrent column to 1.</span></span>  
  
### <a name="merge-a-table-with-new-data-against-the-old-table"></a><span data-ttu-id="56da5-144">Слияние таблицы новых данных со старой таблицей</span><span class="sxs-lookup"><span data-stu-id="56da5-144">Merge a Table with New Data Against the Old Table</span></span>  
 <span data-ttu-id="56da5-145">База данных моделирует свойства объекта, используя "открытую схему". Это значит, что таблица содержит пары имя-значение для каждого свойства.</span><span class="sxs-lookup"><span data-stu-id="56da5-145">The database models the properties of an object by using an "open schema," that is, a table contains name-value pairs for each property.</span></span> <span data-ttu-id="56da5-146">У таблицы Properties три столбца: EntityID, PropertyID и Value.</span><span class="sxs-lookup"><span data-stu-id="56da5-146">The Properties table has three columns: EntityID, PropertyID, and Value.</span></span> <span data-ttu-id="56da5-147">Таблица NewProperties представляет собой обновленную версию таблицы, которую следует синхронизировать с таблицей Properties.</span><span class="sxs-lookup"><span data-stu-id="56da5-147">A NewProperties table that is a newer version of the table has to be synchronized with the Properties table.</span></span> <span data-ttu-id="56da5-148">Для синхронизации этих двух таблиц можно с помощью инструкции MERGE выполнить следующие операции:</span><span class="sxs-lookup"><span data-stu-id="56da5-148">To synchronize these two tables, you can use a single MERGE statement to perform the following operations:</span></span>  
  
-   <span data-ttu-id="56da5-149">удалить свойства из таблицы Properties, если их нет в таблице NewProperties;</span><span class="sxs-lookup"><span data-stu-id="56da5-149">Delete properties from the Properties table if they are absent from the NewProperties table.</span></span>  
  
-   <span data-ttu-id="56da5-150">изменить значения свойств из таблицы Properties на новые, найденные в таблице NewProperties;</span><span class="sxs-lookup"><span data-stu-id="56da5-150">Update values for properties that are in the Properties table with new values found in the NewProperties table.</span></span>  
  
-   <span data-ttu-id="56da5-151">создать новые свойства, присутствующие в таблице NewProperties, если их нет в таблице Properties.</span><span class="sxs-lookup"><span data-stu-id="56da5-151">Insert new properties for properties that are in the NewProperties table but are not found in the Properties table.</span></span>  
  
 <span data-ttu-id="56da5-152">Этот подход применяется к сценариям, похожим на сценарий репликации, цель которых — поддерживать синхронизацию данных в двух таблицах на двух разных серверах.</span><span class="sxs-lookup"><span data-stu-id="56da5-152">This approach is useful in scenarios that resemble replication scenarios, where the objective is to keep data in two tables on two servers synchronized.</span></span>  
  
### <a name="track-inventory"></a><span data-ttu-id="56da5-153">Ведение инвентарного учета</span><span class="sxs-lookup"><span data-stu-id="56da5-153">Track Inventory</span></span>  
 <span data-ttu-id="56da5-154">База данных Inventory содержит таблицу ProductsInventory, в которой есть столбцы ProductID и StockOnHand.</span><span class="sxs-lookup"><span data-stu-id="56da5-154">The Inventory database has a ProductsInventory table that has ProductID and StockOnHand columns.</span></span> <span data-ttu-id="56da5-155">Таблица Shipments со столбцами ProductID, CustomerID и Quantity хранит данные об отгрузке товаров заказчикам.</span><span class="sxs-lookup"><span data-stu-id="56da5-155">A Shipments table with ProductID, CustomerID, and Quantity columns tracks shipments of products to customers.</span></span> <span data-ttu-id="56da5-156">Таблица ProductInventory должна ежедневно обновляться на основании данных из таблицы Shipments.</span><span class="sxs-lookup"><span data-stu-id="56da5-156">The ProductInventory table has to be updated daily based on information in the Shipments table.</span></span> <span data-ttu-id="56da5-157">Уменьшить указанное в таблице ProductInventory количество товара на основании данных об отгрузке можно с помощью единственной инструкции MERGE.</span><span class="sxs-lookup"><span data-stu-id="56da5-157">A single MERGE statement can reduce the inventory in the ProductInventory table based on the shipments made.</span></span> <span data-ttu-id="56da5-158">Если запас товара на складе упал до 0, инструкция MERGE может также удалить строку этого продукта из таблицы ProductInventory.</span><span class="sxs-lookup"><span data-stu-id="56da5-158">If the inventory for a product has been reduced to 0, that MERGE statement can also delete that product row from the ProductInventory table.</span></span>  
  
  
