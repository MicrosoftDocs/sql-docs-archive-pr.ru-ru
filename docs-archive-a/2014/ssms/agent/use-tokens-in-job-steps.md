---
title: Использование токенов в шагах задания | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ssms
ms.topic: conceptual
helpviewer_keywords:
- job steps [SQL Server Agent]
- security [SQL Server Agent], enabling alert job step tokens
- SQL Server Agent jobs, job steps
- tokens [SQL Server]
- escape macros [SQL Server Agent]
ms.assetid: 105bbb66-0ade-4b46-b8e4-f849e5fc4d43
author: stevestein
ms.author: sstein
ms.openlocfilehash: 9d90b6660dd4b65e4e1d9b832b39ffaa275c83bc
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87751628"
---
# <a name="use-tokens-in-job-steps"></a><span data-ttu-id="3928a-102">Использование токенов в шагах задания</span><span class="sxs-lookup"><span data-stu-id="3928a-102">Use Tokens in Job Steps</span></span>
  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="3928a-103">Агент позволяет применять токены в скриптах шагов заданий на языке [!INCLUDE[tsql](../../includes/tsql-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="3928a-103">Agent allows you to use tokens in [!INCLUDE[tsql](../../includes/tsql-md.md)] job step scripts.</span></span> <span data-ttu-id="3928a-104">Применение токенов при написании шагов заданий обеспечивают такую же гибкость, какую дают переменные при написании программ.</span><span class="sxs-lookup"><span data-stu-id="3928a-104">Using tokens when you write your job steps gives you the same flexibility that variables provide when you write software programs.</span></span> <span data-ttu-id="3928a-105">После добавления токена в скрипт шага задания агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] замещает токен во время выполнения, до того как шаг задания выполняется подсистемой [!INCLUDE[tsql](../../includes/tsql-md.md)]</span><span class="sxs-lookup"><span data-stu-id="3928a-105">After you insert a token in a job step script, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent replaces the token at run time, before the job step is executed by the [!INCLUDE[tsql](../../includes/tsql-md.md)] subsystem.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="3928a-106">Начиная с [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] с пакетом обновления 1 (SP1), синтаксис токена шага задания агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] был изменен.</span><span class="sxs-lookup"><span data-stu-id="3928a-106">Starting with [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] Service Pack 1, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job step token syntax changed.</span></span> <span data-ttu-id="3928a-107">В результате все токены, используемые в шагах заданий, теперь должны сопровождаться экранирующим макросом, в противном случае они вызовут ошибку.</span><span class="sxs-lookup"><span data-stu-id="3928a-107">As a result, an escape macro must now accompany all tokens used in job steps, or else those job steps will fail.</span></span> <span data-ttu-id="3928a-108">Использование управляющих макросов и обновление шагов заданий агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , в которых используются токены, описывается в разделах «Основные сведения об использовании токенов», «Макросы и токены агента[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] » и «Обновление шагов заданий для использования маркеров».</span><span class="sxs-lookup"><span data-stu-id="3928a-108">Using escape macros and updating your [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job steps that use tokens are described in the following sections, "Understanding Using Tokens," "[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent Tokens and Macros," and "Updating Job Steps to Use Macros."</span></span> <span data-ttu-id="3928a-109">Кроме того, также изменился синтаксис [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] , при котором для обнаружения токенов шагов заданий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (например «`[DATE]`») использовались квадратные скобки.</span><span class="sxs-lookup"><span data-stu-id="3928a-109">In addition, the [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] syntax, which used square brackets to call out [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job step tokens (for example, "`[DATE]`") has also changed.</span></span> <span data-ttu-id="3928a-110">Теперь необходимо заключить имена токенов в круглые скобки и поставить знак доллара (`$`) в начале синтаксиса токена.</span><span class="sxs-lookup"><span data-stu-id="3928a-110">You must now enclose token names in parentheses and place a dollar sign (`$`) at the beginning of the token syntax.</span></span> <span data-ttu-id="3928a-111">Пример:</span><span class="sxs-lookup"><span data-stu-id="3928a-111">For example:</span></span>  
>   
>  <span data-ttu-id="3928a-112">`$(ESCAPE_` *имя макроса* `(DATE))`</span><span class="sxs-lookup"><span data-stu-id="3928a-112">`$(ESCAPE_` *macro name* `(DATE))`</span></span>  
  
## <a name="understanding-using-tokens"></a><span data-ttu-id="3928a-113">Основные сведения об использовании токенов</span><span class="sxs-lookup"><span data-stu-id="3928a-113">Understanding Using Tokens</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="3928a-114">Все пользователи Windows с разрешением на запись в журнал событий Windows могут получить доступ к шагам заданий, которые активированы предупреждениями агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] или инструментария WMI.</span><span class="sxs-lookup"><span data-stu-id="3928a-114">Any Windows user with write permissions on the Windows Event Log can access job steps that are activated by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent alerts or WMI alerts.</span></span> <span data-ttu-id="3928a-115">Чтобы избежать этого нарушения безопасности, в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] токены агента, которые могут использоваться в заданиях, активированных предупреждениями, по умолчанию отключены.</span><span class="sxs-lookup"><span data-stu-id="3928a-115">To avoid this security risk, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent tokens that can be used in jobs activated by alerts are disabled by default.</span></span> <span data-ttu-id="3928a-116">Эти токены: **a-DBN**, **a-SVR**, **a-Err**, **a-уровень серьезности**, **a-MSG**. и **WMI ( *`property`* )**.</span><span class="sxs-lookup"><span data-stu-id="3928a-116">These tokens are: **A-DBN**, **A-SVR**, **A-ERR**, **A-SEV**, **A-MSG**., and **WMI(*`property`*)**.</span></span> <span data-ttu-id="3928a-117">Обратите внимание, что в этом выпуске использование токенов распространяется на все оповещения.</span><span class="sxs-lookup"><span data-stu-id="3928a-117">Note that in this release, use of tokens is extended to all alerting.</span></span>  
>   
>  <span data-ttu-id="3928a-118">Если необходимо использовать эти токены, убедитесь, что только члены доверенных групп безопасности Windows, таких как группа «Администраторы», обладают разрешением на работу с журналом событий компьютера, на котором находится [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="3928a-118">If you need to use these tokens, first ensure that only members of trusted Windows security groups, such as the Administrators group, have write permissions on the Event Log of the computer where [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] resides.</span></span> <span data-ttu-id="3928a-119">Затем, чтобы включить эти токены, щелкните правой кнопкой мыши элемент **Агент SQL Server** в обозревателе объектов, выберите пункт меню **Свойства**и на странице **Система предупреждений** установите флажок **Заменить токены всех ответов заданий на предупреждения** .</span><span class="sxs-lookup"><span data-stu-id="3928a-119">Then, right-click **SQL Server Agent** in Object Explorer, select **Properties**, and on the **Alert System** page, select **Replace tokens for all job responses to alerts** to enable these tokens.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="3928a-120">Замена токена агента выполняется просто и эффективно: агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] заменяет токен точным строковым литералом.</span><span class="sxs-lookup"><span data-stu-id="3928a-120">Agent token replacement is simple and efficient: [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent replaces an exact literal string value for the token.</span></span> <span data-ttu-id="3928a-121">Все токены обрабатываются с учетом регистра.</span><span class="sxs-lookup"><span data-stu-id="3928a-121">All tokens are case-sensitive.</span></span> <span data-ttu-id="3928a-122">Шаги заданий должны это учитывать для учетной записи и правильно заключать в кавычки применяемые токены или преобразовывать замещающие строки к верному типу данных.</span><span class="sxs-lookup"><span data-stu-id="3928a-122">Your job steps must take this into account and correctly quote the tokens you use or convert the replacement string to the correct data type.</span></span>  
  
 <span data-ttu-id="3928a-123">Например, чтобы напечатать имя базы данных в шаге задания, можно использовать следующую инструкцию:</span><span class="sxs-lookup"><span data-stu-id="3928a-123">For example, you might use the following statement to print the name of the database in a job step:</span></span>  
  
 `PRINT N'Current database name is $(ESCAPE_SQUOTE(A-DBN))' ;`  
  
 <span data-ttu-id="3928a-124">В этом примере макрос **ESCAPE_SQUOTE** добавляется с токеном **A-DBN** .</span><span class="sxs-lookup"><span data-stu-id="3928a-124">In this example, the **ESCAPE_SQUOTE** macro is inserted with the **A-DBN** token.</span></span> <span data-ttu-id="3928a-125">Во время выполнения токен **A-DBN** будет заменен соответствующим именем базы данных.</span><span class="sxs-lookup"><span data-stu-id="3928a-125">At run time, the **A-DBN** token will be replaced with the appropriate database name.</span></span> <span data-ttu-id="3928a-126">Управляющий макрос экранирует все одиночные кавычки, которые случайно передаются в строку замещения токена.</span><span class="sxs-lookup"><span data-stu-id="3928a-126">The escape macro escapes any single quotation marks that may be inadvertently passed in the token replacement string.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="3928a-127">Агент заместит символ одиночной кавычки двумя одиночными кавычками в конечной строке.</span><span class="sxs-lookup"><span data-stu-id="3928a-127">Agent will replace one single quotation mark with two single quotation marks in the final string.</span></span>  
  
 <span data-ttu-id="3928a-128">Например, если замещающая токен строка `AdventureWorks2012'SELECT @@VERSION --`, то команда, выполняемая агентом [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имеет вид:</span><span class="sxs-lookup"><span data-stu-id="3928a-128">For example, if the string passed to replace the token is `AdventureWorks2012'SELECT @@VERSION --`, the command executed by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job step will be:</span></span>  
  
 `PRINT N'Current database name is AdventureWorks2012''SELECT @@VERSION --' ;`  
  
 <span data-ttu-id="3928a-129">В этом случае добавленная инструкция `SELECT @@VERSION`не выполняется.</span><span class="sxs-lookup"><span data-stu-id="3928a-129">In this case, the inserted statement, `SELECT @@VERSION`, does not execute.</span></span> <span data-ttu-id="3928a-130">Вместо этого, дополнительный символ одинарной кавычки заставляет сервер анализировать передаваемую инструкцию как строку.</span><span class="sxs-lookup"><span data-stu-id="3928a-130">Instead, the extra single quotation mark causes the server to parse the inserted statement as a string.</span></span> <span data-ttu-id="3928a-131">Если замещающая токен строка не содержит одинарных кавычек, то никакие символы не экранируются и шаг задания, содержащий токен, выполняется так, как и планировалось.</span><span class="sxs-lookup"><span data-stu-id="3928a-131">If the token replacement string does not contain a single quotation mark, no characters are escaped and the job step containing the token executes as intended.</span></span>  
  
 <span data-ttu-id="3928a-132">Чтобы отладить использование токенов в шагах заданий, используйте инструкции вывода на печать, такие как `PRINT N'$(ESCAPE_SQUOTE(SQLDIR))'` и сохраняйте выходные данные шага задания в файл или таблицу.</span><span class="sxs-lookup"><span data-stu-id="3928a-132">To debug token usage in your job steps, use print statements such as `PRINT N'$(ESCAPE_SQUOTE(SQLDIR))'` and save job step output to a file or table.</span></span> <span data-ttu-id="3928a-133">Используйте страницу **Дополнительно** диалогового окна **Свойства шага задания** , чтобы указать выходной файл или таблицу для шага задания.</span><span class="sxs-lookup"><span data-stu-id="3928a-133">Use the **Advanced** page of the **Job Step Properties** dialog box to specify a job step output file or table.</span></span>  
  
## <a name="sql-server-agent-tokens-and-macros"></a><span data-ttu-id="3928a-134">Токены и макросы агента SQL Server</span><span class="sxs-lookup"><span data-stu-id="3928a-134">SQL Server Agent Tokens and Macros</span></span>  
 <span data-ttu-id="3928a-135">В следующей таблице перечислены и описаны токены и макросы, которые поддерживает агент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="3928a-135">The following tables list and describe the tokens and macros that [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent supports.</span></span>  
  
### <a name="sql-server-agent-tokens"></a><span data-ttu-id="3928a-136">Токены агента SQL Server</span><span class="sxs-lookup"><span data-stu-id="3928a-136">SQL Server Agent Tokens</span></span>  
  
|<span data-ttu-id="3928a-137">Токен</span><span class="sxs-lookup"><span data-stu-id="3928a-137">Token</span></span>|<span data-ttu-id="3928a-138">Описание</span><span class="sxs-lookup"><span data-stu-id="3928a-138">Description</span></span>|  
|-----------|-----------------|  
|<span data-ttu-id="3928a-139">**(A-DBN)**</span><span class="sxs-lookup"><span data-stu-id="3928a-139">**(A-DBN)**</span></span>|<span data-ttu-id="3928a-140">имя базы данных.</span><span class="sxs-lookup"><span data-stu-id="3928a-140">Database name.</span></span> <span data-ttu-id="3928a-141">Если задание запускается в результате предупреждения, то имя базы данных автоматически замещает в шаге задания этот токен.</span><span class="sxs-lookup"><span data-stu-id="3928a-141">If the job is run by an alert, the database name value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="3928a-142">**(A-SVR)**</span><span class="sxs-lookup"><span data-stu-id="3928a-142">**(A-SVR)**</span></span>|<span data-ttu-id="3928a-143">Имя сервера.</span><span class="sxs-lookup"><span data-stu-id="3928a-143">Server name.</span></span> <span data-ttu-id="3928a-144">Если задание запускается в результате предупреждения, то имя сервера автоматически замещает в шаге задания этот токен.</span><span class="sxs-lookup"><span data-stu-id="3928a-144">If the job is run by an alert, the server name value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="3928a-145">**(A-ERR)**</span><span class="sxs-lookup"><span data-stu-id="3928a-145">**(A-ERR)**</span></span>|<span data-ttu-id="3928a-146">Номер ошибки.</span><span class="sxs-lookup"><span data-stu-id="3928a-146">Error number.</span></span> <span data-ttu-id="3928a-147">Если задание запускается в результате предупреждения, то номер ошибки автоматически замещает в шаге задания этот токен.</span><span class="sxs-lookup"><span data-stu-id="3928a-147">If the job is run by an alert, the error number value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="3928a-148">**(A-SEV)**</span><span class="sxs-lookup"><span data-stu-id="3928a-148">**(A-SEV)**</span></span>|<span data-ttu-id="3928a-149">Серьезность ошибки.</span><span class="sxs-lookup"><span data-stu-id="3928a-149">Error severity.</span></span> <span data-ttu-id="3928a-150">Если задание запускается в результате предупреждения, то степень серьезности ошибки автоматически замещает в шаге задания этот токен.</span><span class="sxs-lookup"><span data-stu-id="3928a-150">If the job is run by an alert, the error severity value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="3928a-151">**(A-MSG)**</span><span class="sxs-lookup"><span data-stu-id="3928a-151">**(A-MSG)**</span></span>|<span data-ttu-id="3928a-152">Текст сообщения.</span><span class="sxs-lookup"><span data-stu-id="3928a-152">Message text.</span></span> <span data-ttu-id="3928a-153">Если задание запускается в результате предупреждения, то текст сообщения автоматически замещает в шаге задания этот токен.</span><span class="sxs-lookup"><span data-stu-id="3928a-153">If the job is run by an alert, the message text value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="3928a-154">**Дата**</span><span class="sxs-lookup"><span data-stu-id="3928a-154">**(DATE)**</span></span>|<span data-ttu-id="3928a-155">Текущая дата (в формате ГГГГММДД).</span><span class="sxs-lookup"><span data-stu-id="3928a-155">Current date (in YYYYMMDD format).</span></span>|  
|<span data-ttu-id="3928a-156">**INST**</span><span class="sxs-lookup"><span data-stu-id="3928a-156">**(INST)**</span></span>|<span data-ttu-id="3928a-157">Имя экземпляра.</span><span class="sxs-lookup"><span data-stu-id="3928a-157">Instance name.</span></span> <span data-ttu-id="3928a-158">Для экземпляра по умолчанию этот токен будет иметь имя экземпляра по умолчанию, а именно MSSQLSERVER.</span><span class="sxs-lookup"><span data-stu-id="3928a-158">For a default instance, this token will have the default instance name: MSSQLSERVER.</span></span>|  
|<span data-ttu-id="3928a-159">**JOBID**</span><span class="sxs-lookup"><span data-stu-id="3928a-159">**(JOBID)**</span></span>|<span data-ttu-id="3928a-160">Идентификатор задания.</span><span class="sxs-lookup"><span data-stu-id="3928a-160">Job ID.</span></span>|  
|<span data-ttu-id="3928a-161">**(MACH)**</span><span class="sxs-lookup"><span data-stu-id="3928a-161">**(MACH)**</span></span>|<span data-ttu-id="3928a-162">Имя компьютера.</span><span class="sxs-lookup"><span data-stu-id="3928a-162">Computer name.</span></span>|  
|<span data-ttu-id="3928a-163">**(MSSA)**</span><span class="sxs-lookup"><span data-stu-id="3928a-163">**(MSSA)**</span></span>|<span data-ttu-id="3928a-164">Имя главной службы SQLServerAgent.</span><span class="sxs-lookup"><span data-stu-id="3928a-164">Master SQLServerAgent service name.</span></span>|  
|<span data-ttu-id="3928a-165">**(OSCMD)**</span><span class="sxs-lookup"><span data-stu-id="3928a-165">**(OSCMD)**</span></span>|<span data-ttu-id="3928a-166">Префикс для программы, используемой для запуска шагов задания **CmdExec** .</span><span class="sxs-lookup"><span data-stu-id="3928a-166">Prefix for the program used to run **CmdExec** job steps.</span></span>|  
|<span data-ttu-id="3928a-167">**(SQLDIR)**</span><span class="sxs-lookup"><span data-stu-id="3928a-167">**(SQLDIR)**</span></span>|<span data-ttu-id="3928a-168">Каталог, в котором установлен [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="3928a-168">The directory in which [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is installed.</span></span> <span data-ttu-id="3928a-169">Значение по умолчанию — «C:\Program Files\Microsoft SQL Server\MSSQL».</span><span class="sxs-lookup"><span data-stu-id="3928a-169">By default, this value is C:\Program Files\Microsoft SQL Server\MSSQL.</span></span>|  
|<span data-ttu-id="3928a-170">**(SQLLOGDIR)**</span><span class="sxs-lookup"><span data-stu-id="3928a-170">**(SQLLOGDIR)**</span></span>|<span data-ttu-id="3928a-171">Токен замены для пути к папке журнала ошибок SQL Server, например $(ESCAPE_SQUOTE(SQLLOGDIR)).</span><span class="sxs-lookup"><span data-stu-id="3928a-171">Replacement token for the SQL Server error log folder path - for example, $(ESCAPE_SQUOTE(SQLLOGDIR)).</span></span>|  
|<span data-ttu-id="3928a-172">**(STEPCT)**</span><span class="sxs-lookup"><span data-stu-id="3928a-172">**(STEPCT)**</span></span>|<span data-ttu-id="3928a-173">Количество выполнений этого шага (кроме повторных попыток).</span><span class="sxs-lookup"><span data-stu-id="3928a-173">A count of the number of times this step has executed (excluding retries).</span></span> <span data-ttu-id="3928a-174">Может применяться командой шага для принудительного прекращения цикла из нескольких шагов.</span><span class="sxs-lookup"><span data-stu-id="3928a-174">Can be used by the step command to force termination of a multistep loop.</span></span>|  
|<span data-ttu-id="3928a-175">**(STEPID)**</span><span class="sxs-lookup"><span data-stu-id="3928a-175">**(STEPID)**</span></span>|<span data-ttu-id="3928a-176">Идентификатор шага.</span><span class="sxs-lookup"><span data-stu-id="3928a-176">Step ID.</span></span>|  
|<span data-ttu-id="3928a-177">**(SRVR)**</span><span class="sxs-lookup"><span data-stu-id="3928a-177">**(SRVR)**</span></span>|<span data-ttu-id="3928a-178">Имя компьютера, на котором выполняется [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="3928a-178">Name of the computer running [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="3928a-179">В случае именованного экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имя компьютера включается в имя экземпляра.</span><span class="sxs-lookup"><span data-stu-id="3928a-179">If the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance is a named instance, this includes the instance name.</span></span>|  
|<span data-ttu-id="3928a-180">**ТАЙМАУТ**</span><span class="sxs-lookup"><span data-stu-id="3928a-180">**(TIME)**</span></span>|<span data-ttu-id="3928a-181">Текущее время (в формате ЧЧММСС).</span><span class="sxs-lookup"><span data-stu-id="3928a-181">Current time (in HHMMSS format).</span></span>|  
|<span data-ttu-id="3928a-182">**(STRTTM)**</span><span class="sxs-lookup"><span data-stu-id="3928a-182">**(STRTTM)**</span></span>|<span data-ttu-id="3928a-183">Время запуска задания (в формате ЧЧММСС).</span><span class="sxs-lookup"><span data-stu-id="3928a-183">The time (in HHMMSS format) that the job began executing.</span></span>|  
|<span data-ttu-id="3928a-184">**(STRTDT)**</span><span class="sxs-lookup"><span data-stu-id="3928a-184">**(STRTDT)**</span></span>|<span data-ttu-id="3928a-185">Дата запуска задания (в формате ГГГГММДД).</span><span class="sxs-lookup"><span data-stu-id="3928a-185">The date (in YYYYMMDD format) that the job began executing.</span></span>|  
|<span data-ttu-id="3928a-186">**(WMI(** *свойство* **))**</span><span class="sxs-lookup"><span data-stu-id="3928a-186">**(WMI(** *property* **))**</span></span>|<span data-ttu-id="3928a-187">Для заданий, запускаемых в ответ на предупреждение инструментария WMI, значение свойства указывается параметром *свойство*.</span><span class="sxs-lookup"><span data-stu-id="3928a-187">For jobs that run in response to WMI alerts, the value of the property specified by *property*.</span></span> <span data-ttu-id="3928a-188">Например, маркер `$(WMI(DatabaseName))` предоставляет значение для свойства **DatabaseName** в событии инструментария WMI, которое вызвало предупреждение.</span><span class="sxs-lookup"><span data-stu-id="3928a-188">For example, `$(WMI(DatabaseName))` provides the value of the **DatabaseName** property for the WMI event that caused the alert to run.</span></span>|  
  
### <a name="sql-server-agent-escape-macros"></a><span data-ttu-id="3928a-189">Экранирующие макросы агента SQL Server</span><span class="sxs-lookup"><span data-stu-id="3928a-189">SQL Server Agent Escape Macros</span></span>  
  
|<span data-ttu-id="3928a-190">Экранирующие макросы</span><span class="sxs-lookup"><span data-stu-id="3928a-190">Escape Macros</span></span>|<span data-ttu-id="3928a-191">Описание</span><span class="sxs-lookup"><span data-stu-id="3928a-191">Description</span></span>|  
|-------------------|-----------------|  
|<span data-ttu-id="3928a-192">**$(ESCAPE_SQUOTE(** *имя_токена* **))**</span><span class="sxs-lookup"><span data-stu-id="3928a-192">**$(ESCAPE_SQUOTE(** *token_name* **))**</span></span>|<span data-ttu-id="3928a-193">Экранирует символы одинарных кавычек (') в строке замещения токена.</span><span class="sxs-lookup"><span data-stu-id="3928a-193">Escapes single quotation marks (') in the token replacement string.</span></span> <span data-ttu-id="3928a-194">Замещает символ одинарной кавычки двумя символами одинарной кавычки.</span><span class="sxs-lookup"><span data-stu-id="3928a-194">Replaces one single quotation mark with two single quotation marks.</span></span>|  
|<span data-ttu-id="3928a-195">**$(ESCAPE_DQUOTE(** *имя_токена* **))**</span><span class="sxs-lookup"><span data-stu-id="3928a-195">**$(ESCAPE_DQUOTE(** *token_name* **))**</span></span>|<span data-ttu-id="3928a-196">Экранирует символы двойных кавычек (") в строке замещения токена.</span><span class="sxs-lookup"><span data-stu-id="3928a-196">Escapes double quotation marks (") in the token replacement string.</span></span> <span data-ttu-id="3928a-197">Замещает символ двойных кавычек двумя символами двойных кавычек.</span><span class="sxs-lookup"><span data-stu-id="3928a-197">Replaces one double quotation mark with two double quotation marks.</span></span>|  
|<span data-ttu-id="3928a-198">**$(ESCAPE_RBRACKET(** *имя_токена* **))**</span><span class="sxs-lookup"><span data-stu-id="3928a-198">**$(ESCAPE_RBRACKET(** *token_name* **))**</span></span>|<span data-ttu-id="3928a-199">Экранирует символы правой квадратной скобки (]) в строке замещения токена.</span><span class="sxs-lookup"><span data-stu-id="3928a-199">Escapes right brackets (]) in the token replacement string.</span></span> <span data-ttu-id="3928a-200">Замещает один символ правой квадратной скобки двумя символами правой квадратной скобки.</span><span class="sxs-lookup"><span data-stu-id="3928a-200">Replaces one right bracket with two right brackets.</span></span>|  
|<span data-ttu-id="3928a-201">**$(ESCAPE_NONE(** *имя_токена* **))**</span><span class="sxs-lookup"><span data-stu-id="3928a-201">**$(ESCAPE_NONE(** *token_name* **))**</span></span>|<span data-ttu-id="3928a-202">Замещает токен, не экранируя никакие символы строки.</span><span class="sxs-lookup"><span data-stu-id="3928a-202">Replaces token without escaping any characters in the string.</span></span> <span data-ttu-id="3928a-203">Этот макрос предоставлен для поддержки обратной совместимости в окружениях, где строки замещения токена ожидаются только от надежных пользователей.</span><span class="sxs-lookup"><span data-stu-id="3928a-203">This macro is provided to support backward compatibility in environments where token replacement strings are only expected from trusted users.</span></span> <span data-ttu-id="3928a-204">Дополнительные сведения см. в подразделе «Обновление шагов заданий для использования маркеров» далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="3928a-204">For more information, see "Updating Job Steps to Use Macros," later in this topic.</span></span>|  
  
## <a name="updating-job-steps-to-use-macros"></a><span data-ttu-id="3928a-205">Обновление шагов заданий для использования маркеров</span><span class="sxs-lookup"><span data-stu-id="3928a-205">Updating Job Steps to Use Macros</span></span>  
 <span data-ttu-id="3928a-206">Начиная с версии [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] с пакетом обновления 1 (SP1), шаги заданий, содержащие токены без экранирующих макросов, завершаются сбоем и возвращают сообщение об ошибке; это сообщение указывает на то, что шаг задания содержит токены, обновление которых при помощи макроса необходимо перед тем, как задание можно будет выполнить.</span><span class="sxs-lookup"><span data-stu-id="3928a-206">Beginning with [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] Service Pack 1, job steps that contain tokens without escape macros will fail and return an error message indicating the job step contains one or more tokens that must be updated with a macro before the job can run.</span></span>  
  
 <span data-ttu-id="3928a-207">Вместе со статьей 915845 [!INCLUDE[msCoName](../../includes/msconame-md.md)] SQL Server Agent Job Steps That Use Tokens Fail in SQL Server 2005 Service Pack 1 [(Сбой шагов заданий агента SQL Server, использующих токены, в SQL Server 2005 с пакетом обновления 1) базы знаний](https://support.microsoft.com/kb/915845)предоставляется скрипт, использование которого позволяет обновить все шаги задания, содержащие токены с макросом **ESCAPE_NONE** .</span><span class="sxs-lookup"><span data-stu-id="3928a-207">A script is provided with [!INCLUDE[msCoName](../../includes/msconame-md.md)] Knowledge Base article 915845: [SQL Server Agent Job Steps That Use Tokens Fail in SQL Server 2005 Service Pack 1](https://support.microsoft.com/kb/915845).You can use this script to update all of your job steps that use tokens with the **ESCAPE_NONE** macro.</span></span> <span data-ttu-id="3928a-208">После применения этого скрипта рекомендуется как можно скорее просмотреть шаги заданий, в которых используются токены, и заменить макрос **ESCAPE_NONE** экранирующим макросом, который соответствует контексту шага задания.</span><span class="sxs-lookup"><span data-stu-id="3928a-208">After using this script, we recommend that you review your job steps that use tokens as soon as possible, and replace the **ESCAPE_NONE** macro with an escape macro that is appropriate for the job step context.</span></span>  
  
 <span data-ttu-id="3928a-209">Следующая таблица показывает, каким образом замена токенов обрабатывается агентом [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="3928a-209">The following table describes how token replacement is handled by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent.</span></span> <span data-ttu-id="3928a-210">Чтобы включить или отключить замену токенов предупреждений, щелкните правой кнопкой мыши элемент **Агент SQL Server** в обозревателе объектов, выберите пункт меню **Свойства**и на странице **Система предупреждений** установите или снимите флажок **Заменить токены всех ответов заданий на предупреждения** .</span><span class="sxs-lookup"><span data-stu-id="3928a-210">To turn alert token replacement on or off, right-click **SQL Server Agent** in Object Explorer, select **Properties**, and on the **Alert System** page, select or clear the **Replace tokens for all job responses to alerts** check box.</span></span>  
  
|<span data-ttu-id="3928a-211">Синтаксис токена</span><span class="sxs-lookup"><span data-stu-id="3928a-211">Token syntax</span></span>|<span data-ttu-id="3928a-212">Предупреждение о замене токенов включено</span><span class="sxs-lookup"><span data-stu-id="3928a-212">Alert token replacement on</span></span>|<span data-ttu-id="3928a-213">Предупреждение о замене токенов отключено</span><span class="sxs-lookup"><span data-stu-id="3928a-213">Alert token replacement off</span></span>|  
|------------------|--------------------------------|---------------------------------|  
|<span data-ttu-id="3928a-214">Управляющие макросы используются</span><span class="sxs-lookup"><span data-stu-id="3928a-214">ESCAPE macro used</span></span>|<span data-ttu-id="3928a-215">Все токены в заданиях заменяются успешно.</span><span class="sxs-lookup"><span data-stu-id="3928a-215">All tokens in jobs are successfully replaced.</span></span>|<span data-ttu-id="3928a-216">Токены, активированные предупреждениями, не заменяются.</span><span class="sxs-lookup"><span data-stu-id="3928a-216">Tokens activated by alerts are not replaced.</span></span> <span data-ttu-id="3928a-217">Эти токены представляют **собой DBN**, **a – SVR**, **a-Err**, **A-уровень серьезности**, **a-MSG**и **WMI ( *`property`* )**.</span><span class="sxs-lookup"><span data-stu-id="3928a-217">These tokens are **A-DBN**, **A-SVR**, **A-ERR**, **A-SEV**, **A-MSG**, and **WMI(*`property`*)**.</span></span> <span data-ttu-id="3928a-218">Другие статические токены заменяются успешно.</span><span class="sxs-lookup"><span data-stu-id="3928a-218">Other static tokens are replaced successfully.</span></span>|  
|<span data-ttu-id="3928a-219">Управляющие макросы не используются</span><span class="sxs-lookup"><span data-stu-id="3928a-219">No ESCAPE macro used</span></span>|<span data-ttu-id="3928a-220">Все задания, содержащие токены, завершаются сбоем.</span><span class="sxs-lookup"><span data-stu-id="3928a-220">Any jobs containing tokens fail.</span></span>|<span data-ttu-id="3928a-221">Все задания, содержащие токены, завершаются сбоем.</span><span class="sxs-lookup"><span data-stu-id="3928a-221">Any jobs containing tokens fail.</span></span>|  
  
## <a name="token-syntax-update-examples"></a><span data-ttu-id="3928a-222">Примеры обновления синтаксиса токенов</span><span class="sxs-lookup"><span data-stu-id="3928a-222">Token Syntax Update Examples</span></span>  
  
### <a name="a-using-tokens-in-non-nested-strings"></a><span data-ttu-id="3928a-223">A.</span><span class="sxs-lookup"><span data-stu-id="3928a-223">A.</span></span> <span data-ttu-id="3928a-224">Использование токенов в невложенных строках</span><span class="sxs-lookup"><span data-stu-id="3928a-224">Using tokens in non-nested strings</span></span>  
 <span data-ttu-id="3928a-225">В следующем примере показано, как обновить простой скрипт без вложенных строк соответствующим управляющим маркером.</span><span class="sxs-lookup"><span data-stu-id="3928a-225">The following example shows how to update a simple non-nested script with the appropriate escape macro.</span></span> <span data-ttu-id="3928a-226">До выполнения обновляющего скрипта следующий скрипт шага задания использует токен шага задания, чтобы напечатать соответствующее имя базы данных:</span><span class="sxs-lookup"><span data-stu-id="3928a-226">Before running the update script, the following job step script uses a job step token to print the appropriate database name:</span></span>  
  
 `PRINT N'Current database name is $(A-DBN)' ;`  
  
 <span data-ttu-id="3928a-227">После выполнения обновляющего скрипта макрос `ESCAPE_NONE` добавляется перед токеном `A-DBN` .</span><span class="sxs-lookup"><span data-stu-id="3928a-227">After running the update script, an `ESCAPE_NONE` macro is inserted before the `A-DBN` token.</span></span> <span data-ttu-id="3928a-228">Так как для отделения строки печати используются одинарные кавычки, необходимо обновить шаг задания, добавив макрос `ESCAPE_SQUOTE` следующим образом:</span><span class="sxs-lookup"><span data-stu-id="3928a-228">Because single quotation marks are used to delimit the print string, you must update the job step by inserting the `ESCAPE_SQUOTE` macro as follows:</span></span>  
  
 `PRINT N'Current database name is $(ESCAPE_SQUOTE(A-DBN))' ;`  
  
### <a name="b-using-tokens-in-nested-strings"></a><span data-ttu-id="3928a-229">Б.</span><span class="sxs-lookup"><span data-stu-id="3928a-229">B.</span></span> <span data-ttu-id="3928a-230">Использование токенов во вложенных строках</span><span class="sxs-lookup"><span data-stu-id="3928a-230">Using tokens in nested strings</span></span>  
 <span data-ttu-id="3928a-231">В скриптах шагов заданий, где токены используются во вложенных строках или инструкциях, перед добавлением соответствующих управляющих токенов следует переписать вложенные инструкции в виде нескольких инструкций.</span><span class="sxs-lookup"><span data-stu-id="3928a-231">In job step scripts where tokens are used in nested strings or statements, the nested statements should be rewritten as multiple statements before inserting the appropriate escape macros.</span></span>  
  
 <span data-ttu-id="3928a-232">Например, рассмотрим следующий шаг задания, в котором используется токен `A-MSG` и который не был обновлен с помощью управляющего макроса:</span><span class="sxs-lookup"><span data-stu-id="3928a-232">For example, consider the following job step, which uses the `A-MSG` token and has not been updated with an escape macro:</span></span>  
  
 `PRINT N'Print ''$(A-MSG)''' ;`  
  
 <span data-ttu-id="3928a-233">После выполнения обновляющего скрипта макрос `ESCAPE_NONE` добавляется с токеном.</span><span class="sxs-lookup"><span data-stu-id="3928a-233">After running the update script, an `ESCAPE_NONE` macro is inserted with the token.</span></span> <span data-ttu-id="3928a-234">Однако в этом случае необходимо переписать скрипт, чтобы не использовалось вложение, как показано ниже, и добавить макрос `ESCAPE_SQUOTE` , чтобы правильным образом экранировать разделители, которые могут быть переданы в строку замены токена:</span><span class="sxs-lookup"><span data-stu-id="3928a-234">However, in this case, you would have to rewrite the script without using nesting as follows and insert the `ESCAPE_SQUOTE` macro to properly escape delimiters that may be passed in the token replacement string:</span></span>  
  
 `DECLARE @msgString nvarchar(max)`  
  
 `SET @msgString = '$(ESCAPE_SQUOTE(A-MSG))'`  
  
 `SET @msgString = QUOTENAME(@msgString,'''')`  
  
 `PRINT N'Print ' + @msgString ;`  
  
 <span data-ttu-id="3928a-235">Имейте в виду, что функция QUOTENAME устанавливает символ кавычки.</span><span class="sxs-lookup"><span data-stu-id="3928a-235">Note also in this example that the QUOTENAME function sets the quote character.</span></span>  
  
### <a name="c-using-tokens-with-the-escape_none-macro"></a><span data-ttu-id="3928a-236">В.</span><span class="sxs-lookup"><span data-stu-id="3928a-236">C.</span></span> <span data-ttu-id="3928a-237">Использование токенов с макросом ESCAPE_NONE</span><span class="sxs-lookup"><span data-stu-id="3928a-237">Using tokens with the ESCAPE_NONE macro</span></span>  
 <span data-ttu-id="3928a-238">Следующий пример является частью скрипта, который извлекает `job_id` из таблицы `sysjobs` и использует токен `JOBID` , чтобы заполнить переменную `@JobID` , которая была объявлена как бинарный тип данных ранее в скрипте.</span><span class="sxs-lookup"><span data-stu-id="3928a-238">The following example is part of a script that retrieves the `job_id` from the `sysjobs` table and uses the `JOBID` token to populate the `@JobID` variable, which was declared earlier in the script as a binary data type.</span></span> <span data-ttu-id="3928a-239">Имейте в виду, что с токеном `ESCAPE_NONE` используется макрос `JOBID` , так как для бинарного типа данных разделители не требуются.</span><span class="sxs-lookup"><span data-stu-id="3928a-239">Note that because no delimiters are required for binary data types, the `ESCAPE_NONE` macro is used with the `JOBID` token.</span></span> <span data-ttu-id="3928a-240">После выполнения скрипта обновления не нужно обновлять этот шаг задания.</span><span class="sxs-lookup"><span data-stu-id="3928a-240">You would not need to update this job step after running the update script.</span></span>  
  
 `SELECT * FROM msdb.dbo.sysjobs`  
  
 `WHERE @JobID = CONVERT(uniqueidentifier, $(ESCAPE_NONE(JOBID))) ;`  
  
## <a name="see-also"></a><span data-ttu-id="3928a-241">См. также:</span><span class="sxs-lookup"><span data-stu-id="3928a-241">See Also</span></span>  
 <span data-ttu-id="3928a-242">[Реализация заданий](implement-jobs.md) </span><span class="sxs-lookup"><span data-stu-id="3928a-242">[Implement Jobs](implement-jobs.md) </span></span>  
 [<span data-ttu-id="3928a-243">Управление шагами задания</span><span class="sxs-lookup"><span data-stu-id="3928a-243">Manage Job Steps</span></span>](manage-job-steps.md)  
  
  
