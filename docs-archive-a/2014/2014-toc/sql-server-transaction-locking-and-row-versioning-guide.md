---
title: Руководство по блокировке транзакций и управлению версиями строк SQL Server | Документы Майкрософт
ms.custom: ''
ms.date: 01/24/2019
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
ms.assetid: c7757153-9697-4f01-881c-800e254918c9
author: rothja
ms.author: jroth
ms.openlocfilehash: c79f9997249568c88409394441d28c71da453d63
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87656116"
---
# <a name="sql-server-transaction-locking-and-row-versioning-guide"></a><span data-ttu-id="a5bd4-102">Руководство по блокировке и управлению версиями строк транзакций SQL Server</span><span class="sxs-lookup"><span data-stu-id="a5bd4-102">SQL Server Transaction Locking and Row Versioning Guide</span></span>

  <span data-ttu-id="a5bd4-103">В любой базе данных неправильная работа с транзакциями часто приводит к проблемам производительности и конфликтам в системах со многими пользователями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-103">In any database, mismanagement of transactions often leads to contention and performance problems in systems that have many users.</span></span> <span data-ttu-id="a5bd4-104">По мере роста числа пользователей, обращающихся к данным, повышается актуальность эффективного использования транзакций приложениями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-104">As the number of users that access the data increases, it becomes important to have applications that use transactions efficiently.</span></span> <span data-ttu-id="a5bd4-105">В этом руководстве описываются механизмы блокировки и управления версиями строк, используемые [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] для обеспечения физической целостности каждой транзакции, а также представлены сведения о том, как приложения могут эффективно управлять транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-105">This guide describes the locking and row versioning mechanisms the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses to ensure the physical integrity of each transaction and provides information on how applications can control transactions efficiently.</span></span>  
  
<span data-ttu-id="a5bd4-106">**Применимо к:,** [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] если не указано иное.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-106">**Applies to**: [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] through [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] unless noted otherwise.</span></span>  
  
##  <a name="in-this-guide"></a><a name="Top"></a><span data-ttu-id="a5bd4-107">В этом пошаговом окне</span><span class="sxs-lookup"><span data-stu-id="a5bd4-107">In This Guide</span></span>  

 [<span data-ttu-id="a5bd4-108">Основные сведения о транзакциях</span><span class="sxs-lookup"><span data-stu-id="a5bd4-108">Transaction Basics</span></span>](#Basics)  
  
 [<span data-ttu-id="a5bd4-109">Основы блокировки и управления версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-109">Locking and Row Versioning Basics</span></span>](#Lock_Basics)  
  
 [<span data-ttu-id="a5bd4-110">Блокировка в ядро СУБД</span><span class="sxs-lookup"><span data-stu-id="a5bd4-110">Locking in the Database Engine</span></span>](#Lock_Engine)  
  
 [<span data-ttu-id="a5bd4-111">Уровни изоляции, основанные на управлении версиями строк, в компоненте Database Engine</span><span class="sxs-lookup"><span data-stu-id="a5bd4-111">Row Versioning-based Isolation Levels in the Database Engine</span></span>](#Row_versioning)  
  
 [<span data-ttu-id="a5bd4-112">Настройка блокировки для индекса</span><span class="sxs-lookup"><span data-stu-id="a5bd4-112">Customizing Locking for an Index</span></span>](#Customize)  
  
 [<span data-ttu-id="a5bd4-113">Дополнительные сведения о транзакциях</span><span class="sxs-lookup"><span data-stu-id="a5bd4-113">Advanced Transaction Information</span></span>](#Advanced)  
  
##  <a name="transaction-basics"></a><a name="Basics"></a> <span data-ttu-id="a5bd4-114">Общие сведения о транзакциях</span><span class="sxs-lookup"><span data-stu-id="a5bd4-114">Transaction Basics</span></span>  

 <span data-ttu-id="a5bd4-115">Транзакция является последовательностью операций, выполненных как одна логическая единица работы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-115">A transaction is a sequence of operations performed as a single logical unit of work.</span></span> <span data-ttu-id="a5bd4-116">Логическая единица работы должна обладать четырьмя свойствами, называемыми атомарностью, согласованностью, изоляцией и длительностью (ACID), чтобы называться транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-116">A logical unit of work must exhibit four properties, called the atomicity, consistency, isolation, and durability (ACID) properties, to qualify as a transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-117">Атомарность</span><span class="sxs-lookup"><span data-stu-id="a5bd4-117">Atomicity</span></span>  
 <span data-ttu-id="a5bd4-118">Транзакция должна быть атомарной единицей работы; либо выполняются все входящие в нее изменения данных, либо не выполняется ни одно из этих изменений.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-118">A transaction must be an atomic unit of work; either all of its data modifications are performed, or none of them are performed.</span></span>  
  
 <span data-ttu-id="a5bd4-119">Согласованность</span><span class="sxs-lookup"><span data-stu-id="a5bd4-119">Consistency</span></span>  
 <span data-ttu-id="a5bd4-120">По завершении транзакция должна оставить все данные в согласованном состоянии.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-120">When completed, a transaction must leave all data in a consistent state.</span></span> <span data-ttu-id="a5bd4-121">В реляционной базе данных к модификациям транзакции должны быть применены все правила для обеспечения целостности всех данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-121">In a relational database, all rules must be applied to the transaction's modifications to maintain all data integrity.</span></span> <span data-ttu-id="a5bd4-122">Все внутренние структуры данных, например индексы сбалансированного дерева или взаимосвязанные списки, должны быть правильными в конце транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-122">All internal data structures, such as B-tree indexes or doubly-linked lists, must be correct at the end of the transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-123">Изоляция</span><span class="sxs-lookup"><span data-stu-id="a5bd4-123">Isolation</span></span>  
 <span data-ttu-id="a5bd4-124">Изменения, выполняемые параллельными транзакциями, должны быть изолированы от изменений, выполняемых прочими параллельными транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-124">Modifications made by concurrent transactions must be isolated from the modifications made by any other concurrent transactions.</span></span> <span data-ttu-id="a5bd4-125">Транзакция распознает данные либо в состоянии, в котором они были до того, как другая параллельная транзакция изменила их, либо она распознает данные после того, как другая транзакция была завершена. Но она не распознает промежуточное состояние.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-125">A transaction either recognizes data in the state it was in before another concurrent transaction modified it, or it recognizes the data after the second transaction has completed, but it does not recognize an intermediate state.</span></span> <span data-ttu-id="a5bd4-126">Это упоминается как упорядоченность, потому что она обеспечивает возможность перезагрузить начальные данные и воспроизвести серию транзакций, чтобы завершить работу с данными в том же самом состоянии, в котором они были после выполнения исходных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-126">This is referred to as serializability because it results in the ability to reload the starting data and replay a series of transactions to end up with the data in the same state it was in after the original transactions were performed.</span></span>  
  
 <span data-ttu-id="a5bd4-127">Устойчивость</span><span class="sxs-lookup"><span data-stu-id="a5bd4-127">Durability</span></span>  
 <span data-ttu-id="a5bd4-128">После завершения полностью устойчивой транзакции произведенные ею действия занимают постоянное место в системе.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-128">After a fully durable transaction has completed, its effects are permanently in place in the system.</span></span> <span data-ttu-id="a5bd4-129">Изменения сохраняются даже в случае системного сбоя.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-129">The modifications persist even in the event of a system failure.</span></span> <span data-ttu-id="a5bd4-130">В [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] и дальнейших разделах описаны отложенные устойчивые транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-130">[!INCLUDE[ssSQL14](../includes/sssql14-md.md)] and later enable delayed durable transactions.</span></span> <span data-ttu-id="a5bd4-131">Отложенные устойчивые транзакции фиксируются перед сохранением записи журнала транзакций на диск.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-131">Delayed durable transactions commit before the transaction log record is persisted to disk.</span></span> <span data-ttu-id="a5bd4-132">Подробнее об устойчивости отложенных транзакций можно узнать в разделе [Устойчивость транзакций](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-132">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="a5bd4-133">Программисты SQL ответственны за начало и завершение транзакций в точках, которые осуществляют логическую целостность данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-133">SQL programmers are responsible for starting and ending transactions at points that enforce the logical consistency of the data.</span></span> <span data-ttu-id="a5bd4-134">Программист должен определить последовательность изменений данных, которые оставляют данные в целостном состоянии по отношению к деловым правилам организации.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-134">The programmer must define the sequence of data modifications that leave the data in a consistent state relative to the organization's business rules.</span></span> <span data-ttu-id="a5bd4-135">Программист включает эти инструкции модификации в одну транзакцию, чтобы [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] смог обеспечить физическую целостность транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-135">The programmer includes these modification statements in a single transaction so that the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can enforce the physical integrity of the transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-136">Системы баз данных предприятия, такие как экземпляр компонента [!INCLUDE[ssDE](../includes/ssde-md.md)], ответственны за обеспечение механизмов, гарантирующих физическую целостность каждой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-136">It is the responsibility of an enterprise database system, such as an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], to provide mechanisms ensuring the physical integrity of each transaction.</span></span> <span data-ttu-id="a5bd4-137">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] обеспечивает следующее.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-137">The [!INCLUDE[ssDE](../includes/ssde-md.md)] provides:</span></span>  
  
-   <span data-ttu-id="a5bd4-138">Блокирующие средства, которые сохраняют изоляцию транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-138">Locking facilities that preserve transaction isolation.</span></span>  
  
-   <span data-ttu-id="a5bd4-139">Регистрирующие средства гарантируют длительность транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-139">Logging facilities ensure transaction durability.</span></span> <span data-ttu-id="a5bd4-140">Запись журнала транзакций для полностью устойчивых транзакций сохраняется на диск перед фиксацией транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-140">For fully durable transactions the log record is hardened to disk before the transactions commits.</span></span> <span data-ttu-id="a5bd4-141">Поэтому даже если в оборудовании сервера, операционной системе или экземпляре [!INCLUDE[ssDE](../includes/ssde-md.md)] произойдет сбой, после перезапуска экземпляр использует журналы транзакций для автоматического отката любых незавершенных транзакций до момента сбоя системы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-141">Thus, even if the server hardware, operating system, or the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] itself fails, the instance uses the transaction logs upon restart to automatically roll back any uncompleted transactions to the point of the system failure.</span></span> <span data-ttu-id="a5bd4-142">Отложенные устойчивые транзакции фиксируются перед сохранением записи журнала транзакций на диск.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-142">Delayed durable transactions commit before the transaction log record is hardened to disk.</span></span> <span data-ttu-id="a5bd4-143">Такие транзакции могут быть утеряны, если перед сохранением записи журнала на диск произойдет ошибка системы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-143">Such transactions may be lost if there is a system failure before the log record is hardened to disk.</span></span> <span data-ttu-id="a5bd4-144">Подробнее об устойчивости отложенных транзакций можно узнать в разделе [Устойчивость транзакций](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-144">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
-   <span data-ttu-id="a5bd4-145">Функции управления транзакциями, которые реализуют атомарность и согласованность транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-145">Transaction management features that enforce transaction atomicity and consistency.</span></span> <span data-ttu-id="a5bd4-146">После начала транзакции она должна быть успешно завершена (зафиксирована), иначе компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] отменяет все изменения данных, внесенные с начала транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-146">After a transaction has started, it must be successfully completed (committed), or the [!INCLUDE[ssDE](../includes/ssde-md.md)] undoes all of the data modifications made since the transaction started.</span></span> <span data-ttu-id="a5bd4-147">Эта операция называется откатом транзакции, поскольку она возвращает данные в то состояние, в котором они были до внесения изменений.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-147">This operation is referred to as rolling back a transaction because it returns the data to the state it was prior to those changes.</span></span>  
  
### <a name="controlling-transactions"></a><span data-ttu-id="a5bd4-148">Управление транзакциями</span><span class="sxs-lookup"><span data-stu-id="a5bd4-148">Controlling Transactions</span></span>  

 <span data-ttu-id="a5bd4-149">Управление транзакциями в приложениях реализуется, главным образом, путем указания того, когда транзакция начинается и заканчивается.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-149">Applications control transactions mainly by specifying when a transaction starts and ends.</span></span> <span data-ttu-id="a5bd4-150">Указать это можно либо с помощью инструкций языка [!INCLUDE[tsql](../includes/tsql-md.md)], либо используя функции интерфейса прикладного программирования (API) для баз данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-150">This can be specified by using either [!INCLUDE[tsql](../includes/tsql-md.md)] statements or database application programming interface (API) functions.</span></span> <span data-ttu-id="a5bd4-151">В системе также должна быть возможность правильной обработки ошибок, прерывающих транзакцию до ее окончания.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-151">The system must also be able to correctly handle errors that terminate a transaction before it completes.</span></span> <span data-ttu-id="a5bd4-152">Дополнительные сведения см. в статьях [инструкции транзакций &#40;&#41;Transact-SQL ](/sql/t-sql/language-elements/transactions-transact-sql), [транзакции в ODBC](https://technet.microsoft.com/library/ms131281.aspx) и [транзакции в SQL Server Native Client (OLEDB)](https://msdn.microsoft.com/library/ms130918.aspx).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-152">For more information, see [Transaction Statements &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/transactions-transact-sql), [Transactions in ODBC](https://technet.microsoft.com/library/ms131281.aspx) and [Transactions in SQL Server Native Client (OLEDB)](https://msdn.microsoft.com/library/ms130918.aspx).</span></span>  
  
 <span data-ttu-id="a5bd4-153">По умолчанию управление транзакциями выполняется на уровне соединения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-153">By default, transactions are managed at the connection level.</span></span> <span data-ttu-id="a5bd4-154">Когда транзакция начинает соединение, все выполняемые во время этого соединения инструкции языка [!INCLUDE[tsql](../includes/tsql-md.md)] становятся частью транзакции до ее завершения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-154">When a transaction is started on a connection, all [!INCLUDE[tsql](../includes/tsql-md.md)] statements executed on that connection are part of the transaction until the transaction ends.</span></span> <span data-ttu-id="a5bd4-155">Однако в сеансе MARS явная или неявная транзакция языка [!INCLUDE[tsql](../includes/tsql-md.md)] становится транзакцией контекста пакета, управляемой на пакетном уровне.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-155">However, under a multiple active result set (MARS) session, a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction becomes a batch-scoped transaction that is managed at the batch level.</span></span> <span data-ttu-id="a5bd4-156">После выполнения пакета, если транзакция контекста пакета не зафиксирована и не был выполнен ее откат, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] производит автоматический откат такой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-156">When the batch completes, if the batch-scoped transaction is not committed or rolled back, it is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a5bd4-157">Дополнительные сведения см. [в разделе множественные активные результирующие наборы (MARS) в SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-157">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
#### <a name="starting-transactions"></a><span data-ttu-id="a5bd4-158">Запуск транзакций</span><span class="sxs-lookup"><span data-stu-id="a5bd4-158">Starting Transactions</span></span>  

 <span data-ttu-id="a5bd4-159">С помощью функций API и инструкций языка [!INCLUDE[tsql](../includes/tsql-md.md)] можно запускать транзакции в экземпляре компонента [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] как явные, автоматически фиксируемые или неявные транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-159">Using API functions and [!INCLUDE[tsql](../includes/tsql-md.md)] statements, you can start transactions in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] as explicit, autocommit, or implicit transactions.</span></span>  
  
 <span data-ttu-id="a5bd4-160">**Явные транзакции**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-160">**Explicit Transactions**</span></span>  
 <span data-ttu-id="a5bd4-161">Явная транзакция — это та транзакция, в которой явно определены начало и конец транзакции посредством функций API или при помощи инструкции [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION или ROLLBACK WORK [!INCLUDE[tsql](../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-161">An explicit transaction is one in which you explicitly define both the start and end of the transaction through an API function or by issuing the [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION, or ROLLBACK WORK [!INCLUDE[tsql](../includes/tsql-md.md)] statements.</span></span> <span data-ttu-id="a5bd4-162">После завершения транзакции соединение возвращается в тот режим транзакции, в котором оно было до запуска явной транзакции, либо в неявный режим, либо в режим автоматической фиксации.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-162">When the transaction ends, the connection returns to the transaction mode it was in before the explicit transaction was started, either implicit or autocommit mode.</span></span>  
  
 <span data-ttu-id="a5bd4-163">В явной транзакции можно использовать все инструкции языка [!INCLUDE[tsql](../includes/tsql-md.md)], за исключением следующих:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-163">You can use all [!INCLUDE[tsql](../includes/tsql-md.md)] statements in an explicit transaction, except for the following statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="a5bd4-164">ALTER DATABASE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-164">ALTER DATABASE</span></span>|<span data-ttu-id="a5bd4-165">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-165">CREATE DATABASE</span></span>|<span data-ttu-id="a5bd4-166">DROP FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="a5bd4-166">DROP FULLTEXT INDEX</span></span>|  
|<span data-ttu-id="a5bd4-167">ALTER FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="a5bd4-167">ALTER FULLTEXT CATALOG</span></span>|<span data-ttu-id="a5bd4-168">CREATE FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="a5bd4-168">CREATE FULLTEXT CATALOG</span></span>|<span data-ttu-id="a5bd4-169">RECONFIGURE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-169">RECONFIGURE</span></span>|  
|<span data-ttu-id="a5bd4-170">ALTER FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="a5bd4-170">ALTER FULLTEXT INDEX</span></span>|<span data-ttu-id="a5bd4-171">CREATE FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="a5bd4-171">CREATE FULLTEXT INDEX</span></span>|<span data-ttu-id="a5bd4-172">RESTORE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-172">RESTORE</span></span>|  
|<span data-ttu-id="a5bd4-173">BACKUP</span><span class="sxs-lookup"><span data-stu-id="a5bd4-173">BACKUP</span></span>|<span data-ttu-id="a5bd4-174">DROP DATABASE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-174">DROP DATABASE</span></span>|<span data-ttu-id="a5bd4-175">Хранимые процедуры для работы с полнотекстовыми системами</span><span class="sxs-lookup"><span data-stu-id="a5bd4-175">Full-text system stored procedures</span></span>|  
|<span data-ttu-id="a5bd4-176">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-176">CREATE DATABASE</span></span>|<span data-ttu-id="a5bd4-177">DROP FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="a5bd4-177">DROP FULLTEXT CATALOG</span></span>|<span data-ttu-id="a5bd4-178">Хранимая процедура sp_dboption, чтобы настроить параметры базы данных, или любая системная процедура, изменяющая базу данных master внутри явных или неявных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-178">sp_dboption to set database options or any system procedure that modifies the master database inside explicit or implicit transactions.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-179">Инструкцию UPDATE STATISTICS можно использовать внутри явной транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-179">UPDATE STATISTICS can be used inside an explicit transaction.</span></span> <span data-ttu-id="a5bd4-180">Однако фиксация инструкции UPDATE STATISTICS производится независимо от обрамляющей ее транзакции, поэтому произвести ее откат невозможно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-180">However, UPDATE STATISTICS commits independently of the enclosing transaction and cannot be rolled back.</span></span>  
  
 <span data-ttu-id="a5bd4-181">**Транзакции с автоматической фиксацией**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-181">**Autocommit Transactions**</span></span>  
 <span data-ttu-id="a5bd4-182">Режим автоматической фиксации — это режим управления транзакциями компонента SQL Server Database Engine по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-182">Autocommit mode is the default transaction management mode of the SQL Server Database Engine.</span></span> <span data-ttu-id="a5bd4-183">После завершения каждая инструкция Transact-SQL фиксируется или откатывается назад.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-183">Every Transact-SQL statement is committed or rolled back when it completes.</span></span> <span data-ttu-id="a5bd4-184">Если инструкция выполняется без ошибок, она фиксируется. В противном случае она откатывается назад.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-184">If a statement completes successfully, it is committed; if it encounters any error, it is rolled back.</span></span> <span data-ttu-id="a5bd4-185">Соединение с экземпляром компонента Database Engine работает в режиме автоматической фиксации везде, где не используются явные или неявные транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-185">A connection to an instance of the Database Engine operates in autocommit mode whenever this default mode has not been overridden by either explicit or implicit transactions.</span></span> <span data-ttu-id="a5bd4-186">Режим автоматической фиксации также применяется по умолчанию для ADO, OLE DB, ODBC и DB-Library.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-186">Autocommit mode is also the default mode for ADO, OLE DB, ODBC, and DB-Library.</span></span>  
  
 <span data-ttu-id="a5bd4-187">**Неявные транзакции**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-187">**Implicit Transactions**</span></span>  
 <span data-ttu-id="a5bd4-188">Если соединение работает в режиме неявных транзакций, экземпляр компонента Database Engine автоматически начинает новую транзакцию после фиксации или отката текущей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-188">When a connection is operating in implicit transaction mode, the instance of the Database Engine automatically starts a new transaction after the current transaction is committed or rolled back.</span></span> <span data-ttu-id="a5bd4-189">Для запуска таких транзакций ничего делать не нужно; необходимо только фиксировать или выполнять откат каждой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-189">You do nothing to delineate the start of a transaction; you only commit or roll back each transaction.</span></span> <span data-ttu-id="a5bd4-190">Режим неявных транзакций формирует непрерывную цепь транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-190">Implicit transaction mode generates a continuous chain of transactions.</span></span> <span data-ttu-id="a5bd4-191">Установка неявного режима транзакции либо через функцию API, либо через инструкцию языка [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-191">Set implicit transaction mode on through either an API function or the [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON statement.</span></span>  
  
 <span data-ttu-id="a5bd4-192">После установления на соединении режима неявных транзакций экземпляр компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] автоматически запускает транзакцию, если вначале выполняет любую из следующих инструкций:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-192">After implicit transaction mode has been set on for a connection, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically starts a transaction when it first executes any of these statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="a5bd4-193">ALTER TABLE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-193">ALTER TABLE</span></span>|<span data-ttu-id="a5bd4-194">FETCH</span><span class="sxs-lookup"><span data-stu-id="a5bd4-194">FETCH</span></span>|<span data-ttu-id="a5bd4-195">REVOKE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-195">REVOKE</span></span>|  
|<span data-ttu-id="a5bd4-196">CREATE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-196">CREATE</span></span>|<span data-ttu-id="a5bd4-197">GRANT</span><span class="sxs-lookup"><span data-stu-id="a5bd4-197">GRANT</span></span>|<span data-ttu-id="a5bd4-198">SELECT</span><span class="sxs-lookup"><span data-stu-id="a5bd4-198">SELECT</span></span>|  
|<span data-ttu-id="a5bd4-199">DELETE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-199">DELETE</span></span>|<span data-ttu-id="a5bd4-200">INSERT</span><span class="sxs-lookup"><span data-stu-id="a5bd4-200">INSERT</span></span>|<span data-ttu-id="a5bd4-201">TRUNCATE TABLE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-201">TRUNCATE TABLE</span></span>|  
|<span data-ttu-id="a5bd4-202">DROP</span><span class="sxs-lookup"><span data-stu-id="a5bd4-202">DROP</span></span>|<span data-ttu-id="a5bd4-203">OPEN</span><span class="sxs-lookup"><span data-stu-id="a5bd4-203">OPEN</span></span>|<span data-ttu-id="a5bd4-204">UPDATE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-204">UPDATE</span></span>|  
  
 <span data-ttu-id="a5bd4-205">**Транзакции контекста пакета**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-205">**Batch-scoped Transactions**</span></span>  
 <span data-ttu-id="a5bd4-206">Будучи применимой только к множественным активным результирующим наборам (режим MARS), явная или неявная транзакция [!INCLUDE[tsql](../includes/tsql-md.md)], которая запускается в сеансе режима MARS, становится транзакцией контекста пакета.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-206">Applicable only to multiple active result sets (MARS), a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction that starts under a MARS session becomes a batch-scoped transaction.</span></span> <span data-ttu-id="a5bd4-207">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] автоматически выполняет откат транзакции контекста пакета, если эта транзакция не зафиксирована или выполнен ее откат при завершении пакета.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-207">A batch-scoped transaction that is not committed or rolled back when a batch completes is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="a5bd4-208">**Распределенные транзакции**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-208">**Distributed Transactions**</span></span>  
 <span data-ttu-id="a5bd4-209">Распределенные транзакции выполняются на двух или более серверах, которые называются диспетчерами ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-209">Distributed transactions span two or more servers known as resource managers.</span></span> <span data-ttu-id="a5bd4-210">Управление транзакцией должно координироваться между диспетчерами ресурсов компонентом сервера, который называется диспетчером транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-210">The management of the transaction must be coordinated between the resource managers by a server component called a transaction manager.</span></span> <span data-ttu-id="a5bd4-211">Каждый экземпляр компонента [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] может действовать как диспетчер ресурсов в распределенных транзакциях, координируемых диспетчерами транзакций, например, координатором распределенных транзакций ([!INCLUDE[msCoName](../includes/msconame-md.md)]) (MS DTC) или другими диспетчерами транзакций, поддерживающими спецификацию Open Group XA обработки распределенных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-211">Each instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can operate as a resource manager in distributed transactions coordinated by transaction managers, such as [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC), or other transaction managers that support the Open Group XA specification for distributed transaction processing.</span></span> <span data-ttu-id="a5bd4-212">Дополнительные сведения см. в документации по MS DTC.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-212">For more information, see the MS DTC documentation.</span></span>  
  
 <span data-ttu-id="a5bd4-213">Транзакция в отдельном экземпляре компонента [!INCLUDE[ssDE](../includes/ssde-md.md)], распространяющаяся на несколько данных, в действительности является распределенной транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-213">A transaction within a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] that spans two or more databases is actually a distributed transaction.</span></span> <span data-ttu-id="a5bd4-214">Экземпляр управляет распределенной транзакцией на внутреннем уровне, для пользователя она действует как локальная транзакция.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-214">The instance manages the distributed transaction internally; to the user, it operates as a local transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-215">В приложении управление распределенной транзакцией во многом похоже на управление локальной.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-215">At the application, a distributed transaction is managed much the same as a local transaction.</span></span> <span data-ttu-id="a5bd4-216">В конце транзакции приложение запрашивает ее фиксацию или откат.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-216">At the end of the transaction, the application requests the transaction to be either committed or rolled back.</span></span> <span data-ttu-id="a5bd4-217">Распределенной фиксацией диспетчер транзакций должен управлять иначе, чтобы свести к минимуму риск сбоя сети, в результате которого одни диспетчеры ресурсов могут фиксировать транзакцию, тогда как другие будут выполнять ее откат.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-217">A distributed commit must be managed differently by the transaction manager to minimize the risk that a network failure may result in some resource managers successfully committing while others roll back the transaction.</span></span> <span data-ttu-id="a5bd4-218">Выход из положения заключается в двухфазном процессе фиксации (фаза подготовки и фаза фиксации), который называется двухфазной фиксацией (2PC).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-218">This is achieved by managing the commit process in two phases (the prepare phase and the commit phase), which is known as a two-phase commit (2PC).</span></span>  
  
 <span data-ttu-id="a5bd4-219">Фаза подготовки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-219">Prepare phase</span></span>  
 <span data-ttu-id="a5bd4-220">Когда диспетчер транзакции получает запрос на фиксацию, он отправляет команду подготовки всем диспетчерам ресурсов, занятым в транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-220">When the transaction manager receives a commit request, it sends a prepare command to all of the resource managers involved in the transaction.</span></span> <span data-ttu-id="a5bd4-221">Каждый диспетчер ресурсов всемерно обеспечивает устойчивость транзакции, а все буферы, в которых хранятся образы журналов для этой транзакции, записываются на диск.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-221">Each resource manager then does everything required to make the transaction durable, and all buffers holding log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="a5bd4-222">По мере того, как каждый диспетчер ресурсов завершает фазу подготовки, он возвращает диспетчеру транзакций значение успешного или неуспешного завершения подготовки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-222">As each resource manager completes the prepare phase, it returns success or failure of the prepare to the transaction manager.</span></span> <span data-ttu-id="a5bd4-223">В [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] была введена устойчивость отложенных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-223">[!INCLUDE[ssSQL14](../includes/sssql14-md.md)] introduced delayed transaction durability.</span></span> <span data-ttu-id="a5bd4-224">Отложенные устойчивые транзакции фиксируются перед сохранением образов журнала транзакции на диск.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-224">Delayed durable transactions commit before log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="a5bd4-225">Подробнее об устойчивости отложенных транзакций можно узнать в разделе [Устойчивость транзакций](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-225">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="a5bd4-226">Фаза фиксации</span><span class="sxs-lookup"><span data-stu-id="a5bd4-226">Commit phase</span></span>  
 <span data-ttu-id="a5bd4-227">Если диспетчер транзакций получает значения успешного завершения подготовки от всех диспетчеров ресурсов, то он отправляет команду фиксации каждому диспетчеру ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-227">If the transaction manager receives successful prepares from all of the resource managers, it sends commit commands to each resource manager.</span></span> <span data-ttu-id="a5bd4-228">После этого диспетчеры ресурсов могут завершить фиксацию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-228">The resource managers can then complete the commit.</span></span> <span data-ttu-id="a5bd4-229">Если все диспетчеры ресурсов сообщают об успешной фиксации, то диспетчер транзакций отправляет уведомление приложению.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-229">If all of the resource managers report a successful commit, the transaction manager then sends a success notification to the application.</span></span> <span data-ttu-id="a5bd4-230">Если какой-либо диспетчер ресурсов сообщил о неуспешном завершении подготовки, то диспетчер транзакций отправляет команду отката всем диспетчерам ресурсов и сообщает приложению о сбое фиксации.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-230">If any resource manager reported a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="a5bd4-231">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] управляет распределенными транзакциями посредством [!INCLUDE[tsql](../includes/tsql-md.md)] или API базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-231">[!INCLUDE[ssDE](../includes/ssde-md.md)] applications can manage distributed transactions either through [!INCLUDE[tsql](../includes/tsql-md.md)] or the database API.</span></span> <span data-ttu-id="a5bd4-232">Дополнительные сведения см. в статье [BEGIN DISTRIBUTED TRANSACTION (Transact-SQL)](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-232">For more information, see [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span></span>  
  
#### <a name="ending-transactions"></a><span data-ttu-id="a5bd4-233">Завершение транзакций</span><span class="sxs-lookup"><span data-stu-id="a5bd4-233">Ending Transactions</span></span>  

 <span data-ttu-id="a5bd4-234">Транзакции можно завершить инструкцией COMMIT или ROLLBACK, а также с помощью соответствующей функции API.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-234">You can end transactions with either a COMMIT or ROLLBACK statement, or through a corresponding API function.</span></span>  
  
 <span data-ttu-id="a5bd4-235">COMMIT</span><span class="sxs-lookup"><span data-stu-id="a5bd4-235">COMMIT</span></span>  
 <span data-ttu-id="a5bd4-236">Если транзакция выполнена успешно, ее следует зафиксировать.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-236">If a transaction is successful, commit it.</span></span> <span data-ttu-id="a5bd4-237">Инструкция COMMIT гарантирует, что все изменения в пределах данной транзакции стали постоянной частью базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-237">A COMMIT statement guarantees all of the transaction's modifications are made a permanent part of the database.</span></span> <span data-ttu-id="a5bd4-238">Инструкция COMMIT также освобождает используемые транзакцией ресурсы, такие как блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-238">A COMMIT also frees resources, such as locks, used by the transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-239">ROLLBACK</span><span class="sxs-lookup"><span data-stu-id="a5bd4-239">ROLLBACK</span></span>  
 <span data-ttu-id="a5bd4-240">Если в транзакции произойдет ошибка или пользователь решит отменить транзакцию, следует выполнить ее откат.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-240">If an error occurs in a transaction, or if the user decides to cancel the transaction, then roll the transaction back.</span></span> <span data-ttu-id="a5bd4-241">Инструкция ROLLBACK отменяет все изменения, сделанные в пределах транзакции, возвращая данные в то состояние, в котором они находились на начало транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-241">A ROLLBACK statement backs out all modifications made in the transaction by returning the data to the state it was in at the start of the transaction.</span></span> <span data-ttu-id="a5bd4-242">Инструкция ROLLBACK также освобождает удерживаемые транзакцией ресурсы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-242">A ROLLBACK also frees resources held by the transaction.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-243">Во время соединений, для которых включена поддержка режима MARS, невозможно зафиксировать явную транзакцию, начатую с помощью функции API, пока имеются запросы, ожидающие выполнения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-243">Under connections enabled to support multiple active result sets (MARS), an explicit transaction started through an API function cannot be committed while there are pending requests for execution.</span></span> <span data-ttu-id="a5bd4-244">Любая попытка зафиксировать этот тип транзакции при работающих необработанных операциях завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-244">Any attempt to commit this type of  transaction while there are outstanding operations running will result in an error.</span></span>  
  
#### <a name="errors-during-transaction-processing"></a><span data-ttu-id="a5bd4-245">Ошибки, возникающие в процессе обработки транзакций</span><span class="sxs-lookup"><span data-stu-id="a5bd4-245">Errors During Transaction Processing</span></span>  

 <span data-ttu-id="a5bd4-246">Если ошибка делает невозможным успешное выполнение транзакции, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] автоматически выполняет ее откат и освобождает ресурсы, удерживаемые транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-246">If an error prevents the successful completion of a transaction, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] automatically rolls back the transaction and frees all resources held by the transaction.</span></span> <span data-ttu-id="a5bd4-247">Если сетевое соединение клиента с экземпляром компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] разорвано, то после того, как экземпляр получит уведомление от сети о разрыве соединения, выполняется откат всех необработанных транзакций для этого соединения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-247">If the client's network connection to an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] is broken, any outstanding transactions for the connection are rolled back when the network notifies the instance of the break.</span></span> <span data-ttu-id="a5bd4-248">В случае сбоя клиентского приложения, выключения либо перезапуска клиентского компьютера соединение также будет разорвано, а экземпляр компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] выполнит откат всех необработанных транзакций после получения уведомления о разрыве от сети.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-248">If the client application fails or if the client computer goes down or is restarted, this also breaks the connection, and the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] rolls back any outstanding connections when the network notifies it of the break.</span></span> <span data-ttu-id="a5bd4-249">Если клиент выйдет из приложения, выполняется откат всех необработанных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-249">If the client logs off the application, any outstanding transactions are rolled back.</span></span>  
  
 <span data-ttu-id="a5bd4-250">В случае ошибки во время выполнения инструкции (нарушения ограничения) в пакете, по умолчанию компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] выполнит откат только той инструкции, которая привела к ошибке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-250">If a run-time statement error (such as a constraint violation) occurs in a batch, the default behavior in the [!INCLUDE[ssDE](../includes/ssde-md.md)] is to roll back only the statement that generated the error.</span></span> <span data-ttu-id="a5bd4-251">Это поведение можно изменить с помощью инструкции SET XACT_ABORT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-251">You can change this behavior using the SET XACT_ABORT statement.</span></span> <span data-ttu-id="a5bd4-252">После выполнения инструкции SET XACT_ABORT ON любая ошибка во время выполнения инструкции приведет к автоматическому откату текущей транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-252">After SET XACT_ABORT ON is executed, any run-time statement error causes an automatic rollback of the current transaction.</span></span> <span data-ttu-id="a5bd4-253">Инструкция SET XACT_ABORT не влияет на компиляцию ошибок (например, синтаксических).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-253">Compile errors, such as syntax errors, are not affected by SET XACT_ABORT.</span></span> <span data-ttu-id="a5bd4-254">Дополнительные сведения см. в разделе [SET XACT_ABORT (Transact-SQL)](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-254">For more information, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-255">На случай возникновения ошибок код приложения должен содержать корректирующее действие: COMMIT или ROLLBACK.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-255">When errors occur, corrective action (COMMIT or ROLLBACK) should be included in application code.</span></span> <span data-ttu-id="a5bd4-256">Одним из эффективных средств обработки ошибок, включая транзакции в транзакциях, является [!INCLUDE[tsql](../includes/tsql-md.md)] try... CATCH.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-256">One effective tool for handling errors, including those in transactions, is the [!INCLUDE[tsql](../includes/tsql-md.md)] TRY...CATCH construct.</span></span> <span data-ttu-id="a5bd4-257">Дополнительные сведения с примерами, которые включают транзакции, см. в разделе [TRY...CATCH (Transact-SQL)](/sql/t-sql/language-elements/try-catch-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-257">For more information with examples that include transactions, see [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span></span> <span data-ttu-id="a5bd4-258">Начиная с [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] , можно использовать инструкцию throw для вызова исключения и передачи выполнения блоку catch блока try... CATCH.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-258">Beginning with [!INCLUDE[ssSQL11](../includes/sssql11-md.md)], you can use the THROW statement to raise an exception and transfers execution to a CATCH block of a TRY...CATCH construct.</span></span> <span data-ttu-id="a5bd4-259">Дополнительные сведения см. в разделе [THROW (Transact-SQL)](/sql/t-sql/language-elements/throw-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-259">For more information, see [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span></span>  
  
##### <a name="compile-and-run-time-errors-in-autocommit-mode"></a><span data-ttu-id="a5bd4-260">Ошибки времени компиляции и выполнения в режиме автоматической фиксации</span><span class="sxs-lookup"><span data-stu-id="a5bd4-260">Compile and Run-time Errors in Autocommit mode</span></span>  

 <span data-ttu-id="a5bd4-261">Иногда в режиме автоматической фиксации экземпляр компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] откатывает назад весь пакет вместо одной инструкции SQL.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-261">In autocommit mode, it sometimes appears as if an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] has rolled back an entire batch instead of just one SQL statement.</span></span> <span data-ttu-id="a5bd4-262">Это происходит, если ошибка возникает во время компиляции, а не во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-262">This happens if the error encountered is a compile error, not a run-time error.</span></span> <span data-ttu-id="a5bd4-263">Ошибка компиляции не позволяет компоненту [!INCLUDE[ssDE](../includes/ssde-md.md)] построить план выполнения, поэтому пакет не выполняется.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-263">A compile error prevents the [!INCLUDE[ssDE](../includes/ssde-md.md)] from building an execution plan, so nothing in the batch is executed.</span></span> <span data-ttu-id="a5bd4-264">Поскольку произошел откат назад всех инструкций, предшествующих неправильной инструкции, нельзя выполнить весь пакет.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-264">Although it appears that all of the statements before the one generating the error were rolled back, the error prevented anything in the batch from being executed.</span></span> <span data-ttu-id="a5bd4-265">В следующем примере ни одна из инструкций `INSERT` в третьем пакете не выполнится из-за ошибки компиляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-265">In the following example, none of the `INSERT` statements in the third batch are executed because of a compile error.</span></span> <span data-ttu-id="a5bd4-266">При этом произойдет откат первых двух инструкций `INSERT` и они не будут выполняться ни при каких условиях.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-266">It appears that the first two `INSERT` statements are rolled back when they are never executed.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUSE (3, 'ccc');  -- Syntax error.  
GO  
SELECT * FROM TestBatch;  -- Returns no rows.  
GO  
```  
  
 <span data-ttu-id="a5bd4-267">В следующем примере третья инструкция `INSERT` вызывает ошибку повторения первичного ключа во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-267">In the following example, the third `INSERT` statement generates a run-time duplicate primary key error.</span></span> <span data-ttu-id="a5bd4-268">Первые две инструкции `INSERT` выполняются успешно и фиксируются, поэтому остаются после возникновения ошибки времени выполнения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-268">The first two `INSERT` statements are successful and committed, so they remain after the run-time error.</span></span>  
  
```sql  
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUES (1, 'ccc');  -- Duplicate key error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="a5bd4-269">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] использует отложенное разрешение имен, при котором имена объектов разрешаются только во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-269">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses deferred name resolution, in which object names are not resolved until execution time.</span></span> <span data-ttu-id="a5bd4-270">В следующем примере первые две инструкции `INSERT` выполняются и фиксируются, а вставленные строки остаются в таблице `TestBatch` после того, как третья инструкция `INSERT` вызывает ошибку времени выполнения, ссылаясь на таблицу, которой не существует.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-270">In the following example, the first two `INSERT` statements are executed and committed, and those two rows remain in the `TestBatch` table after the third `INSERT` statement generates a run-time error by referring to a table that does not exist.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBch VALUES (3, 'ccc');  -- Table name error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="a5bd4-271">![Значок стрелки, используемый в ссылке "назад на начало](media/uparrow16x16.gif "Значок стрелки, используемый со ссылкой В начало") " [в этом пошаговом окне](#Top)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-271">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-and-row-versioning-basics"></a><a name="Lock_Basics"></a> <span data-ttu-id="a5bd4-272">Общие сведения о блокировке и управлении версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-272">Locking and Row Versioning Basics</span></span>  

 <span data-ttu-id="a5bd4-273">Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] использует следующие механизмы для гарантии целостности транзакций и поддержания согласованности баз данных, когда несколько пользователей обращаются к одним и тем же данным в одно и то же время.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-273">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses the following mechanisms to ensure the integrity of transactions and maintain the consistency of databases when multiple users are accessing data at the same time:</span></span>  
  
-   <span data-ttu-id="a5bd4-274">Блокировка</span><span class="sxs-lookup"><span data-stu-id="a5bd4-274">Locking</span></span>  
  
     <span data-ttu-id="a5bd4-275">Каждая транзакция запрашивает блокировку разных типов ресурсов, например строк, страниц или таблиц, от которых эта транзакция зависит.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-275">Each transaction requests locks of different types on the resources, such as rows, pages, or tables, on which the transaction is dependent.</span></span> <span data-ttu-id="a5bd4-276">Блокировка не дает другим транзакциям изменять ресурсы, чтобы избежать ошибок в транзакции, запросившей блокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-276">The locks block other transactions from modifying the resources in a way that would cause problems for the transaction requesting the lock.</span></span> <span data-ttu-id="a5bd4-277">Каждая транзакция освобождает свои блокировки, если больше не зависит от блокируемого ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-277">Each transaction frees its locks when it no longer has a dependency on the locked resources.</span></span>  
  
-   <span data-ttu-id="a5bd4-278">Управление версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-278">Row versioning</span></span>  
  
     <span data-ttu-id="a5bd4-279">Если используется уровень изоляции на основе управления версиями, компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] хранит версии каждой измененной строки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-279">When a row versioning-based isolation level is enabled, the [!INCLUDE[ssDE](../includes/ssde-md.md)] maintains versions of each row that is modified.</span></span> <span data-ttu-id="a5bd4-280">Приложения могут указать, что транзакция будет использовать версии строк для просмотра данных, существовавших до ее начала или до начала запроса, вместо того, чтобы защищать все операции чтения блокировками.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-280">Applications can specify that a transaction use the row versions to view data as it existed at the start of the transaction or query instead of protecting all reads with locks.</span></span> <span data-ttu-id="a5bd4-281">При управлении версиями строк вероятность того, что операция чтения будет блокировать другие транзакции, значительно снижается.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-281">By using row versioning, the chance that a read operation will block other transactions is greatly reduced.</span></span>  
  
 <span data-ttu-id="a5bd4-282">Блокировка и управление версиями строк не дают пользователям считывать незафиксированные данные и не дают нескольким пользователям менять одни и те же данные в одно и то же время.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-282">Locking and row versioning prevent users from reading uncommitted data and prevent multiple users from attempting to change the same data at the same time.</span></span> <span data-ttu-id="a5bd4-283">Без этих механизмов запросы к таким данным могли бы возвращать непредвиденные результаты, например данные, которые еще не были зафиксированы в базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-283">Without locking or row versioning, queries executed against that data could produce unexpected results by returning data that has not yet been committed in the database.</span></span>  
  
 <span data-ttu-id="a5bd4-284">Приложения могут выбирать уровни изоляции транзакций, которые определяют уровень защиты транзакции от изменений, внесенных другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-284">Applications can choose transaction isolation levels, which define the level of protection for the transaction from modifications made by other transactions.</span></span> <span data-ttu-id="a5bd4-285">Для отдельных инструкций [!INCLUDE[tsql](../includes/tsql-md.md)] могут быть заданы указания таблиц для дальнейшего уточнения поведения, соответствующего требованиям приложения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-285">Table-level hints can be specified for individual [!INCLUDE[tsql](../includes/tsql-md.md)] statements to further tailor behavior to fit the requirements of the application.</span></span>  
  
### <a name="managing-concurrent-data-access"></a><span data-ttu-id="a5bd4-286">Управление параллельным доступом к данным</span><span class="sxs-lookup"><span data-stu-id="a5bd4-286">Managing Concurrent Data Access</span></span>  

 <span data-ttu-id="a5bd4-287">Когда пользователи обращаются к ресурсу одновременно, говорят, что они делают это параллельно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-287">Users who access a resource at the same time are said to be accessing the resource concurrently.</span></span> <span data-ttu-id="a5bd4-288">Параллельный доступ к данным требует наличия механизмов предотвращения нежелательных последствий, которые могут возникнуть при попытке пользователей изменить ресурсы, активно используемые другими.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-288">Concurrent data access requires mechanisms to prevent adverse effects when multiple users try to modify resources that other users are actively using.</span></span>  
  
#### <a name="concurrency-effects"></a><span data-ttu-id="a5bd4-289">Эффекты параллелизма</span><span class="sxs-lookup"><span data-stu-id="a5bd4-289">Concurrency Effects</span></span>  

 <span data-ttu-id="a5bd4-290">Изменение данных пользователями может оказывать влияние на других пользователей, считывающих или изменяющих эти же данные в этот же момент времени.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-290">Users modifying data can affect other users who are reading or modifying the same data at the same time.</span></span> <span data-ttu-id="a5bd4-291">В этом случае говорят, что пользователи получают параллельный доступ к этим данным.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-291">These users are said to be accessing the data concurrently.</span></span> <span data-ttu-id="a5bd4-292">Если в системе хранения данных отсутствует управление параллелизмом, то могут наблюдаться следующие побочные эффекты.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-292">If a data storage system has no concurrency control, users could see the following side effects:</span></span>  
  
-   <span data-ttu-id="a5bd4-293">Потерянные обновления</span><span class="sxs-lookup"><span data-stu-id="a5bd4-293">Lost updates</span></span>  
  
     <span data-ttu-id="a5bd4-294">Потерянные обновления возникают, когда две или более транзакций выбирают одну и ту же строку и изменяют ее на основании ее исходного значения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-294">Lost updates occur when two or more transactions select the same row and then update the row based on the value originally selected.</span></span> <span data-ttu-id="a5bd4-295">Каждая транзакция не знает о других транзакциях.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-295">Each transaction is unaware of the other transactions.</span></span> <span data-ttu-id="a5bd4-296">Последнее обновление изменяет данные других транзакций, что приводит к потере данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-296">The last update overwrites updates made by the other transactions, which results in lost data.</span></span>  
  
     <span data-ttu-id="a5bd4-297">Например, у двух редакторов есть электронные копии одного и того же документа.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-297">For example, two editors make an electronic copy of the same document.</span></span> <span data-ttu-id="a5bd4-298">Каждый редактор изменяет свою копию независимо и затем сохраняет ее, перезаписывая исходный документ.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-298">Each editor changes the copy independently and then saves the changed copy thereby overwriting the original document.</span></span> <span data-ttu-id="a5bd4-299">Редактор, сохраняющий свою измененную копию, перезаписывает изменения, сделанные другим редактором.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-299">The editor who saves the changed copy last overwrites the changes made by the other editor.</span></span> <span data-ttu-id="a5bd4-300">Этой проблемы можно избежать, если у одного редактора не будет доступа к этому файлу до завершения и фиксации транзакции другого редактора.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-300">This problem could be avoided if one editor could not access the file until the other editor had finished and committed the transaction.</span></span>  
  
-   <span data-ttu-id="a5bd4-301">Незафиксированная зависимость («грязное» чтение)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-301">Uncommitted dependency (dirty read)</span></span>  
  
     <span data-ttu-id="a5bd4-302">Незафиксированная зависимость возникает, когда вторая транзакция выбирает строку, изменяемую в данный момент другой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-302">Uncommitted dependency occurs when a second transaction selects a row that is being updated by another transaction.</span></span> <span data-ttu-id="a5bd4-303">Вторая транзакция будет считывать данные, которые еще не зафиксированы и могут быть изменены первой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-303">The second transaction is reading data that has not been committed yet and may be changed by the transaction updating the row.</span></span>  
  
     <span data-ttu-id="a5bd4-304">Например, редактор изменяет электронный документ.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-304">For example, an editor is making changes to an electronic document.</span></span> <span data-ttu-id="a5bd4-305">В это время второй редактор снимает копию этого документа, включающую уже сделанные изменения, и распространяет этот документ предполагаемой аудитории.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-305">During the changes, a second editor takes a copy of the document that includes all the changes made so far, and distributes the document to the intended audience.</span></span> <span data-ttu-id="a5bd4-306">Затем первый редактор решает, что сделанные изменения неправильны, удаляет их и сохраняет документ.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-306">The first editor then decides the changes made so far are wrong and removes the edits and saves the document.</span></span> <span data-ttu-id="a5bd4-307">Распространенный документ содержит изменения, которые уже не существуют и должны считаться никогда не существовавшими.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-307">The distributed document contains edits that no longer exist and should be treated as if they never existed.</span></span> <span data-ttu-id="a5bd4-308">Этой проблемы можно избежать, если никто не сможет считать измененный документ, пока первый редактор не сохранит окончательную версию изменений и не зафиксирует эту транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-308">This problem could be avoided if no one could read the changed document until the first editor does the final save of modifications and commits the transaction.</span></span>  
  
-   <span data-ttu-id="a5bd4-309">Анализ несогласованности (неповторяющееся чтение)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-309">Inconsistent analysis (nonrepeatable read)</span></span>  
  
     <span data-ttu-id="a5bd4-310">Анализ несогласованности возникает, когда вторая транзакция осуществляет доступ к одной строке несколько раз, и каждый раз считывает разные данные.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-310">Inconsistent analysis occurs when a second transaction accesses the same row several times and reads different data each time.</span></span> <span data-ttu-id="a5bd4-311">Анализ несогласованности сходен с незафиксированной зависимостью, когда транзакция изменяет данные, считываемые другой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-311">Inconsistent analysis is similar to uncommitted dependency in that another transaction is changing the data that a second transaction is reading.</span></span> <span data-ttu-id="a5bd4-312">Однако в анализе несогласованности данные, считываемые второй транзакцией, были зафиксированы транзакцией, которая сделала изменения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-312">However, in inconsistent analysis, the data read by the second transaction was committed by the transaction that made the change.</span></span> <span data-ttu-id="a5bd4-313">Кроме того, анализ несогласованности подразумевает несколько операций чтения (две и более) одной строки, при которых каждый раз данные изменяются другой транзакцией, это называется также неповторяющейся операцией чтения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-313">Also, inconsistent analysis involves multiple reads (two or more) of the same row, and each time the information is changed by another transaction; thus, the term nonrepeatable read.</span></span>  
  
     <span data-ttu-id="a5bd4-314">Например, редактор считывает один и тот же документ дважды, но между этими операциями модуль записи перезаписывает этот документ.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-314">For example, an editor reads the same document twice, but between each reading the writer rewrites the document.</span></span> <span data-ttu-id="a5bd4-315">Когда редактор считывает документ во второй раз, он уже изменен.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-315">When the editor reads the document for the second time, it has changed.</span></span> <span data-ttu-id="a5bd4-316">Первую операцию чтения повторить нельзя.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-316">The original read was not repeatable.</span></span> <span data-ttu-id="a5bd4-317">Этой проблемы можно избежать, если модуль записи не сможет изменять документ, пока редактор не считает его в последний раз.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-317">This problem could be avoided if the writer could not change the document until the editor has finished reading it for the last time.</span></span>  
  
-   <span data-ttu-id="a5bd4-318">Фантомные операции чтения</span><span class="sxs-lookup"><span data-stu-id="a5bd4-318">Phantom reads</span></span>  
  
     <span data-ttu-id="a5bd4-319">Чтение фантомных данных — это ситуация, которая возникает при выполнении двух идентичных запросов, если набор строк, возвращаемых вторым запросом, отличается от первого.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-319">A phantom read is a situation that occurs when two identical queries are executed and the collection of rows returned by the second query is different.</span></span> <span data-ttu-id="a5bd4-320">В приведенном ниже примере показано, как это может происходить.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-320">The example below shows how this may occur.</span></span> <span data-ttu-id="a5bd4-321">Предположим, что две приведенные ниже транзакции выполняются одновременно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-321">Assume the two transactions below are executing at the same time.</span></span> <span data-ttu-id="a5bd4-322">Две инструкции SELECT в первой транзакции могут возвращать разные результаты, поскольку инструкция INSERT во второй транзакции изменяет данные, используемые обеими этими инструкциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-322">The two SELECT statements in the first transaction may return different results because the INSERT statement in the second transaction changes the data used by both.</span></span>  
  
    ```sql  
    --Transaction 1  
    BEGIN TRAN;  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    --The INSERT statement from the second transaction occurs here.  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    COMMIT;  
    ```  
  
    ```sql  
    --Transaction 2  
    BEGIN TRAN;  
    INSERT INTO dbo.employee  
       SET name = 'New' WHERE ID = 5;  
    COMMIT;   
    ```  
  
-   <span data-ttu-id="a5bd4-323">Отсутствующие или дублированные операции чтения, вызванные обновлениями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-323">Missing and double reads caused by row updates</span></span>  
  
    -   <span data-ttu-id="a5bd4-324">Исчезновение обновленной строки или ее многократное отображение</span><span class="sxs-lookup"><span data-stu-id="a5bd4-324">Missing a updated row or seeing an updated row multiple times</span></span>  
  
         <span data-ttu-id="a5bd4-325">Транзакции, работающие на уровне изоляции READ UNCOMMITTED, не используют совмещаемые блокировки, чтобы предотвратить изменение считываемых текущей транзакцией данных другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-325">Transactions that are running at the READ UNCOMMITTED level do not issue shared locks to prevent other transactions from modifying data read by the current transaction.</span></span> <span data-ttu-id="a5bd4-326">Транзакции, работающие на уровне изоляции READ COMMITTED, используют совмещаемые блокировки, однако блокировки строк и страниц снимаются после чтения строки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-326">Transactions that are running at the READ COMMITTED level do issue shared locks, but the row or page locks are released after the row is read.</span></span> <span data-ttu-id="a5bd4-327">В любом случае, если во время сканирования индекса другой пользователь изменит ключевой столбец индекса для строки, считывание которой происходит в данный момент, причем строка была перемещена в позицию, до которой операция сканирования еще не дошла, эта строка может появиться повторно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-327">In either case, when you are scanning an index, if another user changes the index key column of the row during your read, the row might appear again if the key change moved the row to a position ahead of your scan.</span></span> <span data-ttu-id="a5bd4-328">Аналогично, если изменение ключа переместило строку в позицию, считывание которой уже прошло, то она может не отобразиться.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-328">Similarly, the row might not appear if the key change moved the row to a position in the index that you had already read.</span></span> <span data-ttu-id="a5bd4-329">Чтобы избежать этого, воспользуйтесь указаниями SERIALIZABLE или HOLDLOCK либо управлением версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-329">To avoid this, use the SERIALIZABLE or HOLDLOCK hint, or row versioning.</span></span> <span data-ttu-id="a5bd4-330">Дополнительные сведения см. в разделе [Табличные указания (Transact-SQL)](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-330">For more information, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
    -   <span data-ttu-id="a5bd4-331">Отсутствие одной или нескольких строк, которые не подвергались обновлению</span><span class="sxs-lookup"><span data-stu-id="a5bd4-331">Missing one or more rows that were not the target of update</span></span>  
  
         <span data-ttu-id="a5bd4-332">Пропажа строк может возникнуть в случае, если при использовании уровня READ UNCOMMITTED запрос читает строки в порядке их расположения (с использованием IAM-страниц), а другая транзакция вызывает разбиение страницы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-332">When you are using READ UNCOMMITTED, if your query reads rows using an allocation order scan (using IAM pages), you might miss rows if another transaction is causing a page split.</span></span> <span data-ttu-id="a5bd4-333">Этого не может произойти при использовании уровня изоляции READ COMMITTED, поскольку во время разбиения страницы включается блокировка таблицы. Также этого не может произойти, если таблица не имеет кластеризованного индекса, поскольку в таком случае обновления не вызывают разбиения страниц.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-333">This cannot occur when you are using read committed because a table lock is held during a page split and does not happen if the table does not have a clustered index, because updates do not cause page splits.</span></span>  
  
#### <a name="types-of-concurrency"></a><span data-ttu-id="a5bd4-334">Типы параллелизма</span><span class="sxs-lookup"><span data-stu-id="a5bd4-334">Types of Concurrency</span></span>  

 <span data-ttu-id="a5bd4-335">Если несколько пользователей одновременно пытаются выполнять изменения в базе данных, следует реализовать систему элементов управления, с тем чтобы изменения, проводимые одним пользователем, не затрагивали работу другого пользователя.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-335">When many people attempt to modify data in a database at the same time, a system of controls must be implemented so that modifications made by one person do not adversely affect those of another person.</span></span> <span data-ttu-id="a5bd4-336">Такая система называется управлением параллелизм.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-336">This is called concurrency control.</span></span>  
  
 <span data-ttu-id="a5bd4-337">Теория управления параллелизмом предлагает два способа осуществления управления параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-337">Concurrency control theory has two classifications for the methods of instituting concurrency control:</span></span>  
  
-   <span data-ttu-id="a5bd4-338">Пессимистическое управление параллелизмом</span><span class="sxs-lookup"><span data-stu-id="a5bd4-338">Pessimistic concurrency control</span></span>  
  
     <span data-ttu-id="a5bd4-339">Система блокировок не допускает, чтобы изменение данных одними пользователями влияло на других пользователей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-339">A system of locks prevents users from modifying data in a way that affects other users.</span></span> <span data-ttu-id="a5bd4-340">После того как действие пользователя приводит к блокировке, до тех пор пока инициатор ее не снимет, другие пользователи не могут выполнять действия, которые могут вызвать конфликт с блокировкой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-340">After a user performs an action that causes a lock to be applied, other users cannot perform actions that would conflict with the lock until the owner releases it.</span></span> <span data-ttu-id="a5bd4-341">Это называется пессимистическим управлением, поскольку в основном применяется в средах с большим количеством состязаний данных, где затраты на защиту данных с помощью блокировок меньше затрат на откат транзакций в случае конфликтов параллелизма.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-341">This is called pessimistic control because it is mainly used in environments where there is high contention for data, where the cost of protecting data with locks is less than the cost of rolling back transactions if concurrency conflicts occur.</span></span>  
  
-   <span data-ttu-id="a5bd4-342">Управление оптимистическим параллелизмом</span><span class="sxs-lookup"><span data-stu-id="a5bd4-342">Optimistic concurrency control</span></span>  
  
     <span data-ttu-id="a5bd4-343">При оптимистическом управлении параллелизмом пользователи не блокируют данные на период чтения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-343">In optimistic concurrency control, users do not lock data when they read it.</span></span> <span data-ttu-id="a5bd4-344">Когда пользователь обновляет данные, система проверяет, вносил ли другой пользователь в них изменение после считывания.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-344">When a user updates data, the system checks to see if another user changed the data after it was read.</span></span> <span data-ttu-id="a5bd4-345">Если другой пользователь изменял данные, возникает ошибка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-345">If another user updated the data, an error is raised.</span></span> <span data-ttu-id="a5bd4-346">Как правило, при получении сообщения об ошибке пользователь откатывает транзакцию и начинает ее заново.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-346">Typically, the user receiving the error rolls back the transaction and starts over.</span></span> <span data-ttu-id="a5bd4-347">Это называется оптимистическим управлением, поскольку в основном применяется в средах с небольшим количеством состязаний данных, где затраты на периодический откат транзакции меньше затрат на блокировку данных при считывании.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-347">This is called optimistic because it is mainly used in environments where there is low contention for data, and where the cost of occasionally rolling back a transaction is lower than the cost of locking data when read.</span></span>  
  
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="a5bd4-348">поддерживает ряд средств управления параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-348">supports a range of concurrency control.</span></span> <span data-ttu-id="a5bd4-349">Пользователи задают тип управления параллелизмом посредством выбора уровней изоляции транзакций для соединений или параметров параллелизма для курсоров.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-349">Users specify the type of concurrency control by selecting transaction isolation levels for connections or concurrency options on cursors.</span></span> <span data-ttu-id="a5bd4-350">Эти атрибуты задаются с помощью инструкций [!INCLUDE[tsql](../includes/tsql-md.md)] или свойств и атрибутов API-интерфейсов баз данных, таких как ADO, ADO.NET, OLE DB и ODBC.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-350">These attributes can be defined using [!INCLUDE[tsql](../includes/tsql-md.md)] statements, or through the properties and attributes of database application programming interfaces (APIs) such as ADO, ADO.NET, OLE DB, and ODBC.</span></span>  
  
#### <a name="isolation-levels-in-the-database-engine"></a><span data-ttu-id="a5bd4-351">Уровни изоляции в компоненте Database Engine</span><span class="sxs-lookup"><span data-stu-id="a5bd4-351">Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="a5bd4-352">Транзакции указывают уровень изоляции, который определяет степень, до которой одна транзакция должна быть изолирована от изменений ресурса или данных, произведенных другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-352">Transactions specify an isolation level that defines the degree to which one transaction must be isolated from resource or data modifications made by other transactions.</span></span> <span data-ttu-id="a5bd4-353">Уровни изоляции описаны с точки зрения того, какие из побочных эффектов параллелизма разрешены (например, «грязные» чтения или фантомные чтения).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-353">Isolation levels are described in terms of which concurrency side-effects, such as dirty reads or phantom reads, are allowed.</span></span>  
  
 <span data-ttu-id="a5bd4-354">Уровни изоляции транзакций контролируют следующие параметры.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-354">Transaction isolation levels control:</span></span>  
  
-   <span data-ttu-id="a5bd4-355">Применение и типы блокировки при чтении данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-355">Whether locks are taken when data is read, and what type of locks are requested.</span></span>  
  
-   <span data-ttu-id="a5bd4-356">Время удержания блокировок чтения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-356">How long the read locks are held.</span></span>  
  
-   <span data-ttu-id="a5bd4-357">Использование операции чтения ссылок на строки, измененные другой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-357">Whether a read operation referencing rows modified by another transaction:</span></span>  
  
    -   <span data-ttu-id="a5bd4-358">Блокировка до тех пор, пока не будет снята монопольная блокировка строки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-358">Blocks until the exclusive lock on the row is freed.</span></span>  
  
    -   <span data-ttu-id="a5bd4-359">Извлечение зафиксированной версии строки, которая существовала в то время, когда началось выполнение инструкции или транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-359">Retrieves the committed version of the row that existed at the time the statement or transaction started.</span></span>  
  
    -   <span data-ttu-id="a5bd4-360">Считывание незафиксированного изменения данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-360">Reads the uncommitted data modification.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="a5bd4-361">Выбор уровня изоляции транзакции не влияет на блокировки, примененные для защиты изменений данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-361">Choosing a transaction isolation level does not affect the locks acquired to protect data modifications.</span></span> <span data-ttu-id="a5bd4-362">Транзакция всегда вызывает монопольную блокировку любых данных, которые она изменяет, и держит блокировку до тех пор, пока транзакция не завершится, независимо от уровня изоляции, установленного для транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-362">A transaction always gets an exclusive lock on any data it modifies, and holds that lock until the transaction completes, regardless of the isolation level set for that transaction.</span></span> <span data-ttu-id="a5bd4-363">Для операций чтения уровни изоляции транзакций, в основном, определяют уровень защиты от эффектов изменений, сделанных другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-363">For read operations, transaction isolation levels primarily define the level of protection from the effects of modifications made by other transactions.</span></span>  
  
 <span data-ttu-id="a5bd4-364">Более низкий уровень изоляции увеличивает возможность получения доступа к данным несколькими пользователями одновременно, но увеличивает число эффектов параллелизма (таких как «грязное» чтение или потерянные обновления), с которыми может столкнуться пользователь.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-364">A lower isolation level increases the ability of many users to access data at the same time, but increases the number of concurrency effects (such as dirty reads or lost updates) users might encounter.</span></span> <span data-ttu-id="a5bd4-365">Наоборот, более высокий уровень изоляции уменьшает число эффектов параллелизма, с которыми может столкнуться пользователь, но требует больше системных ресурсов и увеличивает шанс того, что одна транзакция блокирует другую.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-365">Conversely, a higher isolation level reduces the types of concurrency effects that users may encounter, but requires more system resources and increases the chances that one transaction will block another.</span></span> <span data-ttu-id="a5bd4-366">Выбор соответствующего уровня изоляции зависит от баланса между требованиями к целостности данных приложения и издержек каждого уровня изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-366">Choosing the appropriate isolation level depends on balancing the data integrity requirements of the application against the overhead of each isolation level.</span></span> <span data-ttu-id="a5bd4-367">Самый высокий уровень изоляции — изоляция упорядочиваемых транзакций — гарантирует, что транзакция получит в точности те же данные при каждой операции чтения, но достигается это применением уровня блокировки, при котором очень вероятно влияние на других пользователей в многопользовательских системах.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-367">The highest isolation level, serializable, guarantees that a transaction will retrieve exactly the same data every time it repeats a read operation, but it does this by performing a level of locking that is likely to impact other users in multi-user systems.</span></span> <span data-ttu-id="a5bd4-368">Самый низкий уровень изоляции — read uncommitted — может извлечь данные, которые были изменены, но не зафиксированы другой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-368">The lowest isolation level, read uncommitted, may retrieve data that has been modified but not committed by other transactions.</span></span> <span data-ttu-id="a5bd4-369">При изоляции уровня read uncommitted могут проявиться все эффекты параллелизма, но при таком уровне нет блокировки чтения или управления версиями, так что издержки минимальны.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-369">All of the concurrency side effects can happen in read uncommitted, but there is no read locking or versioning, so overhead is minimized.</span></span>  
  
##### <a name="database-engine-isolation-levels"></a><span data-ttu-id="a5bd4-370">Уровни изоляции компонента Database Engine</span><span class="sxs-lookup"><span data-stu-id="a5bd4-370">Database Engine Isolation Levels</span></span>  

 <span data-ttu-id="a5bd4-371">Стандарт ISO определяет следующие уровни изоляции, каждый из которых поддерживается компонентом [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-371">The ISO standard defines the following isolation levels, all of which are supported by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span></span>  
  
|<span data-ttu-id="a5bd4-372">Уровень изоляции</span><span class="sxs-lookup"><span data-stu-id="a5bd4-372">Isolation Level</span></span>|<span data-ttu-id="a5bd4-373">Определение</span><span class="sxs-lookup"><span data-stu-id="a5bd4-373">Definition</span></span>|  
|---------------------|----------------|  
|<span data-ttu-id="a5bd4-374">Уровень изоляции read uncommitted</span><span class="sxs-lookup"><span data-stu-id="a5bd4-374">Read uncommitted</span></span>|<span data-ttu-id="a5bd4-375">Самый низкий уровень изоляции, при котором транзакции изолируются до такой степени, чтобы только уберечь от считывания физически поврежденных данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-375">The lowest isolation level where transactions are isolated only enough to ensure that physically corrupt data is not read.</span></span> <span data-ttu-id="a5bd4-376">На этом уровне разрешено «грязное» чтение, поэтому одна транзакция может видеть еще не зафиксированные изменения, совершенные другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-376">In this level, dirty reads are allowed, so one transaction may see not-yet-committed changes made by other transactions.</span></span>|  
|<span data-ttu-id="a5bd4-377">Уровень изоляции read committed</span><span class="sxs-lookup"><span data-stu-id="a5bd4-377">Read committed</span></span>|<span data-ttu-id="a5bd4-378">Позволяет транзакции считывать данные, считанные до этого, но не измененные другой транзакцией, не ожидая завершения выполнения этой другой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-378">Allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="a5bd4-379">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] сохраняет блокировки записи (сформированные для выделенных данных) до конца транзакции, а блокировки чтения снимаются сразу же после выполнения инструкции SELECT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-379">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps write locks (acquired on selected data) until the end of the transaction, but read locks are released as soon as the SELECT operation is performed.</span></span> <span data-ttu-id="a5bd4-380">Это уровень компонента [!INCLUDE[ssDE](../includes/ssde-md.md)], заданный по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-380">This is the [!INCLUDE[ssDE](../includes/ssde-md.md)] default level.</span></span>|  
|<span data-ttu-id="a5bd4-381">Уровень изоляции repeatable read</span><span class="sxs-lookup"><span data-stu-id="a5bd4-381">Repeatable read</span></span>|<span data-ttu-id="a5bd4-382">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] сохраняет блокировки чтения и записи, сформированные для выделенных данных, до конца транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-382">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks that are acquired on selected data until the end of the transaction.</span></span> <span data-ttu-id="a5bd4-383">Однако из-за того, что блокировки диапазона не являются управляемыми, может возникнуть фантомное чтение.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-383">However, because range-locks are not managed, phantom reads can occur.</span></span>|  
|<span data-ttu-id="a5bd4-384">Упорядочиваемый уровень изоляции</span><span class="sxs-lookup"><span data-stu-id="a5bd4-384">Serializable</span></span>|<span data-ttu-id="a5bd4-385">Самый высокий уровень, при котором транзакции полностью изолированы друг от друга.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-385">The highest level where transactions are completely isolated from one another.</span></span> <span data-ttu-id="a5bd4-386">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] сохраняет блокировки чтения и записи, сформированные для выделенных данных, которые снимаются в конце транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-386">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks acquired on selected data to be released at the end of the transaction.</span></span> <span data-ttu-id="a5bd4-387">Блокировки диапазона формируются, когда инструкция SELECT использует предложение диапазона WHERE, в особенности для исключения фантомного чтения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-387">Range-locks are acquired when a SELECT operation uses a ranged WHERE clause, especially to avoid phantom reads.</span></span><br /><br /> <span data-ttu-id="a5bd4-388">**Примечание.** Операции DDL и транзакции с реплицированными таблицами могут завершиться ошибкой, если запрашивается сериализуемый уровень изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-388">**Note:** DDL operations and transactions on replicated tables may fail when serializable isolation level is requested.</span></span> <span data-ttu-id="a5bd4-389">Это происходит вследствие того, что запросы репликации используют указания, которые могут оказаться несовместимыми с сериализуемым уровнем изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-389">This is because replication queries use hints that may be incompatible with serializable isolation level.</span></span>|  
  
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="a5bd4-390">также поддерживает два дополнительных уровня изоляции транзакций, использующие управление версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-390">also supports two additional transaction isolation levels that use row versioning.</span></span> <span data-ttu-id="a5bd4-391">Один является реализацией уровня изоляции read committed, а второй — уровня изоляции транзакции, моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-391">One is an implementation of read committed isolation, and one is a transaction isolation level, snapshot.</span></span>  
  
|<span data-ttu-id="a5bd4-392">Уровень изоляции управления версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-392">Row Versioning Isolation Level</span></span>|<span data-ttu-id="a5bd4-393">Определение</span><span class="sxs-lookup"><span data-stu-id="a5bd4-393">Definition</span></span>|  
|------------------------------------|----------------|  
|<span data-ttu-id="a5bd4-394">Моментальный снимок с уровнем изоляции read committed</span><span class="sxs-lookup"><span data-stu-id="a5bd4-394">Read Committed Snapshot</span></span>|<span data-ttu-id="a5bd4-395">Если параметру базы данных READ_COMMITTED_SNAPSHOT присвоено значение ON, уровень изоляции read committed использует управление версиями строк для обеспечения согласованности считывания на уровне инструкций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-395">When the READ_COMMITTED_SNAPSHOT database option is set ON, read committed isolation uses row versioning to provide statement-level read consistency.</span></span> <span data-ttu-id="a5bd4-396">Операции чтения требуют применения только блокировок уровня таблицы SCH-S и не допускают применения блокировок строк или страниц.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-396">Read operations require only SCH-S table level locks and no page or row locks.</span></span> <span data-ttu-id="a5bd4-397">То есть компонент Database Engine использует управление версиями строк для представления каждой инструкции согласованного на уровне транзакций моментального снимка данных в том виде, который они имели на момент начала выполнения инструкции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-397">That is, the Database Engine uses row versioning to present each statement with a transactionally consistent snapshot of the data as it existed at the start of the statement.</span></span> <span data-ttu-id="a5bd4-398">Для защиты данных от обновления другими транзакциями блокировки не используются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-398">Locks are not used to protect the data from updates by other transactions.</span></span> <span data-ttu-id="a5bd4-399">Определяемая пользователем функция может вернуть данные, зафиксированные после начала выполнения инструкции, содержащей эту функцию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-399">A user-defined function can return data that was committed after the time the statement containing the UDF began.</span></span><br /><br /> <span data-ttu-id="a5bd4-400">Если параметр базы данных READ_COMMITTED_SNAPSHOT имеет значение OFF, которое является значением по умолчанию, то уровень изоляции read committed использует совмещаемые блокировки для предотвращения изменения строк другими транзакциями во время выполнения текущей транзакцией операции чтения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-400">When the READ_COMMITTED_SNAPSHOT database option is set OFF, which is the default setting, read committed isolation uses shared locks to prevent other transactions from modifying rows while the current transaction is running a read operation.</span></span> <span data-ttu-id="a5bd4-401">Совмещаемые блокировки также блокируют инструкции от считывания строк, измененных другими транзакциями, пока не завершится другая транзакция.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-401">The shared locks also block the statement from reading rows modified by other transactions until the other transaction is completed.</span></span> <span data-ttu-id="a5bd4-402">Обе реализации согласуются с определением ISO для уровня изоляции read committed.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-402">Both implementations meet the ISO definition of read committed isolation.</span></span>|  
|<span data-ttu-id="a5bd4-403">Моментальный снимок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-403">Snapshot</span></span>|<span data-ttu-id="a5bd4-404">Уровень изоляции моментальных снимков использует управление версиями строк для обеспечения согласованности чтения на уровне транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-404">The snapshot isolation level uses row versioning to provide transaction-level read consistency.</span></span> <span data-ttu-id="a5bd4-405">Операции чтения применяют только блокировки таблицы SCH-S и не применяют блокировок строк или страниц.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-405">Read operations acquire no page or row locks; only SCH-S table locks are acquired.</span></span> <span data-ttu-id="a5bd4-406">Если считываемые строки изменены другой транзакцией, то извлекается версия строки, которая существовала в момент запуска транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-406">When reading rows modified by another transaction, they retrieve the version of the row that existed when the transaction started.</span></span> <span data-ttu-id="a5bd4-407">Использовать для базы данных изоляцию моментального снимка можно, только если параметр базы данных ALLOW_SNAPSHOT_ISOLATION имеет значение ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-407">You can only use Snapshot isolation against a database when the ALLOW_SNAPSHOT_ISOLATION database option is set ON.</span></span> <span data-ttu-id="a5bd4-408">По умолчанию для пользовательских баз данных этот параметр установлен в OFF.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-408">By default, this option is set OFF for user databases.</span></span><br /><br /> <span data-ttu-id="a5bd4-409">**Примечание**. [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] не поддерживает управление версиями метаданных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-409">**Note:**  [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] does not support versioning of metadata.</span></span> <span data-ttu-id="a5bd4-410">Поэтому, не все операции DDL могут выполняться в явной транзакции, работающей с уровнем изоляции моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-410">For this reason, there are restrictions on what DDL operations can be performed in an explicit transaction that is running under snapshot isolation.</span></span> <span data-ttu-id="a5bd4-411">Следующие инструкции DDL недопустимы в транзакции, работающей при изоляции моментального снимка, после инструкции BEGIN TRANSACTION: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME и любые инструкции DDL среды CLR.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-411">The following DDL statements are not permitted under snapshot isolation after a BEGIN TRANSACTION statement: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME, or any common language runtime (CLR) DDL statement.</span></span> <span data-ttu-id="a5bd4-412">Эти инструкции разрешены при использовании изоляции моментального снимка в неявных транзакциях.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-412">These statements are permitted when you are using snapshot isolation within implicit transactions.</span></span> <span data-ttu-id="a5bd4-413">Неявная транзакция, по определению, это единственная инструкция, для которой возможно выполнение семантики изоляции моментального снимка, даже для инструкций DDL.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-413">An implicit transaction, by definition, is a single statement that makes it possible to enforce the semantics of snapshot isolation, even with DDL statements.</span></span> <span data-ttu-id="a5bd4-414">Нарушение этого принципа может вызвать ошибку 3961: "Сбой транзакции в режиме изоляции моментального снимка в базе данных"%. \* ls ", так как объект, к которому обращается инструкция, был изменен инструкцией DDL в другой параллельной транзакции с момента запуска этой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-414">Violations of this principle can cause error 3961: "Snapshot isolation transaction failed in database '%.\*ls' because the object accessed by the statement has been modified by a DDL statement in another concurrent transaction since the start of this transaction.</span></span> <span data-ttu-id="a5bd4-415">Это запрещено, поскольку управление версиями метаданных не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-415">It is not allowed because the metadata is not versioned.</span></span> <span data-ttu-id="a5bd4-416">Одновременное обновление метаданных может привести к несогласованности при совместном использовании с режимом изоляции моментального снимка».</span><span class="sxs-lookup"><span data-stu-id="a5bd4-416">A concurrent update to metadata could lead to inconsistency if mixed with snapshot isolation."</span></span>|  
  
 <span data-ttu-id="a5bd4-417">Следующая таблица показывает побочные эффекты параллелизма, допускаемые различными уровнями изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-417">The following table shows the concurrency side effects enabled by the different isolation levels.</span></span>  
  
|<span data-ttu-id="a5bd4-418">Уровень изоляции</span><span class="sxs-lookup"><span data-stu-id="a5bd4-418">Isolation level</span></span>|<span data-ttu-id="a5bd4-419">«Грязное» чтение</span><span class="sxs-lookup"><span data-stu-id="a5bd4-419">Dirty read</span></span>|<span data-ttu-id="a5bd4-420">Неповторяющееся чтение</span><span class="sxs-lookup"><span data-stu-id="a5bd4-420">Nonrepeatable read</span></span>|<span data-ttu-id="a5bd4-421">Фантомный</span><span class="sxs-lookup"><span data-stu-id="a5bd4-421">Phantom</span></span>|  
|---------------------|----------------|------------------------|-------------|  
|<span data-ttu-id="a5bd4-422">**Чтение не подтверждено**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-422">**Read uncommitted**</span></span>|<span data-ttu-id="a5bd4-423">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-423">Yes</span></span>|<span data-ttu-id="a5bd4-424">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-424">Yes</span></span>|<span data-ttu-id="a5bd4-425">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-425">Yes</span></span>|  
|<span data-ttu-id="a5bd4-426">**Чтение подтверждено**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-426">**Read committed**</span></span>|<span data-ttu-id="a5bd4-427">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-427">No</span></span>|<span data-ttu-id="a5bd4-428">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-428">Yes</span></span>|<span data-ttu-id="a5bd4-429">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-429">Yes</span></span>|  
|<span data-ttu-id="a5bd4-430">**Повторяющееся чтение**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-430">**Repeatable read**</span></span>|<span data-ttu-id="a5bd4-431">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-431">No</span></span>|<span data-ttu-id="a5bd4-432">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-432">No</span></span>|<span data-ttu-id="a5bd4-433">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-433">Yes</span></span>|  
|<span data-ttu-id="a5bd4-434">**Моментальный снимок**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-434">**Snapshot**</span></span>|<span data-ttu-id="a5bd4-435">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-435">No</span></span>|<span data-ttu-id="a5bd4-436">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-436">No</span></span>|<span data-ttu-id="a5bd4-437">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-437">No</span></span>|  
|<span data-ttu-id="a5bd4-438">**Сериализуемый**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-438">**Serializable**</span></span>|<span data-ttu-id="a5bd4-439">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-439">No</span></span>|<span data-ttu-id="a5bd4-440">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-440">No</span></span>|<span data-ttu-id="a5bd4-441">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-441">No</span></span>|  
  
 <span data-ttu-id="a5bd4-442">Дополнительные сведения о конкретных типах блокировки или управления версиями строк, контролируемых каждым уровнем изоляции транзакций, см. в разделе [SET TRANSACTION ISOLATION LEVEL (Transact-SQL)](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-442">For more information about the specific types of locking or row versioning controlled by each transaction isolation level, see [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-443">Уровни изоляции транзакций могут быть установлены с использованием [!INCLUDE[tsql](../includes/tsql-md.md)] или через API базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-443">Transaction isolation levels can be set using [!INCLUDE[tsql](../includes/tsql-md.md)] or through a database API.</span></span>  
  
 [!INCLUDE[tsql](../includes/tsql-md.md)]  
 <span data-ttu-id="a5bd4-444">В скриптах [!INCLUDE[tsql](../includes/tsql-md.md)] используется инструкция SET TRANSACTION ISOLATION LEVEL.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-444">[!INCLUDE[tsql](../includes/tsql-md.md)] scripts use the SET TRANSACTION ISOLATION LEVEL statement.</span></span>  
  
 <span data-ttu-id="a5bd4-445">ADO</span><span class="sxs-lookup"><span data-stu-id="a5bd4-445">ADO</span></span>  
 <span data-ttu-id="a5bd4-446">Приложения ADO устанавливают для свойства `IsolationLevel` объекта **Connection** значения adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead или adXactReadSerializable.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-446">ADO applications set the `IsolationLevel` property of the **Connection** object to adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead, or adXactReadSerializable.</span></span>  
  
 <span data-ttu-id="a5bd4-447">ADO.NET</span><span class="sxs-lookup"><span data-stu-id="a5bd4-447">ADO.NET</span></span>  
 <span data-ttu-id="a5bd4-448">Приложения ADO.NET, использующие управляемое пространство имен `System.Data.SqlClient`, могут вызывать метод `SqlConnection.BeginTransaction` и устанавливать для параметра *IsolationLevel* значения Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable и Snapshot.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-448">ADO.NET applications using the `System.Data.SqlClient` managed namespace can call the `SqlConnection.BeginTransaction` method and set the *IsolationLevel* option to Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable, and Snapshot.</span></span>  
  
 <span data-ttu-id="a5bd4-449">OLE DB</span><span class="sxs-lookup"><span data-stu-id="a5bd4-449">OLE DB</span></span>  
 <span data-ttu-id="a5bd4-450">Приступив к выполнению транзакции, приложения, использующие OLE DB, вызывают `ITransactionLocal::StartTransaction` с установленными для параметра *isoLevel* значениями ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT или ISOLATIONLEVEL_SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-450">When starting a transaction, applications using OLE DB call `ITransactionLocal::StartTransaction` with *isoLevel* set to ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT, or ISOLATIONLEVEL_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="a5bd4-451">При указании уровня изоляции транзакций в режиме автоматической фиксации приложения OLE DB applications могут присваивать свойству DBPROP_SESS_AUTOCOMMITISOLEVELS параметра DBPROPSET_SESSION значения DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED или DBPROPVAL_TI_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-451">When specifying the transaction isolation level in autocommit mode, OLE DB applications can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED, or DBPROPVAL_TI_SNAPSHOT.</span></span>  
  
 <span data-ttu-id="a5bd4-452">ODBC</span><span class="sxs-lookup"><span data-stu-id="a5bd4-452">ODBC</span></span>  
 <span data-ttu-id="a5bd4-453">Приложения ODBC вызывают `SQLSetConnectAttr` с установленным для параметра *Attribute* значением SQL_ATTR_TXN_ISOLATION и установленными для параметра *ValuePtr* значениями SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ или SQL_TXN_SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-453">ODBC applications call `SQLSetConnectAttr` with *Attribute* set to SQL_ATTR_TXN_ISOLATION and *ValuePtr* set to SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ, or SQL_TXN_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="a5bd4-454">Для транзакций моментального снимка приложения вызывают `SQLSetConnectAttr`, установив Attribute на SQL_COPT_SS_TXN_ISOLATION и ValuePtr на SQL_TXN_SS_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-454">For snapshot transactions, applications call `SQLSetConnectAttr` with Attribute set to SQL_COPT_SS_TXN_ISOLATION and ValuePtr set to SQL_TXN_SS_SNAPSHOT.</span></span> <span data-ttu-id="a5bd4-455">Транзакция моментального снимка может быть получена с использованием или SQL_COPT_SS_TXN_ISOLATION, или SQL_ATTR_TXN_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-455">A snapshot transaction can be retrieved using either SQL_COPT_SS_TXN_ISOLATION or SQL_ATTR_TXN_ISOLATION.</span></span>  
  
 <span data-ttu-id="a5bd4-456">![Значок стрелки, используемый в ссылке "назад на начало](media/uparrow16x16.gif "Значок стрелки, используемый со ссылкой В начало") " [в этом пошаговом окне](#Top)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-456">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-in-the-database-engine"></a><a name="Lock_Engine"></a> <span data-ttu-id="a5bd4-457">Блокировка в ядре СУБД</span><span class="sxs-lookup"><span data-stu-id="a5bd4-457">Locking in the Database Engine</span></span>  

 <span data-ttu-id="a5bd4-458">Блокировка — это механизм, с помощью которого компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] синхронизирует одновременный доступ нескольких пользователей к одному фрагменту данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-458">Locking is a mechanism used by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] to synchronize access by multiple users to the same piece of data at the same time.</span></span>  
  
 <span data-ttu-id="a5bd4-459">Прежде чем транзакция сможет распоряжаться текущим состоянием фрагмента данных, например для чтения или изменения данных, она должна защититься от изменений этих данных другой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-459">Before a transaction acquires a dependency on the current state of a piece of data, such as by reading or modifying the data, it must protect itself from the effects of another transaction modifying the same data.</span></span> <span data-ttu-id="a5bd4-460">Для этого транзакция запрашивает блокировку фрагмента данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-460">The transaction does this by requesting a lock on the piece of data.</span></span> <span data-ttu-id="a5bd4-461">Существует несколько режимов блокировки, например общая или монопольная.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-461">Locks have different modes, such as shared or exclusive.</span></span> <span data-ttu-id="a5bd4-462">Режим блокировки определяет уровень подчинения данных транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-462">The lock mode defines the level of dependency the transaction has on the data.</span></span> <span data-ttu-id="a5bd4-463">Ни одна транзакция не может получить блокировку, которая противоречит другой блокировке этих данных, предоставленной другой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-463">No transaction can be granted a lock that would conflict with the mode of a lock already granted on that data to another transaction.</span></span> <span data-ttu-id="a5bd4-464">Если транзакция запрашивает режим блокировки, противоречащий предоставленной ранее блокировке тех же данных, экземпляр компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] приостанавливает ее работу до тех пор, пока первая блокировка не освободится.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-464">If a transaction requests a lock mode that conflicts with a lock that has already been granted on the same data, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] will pause the requesting transaction until the first lock is released.</span></span>  
  
 <span data-ttu-id="a5bd4-465">При изменении фрагмента данных транзакция удерживает блокировку, защищая изменения до конца транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-465">When a transaction modifies a piece of data, it holds the lock protecting the modification until the end of the transaction.</span></span> <span data-ttu-id="a5bd4-466">Продолжительность блокировки, полученной для защиты операций чтения, зависит от уровня изоляции транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-466">How long a transaction holds the locks acquired to protect read operations depends on the transaction isolation level setting.</span></span> <span data-ttu-id="a5bd4-467">Все блокировки, удерживаемые транзакцией, освобождаются после ее завершения (при фиксации или откате).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-467">All locks held by a transaction are released when the transaction completes (either commits or rolls back).</span></span>  
  
 <span data-ttu-id="a5bd4-468">Приложения обычно не запрашивают блокировку напрямую.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-468">Applications do not typically request locks directly.</span></span> <span data-ttu-id="a5bd4-469">За управление блокировками отвечает внутренний компонент [!INCLUDE[ssDE](../includes/ssde-md.md)], называемый диспетчером блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-469">Locks are managed internally by a part of the [!INCLUDE[ssDE](../includes/ssde-md.md)] called the lock manager.</span></span> <span data-ttu-id="a5bd4-470">Когда экземпляр компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] обрабатывает инструкцию [!INCLUDE[tsql](../includes/tsql-md.md)], обработчик запросов компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] определяет, к каким ресурсам требуется доступ.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-470">When an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] processes a [!INCLUDE[tsql](../includes/tsql-md.md)] statement, the [!INCLUDE[ssDE](../includes/ssde-md.md)] query processor determines which resources are to be accessed.</span></span> <span data-ttu-id="a5bd4-471">Обработчик запросов определяет, какие типы блокировок требуются для защиты каждого ресурса, в зависимости от типа доступа и уровня изоляции транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-471">The query processor determines what types of locks are required to protect each resource based on the type of access and the transaction isolation level setting.</span></span> <span data-ttu-id="a5bd4-472">Затем обработчик запросов запрашивает соответствующую блокировку у диспетчера блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-472">The query processor then requests the appropriate locks from the lock manager.</span></span> <span data-ttu-id="a5bd4-473">Диспетчер блокировок предоставляет блокировку, если она не противоречит блокировкам, удерживаемым другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-473">The lock manager grants the locks if there are no conflicting locks held by other transactions.</span></span>  
  
### <a name="lock-granularity-and-hierarchies"></a><span data-ttu-id="a5bd4-474">Гранулярность блокировок и иерархии блокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-474">Lock Granularity and Hierarchies</span></span>  

 <span data-ttu-id="a5bd4-475">Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] поддерживает многогранулярную блокировку, позволяющую транзакции блокировать различные типы ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-475">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] has multigranular locking that allows different types of resources to be locked by a transaction.</span></span> <span data-ttu-id="a5bd4-476">Чтобы уменьшить издержки применения блокировок, компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] автоматически блокирует ресурсы на соответствующем задаче уровне.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-476">To minimize the cost of locking, the [!INCLUDE[ssDE](../includes/ssde-md.md)] locks resources automatically at a level appropriate to the task.</span></span> <span data-ttu-id="a5bd4-477">Блокировка при меньшей гранулярности, например на уровне строк, увеличивает параллелизм, но в то же время увеличивает и накладные расходы на обработку, поскольку при большом количестве блокируемых строк требуется больше блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-477">Locking at a smaller granularity, such as rows, increases concurrency but has a higher overhead because more locks must be held if many rows are locked.</span></span> <span data-ttu-id="a5bd4-478">Блокировки на большем уровне гранулярности, например на уровне таблиц, обходится дорого в отношении параллелизма, поскольку блокировка целой таблицы ограничивает доступ ко всем частям таблицы других транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-478">Locking at a larger granularity, such as tables, are expensive in terms of concurrency because locking an entire table restricts access to any part of the table by other transactions.</span></span> <span data-ttu-id="a5bd4-479">Однако накладные расходы в этом случае ниже, поскольку меньше количество поддерживаемых блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-479">However, it has a lower overhead because fewer locks are being maintained.</span></span>  
  
 <span data-ttu-id="a5bd4-480">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] часто получает блокировки на нескольких уровнях гранулярности одновременно, чтобы полностью защитить ресурс.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-480">The [!INCLUDE[ssDE](../includes/ssde-md.md)] often has to acquire locks at multiple levels of granularity to fully protect a resource.</span></span> <span data-ttu-id="a5bd4-481">Такая группа блокировок на нескольких уровнях гранулярности называется иерархией блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-481">This group of locks at multiple levels of granularity is called a lock hierarchy.</span></span> <span data-ttu-id="a5bd4-482">Например, чтобы полностью защитить операцию чтения индекса, экземпляру компоненту [!INCLUDE[ssDE](../includes/ssde-md.md)] может потребоваться получить разделяемые блокировки на строки и намеренные разделяемые блокировки на страницы и таблицу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-482">For example, to fully protect a read of an index, an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] may have to acquire share locks on rows and intent share locks on the pages and table.</span></span>  
  
 <span data-ttu-id="a5bd4-483">Следующая таблица содержит перечень ресурсов, которые могут блокироваться компонентом [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-483">The following table shows the resources that the [!INCLUDE[ssDE](../includes/ssde-md.md)] can lock.</span></span>  
  
|<span data-ttu-id="a5bd4-484">Ресурс</span><span class="sxs-lookup"><span data-stu-id="a5bd4-484">Resource</span></span>|<span data-ttu-id="a5bd4-485">Описание</span><span class="sxs-lookup"><span data-stu-id="a5bd4-485">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="a5bd4-486">RID</span><span class="sxs-lookup"><span data-stu-id="a5bd4-486">RID</span></span>|<span data-ttu-id="a5bd4-487">Идентификатор строки, используемый для блокировки одной строки в куче.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-487">A row identifier used to lock a single row within a heap.</span></span>|  
|<span data-ttu-id="a5bd4-488">KEY</span><span class="sxs-lookup"><span data-stu-id="a5bd4-488">KEY</span></span>|<span data-ttu-id="a5bd4-489">Блокировка строки в индексе, используемая для защиты диапазонов значений ключа в сериализуемых транзакциях.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-489">A row lock within an index used to protect key ranges in serializable transactions.</span></span>|  
|<span data-ttu-id="a5bd4-490">PAGE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-490">PAGE</span></span>|<span data-ttu-id="a5bd4-491">8-килобайтовая (КБ) страница в базе данных, например страница данных или индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-491">An 8-kilobyte (KB) page in a database, such as data or index pages.</span></span>|  
|<span data-ttu-id="a5bd4-492">EXTENT</span><span class="sxs-lookup"><span data-stu-id="a5bd4-492">EXTENT</span></span>|<span data-ttu-id="a5bd4-493">Упорядоченная группа из восьми страниц, например страниц данных или индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-493">A contiguous group of eight pages, such as data or index pages.</span></span>|  
|<span data-ttu-id="a5bd4-494">HoBT</span><span class="sxs-lookup"><span data-stu-id="a5bd4-494">HoBT</span></span>|<span data-ttu-id="a5bd4-495">Куча или сбалансированное дерево.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-495">A heap or B-tree.</span></span> <span data-ttu-id="a5bd4-496">Блокировка, защищающая сбалансированное дерево (индекс) или кучу страниц данных в таблице, не имеющей кластеризованного индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-496">A lock protecting a B-tree (index) or the heap data pages in a table that does not have a clustered index.</span></span>|  
|<span data-ttu-id="a5bd4-497">TABLE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-497">TABLE</span></span>|<span data-ttu-id="a5bd4-498">Таблица полностью, включая все данные и индексы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-498">The entire table, including all data and indexes.</span></span>|  
|<span data-ttu-id="a5bd4-499">FILE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-499">FILE</span></span>|<span data-ttu-id="a5bd4-500">Файл базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-500">A database file.</span></span>|  
|<span data-ttu-id="a5bd4-501">APPLICATION</span><span class="sxs-lookup"><span data-stu-id="a5bd4-501">APPLICATION</span></span>|<span data-ttu-id="a5bd4-502">Определяемый приложением ресурс.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-502">An application-specified resource.</span></span>|  
|<span data-ttu-id="a5bd4-503">METADATA</span><span class="sxs-lookup"><span data-stu-id="a5bd4-503">METADATA</span></span>|<span data-ttu-id="a5bd4-504">Блокировки метаданных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-504">Metadata locks.</span></span>|  
|<span data-ttu-id="a5bd4-505">ALLOCATION_UNIT</span><span class="sxs-lookup"><span data-stu-id="a5bd4-505">ALLOCATION_UNIT</span></span>|<span data-ttu-id="a5bd4-506">Единица распределения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-506">An allocation unit.</span></span>|  
|<span data-ttu-id="a5bd4-507">DATABASE</span><span class="sxs-lookup"><span data-stu-id="a5bd4-507">DATABASE</span></span>|<span data-ttu-id="a5bd4-508">База данных, полностью.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-508">The entire database.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-509">На блокировки HoBT и TABLE может влиять параметр LOCK_ESCALATION инструкции [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-509">HoBT and TABLE locks can be affected by the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="lock-modes"></a><span data-ttu-id="a5bd4-510">Режимы блокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-510">Lock Modes</span></span>  

 <span data-ttu-id="a5bd4-511">Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] блокирует ресурсы с помощью различных режимов блокировки, которые определяют доступ одновременных транзакций к ресурсам.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-511">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] locks resources using different lock modes that determine how the resources can be accessed by concurrent transactions.</span></span>  
  
 <span data-ttu-id="a5bd4-512">В следующей таблице показаны режимы блокировки ресурсов, применяемые компонентом [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-512">The following table shows the resource lock modes that the [!INCLUDE[ssDE](../includes/ssde-md.md)] uses.</span></span>  
  
|<span data-ttu-id="a5bd4-513">Режим блокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-513">Lock mode</span></span>|<span data-ttu-id="a5bd4-514">Описание</span><span class="sxs-lookup"><span data-stu-id="a5bd4-514">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="a5bd4-515">Совмещаемая блокировка (S)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-515">Shared (S)</span></span>|<span data-ttu-id="a5bd4-516">Используется для операций считывания, которые не меняют и не обновляют данные, такие как инструкция SELECT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-516">Used for read operations that do not change or update data, such as a SELECT statement.</span></span>|  
|<span data-ttu-id="a5bd4-517">Блокировка обновления (U)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-517">Update (U)</span></span>|<span data-ttu-id="a5bd4-518">Применяется к тем ресурсам, которые могут быть обновлены.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-518">Used on resources that can be updated.</span></span> <span data-ttu-id="a5bd4-519">Предотвращает возникновение распространенной формы взаимоблокировки, возникающей тогда, когда несколько сеансов считывают, блокируют и затем, возможно, обновляют ресурс.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-519">Prevents a common form of deadlock that occurs when multiple sessions are reading, locking, and potentially updating resources later.</span></span>|  
|<span data-ttu-id="a5bd4-520">Монопольная (Х)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-520">Exclusive (X)</span></span>|<span data-ttu-id="a5bd4-521">Используется для операций модификации данных, таких как инструкции INSERT, UPDATE или DELETE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-521">Used for data-modification operations, such as INSERT, UPDATE, or DELETE.</span></span> <span data-ttu-id="a5bd4-522">Гарантирует, что несколько обновлений не будет выполнено одновременно для одного ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-522">Ensures that multiple updates cannot be made to the same resource at the same time.</span></span>|  
|<span data-ttu-id="a5bd4-523">Блокировка с намерением</span><span class="sxs-lookup"><span data-stu-id="a5bd4-523">Intent</span></span>|<span data-ttu-id="a5bd4-524">Используется для создания иерархии блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-524">Used to establish a lock hierarchy.</span></span> <span data-ttu-id="a5bd4-525">Типы блокировки намерений: блокировка с намерением совмещаемого доступа (IS), блокировка с намерением монопольного доступа (IX), а также совмещаемая блокировка с намерением монопольного доступа (SIX).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-525">The types of intent locks are: intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>|  
|<span data-ttu-id="a5bd4-526">схема</span><span class="sxs-lookup"><span data-stu-id="a5bd4-526">Schema</span></span>|<span data-ttu-id="a5bd4-527">Используется во время выполнения операции, зависящей от схемы таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-527">Used when an operation dependent on the schema of a table is executing.</span></span> <span data-ttu-id="a5bd4-528">Типы блокировки схем: блокировка изменения схемы (Sch-S) и блокировка стабильности схемы (Sch-M).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-528">The types of schema locks are: schema modification (Sch-M) and schema stability (Sch-S).</span></span>|  
|<span data-ttu-id="a5bd4-529">Блокировка массового обновления (BU)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-529">Bulk Update (BU)</span></span>|<span data-ttu-id="a5bd4-530">Используется, если выполняется массовое копирование данных в таблицу и задано указание **TABLOCK**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-530">Used when bulk copying data into a table and the **TABLOCK** hint is specified.</span></span>|  
|<span data-ttu-id="a5bd4-531">Диапазон ключей</span><span class="sxs-lookup"><span data-stu-id="a5bd4-531">Key-range</span></span>|<span data-ttu-id="a5bd4-532">Защищает диапазон строк, считываемый запросом при использовании уровня изоляции сериализуемой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-532">Protects the range of rows read by a query when using the serializable transaction isolation level.</span></span> <span data-ttu-id="a5bd4-533">Запрещает другим транзакциям вставлять строки, что помогает запросам сериализуемой транзакции уточнять, были ли запросы запущены повторно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-533">Ensures that other transactions cannot insert rows that would qualify for the queries of the serializable transaction if the queries were run again.</span></span>|  
  
#### <a name="shared-locks"></a><span data-ttu-id="a5bd4-534">Совмещаемые блокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-534">Shared Locks</span></span>  

 <span data-ttu-id="a5bd4-535">Совмещаемые (S) блокировки позволяют одновременным транзакциям считывать (SELECT) ресурс под контролем пессимистичного параллелизма.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-535">Shared (S) locks allow concurrent transactions to read (SELECT) a resource under pessimistic concurrency control.</span></span> <span data-ttu-id="a5bd4-536">Пока для ресурса существуют совмещаемые (S) блокировки, другие транзакции не могут изменять данные.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-536">No other transactions can modify the data while shared (S) locks exist on the resource.</span></span> <span data-ttu-id="a5bd4-537">Совмещаемые блокировки (S) ресурса снимаются по завершении операции считывания, если только уровень изоляции транзакции не установлен на повторяющееся чтение или более высокий уровень, а также если совмещаемые блокировки (S) не продлены на все время транзакции с помощью указания блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-537">Shared (S) locks on a resource are released as soon as the read operation completes, unless the transaction isolation level is set to repeatable read or higher, or a locking hint is used to retain the shared (S) locks for the duration of the transaction.</span></span>  
  
#### <a name="update-locks"></a><span data-ttu-id="a5bd4-538">Блокировки обновления</span><span class="sxs-lookup"><span data-stu-id="a5bd4-538">Update Locks</span></span>  

 <span data-ttu-id="a5bd4-539">Блокировки обновления (U) предотвращают возникновение распространенной формы взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-539">Update (U) locks prevent a common form of deadlock.</span></span> <span data-ttu-id="a5bd4-540">В сериализуемой транзакции или транзакции операцией чтения с возможностью повторения транзакция считывает данные, запрашивает совмещаемую (S) блокировку на ресурс (страницу или строку), затем выполняет изменение данных, что требует преобразование блокировки в монопольную (X).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-540">In a repeatable read or serializable transaction, the transaction reads data, acquiring a shared (S) lock on the resource (page or row), and then modifies the data, which requires lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="a5bd4-541">Если две транзакции запрашивают совмещаемую блокировку на ресурс и затем пытаются одновременно обновить данные, то одна из транзакций пытается преобразовать блокировку в монопольную (X).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-541">If two transactions acquire shared-mode locks on a resource and then attempt to update data concurrently, one transaction attempts the lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="a5bd4-542">Преобразование совмещаемой блокировки в монопольную потребует некоторого времени, поскольку монопольная блокировка для одной транзакции несовместима с совмещаемой блокировкой для другой транзакции. Начнется ожидание блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-542">The shared-mode-to-exclusive lock conversion must wait because the exclusive lock for one transaction is not compatible with the shared-mode lock of the other transaction; a lock wait occurs.</span></span> <span data-ttu-id="a5bd4-543">Вторая транзакция попытается получить монопольную (X) блокировку для обновления.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-543">The second transaction attempts to acquire an exclusive (X) lock for its update.</span></span> <span data-ttu-id="a5bd4-544">Поскольку обе транзакции выполняют преобразование в монопольную (X) блокировку и при этом каждая из транзакций ожидает, пока вторая снимет совмещаемую блокировку, то в результате возникает взаимоблокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-544">Because both transactions are converting to exclusive (X) locks, and they are each waiting for the other transaction to release its shared-mode lock, a deadlock occurs.</span></span>  
  
 <span data-ttu-id="a5bd4-545">Чтобы избежать этой потенциальной взаимоблокировки, применяются блокировки обновления (U).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-545">To avoid this potential deadlock problem, update (U) locks are used.</span></span> <span data-ttu-id="a5bd4-546">Блокировку обновления (U) может устанавливать для ресурса одновременно только одна транзакция.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-546">Only one transaction can obtain an update (U) lock to a resource at a time.</span></span> <span data-ttu-id="a5bd4-547">Если транзакция изменяет ресурс, то блокировка обновления (U) преобразуется в монопольную (X) блокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-547">If a transaction modifies a resource, the update (U) lock is converted to an exclusive (X) lock.</span></span>  
  
#### <a name="exclusive-locks"></a><span data-ttu-id="a5bd4-548">Монопольные блокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-548">Exclusive Locks</span></span>  

 <span data-ttu-id="a5bd4-549">Монопольная (X) блокировка запрещает транзакциям одновременный доступ к ресурсу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-549">Exclusive (X) locks prevent access to a resource by concurrent transactions.</span></span> <span data-ttu-id="a5bd4-550">Если ресурс удерживается монопольной (X) блокировкой, то другие транзакции не могут изменять данные. Операции считывания будут допускаться только при наличии подсказки NOLOCK или уровня изоляции незафиксированной операции чтения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-550">With an exclusive (X) lock, no other transactions can modify data; read operations can take place only with the use of the NOLOCK hint or read uncommitted isolation level.</span></span>  
  
 <span data-ttu-id="a5bd4-551">Изменяющие данные инструкции, такие как INSERT, UPDATE или DELETE, соединяют как операции изменения, так и операции считывания.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-551">Data modification statements, such as INSERT, UPDATE, and DELETE combine both modification and read operations.</span></span> <span data-ttu-id="a5bd4-552">Чтобы выполнить необходимые операции изменения данных, инструкция сначала получает данные с помощью операций считывания.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-552">The statement first performs read operations to acquire data before performing the required modification operations.</span></span> <span data-ttu-id="a5bd4-553">Поэтому, как правило, инструкции изменения данных запрашивают как совмещаемые, так и монопольные блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-553">Data modification statements, therefore, typically request both shared locks and exclusive locks.</span></span> <span data-ttu-id="a5bd4-554">Например инструкция UPDATE может изменять строки в одной таблице, основанной на соединении данных из другой таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-554">For example, an UPDATE statement might modify rows in one table based on a join with another table.</span></span> <span data-ttu-id="a5bd4-555">В этом случае инструкция UPDATE кроме монопольной блокировки обновляемых строк запрашивает также совмещаемые блокировки для строк, считываемых в соединенной таблице.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-555">In this case, the UPDATE statement requests shared locks on the rows read in the join table in addition to requesting exclusive locks on the updated rows.</span></span>  
  
#### <a name="intent-locks"></a><span data-ttu-id="a5bd4-556">Блокировки с намерением</span><span class="sxs-lookup"><span data-stu-id="a5bd4-556">Intent Locks</span></span>  

 <span data-ttu-id="a5bd4-557">В компоненте [!INCLUDE[ssDE](../includes/ssde-md.md)] блокировки с намерением применяются для защиты размещения совмещаемой (S) или монопольной (X) блокировки ресурса на более низком уровне иерархии.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-557">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses intent locks to protect placing a shared (S) lock or exclusive (X) lock on a resource lower in the lock hierarchy.</span></span> <span data-ttu-id="a5bd4-558">Блокировки с намерением называются так потому, что их получают до блокировок более низкого уровня, то есть они обозначают намерение поместить блокировку на более низком уровне.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-558">Intent locks are named intent locks because they are acquired before a lock at the lower level, and therefore signal intent to place locks at a lower level.</span></span>  
  
 <span data-ttu-id="a5bd4-559">Блокировка с намерением выполняет две функции:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-559">Intent locks serve two purposes:</span></span>  
  
-   <span data-ttu-id="a5bd4-560">предотвращает изменение ресурса более высокого уровня другими транзакциям таким образом, что это сделает недействительной блокировку более низкого уровня;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-560">To prevent other transactions from modifying the higher-level resource in a way that would invalidate the lock at the lower level.</span></span>  
  
-   <span data-ttu-id="a5bd4-561">повышает эффективность компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] при распознавании конфликтов блокировок на более высоком уровне гранулярности.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-561">To improve the efficiency of the [!INCLUDE[ssDE](../includes/ssde-md.md)] in detecting lock conflicts at the higher level of granularity.</span></span>  
  
 <span data-ttu-id="a5bd4-562">Например, в таблице требуется блокировка с намерением совмещаемого доступа до того, как для страниц или строк этой таблицы будет запрошена совмещаемая (S) блокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-562">For example, a shared intent lock is requested at the table level before shared (S) locks are requested on pages or rows within that table.</span></span> <span data-ttu-id="a5bd4-563">Если задать блокировку с намерением на уровне таблицы, то другим транзакциям будет запрещено получать монопольную (X) блокировку для таблицы, содержащей эту страницу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-563">Setting an intent lock at the table level prevents another transaction from subsequently acquiring an exclusive (X) lock on the table containing that page.</span></span> <span data-ttu-id="a5bd4-564">Блокировка с намерением повышает производительность, поскольку компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] проверяет наличие таких блокировок только на уровне таблицы, чтобы определить, может ли транзакция безопасно получить для этой таблицы совмещаемую блокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-564">Intent locks improve performance because the [!INCLUDE[ssDE](../includes/ssde-md.md)] examines intent locks only at the table level to determine if a transaction can safely acquire a lock on that table.</span></span> <span data-ttu-id="a5bd4-565">Благодаря этому нет необходимости проверять блокировки в каждой строке и на каждой странице, чтобы убедиться, что транзакция может заблокировать всю таблицу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-565">This removes the requirement to examine every row or page lock on the table to determine if a transaction can lock the entire table.</span></span>  
  
 <span data-ttu-id="a5bd4-566">В состав блокировок с намерением входят блокировка с намерением совмещаемого доступа (IS), блокировка с намерением монопольного доступа (IX), а также совмещаемая блокировка с намерением монопольного доступа (SIX).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-566">Intent locks include intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>  
  
|<span data-ttu-id="a5bd4-567">Режим блокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-567">Lock mode</span></span>|<span data-ttu-id="a5bd4-568">Описание</span><span class="sxs-lookup"><span data-stu-id="a5bd4-568">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="a5bd4-569">Намеренная разделяемая (IS)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-569">Intent shared (IS)</span></span>|<span data-ttu-id="a5bd4-570">Защищает запрошенные или полученные совмещаемые блокировки на некоторых (но не на всех) ресурсах на более низком уровне иерархии.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-570">Protects requested or acquired shared locks on some (but not all) resources lower in the hierarchy.</span></span>|  
|<span data-ttu-id="a5bd4-571">С намерением монопольного доступа (IX)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-571">Intent exclusive (IX)</span></span>|<span data-ttu-id="a5bd4-572">Защищает запрошенные или полученные монопольные блокировки на некоторых (но не на всех) ресурсах на более низком уровне иерархии.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-572">Protects requested or acquired exclusive locks on some (but not all) resources lower in the hierarchy.</span></span> <span data-ttu-id="a5bd4-573">Режим IX является расширенным режимом IS, кроме того, он защищает запрос на совмещаемые блокировки на ресурсах более низкого уровня.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-573">IX is a superset of IS, and it also protects requesting shared locks on lower level resources.</span></span>|  
|<span data-ttu-id="a5bd4-574">Совмещаемая с намерением монопольного доступа (SIX)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-574">Shared with intent exclusive (SIX)</span></span>|<span data-ttu-id="a5bd4-575">Защищает запрошенные или полученные совмещаемые блокировки на всех ресурсах более низкого уровня иерархии, а также блокировки с намерением на некоторых (но не всех) ресурсах более низкого уровня.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-575">Protects requested or acquired shared locks on all resources lower in the hierarchy and intent exclusive locks on some (but not all) of the lower level resources.</span></span> <span data-ttu-id="a5bd4-576">На ресурсах верхнего уровня допускаются одновременные блокировки IS.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-576">Concurrent IS locks at the top-level resource are allowed.</span></span> <span data-ttu-id="a5bd4-577">Например, запрос блокировки SIX для таблицы запрашивает блокировку с намерением монопольного доступа для всех изменяемых страниц и монопольную блокировку изменяемых строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-577">For example, acquiring a SIX lock on a table also acquires intent exclusive locks on the pages being modified and exclusive locks on the modified rows.</span></span> <span data-ttu-id="a5bd4-578">Одновременно для одного ресурса может быть установлена только одна блокировка SIX, что предотвращает обновление ресурса другими транзакциями, хотя эти транзакции могут считывать данные с ресурсов более низкого уровня в иерархии, получая блокировки IS уровня таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-578">There can be only one SIX lock per resource at one time, preventing updates to the resource made by other transactions, although other transactions can read resources lower in the hierarchy by obtaining IS locks at the table level.</span></span>|  
|<span data-ttu-id="a5bd4-579">Блокировка с намерением обновления (IU)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-579">Intent update (IU)</span></span>|<span data-ttu-id="a5bd4-580">Защищает запрошенные или полученные блокировки обновления на всех ресурсах более низкого уровня в иерархии.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-580">Protects requested or acquired update locks on all resources lower in the hierarchy.</span></span> <span data-ttu-id="a5bd4-581">Блокировки IU применяются только на страничных ресурсах.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-581">IU locks are used only on page resources.</span></span> <span data-ttu-id="a5bd4-582">Если выполняется операция обновления, то блокировки IU преобразуются в IX.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-582">IU locks are converted to IX locks if an update operation takes place.</span></span>|  
|<span data-ttu-id="a5bd4-583">Совмещаемая блокировка с намерением обновления (SIU)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-583">Shared intent update (SIU)</span></span>|<span data-ttu-id="a5bd4-584">Сочетание блокировок S и IU в результате раздельного запрашивания этих блокировок и одновременного удержания их обеих.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-584">A combination of S and IU locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span> <span data-ttu-id="a5bd4-585">Например, транзакция выполняет запрос с указанием PAGLOCK, затем выполняет операцию обновления.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-585">For example, a transaction executes a query with the PAGLOCK hint and then executes an update operation.</span></span> <span data-ttu-id="a5bd4-586">Запрос с указанием PAGLOCK получает блокировку S, а операция обновления получает блокировку IU.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-586">The query with the PAGLOCK hint acquires the S lock, and the update operation acquires the IU lock.</span></span>|  
|<span data-ttu-id="a5bd4-587">Блокировка обновления с намерением монопольного доступа (UIX)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-587">Update intent exclusive (UIX)</span></span>|<span data-ttu-id="a5bd4-588">Сочетание блокировок U и IX в результате раздельного запрашивания этих блокировок и одновременного удержания их обеих.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-588">A combination of U and IX locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span>|  
  
#### <a name="schema-locks"></a><span data-ttu-id="a5bd4-589">Блокировки схем</span><span class="sxs-lookup"><span data-stu-id="a5bd4-589">Schema Locks</span></span>  

 <span data-ttu-id="a5bd4-590">В компоненте [!INCLUDE[ssDE](../includes/ssde-md.md)] блокировка изменения схемы (Sch-M) применяется с операциями языка DDL для таблиц, например при добавлении столбца или очистке таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-590">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema modification (Sch-M) locks during a table data definition language (DDL) operation, such as adding a column or dropping a table.</span></span> <span data-ttu-id="a5bd4-591">Пока удерживается блокировка изменения схемы (Sch-M), одновременный доступ к таблице запрещен.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-591">During the time that it is held, the Sch-M lock prevents concurrent access to the table.</span></span> <span data-ttu-id="a5bd4-592">Это означает, что любые операции вне блокировки изменения схемы (Sch-M) будут запрещены до снятия блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-592">This means the Sch-M lock blocks all outside operations until the lock is released.</span></span>  
  
 <span data-ttu-id="a5bd4-593">Блокировка изменения схемы (Sch-M) применяется с некоторыми операциями языка обработки данных, например усечением таблиц, чтобы предотвратить одновременный доступ к таблице.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-593">Some data manipulation language (DML) operations, such as table truncation, use Sch-M locks to prevent access to affected tables by concurrent operations.</span></span>  
  
 <span data-ttu-id="a5bd4-594">Блокировка стабильности схемы (Sch-S) применяется компонентом [!INCLUDE[ssDE](../includes/ssde-md.md)] при компиляции и выполнении запросов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-594">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema stability (Sch-S) locks when compiling and executing queries.</span></span> <span data-ttu-id="a5bd4-595">Блокировка стабильности схемы (Sch-S) не влияет на блокировки транзакций, включая монопольные (X) блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-595">Sch-S locks do not block any transactional locks, including exclusive (X) locks.</span></span> <span data-ttu-id="a5bd4-596">Поэтому другие транзакции (даже транзакции с монопольной блокировкой (X) для таблицы) могут продолжать работу во время компиляции запроса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-596">Therefore, other transactions, including those with X locks on a table, continue to run while a query is being compiled.</span></span> <span data-ttu-id="a5bd4-597">Однако одновременные операции DDL и DML, которые запрашивают блокировки изменения схемы (Sch-M), не могут выполняться над таблицей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-597">However, concurrent DDL operations, and concurrent DML operations that acquire Sch-M locks, cannot be performed on the table.</span></span>  
  
#### <a name="bulk-update-locks"></a><span data-ttu-id="a5bd4-598">Блокировки массового обновления</span><span class="sxs-lookup"><span data-stu-id="a5bd4-598">Bulk Update Locks</span></span>  

 <span data-ttu-id="a5bd4-599">Блокировка массового обновления (BU) позволяет поддерживать несколько одновременных потоков массовой загрузки данных в одну и ту же таблицу и при этом запрещать доступ к таблице любым другим процессам, отличным от массовой загрузки данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-599">Bulk update (BU) locks allow multiple threads to bulk load data concurrently into the same table while preventing other processes that are not bulk loading data from accessing the table.</span></span> <span data-ttu-id="a5bd4-600">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] использует блокировки массового обновления (BU), если выполняются два следующих условия.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-600">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses bulk update (BU) locks when both of the following conditions are true.</span></span>  
  
-   <span data-ttu-id="a5bd4-601">Используется инструкция Transact-SQL BULK INSERT, функция OPENROWSET(BULK) или одна из таких команд массовой вставки API, как .NET SqlBulkCopy, OLEDB Fast Load APIs или ODBC Bulk Copy APIs, для массового копирования данных в таблицу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-601">You use the Transact-SQL BULK INSERT statement, or the OPENROWSET(BULK) function, or you use one of the Bulk Insert API commands such as .NET SqlBulkCopy, OLEDB Fast Load APIs, or the ODBC Bulk Copy APIs to bulk copy data into a table.</span></span>  
  
-   <span data-ttu-id="a5bd4-602">Выделено указание **TABLOCK** или установлен параметр таблицы **table lock on bulk load** с помощью хранимой процедуры **sp_tableoption**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-602">The **TABLOCK** hint is specified or the **table lock on bulk load** table option is set using **sp_tableoption**.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="a5bd4-603">В отличие от инструкции BULK INSERT, которая удерживает менее строгую блокировку массового обновления, инструкция INSERT INTO…SELECT с указанием TABLOCK удерживает монопольную блокировку (X) таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-603">Unlike the BULK INSERT statement, which holds a less restrictive Bulk Update lock, INSERT INTO...SELECT with the TABLOCK hint holds an exclusive (X) lock on the table.</span></span> <span data-ttu-id="a5bd4-604">Это означает, что отсутствует возможность вставки строк с помощью параллельных операций вставки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-604">This means that you cannot insert rows using parallel insert operations.</span></span>  
  
#### <a name="key-range-locks"></a><span data-ttu-id="a5bd4-605">Блокировки диапазона ключа</span><span class="sxs-lookup"><span data-stu-id="a5bd4-605">Key-Range Locks</span></span>  

 <span data-ttu-id="a5bd4-606">Блокировки диапазона ключей защищают диапазон строк, неявно включенный в набор записей, считываемый инструкцией [!INCLUDE[tsql](../includes/tsql-md.md)] при использовании уровня изоляции сериализуемых транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-606">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="a5bd4-607">Блокировка диапазона ключей предотвращает фантомные считывания.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-607">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="a5bd4-608">Кроме того, защита диапазона ключей между строк предотвращает фантомную вставку или удаление из набора записи, к которому получает доступ транзакция.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-608">By protecting the ranges of keys between rows, it also prevents phantom insertions or deletions into a record set accessed by a transaction.</span></span>  
  
### <a name="lock-compatibility"></a><span data-ttu-id="a5bd4-609">Совместимость блокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-609">Lock Compatibility</span></span>  

 <span data-ttu-id="a5bd4-610">Совместимость блокировок определяет, могут ли несколько транзакций одновременно получить блокировку одного и того же ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-610">Lock compatibility controls whether multiple transactions can acquire locks on the same resource at the same time.</span></span> <span data-ttu-id="a5bd4-611">Если ресурс уже блокирован другой транзакцией, новая блокировка может быть предоставлена только в том случае, если режим запрошенной блокировки совместим с режимом существующей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-611">If a resource is already locked by another transaction, a new lock request can be granted only if the mode of the requested lock is compatible with the mode of the existing lock.</span></span> <span data-ttu-id="a5bd4-612">В противном случае транзакция, запросившая новую блокировку, ожидает освобождения ресурса, пока не истечет время ожидания существующей блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-612">If the mode of the requested lock is not compatible with the existing lock, the transaction requesting the new lock waits for the existing lock to be released or for the lock timeout interval to expire.</span></span> <span data-ttu-id="a5bd4-613">Например с монопольными блокировками не совместим ни один из режимов блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-613">For example, no lock modes are compatible with exclusive locks.</span></span> <span data-ttu-id="a5bd4-614">Пока удерживается монопольная (X) блокировка, больше ни одна из транзакций не может получить блокировку ни одного из типов (разделяемую, обновления или монопольную) на этот ресурс, пока не будет освобождена монопольная (X) блокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-614">While an exclusive (X) lock is held, no other transaction can acquire a lock of any kind (shared, update, or exclusive) on that resource until the exclusive (X) lock is released.</span></span> <span data-ttu-id="a5bd4-615">И наоборот, если к ресурсу применяется разделяемая (S) блокировка, другие транзакции могут получать разделяемую блокировку или блокировку обновления (U) на этот элемент, даже если не завершилась первая транзакция.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-615">Alternatively, if a shared (S) lock has been applied to a resource, other transactions can also acquire a shared lock or an update (U) lock on that item even if the first transaction has not completed.</span></span> <span data-ttu-id="a5bd4-616">Тем не менее другие транзакции не могут получить монопольную блокировку до освобождения разделяемой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-616">However, other transactions cannot acquire an exclusive lock until the shared lock has been released.</span></span>  
  
 <span data-ttu-id="a5bd4-617">Следующая таблица показывает совместимости для большинства из распространенных режимов блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-617">The following table shows the compatibility of the most commonly encountered lock modes.</span></span>  
  
||<span data-ttu-id="a5bd4-618">Полученный ранее режим</span><span class="sxs-lookup"><span data-stu-id="a5bd4-618">Existing granted mode</span></span>||||||  
|------|---------------------------|------|------|------|------|------|  
|<span data-ttu-id="a5bd4-619">**Запрашиваемый режим**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-619">**Requested mode**</span></span>|<span data-ttu-id="a5bd4-620">**IS**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-620">**IS**</span></span>|<span data-ttu-id="a5bd4-621">**S**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-621">**S**</span></span>|<span data-ttu-id="a5bd4-622">**U**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-622">**U**</span></span>|<span data-ttu-id="a5bd4-623">**IX**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-623">**IX**</span></span>|<span data-ttu-id="a5bd4-624">**SIX**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-624">**SIX**</span></span>|<span data-ttu-id="a5bd4-625">**X**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-625">**X**</span></span>|  
|<span data-ttu-id="a5bd4-626">**Блокировка с намерением совмещаемого доступа (IS)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-626">**Intent shared (IS)**</span></span>|<span data-ttu-id="a5bd4-627">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-627">Yes</span></span>|<span data-ttu-id="a5bd4-628">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-628">Yes</span></span>|<span data-ttu-id="a5bd4-629">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-629">Yes</span></span>|<span data-ttu-id="a5bd4-630">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-630">Yes</span></span>|<span data-ttu-id="a5bd4-631">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-631">Yes</span></span>|<span data-ttu-id="a5bd4-632">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-632">No</span></span>|  
|<span data-ttu-id="a5bd4-633">**Общий доступ (S)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-633">**Shared (S)**</span></span>|<span data-ttu-id="a5bd4-634">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-634">Yes</span></span>|<span data-ttu-id="a5bd4-635">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-635">Yes</span></span>|<span data-ttu-id="a5bd4-636">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-636">Yes</span></span>|<span data-ttu-id="a5bd4-637">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-637">No</span></span>|<span data-ttu-id="a5bd4-638">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-638">No</span></span>|<span data-ttu-id="a5bd4-639">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-639">No</span></span>|  
|<span data-ttu-id="a5bd4-640">**Обновление (U)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-640">**Update (U)**</span></span>|<span data-ttu-id="a5bd4-641">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-641">Yes</span></span>|<span data-ttu-id="a5bd4-642">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-642">Yes</span></span>|<span data-ttu-id="a5bd4-643">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-643">No</span></span>|<span data-ttu-id="a5bd4-644">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-644">No</span></span>|<span data-ttu-id="a5bd4-645">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-645">No</span></span>|<span data-ttu-id="a5bd4-646">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-646">No</span></span>|  
|<span data-ttu-id="a5bd4-647">**Монопольная блокировка намерения (IX)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-647">**Intent exclusive (IX)**</span></span>|<span data-ttu-id="a5bd4-648">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-648">Yes</span></span>|<span data-ttu-id="a5bd4-649">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-649">No</span></span>|<span data-ttu-id="a5bd4-650">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-650">No</span></span>|<span data-ttu-id="a5bd4-651">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-651">Yes</span></span>|<span data-ttu-id="a5bd4-652">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-652">No</span></span>|<span data-ttu-id="a5bd4-653">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-653">No</span></span>|  
|<span data-ttu-id="a5bd4-654">**Общий доступ с монопольной блокировкой намерения (SIX)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-654">**Shared with intent exclusive (SIX)**</span></span>|<span data-ttu-id="a5bd4-655">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-655">Yes</span></span>|<span data-ttu-id="a5bd4-656">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-656">No</span></span>|<span data-ttu-id="a5bd4-657">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-657">No</span></span>|<span data-ttu-id="a5bd4-658">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-658">No</span></span>|<span data-ttu-id="a5bd4-659">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-659">No</span></span>|<span data-ttu-id="a5bd4-660">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-660">No</span></span>|  
|<span data-ttu-id="a5bd4-661">**Монопольная (Х)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-661">**Exclusive (X)**</span></span>|<span data-ttu-id="a5bd4-662">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-662">No</span></span>|<span data-ttu-id="a5bd4-663">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-663">No</span></span>|<span data-ttu-id="a5bd4-664">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-664">No</span></span>|<span data-ttu-id="a5bd4-665">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-665">No</span></span>|<span data-ttu-id="a5bd4-666">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-666">No</span></span>|<span data-ttu-id="a5bd4-667">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-667">No</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-668">Намеренная монопольная блокировка (IX) совместима с блокировкой IX, поскольку IX означает намерение обновить не все строки, а только некоторые из них.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-668">An intent exclusive (IX) lock is compatible with an IX lock mode because IX means the intention is to update only some of the rows rather than all of them.</span></span> <span data-ttu-id="a5bd4-669">Другим транзакциям разрешено чтение и обновление некоторых строк, если только это не строки, которые обновляются другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-669">Other transactions that attempt to read or update some of the rows are also permitted as long as they are not the same rows being updated by other transactions.</span></span> <span data-ttu-id="a5bd4-670">Кроме того, если две транзакции попытаются обновить одну строку, то обеим будет предоставлена блокировка IX на уровне таблицы и страницы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-670">Further, if two transactions attempt to update the same row, both transactions will be granted an IX lock at table and page level.</span></span> <span data-ttu-id="a5bd4-671">Но одной транзакции будет предоставлена блокировка X на уровне строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-671">However, one transaction will be granted an X lock at row level.</span></span> <span data-ttu-id="a5bd4-672">Другая транзакция должна ожидать, пока блокировка на уровне строк не будет снята.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-672">The other transaction must wait until the row-level lock is removed.</span></span>  
  
 <span data-ttu-id="a5bd4-673">Для определения совместимости всех режимов блокировок, доступных в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], используется следующая таблица.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-673">Use the following table to determine the compatibility of all the lock modes available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="a5bd4-674">![Диаграмма матрицы совместимости блокировок](media/lockconflicttable.gif "Диаграмма матрицы совместимости блокировок")</span><span class="sxs-lookup"><span data-stu-id="a5bd4-674">![Diagram showing lock compatibility matrix](media/lockconflicttable.gif "Diagram showing lock compatibility matrix")</span></span>  
  
### <a name="key-range-locking"></a><span data-ttu-id="a5bd4-675">Блокировка диапазона ключей</span><span class="sxs-lookup"><span data-stu-id="a5bd4-675">Key-Range Locking</span></span>  

 <span data-ttu-id="a5bd4-676">Блокировки диапазона ключей защищают диапазон строк, неявно включенный в набор записей, считываемый инструкцией [!INCLUDE[tsql](../includes/tsql-md.md)] при использовании уровня изоляции сериализуемых транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-676">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="a5bd4-677">При использовании упорядочиваемого уровня изоляции необходимо, чтобы любой запрос, выполняемый в транзакции, получал одинаковый набор строк при каждом выполнении в рамках этой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-677">The serializable isolation level requires that any query executed during a transaction must obtain the same set of rows every time it is executed during the transaction.</span></span> <span data-ttu-id="a5bd4-678">Блокировка диапазона ключей обеспечивает выполнение этого требования, запрещая другим транзакциям вставку таких новых строк, ключи которых попадали бы в диапазон ключей, считываемых сериализуемой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-678">A key range lock protects this requirement by preventing other transactions from inserting new rows whose keys would fall in the range of keys read by the serializable transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-679">Блокировка диапазона ключей предотвращает фантомные считывания.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-679">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="a5bd4-680">Защищая диапазоны ключей между строками, она также предотвращает фантомные вставки в набор записей, к которым транзакция имеет доступ.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-680">By protecting the ranges of keys between rows, it also prevents phantom insertions into a set of records accessed by a transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-681">Блокировка диапазона ключей применятся к индексу, указывая начальное и конечное значения ключа.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-681">A key-range lock is placed on an index, specifying a beginning and ending key value.</span></span> <span data-ttu-id="a5bd4-682">Данная блокировка предотвращает все попытки вставки, обновления или удаления строк со значением ключа, находящимся в этом диапазоне, поскольку для выполнения этих операций потребуется получение блокировки индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-682">This lock blocks any attempt to insert, update, or delete any row with a key value that falls in the range because those operations would first have to acquire a lock on the index.</span></span> <span data-ttu-id="a5bd4-683">Например, сериализуемая транзакция выполняет инструкцию SELECT, считывающую все строки, ключевые значения которых лежат между **'** AAA **'** и **'** CZZ **'**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-683">For example, a serializable transaction could issue a SELECT statement that reads all rows whose key values are between **'** AAA **'** and **'** CZZ **'**.</span></span> <span data-ttu-id="a5bd4-684">Блокировка диапазона ключей для значений ключа между **'** AAA **'** и **'** CZZ **'** запрещает другим транзакциям вставлять строки со значениями ключа, входящими в этот диапазон, например, запрещаются значения ключа **'** ADG **'** , **'** BBD **'** или **'** CAL **'** .</span><span class="sxs-lookup"><span data-stu-id="a5bd4-684">A key-range lock on the key values in the range from **'** AAA **'** to **'** CZZ **'** prevents other transactions from inserting rows with key values anywhere in that range, such as **'** ADG **'**, **'** BBD **'**, or **'** CAL **'**.</span></span>  
  
#### <a name="key-range-lock-modes"></a><span data-ttu-id="a5bd4-685">Режимы блокировки диапазона ключей</span><span class="sxs-lookup"><span data-stu-id="a5bd4-685">Key-Range Lock Modes</span></span>  

 <span data-ttu-id="a5bd4-686">Блокировки диапазона ключей содержат и компонент диапазона, и компонент строки, которые задаются в формате диапазона строк:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-686">Key-range locks include both a range and a row component specified in range-row format:</span></span>  
  
-   <span data-ttu-id="a5bd4-687">Компонент диапазона соответствует режиму блокировки, защищающему диапазон между любыми двумя последовательными элементами индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-687">Range represents the lock mode protecting the range between two consecutive index entries.</span></span>  
  
-   <span data-ttu-id="a5bd4-688">Компонент строки соответствует режиму блокировки, защищающему сами элементы индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-688">Row represents the lock mode protecting the index entry.</span></span>  
  
-   <span data-ttu-id="a5bd4-689">Режим соответствует применяемому соединенному режиму блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-689">Mode represents the combined lock mode used.</span></span> <span data-ttu-id="a5bd4-690">Режимы блокировки диапазона ключей состоят из двух частей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-690">Key-range lock modes consist of two parts.</span></span> <span data-ttu-id="a5bd4-691">Первая представляет собой тип блокировки, используемой для блокировки диапазона индекса (Range*T*), а вторая представляет тип блокировки, используемой для блокировки конкретных ключей(*K*).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-691">The first represents the type of lock used to lock the index range (Range*T*) and the second represents the lock type used to lock a specific key (*K*).</span></span> <span data-ttu-id="a5bd4-692">Эти две части соединены дефисом (-), например Range*T*-*K*.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-692">The two parts are connected with a hyphen (-), such as Range*T*-*K*.</span></span>  
  
    |<span data-ttu-id="a5bd4-693">Диапазон</span><span class="sxs-lookup"><span data-stu-id="a5bd4-693">Range</span></span>|<span data-ttu-id="a5bd4-694">Строка</span><span class="sxs-lookup"><span data-stu-id="a5bd4-694">Row</span></span>|<span data-ttu-id="a5bd4-695">Режим</span><span class="sxs-lookup"><span data-stu-id="a5bd4-695">Mode</span></span>|<span data-ttu-id="a5bd4-696">Описание</span><span class="sxs-lookup"><span data-stu-id="a5bd4-696">Description</span></span>|  
    |-----------|---------|----------|-----------------|  
    |<span data-ttu-id="a5bd4-697">RangeS</span><span class="sxs-lookup"><span data-stu-id="a5bd4-697">RangeS</span></span>|<span data-ttu-id="a5bd4-698">S</span><span class="sxs-lookup"><span data-stu-id="a5bd4-698">S</span></span>|<span data-ttu-id="a5bd4-699">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="a5bd4-699">RangeS-S</span></span>|<span data-ttu-id="a5bd4-700">Блокировка общего диапазона и общего ресурса; упорядочиваемый просмотр диапазона.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-700">Shared range, shared resource lock; serializable range scan.</span></span>|  
    |<span data-ttu-id="a5bd4-701">RangeS</span><span class="sxs-lookup"><span data-stu-id="a5bd4-701">RangeS</span></span>|<span data-ttu-id="a5bd4-702">U</span><span class="sxs-lookup"><span data-stu-id="a5bd4-702">U</span></span>|<span data-ttu-id="a5bd4-703">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="a5bd4-703">RangeS-U</span></span>|<span data-ttu-id="a5bd4-704">Совмещаемая блокировка диапазона — блокировка обновления ресурса; упорядочиваемый просмотр обновлений.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-704">Shared range, update resource lock; serializable update scan.</span></span>|  
    |<span data-ttu-id="a5bd4-705">RangeI</span><span class="sxs-lookup"><span data-stu-id="a5bd4-705">RangeI</span></span>|<span data-ttu-id="a5bd4-706">NULL</span><span class="sxs-lookup"><span data-stu-id="a5bd4-706">Null</span></span>|<span data-ttu-id="a5bd4-707">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="a5bd4-707">RangeI-N</span></span>|<span data-ttu-id="a5bd4-708">Блокировка диапазона для вставки, блокировка ресурса не определена; используется для проверки диапазонов перед вставкой новых ключей в индекс.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-708">Insert range, null resource lock; used to test ranges before inserting a new key into an index.</span></span>|  
    |<span data-ttu-id="a5bd4-709">RangeX</span><span class="sxs-lookup"><span data-stu-id="a5bd4-709">RangeX</span></span>|<span data-ttu-id="a5bd4-710">X</span><span class="sxs-lookup"><span data-stu-id="a5bd4-710">X</span></span>|<span data-ttu-id="a5bd4-711">RangeX-X</span><span class="sxs-lookup"><span data-stu-id="a5bd4-711">RangeX-X</span></span>|<span data-ttu-id="a5bd4-712">Монопольная блокировка диапазона, монопольная блокировка ресурса; используется при обновлении ключа в диапазоне.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-712">Exclusive range, exclusive resource lock; used when updating a key in a range.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-713">Внутренней нулевой режим блокировки совместим со всеми другими режимами блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-713">The internal Null lock mode is compatible with all other lock modes.</span></span>  
  
 <span data-ttu-id="a5bd4-714">Для режимов блокировки диапазона ключей существует матрица совместимости, показывающая, какие виды блокировок совместимы с другими блокировками, полученными для пересекающихся диапазонов и ключей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-714">Key-range lock modes have a compatibility matrix that shows which locks are compatible with other locks obtained on overlapping keys and ranges.</span></span>  
  
||<span data-ttu-id="a5bd4-715">Полученный ранее режим</span><span class="sxs-lookup"><span data-stu-id="a5bd4-715">Existing granted mode</span></span>|||||||  
|------|---------------------------|------|------|------|------|------|------|  
|<span data-ttu-id="a5bd4-716">**Запрашиваемый режим**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-716">**Requested mode**</span></span>|<span data-ttu-id="a5bd4-717">**S**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-717">**S**</span></span>|<span data-ttu-id="a5bd4-718">**U**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-718">**U**</span></span>|<span data-ttu-id="a5bd4-719">**X**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-719">**X**</span></span>|<span data-ttu-id="a5bd4-720">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-720">**RangeS-S**</span></span>|<span data-ttu-id="a5bd4-721">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-721">**RangeS-U**</span></span>|<span data-ttu-id="a5bd4-722">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-722">**RangeI-N**</span></span>|<span data-ttu-id="a5bd4-723">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-723">**RangeX-X**</span></span>|  
|<span data-ttu-id="a5bd4-724">**Общий доступ (S)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-724">**Shared (S)**</span></span>|<span data-ttu-id="a5bd4-725">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-725">Yes</span></span>|<span data-ttu-id="a5bd4-726">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-726">Yes</span></span>|<span data-ttu-id="a5bd4-727">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-727">No</span></span>|<span data-ttu-id="a5bd4-728">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-728">Yes</span></span>|<span data-ttu-id="a5bd4-729">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-729">Yes</span></span>|<span data-ttu-id="a5bd4-730">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-730">Yes</span></span>|<span data-ttu-id="a5bd4-731">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-731">No</span></span>|  
|<span data-ttu-id="a5bd4-732">**Обновление (U)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-732">**Update (U)**</span></span>|<span data-ttu-id="a5bd4-733">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-733">Yes</span></span>|<span data-ttu-id="a5bd4-734">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-734">No</span></span>|<span data-ttu-id="a5bd4-735">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-735">No</span></span>|<span data-ttu-id="a5bd4-736">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-736">Yes</span></span>|<span data-ttu-id="a5bd4-737">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-737">No</span></span>|<span data-ttu-id="a5bd4-738">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-738">Yes</span></span>|<span data-ttu-id="a5bd4-739">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-739">No</span></span>|  
|<span data-ttu-id="a5bd4-740">**Монопольная (Х)**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-740">**Exclusive (X)**</span></span>|<span data-ttu-id="a5bd4-741">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-741">No</span></span>|<span data-ttu-id="a5bd4-742">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-742">No</span></span>|<span data-ttu-id="a5bd4-743">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-743">No</span></span>|<span data-ttu-id="a5bd4-744">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-744">No</span></span>|<span data-ttu-id="a5bd4-745">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-745">No</span></span>|<span data-ttu-id="a5bd4-746">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-746">Yes</span></span>|<span data-ttu-id="a5bd4-747">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-747">No</span></span>|  
|<span data-ttu-id="a5bd4-748">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-748">**RangeS-S**</span></span>|<span data-ttu-id="a5bd4-749">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-749">Yes</span></span>|<span data-ttu-id="a5bd4-750">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-750">Yes</span></span>|<span data-ttu-id="a5bd4-751">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-751">No</span></span>|<span data-ttu-id="a5bd4-752">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-752">Yes</span></span>|<span data-ttu-id="a5bd4-753">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-753">Yes</span></span>|<span data-ttu-id="a5bd4-754">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-754">No</span></span>|<span data-ttu-id="a5bd4-755">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-755">No</span></span>|  
|<span data-ttu-id="a5bd4-756">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-756">**RangeS-U**</span></span>|<span data-ttu-id="a5bd4-757">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-757">Yes</span></span>|<span data-ttu-id="a5bd4-758">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-758">No</span></span>|<span data-ttu-id="a5bd4-759">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-759">No</span></span>|<span data-ttu-id="a5bd4-760">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-760">Yes</span></span>|<span data-ttu-id="a5bd4-761">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-761">No</span></span>|<span data-ttu-id="a5bd4-762">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-762">No</span></span>|<span data-ttu-id="a5bd4-763">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-763">No</span></span>|  
|<span data-ttu-id="a5bd4-764">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-764">**RangeI-N**</span></span>|<span data-ttu-id="a5bd4-765">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-765">Yes</span></span>|<span data-ttu-id="a5bd4-766">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-766">Yes</span></span>|<span data-ttu-id="a5bd4-767">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-767">Yes</span></span>|<span data-ttu-id="a5bd4-768">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-768">No</span></span>|<span data-ttu-id="a5bd4-769">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-769">No</span></span>|<span data-ttu-id="a5bd4-770">Да</span><span class="sxs-lookup"><span data-stu-id="a5bd4-770">Yes</span></span>|<span data-ttu-id="a5bd4-771">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-771">No</span></span>|  
|<span data-ttu-id="a5bd4-772">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-772">**RangeX-X**</span></span>|<span data-ttu-id="a5bd4-773">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-773">No</span></span>|<span data-ttu-id="a5bd4-774">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-774">No</span></span>|<span data-ttu-id="a5bd4-775">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-775">No</span></span>|<span data-ttu-id="a5bd4-776">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-776">No</span></span>|<span data-ttu-id="a5bd4-777">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-777">No</span></span>|<span data-ttu-id="a5bd4-778">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-778">No</span></span>|<span data-ttu-id="a5bd4-779">Нет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-779">No</span></span>|  
  
#### <a name="conversion-locks"></a><span data-ttu-id="a5bd4-780">Блокировки преобразования</span><span class="sxs-lookup"><span data-stu-id="a5bd4-780">Conversion Locks</span></span>  

 <span data-ttu-id="a5bd4-781">При пересечении двух блокировок диапазона ключей создаются блокировки преобразования.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-781">Conversion locks are created when a key-range lock overlaps another lock.</span></span>  
  
|<span data-ttu-id="a5bd4-782">Блокировка 1</span><span class="sxs-lookup"><span data-stu-id="a5bd4-782">Lock 1</span></span>|<span data-ttu-id="a5bd4-783">Блокировка 2</span><span class="sxs-lookup"><span data-stu-id="a5bd4-783">Lock 2</span></span>|<span data-ttu-id="a5bd4-784">Блокировка преобразования</span><span class="sxs-lookup"><span data-stu-id="a5bd4-784">Conversion lock</span></span>|  
|------------|------------|---------------------|  
|<span data-ttu-id="a5bd4-785">S</span><span class="sxs-lookup"><span data-stu-id="a5bd4-785">S</span></span>|<span data-ttu-id="a5bd4-786">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="a5bd4-786">RangeI-N</span></span>|<span data-ttu-id="a5bd4-787">RangeI-S</span><span class="sxs-lookup"><span data-stu-id="a5bd4-787">RangeI-S</span></span>|  
|<span data-ttu-id="a5bd4-788">U</span><span class="sxs-lookup"><span data-stu-id="a5bd4-788">U</span></span>|<span data-ttu-id="a5bd4-789">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="a5bd4-789">RangeI-N</span></span>|<span data-ttu-id="a5bd4-790">RangeI-U</span><span class="sxs-lookup"><span data-stu-id="a5bd4-790">RangeI-U</span></span>|  
|<span data-ttu-id="a5bd4-791">X</span><span class="sxs-lookup"><span data-stu-id="a5bd4-791">X</span></span>|<span data-ttu-id="a5bd4-792">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="a5bd4-792">RangeI-N</span></span>|<span data-ttu-id="a5bd4-793">RangeI-X</span><span class="sxs-lookup"><span data-stu-id="a5bd4-793">RangeI-X</span></span>|  
|<span data-ttu-id="a5bd4-794">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="a5bd4-794">RangeI-N</span></span>|<span data-ttu-id="a5bd4-795">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="a5bd4-795">RangeS-S</span></span>|<span data-ttu-id="a5bd4-796">RangeX-S</span><span class="sxs-lookup"><span data-stu-id="a5bd4-796">RangeX-S</span></span>|  
|<span data-ttu-id="a5bd4-797">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="a5bd4-797">RangeI-N</span></span>|<span data-ttu-id="a5bd4-798">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="a5bd4-798">RangeS-U</span></span>|<span data-ttu-id="a5bd4-799">RangeX-U</span><span class="sxs-lookup"><span data-stu-id="a5bd4-799">RangeX-U</span></span>|  
  
 <span data-ttu-id="a5bd4-800">Блокировки преобразования могут появляться на короткие промежутки времени при различных сложных обстоятельствах, иногда, например при выполнении параллельных процессов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-800">Conversion locks can be observed for a short period of time under different complex circumstances, sometimes while running concurrent processes.</span></span>  
  
#### <a name="serializable-range-scan-singleton-fetch-delete-and-insert"></a><span data-ttu-id="a5bd4-801">Упорядочиваемое сканирование диапазона, одноэлементная выборка, удаление и вставка</span><span class="sxs-lookup"><span data-stu-id="a5bd4-801">Serializable Range Scan, Singleton Fetch, Delete, and Insert</span></span>  

 <span data-ttu-id="a5bd4-802">Блокировка диапазона ключей гарантирует, что следующие операции являются упорядочиваемыми:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-802">Key-range locking ensures that the following operations are serializable:</span></span>  
  
-   <span data-ttu-id="a5bd4-803">Запрос просмотра диапазона</span><span class="sxs-lookup"><span data-stu-id="a5bd4-803">Range scan query</span></span>  
  
-   <span data-ttu-id="a5bd4-804">Одноэлементная выборка несуществующей строки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-804">Singleton fetch of nonexistent row</span></span>  
  
-   <span data-ttu-id="a5bd4-805">Операция удаления</span><span class="sxs-lookup"><span data-stu-id="a5bd4-805">Delete operation</span></span>  
  
-   <span data-ttu-id="a5bd4-806">Операция вставки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-806">Insert operation</span></span>  
  
 <span data-ttu-id="a5bd4-807">Для получения блокировки диапазона ключей должны выполняться следующие условия:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-807">Before key-range locking can occur, the following conditions must be satisfied:</span></span>  
  
-   <span data-ttu-id="a5bd4-808">Должен быть установлен уровень изоляции транзакций SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-808">The transaction-isolation level must be set to SERIALIZABLE.</span></span>  
  
-   <span data-ttu-id="a5bd4-809">Обработчик запросов должен использовать индекс при применении предиката фильтрации по диапазону.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-809">The query processor must use an index to implement the range filter predicate.</span></span> <span data-ttu-id="a5bd4-810">Например, предложение WHERE инструкции SELECT может установить условие по диапазону с помощью следующего предиката: ColumnX BETWEEN N **'** AAA **'** AND N **'** CZZ **'** .</span><span class="sxs-lookup"><span data-stu-id="a5bd4-810">For example, the WHERE clause in a SELECT statement could establish a range condition with this predicate: ColumnX BETWEEN N **'** AAA **'** AND N **'** CZZ **'**.</span></span> <span data-ttu-id="a5bd4-811">Блокировка диапазона ключей может быть получена лишь в случае, если **ColumnX** входит в ключ индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-811">A key-range lock can only be acquired if **ColumnX** is covered by an index key.</span></span>  
  
#### <a name="examples"></a><span data-ttu-id="a5bd4-812">Примеры</span><span class="sxs-lookup"><span data-stu-id="a5bd4-812">Examples</span></span>  

 <span data-ttu-id="a5bd4-813">Следующая таблица и индекс используются в приведенных ниже примерах блокировки диапазона ключей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-813">The following table and index are used as a basis for the key-range locking examples that follow.</span></span>  
  
 <span data-ttu-id="a5bd4-814">![Таблица базы данных с иллюстрацией сбалансированного дерева индекса](media/btree4.gif "Таблица базы данных с иллюстрацией сбалансированного дерева индекса")</span><span class="sxs-lookup"><span data-stu-id="a5bd4-814">![Database table with index b-tree illustration](media/btree4.gif "Database table with index b-tree illustration")</span></span>  
  
##### <a name="range-scan-query"></a><span data-ttu-id="a5bd4-815">Запрос просмотра диапазона</span><span class="sxs-lookup"><span data-stu-id="a5bd4-815">Range Scan Query</span></span>  

 <span data-ttu-id="a5bd4-816">Если запрос просмотра диапазона является упорядочиваемым, то один и тот же запрос должен возвращать одинаковые результаты при каждом выполнении в одной транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-816">To ensure a range scan query is serializable, the same query should return the same results each time it is executed within the same transaction.</span></span> <span data-ttu-id="a5bd4-817">В запросе просмотра диапазона новые строки не должны вставляться другими транзакциями, иначе они окажутся фантомными вставками.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-817">New rows must not be inserted within the range scan query by other transactions; otherwise, these become phantom inserts.</span></span> <span data-ttu-id="a5bd4-818">Например, в следующем запросе используются таблица и индекс из предыдущего рисунка:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-818">For example, the following query uses the table and index in the previous illustration:</span></span>  
  
```sql  
SELECT name  
    FROM mytable  
    WHERE name BETWEEN 'A' AND 'C';  
```  
  
 <span data-ttu-id="a5bd4-819">Блокировка диапазона ключей устанавливается на элементы индекса, соответствующие диапазону строк данных, имена которых находятся между значениями Adam и Dale, что приводит в результате к запрету добавления или удаления новых строк, выбранных в предыдущем запросе.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-819">Key-range locks are placed on the index entries corresponding to the range of data rows where the name is between the values Adam and Dale, preventing new rows qualifying in the previous query from being added or deleted.</span></span> <span data-ttu-id="a5bd4-820">Хотя первым именем диапазона является Adam, блокировка диапазона ключей в режиме RangeS-S по этому элементу индекса гарантирует, что не будут добавляться новые имена, начинающиеся с буквы А, например Abigail.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-820">Although the first name in this range is Adam, the RangeS-S mode key-range lock on this index entry ensures that no new names beginning with the letter A can be added before Adam, such as Abigail.</span></span> <span data-ttu-id="a5bd4-821">Аналогично блокировка диапазона ключей в режиме RangeS-S по элементу индекса для имени Dale дает гарантию того, что не будут добавляться новые имена после Carlos, начинающиеся с буквы C, например Clive.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-821">Similarly, the RangeS-S key-range lock on the index entry for Dale ensures that no new names beginning with the letter C can be added after Carlos, such as Clive.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-822">Число установленных блокировок RangeS-S равно *n*+1, где *n* — это число строк, удовлетворяющих запросу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-822">The number of RangeS-S locks held is *n*+1, where *n* is the number of rows that satisfy the query.</span></span>  
  
##### <a name="singleton-fetch-of-nonexistent-data"></a><span data-ttu-id="a5bd4-823">Одноэлементная выборка несуществующих данных</span><span class="sxs-lookup"><span data-stu-id="a5bd4-823">Singleton Fetch of Nonexistent Data</span></span>  

 <span data-ttu-id="a5bd4-824">Если запрос в транзакции пытается выбрать строку, которая не существует, то выполнение данного запроса позднее в той же самой транзакции приведет к такому же результату.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-824">If a query within a transaction attempts to select a row that does not exist, issuing the query at a later point within the same transaction has to return the same result.</span></span> <span data-ttu-id="a5bd4-825">Никакой транзакции не будет разрешено вставить эту несуществующую строку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-825">No other transaction can be allowed to insert that nonexistent row.</span></span> <span data-ttu-id="a5bd4-826">Например, для запроса:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-826">For example, given this query:</span></span>  
  
```sql 
SELECT name  
    FROM mytable  
    WHERE name = 'Bill';  
```  
  
 <span data-ttu-id="a5bd4-827">На элемент индекса устанавливается блокировка диапазона ключей, соответствующая именам от `Ben` до `Bing`, так как имя `Bill` было бы вставлено между этими соседними элементами индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-827">A key-range lock is placed on the index entry corresponding to the name range from `Ben` to `Bing` because the name `Bill` would be inserted between these two adjacent index entries.</span></span> <span data-ttu-id="a5bd4-828">Блокировка диапазона ключей режима RangeS-S применяется к элементу индекса `Bing`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-828">The RangeS-S mode key-range lock is placed on the index entry `Bing`.</span></span> <span data-ttu-id="a5bd4-829">Это предотвращает вставку другими транзакциями значений между элементами индекса `Bill` и `Ben`, например запрещается вставка значения `Bing`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-829">This prevents any other transaction from inserting values, such as `Bill`, between the index entries `Ben` and `Bing`.</span></span>  
  
##### <a name="delete-operation"></a><span data-ttu-id="a5bd4-830">Операция удаления</span><span class="sxs-lookup"><span data-stu-id="a5bd4-830">Delete Operation</span></span>  

 <span data-ttu-id="a5bd4-831">При удалении значения из транзакции диапазон, к которому относится значение, не должен быть заблокирован во время существования транзакции, которая выполняет удаление.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-831">When deleting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the delete operation.</span></span> <span data-ttu-id="a5bd4-832">Блокировка удаляемого значения ключа до конца выполнения транзакции достаточна для обеспечения возможности сериализации.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-832">Locking the deleted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="a5bd4-833">Например, рассмотрим эту инструкцию DELETE:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-833">For example, given this DELETE statement:</span></span>  
  
```sql  
DELETE mytable  
    WHERE name = 'Bob';  
```  
  
 <span data-ttu-id="a5bd4-834">Монопольная (X) блокировка установлена на элемент индекса, соответствующий имени `Bob`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-834">An exclusive (X) lock is placed on the index entry corresponding to the name `Bob`.</span></span> <span data-ttu-id="a5bd4-835">Другие транзакции могут добавлять или удалять значения, находящиеся перед удаленным значением `Bob` или после него.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-835">Other transactions can insert or delete values before or after the deleted value `Bob`.</span></span> <span data-ttu-id="a5bd4-836">Однако попытка любой транзакции прочесть, вставить или удалить значение `Bob` блокируется до фиксации или отката транзакции, которая выполнила удаление.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-836">However, any transaction that attempts to read, insert, or delete the value `Bob` will be blocked until the deleting transaction either commits or rolls back.</span></span>  
  
 <span data-ttu-id="a5bd4-837">Удаление диапазона можно выполнить, используя три базовых режима блокировки: блокировки строки, страницы или таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-837">Range delete can be executed using three basic lock modes: row, page, or table lock.</span></span> <span data-ttu-id="a5bd4-838">Стратегия блокировки строки, страницы или таблицы либо выбирается автоматически оптимизатором запросов, либо задается пользователем с помощью подсказок блокировки ROWLOCK, PAGLOCK и TABLOCK.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-838">The row, page, or table locking strategy is decided by query optimizer or can be specified by the user through optimizer hints such as ROWLOCK, PAGLOCK, or TABLOCK.</span></span> <span data-ttu-id="a5bd4-839">При использовании подсказок PAGLOCK или TABLOCK при удалении всех входящих в страницу строк компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] немедленно освобождает память, занимаемую страницей индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-839">When PAGLOCK or TABLOCK is used, the [!INCLUDE[ssDE](../includes/ssde-md.md)] immediately deallocates an index page if all rows are deleted from this page.</span></span> <span data-ttu-id="a5bd4-840">При использовании подсказки ROWLOCK, напротив, все удаленные строки лишь отмечаются как удаленные, со страницы индекса их удаляет позже выполняющаяся в режиме в сети задача.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-840">In contrast, when ROWLOCK is used, all deleted rows are marked only as deleted; they are removed from the index page later using a background task.</span></span>  
  
##### <a name="insert-operation"></a><span data-ttu-id="a5bd4-841">Операция вставки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-841">Insert Operation</span></span>  

 <span data-ttu-id="a5bd4-842">При вставке значения из транзакции диапазон, в который попадает значение, не должен быть заблокирован во время существования транзакции, выполняющей вставку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-842">When inserting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="a5bd4-843">Блокировка вставленного значения ключа до конца выполнения транзакции достаточна для обеспечения возможности сериализации.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-843">Locking the inserted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="a5bd4-844">Рассмотрим следующую инструкцию INSERT:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-844">For example, given this INSERT statement:</span></span>  
  
```sql  
INSERT mytable VALUES ('Dan');  
```  
  
 <span data-ttu-id="a5bd4-845">Для проверки диапазона блокировка диапазона ключей в режиме RangeI-N применяется к элементу индекса, соответствующему имени David.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-845">The RangeI-N mode key-range lock is placed on the index entry corresponding to the name David to test the range.</span></span> <span data-ttu-id="a5bd4-846">Если блокировка предоставляется, тогда вставляется `Dan`, и к значению `Dan` применяется монопольная (X) блокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-846">If the lock is granted, `Dan` is inserted and an exclusive (X) lock is placed on the value `Dan`.</span></span> <span data-ttu-id="a5bd4-847">Блокировка диапазона ключей в режиме RangeI-N необходима только для проверки диапазона, поэтому она не поддерживается в течение всего времени существования выполняющей вставку транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-847">The RangeI-N mode key-range lock is necessary only to test the range and is not held for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="a5bd4-848">Другие транзакции могут вставлять или удалять значения, находящиеся перед вставленным значением `Dan` или после него.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-848">Other transactions can insert or delete values before or after the inserted value `Dan`.</span></span> <span data-ttu-id="a5bd4-849">Однако попытка любой транзакции прочесть, вставить или удалить значение `Dan` будет блокироваться до отката или фиксации транзакции, которая выполнила вставку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-849">However, any transaction attempting to read, insert, or delete the value `Dan` will be locked until the inserting transaction either commits or rolls back.</span></span>  
  
### <a name="dynamic-locking"></a><span data-ttu-id="a5bd4-850">Динамические блокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-850">Dynamic Locking</span></span>  

 <span data-ttu-id="a5bd4-851">Использование блокировок низкого уровня, например блокировок строк, увеличивает параллелизм, поскольку снижается вероятность одновременной блокировки области данных двумя различными транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-851">Using low-level locks, such as row locks, increases concurrency by decreasing the probability that two transactions will request locks on the same piece of data at the same time.</span></span> <span data-ttu-id="a5bd4-852">Использование блокировок низкого уровня также увеличивает их количество, что приводит к большей загрузке ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-852">Using low-level locks also increases the number of locks and the resources needed to manage them.</span></span> <span data-ttu-id="a5bd4-853">При использовании блокировок страниц и таблиц высокого уровня загруженность снижается, однако при этом уменьшается степень параллелизма.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-853">Using high-level table or page locks lowers overhead, but at the expense of lowering concurrency.</span></span>  
  
 <span data-ttu-id="a5bd4-854">![Диаграмма стоимости и гранулярности](media/lockcht.gif "Диаграмма стоимости и гранулярности")</span><span class="sxs-lookup"><span data-stu-id="a5bd4-854">![Diagram showing cost versus granularity](media/lockcht.gif "Diagram showing cost versus granularity")</span></span>  
  
 <span data-ttu-id="a5bd4-855">В приложении [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] используется динамический выбор уровня блокировки, что обеспечивает оптимальное использование ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-855">The [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy to determine the most cost-effective locks.</span></span> <span data-ttu-id="a5bd4-856">При выполнении запроса компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] автоматически определяет оптимальный уровень блокировки на основании характеристик схемы и запроса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-856">The [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically determines what locks are most appropriate when the query is executed, based on the characteristics of the schema and query.</span></span> <span data-ttu-id="a5bd4-857">Например, при просмотре индекса для уменьшения загрузки системы оптимизатор может задать блокировки на уровне страниц.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-857">For example, to reduce the overhead of locking, the optimizer may choose page-level locks in an index when performing an index scan.</span></span>  
  
 <span data-ttu-id="a5bd4-858">Динамический выбор уровня блокировки имеет следующие преимущества.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-858">Dynamic locking has the following advantages:</span></span>  
  
-   <span data-ttu-id="a5bd4-859">Упрощенное администрирование базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-859">Simplified database administration.</span></span> <span data-ttu-id="a5bd4-860">Администратор базы данных не должен задавать условия укрупнения блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-860">Database administrators do not have to adjust lock escalation thresholds.</span></span>  
  
-   <span data-ttu-id="a5bd4-861">Повышение производительности.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-861">Increased performance.</span></span> <span data-ttu-id="a5bd4-862">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] сводит к минимуму загрузку системы, назначая блокировки индивидуально для каждой задачи.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-862">The [!INCLUDE[ssDE](../includes/ssde-md.md)] minimizes system overhead by using locks appropriate to the task.</span></span>  
  
-   <span data-ttu-id="a5bd4-863">Разработчики приложений могут полностью сосредоточиться на процессе разработки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-863">Application developers can concentrate on development.</span></span> <span data-ttu-id="a5bd4-864">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] автоматически регулирует блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-864">The [!INCLUDE[ssDE](../includes/ssde-md.md)] adjusts locking automatically.</span></span>  
  
 <span data-ttu-id="a5bd4-865">В [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] и более поздних версиях поведение укрупнения блокировок изменилось с введением параметра LOCK_ESCALATION.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-865">In [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] and later versions, the behavior of lock escalation has changed with the introduction of the LOCK_ESCALATION option.</span></span> <span data-ttu-id="a5bd4-866">Дополнительные сведения см. в описании параметра LOCK_ESCALATION [инструкции ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-866">For more information, see the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="deadlocking"></a><span data-ttu-id="a5bd4-867">Взаимоблокировка</span><span class="sxs-lookup"><span data-stu-id="a5bd4-867">Deadlocking</span></span>  

 <span data-ttu-id="a5bd4-868">Взаимоблокировка возникает, когда две или более задачи постоянно блокируют друг друга из-за того, что задача каждой из сторон блокирует ресурс, необходимый другой стороне.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-868">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="a5bd4-869">Пример:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-869">For example:</span></span>  
  
-   <span data-ttu-id="a5bd4-870">Транзакция А создает общую блокировку строки 1.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-870">Transaction A acquires a share lock on row 1.</span></span>  
  
-   <span data-ttu-id="a5bd4-871">Транзакция Б создает общую блокировку строки 2.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-871">Transaction B acquires a share lock on row 2.</span></span>  
  
-   <span data-ttu-id="a5bd4-872">Транзакция А теперь запрашивает монопольную блокировку строки 2 и блокируется до того, как транзакция Б закончится и освободит общую блокировку строки 2.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-872">Transaction A now requests an exclusive lock on row 2, and is blocked until transaction B finishes and releases the share lock it has on row 2.</span></span>  
  
-   <span data-ttu-id="a5bd4-873">Транзакция Б теперь запрашивает монопольную блокировку строки 1 и блокируется до того, как транзакция A закончится и освободит общую блокировку строки 1.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-873">Transaction B now requests an exclusive lock on row 1, and is blocked until transaction A finishes and releases the share lock it has on row 1.</span></span>  
  
 <span data-ttu-id="a5bd4-874">Транзакция А не может завершиться до того, как завершится транзакция Б, а транзакция Б заблокирована транзакцией А. Такое условие также называется цикличной зависимостью: транзакция А зависит от транзакции Б, а транзакция Б зависит от транзакции А и этим замыкает цикл.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-874">Transaction A cannot complete until transaction B completes, but transaction B is blocked by transaction A. This condition is also called a cyclic dependency: Transaction A has a dependency on transaction B, and transaction B closes the circle by having a dependency on transaction A.</span></span>  
  
 <span data-ttu-id="a5bd4-875">Обе транзакции находятся в состоянии взаимоблокировки и будут всегда находиться в состоянии ожидания, если взаимоблокировка не будет разрушена внешним процессом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-875">Both transactions in a deadlock will wait forever unless the deadlock is broken by an external process.</span></span> <span data-ttu-id="a5bd4-876">Монитор взаимоблокировок компонента [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] периодически проверяет задачи на состояние взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-876">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] deadlock monitor periodically checks for tasks that are in a deadlock.</span></span> <span data-ttu-id="a5bd4-877">Если монитор обнаруживает цикличную зависимость, то выбирается одна задача, для которой транзакция будет завершена с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-877">If the monitor detects a cyclic dependency, it chooses one of the tasks as a victim and terminates its transaction with an error.</span></span> <span data-ttu-id="a5bd4-878">Это позволяет другой задаче завершить свою транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-878">This allows the other task to complete its transaction.</span></span> <span data-ttu-id="a5bd4-879">Позднее приложение может повторно выполнить транзакцию, которая завершилась с ошибкой, обычно после того как другая транзакция (бывшая в состоянии взаимоблокировки) завершится.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-879">The application with the transaction that terminated with an error can retry the transaction, which usually completes after the other deadlocked transaction has finished.</span></span>  
  
 <span data-ttu-id="a5bd4-880">Взаимоблокировки часто путают с обычными блокировками.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-880">Deadlocking is often confused with normal blocking.</span></span> <span data-ttu-id="a5bd4-881">Если транзакция запрашивает блокировку на ресурс, заблокированный дугой транзакцией, то запрашивающая транзакция ожидает до тех пор, пока блокировка не освобождается.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-881">When a transaction requests a lock on a resource locked by another transaction, the requesting transaction waits until the lock is released.</span></span> <span data-ttu-id="a5bd4-882">По умолчанию время ожидания транзакций сервера [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] не ограничено, если только не установлен параметр LOCK_TIMEOUT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-882">By default, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] transactions do not time out, unless LOCK_TIMEOUT is set.</span></span> <span data-ttu-id="a5bd4-883">Запрашивающая транзакция блокируется, но не устанавливается в состояние взаимоблокировки, потому что запрашивающая транзакция ничего не сделала, чтобы заблокировать транзакцию, владеющую блокировкой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-883">The requesting transaction is blocked, not deadlocked, because the requesting transaction has not done anything to block the transaction owning the lock.</span></span> <span data-ttu-id="a5bd4-884">Наконец, владеющая транзакция завершится и освободит блокировку, и затем запрашивающая транзакция получит блокировку и продолжится.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-884">Eventually, the owning transaction will complete and release the lock, and then the requesting transaction will be granted the lock and proceed.</span></span>  
  
 <span data-ttu-id="a5bd4-885">Взаимоблокировки иногда называют тупиковыми ситуациями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-885">Deadlocks are sometimes called a deadly embrace.</span></span>  
  
 <span data-ttu-id="a5bd4-886">Условие взаимоблокировки может возникнуть в любой системе с несколькими потоками, не только в системе управления реляционными базами данных, и может возникнуть для ресурсов, отличных от блокировок объектов баз данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-886">Deadlock is a condition that can occur on any system with multiple threads, not just on a relational database management system, and can occur for resources other than locks on database objects.</span></span> <span data-ttu-id="a5bd4-887">Например, в многопоточной операционной системе один поток может занять один или более ресурсов, таких как блокировки памяти.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-887">For example, a thread in a multithreaded operating system might acquire one or more resources, such as blocks of memory.</span></span> <span data-ttu-id="a5bd4-888">Если в настоящее время другой поток владеет занятым ресурсом, то первый поток должен ждать, пока владеющий поток освободит целевой ресурс.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-888">If the resource being acquired is currently owned by another thread, the first thread may have to wait for the owning thread to release the target resource.</span></span> <span data-ttu-id="a5bd4-889">В таком случае говорят, что ожидающий поток зависит от владеющего потока для данного ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-889">The waiting thread is said to have a dependency on the owning thread for that particular resource.</span></span> <span data-ttu-id="a5bd4-890">В экземпляре компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] сеансы оказываются взаимозаблокированными при использовании ресурсов, отличных от баз данных, таких как память или потоки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-890">In an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], sessions can deadlock when acquiring nondatabase resources, such as memory or threads.</span></span>  
  
 <span data-ttu-id="a5bd4-891">![Диаграмма, иллюстрирующая взаимоблокировку транзакций](media/dedlck1.gif "Диаграмма, иллюстрирующая взаимоблокировку транзакций")</span><span class="sxs-lookup"><span data-stu-id="a5bd4-891">![Diagram showing transaction deadlock](media/dedlck1.gif "Diagram showing transaction deadlock")</span></span>  
  
 <span data-ttu-id="a5bd4-892">На рисунке транзакция Т1 зависит от транзакции Т2 для ресурса блокировки таблицы **Деталь**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-892">In the illustration, transaction T1 has a dependency on transaction T2 for the **Part** table lock resource.</span></span> <span data-ttu-id="a5bd4-893">Аналогично транзакция Т2 зависит от транзакции Т1 для ресурса блокировки таблицы **Поставщик**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-893">Similarly, transaction T2 has a dependency on transaction T1 for the **Supplier** table lock resource.</span></span> <span data-ttu-id="a5bd4-894">Так как эти зависимости из одного цикла, возникает взаимоблокировка транзакций T1 и T2.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-894">Because these dependencies form a cycle, there is a deadlock between transactions T1 and T2.</span></span>  
  
 <span data-ttu-id="a5bd4-895">Взаимоблокировка может произойти также в случае, когда таблица секционирована, а параметр LOCK_ESCALATION инструкции ALTER TABLE имеет значение AUTO.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-895">Deadlocks can also occur when a table is partitioned and the LOCK_ESCALATION setting of ALTER TABLE is set to AUTO.</span></span> <span data-ttu-id="a5bd4-896">Если для LOCK_ESCALATION установлено значение AUTO, параллелизм увеличивается, позволяя [!INCLUDE[ssDE](../includes/ssde-md.md)] блоку блокировать секции таблицы на уровне HoBT, а не на уровне таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-896">When LOCK_ESCALATION is set to AUTO, concurrency increases by allowing the [!INCLUDE[ssDE](../includes/ssde-md.md)] to lock table partitions at the HoBT level instead of at the TABLE level.</span></span> <span data-ttu-id="a5bd4-897">Однако если отдельные транзакции удерживают блокировки секций в таблице и пытаются заблокировать еще какой-либо объект в разделе, принадлежащем другой транзакции, это вызовет взаимоблокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-897">However, when separate transactions hold partition locks in a table and want a lock somewhere on the other transactions partition, this causes a deadlock.</span></span> <span data-ttu-id="a5bd4-898">Такого типа взаимоблокировок можно избежать, установив параметр LOCK_ESCALATION в значение TABLE. Однако это заметно снизит степень параллелизма, поскольку операциям массового обновления данных секции нужно будет ожидать блокировки таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-898">This type of deadlock can be avoided by setting LOCK_ESCALATION to TABLE; although this setting will reduce concurrency by forcing large updates to a partition to wait for a table lock.</span></span>  
  
#### <a name="detecting-and-ending-deadlocks"></a><span data-ttu-id="a5bd4-899">Обнаружение и устранение взаимоблокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-899">Detecting and Ending Deadlocks</span></span>  

 <span data-ttu-id="a5bd4-900">Взаимоблокировка возникает, когда две или более задачи постоянно блокируют друг друга из-за того, что задача каждой из сторон блокирует ресурс, необходимый другой стороне.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-900">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="a5bd4-901">На следующем графике приведена общая схема состояния взаимоблокировки, в которой:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-901">The following graph presents a high level view of a deadlock state where:</span></span>  
  
-   <span data-ttu-id="a5bd4-902">Задача T1 блокирует ресурс R1 (изображается в виде стрелки от R1 к T1) и запросила блокировку ресурса R2 (изображается в виде стрелки от T1 к R2).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-902">Task T1 has a lock on resource R1 (indicated by the arrow from R1 to T1) and has requested a lock on resource R2 (indicated by the arrow from T1 to R2).</span></span>  
  
-   <span data-ttu-id="a5bd4-903">Задача T2 блокирует ресурс R2 (изображается в виде стрелки от R2 к T2) и запросила блокировку ресурса R1 (изображается в виде стрелки от T2 к R1).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-903">Task T2 has a lock on resource R2 (indicated by the arrow from R2 to T2) and has requested a lock on resource R1 (indicated by the arrow from T2 to R1).</span></span>  
  
-   <span data-ttu-id="a5bd4-904">Так как ни одна из задач не может продолжиться до тех пор, пока не освободится ресурс, а ни один из ресурсов не может быть освобожден до тех пор, пока не продолжится задание, существует состояние взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-904">Because neither task can continue until a resource is available and neither resource can be released until a task continues, a deadlock state exists.</span></span>  
  
 <span data-ttu-id="a5bd4-905">![Диаграмма, иллюстрирующая задачи в состоянии взаимоблокировки](media/task-deadlock-state.gif "Диаграмма, иллюстрирующая задачи в состоянии взаимоблокировки")</span><span class="sxs-lookup"><span data-stu-id="a5bd4-905">![Diagram showing tasks in a deadlock state](media/task-deadlock-state.gif "Diagram showing tasks in a deadlock state")</span></span>  
  
 <span data-ttu-id="a5bd4-906">Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] автоматически обнаруживает цикл взаимоблокировки в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-906">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] automatically detects deadlock cycles within [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a5bd4-907">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] для устранения взаимоблокировки выбирает один из сеансов в качестве жертвы взаимоблокировки и прекращает выполнение текущей транзакции с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-907">The [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses one of the sessions as a deadlock victim and the current transaction is terminated with an error to break the deadlock.</span></span>  
  
##### <a name="resources-that-can-deadlock"></a><span data-ttu-id="a5bd4-908">Ресурсы, которые могут принимать участие во взаимоблокировке</span><span class="sxs-lookup"><span data-stu-id="a5bd4-908">Resources That Can Deadlock</span></span>  

 <span data-ttu-id="a5bd4-909">Каждый сеанс пользователя может иметь одну или несколько запущенных от его имени задач, которые могут использовать или ожидать использование различных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-909">Each user session might have one or more tasks running on its behalf where each task might acquire or wait to acquire a variety of resources.</span></span> <span data-ttu-id="a5bd4-910">Следующие типы ресурсов могут привести к блокировке, которая может привести к взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-910">The following types of resources can cause blocking that could result in a deadlock.</span></span>  
  
-   <span data-ttu-id="a5bd4-911">**Блокировки**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-911">**Locks**.</span></span> <span data-ttu-id="a5bd4-912">Ожидание применения блокировки такого ресурса, как объект, страница, строка, метаданные и приложение, может привести к взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-912">Waiting to acquire locks on resources, such as objects, pages, rows, metadata, and applications can cause deadlock.</span></span> <span data-ttu-id="a5bd4-913">Например, транзакция T1 применила общую (S) блокировку строки r1 и ожидает монопольную (X) блокировку строки r2.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-913">For example, transaction T1 has a shared (S) lock on row r1 and is waiting to get an exclusive (X) lock on r2.</span></span> <span data-ttu-id="a5bd4-914">Транзакция T2 применила общую (S) блокировку строки r2 и ожидает монопольную (X) блокировку строки r1.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-914">Transaction T2 has a shared (S) lock on r2 and is waiting to get an exclusive (X) lock on row r1.</span></span> <span data-ttu-id="a5bd4-915">В результате получается цикл блокировки, в котором T1 и T2 ожидают, пока одна транзакция освободит заблокированный другой транзакцией ресурс.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-915">This results in a lock cycle in which T1 and T2 wait for each other to release the locked resources.</span></span>  
  
-   <span data-ttu-id="a5bd4-916">**Рабочие потоки**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-916">**Worker threads**.</span></span> <span data-ttu-id="a5bd4-917">Задача, ожидающая в очереди доступного рабочего потока, может привести к взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-917">A queued task waiting for an available worker thread can cause deadlock.</span></span> <span data-ttu-id="a5bd4-918">Если задача, ожидающая в очереди, владеет ресурсами, которые блокируют все рабочие потоки, результатом будет взаимоблокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-918">If the queued task owns resources that are blocking all worker threads, a deadlock will result.</span></span> <span data-ttu-id="a5bd4-919">Например, сеанс S1 запускает транзакцию и применяет общую (S) блокировку строки r1, а затем уходит в спящий режим.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-919">For example, session S1 starts a transaction and acquires a shared (S) lock on row r1 and then goes to sleep.</span></span> <span data-ttu-id="a5bd4-920">Активные сеансы, запущенные на всех доступных рабочих потоках, делают попытки применить монопольную блокировку (X) строки r1.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-920">Active sessions running on all available worker threads are trying to acquire exclusive (X) locks on row r1.</span></span> <span data-ttu-id="a5bd4-921">Так как сеанс S1 не может использовать рабочий поток, он не может зафиксировать транзакцию и освободить строку r1.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-921">Because session S1 cannot acquire a worker thread, it cannot commit the transaction and release the lock on row r1.</span></span> <span data-ttu-id="a5bd4-922">Возникает взаимоблокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-922">This results in a deadlock.</span></span>  
  
-   <span data-ttu-id="a5bd4-923">**Память.**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-923">**Memory**.</span></span> <span data-ttu-id="a5bd4-924">Если параллельные запросы ожидают предоставления памяти, которая не может быть выделена при доступном объеме памяти, может возникнуть взаимоблокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-924">When concurrent requests are waiting for memory grants that cannot be satisfied with the available memory, a deadlock can occur.</span></span> <span data-ttu-id="a5bd4-925">Например, два параллельных запроса Q1 и Q2 выполняются как определяемые пользователем функции, использующие соответственно 10 МБ и 20 МБ памяти.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-925">For example, two concurrent queries, Q1 and Q2, execute as user-defined functions that acquire 10MB and 20MB of memory respectively.</span></span> <span data-ttu-id="a5bd4-926">Если каждому запросу нужно 30 МБ, а общий доступный объем памяти равен 20 МБ, то Q1 и Q2 должны ожидать, пока один из них не освободит память, то есть возникает взаимоблокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-926">If each query needs 30MB and the total available memory is 20MB, then Q1 and Q2 must wait for each other to release memory, and this results in a deadlock.</span></span>  
  
-   <span data-ttu-id="a5bd4-927">**Ресурсы, связанные с параллельным выполнением запросов** Потоки-координаторы, производители и потребители, ассоциированные с портом обмена, могут заблокировать друг друга, приводя к взаимоблокировке, как правило, при включении, по крайней мере, еще одного процесса, который не является частью параллельного запроса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-927">**Parallel query execution-related resources** Coordinator, producer, or consumer threads associated with an exchange port may block each other causing a deadlock usually when including at least one other process that is not a part of the parallel query.</span></span> <span data-ttu-id="a5bd4-928">Кроме того, когда начинается выполнение параллельного запроса, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] определяет степень параллелизма, или число потоков исполнителя, на основе текущей рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-928">Also, when a parallel query starts execution, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines the degree of parallelism, or the number of worker threads, based upon the current workload.</span></span> <span data-ttu-id="a5bd4-929">При неожиданном изменении системной рабочей нагрузки, например когда начинается выполнение на сервере новых запросов или системе не хватает потоков исполнителя, может возникать взаимоблокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-929">If the system workload unexpectedly changes, for example, where new queries start running on the server or the system runs out of worker threads, then a deadlock could occur.</span></span>  
  
-   <span data-ttu-id="a5bd4-930">**Ресурсы режима MARS**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-930">**Multiple Active Result Sets (MARS) resources**.</span></span> <span data-ttu-id="a5bd4-931">Эти ресурсы используются для управления чередованием активных запросов в режиме MARS.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-931">These resources are used to control interleaving of multiple active requests under MARS.</span></span> <span data-ttu-id="a5bd4-932">Дополнительные сведения см. [в разделе множественные активные результирующие наборы (MARS) в SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-932">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
    -   <span data-ttu-id="a5bd4-933">**Пользовательский ресурс**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-933">**User resource**.</span></span> <span data-ttu-id="a5bd4-934">Если поток ожидает ресурс, потенциально контролируемый пользовательским приложением, ресурс считается внешним или пользовательским и рассматривается как заблокированный.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-934">When a thread is waiting for a resource that is potentially controlled by a user application, the resource is considered to be an external or user resource and is treated like a lock.</span></span>  
  
    -   <span data-ttu-id="a5bd4-935">**Объект взаимного исключения сеанса**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-935">**Session mutex**.</span></span> <span data-ttu-id="a5bd4-936">Задачи, выполняемые в одном сеансе, чередуются. Это означает, что только одна задача сеанса может выполняться в данный момент времени.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-936">The tasks running in one session are interleaved, meaning that only one task can run under the session at a given time.</span></span> <span data-ttu-id="a5bd4-937">Перед тем как задача может быть запущена на выполнение, она должна получить монопольный доступ к объекту взаимного исключения сеанса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-937">Before the task can run, it must have exclusive access to the session mutex.</span></span>  
  
    -   <span data-ttu-id="a5bd4-938">**Объект взаимного исключения транзакции**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-938">**Transaction mutex**.</span></span> <span data-ttu-id="a5bd4-939">Все задачи, выполняемые в одной транзакции, чередуются. Это означает, что только одна задача транзакции может выполняться в данный момент времени.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-939">All tasks running in one transaction are interleaved, meaning that only one task can run under the transaction at a given time.</span></span> <span data-ttu-id="a5bd4-940">Перед тем как задача может быть запущена на выполнение, она должна получить монопольный доступ к объекту взаимного исключения транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-940">Before the task can run, it must have exclusive access to the transaction mutex.</span></span>  
  
     <span data-ttu-id="a5bd4-941">Чтобы задача могла быть запущена в режиме MARS, она должна занять объект взаимного исключения сеанса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-941">In order for a task to run under MARS, it must acquire the session mutex.</span></span> <span data-ttu-id="a5bd4-942">Если задача выполняется в транзакции, она должна занять объект взаимного исключения транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-942">If the task is running under a transaction, it must then acquire the transaction mutex.</span></span> <span data-ttu-id="a5bd4-943">Этим гарантируется то, что только одна задача будет активна в каждый момент времени данного сеанса и данной транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-943">This guarantees that only one task is active at one time in a given session and a given transaction.</span></span> <span data-ttu-id="a5bd4-944">Как только потребуются необходимые объекты взаимного исключения, задача сможет выполняться.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-944">Once the required mutexes have been acquired, the task can execute.</span></span> <span data-ttu-id="a5bd4-945">По завершении задачи или завершении посреди запроса сначала освобождается объект взаимного исключения транзакции, затем объект взаимного исключения сеанса в порядке, обратном тому, в котором они занимались.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-945">When the task finishes, or yields in the middle of the request, it will first release transaction mutex followed by the session mutex in reverse order of acquisition.</span></span> <span data-ttu-id="a5bd4-946">Однако взаимоблокировки могут произойти и с этими ресурсами.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-946">However, deadlocks can occur with these resources.</span></span> <span data-ttu-id="a5bd4-947">В следующем примере кода две задачи, запросы пользователя U1 и U2, выполняются в одном и том же сеансе.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-947">In the following code example, two tasks, user request U1 and user request U2, are running in the same session.</span></span>  
  
    ```  
    U1:    Rs1=Command1.Execute("insert sometable EXEC usp_someproc");  
    U2:    Rs2=Command2.Execute("select colA from sometable");  
    ```  
  
     <span data-ttu-id="a5bd4-948">Хранимая процедура, выполняемая запросом пользователя U1, заняла объект взаимного исключения сеанса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-948">The stored procedure executing from user request U1 has acquired the session mutex.</span></span> <span data-ttu-id="a5bd4-949">Если для выполнения хранимой процедуры необходимо длительное время, компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] предполагает, что хранимая процедура ждет указаний пользователя.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-949">If the stored procedure takes a long time to execute, it is assumed by the [!INCLUDE[ssDE](../includes/ssde-md.md)] that the stored procedure is waiting for input from the user.</span></span> <span data-ttu-id="a5bd4-950">Запрос пользователя U2 ожидает освобождения объекта взаимного исключения сеанса, в то время как пользователь ожидает результирующий набор от U2, а U1 ожидает пользовательский ресурс.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-950">User request U2 is waiting for the session mutex while the user is waiting for the result set from U2, and U1 is waiting for a user resource.</span></span> <span data-ttu-id="a5bd4-951">Это состояние взаимоблокировки логически представляется так:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-951">This is deadlock state logically illustrated as:</span></span>  
  
 <span data-ttu-id="a5bd4-952">![Блок-диаграмма, показывающая взаимоблокировку пользовательских процессов](media/udb9-logicflowexamplec.gif "Блок-диаграмма, показывающая взаимоблокировку пользовательских процессов")</span><span class="sxs-lookup"><span data-stu-id="a5bd4-952">![Logic diagram showing user process deadlock.](media/udb9-logicflowexamplec.gif "Logic diagram showing user process deadlock.")</span></span>  
  
##### <a name="deadlock-detection"></a><span data-ttu-id="a5bd4-953">Обнаружение взаимоблокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-953">Deadlock Detection</span></span>  

 <span data-ttu-id="a5bd4-954">Все ресурсы, перечисленные в предыдущем разделе, принимают участие в схеме обнаружения взаимоблокировок компонента [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-954">All of the resources listed in the section above participate in the [!INCLUDE[ssDE](../includes/ssde-md.md)] deadlock detection scheme.</span></span> <span data-ttu-id="a5bd4-955">Обнаружение взаимоблокировки выполняется потоком монитора блокировок, который периодически производит поиск по всем задачам в экземпляре компонента [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-955">Deadlock detection is performed by a lock monitor thread that periodically initiates a search through all of the tasks in an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="a5bd4-956">Следующие пункты описывают процесс поиска:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-956">The following points describe the search process:</span></span>  
  
-   <span data-ttu-id="a5bd4-957">Значение интервала по умолчанию составляет 5 секунд.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-957">The default interval is 5 seconds.</span></span>  
  
-   <span data-ttu-id="a5bd4-958">Если поток монитора блокировки находит взаимоблокировки, интервал обнаружения взаимоблокировок снижается с 5 секунд до 100 миллисекунд в зависимости от частоты взаимоблокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-958">If the lock monitor thread finds deadlocks, the deadlock detection interval will drop from 5 seconds to as low as 100 milliseconds depending on the frequency of deadlocks.</span></span>  
  
-   <span data-ttu-id="a5bd4-959">Если поток монитора блокировки прекращает поиск взаимоблокировок, компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] увеличивает интервал до 5 секунд.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-959">If the lock monitor thread stops finding deadlocks, the [!INCLUDE[ssDE](../includes/ssde-md.md)] increases the intervals between searches to 5 seconds.</span></span>  
  
-   <span data-ttu-id="a5bd4-960">Если взаимоблокировка была только что найдена, предполагается, что следующие потоки, которые должны ожидать блокировки, входят в цикл взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-960">If a deadlock has just been detected, it is assumed that the next threads that must wait for a lock are entering the deadlock cycle.</span></span> <span data-ttu-id="a5bd4-961">Первая пара элементов, ожидающих блокировки, после того как взаимоблокировка была обнаружена, запускает поиск взаимоблокировок вместо того, чтобы ожидать следующий интервал обнаружения взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-961">The first couple of lock waits after a deadlock has been detected will immediately trigger a deadlock search rather than wait for the next deadlock detection interval.</span></span> <span data-ttu-id="a5bd4-962">Например, если текущее значение интервала равно 5 секунд и была обнаружена взаимоблокировка, следующий ожидающий блокировки элемент немедленно приводит в действие детектор взаимоблокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-962">For example, if the current interval is 5 seconds, and a deadlock was just detected, the next lock wait will kick off the deadlock detector immediately.</span></span> <span data-ttu-id="a5bd4-963">Если этот ожидающий блокировки элемент является частью взаимоблокировки, она будет обнаружена немедленно, а не во время следующего поиска взаимоблокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-963">If this lock wait is part of a deadlock, it will be detected right away rather than during next deadlock search.</span></span>  
  
 <span data-ttu-id="a5bd4-964">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] обычно выполняет только периодическое обнаружение взаимоблокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-964">The [!INCLUDE[ssDE](../includes/ssde-md.md)] typically performs periodic deadlock detection only.</span></span> <span data-ttu-id="a5bd4-965">Так как число взаимоблокировок, произошедших в системе, обычно мало, периодическое обнаружение взаимоблокировок помогает сократить издержки от взаимоблокировок в системе.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-965">Because the number of deadlocks encountered in the system is usually small, periodic deadlock detection helps to reduce the overhead of deadlock detection in the system.</span></span>  
  
 <span data-ttu-id="a5bd4-966">Если монитор блокировок запускает поиск взаимоблокировок для определенного потока, он идентифицирует ресурс, ожидаемый потоком.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-966">When the lock monitor initiates deadlock search for a particular thread, it identifies the resource on which the thread is waiting.</span></span> <span data-ttu-id="a5bd4-967">После этого монитор блокировок находит владельцев определенного ресурса и рекурсивно продолжает поиск взаимоблокировок для этих потоков до тех пор, пока не найдет цикл.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-967">The lock monitor then finds the owner(s) for that particular resource and recursively continues the deadlock search for those threads until it finds a cycle.</span></span> <span data-ttu-id="a5bd4-968">Цикл, определенный таким способом, формирует взаимоблокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-968">A cycle identified in this manner forms a deadlock.</span></span>  
  
 <span data-ttu-id="a5bd4-969">После обнаружения взаимоблокировки компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] завершает взаимоблокировку, выбрав один из потоков в качестве жертвы взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-969">After a deadlock is detected, the [!INCLUDE[ssDE](../includes/ssde-md.md)] ends a deadlock by choosing one of the threads as a deadlock victim.</span></span> <span data-ttu-id="a5bd4-970">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] прерывает выполняемый в данный момент пакет потока, производит откат транзакции жертвы взаимоблокировки и возвращает приложению ошибку 1205.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-970">The [!INCLUDE[ssDE](../includes/ssde-md.md)] terminates the current batch being executed for the thread, rolls back the transaction of the deadlock victim, and returns a 1205 error to the application.</span></span> <span data-ttu-id="a5bd4-971">Откат транзакции жертвы взаимоблокировки снимает все блокировки, удерживаемые транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-971">Rolling back the transaction for the deadlock victim releases all locks held by the transaction.</span></span> <span data-ttu-id="a5bd4-972">Это позволяет транзакциям потоков разблокироваться и продолжить выполнение.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-972">This allows the transactions of the other threads to become unblocked and continue.</span></span> <span data-ttu-id="a5bd4-973">Ошибка 1205 жертвы взаимоблокировки записывает в журнал ошибок сведения обо всех потоках и ресурсах, затронутых взаимоблокировкой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-973">The 1205 deadlock victim error records information about the threads and resources involved in a deadlock in the error log.</span></span>  
  
 <span data-ttu-id="a5bd4-974">По умолчанию компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] выбирает в качестве жертвы взаимоблокировки сеанс, выполняющий ту транзакцию, откат которой потребует меньше всего затрат.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-974">By default, the [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses as the deadlock victim the session running the transaction that is least expensive to roll back.</span></span> <span data-ttu-id="a5bd4-975">В качестве альтернативы пользователь может указать приоритет сеансов в ситуации взаимоблокировки, используя инструкцию SET DEADLOCK_PRIORITY.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-975">Alternatively, a user can specify the priority of sessions in a deadlock situation using the SET DEADLOCK_PRIORITY statement.</span></span> <span data-ttu-id="a5bd4-976">DEADLOCK_PRIORITY может принимать значения LOW, NORMAL или HIGH или в качестве альтернативы может принять любое целочисленное значение в промежутке (-10 до 10).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-976">DEADLOCK_PRIORITY can be set to LOW, NORMAL, or HIGH, or alternatively can be set to any integer value in the range (-10 to 10).</span></span> <span data-ttu-id="a5bd4-977">Приоритет в случае взаимоблокировки по умолчанию устанавливается на значение NORMAL.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-977">The deadlock priority defaults to NORMAL.</span></span> <span data-ttu-id="a5bd4-978">Если у двух сеансов имеются различные приоритеты в случае взаимоблокировки, то в качестве жертвы взаимоблокировки будет выбран сеанс с более низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-978">If two sessions have different deadlock priorities, the session with the lower priority is chosen as the deadlock victim.</span></span> <span data-ttu-id="a5bd4-979">Если у обоих сеансов установлен одинаковый приоритет в случае взаимоблокировки, то в качестве объекта взаимоблокировки будет выбран сеанс, откат которого потребует наименьших затрат.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-979">If both sessions have the same deadlock priority, the session with the transaction that is least expensive to roll back is chosen.</span></span> <span data-ttu-id="a5bd4-980">Если сеансы, вовлеченные в цикл взаимоблокировки, имеют один и тот же приоритет в случае взаимоблокировки и одинаковую стоимость, то жертва взаимоблокировки выбирается случайным образом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-980">If sessions involved in the deadlock cycle have the same deadlock priority and the same cost, a victim is chosen randomly.</span></span>  
  
 <span data-ttu-id="a5bd4-981">При работе со средой CLR монитор взаимоблокировки автоматически обнаруживает взаимоблокировку для ресурсов синхронизации (мониторы, блокировки чтения и записи и соединение потоков), доступ к которым был получен изнутри управляемых процедур.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-981">When working with CLR, the deadlock monitor automatically detects deadlock for synchronization resources (monitors, reader/writer lock and thread join) accessed inside managed procedures.</span></span> <span data-ttu-id="a5bd4-982">Однако взаимоблокировка снимается путем создания сообщения об исключительной ситуации в процедуре, которая была выбрана в качестве жертвы взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-982">However, the deadlock is resolved by throwing an exception in the procedure that was selected to be the deadlock victim.</span></span> <span data-ttu-id="a5bd4-983">Важно понимать, что исключение не освобождает ресурсы, которыми владеет жертва взаимоблокировки, автоматически; ресурсы должны быть освобождены явно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-983">It is important to understand that the exception does not automatically release resources currently owned by the victim; the resources must be explicitly released.</span></span> <span data-ttu-id="a5bd4-984">В соответствии с поведением исключения, исключение, используемое для идентификации жертвы взаимоблокировки, может быть поймано и отклонено.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-984">Consistent with exception behavior, the exception used to identify a deadlock victim can be caught and dismissed.</span></span>  
  
##### <a name="deadlock-information-tools"></a><span data-ttu-id="a5bd4-985">Информационные средства взаимоблокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-985">Deadlock Information Tools</span></span>  

 <span data-ttu-id="a5bd4-986">Для просмотра сведений о взаимоблокировках компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] предлагает средство мониторинга в форме двух флагов трассировки и события Deadlock Graph в [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-986">To view deadlock information, the [!INCLUDE[ssDE](../includes/ssde-md.md)] provides monitoring tools in the form of two trace flags, and the deadlock graph event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span></span>  
  
###### <a name="trace-flag-1204-and-trace-flag-1222"></a><span data-ttu-id="a5bd4-987">Флаги трассировки 1204 и 1222</span><span class="sxs-lookup"><span data-stu-id="a5bd4-987">Trace Flag 1204 and Trace Flag 1222</span></span>  

 <span data-ttu-id="a5bd4-988">При возникновении взаимоблокировок флаги трассировки 1204 и 1222 возвращают сведения, фиксируемые в журнале ошибок [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-988">When deadlocks occur, trace flag 1204 and trace flag 1222 return information that is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="a5bd4-989">Флаг трассировки 1204 сообщает сведения о взаимоблокировках, отформатированные каждым узлом, принимающим участие во взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-989">Trace flag 1204 reports deadlock information formatted by each node involved in the deadlock.</span></span> <span data-ttu-id="a5bd4-990">Флаг трассировки 1222 форматирует сведения о взаимоблокировках сначала по процессам, а затем по ресурсам.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-990">Trace flag 1222 formats deadlock information, first by processes and then by resources.</span></span> <span data-ttu-id="a5bd4-991">Есть возможность включения обоих флагов трассировки для получения двух представлений одного события взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-991">It is possible to enable both trace flags to obtain two representations of the same deadlock event.</span></span>  
  
 <span data-ttu-id="a5bd4-992">Помимо указания свойств флагов трассировки 1204 и 1222, в таблице ниже содержатся их сходства и различия.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-992">In addition to defining the properties of trace flag 1204 and 1222, the following table also shows the similarities and differences.</span></span>  
  
|<span data-ttu-id="a5bd4-993">Свойство</span><span class="sxs-lookup"><span data-stu-id="a5bd4-993">Property</span></span>|<span data-ttu-id="a5bd4-994">Флаги трассировки 1204 и 1222</span><span class="sxs-lookup"><span data-stu-id="a5bd4-994">Trace Flag 1204 and Trace Flag 1222</span></span>|<span data-ttu-id="a5bd4-995">Только флаг трассировки 1204</span><span class="sxs-lookup"><span data-stu-id="a5bd4-995">Trace Flag 1204 only</span></span>|<span data-ttu-id="a5bd4-996">Только флаг трассировки 1222</span><span class="sxs-lookup"><span data-stu-id="a5bd4-996">Trace Flag 1222 only</span></span>|  
|--------------|-----------------------------------------|--------------------------|--------------------------|  
|<span data-ttu-id="a5bd4-997">Формат вывода</span><span class="sxs-lookup"><span data-stu-id="a5bd4-997">Output format</span></span>|<span data-ttu-id="a5bd4-998">Результаты фиксируются в журнале ошибок [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-998">Output is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>|<span data-ttu-id="a5bd4-999">Ориентирован на узлы, участвующие во взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-999">Focused on the nodes involved in the deadlock.</span></span> <span data-ttu-id="a5bd4-1000">Каждому узлу посвящен раздел, а в последнем разделе описывается пострадавший в результате взаимоблокировки объект.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1000">Each node has a dedicated section, and the final section describes the deadlock victim.</span></span>|<span data-ttu-id="a5bd4-1001">Возвращает сведения в XML-формате, не соответствующем определению схемы XML (XSD).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1001">Returns information in an XML-like format that does not conform to an XML Schema Definition (XSD) schema.</span></span> <span data-ttu-id="a5bd4-1002">В формате предусмотрено три основных раздела.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1002">The format has three major sections.</span></span> <span data-ttu-id="a5bd4-1003">В первом разделе объявляется пострадавший в результате взаимоблокировки объект.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1003">The first section declares the deadlock victim.</span></span> <span data-ttu-id="a5bd4-1004">Во втором разделе описываются все процессы, вовлеченные во взаимоблокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1004">The second section describes each process involved in the deadlock.</span></span> <span data-ttu-id="a5bd4-1005">В третьем разделе приводятся ресурсы, синонимичные узлам во флаге трассировки 1204.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1005">The third section describes the resources that are synonymous with nodes in trace flag 1204.</span></span>|  
|<span data-ttu-id="a5bd4-1006">Идентифицирующие атрибуты</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1006">Identifying attributes</span></span>|<span data-ttu-id="a5bd4-1007">**SPID: \<x> ECID: \<x> .**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1007">**SPID:\<x> ECID:\<x>.**</span></span> <span data-ttu-id="a5bd4-1008">Определяет поток идентификатора системных процессов в случае параллельной обработки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1008">Identifies the system process ID thread in cases of parallel processes.</span></span> <span data-ttu-id="a5bd4-1009">Запись `SPID:<x> ECID:0` , где \<x> заменяется значением SPID, представляет основной поток.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1009">The entry `SPID:<x> ECID:0`, where \<x> is replaced by the SPID value, represents the main thread.</span></span> <span data-ttu-id="a5bd4-1010">Запись `SPID:<x> ECID:<y>` , где \<x> заменяется значением SPID и \<y> больше 0, представляет подпотоки для одного и того же SPID.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1010">The entry `SPID:<x> ECID:<y>`, where \<x> is replaced by the SPID value and \<y> is greater than 0, represents the sub-threads for the same SPID.</span></span><br /><br /> <span data-ttu-id="a5bd4-1011">**BatchID** (**sbid** для флага трассировки 1222).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1011">**BatchID** (**sbid** for trace flag 1222).</span></span> <span data-ttu-id="a5bd4-1012">Определяет пакет, из которого выполнение кода запрашивает или удерживает блокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1012">Identifies the batch from which code execution is requesting or holding a lock.</span></span> <span data-ttu-id="a5bd4-1013">Если режим MARS отключен, значение BatchID равно 0.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1013">When Multiple Active Result Sets (MARS) is disabled, the BatchID value is 0.</span></span> <span data-ttu-id="a5bd4-1014">Если режим MARS включен, для активных пакетов задается значение в диапазоне от 1 до *n*.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1014">When MARS is enabled, the value for active batches is 1 to *n*.</span></span> <span data-ttu-id="a5bd4-1015">При отсутствии активных пакетов в сеансе BatchID присваивается значение 0.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1015">If there are no active batches in the session, BatchID is 0.</span></span><br /><br /> <span data-ttu-id="a5bd4-1016">**Mode**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1016">**Mode**.</span></span> <span data-ttu-id="a5bd4-1017">Задает тип блокировки для конкретного ресурса, который запрошен, предоставлен или ожидается потоком.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1017">Specifies the type of lock for a particular resource that is requested, granted, or waited on by a thread.</span></span> <span data-ttu-id="a5bd4-1018">Значением Mode может быть IS (с намерением совмещаемого доступа), S (совмещаемая), U (на обновление), IX (с намерением монопольного доступа), SIX (совмещаемая с намерением монопольного доступа) и X (монопольная).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1018">Mode can be IS (Intent Shared), S (Shared), U (Update), IX (Intent Exclusive), SIX (Shared with Intent Exclusive), and X (Exclusive).</span></span><br /><br /> <span data-ttu-id="a5bd4-1019">**Line #** (**line** для флага трассировки 1222).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1019">**Line #** (**line** for trace flag 1222).</span></span> <span data-ttu-id="a5bd4-1020">Содержит номер строки в текущем пакете инструкций, который выполнялся в момент возникновения взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1020">Lists the line number in the current batch of statements that was being executed when the deadlock occurred.</span></span><br /><br /> <span data-ttu-id="a5bd4-1021">**Input Buf** (**inputbuf** для флага трассировки 1222).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1021">**Input Buf** (**inputbuf** for trace flag 1222).</span></span> <span data-ttu-id="a5bd4-1022">Выводит все инструкции в текущем пакете.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1022">Lists all the statements in the current batch.</span></span>|<span data-ttu-id="a5bd4-1023">**Node**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1023">**Node**.</span></span> <span data-ttu-id="a5bd4-1024">Представляет номер записи в цепочке взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1024">Represents the entry number in the deadlock chain.</span></span><br /><br /> <span data-ttu-id="a5bd4-1025">**Lists**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1025">**Lists**.</span></span> <span data-ttu-id="a5bd4-1026">Владелец блокировки может быть частью этих списков:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1026">The lock owner can be part of these lists:</span></span><br /><br /> <span data-ttu-id="a5bd4-1027">**Grant List**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1027">**Grant List**.</span></span> <span data-ttu-id="a5bd4-1028">Перечисляет текущих владельцев ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1028">Enumerates the current owners of the resource.</span></span><br /><br /> <span data-ttu-id="a5bd4-1029">**Convert List**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1029">**Convert List**.</span></span> <span data-ttu-id="a5bd4-1030">Перечисляет текущих владельцев, которые пытаются перенести блокировки на более высокий уровень.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1030">Enumerates the current owners that are trying to convert their locks to a higher level.</span></span><br /><br /> <span data-ttu-id="a5bd4-1031">**Wait List**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1031">**Wait List**.</span></span> <span data-ttu-id="a5bd4-1032">Перечисляет текущие запросы на новые блокировки ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1032">Enumerates current new lock requests for the resource.</span></span><br /><br /> <span data-ttu-id="a5bd4-1033">**Statement Type**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1033">**Statement Type**.</span></span> <span data-ttu-id="a5bd4-1034">Описывает тип инструкции DML (SELECT, INSERT, UPDATE или DELETE), для которой потокам выданы разрешения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1034">Describes the type of DML statement (SELECT, INSERT, UPDATE, or DELETE) on which the threads have permissions.</span></span><br /><br /> <span data-ttu-id="a5bd4-1035">**Victim Resource Owner**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1035">**Victim Resource Owner**.</span></span> <span data-ttu-id="a5bd4-1036">Задает участвующий поток, который [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] выбирает в качестве жертвы, чтобы нарушить цикл взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1036">Specifies the participating thread that [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] chooses as the victim to break the deadlock cycle.</span></span> <span data-ttu-id="a5bd4-1037">Выбранный поток и все его субпотоки прекращаются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1037">The chosen thread and all existing sub-threads are terminated.</span></span><br /><br /> <span data-ttu-id="a5bd4-1038">**Next Branch**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1038">**Next Branch**.</span></span> <span data-ttu-id="a5bd4-1039">Представляет два или более субпотока из одного SPID, которые участвуют в цикле взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1039">Represents the two or more sub-threads from the same SPID that are involved in the deadlock cycle.</span></span>|<span data-ttu-id="a5bd4-1040">**deadlock victim**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1040">**deadlock victim**.</span></span> <span data-ttu-id="a5bd4-1041">Представляет собой адрес физической памяти задачи (см. раздел [sys.dm_os_tasks (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)), которая была выбрана в качестве жертвы взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1041">Represents the physical memory address of the task (see [sys.dm_os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) that was selected as a deadlock victim.</span></span> <span data-ttu-id="a5bd4-1042">Может быть равен 0 (нулю) в случае неустраненной взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1042">It may be 0 (zero) in the case of an unresolved deadlock.</span></span> <span data-ttu-id="a5bd4-1043">Откатываемая задача не может быть выбрана в качестве жертвы взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1043">A task that is rolling back cannot be chosen as a deadlock victim.</span></span><br /><br /> <span data-ttu-id="a5bd4-1044">**executionstack**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1044">**executionstack**.</span></span> <span data-ttu-id="a5bd4-1045">Представляет код [!INCLUDE[tsql](../includes/tsql-md.md)], выполняющийся в момент возникновения взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1045">Represents [!INCLUDE[tsql](../includes/tsql-md.md)] code that is being executed at the time the deadlock occurs.</span></span><br /><br /> <span data-ttu-id="a5bd4-1046">**priority**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1046">**priority**.</span></span> <span data-ttu-id="a5bd4-1047">Представляет собой приоритет в случае взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1047">Represents deadlock priority.</span></span> <span data-ttu-id="a5bd4-1048">В определенных случаях компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] может отдать предпочтение изменению приоритета в случае взаимоблокировки на некоторое короткое время для достижения лучшего параллелизма.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1048">In certain cases, the [!INCLUDE[ssDE](../includes/ssde-md.md)] may opt to alter the deadlock priority for a short duration to achieve better concurrency.</span></span><br /><br /> <span data-ttu-id="a5bd4-1049">**logused**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1049">**logused**.</span></span> <span data-ttu-id="a5bd4-1050">Пространство журнала, используемое задачей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1050">Log space used by the task.</span></span><br /><br /> <span data-ttu-id="a5bd4-1051">**owner id**. Идентификатор транзакции, которая управляет запросом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1051">**owner id**. The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="a5bd4-1052">**status**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1052">**status**.</span></span> <span data-ttu-id="a5bd4-1053">Состояние задачи.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1053">State of the task.</span></span> <span data-ttu-id="a5bd4-1054">Принимает одно из следующих значений:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1054">It is one of the following values:</span></span><br /><br /> <span data-ttu-id="a5bd4-1055">>> **pending**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1055">>> **pending**.</span></span> <span data-ttu-id="a5bd4-1056">Ожидание потока исполнителя.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1056">Waiting for a worker thread.</span></span><br /><br /> <span data-ttu-id="a5bd4-1057">>> **runnable**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1057">>> **runnable**.</span></span> <span data-ttu-id="a5bd4-1058">Готов к запуску, но ожидает такт.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1058">Ready to run but waiting for a quantum.</span></span><br /><br /> <span data-ttu-id="a5bd4-1059">>> **running**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1059">>> **running**.</span></span> <span data-ttu-id="a5bd4-1060">Выполняется в данный момент в планировщике.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1060">Currently running on the scheduler.</span></span><br /><br /> <span data-ttu-id="a5bd4-1061">>> **suspended**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1061">>> **suspended**.</span></span> <span data-ttu-id="a5bd4-1062">Выполнение приостановлено.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1062">Execution is suspended.</span></span><br /><br /> <span data-ttu-id="a5bd4-1063">>> **done**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1063">>> **done**.</span></span> <span data-ttu-id="a5bd4-1064">Задача выполнена.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1064">Task has completed.</span></span><br /><br /> <span data-ttu-id="a5bd4-1065">>> **spinloop**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1065">>> **spinloop**.</span></span> <span data-ttu-id="a5bd4-1066">Ожидание освобождение элемента Spinlock.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1066">Waiting for a spinlock to become free.</span></span><br /><br /> <span data-ttu-id="a5bd4-1067">**waitresource**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1067">**waitresource**.</span></span> <span data-ttu-id="a5bd4-1068">Ресурс, необходимый для выполнения задачи.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1068">The resource needed by the task.</span></span><br /><br /> <span data-ttu-id="a5bd4-1069">**waittime**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1069">**waittime**.</span></span> <span data-ttu-id="a5bd4-1070">Время ожидания ресурса в миллисекундах.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1070">Time in milliseconds waiting for the resource.</span></span><br /><br /> <span data-ttu-id="a5bd4-1071">**schedulerid**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1071">**schedulerid**.</span></span> <span data-ttu-id="a5bd4-1072">Планировщик, ассоциированный с этой задачей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1072">Scheduler associated with this task.</span></span> <span data-ttu-id="a5bd4-1073">См. раздел [sys.dm_os_schedulers (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1073">See [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span></span><br /><br /> <span data-ttu-id="a5bd4-1074">**hostname**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1074">**hostname**.</span></span> <span data-ttu-id="a5bd4-1075">Имя рабочей станции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1075">The name of the workstation.</span></span><br /><br /> <span data-ttu-id="a5bd4-1076">**isolationlevel**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1076">**isolationlevel**.</span></span> <span data-ttu-id="a5bd4-1077">Текущий уровень изоляции транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1077">The current transaction isolation level.</span></span><br /><br /> <span data-ttu-id="a5bd4-1078">**Xactid**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1078">**Xactid**.</span></span> <span data-ttu-id="a5bd4-1079">Идентификатор транзакции, которая управляет запросом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1079">The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="a5bd4-1080">**currentdb**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1080">**currentdb**.</span></span> <span data-ttu-id="a5bd4-1081">Идентификатор базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1081">The ID of the database.</span></span><br /><br /> <span data-ttu-id="a5bd4-1082">**lastbatchstarted**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1082">**lastbatchstarted**.</span></span> <span data-ttu-id="a5bd4-1083">Последний раз, когда клиентский процесс запустил выполнение пакета.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1083">The last time a client process started batch execution.</span></span><br /><br /> <span data-ttu-id="a5bd4-1084">**lastbatchcompleted**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1084">**lastbatchcompleted**.</span></span> <span data-ttu-id="a5bd4-1085">Последний раз, когда клиентский процесс завершил выполнение пакета.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1085">The last time a client process completed batch execution.</span></span><br /><br /> <span data-ttu-id="a5bd4-1086">**clientoption1 и clientoption2**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1086">**clientoption1 and clientoption2**.</span></span> <span data-ttu-id="a5bd4-1087">Устанавливает параметры для данного клиентского соединения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1087">Set options on this client connection.</span></span> <span data-ttu-id="a5bd4-1088">Это битовая маска, которая включает сведения о параметрах, обычно управляемых инструкциями SET, такими как SET NOCOUNT и SET XACTABORT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1088">This is a bitmask that includes information about options usually controlled by SET statements such as SET NOCOUNT and SET XACTABORT.</span></span><br /><br /> <span data-ttu-id="a5bd4-1089">**associatedObjectId**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1089">**associatedObjectId**.</span></span> <span data-ttu-id="a5bd4-1090">Представляет собой идентификатор HoBT (КиСД — куча или сбалансированное дерево).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1090">Represents the HoBT (heap or b-tree) ID.</span></span>|  
|<span data-ttu-id="a5bd4-1091">Атрибуты ресурсов</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1091">Resource attributes</span></span>|<span data-ttu-id="a5bd4-1092">**RID**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1092">**RID**.</span></span> <span data-ttu-id="a5bd4-1093">Определяет одну строку в таблице, по которой удерживается или запрошена блокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1093">Identifies the single row within a table on which a lock is held or requested.</span></span> <span data-ttu-id="a5bd4-1094">RID представляется как RID: *db_id:file_id:page_no:row_no*.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1094">RID is represented as RID: *db_id:file_id:page_no:row_no*.</span></span> <span data-ttu-id="a5bd4-1095">Например, `RID: 6:1:20789:0`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1095">For example, `RID: 6:1:20789:0`.</span></span><br /><br /> <span data-ttu-id="a5bd4-1096">**OBJECT**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1096">**OBJECT**.</span></span> <span data-ttu-id="a5bd4-1097">Определяет таблицу, по которой удерживается или запрошена блокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1097">Identifies the table on which a lock is held or requested.</span></span> <span data-ttu-id="a5bd4-1098">OBJECT представляется как OBJECT: *db_id:object_id*.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1098">OBJECT is represented as OBJECT: *db_id:object_id*.</span></span> <span data-ttu-id="a5bd4-1099">Например, `TAB: 6:2009058193`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1099">For example, `TAB: 6:2009058193`.</span></span><br /><br /> <span data-ttu-id="a5bd4-1100">**KEY**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1100">**KEY**.</span></span> <span data-ttu-id="a5bd4-1101">Определяет диапазон ключа в индексе, по которому удерживается или запрошена блокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1101">Identifies the key range within an index on which a lock is held or requested.</span></span> <span data-ttu-id="a5bd4-1102">KEY представляется как KEY: *db_id:hobt_id* (*значение хэша ключа индекса*).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1102">KEY is represented as KEY: *db_id:hobt_id* (*index key hash value*).</span></span> <span data-ttu-id="a5bd4-1103">Например, `KEY: 6:72057594057457664 (350007a4d329)`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1103">For example, `KEY: 6:72057594057457664 (350007a4d329)`.</span></span><br /><br /> <span data-ttu-id="a5bd4-1104">**PAG**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1104">**PAG**.</span></span> <span data-ttu-id="a5bd4-1105">Определяет страничный ресурс, по которому удерживается или запрошена блокировка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1105">Identifies the page resource on which a lock is held or requested.</span></span> <span data-ttu-id="a5bd4-1106">PAG представляется как PAG: *db_id:file_id:page_no*.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1106">PAG is represented as PAG: *db_id:file_id:page_no*.</span></span> <span data-ttu-id="a5bd4-1107">Например, `PAG: 6:1:20789`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1107">For example, `PAG: 6:1:20789`.</span></span><br /><br /> <span data-ttu-id="a5bd4-1108">**EXT**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1108">**EXT**.</span></span> <span data-ttu-id="a5bd4-1109">Определяет структуру экстента.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1109">Identifies the extent structure.</span></span> <span data-ttu-id="a5bd4-1110">EXT представляется как EXT: *db_id:file_id:extent_no*.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1110">EXT is represented as EXT: *db_id:file_id:extent_no*.</span></span> <span data-ttu-id="a5bd4-1111">Например, `EXT: 6:1:9`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1111">For example, `EXT: 6:1:9`.</span></span><br /><br /> <span data-ttu-id="a5bd4-1112">**DB**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1112">**DB**.</span></span> <span data-ttu-id="a5bd4-1113">Определяет блокировку базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1113">Identifies the database lock.</span></span> <span data-ttu-id="a5bd4-1114">**DB представляется одним из следующих способов:**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1114">**DB is represented in one of the following ways:**</span></span><br /><br /> <span data-ttu-id="a5bd4-1115">DB: *db_id*</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1115">DB: *db_id*</span></span><br /><br /> <span data-ttu-id="a5bd4-1116">DB: *db_id*[BULK-OP-DB], который идентифицирует блокировку, выполненную резервной базой данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1116">DB: *db_id*[BULK-OP-DB], which identifies the database lock taken by the backup database.</span></span><br /><br /> <span data-ttu-id="a5bd4-1117">DB: *db_id*[BULK-OP-LOG], который идентифицирует блокировку, выполненную журналом резервных копий этой базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1117">DB: *db_id*[BULK-OP-LOG], which identifies the lock taken by the backup log for that particular database.</span></span><br /><br /> <span data-ttu-id="a5bd4-1118">**APP**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1118">**APP**.</span></span> <span data-ttu-id="a5bd4-1119">Определяет блокировку, выполненную ресурсом приложения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1119">Identifies the lock taken by an application resource.</span></span> <span data-ttu-id="a5bd4-1120">APP представляется как APP: *lock_resource*.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1120">APP is represented as APP: *lock_resource*.</span></span> <span data-ttu-id="a5bd4-1121">Например, `APP: Formf370f478`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1121">For example, `APP: Formf370f478`.</span></span><br /><br /> <span data-ttu-id="a5bd4-1122">**METADATA**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1122">**METADATA**.</span></span> <span data-ttu-id="a5bd4-1123">Представляет ресурсы метаданных, участвующие во взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1123">Represents metadata resources involved in a deadlock.</span></span> <span data-ttu-id="a5bd4-1124">Поскольку METADATA содержит множество вспомогательных ресурсов, возвращаемое значение зависит от заблокированного вспомогательного ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1124">Because METADATA has many subresources, the value returned depends upon the subresource that has deadlocked.</span></span> <span data-ttu-id="a5bd4-1125">Например, METADATA. USER_TYPE возвращает `user_type_id =` \<*integer_value*> .</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1125">For example, METADATA.USER_TYPE returns `user_type_id =` \<*integer_value*>.</span></span> <span data-ttu-id="a5bd4-1126">Дополнительные сведения о ресурсах и вспомогательных ресурсах METADATA см. в разделе [sys.dm_tran_locks (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1126">For more information about METADATA resources and subresources, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span><br /><br /> <span data-ttu-id="a5bd4-1127">**HOBT**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1127">**HOBT**.</span></span> <span data-ttu-id="a5bd4-1128">Представляет кучу или сбалансированное дерево, участвующее во взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1128">Represents a heap or b-tree involved in a deadlock.</span></span>|<span data-ttu-id="a5bd4-1129">Немонопольно для этого флага трассировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1129">None exclusive to this trace flag.</span></span>|<span data-ttu-id="a5bd4-1130">Немонопольно для этого флага трассировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1130">None exclusive to this trace flag.</span></span>|  
  
###### <a name="trace-flag-1204-example"></a><span data-ttu-id="a5bd4-1131">Пример флага трассировки 1204</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1131">Trace Flag 1204 Example</span></span>  

 <span data-ttu-id="a5bd4-1132">Следующий пример демонстрирует результаты, выводимые при включенном флаге трассировки 1204.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1132">The following example shows the output when trace flag 1204 is turned on.</span></span> <span data-ttu-id="a5bd4-1133">В этом случае таблица в узле 1 — это куча без индексов, а таблица в узле 2 — это куча с некластеризованным индексом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1133">In this case, the table in Node 1 is a heap with no indexes, and the table in Node 2 is a heap with a nonclustered index.</span></span> <span data-ttu-id="a5bd4-1134">В момент возникновения взаимоблокировки обновляется ключ индекса в узле 2.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1134">The index key in Node 2 is being updated when the deadlock occurs.</span></span>  
  
```  
Deadlock encountered .... Printing deadlock information  
Wait-for graph  
  
Node:1  
  
RID: 6:1:20789:0               CleanCnt:3 Mode:X Flags: 0x2  
 Grant List 0:  
   Owner:0x0315D6A0 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:55 ECID:0 XactLockInfo: 0x04D9E27C  
   SPID: 55 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
BEGIN TRANSACTION  
   EXEC usp_p2  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x03A3DAD0   
     Mode: U SPID:54 BatchID:0 ECID:0 TaskProxy:(0x04976374) Value:0x315d200 Cost:(0/868)  
  
Node:2  
  
KEY: 6:72057594057457664 (350007a4d329) CleanCnt:2 Mode:X Flags: 0x0  
 Grant List 0:  
   Owner:0x0315D140 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:54 ECID:0 XactLockInfo: 0x03A3DAF4  
   SPID: 54 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
     BEGIN TRANSACTION  
       EXEC usp_p1  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
  
Victim Resource Owner:  
 ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
```  
  
###### <a name="trace-flag-1222-example"></a><span data-ttu-id="a5bd4-1135">Пример флага трассировки 1222</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1135">Trace Flag 1222 Example</span></span>  

 <span data-ttu-id="a5bd4-1136">Следующий пример демонстрирует результаты, выводимые при включенном флаге трассировки 1222.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1136">The following example shows the output when trace flag 1222 is turned on.</span></span> <span data-ttu-id="a5bd4-1137">В этом случае одна таблица — это куча без индексов, а другая — это куча с некластеризованным индексом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1137">In this case, one table is a heap with no indexes, and the other table is a heap with a nonclustered index.</span></span> <span data-ttu-id="a5bd4-1138">В момент возникновения взаимоблокировки обновляется ключ индекса во второй таблице.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1138">In the second table, the index key is being updated when the deadlock occurs.</span></span>  
  
```  
deadlock-list  
 deadlock victim=process689978  
  process-list  
   process id=process6891f8 taskpriority=0 logused=868   
   waitresource=RID: 6:1:20789:0 waittime=1359 ownerId=310444   
   transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:42.733 XDES=0x3a3dad0   
   lockMode=U schedulerid=1 kpid=1952 status=suspended spid=54   
   sbid=0 ecid=0 priority=0 transcount=2   
   lastbatchstarted=2005-09-05T11:22:42.733   
   lastbatchcompleted=2005-09-05T11:22:42.733   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310444 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p1 line=6 stmtstart=202   
     sqlhandle=0x0300060013e6446b027cbb00c69600000100000000000000  
     UPDATE T2 SET COL1 = 3 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600856aa70f503b8104000000000000000000000000  
     EXEC usp_p1       
    inputbuf  
      BEGIN TRANSACTION  
       EXEC usp_p1  
   process id=process689978 taskpriority=0 logused=380   
   waitresource=KEY: 6:72057594057457664 (350007a4d329)     
   waittime=5015 ownerId=310462 transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:44.077 XDES=0x4d9e258 lockMode=U   
   schedulerid=1 kpid=3024 status=suspended spid=55 sbid=0 ecid=0   
   priority=0 transcount=2 lastbatchstarted=2005-09-05T11:22:44.077   
   lastbatchcompleted=2005-09-05T11:22:44.077   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310462 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p2 line=6 stmtstart=200   
     sqlhandle=0x030006004c0a396c027cbb00c69600000100000000000000  
     UPDATE T1 SET COL1 = 4 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600d688e709b85f8904000000000000000000000000  
     EXEC usp_p2       
    inputbuf  
      BEGIN TRANSACTION  
        EXEC usp_p2      
  resource-list  
   ridlock fileid=1 pageid=20789 dbid=6 objectname=AdventureWorks2012.dbo.T2   
   id=lock3136940 mode=X associatedObjectId=72057594057392128  
    owner-list  
     owner id=process689978 mode=X  
    waiter-list  
     waiter id=process6891f8 mode=U requestType=wait  
   keylock hobtid=72057594057457664 dbid=6 objectname=AdventureWorks2012.dbo.T1   
   indexname=nci_T1_COL1 id=lock3136fc0 mode=X   
   associatedObjectId=72057594057457664  
    owner-list  
     owner id=process6891f8 mode=X  
    waiter-list  
     waiter id=process689978 mode=U requestType=wait  
```  
  
###### <a name="profiler-deadlock-graph-event"></a><span data-ttu-id="a5bd4-1139">Событие Deadlock Graph компонента Profiler</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1139">Profiler Deadlock Graph Event</span></span>  

 <span data-ttu-id="a5bd4-1140">Событие в приложении [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], которое представляет собой графическое описание задач и ресурсов, вовлеченных во взаимоблокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1140">This is an event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] that presents a graphical depiction of the tasks and resources involved in a deadlock.</span></span> <span data-ttu-id="a5bd4-1141">Следующий пример иллюстрирует результаты, выводимые компонентом [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], когда включено событие Deadlock Graph.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1141">The following example shows the output from [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] when the deadlock graph event is turned on.</span></span>  
  
 <span data-ttu-id="a5bd4-1142">![Блок-диаграмма потока, показывающая взаимоблокировку пользовательских процессов](media/udb9-profilerdeadlockgraphc.gif "Блок-диаграмма потока, показывающая взаимоблокировку пользовательских процессов")</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1142">![Logic flow diagram showing user process deadlock.](media/udb9-profilerdeadlockgraphc.gif "Logic flow diagram showing user process deadlock.")</span></span>  
  
 <span data-ttu-id="a5bd4-1143">Дополнительные сведения о запуске [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] графа взаимоблокировок см. в статье [сохранение графов взаимоблокировок &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1143">For more information about running the [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] deadlock graph, see [Save Deadlock Graphs &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span></span>  
  
#### <a name="handling-deadlocks"></a><span data-ttu-id="a5bd4-1144">Обработка взаимоблокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1144">Handling Deadlocks</span></span>  

 <span data-ttu-id="a5bd4-1145">Когда экземпляр компонента [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] выбирает транзакцию в качестве жертвы взаимоблокировки, он определяет текущий пакет, откатывает транзакцию назад и возвращает приложению сообщение об ошибке с номером 1205.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1145">When an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] chooses a transaction as a deadlock victim, it terminates the current batch, rolls back the transaction, and returns error message 1205 to the application.</span></span>  
  
 `Your transaction (process ID #52) was deadlocked on {lock | communication buffer | thread} resources with another process and has been chosen as the deadlock victim. Rerun your transaction.`  
  
 <span data-ttu-id="a5bd4-1146">Поскольку любое приложение, отправляющее запросы [!INCLUDE[tsql](../includes/tsql-md.md)], может быть выбрано в качестве жертвы взаимоблокировки, приложения должны содержать обработчик ошибок, перехватывающий сообщение об ошибке с номером 1205.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1146">Because any application submitting [!INCLUDE[tsql](../includes/tsql-md.md)] queries can be chosen as the deadlock victim, applications should have an error handler that can trap error message 1205.</span></span> <span data-ttu-id="a5bd4-1147">Приложение, которое не обрабатывает эту ошибку, не будет знать о том, что произошел откат транзакции, и произойдет ошибка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1147">If an application does not trap the error, the application can proceed unaware that its transaction has been rolled back and errors can occur.</span></span>  
  
 <span data-ttu-id="a5bd4-1148">Благодаря обработчику ошибки 1205 приложение сможет справиться с взаимоблокировкой и предпринять действия по ее исправлению (например автоматически повторить запрос, который не был выполнен из-за взаимоблокировки).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1148">Implementing an error handler that traps error message 1205 allows an application to handle the deadlock situation and take remedial action (for example, automatically resubmitting the query that was involved in the deadlock).</span></span> <span data-ttu-id="a5bd4-1149">Если повторное выполнение запроса происходит автоматически, пользователю не обязательно знать о возникновении взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1149">By resubmitting the query automatically, the user does not need to know that a deadlock occurred.</span></span>  
  
 <span data-ttu-id="a5bd4-1150">Прежде чем повторять запрос, следует приостановить приложение на короткое время.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1150">The application should pause briefly before resubmitting its query.</span></span> <span data-ttu-id="a5bd4-1151">Это позволит второй участвующей транзакции закончить работу и освободить блокировки, которые частично создавали взаимоблокировку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1151">This gives the other transaction involved in the deadlock a chance to complete and release its locks that formed part of the deadlock cycle.</span></span> <span data-ttu-id="a5bd4-1152">Благодаря этому приложение минимизирует вероятность повторного возникновения взаимоблокировки при повторном выполнении запроса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1152">This minimizes the likelihood of the deadlock reoccurring when the resubmitted query requests its locks.</span></span>  
  
#### <a name="minimizing-deadlocks"></a><span data-ttu-id="a5bd4-1153">Минимизация взаимоблокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1153">Minimizing Deadlocks</span></span>  

 <span data-ttu-id="a5bd4-1154">Хотя полностью избежать взаимоблокировок нельзя, следующие соглашения по написанию кода могут уменьшить вероятность возникновения взаимоблокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1154">Although deadlocks cannot be completely avoided, following certain coding conventions can minimize the chance of generating a deadlock.</span></span> <span data-ttu-id="a5bd4-1155">Минимизация взаимоблокировок приводит к увеличению пропускной способности системы (выполнению большего количества транзакций за единицу времени) и уменьшению накладных расходов системы на обслуживание, так как транзакции реже:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1155">Minimizing deadlocks can increase transaction throughput and reduce system overhead because fewer transactions are:</span></span>  
  
-   <span data-ttu-id="a5bd4-1156">Откатываются с отменой всей выполненной транзакцией работы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1156">Rolled back, undoing all the work performed by the transaction.</span></span>  
  
-   <span data-ttu-id="a5bd4-1157">Повторно выполняются приложениями, так как при возникновении взаимоблокировок они откатывались.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1157">Resubmitted by applications because they were rolled back when deadlocked.</span></span>  
  
 <span data-ttu-id="a5bd4-1158">Для минимизации взаимоблокировок:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1158">To help minimize deadlocks:</span></span>  
  
-   <span data-ttu-id="a5bd4-1159">Осуществляйте доступ к объектам в одинаковом порядке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1159">Access objects in the same order.</span></span>  
  
-   <span data-ttu-id="a5bd4-1160">Избегайте взаимодействия с пользователем в транзакциях.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1160">Avoid user interaction in transactions.</span></span>  
  
-   <span data-ttu-id="a5bd4-1161">Уменьшайте размер транзакций, желательно помещая их в один пакет.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1161">Keep transactions short and in one batch.</span></span>  
  
-   <span data-ttu-id="a5bd4-1162">Используйте низкий уровень изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1162">Use a lower isolation level.</span></span>  
  
-   <span data-ttu-id="a5bd4-1163">Используйте уровень изоляции строк, основанный на управлении версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1163">Use a row versioning-based isolation level.</span></span>  
  
    -   <span data-ttu-id="a5bd4-1164">Установите параметр базы данных READ_COMMITTED_SNAPSHOT в ON для разрешения использования управления версиями строк транзакциями с уровнем изоляции READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1164">Set READ_COMMITTED_SNAPSHOT database option ON to enable read-committed transactions to use row versioning.</span></span>  
  
    -   <span data-ttu-id="a5bd4-1165">Используйте изоляцию моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1165">Use snapshot isolation.</span></span>  
  
-   <span data-ttu-id="a5bd4-1166">Используйте связанные соединения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1166">Use bound connections.</span></span>  
  
##### <a name="access-objects-in-the-same-order"></a><span data-ttu-id="a5bd4-1167">Осуществление доступа к объектам в одинаковом порядке</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1167">Access Objects in the Same Order</span></span>  

 <span data-ttu-id="a5bd4-1168">Если все одновременные транзакции будут осуществлять доступ к объектам в одинаковом порядке, то появление взаимоблокировок менее вероятно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1168">If all concurrent transactions access objects in the same order, deadlocks are less likely to occur.</span></span> <span data-ttu-id="a5bd4-1169">Например, если две одновременные транзакции блокируют таблицу **Supplier**, а затем таблицу **Part**, то одна транзакция блокируется в таблице **Supplier** до окончания выполнения другой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1169">For example, if two concurrent transactions obtain a lock on the **Supplier** table and then on the **Part** table, one transaction is blocked on the **Supplier** table until the other transaction is completed.</span></span> <span data-ttu-id="a5bd4-1170">После фиксации или отката первой транзакции вторая продолжает работу, и взаимоблокировки не происходит.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1170">After the first transaction commits or rolls back, the second continues, and a deadlock does not occur.</span></span> <span data-ttu-id="a5bd4-1171">Использование хранимых процедур для всех изменений данных может стандартизировать порядок доступа к объектам.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1171">Using stored procedures for all data modifications can standardize the order of accessing objects.</span></span>  
  
 <span data-ttu-id="a5bd4-1172">![Диаграмма, иллюстрирующая предотвращение взаимоблокировки](media/dedlck2.gif "Диаграмма, иллюстрирующая предотвращение взаимоблокировки")</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1172">![Diagram showing deadlock avoidance](media/dedlck2.gif "Diagram showing deadlock avoidance")</span></span>  
  
##### <a name="avoid-user-interaction-in-transactions"></a><span data-ttu-id="a5bd4-1173">Отказ от взаимодействия с пользователем в транзакциях</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1173">Avoid User Interaction in Transactions</span></span>  

 <span data-ttu-id="a5bd4-1174">Скорость выполнения пакетов без вмешательства пользователя гораздо выше, чем скорость выполнения пакетов, в которых пользователь должен вручную реагировать на запросы,поэтому нет необходимости создавать транзакции, в которых происходит взаимодействие с пользователем, например вводить запрашиваемый приложением параметр.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1174">Avoid writing transactions that include user interaction, because the speed of batches running without user intervention is much faster than the speed at which a user must manually respond to queries, such as replying to a prompt for a parameter requested by an application.</span></span> <span data-ttu-id="a5bd4-1175">Например, если транзакция ожидает ввода информации пользователем, а пользователь ушел на обед или отправился домой в конце рабочей недели, выполнение транзакции может завершиться только после его возвращения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1175">For example, if a transaction is waiting for user input and the user goes to lunch or even home for the weekend, the user delays the transaction from completing.</span></span> <span data-ttu-id="a5bd4-1176">Это уменьшает пропускную способность системы, так как любые блокировки, устанавливаемые транзакцией, будут сняты только после подтверждения или отката транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1176">This degrades system throughput because any locks held by the transaction are released only when the transaction is committed or rolled back.</span></span> <span data-ttu-id="a5bd4-1177">Даже если взаимоблокировка не возникла, другие транзакции, требующие доступа к тем же ресурсам, окажутся заблокированными до окончания выполнения текущей транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1177">Even if a deadlock situation does not arise, other transactions accessing the same resources are blocked while waiting for the transaction to complete.</span></span>  
  
##### <a name="keep-transactions-short-and-in-one-batch"></a><span data-ttu-id="a5bd4-1178">Уменьшение размера транзакций и помещение их в один пакет</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1178">Keep Transactions Short and in One Batch</span></span>  

 <span data-ttu-id="a5bd4-1179">Обычно взаимоблокировка возникает, когда несколько долго выполняемых транзакций запускаются одновременно в одной базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1179">A deadlock typically occurs when several long-running transactions execute concurrently in the same database.</span></span> <span data-ttu-id="a5bd4-1180">Чем длиннее транзакция, тем дольше будут удерживаться полученные монопольные блокировки или блокировки обновления, которые блокируют другие действия и могут привести к взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1180">The longer the transaction, the longer the exclusive or update locks are held, blocking other activity and leading to possible deadlock situations.</span></span>  
  
 <span data-ttu-id="a5bd4-1181">Помещение транзакций в один пакет сокращает объемы передачи данных по сети во время транзакции, уменьшая возможные задержки при завершении транзакций и снятии блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1181">Keeping transactions in one batch minimizes network roundtrips during a transaction, reducing possible delays in completing the transaction and releasing locks.</span></span>  
  
##### <a name="use-a-lower-isolation-level"></a><span data-ttu-id="a5bd4-1182">Использование низкого уровня изоляции</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1182">Use a Lower Isolation Level</span></span>  

 <span data-ttu-id="a5bd4-1183">Определите, может ли транзакция выполняться при более низком уровне изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1183">Determine whether a transaction can run at a lower isolation level.</span></span> <span data-ttu-id="a5bd4-1184">Применение фиксации чтением позволяет транзакции считывать данные, считанные до этого (но не измененные) другой транзакцией, не ожидая завершения выполнения этой другой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1184">Implementing read committed allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="a5bd4-1185">Использование более низкого уровня изоляции, например фиксации чтением, устанавливает совмещаемые блокировки на более короткий промежуток времени, чем при использовании более высокого уровня изоляции, например сериализации.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1185">Using a lower isolation level, such as read committed, holds shared locks for a shorter duration than a higher isolation level, such as serializable.</span></span> <span data-ttu-id="a5bd4-1186">Это уменьшает количество состязаний блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1186">This reduces locking contention.</span></span>  
  
##### <a name="use-a-row-versioning-based-isolation-level"></a><span data-ttu-id="a5bd4-1187">Использование уровня изоляции строк, основанного на управлении версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1187">Use a Row Versioning-based Isolation Level</span></span>  

 <span data-ttu-id="a5bd4-1188">Если параметр базы данных READ_COMMITTED_SNAPSHOT установлен в ON, то транзакция, запущенная с уровнем изоляции подтверждения чтением, использует во время операция считывания управление версиями, а не совмещаемые блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1188">When the READ_COMMITTED_SNAPSHOT database option is set ON, a transaction running under read committed isolation level uses row versioning rather than shared locks during read operations.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1189">Некоторые приложения зависят от блокировок и монополизации ресурсов, обеспечиваемых уровнем изоляции read committed.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1189">Some applications rely upon locking and blocking behavior of read committed isolation.</span></span> <span data-ttu-id="a5bd4-1190">В такие приложения перед включением данного параметра необходимо внести изменения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1190">For these applications, some change is required before this option can be enabled.</span></span>  
  
 <span data-ttu-id="a5bd4-1191">В изоляции моментальных снимков также применяется управление версиями строк, не использующее во время операций считывания разделяемых блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1191">Snapshot isolation also uses row versioning, which does not use shared locks during read operations.</span></span> <span data-ttu-id="a5bd4-1192">Перед запуском транзакций с изоляцией моментальных снимков параметр ALLOW_SNAPSHOT_ISOLATION должен быть установлен в ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1192">Before a transaction can run under snapshot isolation, the ALLOW_SNAPSHOT_ISOLATION database option must be set ON.</span></span>  
  
 <span data-ttu-id="a5bd4-1193">Применение этих уровней изоляции приводит к минимизации взаимоблокировок, возникающих между операциями считывания и записи.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1193">Implement these isolation levels to minimize deadlocks that can occur between read and write operations.</span></span>  
  
##### <a name="use-bound-connections"></a><span data-ttu-id="a5bd4-1194">Использование связанных соединений</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1194">Use Bound Connections</span></span>  

 <span data-ttu-id="a5bd4-1195">При использовании связанных соединений два или более соединения, открытые одним и тем же приложением, могут действовать совместно друг с другом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1195">Using bound connections, two or more connections opened by the same application can cooperate with each other.</span></span> <span data-ttu-id="a5bd4-1196">Любые блокировки, используемые вторичными соединениями, устанавливаются так, как если бы они запрашивались первичным соединением, и наоборот.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1196">Any locks acquired by the secondary connections are held as if they were acquired by the primary connection, and vice versa.</span></span> <span data-ttu-id="a5bd4-1197">Поэтому соединения не блокируют друг друга.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1197">Therefore they do not block each other.</span></span>  
  
### <a name="lock-partitioning"></a><span data-ttu-id="a5bd4-1198">Секционирование блокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1198">Lock Partitioning</span></span>  

 <span data-ttu-id="a5bd4-1199">В больших компьютерных системах блокировки часто запрашиваемых объектов могут стать узким местом производительности, так как запросы и освобождения блокировок являются ограниченными внутренними ресурсами.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1199">For large computer systems, locks on frequently referenced objects can become a performance bottleneck as acquiring and releasing locks place contention on internal locking resources.</span></span> <span data-ttu-id="a5bd4-1200">Секционирование блокировок повышает производительность блокировок, разбивая блокируемые ресурсы на несколько более мелких.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1200">Lock partitioning enhances locking performance by splitting a single lock resource into multiple lock resources.</span></span> <span data-ttu-id="a5bd4-1201">Эта особенность доступна только в системах, имеющих 16 и более процессоров, включается автоматически и не может быть отключена.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1201">This feature is only available for systems with 16 or more CPUs, and is automatically enabled and cannot be disabled.</span></span> <span data-ttu-id="a5bd4-1202">Секционироваться могут только блокировки объектов. Блокировки объектов, имеющие подтип, не секционируются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1202">Only object locks can be partitioned.Object locks that have a subtype are not partitioned.</span></span> <span data-ttu-id="a5bd4-1203">Дополнительные сведения см. в разделе [sys.dm_tran_locks (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1203">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
#### <a name="understanding-lock-partitioning"></a><span data-ttu-id="a5bd4-1204">Основные сведения о секционировании блокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1204">Understanding Lock Partitioning</span></span>  

 <span data-ttu-id="a5bd4-1205">Задачи, работающие с блокировками, производят доступ к нескольким общим ресурсам, два из которых оптимизированы для работы с секционированием блокировок:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1205">Locking tasks access several shared resources, two of which are optimized by lock partitioning:</span></span>  
  
-   <span data-ttu-id="a5bd4-1206">**Spinlock**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1206">**Spinlock**.</span></span> <span data-ttu-id="a5bd4-1207">Контролирует доступ к блокируемому ресурсу (например к строке или таблице).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1207">This controls access to a lock resource, such as a row or a table.</span></span>  
  
     <span data-ttu-id="a5bd4-1208">Без секционирования блокировок один элемент Spinlock управляет всеми запросами на блокировку к каждому блокируемому ресурсу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1208">Without lock partitioning, one spinlock manages all lock requests for a single lock resource.</span></span> <span data-ttu-id="a5bd4-1209">В системах с высокой интенсивностью могут возникнуть состязания, так как запросы на блокировку будут ожидать освобождения элемента Spinlock.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1209">On systems that experience a large volume of activity, contention can occur as lock requests wait for the spinlock to become available.</span></span> <span data-ttu-id="a5bd4-1210">В таких условиях запросы на блокировку могут стать узким местом и отрицательно повлиять на производительность.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1210">Under this situation, acquiring locks can become a bottleneck and can negatively impact performance.</span></span>  
  
     <span data-ttu-id="a5bd4-1211">Чтобы снизить состязание за блокируемый ресурс, секционирование разбивает один блокируемый ресурс на несколько, распределяя нагрузку между несколькими элементами.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1211">To reduce contention on a single lock resource, lock partitioning splits a single lock resource into multiple lock resources to distribute the load across multiple spinlocks.</span></span>  
  
-   <span data-ttu-id="a5bd4-1212">**Память.**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1212">**Memory**.</span></span> <span data-ttu-id="a5bd4-1213">Используется для хранения структур ресурсов блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1213">This is used to store the lock resource structures.</span></span>  
  
     <span data-ttu-id="a5bd4-1214">После запроса элемента Spinlock структуры блокировки хранятся в памяти, где к ним производится доступ и, возможно, изменение.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1214">Once the spinlock is acquired, lock structures are stored in memory and then accessed and possibly modified.</span></span> <span data-ttu-id="a5bd4-1215">Распределение доступа к блокировкам по нескольким ресурсам помогает избежать необходимости передачи блоков памяти между процессорами, что позволяет повысить производительность.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1215">Distributing lock access across multiple resources helps to eliminate the need to transfer memory blocks between CPUs, which will help to improve performance.</span></span>  
  
#### <a name="implementing-and-monitoring-lock-partitioning"></a><span data-ttu-id="a5bd4-1216">Реализация и отслеживание секционирования блокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1216">Implementing and Monitoring Lock Partitioning</span></span>  

 <span data-ttu-id="a5bd4-1217">Секционирование блокировок включается по умолчанию в системах, имеющих 16 и более процессоров.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1217">Lock partitioning is turned on by default for systems with 16 or more CPUs.</span></span> <span data-ttu-id="a5bd4-1218">Если секционирование блокировок разрешено, в журнал ошибок [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] записывается информационное сообщение об этом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1218">When lock partitioning is enabled, an informational message is recorded in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>  
  
 <span data-ttu-id="a5bd4-1219">При запросе блокировок для секционированного ресурса:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1219">When acquiring locks on a partitioned resource:</span></span>  
  
-   <span data-ttu-id="a5bd4-1220">Для одной секции запрашиваются только режимы блокировок NL, SCH-S, IS, IU и IX.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1220">Only NL, SCH-S, IS, IU, and IX lock modes are acquired on a single partition.</span></span>  
  
-   <span data-ttu-id="a5bd4-1221">Общая (S), монопольная (X) и другие блокировки в режимах, отличных от NL, SCH-S, IS, IU и IX, должны запрашиваться для всех секций, начиная с секции с идентификатором 0 и далее в порядке номеров идентификаторов секций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1221">Shared (S), exclusive (X), and other locks in modes other than NL, SCH-S, IS, IU, and IX must be acquired on all partitions starting with partition ID 0 and following in partition ID order.</span></span> <span data-ttu-id="a5bd4-1222">Эти блокировки на секционированном ресурсе будут использовать больше памяти, чем блокировки в том же режиме, запрошенные для несекционированного ресурса, поскольку каждая секция по сути, является отдельной блокировкой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1222">These locks on a partitioned resource will use more memory than locks in the same mode on a non-partitioned resource since each partition is effectively a separate lock.</span></span> <span data-ttu-id="a5bd4-1223">Расход памяти определяется имеющимся количеством секций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1223">The memory increase is determined by the number of partitions.</span></span> <span data-ttu-id="a5bd4-1224">Счетчики блокировок [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] в системном мониторе Windows показывают объем памяти, занятой секционированными и несекционированными блокировками.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1224">The [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] lock counters in the Windows Performance Monitor will display information about memory used by partitioned and non-partitioned locks.</span></span>  
  
 <span data-ttu-id="a5bd4-1225">В момент начала транзакции ей назначается секция.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1225">A transaction is assigned to a partition when the transaction starts.</span></span> <span data-ttu-id="a5bd4-1226">Для транзакций все запросы блокировок, которые могут быть секционированы, используют секцию, связанную с этой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1226">For the transaction, all lock requests that can be partitioned use the partition assigned to that transaction.</span></span> <span data-ttu-id="a5bd4-1227">По этому алгоритму доступ разных транзакций к ресурсам блокировок одного и того же объекта распределяется между различными секциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1227">By this method, access to lock resources of the same object by different transactions is distributed across different partitions.</span></span>  
  
 <span data-ttu-id="a5bd4-1228">Столбец resource_lock_partition в динамическом административном представлении sys.dm_tran_locks содержит идентификатор секции для блокировки секционированного ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1228">The resource_lock_partition column in the sys.dm_tran_locks Dynamic Management View provides the lock partition ID for a lock partitioned resource.</span></span> <span data-ttu-id="a5bd4-1229">Дополнительные сведения см. в разделе [sys.dm_tran_locks (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1229">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1230">В приложении [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] при возникновении события «Locks» в столбце BigintData1 содержатся идентификаторы секций для блокировок секционированных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1230">Under the Locks event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], the BigintData1 column provides the lock partition ID for a lock partitioned resource.</span></span>  
  
#### <a name="working-with-lock-partitioning"></a><span data-ttu-id="a5bd4-1231">Работа с секционированием блокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1231">Working with Lock Partitioning</span></span>  

 <span data-ttu-id="a5bd4-1232">Следующий пример кода иллюстрирует секционирование блокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1232">The following code examples illustrate lock partitioning.</span></span> <span data-ttu-id="a5bd4-1233">В примерах две транзакции выполняются в двух различных сеансах, показывая работу секционирования блокировок в компьютерной системе с 16 процессорами.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1233">In the examples, two transactions are executed in two different sessions in order to show lock partitioning behavior on a computer system with 16 CPUs.</span></span>  
  
 <span data-ttu-id="a5bd4-1234">Эти инструкции [!INCLUDE[tsql](../includes/tsql-md.md)] создают тестовые объекты, используемые в примерах ниже.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1234">These [!INCLUDE[tsql](../includes/tsql-md.md)] statements create test objects that are used in the examples that follow.</span></span>  
  
```sql  
-- Create a test table.  
CREATE TABLE TestTable  
    (col1        int);  
GO  
  
-- Create a clustered index on the table.  
CREATE CLUSTERED INDEX ci_TestTable   
    ON TestTable (col1);  
GO  
  
-- Populate the table.  
INSERT INTO TestTable VALUES (1);  
GO  
```  
  
##### <a name="example-a"></a><span data-ttu-id="a5bd4-1235">Пример A</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1235">Example A</span></span>  

 <span data-ttu-id="a5bd4-1236">Сеанс 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1236">Session 1:</span></span>  
  
 <span data-ttu-id="a5bd4-1237">В ходе транзакции выполняется инструкция `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1237">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="a5bd4-1238">Поскольку приведено указание блокировки `HOLDLOCK`, эта инструкция получит и сохранит блокировку с намерением совмещаемого доступа (IS) для таблицы (в данном примере блокировки строк и страниц не учитываются).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1238">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="a5bd4-1239">Блокировка IS будет получена только на секцию, назначенную для транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1239">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="a5bd4-1240">В этом примере предполагается, что блокировка IS получена для секции с идентификатором 7.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1240">For this example, it is assumed that the IS lock is acquired on partition ID 7.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="a5bd4-1241">Сеанс 2.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1241">Session 2:</span></span>  
  
 <span data-ttu-id="a5bd4-1242">Начинается транзакция, и запускаемая в этой транзакции инструкция `SELECT` запрашивает и сохраняет совмещаемую (S) блокировку таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1242">A transaction is started, and the `SELECT` statement running under this transaction will acquire and retain a shared (S) lock on the table.</span></span> <span data-ttu-id="a5bd4-1243">Блокировка S будет запрошена для всех секций, что приведет к появлению нескольких блокировок таблицы, по одной для каждой секции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1243">The S lock will be acquired on all partitions which results in multiple table locks, one for each partition.</span></span> <span data-ttu-id="a5bd4-1244">Например, в системе с 16 процессорами для секций с идентификаторами от 0 до 15 будет создано 16 блокировок типа S.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1244">For example, on a 16-cpu system, 16 S locks will be issued across lock partition IDs 0-15.</span></span> <span data-ttu-id="a5bd4-1245">Поскольку блокировка типа S совместима с блокировкой типа IS, удерживаемой для секции 7 в транзакции сеанса 1, блокировок между транзакциями не возникнет.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1245">Because the S lock is compatible with the IS lock being held on partition ID 7 by the transaction in session 1, there is no blocking between transactions.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCK, HOLDLOCK);  
```  
  
 <span data-ttu-id="a5bd4-1246">Сеанс 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1246">Session 1:</span></span>  
  
 <span data-ttu-id="a5bd4-1247">Следующая инструкция `SELECT` выполняется в транзакции, все еще активной в сеансе 1.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1247">The following `SELECT` statement is executed under the transaction that is still active under session 1.</span></span> <span data-ttu-id="a5bd4-1248">Поскольку указана подсказка таблицы для монопольной (X) блокировки, транзакция попытается получить блокировку Х для таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1248">Because of the exclusive (X) table lock hint, the transaction will attempt to acquire an X lock on the table.</span></span> <span data-ttu-id="a5bd4-1249">Однако блокировка S, удерживаемая транзакцией в сеансе 2, будет блокировать блокировку Х для секции с идентификатором 0.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1249">However, the S lock that is being held by the transaction in session 2 will block the X lock at partition ID 0.</span></span>  
  
```sql  
SELECT col1  
    FROM TestTable  
    WITH (TABLOCKX);  
```  
  
##### <a name="example-b"></a><span data-ttu-id="a5bd4-1250">Пример Б</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1250">Example B</span></span>  

 <span data-ttu-id="a5bd4-1251">Сеанс 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1251">Session 1:</span></span>  
  
 <span data-ttu-id="a5bd4-1252">В ходе транзакции выполняется инструкция `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1252">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="a5bd4-1253">Поскольку приведено указание блокировки `HOLDLOCK`, эта инструкция получит и сохранит блокировку с намерением совмещаемого доступа (IS) для таблицы (в данном примере блокировки строк и страниц не учитываются).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1253">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="a5bd4-1254">Блокировка IS будет получена только на секцию, назначенную для транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1254">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="a5bd4-1255">В данном примере предполагается, что блокировка IS получена для секции с идентификатором 6.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1255">For this example, it is assumed that the IS lock is acquired on partition ID 6.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="a5bd4-1256">Сеанс 2.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1256">Session 2:</span></span>  
  
 <span data-ttu-id="a5bd4-1257">В ходе транзакции выполняется инструкция `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1257">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="a5bd4-1258">Так как приведено указание блокировки `TABLOCKX`, транзакция попытается получить монопольную (Х) блокировку таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1258">Because of the `TABLOCKX` lock hint, the transaction tries to acquire an exclusive (X) lock on the table.</span></span> <span data-ttu-id="a5bd4-1259">Следует помнить, что блокировка Х может быть запрошена для всех секций, начиная с секции 0.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1259">Remember that the X lock must be acquired on all partitions starting with partition ID 0.</span></span> <span data-ttu-id="a5bd4-1260">Блокировка Х будет запрошена для всех секций с идентификаторами от 0 до 5, но она будет блокирована блокировкой IS, запрошенной для секции с идентификатором 6.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1260">The X lock will be acquired on all partitions IDs 0-5 but will be blocked by the IS lock that is acquired on partition ID 6.</span></span>  
  
 <span data-ttu-id="a5bd4-1261">В секциях с идентификаторами от 7 до 15 блокировка Х еще не достигнута, поэтому другие транзакции могут продолжать запрос блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1261">On partition IDs 7-15 that the X lock has not yet reached, other transactions can continue to acquire locks.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCKX, HOLDLOCK);  
```  
  
 <span data-ttu-id="a5bd4-1262">![Значок стрелки, используемый в ссылке "назад на начало](media/uparrow16x16.gif "Значок стрелки, используемый со ссылкой В начало") " [в этом пошаговом окне](#Top)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1262">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="row-versioning-based-isolation-levels-in-the-database-engine"></a><a name="Row_versioning"></a><span data-ttu-id="a5bd4-1263">Уровни изоляции на основе управления версиями строк в ядро СУБД</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1263">Row Versioning-based Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="a5bd4-1264">Начиная с SQL Server 2005, компонент Database Engine предлагает реализацию существующего уровня изоляции транзакции read committed, который обеспечивает моментальный снимок уровня инструкций, основанный на управлении версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1264">Starting with SQL Server 2005, the Database Engine offers an implementation of an existing transaction isolation level, read committed, that provides a statement level snapshot using row versioning.</span></span> <span data-ttu-id="a5bd4-1265">Компонент SQL Server Database Engine также предлагает уровень изоляции транзакции моментальных снимков, который обеспечивает моментальный снимок уровня транзакций, основанный на управлении версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1265">SQL Server Database Engine also offers a transaction isolation level, snapshot, that provides a transaction level snapshot also using row versioning.</span></span>  
  
 <span data-ttu-id="a5bd4-1266">Управление версиями строк — это стандартная структура в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], которая вызывает механизм копирования при записи, когда строка изменяется или удаляется.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1266">Row versioning is a general framework in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] that invokes a copy-on-write mechanism when a row is modified or deleted.</span></span> <span data-ttu-id="a5bd4-1267">Для этого требуется, чтобы во время выполнения транзакции предыдущая версия строки была доступна для транзакций, которым необходимо прежнее состояние, согласованное на уровне транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1267">This requires that while the transaction is running, the old version of the row must be available for transactions that require an earlier transactionally consistent state.</span></span> <span data-ttu-id="a5bd4-1268">Управление версиями строк используется для выполнения следующих действий:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1268">Row versioning is used to do the following:</span></span>  
  
-   <span data-ttu-id="a5bd4-1269">создания таблиц **inserted** и **deleted** в триггерах.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1269">Build the **inserted** and **deleted** tables in triggers.</span></span> <span data-ttu-id="a5bd4-1270">Предусмотрено управление версиями для всех строк, изменяемых триггером,</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1270">Any rows modified by the trigger are versioned.</span></span> <span data-ttu-id="a5bd4-1271">в том числе строк, измененных инструкцией, которая инициировала триггер, а также всех изменений данных, выполненных триггером;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1271">This includes the rows modified by the statement that launched the trigger, as well as any data modifications made by the trigger.</span></span>  
  
-   <span data-ttu-id="a5bd4-1272">Поддержка режима MARS.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1272">Support Multiple Active Result Sets (MARS).</span></span> <span data-ttu-id="a5bd4-1273">Если в ходе сеанса MARS выдается инструкция изменения данных (например, INSERT, UPDATE или DELETE) в момент, когда есть активный результирующий набор, выполняется управление версиями строк, которых коснулось изменение.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1273">If a MARS session issues a data modification statement (such as INSERT, UPDATE, or DELETE) at a time there is an active result set, the rows affected by the modification statement are versioned.</span></span>  
  
-   <span data-ttu-id="a5bd4-1274">поддержки операций с индексами, в которых задан параметр ONLINE;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1274">Support index operations that specify the ONLINE option.</span></span>  
  
-   <span data-ttu-id="a5bd4-1275">поддержки уровней изоляции транзакций на основе управления версиями;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1275">Support row versioning-based transaction isolation levels:</span></span>  
  
    -   <span data-ttu-id="a5bd4-1276">новой реализации уровня изоляции READ COMMITTED, который использует управление версиями строк для обеспечения совместимости считывания на уровне инструкций;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1276">A new implementation of read committed isolation level that uses row versioning to provide statement-level read consistency.</span></span>  
  
    -   <span data-ttu-id="a5bd4-1277">нового уровня изоляции и моментального снимка для обеспечения совместимости считывания на уровне транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1277">A new isolation level, snapshot, to provide transaction-level read consistency.</span></span>  
  
 <span data-ttu-id="a5bd4-1278">В базе данных `tempdb` должно быть достаточно места для хранения версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1278">The `tempdb` database must have enough space for the version store.</span></span> <span data-ttu-id="a5bd4-1279">Если база данных `tempdb` заполнена, операции обновления прекращают формирование версий и продолжаются до успешного выполнения, а операции считывания завершаются ошибкой, поскольку конкретной требуемой версии строки уже не существует.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1279">When `tempdb` is full, update operations will stop generating versions and continue to succeed, but read operations might fail because a particular row version that is needed no longer exists.</span></span> <span data-ttu-id="a5bd4-1280">Это касается работы триггеров, режима MARS и индексирования в сети.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1280">This affects operations like triggers, MARS, and online indexing.</span></span>  
  
 <span data-ttu-id="a5bd4-1281">Использование управления версиями для транзакций READ COMMITTED и моментальных снимков — это процесс, состоящий из двух шагов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1281">Using row versioning for read-committed and snapshot transactions is a two-step process:</span></span>  
  
1.  <span data-ttu-id="a5bd4-1282">Присвоение любому или обоим параметрам базы данных READ_COMMITTED_SNAPSHOT и ALLOW_SNAPSHOT_ISOLATION значения ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1282">Set either or both the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options ON.</span></span>  
  
2.  <span data-ttu-id="a5bd4-1283">Задание соответствующего уровня изоляции транзакций в приложении:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1283">Set the appropriate transaction isolation level in an application:</span></span>  
  
    -   <span data-ttu-id="a5bd4-1284">если параметр базы данных READ_COMMITTED_SNAPSHOT имеет значение ON, транзакции, устанавливающие уровень изоляции READ COMMITTED, используют управление версиями строк;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1284">When the READ_COMMITTED_SNAPSHOT database option is ON, transactions setting the read committed isolation level use row versioning.</span></span>  
  
    -   <span data-ttu-id="a5bd4-1285">если параметр базы данных ALLOW_SNAPSHOT_ISOLATION имеет значение ON, транзакции могут устанавливать уровень изоляции моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1285">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, transactions can set the snapshot isolation level.</span></span>  
  
 <span data-ttu-id="a5bd4-1286">Если один из параметров базы данных READ_COMMITTED_SNAPSHOT и ALLOW_SNAPSHOT_ISOLATION имеет значение ON, компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] присваивает порядковый номер транзакции (XSN) каждой транзакции, обрабатывающей данные с помощью управления версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1286">When either READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database option is set ON, the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] assigns a transaction sequence number (XSN) to each transaction that manipulates data using row versioning.</span></span> <span data-ttu-id="a5bd4-1287">Транзакции начинаются после выполнения инструкции BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1287">Transactions start at the time a BEGIN TRANSACTION statement is executed.</span></span> <span data-ttu-id="a5bd4-1288">Тем не менее порядковый номер транзакции начинается с первой операции считывания или записи после инструкции BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1288">However, the transaction sequence number starts with the first read or write operation after the BEGIN TRANSACTION statement.</span></span> <span data-ttu-id="a5bd4-1289">Порядковый номер транзакции увеличивается с шагом на единицу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1289">The transaction sequence number is incremented by one each time it is assigned.</span></span>  
  
 <span data-ttu-id="a5bd4-1290">Если один из параметров базы данных READ_COMMITTED_SNAPSHOT и ALLOW_SNAPSHOT_ISOLATION имеет значение ON, логические копии (версии) сохраняются для всех изменений данных, выполненных в базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1290">When either the READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database options are ON, logical copies (versions) are maintained for all data modifications performed in the database.</span></span> <span data-ttu-id="a5bd4-1291">При каждом изменении строки конкретной транзакцией экземпляр компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] сохраняет версию ранее зафиксированного образа строки в `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1291">Every time a row is modified by a specific transaction, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stores a version of the previously committed image of the row in `tempdb`.</span></span> <span data-ttu-id="a5bd4-1292">Каждой версии присваивается порядковый номер транзакции, выполнившей изменение.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1292">Each version is marked with the transaction sequence number of the transaction that made the change.</span></span> <span data-ttu-id="a5bd4-1293">Версии измененных строк сцепляются с помощью списка ссылок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1293">The versions of modified rows are chained using a link list.</span></span> <span data-ttu-id="a5bd4-1294">Самое последнее значение строки всегда хранится в текущей базе данных с указанием на цепочку версий, хранящихся в базе данных `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1294">The newest row value is always stored in the current database and chained to the versioned rows stored in `tempdb`.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1295">Для модификации типов данных LOB только измененный фрагмент копируется в блок хранения версий базы данных `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1295">For modification of large objects (LOBs), only the changed fragment is copied to the version store in `tempdb`.</span></span>  
  
 <span data-ttu-id="a5bd4-1296">Версии строк хранятся в соответствии с требованиями транзакций, выполняющихся на уровнях изоляции на основе управления версиями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1296">Row versions are held long enough to satisfy the requirements of transactions running under row versioning-based isolation levels.</span></span> <span data-ttu-id="a5bd4-1297">Компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] отслеживает наименьший применимый порядковый номер транзакции и периодически удаляет все версии строк, помеченных порядковыми номерами меньше, чем наименьший применимый порядковый номер транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1297">The [!INCLUDE[ssDE](../includes/ssde-md.md)] tracks the earliest useful transaction sequence number and periodically deletes all row versions stamped with transaction sequence numbers that are lower than the earliest useful sequence number.</span></span>  
  
 <span data-ttu-id="a5bd4-1298">Если оба параметра базы данных имеют значение OFF, выполняется управление версиями только строк, измененных триггерами или сеансами MARS либо считанных операциями над индексом ONLINE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1298">When both database options are set to OFF, only rows modified by triggers or MARS sessions, or read by ONLINE index operations, are versioned.</span></span> <span data-ttu-id="a5bd4-1299">Если эти версии строк больше не нужны, они удаляются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1299">Those row versions are released when no longer needed.</span></span> <span data-ttu-id="a5bd4-1300">Периодически выполняется фоновый поток удаления устаревших версий строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1300">A background thread periodically executes to remove stale row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1301">Для краткосрочных транзакций версия измененной строки может помещаться в буферный пул без записи в дисковые файлы базы данных `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1301">For short-running transactions, a version of a modified row may get cached in the buffer pool without getting written into the disk files of the `tempdb` database.</span></span> <span data-ttu-id="a5bd4-1302">Если версии строки требуются в течение небольшого промежутка времени, они просто удаляются из буферный пул, тем самым не нагружая дополнительно подсистему ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1302">If the need for the versioned row is short-lived, it will simply get dropped from the buffer pool and may not necessarily incur I/O overhead.</span></span>  
  
### <a name="behavior-when-reading-data"></a><span data-ttu-id="a5bd4-1303">Режим считывания данных</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1303">Behavior When Reading Data</span></span>  

 <span data-ttu-id="a5bd4-1304">Если транзакции выполняются над считываемыми данными уровня изоляции на основе управления версиями, операции считывания не запрашивают общие блокировки считываемых данных и, как следствие, не блокируют транзакции, изменяющие данные.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1304">When transactions running under row versioning-based isolation read data, the read operations do not acquire shared (S) locks on the data being read, and therefore do not block transactions that are modifying data.</span></span> <span data-ttu-id="a5bd4-1305">Кроме того, затраты на блокировку ресурсов сокращаются до минимума, поскольку уменьшается число запрашиваемых блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1305">Also, the overhead of locking resources is minimized as the number of locks acquired is reduced.</span></span> <span data-ttu-id="a5bd4-1306">Изоляция READ COMMITTED, использующая управление версиями строк, и изоляция моментальных снимков служит для обеспечения совместимости операций считывания данных, управляемых по версии, на уровне инструкций и транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1306">Read committed isolation using row versioning and snapshot isolation are designed to provide statement-level or transaction-level read consistencies of versioned data.</span></span>  
  
 <span data-ttu-id="a5bd4-1307">Для всех запросов, включая транзакции, выполняемые с уровнем изоляции на основе управления версиями строк, требуется Sch-S (стабильность схемы) во время компиляции и выполнения блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1307">All queries, including transactions running under row versioning-based isolation levels, acquire Sch-S (schema stability) locks during compilation and execution.</span></span> <span data-ttu-id="a5bd4-1308">Поэтому запросы блокируются, если параллельная транзакция удерживает в таблице блокировку Sch-M (изменение схемы).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1308">Because of this, queries are blocked when a concurrent transaction holds a Sch-M (schema modification) lock on the table.</span></span> <span data-ttu-id="a5bd4-1309">Например, операция языка DDL получает блокировку Sch-M до того, как она изменяет данные схемы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1309">For example, a data definition language (DDL) operation acquires a Sch-M lock before it modifies the schema information of the table.</span></span> <span data-ttu-id="a5bd4-1310">Транзакции с запросами, включая те, которые выполняются с уровнем изоляции на основе управления версиями строк, блокируются при попытке получить блокировку Sch-S.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1310">Query transactions, including those running under a row versioning-based isolation level, are blocked when attempting to acquire a Sch-S lock.</span></span> <span data-ttu-id="a5bd4-1311">И наоборот, запрос, удерживающий блокировку Sch-S, блокирует параллельную транзакцию, которая пытается получить блокировку Sch-M.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1311">Conversely, a query holding a Sch-S lock blocks a concurrent transaction that attempts to acquire a Sch-M lock.</span></span>  
  
 <span data-ttu-id="a5bd4-1312">Когда запускается транзакция, использующая уровень изоляции моментального снимка, экземпляр компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] регистрирует все активные в данный момент транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1312">When a transaction using the snapshot isolation level starts, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] records all of the currently active transactions.</span></span> <span data-ttu-id="a5bd4-1313">Когда транзакция моментальных снимков считывает строку, имеющую цепочку версий, компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] следует по цепочке и получает строку, если порядковый номер транзакции:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1313">When the snapshot transaction reads a row that has a version chain, the [!INCLUDE[ssDE](../includes/ssde-md.md)] follows the chain and retrieves the row where the transaction sequence number is:</span></span>  
  
-   <span data-ttu-id="a5bd4-1314">равен ближайшему порядковому номеру, который меньше номера транзакции моментальных снимков, считывающей строку;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1314">Closest to but lower than the sequence number of the snapshot transaction reading the row.</span></span>  
  
-   <span data-ttu-id="a5bd4-1315">не находится в списке транзакций, активных в момент начала транзакции моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1315">Not in the list of the transactions active when the snapshot transaction started.</span></span>  
  
 <span data-ttu-id="a5bd4-1316">Операции считывания, выполняемые транзакцией моментальных снимков, получают последнюю версию каждой строки, зафиксированной в момент начала транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1316">Read operations performed by a snapshot transaction retrieve the last version of each row that had been committed at the time the snapshot transaction started.</span></span> <span data-ttu-id="a5bd4-1317">Тем самым предоставляется согласованный на уровне транзакций моментальный снимок данных на момент начала транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1317">This provides a transactionally consistent snapshot of the data as it existed at the start of the transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-1318">Транзакции READ COMMITTED, использующие управление версиями строк, выполняются практически также.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1318">Read-committed transactions using row versioning operate in much the same way.</span></span> <span data-ttu-id="a5bd4-1319">Разница заключается в том, что транзакция READ COMMITTED не использует собственный порядковый номер транзакции при выборе версий строки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1319">The difference is that the read-committed transaction does not use its own transaction sequence number when choosing row versions.</span></span> <span data-ttu-id="a5bd4-1320">При каждом запуске инструкции транзакции READ COMMITTED считывает последний порядковый номер транзакции, выданный этому экземпляру компонента [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1320">Each time a statement is started, the read-committed transaction reads the latest transaction sequence number issued for that instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="a5bd4-1321">Этот номер используется для выбора правильных версий строки в данной инструкции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1321">This is the transaction sequence number used to select the correct row versions for that statement.</span></span> <span data-ttu-id="a5bd4-1322">Такой метод дает возможность транзакциям READ COMMITTED видеть моментальный снимок данных на момент начала каждой инструкции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1322">This allows read-committed transactions to see a snapshot of the data as it exists at the start of each statement.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1323">Даже если транзакция с зафиксированным чтением с помощью управления версиями строк обеспечивает транзакционно согласованное представление данных на уровне инструкций, версии строк, которые она создает или к которым получает доступ, сохраняются до ее завершения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1323">Even though read-committed transactions using row versioning provides a transactionally consistent view of the data at a statement level, row versions generated or accessed by this type of transaction are maintained until the transaction completes.</span></span>  
  
### <a name="behavior-when-modifying-data"></a><span data-ttu-id="a5bd4-1324">Режим изменения данных</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1324">Behavior When Modifying Data</span></span>  

 <span data-ttu-id="a5bd4-1325">В транзакции READ COMMITTED, использующей управление версиями строк, выбор строк для обновления выполняется с помощью просматривания блокировок в случае блокировки обновлений для строки данных по мере считывания значений данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1325">In a read-committed transaction using row versioning, the selection of rows to update is done using a blocking scan where an update (U) lock is taken on the data row as data values are read.</span></span> <span data-ttu-id="a5bd4-1326">Это аналогично транзакции READ COMMITTED без использования управления версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1326">This is the same as a read-committed transaction that does not use row versioning.</span></span> <span data-ttu-id="a5bd4-1327">Если строка данных не удовлетворяет условию обновления, блокировка обновления по этой строке отменяется, и блокируется и просматривается следующая строка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1327">If the data row does not meet the update criteria, the update lock is released on that row and the next row is locked and scanned.</span></span>  
  
 <span data-ttu-id="a5bd4-1328">Транзакции, которые выполнялись в рамках изоляции моментальных снимков, применяют оптимистичный подход к изменению данных, запрашивая блокировки данных перед выполнением изменений только, чтобы применить ограничения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1328">Transactions running under snapshot isolation take an optimistic approach to data modification by acquiring locks on data before performing the modification only to enforce constraints.</span></span> <span data-ttu-id="a5bd4-1329">В противном случае блокировка данных не запрашивается, пока не потребуется изменить данные.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1329">Otherwise, locks are not acquired on data until the data is to be modified.</span></span> <span data-ttu-id="a5bd4-1330">Если строка данных удовлетворяет условию обновления, транзакция моментального снимка удостоверяется, что строка данных не изменялась параллельной транзакцией, зафиксированной после начала транзакции моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1330">When a data row meets the update criteria, the snapshot transaction verifies that the data row has not been modified by a concurrent transaction that committed after the snapshot transaction began.</span></span> <span data-ttu-id="a5bd4-1331">Если строка данных изменялась вне транзакции моментального снимка, возникает конфликт обновления, и выполнение транзакции моментального снимка прерывается.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1331">If the data row has been modified outside of the snapshot transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span> <span data-ttu-id="a5bd4-1332">Конфликт обновления обрабатывается компонентом [!INCLUDE[ssDE](../includes/ssde-md.md)]. Отключение функции обнаружения конфликтов обновления невозможно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1332">The update conflict is handled by the [!INCLUDE[ssDE](../includes/ssde-md.md)] and there is no way to disable the update conflict detection.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1333">Операции обновления, выполняющиеся в рамках изоляции моментальных снимков, внутренне запускаются в рамках изоляции READ COMMITTED, если транзакция моментального снимка обращается к какому-либо из следующих объектов:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1333">Update operations running under snapshot isolation internally execute under read committed isolation when the snapshot transaction accesses any of the following:</span></span>  
>   
>  <span data-ttu-id="a5bd4-1334">к таблице с ограничением внешнего ключа;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1334">A table with a FOREIGN KEY constraint.</span></span>  
>   
>  <span data-ttu-id="a5bd4-1335">к таблице, на которую ссылается ограничение внешнего ключа другой таблицы;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1335">A table that is referenced in the FOREIGN KEY constraint of another table.</span></span>  
>   
>  <span data-ttu-id="a5bd4-1336">индексированному представлению, ссылающемуся на несколько таблиц.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1336">An indexed view referencing more than one table.</span></span>  
>   
>  <span data-ttu-id="a5bd4-1337">Тем не менее даже в этом случае операция обновления будет удостоверяться, что данные не изменялись другой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1337">However, even under these conditions the update operation will continue to verify that the data has not been modified by another transaction.</span></span> <span data-ttu-id="a5bd4-1338">Если данные изменялись другой транзакцией, транзакция моментального снимка обнаруживает конфликт обновления и прерывается.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1338">If data has been modified by another transaction, the snapshot transaction encounters an update conflict and is terminated.</span></span>  
  
### <a name="behavior-in-summary"></a><span data-ttu-id="a5bd4-1339">Сводка по режимам работы</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1339">Behavior in Summary</span></span>  

 <span data-ttu-id="a5bd4-1340">В приведенной ниже таблице перечисляются различия между изоляцией моментальных снимков и изоляцией READ COMMITTED при использовании управления версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1340">The following table summarizes the differences between snapshot isolation and read committed isolation using row versioning.</span></span>  
  
|<span data-ttu-id="a5bd4-1341">Свойство</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1341">Property</span></span>|<span data-ttu-id="a5bd4-1342">Уровень изоляции зафиксированного чтения, использующий управление версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1342">Read-committed isolation level using row versioning</span></span>|<span data-ttu-id="a5bd4-1343">Уровень изоляции моментальных снимков</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1343">Snapshot isolation level</span></span>|  
|--------------|----------------------------------------------------------|------------------------------|  
|<span data-ttu-id="a5bd4-1344">Параметр базы данных, который должен иметь значение ON, чтобы обеспечить требуемую поддержку.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1344">The database option that must be set to ON to enable the required support.</span></span>|<span data-ttu-id="a5bd4-1345">READ_COMMITTED_SNAPSHOT</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1345">READ_COMMITTED_SNAPSHOT</span></span>|<span data-ttu-id="a5bd4-1346">ALLOW_SNAPSHOT_ISOLATION</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1346">ALLOW_SNAPSHOT_ISOLATION</span></span>|  
|<span data-ttu-id="a5bd4-1347">Способ запроса в сеансе конкретного типа управления версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1347">How a session requests the specific type of row versioning.</span></span>|<span data-ttu-id="a5bd4-1348">Используйте уровень изоляции READ COMMITTED по умолчанию или выполните инструкцию SET TRANSACTION ISOLATION LEVEL для задания уровня изоляции READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1348">Use the default read-committed isolation level, or run the SET TRANSACTION ISOLATION LEVEL statement to specify the READ COMMITTED isolation level.</span></span> <span data-ttu-id="a5bd4-1349">Это можно делать после запуска транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1349">This can be done after the transaction starts.</span></span>|<span data-ttu-id="a5bd4-1350">Требует выполнения инструкции SET TRANSACTION ISOLATION LEVEL для задания уровня изоляции SNAPSHOT до запуска транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1350">Requires the execution of SET TRANSACTION ISOLATION LEVEL to specify the SNAPSHOT isolation level before the start of the transaction.</span></span>|  
|<span data-ttu-id="a5bd4-1351">Версия данных, считанных инструкциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1351">The version of data read by statements.</span></span>|<span data-ttu-id="a5bd4-1352">Все данные, зафиксированные до начала каждой инструкции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1352">All data that was committed before the start of each statement.</span></span>|<span data-ttu-id="a5bd4-1353">Все данные, зафиксированные до начала каждой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1353">All data that was committed before the start of each transaction.</span></span>|  
|<span data-ttu-id="a5bd4-1354">Способ обработки обновлений.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1354">How updates are handled.</span></span>|<span data-ttu-id="a5bd4-1355">Восстановление из версии строки к фактическим строкам для выбора обновляемых данных и использование блокировок обновления по выбранным строкам данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1355">Reverts from row versions to actual data to select rows to update and uses update locks on the data rows selected.</span></span> <span data-ttu-id="a5bd4-1356">Запрос монопольных блокировок по строкам изменяемых фактических данных</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1356">Acquires exclusive locks on actual data rows to be modified.</span></span> <span data-ttu-id="a5bd4-1357">без обнаружения конфликтов обновления.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1357">No update conflict detection.</span></span>|<span data-ttu-id="a5bd4-1358">Использование версий строки для выбора обновляемых строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1358">Uses row versions to select rows to update.</span></span> <span data-ttu-id="a5bd4-1359">Попытка запроса монопольной блокировки изменяемой строки фактических данных; если данные изменялись другой транзакцией, возникает конфликт обновления и выполнение транзакции моментального снимка прерывается.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1359">Tries to acquire an exclusive lock on the actual data row to be modified, and if the data has been modified by another transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span>|  
|<span data-ttu-id="a5bd4-1360">Обнаружение конфликтов обновления.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1360">Update conflict detection.</span></span>|<span data-ttu-id="a5bd4-1361">Нет.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1361">None.</span></span>|<span data-ttu-id="a5bd4-1362">Встроенная поддержка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1362">Integrated support.</span></span> <span data-ttu-id="a5bd4-1363">Ее нельзя отключить.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1363">Cannot be disabled.</span></span>|  
  
### <a name="row-versioning-resource-usage"></a><span data-ttu-id="a5bd4-1364">Использование ресурсов при управлении версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1364">Row Versioning Resource Usage</span></span>  

 <span data-ttu-id="a5bd4-1365">Платформа управления версиями строк поддерживает следующие функции, доступные в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1365">The row versioning framework supports the following features available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:</span></span>  
  
-   <span data-ttu-id="a5bd4-1366">Триггеры</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1366">Triggers</span></span>  
  
-   <span data-ttu-id="a5bd4-1367">Режим MARS</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1367">Multiple Active Results Sets (MARS)</span></span>  
  
-   <span data-ttu-id="a5bd4-1368">Индексирование в сети</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1368">Online indexing</span></span>  
  
 <span data-ttu-id="a5bd4-1369">Платформа управления версиями строк также поддерживает следующие уровни изоляции транзакций на основе версий строк, которые не включены по умолчанию:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1369">The row versioning framework also supports the following row versioning-based transaction isolation levels, which by default are not enabled:</span></span>  
  
-   <span data-ttu-id="a5bd4-1370">Если параметр базы данных READ_COMMITTED_SNAPSHOT имеет значение ON, транзакции READ_COMMITTED обеспечивают согласованность чтения на уровне инструкций с помощью управления версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1370">When the READ_COMMITTED_SNAPSHOT database option is ON, READ_COMMITTED transactions provide statement-level read consistency using row versioning.</span></span>  
  
-   <span data-ttu-id="a5bd4-1371">Если параметр базы данных ALLOW_SNAPSHOT_ISOLATION имеет значение ON, транзакции SNAPSHOT обеспечивают согласованность чтения на уровне транзакций с помощью управления версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1371">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, SNAPSHOT transactions provide transaction-level read consistency using row versioning.</span></span>  
  
 <span data-ttu-id="a5bd4-1372">Уровни изоляции на основе управления версиями строк позволяют уменьшить число блокировок, устанавливаемых в ходе транзакции, устраняя необходимость использования разделяемых блокировок при операциях чтения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1372">Row versioning-based isolation levels reduce the number of locks acquired by transaction by eliminating the use of shared locks on read operations.</span></span> <span data-ttu-id="a5bd4-1373">Это увеличивает производительность системы путем сокращения объема ресурсов, используемых для управления блокировками.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1373">This increases system performance by reducing the resources used to manage locks.</span></span> <span data-ttu-id="a5bd4-1374">Производительность также увеличивается снижением количества блокировок транзакции со стороны других транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1374">Performance is also increased by reducing the number of times a transaction is blocked by locks acquired by other transactions.</span></span>  
  
 <span data-ttu-id="a5bd4-1375">Уровни изоляции на основе управления версиями строк увеличивают ресурсы, требуемые для изменения данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1375">Row versioning-based isolation levels increase the resources needed by data modifications.</span></span> <span data-ttu-id="a5bd4-1376">Включение этих параметров приводит к включению управления версиями для всех изменений базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1376">Enabling these options causes all data modifications for the database to be versioned.</span></span> <span data-ttu-id="a5bd4-1377">Копия данных перед изменением сохраняется в базе данных tempdb даже в том случае, когда не имеется активных транзакций, использующих изоляцию на основе управления версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1377">A copy of the data before modification is stored in tempdb even when there are no active transactions using row versioning-based isolation.</span></span> <span data-ttu-id="a5bd4-1378">Данные после изменения содержат указатель на версии данных, хранящиеся в базе tempdb.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1378">The data after modification includes a pointer to the versioned data stored in tempdb.</span></span> <span data-ttu-id="a5bd4-1379">Для больших объектов в базу данных tempdb копируется только часть измененного объекта.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1379">For large objects, only part of the object that changed is copied to tempdb.</span></span>  
  
#### <a name="space-used-in-tempdb"></a><span data-ttu-id="a5bd4-1380">Пространство, используемое в базе данных tempdb</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1380">Space Used in tempdb</span></span>  

 <span data-ttu-id="a5bd4-1381">Для каждого экземпляра компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] в базе данных tempdb должно быть достаточно места, чтобы хранить версии строк, формируемые для каждой базы данных этого экземпляра.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1381">For each instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], tempdb must have enough space to hold the row versions generated for every database in the instance.</span></span> <span data-ttu-id="a5bd4-1382">Администратор баз данных должен обеспечить достаточно места в базе данных tempdb для поддержки хранилища версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1382">The database administrator must ensure that tempdb has ample space to support the version store.</span></span> <span data-ttu-id="a5bd4-1383">В базе данных tempdb имеются два хранилища версий:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1383">There are two version stores in tempdb:</span></span>  
  
-   <span data-ttu-id="a5bd4-1384">Хранилище версий построения индекса в сети используется для построения индексов в сети во всех базах данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1384">The online index build version store is used for online index builds in all databases.</span></span>  
  
-   <span data-ttu-id="a5bd4-1385">Стандартное хранилище версий используется для всех прочих операций изменения данных во всех базах.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1385">The common version store is used for all other data modification operations in all databases.</span></span>  
  
 <span data-ttu-id="a5bd4-1386">Версии строк должны храниться в течение всего времени до тех пор, пока активной транзакции требуется доступ к ним.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1386">Row versions must be stored for as long as an active transaction needs to access it.</span></span> <span data-ttu-id="a5bd4-1387">Каждую минуту фоновый поток удаляет версии строк, которые больше не требуются, и освобождает занимаемое версиями место в базе данных tempdb.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1387">Once every minute, a background thread removes row versions that are no longer needed and frees up the version space in tempdb.</span></span> <span data-ttu-id="a5bd4-1388">Транзакция с продолжительным временем выполнения блокирует освобождение места в хранилище версий, если для нее выполняется любое из следующих условий:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1388">A long-running transaction prevents space in the version store from being released if it meets any of the following conditions:</span></span>  
  
-   <span data-ttu-id="a5bd4-1389">В транзакции используется изоляция на основе управления версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1389">It uses row versioning-based isolation.</span></span>  
  
-   <span data-ttu-id="a5bd4-1390">Используются триггеры, режим MARS или операции построения индекса в сети.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1390">It uses triggers, MARS, or online index build operations.</span></span>  
  
-   <span data-ttu-id="a5bd4-1391">Транзакция формирует версии строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1391">It generates row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1392">Когда внутри транзакции запускается триггер, версии строк, создаваемые триггером, сохраняются до конца транзакции, даже если после завершения триггера версии строк больше не требуются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1392">When a trigger is invoked inside a transaction, the row versions created by the trigger are maintained until the end of the transaction, even though the row versions are no longer needed after the trigger completes.</span></span> <span data-ttu-id="a5bd4-1393">Это применимо также для транзакций с чтением только зафиксированных данных, использующих управление версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1393">This also applies to read-committed transactions that use row versioning.</span></span> <span data-ttu-id="a5bd4-1394">Для этого типа транзакций согласованное на уровне транзакций представление базы данных необходимо только для каждой инструкции транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1394">With this type of transaction, a transactionally consistent view of the database is needed only for each statement in the transaction.</span></span> <span data-ttu-id="a5bd4-1395">Это означает, что версии строк, созданные для инструкции транзакции, больше требуются после завершения инструкции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1395">This means that the row versions created for a statement in the transaction are no longer needed after the statement completes.</span></span> <span data-ttu-id="a5bd4-1396">Однако версии строк, созданные каждой инструкцией транзакции, сохраняются до завершения инструкции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1396">However, row versions created by each statement in the transaction are maintained until the transaction completes.</span></span>  
  
 <span data-ttu-id="a5bd4-1397">Если в базе данных tempdb не хватает места, компонент [!INCLUDE[ssDE](../includes/ssde-md.md)] выполняет принудительное сжатие хранилища версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1397">When tempdb runs out of space, the [!INCLUDE[ssDE](../includes/ssde-md.md)] forces the version stores to shrink.</span></span> <span data-ttu-id="a5bd4-1398">В процессе сжатия наиболее длительные запущенные транзакции, в которых еще не сформированы версии строк, помечаются как жертвы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1398">During the shrink process, the longest running transactions that have not yet generated row versions are marked as victims.</span></span> <span data-ttu-id="a5bd4-1399">Для каждой транзакции-жертвы в журнале ошибок формируется сообщение 3967.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1399">A message 3967 is generated in the error log for each victim transaction.</span></span> <span data-ttu-id="a5bd4-1400">Если транзакция помечена как жертва, для нее отключается возможность считывания версий строк в хранилище версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1400">If a transaction is marked as a victim, it can no longer read the row versions in the version store.</span></span> <span data-ttu-id="a5bd4-1401">При попытке считывания транзакцией версий строк формируется сообщение 3966 и выполняется откат транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1401">When it attempts to read row versions, message 3966 is generated and the transaction is rolled back.</span></span> <span data-ttu-id="a5bd4-1402">В случае успешного сжатия в базе данных tempdb появляется доступное пространство.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1402">If the shrinking process succeeds, space becomes available in tempdb.</span></span> <span data-ttu-id="a5bd4-1403">В противном случае место в базе данных tempdb заканчивается, и происходит следующее:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1403">Otherwise, tempdb runs out of space and the following occurs:</span></span>  
  
-   <span data-ttu-id="a5bd4-1404">Выполнение операций записи продолжается, но версии не формируются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1404">Write operations continue to execute but do not generate versions.</span></span> <span data-ttu-id="a5bd4-1405">В журнале ошибок отображается информационное сообщение (3959), но на транзакцию, записывающую данные, это не влияет.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1405">An information message (3959) appears in the error log, but the transaction that writes data is not affected.</span></span>  
  
-   <span data-ttu-id="a5bd4-1406">Транзакции, пытающиеся получить доступ к версиям строк, которые не были сформированы из-за полного отката базы данных tempdb, завершаются с ошибкой 3958.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1406">Transactions that attempt to access row versions that were not generated because of a tempdb full rollback terminate with an error 3958.</span></span>  
  
#### <a name="space-used-in-data-rows"></a><span data-ttu-id="a5bd4-1407">Пространство, используемое в строках данных</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1407">Space Used in Data Rows</span></span>  

 <span data-ttu-id="a5bd4-1408">Для каждой строки базы данных доступно до 14 байт в конце строки для хранения сведений об управлении версиями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1408">Each database row may use up to 14 bytes at the end of the row for row versioning information.</span></span> <span data-ttu-id="a5bd4-1409">Сведения для управления версиями строк содержат последовательный номер транзакции, зафиксировавшей версию, а также указатель на строку этой версии.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1409">The row versioning information contains the transaction sequence number of the transaction that committed the version and the pointer to the versioned row.</span></span> <span data-ttu-id="a5bd4-1410">Эти 14 байт добавляются при первом изменении строки либо при вставке новой строки, если выполняется любое из следующих условий:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1410">These 14 bytes are added the first time the row is modified, or when a new row is inserted, under any of these conditions:</span></span>  
  
-   <span data-ttu-id="a5bd4-1411">Параметры READ_COMMITTED_SNAPSHOT или ALLOW_SNAPSHOT_ISOLATION установлены в ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1411">READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION options are ON.</span></span>  
  
-   <span data-ttu-id="a5bd4-1412">В таблице имеется триггер.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1412">The table has a trigger.</span></span>  
  
-   <span data-ttu-id="a5bd4-1413">Используется режим MARS.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1413">Multiple Active Results Sets (MARS) is being used.</span></span>  
  
-   <span data-ttu-id="a5bd4-1414">В данный момент в таблице выполняются фоновые операции построения индекса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1414">Online index build operations are currently running on the table.</span></span>  
  
 <span data-ttu-id="a5bd4-1415">Данные 14 байт удаляются из строки базы данных при первом изменении строки, если выполняется каждое из следующих условий:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1415">These 14 bytes are removed from the database row the first time the row is modified under all of these conditions:</span></span>  
  
-   <span data-ttu-id="a5bd4-1416">Параметры READ_COMMITTED_SNAPSHOT и ALLOW_SNAPSHOT_ISOLATION установлены в OFF.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1416">READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION options are OFF.</span></span>  
  
-   <span data-ttu-id="a5bd4-1417">В таблице больше не существует триггера.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1417">The trigger no longer exists on the table.</span></span>  
  
-   <span data-ttu-id="a5bd4-1418">Режим MARS больше не используется.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1418">MARS is not being used.</span></span>  
  
-   <span data-ttu-id="a5bd4-1419">Фоновые операции построения индекса в данный момент не выполняются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1419">Online index build operations are not currently running.</span></span>  
  
 <span data-ttu-id="a5bd4-1420">Если используются любые функции управления версиями строк, необходимо выделить достаточно места на диске: по 14 байт на строку базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1420">If you use any of the row versioning features, you might need to allocate additional disk space for the database to accommodate the 14 bytes per database row.</span></span> <span data-ttu-id="a5bd4-1421">Добавление сведений для управления версиями строк может привести к разбиению страниц индекса или выделению новой страницы данных, если в текущей странице места недостаточно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1421">Adding the row versioning information can cause index page splits or the allocation of a new data page if there is not enough space available on the current page.</span></span> <span data-ttu-id="a5bd4-1422">Например, если средняя длина строки составляет 100 байт, то дополнительные 14 байт вызовут увеличение существующей таблицы на 14 процентов (или менее).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1422">For example, if the average row length is 100 bytes, the additional 14 bytes cause an existing table to grow up to 14 percent.</span></span>  
  
 <span data-ttu-id="a5bd4-1423">Уменьшение [коэффициента заполнения](../relational-databases/indexes/specify-fill-factor-for-an-index.md) может исключить фрагментацию страниц индекса или снизить степень фрагментации.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1423">Decreasing the [fill factor](../relational-databases/indexes/specify-fill-factor-for-an-index.md) might help to prevent or decrease fragmentation of index pages.</span></span> <span data-ttu-id="a5bd4-1424">Чтобы просмотреть сведения о фрагментации для данных и индексов таблицы или представления, можно использовать [инструкцию DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1424">To view fragmentation information for the data and indexes of a table or view, you can use [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span></span>  
  
#### <a name="space-used-in-large-objects"></a><span data-ttu-id="a5bd4-1425">Пространство, используемое большими объектами</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1425">Space Used in Large Objects</span></span>  

 <span data-ttu-id="a5bd4-1426">Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] поддерживает шесть типов данных, которые могут содержать строки длиной до 2 гигабайт (ГБ): `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text` и `image`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1426">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] supports six data types that can hold large strings up to 2 gigabytes (GB) in length: `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text`, and `image`.</span></span> <span data-ttu-id="a5bd4-1427">Большие строки, сохраненные с помощью этих типов данных, хранятся в рядах фрагментов данных, связанных со строкой данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1427">Large strings stored using these data types are stored in a series of data fragments that are linked to the data row.</span></span> <span data-ttu-id="a5bd4-1428">Сведения о версиях строк хранятся в каждом из фрагментов, используемых для хранения этих больших строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1428">Row versioning information is stored in each fragment used to store these large strings.</span></span> <span data-ttu-id="a5bd4-1429">Фрагменты данных представляют собой коллекцию страниц, выделенную для больших объектов таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1429">Data fragments are a collection of pages dedicated to large objects in a table.</span></span>  
  
 <span data-ttu-id="a5bd4-1430">По мере добавления в базу данных новых больших значений выделяются фрагменты, размером максимум в 8040 байт данных на фрагмент.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1430">As new large values are added to a database, they are allocated using a maximum of 8040 bytes of data per fragment.</span></span> <span data-ttu-id="a5bd4-1431">Более ранние версии компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] поддерживали хранение до 8080 байт данных типа `ntext`, `text` или `image` на фрагмент.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1431">Earlier versions of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stored up to 8080 bytes of `ntext`, `text`, or `image` data per fragment.</span></span>  
  
 <span data-ttu-id="a5bd4-1432">Когда база данных обновляется с более ранних версий `ntext` на `text`, существующие большие объекты (LOB) типа `image`, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] и [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] не обновляются, чтобы освободить пространство для информации об управлении версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1432">Existing `ntext`, `text`, and `image` large object (LOB) data is not updated to make space for the row versioning information when a database is upgraded to [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] from an earlier version of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a5bd4-1433">Однако при первом обновлении данные LOB динамически обновляются для включения хранения сведений для управления версиями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1433">However, the first time the LOB data is modified, it is dynamically upgraded to enable storage of versioning information.</span></span> <span data-ttu-id="a5bd4-1434">Это происходит даже в случае, если версии строк не формируются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1434">This will happen even if row versions are not generated.</span></span> <span data-ttu-id="a5bd4-1435">После обновления данных LOB максимальное число байтов на фрагмент уменьшается с 8080 до 8040 байт.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1435">After the LOB data is upgraded, the maximum number of bytes stored per fragment is reduced from 8080 bytes to 8040 bytes.</span></span> <span data-ttu-id="a5bd4-1436">Процесс обновления равнозначен удалению значения LOB и повторной вставки того же значения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1436">The upgrade process is equivalent to deleting the LOB value and reinserting the same value.</span></span> <span data-ttu-id="a5bd4-1437">Данные LOB обновляются даже при изменении только одного байта.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1437">The LOB data is upgraded even if only one byte is modified.</span></span> <span data-ttu-id="a5bd4-1438">Это одноразовая операция для каждой строки типа `ntext`, `text` или `image`, но при каждой операции, в зависимости от размера данных LOB, может формироваться большое число операций выделения страниц и операций ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1438">This is a one-time operation for each `ntext`, `text`, or `image` column, but each operation may generate a large amount of page allocations and I/O activity depending upon the size of the LOB data.</span></span> <span data-ttu-id="a5bd4-1439">Может также формироваться большое число операций записи в журнал, если изменения полностью записываются в журнал.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1439">It may also generate a large amount of logging activity if the modification is fully logged.</span></span> <span data-ttu-id="a5bd4-1440">Операции WRITETEXT и UPDATETEXT записываются в журнал в минимальном объеме, если режим восстановления базы данных не установлен в FULL.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1440">WRITETEXT and UPDATETEXT operations are minimally logged if database recovery mode is not set to FULL.</span></span>  
  
 <span data-ttu-id="a5bd4-1441">Типы данных `nvarchar(max)`, `varchar(max)` и `varbinary(max)` в более ранних версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] недоступны.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1441">The `nvarchar(max)`, `varchar(max)`, and `varbinary(max)` data types are not available in earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a5bd4-1442">Поэтому проблем, связанных с их обновлением, возникнуть не может.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1442">Therefore, they have no upgrade issues.</span></span>  
  
 <span data-ttu-id="a5bd4-1443">Для соответствия данному требованию необходимо выделить достаточно места на диске.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1443">Enough disk space should be allocated to accommodate this requirement.</span></span>  
  
#### <a name="monitoring-row-versioning-and-the-version-store"></a><span data-ttu-id="a5bd4-1444">Контроль управления версиями строк и хранилища версий</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1444">Monitoring Row Versioning and the Version Store</span></span>  

 <span data-ttu-id="a5bd4-1445">Для контроля за управлением версиями строк, за хранилищем версий и процессами изоляции моментальных снимков с целью увеличения производительности и диагностики в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] имеются средства в виде динамических административных представлений (DMV) и счетчиков производительности в системном мониторе Windows.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1445">For monitoring row versioning, version store, and snapshot isolation processes for performance and problems, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] provides tools in the form of Dynamic Management Views (DMVs) and performance counters in Windows System Monitor.</span></span>  
  
##### <a name="dmvs"></a><span data-ttu-id="a5bd4-1446">Представления DMV</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1446">DMVs</span></span>  

 <span data-ttu-id="a5bd4-1447">Следующие представления DMV предоставляют сведения о текущем системном состоянии базы данных tempdb и хранилища версий, а также о транзакциях, в которых используется управление версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1447">The following DMVs provide information about the current system state of tempdb and the version store, as well as transactions using row versioning.</span></span>  
  
 <span data-ttu-id="a5bd4-1448">sys.dm_db_file_space_usage</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1448">sys.dm_db_file_space_usage.</span></span> <span data-ttu-id="a5bd4-1449">Возвращает сведения о пространстве, используемом каждым файлом базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1449">Returns space usage information for each file in the database.</span></span> <span data-ttu-id="a5bd4-1450">Дополнительные сведения см. в разделе [sys.dm_db_file_space_usage (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1450">For more information, see [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1451">sys.dm_db_session_space_usage</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1451">sys.dm_db_session_space_usage.</span></span> <span data-ttu-id="a5bd4-1452">Возвращает сведения об активности по выделению и освобождению страниц по сеансам для базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1452">Returns page allocation and deallocation activity by session for the database.</span></span> <span data-ttu-id="a5bd4-1453">Дополнительные сведения см. в разделе [sys.dm_db_session_space_usage (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1453">For more information, see [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1454">sys.dm_db_task_space_usage</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1454">sys.dm_db_task_space_usage.</span></span> <span data-ttu-id="a5bd4-1455">Возвращает действия по размещению и удалению из памяти страниц для задачи в базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1455">Returns page allocation and deallocation activity by task for the database.</span></span> <span data-ttu-id="a5bd4-1456">Дополнительные сведения см. в разделе [sys.dm_db_task_space_usage (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1456">For more information, see [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1457">sys.dm_tran_top_version_generators</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1457">sys.dm_tran_top_version_generators.</span></span> <span data-ttu-id="a5bd4-1458">Возвращает виртуальную таблицу для объектов, формирующих большинство версий в хранилище версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1458">Returns a virtual table for the objects producing the most versions in the version store.</span></span> <span data-ttu-id="a5bd4-1459">В ней 256 максимальных значений совокупной длины записей сгруппированы по database_id и rowset_id.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1459">It groups the top 256 aggregated record lengths by database_id and rowset_id.</span></span> <span data-ttu-id="a5bd4-1460">Эта функция позволяет определить самых крупных потребителей в хранилище версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1460">Use this function to find the largest consumers of the version store.</span></span> <span data-ttu-id="a5bd4-1461">Дополнительные сведения см. в разделе [sys.dm_tran_top_version_generators (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1461">For more information, see [sys.dm_tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1462">sys.dm_tran_version_store</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1462">sys.dm_tran_version_store.</span></span> <span data-ttu-id="a5bd4-1463">Возвращает виртуальную таблицу, в которой отображаются все записи о версиях в стандартном хранилище версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1463">Returns a virtual table that displays all version records in the common version store.</span></span> <span data-ttu-id="a5bd4-1464">Дополнительные сведения см. в разделе [sys.dm_tran_version_store (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1464">For more information, see [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1465">Выполнение функций sys.dm_tran_top_version_generators и sys.dm_tran_version_store потенциально является весьма затратным, так как обеими функциями выполняется запрос ко всему хранилищу версий, которое может быть довольно объемным.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1465">sys.dm_tran_top_version_generators and sys.dm_tran_version_store are potentially very expensive functions to run, since both query the entire version store, which could be very large.</span></span>  
  
 <span data-ttu-id="a5bd4-1466">sys.dm_tran_active_snapshot_database_transactions</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1466">sys.dm_tran_active_snapshot_database_transactions.</span></span> <span data-ttu-id="a5bd4-1467">Возвращает виртуальную таблицу для всех активных транзакций во всех базах данных экземпляра [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], использующего управление версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1467">Returns a virtual table for all active transactions in all databases within the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] instance that use row versioning.</span></span> <span data-ttu-id="a5bd4-1468">Системные транзакции в данном DMV не отображаются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1468">System transactions do not appear in this DMV.</span></span> <span data-ttu-id="a5bd4-1469">Дополнительные сведения см. в разделе [sys.dm_tran_active_snapshot_database_transactions (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1469">For more information, see [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1470">sys.dm_tran_transactions_snapshot</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1470">sys.dm_tran_transactions_snapshot.</span></span> <span data-ttu-id="a5bd4-1471">Возвращает виртуальную таблицу, в которой отображаются моментальные снимки, сделанные каждой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1471">Returns a virtual table that displays snapshots taken by each transaction.</span></span> <span data-ttu-id="a5bd4-1472">Моментальный снимок содержит последовательные номера активных транзакций, использующих управление версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1472">The snapshot contains the sequence number of the active transactions that use row versioning.</span></span> <span data-ttu-id="a5bd4-1473">Дополнительные сведения см. в разделе [sys.dm_tran_transactions_snapshot (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1473">For more information, see [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1474">sys.dm_tran_current_transaction</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1474">sys.dm_tran_current_transaction.</span></span> <span data-ttu-id="a5bd4-1475">Возвращает одиночную строку, в которой отображаются зависящие от версии сведения транзакции текущего сеанса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1475">Returns a single row that displays row versioning-related state information of the transaction in the current session.</span></span> <span data-ttu-id="a5bd4-1476">Дополнительные сведения см. в разделе [sys.dm_tran_current_transaction (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1476">For more information, see [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1477">sys.dm_tran_current_snapshot</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1477">sys.dm_tran_current_snapshot.</span></span> <span data-ttu-id="a5bd4-1478">Возвращает виртуальную таблицу, в которой отображаются все активные транзакции на момент начала текущей транзакции с изоляцией моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1478">Returns a virtual table that displays all active transactions at the time the current snapshot isolation transaction starts.</span></span> <span data-ttu-id="a5bd4-1479">Если текущая транзакция использует изоляцию моментального снимка, данная функция не возвращает строки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1479">If the current transaction is using snapshot isolation, this function returns no rows.</span></span> <span data-ttu-id="a5bd4-1480">Представление sys.dm_tran_current_snapshot похоже на sys.dm_tran_transactions_snapshot с той разницей, что возвращает только активные транзакции для текущего снимка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1480">sys.dm_tran_current_snapshot is similar to sys.dm_tran_transactions_snapshot, except that it returns only the active transactions for the current snapshot.</span></span> <span data-ttu-id="a5bd4-1481">Дополнительные сведения см. в разделе [sys.dm_tran_current_snapshot (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1481">For more information, see [sys.dm_tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span></span>  
  
##### <a name="performance-counters"></a><span data-ttu-id="a5bd4-1482">Счетчики производительности</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1482">Performance Counters</span></span>  

 <span data-ttu-id="a5bd4-1483">Счетчики производительности [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] предоставляют сведения о системной производительности, на которую влияют процессы [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1483">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] performance counters provide information about the system performance impacted by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] processes.</span></span> <span data-ttu-id="a5bd4-1484">Следующие счетчики производительности контролируют базу данных tempdb и хранилище версий, а также транзакции, использующие управление версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1484">The following performance counters monitor tempdb and the version store, as well as transactions using row versioning.</span></span> <span data-ttu-id="a5bd4-1485">Счетчики производительности содержатся в объекте производительности SQLServer:Transactions.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1485">The performance counters are contained in the SQLServer:Transactions performance object.</span></span>  
  
 <span data-ttu-id="a5bd4-1486">**Свободное пространство в базе данных tempdb (КБ)** .</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1486">**Free Space in tempdb (KB)**.</span></span> <span data-ttu-id="a5bd4-1487">Позволяет контролировать объем (в килобайтах (КБ)) свободного места в базе данных tempdb.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1487">Monitors the amount, in kilobytes (KB), of free space in the tempdb database.</span></span> <span data-ttu-id="a5bd4-1488">В базе данных tempdb должно быть достаточно свободного места для обработки хранилища версий, поддерживающего изоляцию моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1488">There must be enough free space in tempdb to handle the version store that supports snapshot isolation.</span></span>  
  
 <span data-ttu-id="a5bd4-1489">Следующая формула позволяет приблизительно оценить размер хранилища версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1489">The following formula provides a rough estimate of the size of the version store.</span></span> <span data-ttu-id="a5bd4-1490">Для транзакций с длительным временем выполнения она может быть полезна при контроле над скоростью формирования и очистки в целях оценки максимального размера хранилища версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1490">For long-running transactions, it may be useful to monitor the generation and cleanup rate to estimate the maximum size of the version store.</span></span>  
  
 <span data-ttu-id="a5bd4-1491">[размер стандартного хранилища версий] = 2 \* [создаваемые данные для хранилища версий за минуту] \* [наиболее длительное время выполнения транзакции (в минутах)]</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1491">[size of common version store] = 2 \* [version store data generated per minute] \* [longest running time (minutes) of the transaction]</span></span>  
  
 <span data-ttu-id="a5bd4-1492">Наиболее длительное время выполнения транзакции не должно включать построение индекса в сети.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1492">The longest running time of transactions should not include online index builds.</span></span> <span data-ttu-id="a5bd4-1493">Так как эти операции над очень большими таблицами могут занять продолжительное время, для построения индекса в сети используется отдельное хранилище версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1493">Because these operations may take a long time on very large tables, online index builds use a separate version store.</span></span> <span data-ttu-id="a5bd4-1494">Примерный размер хранилища версий для построения индексов в сети равен объему данных, изменяемых в таблице, включая все индексы, за время активности построения индекса в сети.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1494">The approximate size of the online index build version store equals the amount of data modified in the table, including all indexes, while the online index build is active.</span></span>  
  
 <span data-ttu-id="a5bd4-1495">**Размер хранилища версий (KБ)** .</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1495">**Version Store Size (KB)**.</span></span> <span data-ttu-id="a5bd4-1496">Контролирует размер всех хранилищ версий в килобайтах.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1496">Monitors the size in KB of all version stores.</span></span> <span data-ttu-id="a5bd4-1497">Эти сведения помогают определить объем пространства, которое необходимо выделить в базе данных tempdb для хранилища версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1497">This information helps determine the amount of space needed in the tempdb database for the version store.</span></span> <span data-ttu-id="a5bd4-1498">Наблюдение за этим счетчиком в течение некоторого периода времени полезно для оценки дополнительного пространства, необходимого для базы данных tempdb.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1498">Monitoring this counter over a period of time provides a useful estimate of additional space needed for tempdb.</span></span>  
  
 <span data-ttu-id="a5bd4-1499">`Version Generation rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1499">`Version Generation rate (KB/s)`.</span></span> <span data-ttu-id="a5bd4-1500">Контролирует скорость формирования версий во всех хранилищах версий, КБ/с.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1500">Monitors the version generation rate in KB per second in all version stores.</span></span>  
  
 <span data-ttu-id="a5bd4-1501">`Version Cleanup rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1501">`Version Cleanup rate (KB/s)`.</span></span> <span data-ttu-id="a5bd4-1502">Контролирует скорость очистки версий во всех хранилищах версий, КБ/с.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1502">Monitors the version cleanup rate in KB per second in all version stores.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1503">Сведения счетчиков Скорость формирования версий (КБ/с) и Скорость очистки версий (КБ/с) можно использовать для предсказания требований к пространству для базы данных tempdb.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1503">Information from Version Generation rate (KB/s) and Version Cleanup rate (KB/s) can be used to predict tempdb space requirements.</span></span>  
  
 <span data-ttu-id="a5bd4-1504">**Счетчик блоков хранилища версий**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1504">**Version Store unit count**.</span></span> <span data-ttu-id="a5bd4-1505">Контролирует число записей в хранилище версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1505">Monitors the count of version store units.</span></span>  
  
 <span data-ttu-id="a5bd4-1506">**Создано блоков хранилища версий**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1506">**Version Store unit creation**.</span></span> <span data-ttu-id="a5bd4-1507">Контролирует общее число записей в хранилище версий, созданных для хранения версий строк с момента запуска экземпляра.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1507">Monitors the total number of version store units created to store row versions since the instance was started.</span></span>  
  
 <span data-ttu-id="a5bd4-1508">**Усечено блоков хранилища версий**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1508">**Version Store unit truncation**.</span></span> <span data-ttu-id="a5bd4-1509">Контролирует общее число записей в хранилище версий, усеченных с момента запуска экземпляра.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1509">Monitors the total number of version store units truncated since the instance was started.</span></span> <span data-ttu-id="a5bd4-1510">Усечение записи в хранилище версий выполняется в случае, когда [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] определяет, что для запуска активных транзакций не требуется ни одной из строк версий, хранящихся в хранилище.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1510">A version store unit is truncated when [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines that none of the version rows stored in the version store unit are needed to run active transactions.</span></span>  
  
 <span data-ttu-id="a5bd4-1511">**Коэффициент конфликтов обновления**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1511">**Update conflict ratio**.</span></span> <span data-ttu-id="a5bd4-1512">Контролирует процент транзакций с обновлением моментальных снимков, в которых возникают конфликты обновления, в общем числе транзакций с обновлением моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1512">Monitors the ratio of update snapshot transaction that have update conflicts to the total number of update snapshot transactions.</span></span>  
  
 <span data-ttu-id="a5bd4-1513">**Наиболее продолжительное время выполнения транзакции**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1513">**Longest Transaction Running Time**.</span></span> <span data-ttu-id="a5bd4-1514">Контролирует наиболее длительное время выполнения любой транзакции, использующей управление версиями строк, в секундах.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1514">Monitors the longest running time in seconds of any transaction using row versioning.</span></span> <span data-ttu-id="a5bd4-1515">Пользуясь этим, можно определить транзакцию, выполняемую в течение неоправданно длительного промежутка времени, если таковая имеется.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1515">This can be used to determine if any transaction is running for an unreasonable amount of time.</span></span>  
  
 <span data-ttu-id="a5bd4-1516">**Транзакции**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1516">**Transactions**.</span></span> <span data-ttu-id="a5bd4-1517">Контролирует общее число активных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1517">Monitors the total number of active transactions.</span></span> <span data-ttu-id="a5bd4-1518">В этот показатель не включаются системные транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1518">This does not include system transactions.</span></span>  
  
 <span data-ttu-id="a5bd4-1519">`Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1519">`Snapshot Transactions`.</span></span> <span data-ttu-id="a5bd4-1520">Контролирует общее число активных транзакций моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1520">Monitors the total number of active snapshot transactions.</span></span>  
  
 <span data-ttu-id="a5bd4-1521">`Update Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1521">`Update Snapshot Transactions`.</span></span> <span data-ttu-id="a5bd4-1522">Контролирует общее число активных транзакций моментальных снимков, выполняющих операции обновления.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1522">Monitors the total number of active snapshot transactions that perform update operations.</span></span>  
  
 <span data-ttu-id="a5bd4-1523">`NonSnapshot Version Transactions`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1523">`NonSnapshot Version Transactions`.</span></span> <span data-ttu-id="a5bd4-1524">Контролирует общее число активных транзакций вне моментальных снимков, формирующих записи о версиях.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1524">Monitors the total number of active non-snapshot transactions that generate version records.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1525">Сумма показателей Транзакции моментальных снимков обновления и Транзакции версий без моментальных снимков представляет собой общее число транзакций, участвующих в формировании версий.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1525">The sum of Update Snapshot Transactions and NonSnapshot Version Transactions represents the total number of transactions that participate in version generation.</span></span> <span data-ttu-id="a5bd4-1526">Разность показателей Транзакции моментальных снимков и Транзакции моментальных снимков обновления соответствует числу транзакций моментальных снимков, выполняющих только чтение.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1526">The difference of Snapshot Transactions and Update Snapshot Transactions reports the number of read-only snapshot transactions.</span></span>  
  
### <a name="row-versioning-based-isolation-level-example"></a><span data-ttu-id="a5bd4-1527">Пример уровня изоляции, основанного на управлении версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1527">Row Versioning-based Isolation Level Example</span></span>  

 <span data-ttu-id="a5bd4-1528">В следующих примерах показана разница в поведении между транзакциями с уровнем изоляции моментального снимка и транзакциями с уровнем изоляции read-committed, использующими управление версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1528">The following examples show the differences in behavior between snapshot isolation transactions and read-committed transactions that use row versioning.</span></span>  
  
#### <a name="a-working-with-snapshot-isolation"></a><span data-ttu-id="a5bd4-1529">A.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1529">A.</span></span> <span data-ttu-id="a5bd4-1530">Работа с изоляцией моментального снимка</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1530">Working with snapshot isolation</span></span>  

 <span data-ttu-id="a5bd4-1531">В этом примере транзакция, запущенная под изоляцией моментальных снимков, считывает данные, которые были изменены другой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1531">In this example, a transaction running under snapshot isolation reads data that is then modified by another transaction.</span></span> <span data-ttu-id="a5bd4-1532">Транзакция моментального снимка не блокирует операцию обновления, выполняемую другой транзакцией, которая продолжает считывать данные обновленных строк, не учитывая модификацию данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1532">The snapshot transaction does not block the update operation executed by the other transaction, and it continues to read data from the versioned row, ignoring the data modification.</span></span> <span data-ttu-id="a5bd4-1533">Однако когда транзакция моментального снимка предпринимает попытки изменить данные, уже измененные другой транзакцией, формируется ошибка, и транзакция моментального снимка завершается.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1533">However, when the snapshot transaction attempts to modify the data that has already been modified by the other transaction, the snapshot transaction generates an error and is terminated.</span></span>  
  
 <span data-ttu-id="a5bd4-1534">В сеансе 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1534">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or the 2008 or 2008R2 version of the AdventureWorks database.  
GO  
  
-- Enable snapshot isolation on the database.  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
GO  
  
-- Start a snapshot transaction  
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="a5bd4-1535">В сеансе 2:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1535">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under snapshot isolation shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="a5bd4-1536">В сеансе 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1536">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this shows  
    -- the employee having 48 vacation hours.  The  
    -- snapshot transaction is still reading data from  
    -- the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="a5bd4-1537">В сеансе 2:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1537">On session 2:</span></span>  
  
```sql  
-- Commit the transaction; this commits the data  
-- modification.  
COMMIT TRANSACTION;  
GO  
```  
  
 <span data-ttu-id="a5bd4-1538">В сеансе 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1538">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still   
    -- shows the employee having 48 vacation hours  
    -- even after the other transaction has committed  
    -- the data modification.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- Because the data has been modified outside of the  
    -- snapshot transaction, any further data changes to   
    -- that data by the snapshot transaction will cause   
    -- the snapshot transaction to fail. This statement   
    -- will generate a 3960 error and the transaction will   
    -- terminate.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION  
GO  
```  
  
#### <a name="b-working-with-read-committed-using-row-versioning"></a><span data-ttu-id="a5bd4-1539">Б.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1539">B.</span></span> <span data-ttu-id="a5bd4-1540">Работа с изоляцией read-committed с использованием управления версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1540">Working with read-committed using row versioning</span></span>  

 <span data-ttu-id="a5bd4-1541">В этом примере транзакция read-committed, используя управление версиями строк, запускается после другой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1541">In this example, a read-committed transaction using row versioning runs concurrently with another transaction.</span></span> <span data-ttu-id="a5bd4-1542">Транзакция read-committed работает не так, как транзакция моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1542">The read-committed transaction behaves differently than a snapshot transaction.</span></span> <span data-ttu-id="a5bd4-1543">Как и транзакция моментального снимка, транзакция read-committed будет считывать версии строк даже после того, как другая транзакция изменила данные.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1543">Like a snapshot transaction, the read-committed transaction will read versioned rows even after the other transaction has modified data.</span></span> <span data-ttu-id="a5bd4-1544">Однако в отличие от транзакции моментального снимка, она:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1544">However, unlike a snapshot transaction, the read-committed transaction will:</span></span>  
  
-   <span data-ttu-id="a5bd4-1545">считывает измененные данные после того, как другая транзакция фиксирует изменения;</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1545">Read the modified data after the other transaction commits the data changes.</span></span>  
  
-   <span data-ttu-id="a5bd4-1546">может обновлять данные, измененные другой транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1546">Be able to update the data modified by the other transaction where the snapshot transaction could not.</span></span>  
  
 <span data-ttu-id="a5bd4-1547">В сеансе 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1547">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or any earlier version of the AdventureWorks database.  
GO  
  
-- Enable READ_COMMITTED_SNAPSHOT on the database.  
-- For this statement to succeed, this session  
-- must be the only connection to the AdventureWorks2012  
-- database.  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
GO  
  
-- Start a read-committed transaction  
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="a5bd4-1548">В сеансе 2:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1548">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under read-committed using row versioning shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="a5bd4-1549">В сеансе 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1549">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still shows  
    -- the employee having 48 vacation hours.  The  
    -- read-committed transaction is still reading data   
    -- from the versioned row and the other transaction   
    -- has not committed the data changes yet.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="a5bd4-1550">В сеансе 2:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1550">On session 2:</span></span>  
  
```sql  
-- Commit the transaction.  
COMMIT TRANSACTION;  
GO  
  
```  
  
 <span data-ttu-id="a5bd4-1551">В сеансе 1:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1551">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement which now shows the   
    -- employee having 40 vacation hours.  Being   
    -- read-committed, this transaction is reading the   
    -- committed data. This is different from snapshot  
    -- isolation which reads from the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- This statement, which caused the snapshot transaction   
    -- to fail, will succeed with read-committed using row versioning.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION;  
GO  
```  
  
### <a name="enabling-row-versioning-based-isolation-levels"></a><span data-ttu-id="a5bd4-1552">Включение основанных на управлении версиями строк уровней изоляции</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1552">Enabling Row Versioning-Based Isolation Levels</span></span>  

 <span data-ttu-id="a5bd4-1553">Администраторы баз данных управляют настройками уровней баз данных, основанных на управлении версиями строк, при помощи параметров баз данных READ_COMMITTED_SNAPSHOT и ALLOW_SNAPSHOT_ISOLATION инструкции ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1553">Database administrators control the database-level settings for row versioning by using the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options in the ALTER DATABASE statement.</span></span>  
  
 <span data-ttu-id="a5bd4-1554">Когда значение параметра базы данных READ_COMMITTED_SNAPSHOT устанавливается равным ON, немедленно включаются механизмы, осуществляющие поддержку данной функции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1554">When the READ_COMMITTED_SNAPSHOT database option is set ON, the mechanisms used to support the option are activated immediately.</span></span> <span data-ttu-id="a5bd4-1555">При настройке параметра READ_COMMITTED_SNAPSHOT в базе данных допустимо соединение только при помощи команды ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1555">When setting the READ_COMMITTED_SNAPSHOT option, only the connection executing the ALTER DATABASE command is allowed in the database.</span></span> <span data-ttu-id="a5bd4-1556">До завершения инструкции ALTER DATABASE в базе данных не должно быть других открытых соединений.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1556">There must be no other open connection in the database until ALTER DATABASE is complete.</span></span> <span data-ttu-id="a5bd4-1557">База данных не обязательно должна находиться в однопользовательском режиме.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1557">The database does not have to be in single-user mode.</span></span>  
  
 <span data-ttu-id="a5bd4-1558">Следующая инструкция [!INCLUDE[tsql](../includes/tsql-md.md)] включает READ_COMMITTED_SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1558">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement enables READ_COMMITTED_SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
```  
  
 <span data-ttu-id="a5bd4-1559">Если значение параметра базы данных ALLOW_SNAPSHOT_ISOLATION равно ON, экземпляр компонента [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] не создает версии строк для измененных данных до тех пор, пока все изменяющие данные транзакции не завершат работу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1559">When the ALLOW_SNAPSHOT_ISOLATION database option is set ON, the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] does not generate row versions for modified data until all active transactions that have modified data in the database complete.</span></span> <span data-ttu-id="a5bd4-1560">Если изменяющие данные транзакции активны, то [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] устанавливает значение параметра равным PENDING_ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1560">If there are active modification transactions, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] sets the state of the option to PENDING_ON.</span></span> <span data-ttu-id="a5bd4-1561">После завершения работы всех изменяющих данные транзакций значение параметра меняется на ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1561">After all of the modification transactions complete, the state of the option is changed to ON.</span></span> <span data-ttu-id="a5bd4-1562">Пользователь не может запустить транзакцию моментальных снимков в базе данных до тех пор, пока значение параметра не равно ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1562">Users cannot start a snapshot transaction in that database until the option is fully ON.</span></span> <span data-ttu-id="a5bd4-1563">База данных проходит через состояние PENDING_OFF, когда администратор базы данных устанавливает параметр ALLOW_SNAPSHOT_ISOLATION равным OFF.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1563">The database passes through a PENDING_OFF state when the database administrator sets the ALLOW_SNAPSHOT_ISOLATION option to OFF.</span></span>  
  
 <span data-ttu-id="a5bd4-1564">Следующая инструкция [!INCLUDE[tsql](../includes/tsql-md.md)] включает параметр ALLOW_SNAPSHOT_ISOLATION:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1564">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement will enable ALLOW_SNAPSHOT_ISOLATION:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
```  
  
 <span data-ttu-id="a5bd4-1565">В следующей таблице приведен список и описаны значения параметра ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1565">The following table lists and describes the states of the ALLOW_SNAPSHOT_ISOLATION option.</span></span> <span data-ttu-id="a5bd4-1566">Использование инструкции ALTER DATABASE с параметром ALLOW_SNAPSHOT_ISOLATION не помешает другим пользователям, использующим в текущий момент данные базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1566">Using ALTER DATABASE with the ALLOW_SNAPSHOT_ISOLATION option does not block users who are currently accessing the database data.</span></span>  
  
|<span data-ttu-id="a5bd4-1567">Состояние платформы изоляции моментальных снимков текущей базы данных</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1567">State of snapshot isolation framework for current database</span></span>|<span data-ttu-id="a5bd4-1568">Описание</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1568">Description</span></span>|  
|----------------------------------------------------------------|-----------------|  
|<span data-ttu-id="a5bd4-1569">OFF</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1569">OFF</span></span>|<span data-ttu-id="a5bd4-1570">Поддержка транзакций изоляции моментальных снимков не включена.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1570">The support for snapshot isolation transactions is not activated.</span></span> <span data-ttu-id="a5bd4-1571">Транзакции изоляции моментальных снимков не разрешены.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1571">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="a5bd4-1572">PENDING_ON</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1572">PENDING_ON</span></span>|<span data-ttu-id="a5bd4-1573">Поддержка транзакций изоляции моментальных снимков находится в переходном состоянии (из OFF в ON).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1573">The support for snapshot isolation transactions is in transition state (from OFF to ON).</span></span> <span data-ttu-id="a5bd4-1574">Открытые транзакции должны завершить свою работу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1574">Open transactions must complete.</span></span><br /><br /> <span data-ttu-id="a5bd4-1575">Транзакции изоляции моментальных снимков не разрешены.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1575">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="a5bd4-1576">ON</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1576">ON</span></span>|<span data-ttu-id="a5bd4-1577">Поддержка транзакций изоляции моментальных снимков включена.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1577">The support for snapshot isolation transactions is activated.</span></span><br /><br /> <span data-ttu-id="a5bd4-1578">Транзакции изоляции моментальных снимков разрешены.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1578">Snapshot transactions are allowed.</span></span>|  
|<span data-ttu-id="a5bd4-1579">PENDING_OFF</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1579">PENDING_OFF</span></span>|<span data-ttu-id="a5bd4-1580">Поддержка транзакций изоляции моментальных снимков находится в переходном состоянии (из ON в OFF).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1580">The support for snapshot isolation transactions is in transition state (from ON to OFF).</span></span><br /><br /> <span data-ttu-id="a5bd4-1581">Транзакции моментальных снимков, запущенные после этого момента, не имеют доступа к базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1581">Snapshot transactions started after this time cannot access this database.</span></span> <span data-ttu-id="a5bd4-1582">Транзакции обновления все еще терпят издержки из-за различия в версиях в данной базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1582">Update transactions still pay the cost of versioning in this database.</span></span> <span data-ttu-id="a5bd4-1583">Существующие транзакции моментальных снимков по-прежнему могут получать доступ к базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1583">Existing snapshot transactions can still access this database without a problem.</span></span> <span data-ttu-id="a5bd4-1584">Состояние PENDING_OFF не переходит в состояние OFF до тех пор, пока не завершится выполнение всех транзакций моментальных снимков, которые были активны, когда параметр изоляции моментальных снимков базы данных был равен ON.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1584">The state PENDING_OFF does not become OFF until all snapshot transactions that were active when the database snapshot isolation state was ON finish.</span></span>|  
  
 <span data-ttu-id="a5bd4-1585">Используйте представление каталога sys.databases для определения состояния параметров управления версиями строк базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1585">Use the sys.databases catalog view to determine the state of both row versioning database options.</span></span>  
  
 <span data-ttu-id="a5bd4-1586">Все обновления пользовательских таблиц и некоторых системных таблиц, хранящихся в базах данных master и msdb, создают версии строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1586">All updates to user tables and some system tables stored in master and msdb generate row versions.</span></span>  
  
 <span data-ttu-id="a5bd4-1587">Параметр ALLOW_SNAPSHOT_ISOLATION автоматически устанавливается равным ON в базах данных master и msdb и не может быть отключен.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1587">The ALLOW_SNAPSHOT_ISOLATION option is automatically set ON in the master and msdb databases, and cannot be disabled.</span></span>  
  
 <span data-ttu-id="a5bd4-1588">Пользователь не может установить параметр READ_COMMITTED_SNAPSHOT равным ON в базах данных master, tempdb или msdb.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1588">Users cannot set the READ_COMMITTED_SNAPSHOT option ON in master, tempdb, or msdb.</span></span>  
  
### <a name="using-row-versioning-based-isolation-levels"></a><span data-ttu-id="a5bd4-1589">Использование уровней изоляции строк на основе управления версиями</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1589">Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="a5bd4-1590">Платформа управления версиями строк в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] всегда включена и используется многими функциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1590">The row versioning framework is always enabled in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], and is used by multiple features.</span></span> <span data-ttu-id="a5bd4-1591">Помимо уровней изоляции, основанных на управлении версиями строк, эта структура используется для поддержки изменений в триггерах и сеансах MARS, а также для поддержки считывания данных операциями индекса ONLINE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1591">Besides providing row versioning-based isolation levels, it is used to support modifications made in triggers and multiple active result sets (MARS) sessions, and to support data reads for ONLINE index operations.</span></span>  
  
 <span data-ttu-id="a5bd4-1592">Уровни изоляции, основанные на управлении версиями строк, включены на уровне базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1592">Row versioning-based isolation levels are enabled at the database level.</span></span> <span data-ttu-id="a5bd4-1593">Любое приложение, которое обращается к объектам из включенной базы данных, может запускать запросы с использованием следующих уровней изоляции:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1593">Any application accessing objects from enabled databases can run queries using the following isolation levels:</span></span>  
  
-   <span data-ttu-id="a5bd4-1594">Изоляция зафиксированного считывания использует управление версиями строк, присваивая параметру базы данных `READ_COMMITTED_SNAPSHOT` значение `ON`, как показано в следующем примере кода:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1594">Read-committed that uses row versioning by setting the `READ_COMMITTED_SNAPSHOT` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET READ_COMMITTED_SNAPSHOT ON;  
    ```  
  
     <span data-ttu-id="a5bd4-1595">Если в базе данных задан параметр READ_COMMITTED_SNAPSHOT, то все запросы, которые выполняются на уровне изоляции read committed, применяют управление версиями строк, то есть операции считывания не блокируют операции обновления.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1595">When the database is enabled for READ_COMMITTED_SNAPSHOT, all queries running under the read committed isolation level use row versioning, which means that read operations do not block update operations.</span></span>  
  
-   <span data-ttu-id="a5bd4-1596">Изоляция моментальных снимков с помощью присвоения параметру базы данных `ALLOW_SNAPSHOT_ISOLATION` значения `ON`, как показано в следующем примере кода:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1596">Snapshot isolation by setting the `ALLOW_SNAPSHOT_ISOLATION` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET ALLOW_SNAPSHOT_ISOLATION ON;  
    ```  
  
     <span data-ttu-id="a5bd4-1597">Транзакция, запускаемая при изоляции моментальных снимков, может обращаться к таблицам в базе данных, которые были включены для моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1597">A transaction running under snapshot isolation can access tables in the database that have been enabled for snapshot.</span></span> <span data-ttu-id="a5bd4-1598">Чтобы получить доступ к остальным таблицам, следует изменить уровень изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1598">To access tables that have not been enabled for snapshot, the isolation level must be changed.</span></span> <span data-ttu-id="a5bd4-1599">Например, в следующем примере кода показана инструкция `SELECT`, которая во время выполнения транзакции моментального снимка соединяет две таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1599">For example, the following code example shows a `SELECT` statement that joins two tables while running under a snapshot transaction.</span></span> <span data-ttu-id="a5bd4-1600">Одна таблица принадлежит базе данных с выключенной изоляцией моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1600">One table belongs to a database in which snapshot isolation is not enabled.</span></span> <span data-ttu-id="a5bd4-1601">Если инструкция `SELECT` запускается при включенной изоляции моментальных снимков, она завершается неуспешно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1601">When the `SELECT` statement runs under snapshot isolation, it fails to execute successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
     <span data-ttu-id="a5bd4-1602">В следующем примере кода показана измененная инструкция `SELECT`, в которой уровень изоляции транзакций изменен на зафиксированное считывание.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1602">The following code example shows the same `SELECT` statement that has been modified to change the transaction isolation level to read-committed.</span></span> <span data-ttu-id="a5bd4-1603">Благодаря этому инструкция `SELECT` выполняется успешно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1603">Because of this change, the `SELECT` statement executes successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            WITH (READCOMMITTED)  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
#### <a name="limitations-of-transactions-using-row-versioning-based-isolation-levels"></a><span data-ttu-id="a5bd4-1604">Ограничения транзакций, использующих уровни изоляции строк на основе управления версиями</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1604">Limitations of Transactions Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="a5bd4-1605">При работе с уровнями изоляции строк на основе управления версиями следует учитывать следующие ограничения:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1605">Consider the following limitations when working with row versioning-based isolation levels:</span></span>  
  
-   <span data-ttu-id="a5bd4-1606">Параметр READ_COMMITTED_SNAPSHOT должен быть выключен в базах данных tempdb, msdb и master.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1606">READ_COMMITTED_SNAPSHOT cannot be enabled in tempdb, msdb, or master.</span></span>  
  
-   <span data-ttu-id="a5bd4-1607">Глобальные временные таблицы хранятся в базе данных tempdb.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1607">Global temp tables are stored in tempdb.</span></span> <span data-ttu-id="a5bd4-1608">При обращении к глобальным временным таблицам внутри транзакции моментального снимка необходимо выполнить одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1608">When accessing global temp tables inside a snapshot transaction, one of the following must happen:</span></span>  
  
    -   <span data-ttu-id="a5bd4-1609">Присвойте значение ON параметру ALLOW_SNAPSHOT_ISOLATION в базе данных tempdb.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1609">Set the ALLOW_SNAPSHOT_ISOLATION database option ON in tempdb.</span></span>  
  
    -   <span data-ttu-id="a5bd4-1610">Чтобы изменить уровень изоляции для инструкции, ознакомьтесь с соответствующими указаниями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1610">Use an isolation hint to change the isolation level for the statement.</span></span>  
  
-   <span data-ttu-id="a5bd4-1611">Транзакции моментальных снимков завершаются неуспешно в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1611">Snapshot transactions fail when:</span></span>  
  
    -   <span data-ttu-id="a5bd4-1612">Если база данных стала доступной только для считывания после запуска транзакции моментального снимка, но до того, как эта транзакция получила доступ к базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1612">A database is made read-only after the snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span>  
  
    -   <span data-ttu-id="a5bd4-1613">Если при обращении к объектам из нескольких баз данных состояние базы данных изменилось следующим образом: она была восстановлена после запуска транзакции моментального снимка, но до того, как эта транзакция получила доступ к базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1613">If accessing objects from multiple databases, a database state was changed in such a way that database recovery occurred after a snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span> <span data-ttu-id="a5bd4-1614">Например, база данных перешла в состояние OFFLINE, затем в ONLINE, автоматически закрылась, затем открылась или была отсоединена, а затем присоединена.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1614">For example: the database was set to OFFLINE and then to ONLINE, database autoclose and open, or database detach and attach.</span></span>  
  
-   <span data-ttu-id="a5bd4-1615">Распределенные транзакции (включая запросы к распределенным секционированным базам данных) не поддерживаются при изоляции моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1615">Distributed transactions, including queries in distributed partitioned databases, are not supported under snapshot isolation.</span></span>  
  
-   [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="a5bd4-1616">не сохраняет несколько версий системных метаданных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1616">does not keep multiple versions of system metadata.</span></span> <span data-ttu-id="a5bd4-1617">Метаданные изменяются с помощью инструкций языка DDL, применяемых к таблицам и другим объектам баз данных (индексам, представлениям, типам данных, хранимым процедурам и функциям среды CRL).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1617">Data definition language (DDL) statements on tables and other database objects (indexes, views, data types, stored procedures, and common language runtime functions) change metadata.</span></span> <span data-ttu-id="a5bd4-1618">Если инструкция DDL изменяет объект, то при изоляции моментальных снимков любая параллельная ссылка на объект вызовет сбой транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1618">If a DDL statement modifies an object, any concurrent reference to the object under snapshot isolation causes the snapshot transaction to fail.</span></span> <span data-ttu-id="a5bd4-1619">Это ограничение не затрагивает участвующие в считывании транзакции, если включен параметр базы данных READ_COMMITTED_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1619">Read-committed transactions do not have this limitation when the READ_COMMITTED_SNAPSHOT database option is ON.</span></span>  
  
     <span data-ttu-id="a5bd4-1620">Например, администратор базы данных выполняет следующую инструкцию `ALTER INDEX`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1620">For example, a database administrator executes the following `ALTER INDEX` statement.</span></span>  
  
    ```sql  
    USE AdventureWorks2012;  
    GO  
    ALTER INDEX AK_Employee_LoginID  
        ON HumanResources.Employee REBUILD;  
    GO  
    ```  
  
     <span data-ttu-id="a5bd4-1621">При попытке вызвать таблицу `ALTER INDEX` во время выполнения инструкции `HumanResources.Employee` все активные транзакции моментальных снимков получат сообщение об ошибке после завершения выполнения инструкции `ALTER INDEX`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1621">Any snapshot transaction that is active when the `ALTER INDEX` statement is executed receives an error if it attempts to reference the `HumanResources.Employee` table after the `ALTER INDEX` statement is executed.</span></span> <span data-ttu-id="a5bd4-1622">Это не относится к участвующим в считывании транзакциям, которые применяют управление версиями строк.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1622">Read-committed transactions using row versioning are not affected.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="a5bd4-1623">Операции BULK INSERT могут вызвать изменения метаданных целевой таблицы (например при выключении проверки ограничений).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1623">BULK INSERT operations may cause changes to target table metadata (for example, when disabling constraint checks).</span></span> <span data-ttu-id="a5bd4-1624">В этом случае происходит сбой параллельных транзакций изоляции моментальных снимков, обращающихся к таблицам, которые добавляются путем массовой вставки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1624">When this happens, concurrent snapshot isolation transactions accessing bulk inserted tables fail.</span></span>  
  
 <span data-ttu-id="a5bd4-1625">![Значок стрелки, используемый в ссылке "назад на начало](media/uparrow16x16.gif "Значок стрелки, используемый со ссылкой В начало") " [в этом пошаговом окне](#Top)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1625">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="customizing-locking-and-row-versioning"></a><span data-ttu-id="a5bd4-1626">Настройка блокировки и управления версиями строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1626">Customizing Locking and Row Versioning</span></span>  
  
### <a name="customizing-the-lock-time-out"></a><span data-ttu-id="a5bd4-1627">Настройка времени ожидания блокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1627">Customizing the Lock Time-Out</span></span>  

 <span data-ttu-id="a5bd4-1628">Если экземпляр [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] не может предоставить блокировку транзакции из-за того, что другая транзакция уже владеет конфликтующей блокировкой этого ресурса, то первая транзакция блокируется, ожидая снятия существующей блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1628">When an instance of the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] cannot grant a lock to a transaction because another transaction already owns a conflicting lock on the resource, the first transaction becomes blocked waiting for the existing lock to be released.</span></span> <span data-ttu-id="a5bd4-1629">По умолчанию не существует обязательного периода ожидания и не существует способа выяснить, заблокирован ли ресурс до блокировки ресурса, за исключением попытки доступа к данным (с потенциальной возможностью блокировки).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1629">By default, there is no mandatory time-out period and no way to test whether a resource is locked before locking it, except to attempt to access the data (and potentially get blocked indefinitely).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1630">В [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] используйте динамическое административное представление **sys.dm_os_waiting_tasks**, чтобы определить, заблокирован ли процесс и кто его блокирует.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1630">In [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sys.dm_os_waiting_tasks** dynamic management view to determine whether a process is being blocked and who is blocking it.</span></span> <span data-ttu-id="a5bd4-1631">В предыдущих версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] используйте системную хранимую процедуру **sp_who**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1631">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sp_who** system stored procedure.</span></span>  
  
 <span data-ttu-id="a5bd4-1632">Параметр LOCK_TIMEOUT дает возможность приложению задать максимальное время ожидания инструкцией заблокированного ресурса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1632">The LOCK_TIMEOUT setting allows an application to set a maximum time that a statement waits on a blocked resource.</span></span> <span data-ttu-id="a5bd4-1633">Если время ожидания инструкцией превышает значение, установленное LOCK_TIMEOUT, заблокированная инструкция автоматически отменяется и в приложение возвращается сообщение об ошибке 1222 (`Lock request time-out period exceeded`).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1633">When a statement has waited longer than the LOCK_TIMEOUT setting, the blocked statement is canceled automatically, and error message 1222 (`Lock request time-out period exceeded`) is returned to the application.</span></span> <span data-ttu-id="a5bd4-1634">Однако никакая транзакция, содержащая инструкцию, не будет откатана или отменена [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1634">Any transaction containing the statement, however, is not rolled back or canceled by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a5bd4-1635">Следовательно, в приложении необходим обработчик ошибок, который может перехватывать сообщение об ошибке 1222.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1635">Therefore, the application must have an error handler that can trap error message 1222.</span></span> <span data-ttu-id="a5bd4-1636">Если приложение не перехватывает ошибку, то оно может продолжить свою работу, не зная, что отдельная инструкция в транзакции была отмена. В будущем возможны ошибки, связанные с тем, что последующие инструкции в транзакции могут опираться на инструкцию, которая не была выполнена.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1636">If an application does not trap the error, the application can proceed unaware that an individual statement within a transaction has been canceled, and errors can occur because statements later in the transaction might depend on the statement that was never executed.</span></span>  
  
 <span data-ttu-id="a5bd4-1637">Реализация обработчика ошибок, который перехватывает сообщения об ошибке 1222, позволяет приложению обработать ситуацию, связанную с превышением времени ожидания, и предпринять действия по ее исправлению, такие как повторная автоматическая передача заблокированной инструкции или откат всей транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1637">Implementing an error handler that traps error message 1222 allows an application to handle the time-out situation and take remedial action, such as: automatically resubmitting the statement that was blocked or rolling back the entire transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-1638">Чтобы определить текущий параметр LOCK_TIMEOUT, выполните @LOCK_TIMEOUT функцию @:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1638">To determine the current LOCK_TIMEOUT setting, execute the @@LOCK_TIMEOUT function:</span></span>  
  
```sql  
SELECT @@lock_timeout;  
GO  
```  
  
### <a name="customizing-transaction-isolation-level"></a><span data-ttu-id="a5bd4-1639">Настройка уровня изоляции транзакции</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1639">Customizing Transaction Isolation Level</span></span>  

 <span data-ttu-id="a5bd4-1640">READ COMMITTED является уровнем изоляции по умолчанию для компонента [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1640">READ COMMITTED is the default isolation level for the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="a5bd4-1641">Если приложение должно работать с другим уровнем изоляции, оно может использовать следующие методы для установки уровня изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1641">If an application must operate at a different isolation level, it can use the following methods to set the isolation level:</span></span>  
  
-   <span data-ttu-id="a5bd4-1642">Выполните инструкцию [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1642">Run the [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="a5bd4-1643">Приложения ADO.NET, использующие управляемое пространство имен System.Data.SqlClient, могут указать параметр *IsolationLevel* при помощи метода SqlConnection.BeginTransaction.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1643">ADO.NET applications that use the System.Data.SqlClient managed namespace can specify an *IsolationLevel* option by using the SqlConnection.BeginTransaction method.</span></span>  
  
-   <span data-ttu-id="a5bd4-1644">Приложения, использующие ADO, могут установить свойство `Autocommit Isolation Levels`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1644">Applications that use ADO can set the `Autocommit Isolation Levels` property.</span></span>  
  
-   <span data-ttu-id="a5bd4-1645">При запуске транзакции приложения, использующие OLE DB, могут вызвать метод ITransactionLocal::StartTransaction с параметром *isoLevel*, равным необходимому уровню изоляции транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1645">When starting a transaction, applications using OLE DB can call ITransactionLocal::StartTransaction with *isoLevel* set to the desired transaction isolation level.</span></span> <span data-ttu-id="a5bd4-1646">При указании уровня изоляции в режиме автоматической фиксации приложения, использующие OLE DB, могут установить свойство DBPROP_SESS_AUTOCOMMITISOLEVELS в значение, равное необходимому уровню изоляции транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1646">When specifying the isolation level in autocommit mode, applications that use OLE DB can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to the desired transaction isolation level.</span></span>  
  
-   <span data-ttu-id="a5bd4-1647">Приложения, использующие ODBC, могут установить атрибут SQL_COPT_SS_TXN_ISOLATION при помощи функции SQLSetConnectAttr.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1647">Applications that use ODBC can set the SQL_COPT_SS_TXN_ISOLATION attribute by using SQLSetConnectAttr.</span></span>  
  
 <span data-ttu-id="a5bd4-1648">Если уровень изоляции указан, поведение блокировки для всех запросов и инструкций языка DML в сеансе [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] действует на указанном уровне изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1648">When the isolation level is specified, the locking behavior for all queries and data manipulation language (DML) statements in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] session operates at that isolation level.</span></span> <span data-ttu-id="a5bd4-1649">Уровень изоляции действует до тех пор, пока сеанс не будет прерван или не будет установлен другой уровень изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1649">The isolation level remains in effect until the session terminates or until the isolation level is set to another level.</span></span>  
  
 <span data-ttu-id="a5bd4-1650">В следующем примере устанавливается уровень изоляции `SERIALIZABLE`:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1650">The following example sets the `SERIALIZABLE` isolation level:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
SELECT BusinessEntityID  
    FROM HumanResources.Employee;  
GO  
```  
  
 <span data-ttu-id="a5bd4-1651">При необходимости уровень изоляции может быть изменен для отдельного запроса или инструкции DML с помощью указания подсказки уровня таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1651">The isolation level can be overridden for individual query or DML statements, if necessary, by specifying a table-level hint.</span></span> <span data-ttu-id="a5bd4-1652">Указание подсказки уровня таблицы не влияет на остальные инструкции сеанса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1652">Specifying a table-level hint does not affect other statements in the session.</span></span> <span data-ttu-id="a5bd4-1653">Указания уровня таблицы для изменения поведения по умолчанию рекомендуется использовать только в случае крайней необходимости.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1653">We recommend that table-level hints be used to change the default behavior only when absolutely necessary.</span></span>  
  
 <span data-ttu-id="a5bd4-1654">Компоненту [!INCLUDE[ssDE](../includes/ssde-md.md)] может потребоваться применить блокировки при чтении метаданных, даже если уровень изоляции установлен в значение, при котором не запрашиваются общие блокировки при чтении данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1654">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata even when the isolation level is set to a level where share locks are not requested when reading data.</span></span> <span data-ttu-id="a5bd4-1655">Например, транзакция, выполняемая на уровне изоляции READ UNCOMMITTED, не применяет общих блокировок при чтении данных, но иногда может запросить блокировки при чтении системного представления каталога.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1655">For example, a transaction running at the read-uncommitted isolation level does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="a5bd4-1656">Это значит, что транзакция READ UNCOMMITTED, возможно, вызовет блокировку при выполнении запроса к таблице, в то время как параллельная транзакция изменяет метаданные этой таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1656">This means it is possible for a read uncommitted transaction to cause blocking when querying a table when a concurrent transaction is modifying the metadata of that table.</span></span>  
  
 <span data-ttu-id="a5bd4-1657">Чтобы узнать, какой уровень изоляции транзакции установлен в данный момент, используйте инструкцию `DBCC USEROPTIONS`, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1657">To determine the transaction isolation level currently set, use the `DBCC USEROPTIONS` statement as shown in the following example.</span></span> <span data-ttu-id="a5bd4-1658">Этот результирующий набор может отличаться от результирующего набора, полученного в другой системе.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1658">The result set may vary from the result set on your system.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;  
GO  
DBCC USEROPTIONS;  
GO  
```  
  
 [!INCLUDE[ssResult](../includes/ssresult-md.md)]  
  
 `Set Option                   Value`  
  
 `---------------------------- -------------------------------------------`  
  
 `textsize                     2147483647`  
  
 `language                     us_english`  
  
 `dateformat                   mdy`  
  
 `datefirst                    7`  
  
 `...                          ...`  
  
 `Isolation level              repeatable read`  
  
 ``  
  
 `(14 row(s) affected)`  
  
 ``  
  
 `DBCC execution completed. If DBCC printed error messages, contact your system administrator.`  
  
### <a name="locking-hints"></a><span data-ttu-id="a5bd4-1659">Указания блокировок</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1659">Locking Hints</span></span>  

 <span data-ttu-id="a5bd4-1660">Указания блокировок можно задавать при ссылках на отдельные таблицы в инструкциях SELECT, INSERT, UPDATE и DELETE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1660">Locking hints can be specified for individual table references in the SELECT, INSERT, UPDATE, and DELETE statements.</span></span> <span data-ttu-id="a5bd4-1661">Подсказки указывают тип блокировки или управления версиями строк, который будет использоваться экземпляром [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] при работе с данными таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1661">The hints specify the type of locking or row versioning the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses for the table data.</span></span> <span data-ttu-id="a5bd4-1662">Указания блокировок на табличном уровне можно использовать, когда требуется более подробное управление типом получаемых для объекта блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1662">Table-level locking hints can be used when a finer control of the types of locks acquired on an object is required.</span></span> <span data-ttu-id="a5bd4-1663">Эти указания имеют приоритет относительно текущего уровня изоляции транзакций в сеансе.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1663">These locking hints override the current transaction isolation level for the session.</span></span>  
  
 <span data-ttu-id="a5bd4-1664">Дополнительные сведения о конкретных указаниях блокировок и их поведении см. в разделе [Указания таблиц (Transact-SQL)](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1664">For more information about the specific locking hints and their behaviors, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1665">Оптимизатор запросов компонента [!INCLUDE[ssDE](../includes/ssde-md.md)] почти всегда выбирает оптимальный уровень блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1665">The [!INCLUDE[ssDE](../includes/ssde-md.md)] query optimizer almost always chooses the correct locking level.</span></span> <span data-ttu-id="a5bd4-1666">Для изменения блокировок по умолчанию указания блокировок на уровне таблицы рекомендуется использовать только при необходимости.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1666">We recommend that table-level locking hints be used to change the default locking behavior only when necessary.</span></span> <span data-ttu-id="a5bd4-1667">Изменение уровня блокировок может неблагоприятно повлиять на параллельную работу пользователей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1667">Disallowing a locking level can adversely affect concurrency.</span></span>  
  
 <span data-ttu-id="a5bd4-1668">Компоненту [!INCLUDE[ssDE](../includes/ssde-md.md)] могут потребоваться блокировки при чтении метаданных, даже при выполнении инструкции SELECT с указанием по блокировке, предотвращающей запросы на блокировки при чтении данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1668">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata, even when processing a select with a locking hint that prevents requests for share locks when reading data.</span></span> <span data-ttu-id="a5bd4-1669">Например, инструкция SELECT с указанием NOLOCK не получает разделяемых блокировок при чтении данных, но иногда может запросить блокировку при чтении представления системного каталога.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1669">For example, a SELECT using the NOLOCK hint does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="a5bd4-1670">Из этого следует, что возможна блокировка инструкции SELECT с указанием NOLOCK.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1670">This means it is possible for a SELECT statement using NOLOCK to be blocked.</span></span>  
  
 <span data-ttu-id="a5bd4-1671">Как показано в следующем примере, если устанавливается уровень изоляции транзакций `SERIALIZABLE` и используется указание блокировки табличного уровня `NOLOCK` в инструкции `SELECT`, то блокировки диапазонов значений ключа, обычно используемые для обеспечения сериализуемости транзакций, не получаются.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1671">As shown in the following example, if the transaction isolation level is set to `SERIALIZABLE`, and the table-level locking hint `NOLOCK` is used with the `SELECT` statement, key-range locks typically used to maintain serializable transactions are not taken.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
GO  
SELECT JobTitle  
    FROM HumanResources.Employee WITH (NOLOCK);  
GO  
  
-- Get information about the locks held by   
-- the transaction.  
SELECT    
        resource_type,   
        resource_subtype,   
        request_mode  
    FROM sys.dm_tran_locks  
    WHERE request_session_id = @@spid;  
  
-- End the transaction.  
ROLLBACK;  
GO  
```  
  
 <span data-ttu-id="a5bd4-1672">Единственная получаемая блокировка, ссылающаяся на `HumanResources.Employee`, это блокировка стабильности схемы (Sch-S).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1672">The only lock taken that references `HumanResources.Employee` is a schema stability (Sch-S) lock.</span></span> <span data-ttu-id="a5bd4-1673">В этом случае сериализуемость не гарантируется.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1673">In this case, serializability is no longer guaranteed.</span></span>  
  
 <span data-ttu-id="a5bd4-1674">В [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] параметр LOCK_ESCALATION инструкции ALTER TABLE может вызывать конфликт с блокировками таблицы и разрешить блокировки HoBT для секционированных таблиц.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1674">In [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)], the LOCK_ESCALATION option of ALTER TABLE can disfavor table locks, and enable HoBT locks on partitioned tables.</span></span> <span data-ttu-id="a5bd4-1675">Этот параметр не является указанием блокировки, но позволяет снизить укрупнение блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1675">This option is not a locking hint, but can but used to reduce lock escalation.</span></span> <span data-ttu-id="a5bd4-1676">Дополнительные сведения см. в разделе [ALTER TABLE (Transact-SQL)](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1676">For more information, see [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
###  <a name="customizing-locking-for-an-index"></a><a name="Customize"></a> <span data-ttu-id="a5bd4-1677">Настройка блокировки индекса</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1677">Customizing Locking for an Index</span></span>  

 <span data-ttu-id="a5bd4-1678">Компонент [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] использует механизм динамической блокировки, при которой для большинства запросов выбирается оптимальная степень гранулярности.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1678">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy that automatically chooses the best locking granularity for queries in most cases.</span></span> <span data-ttu-id="a5bd4-1679">Не рекомендуется переопределять уровни блокировки по умолчанию, для которых установлены блокировки страниц и строк, за исключением случаев, когда методы доступа хорошо понятны и постоянны и не приходится решать проблему состязания за получение ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1679">We recommend that you do not override the default locking levels, which have page and row locking on, unless table or index access patterns are well understood and consistent, and there is a resource contention problem to solve.</span></span> <span data-ttu-id="a5bd4-1680">Переопределение уровня блокировки может существенно затруднить параллельный доступ к таблице или индексу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1680">Overriding a locking level can significantly impede concurrent access to a table or index.</span></span> <span data-ttu-id="a5bd4-1681">Например, задание только блокировок на уровне таблицы для крупной таблицы, к которой обращается большое количество пользователей, может привести к возникновению узких мест, так как пользователям придется ждать снятия блокировки на уровне таблицы перед доступом к таблице.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1681">For example, specifying only table-level locks on a large table that users access heavily can cause bottlenecks because users must wait for the table-level lock to be released before accessing the table.</span></span>  
  
 <span data-ttu-id="a5bd4-1682">В некоторых случаях запрет блокировки страниц или строк может быть полезным, если методы доступа хорошо понятны и согласованы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1682">There are a few cases where disallowing page or row locking can be beneficial, if the access patterns are well understood and consistent.</span></span> <span data-ttu-id="a5bd4-1683">Допустим, приложение базы данных использует таблицу уточняющих запросов, которая еженедельно обновляется в ходе пакетной обработки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1683">For example, a database application uses a lookup table that is updated weekly in a batch process.</span></span> <span data-ttu-id="a5bd4-1684">Параллельные обращения агентов чтения к таблице выполняются с совмещаемой блокировкой (S), а еженедельное пакетное обновление получает доступ к таблице с монопольной блокировкой (X).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1684">Concurrent readers access the table with a shared (S) lock and the weekly batch update accesses the table with an exclusive (X) lock.</span></span> <span data-ttu-id="a5bd4-1685">Отключение блокировки строк или страниц в таблице уменьшает затраты ресурсов на управление блокировками в течение недели благодаря возможности параллельного доступа агентов чтения через общие блокировки таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1685">Turning off page and row locking on the table reduces the locking overhead throughout the week by allowing readers to concurrently access the table through shared table locks.</span></span> <span data-ttu-id="a5bd4-1686">При выполнении пакетного задания обновление может быть проведено более эффективно, так как ему предоставляется монопольная блокировка таблицы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1686">When the batch job runs, it can complete the update efficiently because it obtains an exclusive table lock.</span></span>  
  
 <span data-ttu-id="a5bd4-1687">Отключение блокировки страниц и строк может быть как приемлемым, так и нет, поскольку еженедельное пакетное обновление будет запрещать параллельные обращения агентов чтения к таблице в процессе обновления.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1687">Turning off page and row locking might or might not be acceptable because the weekly batch update will block the concurrent readers from accessing the table while the update runs.</span></span> <span data-ttu-id="a5bd4-1688">Если пакетное задание изменяет только строки или страницы, можно изменить уровень блокировки, чтобы разрешить блокировку на уровне строк и страниц, что позволит другим сеансам выполнять чтение из таблицы без блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1688">If the batch job only changes a few rows or pages, you can change the locking level to allow row or page level locking, which will enable other sessions to read from the table without blocking.</span></span> <span data-ttu-id="a5bd4-1689">Если в пакетном задании имеется большое количество обновлений, получение монопольной блокировки на таблицу может быть самым эффективным способом завершения пакетного задания.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1689">If the batch job has a large number of updates, obtaining an exclusive lock on the table may be the best way to ensure the batch job finishes efficiently.</span></span>  
  
 <span data-ttu-id="a5bd4-1690">Иногда взаимоблокировка возникает, когда две параллельные операции накладывают блокировки на уровне строк в одной таблице, а затем взаимоблокируются, так как обеим нужно блокировать страницу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1690">Occasionally a deadlock occurs when two concurrent operations acquire row locks on the same table and then block because they both need to lock the page.</span></span> <span data-ttu-id="a5bd4-1691">Запрет блокировок на уровне строк вынуждает одну из операций ждать, что позволяет избежать взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1691">Disallowing row locks forces one of the operations to wait, avoiding the deadlock.</span></span>  
  
 <span data-ttu-id="a5bd4-1692">Степень гранулярности блокировок индекса настраивается при помощи инструкций CREATE INDEX и ALTER INDEX.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1692">The granularity of locking used on an index can be set using the CREATE INDEX and ALTER INDEX statements.</span></span> <span data-ttu-id="a5bd4-1693">Настройки блокировок применяются как к страницам индекса, так и к страницам таблиц.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1693">The lock settings apply to both the index pages and the table pages.</span></span> <span data-ttu-id="a5bd4-1694">Ее можно настроить в ограничениях PRIMARY KEY и UNIQUE инструкций CREATE TABLE и ALTER TABLE.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1694">In addition, the CREATE TABLE and ALTER TABLE statements can be used to set locking granularity on PRIMARY KEY and UNIQUE constraints.</span></span> <span data-ttu-id="a5bd4-1695">Для обеспечения обратной совместимости **sp_indexoption** системная хранимая процедура также может задавать гранулярность.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1695">For backwards compatibility, the **sp_indexoption** system stored procedure can also set the granularity.</span></span> <span data-ttu-id="a5bd4-1696">Текущее значение параметра для заданного индекса можно узнать при помощи функции INDEXPROPERTY.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1696">To display the current locking option for a given index, use the INDEXPROPERTY function.</span></span> <span data-ttu-id="a5bd4-1697">Для любого индекса можно запретить блокировку страниц, блокировку строк или их сочетание.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1697">Page-level locks, row-level locks, or a combination of page-level and row-level locks can be disallowed for a given index.</span></span>  
  
|<span data-ttu-id="a5bd4-1698">Запрещенные блокировки</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1698">Disallowed locks</span></span>|<span data-ttu-id="a5bd4-1699">При обращении к индексу используются</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1699">Index accessed by</span></span>|  
|----------------------|-----------------------|  
|<span data-ttu-id="a5bd4-1700">Уровня страниц</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1700">Page level</span></span>|<span data-ttu-id="a5bd4-1701">Блокировки уровня строк и таблиц</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1701">Row-level and table-level locks</span></span>|  
|<span data-ttu-id="a5bd4-1702">Уровня строк</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1702">Row level</span></span>|<span data-ttu-id="a5bd4-1703">Блокировки уровня страниц и таблиц</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1703">Page-level and table-level locks</span></span>|  
|<span data-ttu-id="a5bd4-1704">Уровня строк и страниц</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1704">Page level and row level</span></span>|<span data-ttu-id="a5bd4-1705">Блокировки уровня таблиц</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1705">Table-level locks</span></span>|  
  
 <span data-ttu-id="a5bd4-1706">![Значок стрелки, используемый в ссылке "назад на начало](media/uparrow16x16.gif "Значок стрелки, используемый со ссылкой В начало") " [в этом пошаговом окне](#Top)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1706">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="advanced-transaction-information"></a><a name="Advanced"></a> <span data-ttu-id="a5bd4-1707">Дополнительные сведения о транзакциях</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1707">Advanced Transaction Information</span></span>  
  
### <a name="nesting-transactions"></a><span data-ttu-id="a5bd4-1708">Вложенность транзакций</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1708">Nesting Transactions</span></span>  

 <span data-ttu-id="a5bd4-1709">Явные транзакции могут быть вложенными.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1709">Explicit transactions can be nested.</span></span> <span data-ttu-id="a5bd4-1710">Обычно это используется для поддержки транзакций в хранимых процедурах, которые могут быть вызваны, или из процесса, который уже находится в транзакции, или из процесса, у которого нет активной транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1710">This is primarily intended to support transactions in stored procedures that can be called either from a process already in a transaction or from processes that have no active transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-1711">В следующем примере показано намеренное использование вложенных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1711">The following example shows the intended use of nested transactions.</span></span> <span data-ttu-id="a5bd4-1712">Процедура `TransProc` принудительно создает свою транзакцию, независимо от режима транзакции любого процесса, который ее выполняет.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1712">The procedure `TransProc` enforces its transaction regardless of the transaction mode of any process that executes it.</span></span> <span data-ttu-id="a5bd4-1713">Если процедура `TransProc` вызывается при активной транзакции, вложенная транзакция в `TransProc` в значительной степени не учитываются, и ее инструкции INSERT фиксируются или откатываются, в зависимости от окончательного действия внешней транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1713">If `TransProc` is called when a transaction is active, the nested transaction in `TransProc` is largely ignored, and its INSERT statements are committed or rolled back based on the final action taken for the outer transaction.</span></span> <span data-ttu-id="a5bd4-1714">Если процедура `TransProc` выполняется процессом, не выполняющим отдельную транзакцию, инструкция COMMIT TRANSACTION в конце процедуры фактически фиксирует инструкции INSERT.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1714">If `TransProc` is executed by a process that does not have an outstanding transaction, the COMMIT TRANSACTION at the end of the procedure effectively commits the INSERT statements.</span></span>  
  
```sql  
SET QUOTED_IDENTIFIER OFF;  
GO  
SET NOCOUNT OFF;  
GO  
CREATE TABLE TestTrans(Cola INT PRIMARY KEY,  
               Colb CHAR(3) NOT NULL);  
GO  
CREATE PROCEDURE TransProc @PriKey INT, @CharCol CHAR(3) AS  
BEGIN TRANSACTION InProc  
INSERT INTO TestTrans VALUES (@PriKey, @CharCol)  
INSERT INTO TestTrans VALUES (@PriKey + 1, @CharCol)  
COMMIT TRANSACTION InProc;  
GO  
/* Start a transaction and execute TransProc. */  
BEGIN TRANSACTION OutOfProc;  
GO  
EXEC TransProc 1, 'aaa';  
GO  
/* Roll back the outer transaction, this will  
   roll back TransProc's nested transaction. */  
ROLLBACK TRANSACTION OutOfProc;  
GO  
EXECUTE TransProc 3,'bbb';  
GO  
/* The following SELECT statement shows only rows 3 and 4 are   
   still in the table. This indicates that the commit  
   of the inner transaction from the first EXECUTE statement of  
   TransProc was overridden by the subsequent rollback. */  
SELECT * FROM TestTrans;  
GO  
```  
  
 <span data-ttu-id="a5bd4-1715">Фиксация внутренних транзакций не учитываются компонентом [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1715">Committing inner transactions is ignored by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="a5bd4-1716">Транзакция либо фиксируется, либо откатывается в зависимости от предпринятого действия в конце самой внешней транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1716">The transaction is either committed or rolled back based on the action taken at the end of the outermost transaction.</span></span> <span data-ttu-id="a5bd4-1717">Если внешняя транзакция зафиксирована, внутренние вложенные транзакции также будут зафиксированы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1717">If the outer transaction is committed, the inner nested transactions are also committed.</span></span> <span data-ttu-id="a5bd4-1718">Если внешняя транзакция откатывается, то все внутренние транзакции также будут отменены, независимо от того, были ли отдельные внутренние транзакции зафиксированы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1718">If the outer transaction is rolled back, then all inner transactions are also rolled back, regardless of whether or not the inner transactions were individually committed.</span></span>  
  
 <span data-ttu-id="a5bd4-1719">Каждый вызов инструкций COMMIT TRANSACTION или COMMIT WORK применяется к последней выполненной инструкции BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1719">Each call to COMMIT TRANSACTION or COMMIT WORK applies to the last executed BEGIN TRANSACTION.</span></span> <span data-ttu-id="a5bd4-1720">Если инструкции BEGIN TRANSACTION являются вложенными, то инструкция COMMIT применяется только к последней вложенной транзакции, которая является самой внутренней транзакцией.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1720">If the BEGIN TRANSACTION statements are nested, then a COMMIT statement applies only to the last nested transaction, which is the innermost transaction.</span></span> <span data-ttu-id="a5bd4-1721">Даже если инструкция COMMIT TRANSACTION *transaction_name* в вложенной транзакции ссылается на имя транзакции внешней транзакции, фиксация применяется только к самой внутренней транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1721">Even if a COMMIT TRANSACTION *transaction_name* statement within a nested transaction refers to the transaction name of the outer transaction, the commit applies only to the innermost transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-1722">Параметр *transaction_name* инструкции ROLLBACK TRANSACTION не является допустимым для ссылки на внутренние транзакции набора именованных вложенных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1722">It is not legal for the *transaction_name* parameter of a ROLLBACK TRANSACTION statement to refer to the inner transactions of a set of named nested transactions.</span></span> <span data-ttu-id="a5bd4-1723">*transaction_name* может ссылаться только на имя самой внешней транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1723">*transaction_name* can refer only to the transaction name of the outermost transaction.</span></span> <span data-ttu-id="a5bd4-1724">Если инструкция ROLLBACK TRANSACTION *transaction_name* с именем самой внешней транзакции выполняется на любом уровне набора вложенных транзакций, для всех вложенных транзакций будет выполнен откат.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1724">If a ROLLBACK TRANSACTION *transaction_name* statement using the name of the outer transaction is executed at any level of a set of nested transactions, all of the nested transactions are rolled back.</span></span> <span data-ttu-id="a5bd4-1725">Если инструкция ROLLBACK TRANSACTION или ROLLBACK Statement без параметра *transaction_name* выполняется на любом уровне набора вложенных транзакций, то выполняется откат всех вложенных транзакций, включая внешнюю транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1725">If a ROLLBACK WORK or ROLLBACK TRANSACTION statement without a *transaction_name* parameter is executed at any level of a set of nested transaction, it rolls back all of the nested transactions, including the outermost transaction.</span></span>  
  
 <span data-ttu-id="a5bd4-1726">Функция @ @TRANCOUNT записывает текущий уровень вложенности транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1726">The @@TRANCOUNT function records the current transaction nesting level.</span></span> <span data-ttu-id="a5bd4-1727">Каждая инструкция BEGIN TRANSACTION увеличивает значение @ @TRANCOUNT на единицу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1727">Each BEGIN TRANSACTION statement increments @@TRANCOUNT by one.</span></span> <span data-ttu-id="a5bd4-1728">Каждая инструкция COMMIT TRANSACTION или COMMIT Function уменьшает значение @ @TRANCOUNT на единицу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1728">Each COMMIT TRANSACTION or COMMIT WORK statement decrements @@TRANCOUNT by one.</span></span> <span data-ttu-id="a5bd4-1729">Инструкция ROLLBACK Statement или ROLLBACK TRANSACTION, не имеющая имени транзакции, откатывает все вложенные транзакции и уменьшает @TRANCOUNT значение @ до 0.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1729">A ROLLBACK WORK or a ROLLBACK TRANSACTION statement that does not have a transaction name rolls back all nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="a5bd4-1730">Инструкция ROLLBACK TRANSACTION, использующая имя транзакции внешней транзакции в наборе вложенных транзакций, откатывает все вложенные транзакции и уменьшает @TRANCOUNT значение @ до 0.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1730">A ROLLBACK TRANSACTION that uses the transaction name of the outermost transaction in a set of nested transactions rolls back all of the nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="a5bd4-1731">Если вы не уверены, что вы уже используете транзакцию, выберите параметр @, @TRANCOUNT чтобы определить, является ли он 1 или более.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1731">When you are unsure if you are already in a transaction, SELECT @@TRANCOUNT to determine if it is 1 or more.</span></span> <span data-ttu-id="a5bd4-1732">Если @TRANCOUNT значение @ равно 0, значит, нет транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1732">If @@TRANCOUNT is 0, you are not in a transaction.</span></span>  
  
### <a name="using-bound-sessions"></a><span data-ttu-id="a5bd4-1733">Использование связанных сеансов</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1733">Using Bound Sessions</span></span>  

 <span data-ttu-id="a5bd4-1734">Связанные сеансы упрощают согласование действий в нескольких сеансах на одном и том же сервере.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1734">Bound sessions ease the coordination of actions across multiple sessions on the same server.</span></span> <span data-ttu-id="a5bd4-1735">Связанные сеансы позволяют двум и более сеансам разделять одну и ту же транзакцию и блокировки и могут работать с одними и теми же данными без конфликтов блокировок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1735">Bound sessions allow two or more sessions to share the same transaction and locks, and can work on the same data without lock conflicts.</span></span> <span data-ttu-id="a5bd4-1736">Связанные сеансы могут создаваться из нескольких сеансов внутри одного приложения или из нескольких приложений с отдельными сеансами.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1736">Bound sessions can be created from multiple sessions within the same application or from multiple applications with separate sessions.</span></span>  
  
 <span data-ttu-id="a5bd4-1737">Для участия в связанном сеансе сеанс вызывает **sp_getbindtoken** или **srv_getbindtoken** (с помощью служб Open Data Services) для получения маркера привязки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1737">To participate in a bound session, a session calls **sp_getbindtoken** or **srv_getbindtoken** (through Open Data Services) to get a bind token.</span></span> <span data-ttu-id="a5bd4-1738">Токен привязки является символьной строкой, которая уникальным образом идентифицирует каждую связанную транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1738">A bind token is a character string that uniquely identifies each bound transaction.</span></span> <span data-ttu-id="a5bd4-1739">Затем токен привязки отправляется в другие сеансы с целью быть связанным с текущим сеансом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1739">The bind token is then sent to the other sessions to be bound with the current session.</span></span> <span data-ttu-id="a5bd4-1740">Другие сеансы связываются с транзакцией, вызывая хранимую процедуру **sp_bindsession** и используя токен привязки из первого сеанса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1740">The other sessions bind to the transaction by calling **sp_bindsession**, using the bind token received from the first session.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a5bd4-1741">Для выполнения **sp_getbindtoken** или **srv_getbindtoken** в сеансе должна быть активная пользовательская транзакция.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1741">A session must have an active user transaction in order for **sp_getbindtoken** or **srv_getbindtoken** to succeed.</span></span>  
  
 <span data-ttu-id="a5bd4-1742">Токены привязки должны передаваться из кода приложения, создающего первый сеанс, в код приложения, который последовательно связывает свои сеансы с первым сеансом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1742">Bind tokens must be transmitted from the application code that makes the first session to the application code that subsequently binds their sessions to the first session.</span></span> <span data-ttu-id="a5bd4-1743">Не существует инструкции языка [!INCLUDE[tsql](../includes/tsql-md.md)] или функции API, которую приложение могло бы использовать для получения токена привязки для транзакции, инициализированной другим процессом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1743">There is no [!INCLUDE[tsql](../includes/tsql-md.md)] statement or API function that an application can use to get the bind token for a transaction started by another process.</span></span> <span data-ttu-id="a5bd4-1744">Вот некоторые методы, которые можно использовать для передачи токена привязки:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1744">Some of the methods that can be used to transmit a bind token include the following:</span></span>  
  
-   <span data-ttu-id="a5bd4-1745">Если сеансы инициализируются одним и тем же процессом приложения, то можно хранить токены привязки в памяти глобальных данных или передавать в функции в качестве параметров.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1745">If the sessions are all initiated from the same application process, bind tokens can be stored in global memory or passed into functions as a parameter.</span></span>  
  
-   <span data-ttu-id="a5bd4-1746">Если сеансы инициализируются разными процессами приложения, то можно передавать токены привязки с помощью механизмов межпроцессного взаимодействия (IPC), таких как удаленный вызов процедуры или динамический обмен данными.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1746">If the sessions are made from separate application processes, bind tokens can be transmitted using interprocess communication (IPC), such as a remote procedure call (RPC) or dynamic data exchange (DDE).</span></span>  
  
-   <span data-ttu-id="a5bd4-1747">Токены привязки можно хранить в таблице экземпляра компонента [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]; процессы, связывающиеся с первым сеансом, могут считывать эту таблицу.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1747">Bind tokens can be stored in a table in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] that can be read by processes wanting to bind to the first session.</span></span>  
  
 <span data-ttu-id="a5bd4-1748">Только один связанный сеанс в наборе может быть активен в каждый момент времени.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1748">Only one session in a set of bound sessions can be active at any time.</span></span> <span data-ttu-id="a5bd4-1749">Если один сеанс выполняет инструкцию на экземпляре или ожидает результатов на экземпляре, то никакой другой связанный сеанс не может получить доступ к экземпляру до тех пор, пока первый сеанс не закончит обработку или не отменит текущую инструкцию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1749">If one session is executing a statement on the instance or has results pending from the instance, no other session bound to it can access the instance until the current session finishes processing or cancels the current statement.</span></span> <span data-ttu-id="a5bd4-1750">Если экземпляр занят и находится в процессе обработки инструкции с других связанных сеансов, то возникает ошибка, указывающая на то, что пространство транзакции находится в использовании и сеанс следует повторить позднее.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1750">If the instance is busy processing a statement from another of the bound sessions, an error occurs indicating that the transaction space is in use and the session should retry later.</span></span>  
  
 <span data-ttu-id="a5bd4-1751">При связывании сеансов каждый сеанс сохраняет настройку своего уровня изоляции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1751">When you bind sessions, each session retains its isolation level setting.</span></span> <span data-ttu-id="a5bd4-1752">Использование инструкции SET TRANSACTION ISOLATION LEVEL для изменения настройки уровня изоляции одного сеанса не влияет на настройки всех связанных с ним сеансов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1752">Using SET TRANSACTION ISOLATION LEVEL to change the isolation level setting of one session does not affect the setting of any other session bound to it.</span></span>  
  
#### <a name="types-of-bound-sessions"></a><span data-ttu-id="a5bd4-1753">Типы связанных сеансов</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1753">Types of Bound Sessions</span></span>  

 <span data-ttu-id="a5bd4-1754">Существует два типа связанных сеансов: локальный и распределенный.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1754">The two types of bound sessions are local and distributed.</span></span>  
  
-   <span data-ttu-id="a5bd4-1755">Локальный связанный сеанс</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1755">Local bound session</span></span>  
  
     <span data-ttu-id="a5bd4-1756">Позволяет связанным сеансам совместно использовать область транзакции одной транзакции одного экземпляра компонента [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1756">Allows bound sessions to share the transaction space of a single transaction in a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span>  
  
-   <span data-ttu-id="a5bd4-1757">Распределенный связанный сеанс</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1757">Distributed bound session</span></span>  
  
     <span data-ttu-id="a5bd4-1758">Позволяет связанным сеансам совместно использовать одну и ту же транзакцию в двух или более экземплярах до тех пор, пока вся транзакция не будет зафиксирована или откатана с использованием координатора распределенных транзакций ([!INCLUDE[msCoName](../includes/msconame-md.md)]) (MS DTC).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1758">Allows bound sessions to share the same transaction across two or more instances until the entire transaction is either committed or rolled back by using [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC).</span></span>  
  
 <span data-ttu-id="a5bd4-1759">Распределенные связанные сеансы не идентифицируются символьной строкой связывающего токена, они идентифицируются номерами идентификации для распределенных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1759">Distributed bound sessions are not identified by a character string bind token; they are identified by distributed transaction identification numbers.</span></span> <span data-ttu-id="a5bd4-1760">Если связанный сеанс входит в локальную транзакцию и выполняет вызов удаленной процедуры на удаленном сервере и при этом параметр SET REMOTE_PROC_TRANSACTIONS включен, то локальная связанная транзакция автоматически продвигается до распределенной связанной транзакции координатором распределенных транзакций (MS DTC) и начинается сеанс (MS DTC).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1760">If a bound session is involved in a local transaction and executes an RPC on a remote server with SET REMOTE_PROC_TRANSACTIONS ON, the local bound transaction is automatically promoted to a distributed bound transaction by MS DTC and an MS DTC session is started.</span></span>  
  
#### <a name="when-to-use-bound-sessions"></a><span data-ttu-id="a5bd4-1761">Когда использовать связанные сеансы</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1761">When to Use Bound Sessions</span></span>  

 <span data-ttu-id="a5bd4-1762">В более ранних версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] связанные сеансы в основном использовались в разработке расширенных хранимых процедур, которые должны выполнять инструкции языка [!INCLUDE[tsql](../includes/tsql-md.md)] от имени вызывающего их процесса.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1762">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], bound sessions were primarily used in developing extended stored procedures that must execute [!INCLUDE[tsql](../includes/tsql-md.md)] statements on behalf of the process that calls them.</span></span> <span data-ttu-id="a5bd4-1763">Передача вызывающего процесса в виде токена привязки в параметре расширенной хранимой процедуры позволяет процедуре присоединять область транзакции вызывающего процесса, соединяя таким образом хранимую процедуру с вызывающим процессом.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1763">Having the calling process pass in a bind token as one parameter of the extended stored procedure allows the procedure to join the transaction space of the calling process, thereby integrating the extended stored procedure with the calling process.</span></span>  
  
 <span data-ttu-id="a5bd4-1764">В компоненте [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] хранимые процедуры CLR более безопасны, масштабируемы и устойчивы, чем расширенные хранимые процедуры.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1764">In the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], stored procedures written using CLR are more secure, scalable, and stable than extended stored procedures.</span></span> <span data-ttu-id="a5bd4-1765">Хранимые процедуры CLR используют объект **SqlContext** для объединения контекста вызывающего сеанса, а не **sp_bindsession**.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1765">CLR-stored procedures use the **SqlContext** object to join the context of the calling session, not **sp_bindsession**.</span></span>  
  
 <span data-ttu-id="a5bd4-1766">Связанные сеансы можно использовать для построения трехзвенных приложений, в которых бизнес-логика разделена на отдельные программы, которые работают вместе на одной бизнес-транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1766">Bound sessions can be used to develop three-tier applications in which business logic is incorporated into separate programs that work cooperatively on a single business transaction.</span></span> <span data-ttu-id="a5bd4-1767">В коде этих программ должен быть тщательно согласован доступ к базе данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1767">These programs must be coded to carefully coordinate their access to a database.</span></span> <span data-ttu-id="a5bd4-1768">Так как два сеанса совместно используют одни и те же блокировки, две программы не должны одновременно пытаться модифицировать одни и те же данные.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1768">Because the two sessions share the same locks, the two programs must not try to modify the same data at the same time.</span></span> <span data-ttu-id="a5bd4-1769">В каждый момент времени только один сеанс может выполнять работу, являющуюся частью транзакции; недопустимо параллельное выполнение.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1769">At any point in time, only one session can be doing work as part of the transaction; there can be no parallel execution.</span></span> <span data-ttu-id="a5bd4-1770">Переключение транзакции между сеансами возможно только в определенных точках выхода, например, когда завершены DML-инструкции и восстановлены их результаты.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1770">The transaction can only be switched between sessions at well-defined yield points, such as when all DML statements have completed and their results have been retrieved.</span></span>  
  
### <a name="coding-efficient-transactions"></a><span data-ttu-id="a5bd4-1771">Кодирование эффективных транзакций</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1771">Coding Efficient Transactions</span></span>  

 <span data-ttu-id="a5bd4-1772">Важно, чтобы транзакции были как можно более короткими.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1772">It is important to keep transactions as short as possible.</span></span> <span data-ttu-id="a5bd4-1773">После открытия транзакции система управления базой данных (СУБД) удерживает до ее окончания большое количество ресурсов, обеспечивающих ее целостность, согласованность, изоляцию и устойчивость (atomicity, consistency, isolation, durability — ACID).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1773">When a transaction is started, a database management system (DBMS) must hold many resources until the end of the transaction to protect the atomicity, consistency, isolation, and durability (ACID) properties of the transaction.</span></span> <span data-ttu-id="a5bd4-1774">При изменении данных соответствующие строки необходимо защищать монопольными блокировками, чтобы предотвратить их считывание другими транзакциями, и эти монопольные блокировки должны удерживаться до фиксации или отката транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1774">If data is modified, the modified rows must be protected with exclusive locks that prevent any other transaction from reading the rows, and exclusive locks must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="a5bd4-1775">В зависимости от установки параметров уровня изоляции транзакции для выполнения инструкций SELECT могут потребоваться блокировки, которые необходимо удерживать до окончания или отката транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1775">Depending on transaction isolation level settings, SELECT statements may acquire locks that must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="a5bd4-1776">В целях сокращения числа состязаний за ресурсы при одновременной работе пользователей, особенно в многопользовательских системах, транзакции должны быть как можно более короткими.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1776">Especially in systems with many users, transactions must be kept as short as possible to reduce locking contention for resources between concurrent connections.</span></span> <span data-ttu-id="a5bd4-1777">Длительные неэффективные транзакции могут без проблем работать при небольшом количестве пользователей, но могут создавать совершенно недопустимую нагрузку в системах, где одновременно работают тысячи пользователей.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1777">Long-running, inefficient transactions may not be a problem with small numbers of users, but they are intolerable in a system with thousands of users.</span></span> <span data-ttu-id="a5bd4-1778">С версии [!INCLUDE[ssSQL14](../includes/sssql14-md.md)][!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] поддерживает отложенные устойчивые транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1778">Beginning with [!INCLUDE[ssSQL14](../includes/sssql14-md.md)][!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] supports delayed durable transactions.</span></span> <span data-ttu-id="a5bd4-1779">Для отложенных устойчивых транзакций устойчивость не гарантирована.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1779">Delayed durable transactions do not guarantee durability.</span></span> <span data-ttu-id="a5bd4-1780">См. дополнительные сведения в разделе [Устойчивость транзакций](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1780">See the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md) for more information.</span></span>  
  
#### <a name="coding-guidelines"></a><span data-ttu-id="a5bd4-1781">Рекомендации по кодированию</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1781">Coding Guidelines</span></span>  

 <span data-ttu-id="a5bd4-1782">Ниже приведены следующие рекомендации по кодированию эффективных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1782">These are guidelines for coding efficient transactions:</span></span>  
  
-   <span data-ttu-id="a5bd4-1783">Во время транзакции не следует запрашивать ввод данных от пользователя.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1783">Do not require input from users during a transaction.</span></span>  
  
     <span data-ttu-id="a5bd4-1784">Все необходимые входные данные следует получить от пользователя до начала транзакции.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1784">Get all required input from users before a transaction is started.</span></span> <span data-ttu-id="a5bd4-1785">Если в течение транзакции требуются дополнительные входные данные от пользователя, произведите откат текущей транзакции и запустите ее снова после того, как они будут получены.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1785">If additional user input is required during a transaction, roll back the current transaction and restart the transaction after the user input is supplied.</span></span> <span data-ttu-id="a5bd4-1786">Даже если пользователь реагирует немедленно, время человеческой реакции несоизмеримо с вычислительной мощностью компьютера.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1786">Even if users respond immediately, human reaction times are vastly slower than computer speeds.</span></span> <span data-ttu-id="a5bd4-1787">Все ресурсы, занятые транзакцией, удерживаются весьма долгое время, что может привести к проблемам блокировки.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1787">All resources held by the transaction are held for an extremely long time, which has the potential to cause blocking problems.</span></span> <span data-ttu-id="a5bd4-1788">Пока пользователь не ответит на запрос, транзакция будет активной, блокируя важные ресурсы, и такое состояние может продлиться в течение нескольких минут или даже часов.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1788">If users do not respond, the transaction remains active, locking critical resources until they respond, which may not happen for several minutes or even hours.</span></span>  
  
-   <span data-ttu-id="a5bd4-1789">По возможности не следует открывать транзакцию во время просмотра данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1789">Do not open a transaction while browsing through data, if at all possible.</span></span>  
  
     <span data-ttu-id="a5bd4-1790">Транзакцию не следует начинать, пока не завершится предварительный анализ всех данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1790">Transactions should not be started until all preliminary data analysis has been completed.</span></span>  
  
-   <span data-ttu-id="a5bd4-1791">Транзакция должна быть как можно более короткой.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1791">Keep the transaction as short as possible.</span></span>  
  
     <span data-ttu-id="a5bd4-1792">После того как станет известно, какие именно изменения данных необходимо произвести, начните транзакцию, выполните инструкции по модификации данных и немедленно зафиксируйте (или откатите) ее.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1792">After you know the modifications that have to be made, start a transaction, execute the modification statements, and then immediately commit or roll back.</span></span> <span data-ttu-id="a5bd4-1793">Не следует открывать транзакцию раньше, чем это необходимо.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1793">Do not open the transaction before it is required.</span></span>  
  
-   <span data-ttu-id="a5bd4-1794">Для снижения вероятности блокировок следует рассмотреть использование уровней изоляции, основанных на управлении версиями строк, в отношении запросов только для чтения.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1794">To reduce blocking, consider using a row versioning-based isolation level for read-only queries.</span></span>  
  
-   <span data-ttu-id="a5bd4-1795">Избирательно используйте более низкие уровни изоляции транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1795">Make intelligent use of lower transaction isolation levels.</span></span>  
  
     <span data-ttu-id="a5bd4-1796">Многие приложения практически не требуют дополнительного кодирования при использовании уровня изоляции транзакции READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1796">Many applications can be readily coded to use a read-committed transaction isolation level.</span></span> <span data-ttu-id="a5bd4-1797">Уровень изоляции сериализуемой транзакции требуется не для всех транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1797">Not all transactions require the serializable transaction isolation level.</span></span>  
  
-   <span data-ttu-id="a5bd4-1798">Избирательно используйте более низкую степень параллелизма курсоров, например оптимистичный параллелизм.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1798">Make intelligent use of lower cursor concurrency options, such as optimistic concurrency options.</span></span>  
  
     <span data-ttu-id="a5bd4-1799">В системе с низкой вероятностью одновременных обновлений дополнительная нагрузка, вызванная возникающей время от времени ситуацией типа «кто-то изменил мои данные после того, как я их считал», может оказаться гораздо ниже, нежели дополнительная нагрузка от постоянного блокирования строк по мере их считывания.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1799">In a system with a low probability of concurrent updates, the overhead of dealing with an occasional "somebody else changed your data after you read it" error can be much lower than the overhead of always locking rows as they are read.</span></span>  
  
-   <span data-ttu-id="a5bd4-1800">Во время транзакции следует производить доступ к как можно меньшему объему данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1800">Access the least amount of data possible while in a transaction.</span></span>  
  
     <span data-ttu-id="a5bd4-1801">Это уменьшает количество блокируемых строк, снижая таким образом состязания между транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1801">This lessens the number of locked rows, thereby reducing contention between transactions.</span></span>  
  
#### <a name="avoiding-concurrency-and-resource-problems"></a><span data-ttu-id="a5bd4-1802">Как избежать проблем параллелизма и нехватки ресурсов</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1802">Avoiding Concurrency and Resource Problems</span></span>  

 <span data-ttu-id="a5bd4-1803">Для предотвращения проблем параллелизма и нехватки ресурсов следует аккуратно обращаться с неявными транзакциями.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1803">To prevent concurrency and resource problems, manage implicit transactions carefully.</span></span> <span data-ttu-id="a5bd4-1804">При использовании неявных транзакций инструкция [!INCLUDE[tsql](../includes/tsql-md.md)], следующая за COMMIT или ROLLBACK, автоматически запускает новую транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1804">When using implicit transactions, the next [!INCLUDE[tsql](../includes/tsql-md.md)] statement after COMMIT or ROLLBACK automatically starts a new transaction.</span></span> <span data-ttu-id="a5bd4-1805">Это может привести к тому, что новая транзакция будет открыта во время просмотра данных пользователем или даже тогда, когда у пользователя запрашивается ввод данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1805">This can cause a new transaction to be opened while the application browses through data, or even when it requires input from the user.</span></span> <span data-ttu-id="a5bd4-1806">После завершения последней транзакции, необходимой для защиты изменения данных, следует выключить неявные транзакции до тех пор, пока они снова не понадобятся.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1806">After completing the last transaction required to protect data modifications, turn off implicit transactions until a transaction is once again required to protect data modifications.</span></span> <span data-ttu-id="a5bd4-1807">Это позволяет [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] использовать режим автофиксации, пока приложение просматривает или запрашивает данные от пользователя.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1807">This process lets the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] use autocommit mode while the application is browsing data and getting input from the user.</span></span>  
  
 <span data-ttu-id="a5bd4-1808">Кроме того, когда включен уровень изоляции моментального снимка, то, даже если новая транзакция не будет удерживать блокировки, длительная транзакция предотвращает удаление старых версий из временной базы данных `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1808">In addition, when the snapshot isolation level is enabled, although a new transaction will not hold locks, a long-running transaction will prevent the old versions from being removed from `tempdb`.</span></span>  
  
### <a name="managing-long-running-transactions"></a><span data-ttu-id="a5bd4-1809">Управление длительными транзакциями</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1809">Managing Long-Running Transactions</span></span>  

 <span data-ttu-id="a5bd4-1810">*Длительная транзакция* — это активная транзакция, которая не была зафиксирована или для которой не совершен откат в допустимый срок.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1810">A *long-running transaction* is an active transaction that has not been committed or roll backed the transaction in a timely manner.</span></span> <span data-ttu-id="a5bd4-1811">Например, если запуском и завершением транзакции управляет пользователь, то типичной причиной возникновения длительной транзакции служит отсутствие пользователя после начала транзакции, в то время как для продолжения транзакции требуется его участие.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1811">For example, if the beginning and end of a transaction is controlled by the user, a typical cause of a long-running transaction is a user starting a transaction and then leaving while the transaction waits for a response from the user.</span></span>  
  
 <span data-ttu-id="a5bd4-1812">Длительная транзакция может стать причиной следующих серьезных проблем для базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1812">A long running transaction can cause serious problems for a database, as follows:</span></span>  
  
-   <span data-ttu-id="a5bd4-1813">Если работа экземпляра сервера завершается после того, как активная транзакция выполнила много незафиксированных изменений, этап восстановления последующего перезапуска может занять гораздо больше времени, чем указано в параметре конфигурации сервера **Recovery Interval** или ALTER DATABASE... Задайте параметр TARGET_RECOVERY_TIME.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1813">If a server instance is shut down after an active transaction has performed many uncommitted modifications, the recovery phase of the subsequent restart can take much longer than the time specified by the **recovery interval** server configuration option or by the ALTER DATABASE... SET TARGET_RECOVERY_TIME option.</span></span> <span data-ttu-id="a5bd4-1814">Эти параметры управляют частотой активных и косвенных контрольных точек соответственно.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1814">These options control the frequency of active and indirect checkpoints, respectively.</span></span> <span data-ttu-id="a5bd4-1815">Дополнительные сведения о типах контрольных точек см. в статье [Контрольные точки базы данных (SQL Server)](../relational-databases/logs/database-checkpoints-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1815">For more information about the types of checkpoints, see [Database Checkpoints &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span></span>  
  
-   <span data-ttu-id="a5bd4-1816">Более того, хотя ожидающая транзакция может сформировать очень маленькую запись журнала, она задерживает усечение журнала на неограниченное время, что приводит к увеличению и возможному заполнению журнала транзакций.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1816">More importantly, although a waiting transaction might generate very little log, it holds up log truncation indefinitely, causing the transaction log to grow and possibly fill up.</span></span> <span data-ttu-id="a5bd4-1817">Если журнал транзакций заполняется, база данных не может больше обновляться.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1817">If the transaction log fills up, the database cannot perform any more updates.</span></span> <span data-ttu-id="a5bd4-1818">Дополнительные сведения см. в статьях [Устранение неполадок с полным журналом транзакций &#40;SQL Server ошибка 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md), а [&#40;журнала транзакций SQL Server ](../relational-databases/logs/the-transaction-log-sql-server.md)&#41;.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1818">For more information, see [Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md), and [The Transaction Log &#40;SQL Server&#41;](../relational-databases/logs/the-transaction-log-sql-server.md).</span></span>  
  
#### <a name="discovering-long-running-transactions"></a><span data-ttu-id="a5bd4-1819">Обнаружение длительных транзакций</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1819">Discovering Long-Running Transactions</span></span>  

 <span data-ttu-id="a5bd4-1820">Длительные транзакции можно обнаружить следующими способами:</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1820">To look for long-running transactions, use one of the following:</span></span>  
  
-   <span data-ttu-id="a5bd4-1821">**sys.dm_tran_database_transactions**</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1821">**sys.dm_tran_database_transactions**</span></span>  
  
     <span data-ttu-id="a5bd4-1822">Данное динамическое административное представление возвращает сведения о транзакциях на уровне базы данных.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1822">This dynamic management view returns information about transactions at the database level.</span></span> <span data-ttu-id="a5bd4-1823">Столбцы этого представления содержат сведения о времени первой записи журнала (**database_transaction_begin_time**), текущем состоянии транзакции (**database_transaction_state**) и регистрационном номере (LSN) первой записи в журнале транзакций (**database_transaction_begin_lsn**).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1823">For a long-running transaction, columns of particular interest include the time of the first log record (**database_transaction_begin_time**), the current state of the transaction (**database_transaction_state**), and the log sequence number (LSN) of the begin record in the transaction log (**database_transaction_begin_lsn**).</span></span>  
  
     <span data-ttu-id="a5bd4-1824">Дополнительные сведения см. в разделе [sys.dm_tran_database_transactions (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1824">For more information, see [sys.dm_tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span></span>  
  
-   <span data-ttu-id="a5bd4-1825">DBCC OPENTRAN</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1825">DBCC OPENTRAN</span></span>  
  
     <span data-ttu-id="a5bd4-1826">Эта инструкция позволяет установить идентификатор владельца транзакции, таким образом, можно отследить источник транзакции для более упорядоченной остановки (фиксацией, а не откатом).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1826">This statement lets you identify the user ID of the owner of the transaction, so you can potentially track down the source of the transaction for a more orderly termination (committing it rather than rolling it back).</span></span> <span data-ttu-id="a5bd4-1827">Дополнительные сведения см. в разделе [DBCC OPENTRAN (Transact-SQL)](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1827">For more information, see [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span></span>  
  
#### <a name="stopping-a-transaction"></a><span data-ttu-id="a5bd4-1828">Остановка транзакции</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1828">Stopping a Transaction</span></span>  

 <span data-ttu-id="a5bd4-1829">Может потребоваться применить инструкцию KILL.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1829">You may have to use the KILL statement.</span></span> <span data-ttu-id="a5bd4-1830">Ее следует использовать с осторожностью, особенно если запущены критические процессы.</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1830">Use this statement very carefully, however, especially when critical processes are running.</span></span> <span data-ttu-id="a5bd4-1831">Дополнительные сведения см. в разделе [KILL (Transact-SQL)](/sql/t-sql/language-elements/kill-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1831">For more information, see [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span></span>  
  
 <span data-ttu-id="a5bd4-1832">![Значок стрелки, используемый в ссылке "назад на начало](media/uparrow16x16.gif "Значок стрелки, используемый со ссылкой В начало") " [в этом пошаговом окне](#Top)</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1832">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a5bd4-1833">См. также</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1833">See Also</span></span>  

 <span data-ttu-id="a5bd4-1834">[Изоляция транзакций на основе управления версиями строк в SQL Server 2005](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span><span class="sxs-lookup"><span data-stu-id="a5bd4-1834">[SQL Server 2005 Row Versioning-Based Transaction Isolation](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span></span>  
 <span data-ttu-id="a5bd4-1835">[Издержки управления версиями строк](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span><span class="sxs-lookup"><span data-stu-id="a5bd4-1835">[Overhead of Row Versioning](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span></span>  
 [<span data-ttu-id="a5bd4-1836">Создание автономных транзакций в SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="a5bd4-1836">How to create an autonomous transaction in SQL Server 2008</span></span>](https://blogs.msdn.com/b/sqlprogrammability/archive/2008/08/22/how-to-create-an-autonomous-transaction-in-sql-server-2008.aspx)  
  
  
