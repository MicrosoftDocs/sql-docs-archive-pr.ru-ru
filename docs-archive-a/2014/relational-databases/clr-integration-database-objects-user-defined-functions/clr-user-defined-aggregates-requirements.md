---
title: Требования к определяемым пользователем агрегатам CLR | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- aggregate functions [CLR integration]
- user-defined types [CLR integration], user-defined aggregates
- CREATE AGGREGATE statement
- SqlUserDefinedAggregate attribute
- aggregate methods [CLR integration]
- assemblies [CLR integration], user-defined aggregate functions
- custom aggregates [CLR integration]
- user-defined functions [CLR integration]
- UDTs [CLR integration], user-defined aggregates
ms.assetid: dbf9eb5a-bd99-42f7-b275-556d0def045d
author: rothja
ms.author: jroth
ms.openlocfilehash: 8123f8324d43212007857dbb596a4fc61872bd2e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87664949"
---
# <a name="requirements-for-clr-user-defined-aggregates"></a><span data-ttu-id="a8d8e-102">Требования для определяемых пользователем статистических функций CLR</span><span class="sxs-lookup"><span data-stu-id="a8d8e-102">Requirements for CLR User-Defined Aggregates</span></span>
  <span data-ttu-id="a8d8e-103">Тип в сборке CLR можно зарегистрировать как определяемую пользователем агрегатную функцию, если он реализует необходимую статистическую обработку.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-103">A type in a common language runtime (CLR) assembly can be registered as a user-defined aggregate function, as long as it implements the required aggregation contract.</span></span> <span data-ttu-id="a8d8e-104">Такой контракт состоит из атрибута `SqlUserDefinedAggregate` и методов статистического контракта.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-104">This contract consists of the `SqlUserDefinedAggregate` attribute and the aggregation contract methods.</span></span> <span data-ttu-id="a8d8e-105">Контракт статистической обработки включает механизм сохранения промежуточного состояния агрегата и механизм для накопления новых значений, который состоит из четырех методов: `Init` , `Accumulate` , `Merge` и `Terminate` .</span><span class="sxs-lookup"><span data-stu-id="a8d8e-105">The aggregation contract includes the mechanism to save the intermediate state of the aggregation, and the mechanism to accumulate new values, which consists of four methods: `Init`, `Accumulate`, `Merge`, and `Terminate`.</span></span> <span data-ttu-id="a8d8e-106">Если вы удовлетворены этими требованиями, вы сможете использовать все преимущества определяемых пользователем статистических функций в [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="a8d8e-106">When you have met these requirements, you will be able to take full advantage of user-defined aggregates in [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a8d8e-107">В следующих подразделах этого раздела содержатся подробные сведения о создании определяемых пользователем статистических функций и работе с ними.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-107">The following sections of this topic provide additional details about how to create and work with user-defined aggregates.</span></span> <span data-ttu-id="a8d8e-108">Пример см. в разделе [Вызов определяемых пользователем агрегатных функций CLR](clr-user-defined-aggregate-invoking-functions.md).</span><span class="sxs-lookup"><span data-stu-id="a8d8e-108">For an example, see [Invoking CLR User-Defined Aggregate Functions](clr-user-defined-aggregate-invoking-functions.md).</span></span>  
  
## <a name="sqluserdefinedaggregate"></a><span data-ttu-id="a8d8e-109">SqlUserDefinedAggregate</span><span class="sxs-lookup"><span data-stu-id="a8d8e-109">SqlUserDefinedAggregate</span></span>  
 <span data-ttu-id="a8d8e-110">Дополнительные сведения см. в разделе [склусердефинедаггрегатеаттрибуте](https://go.microsoft.com/fwlink/?LinkId=124626).</span><span class="sxs-lookup"><span data-stu-id="a8d8e-110">For more information, see [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span></span>  
  
## <a name="aggregation-methods"></a><span data-ttu-id="a8d8e-111">Методы статистической обработки</span><span class="sxs-lookup"><span data-stu-id="a8d8e-111">Aggregation Methods</span></span>  
 <span data-ttu-id="a8d8e-112">Класс, зарегистрированный как определяемая пользователем статистическая функция, должен поддерживать следующие методы экземпляра.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-112">The class registered as a user-defined aggregate should support the following instance methods.</span></span> <span data-ttu-id="a8d8e-113">Это методы, которые использует обработчик запросов для выполнения статистической обработки.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-113">These are the methods that the query processor uses to compute the aggregation:</span></span>  
  
|<span data-ttu-id="a8d8e-114">Метод</span><span class="sxs-lookup"><span data-stu-id="a8d8e-114">Method</span></span>|<span data-ttu-id="a8d8e-115">Синтаксис</span><span class="sxs-lookup"><span data-stu-id="a8d8e-115">Syntax</span></span>|<span data-ttu-id="a8d8e-116">Описание</span><span class="sxs-lookup"><span data-stu-id="a8d8e-116">Description</span></span>|  
|------------|------------|-----------------|  
|`Init`|<span data-ttu-id="a8d8e-117">Public void init ();</span><span class="sxs-lookup"><span data-stu-id="a8d8e-117">public void Init();</span></span>|<span data-ttu-id="a8d8e-118">Обработчик запросов использует данный метод для инициализации вычисления статистической обработки.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-118">The query processor uses this method to initialize the computation of the aggregation.</span></span> <span data-ttu-id="a8d8e-119">Этот метод вызывается один раз для каждой группы, которую обработчик запросов подвергает статистической обработке.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-119">This method is invoked once for each group that the query processor is aggregating.</span></span> <span data-ttu-id="a8d8e-120">Обработчик запросов может выбрать повторное использование одного экземпляра класса статистической функции для выполнения статистической обработки нескольких групп.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-120">The query processor may choose to reuse the same instance of the aggregate class for computing aggregates of multiple groups.</span></span> <span data-ttu-id="a8d8e-121">Метод `Init` должен выполнять всю необходимую очистку прежнего использования экземпляра и запускать новые статистические вычисления.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-121">The `Init` method should perform any clean-up as necessary from previous uses of this instance, and enable it to re-start a new aggregate computation.</span></span>|  
|`Accumulate`|<span data-ttu-id="a8d8e-122">Public void accumulate (ввод-тип значение [, значение типа входных данных,...]);</span><span class="sxs-lookup"><span data-stu-id="a8d8e-122">public void Accumulate ( input-type value[, input-type value, ...]);</span></span>|<span data-ttu-id="a8d8e-123">Один или несколько параметров, представляющих аргументы функции.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-123">One or more parameters representing the parameters of the function.</span></span> <span data-ttu-id="a8d8e-124">*input_type* должен быть управляемым [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] типом данных, эквивалентным собственному [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] типу данных, заданному *input_sqltype* в `CREATE AGGREGATE` инструкции.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-124">*input_type* should be the managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type equivalent to the native [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type specified by *input_sqltype* in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="a8d8e-125">Дополнительные сведения см. в разделе [сопоставление данных параметров CLR](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span><span class="sxs-lookup"><span data-stu-id="a8d8e-125">For more information, see [Mapping CLR Parameter Data](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span></span><br /><br /> <span data-ttu-id="a8d8e-126">Для определяемых пользователем типов входной тип аналогичен определяемому пользователем типу.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-126">For user-defined types (UDTs), the input-type is the same as the UDT type.</span></span> <span data-ttu-id="a8d8e-127">Обработчик запросов использует этот метод для накопления статистических значений.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-127">The query processor uses this method to accumulate the aggregate values.</span></span> <span data-ttu-id="a8d8e-128">Метод вызывается один раз для каждого значения группы, в которой выполняется статистическая обработка.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-128">This is invoked once for each value in the group that is being aggregated.</span></span> <span data-ttu-id="a8d8e-129">Обработчик запросов всегда вызывает его только после вызова метода `Init` в данном экземпляре статистического класса.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-129">The query processor always calls this only after calling the `Init` method on the given instance of the aggregate-class.</span></span> <span data-ttu-id="a8d8e-130">Реализация данного метода должна обновить состояние экземпляра, чтобы отразить накопление передаваемого значения аргумента.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-130">The implementation of this method should update the state of the instance to reflect the accumulation of the argument value being passed in.</span></span>|  
|`Merge`|<span data-ttu-id="a8d8e-131">Открытое слияние void (udagg_class значение);</span><span class="sxs-lookup"><span data-stu-id="a8d8e-131">public void Merge( udagg_class value);</span></span>|<span data-ttu-id="a8d8e-132">Метод используется для слияния еще одного экземпляра этого статистического класса с текущим экземпляром.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-132">This method can be used to merge another instance of this aggregate class with the current instance.</span></span> <span data-ttu-id="a8d8e-133">Обработчик запросов использует этот метод для слияния нескольких частичных вычислений статистической обработки.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-133">The query processor uses this method to merge multiple partial computations of an aggregation.</span></span>|  
|`Terminate`|<span data-ttu-id="a8d8e-134">Открытый return_type Terminate ();</span><span class="sxs-lookup"><span data-stu-id="a8d8e-134">public return_type Terminate();</span></span>|<span data-ttu-id="a8d8e-135">Этот метод завершает статистическое вычисление и возвращает результат статистической обработки.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-135">This method completes the aggregate computation and returns the result of the aggregation.</span></span> <span data-ttu-id="a8d8e-136">*Return_type* должен быть управляемым [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] типом данных, который является управляемым эквивалентом *return_sqltype* , указанного в `CREATE AGGREGATE` инструкции.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-136">The *return_type* should be a managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type that is the managed equivalent of *return_sqltype* specified in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="a8d8e-137">*Return_type* также может быть определяемым пользователем типом.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-137">The *return_type* can also be a user-defined type.</span></span>|  
  
### <a name="table-valued-parameters"></a><span data-ttu-id="a8d8e-138">Параметры, возвращающие табличные значения</span><span class="sxs-lookup"><span data-stu-id="a8d8e-138">Table-Valued Parameters</span></span>  
 <span data-ttu-id="a8d8e-139">Возвращающие табличное значение параметры — это определяемые пользователем табличные типы, которые передаются в процедуру или функцию, предоставляя эффективный способ передачи на сервер нескольких строк данных.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-139">Table-valued parameters (TVPs), user-defined table types that are passed into a procedure or function, provide an efficient way to pass multiple rows of data to the server.</span></span> <span data-ttu-id="a8d8e-140">Возвращающие табличное значение параметры выполняют функции, аналогичные массивам параметров, но обладают большей гибкостью и лучше интегрируются с [!INCLUDE[tsql](../../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a8d8e-140">TVPs provide similar functionality to parameter arrays, but offer greater flexibility and closer integration with [!INCLUDE[tsql](../../includes/tsql-md.md)].</span></span> <span data-ttu-id="a8d8e-141">Они также обеспечивают возможность повышения производительности.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-141">They also provide the potential for better performance.</span></span> <span data-ttu-id="a8d8e-142">Кроме того, возвращающие табличное значение параметры способствуют сокращению циклов приема-передачи данных с сервера и на сервер.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-142">TVPs also help reduce the number of round trips to the server.</span></span> <span data-ttu-id="a8d8e-143">Вместо того чтобы отправлять на сервер несколько запросов (как в случае списка скалярных параметров), данные можно отправить в виде возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-143">Instead of sending multiple requests to the server, such as with a list of scalar parameters, data can be sent to the server as a TVP.</span></span> <span data-ttu-id="a8d8e-144">Определяемый пользователем табличный тип нельзя передавать в виде возвращающего табличное значение параметра в управляемую хранимую процедуру или функцию, которая выполняется в процессе [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Кроме того, такие процедуры и функции не могут возвращать определяемые пользователем табличные типы.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-144">A user-defined table type cannot be passed as a table-valued parameter to, or be returned from, a managed stored procedure or function executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process.</span></span> <span data-ttu-id="a8d8e-145">Возвращающие табличное значение параметры также нельзя использовать внутри области контекстного соединения.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-145">Also, TVPs cannot be used within the scope of a context connection.</span></span> <span data-ttu-id="a8d8e-146">Однако возвращающий табличное значение параметр можно использовать с SqlClient в управляемых хранимых процедурах или функциях, выполняемых в процессе [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], если он используется в соединении, отличном от контекстного соединения.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-146">However, a TVP can be used with SqlClient in managed stored procedures or functions executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process, if it is used in a connection that is not a context connection.</span></span> <span data-ttu-id="a8d8e-147">Соединение может быть установлено с тем же сервером, который выполняет управляемую процедуру или функцию.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-147">The connection can be to the same server that is executing the managed procedure or function.</span></span> <span data-ttu-id="a8d8e-148">Дополнительные сведения о TVP см. в разделе [Использование возвращающих табличное значение параметров &#40;ядро СУБД&#41;](../tables/use-table-valued-parameters-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="a8d8e-148">For more information about TVPs, see [Use Table-Valued Parameters &#40;Database Engine&#41;](../tables/use-table-valued-parameters-database-engine.md).</span></span>  
  
## <a name="change-history"></a><span data-ttu-id="a8d8e-149">Журнал изменений</span><span class="sxs-lookup"><span data-stu-id="a8d8e-149">Change History</span></span>  
  
|<span data-ttu-id="a8d8e-150">Обновленное содержимое</span><span class="sxs-lookup"><span data-stu-id="a8d8e-150">Updated content</span></span>|  
|---------------------|  
|<span data-ttu-id="a8d8e-151">Обновлено описание метода `Accumulate`, который теперь принимает несколько параметров.</span><span class="sxs-lookup"><span data-stu-id="a8d8e-151">Updated the description of the `Accumulate` method; it now accepts more than one parameter.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="a8d8e-152">См. также:</span><span class="sxs-lookup"><span data-stu-id="a8d8e-152">See Also</span></span>  
 <span data-ttu-id="a8d8e-153">[Определяемые пользователем типы CLR](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span><span class="sxs-lookup"><span data-stu-id="a8d8e-153">[CLR User-Defined Types](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span></span>  
 [<span data-ttu-id="a8d8e-154">Вызов определяемых пользователем агрегатных функций CLR</span><span class="sxs-lookup"><span data-stu-id="a8d8e-154">Invoking CLR User-Defined Aggregate Functions</span></span>](clr-user-defined-aggregate-invoking-functions.md)  
  
  
