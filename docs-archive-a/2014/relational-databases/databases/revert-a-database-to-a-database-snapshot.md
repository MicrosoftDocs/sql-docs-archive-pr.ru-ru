---
title: Восстановление базы данных из моментального снимка | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- database snapshots [SQL Server], reverting to
- reverting databases
ms.assetid: 8f74dd31-c9ca-4537-8760-0c7648f0787d
author: stevestein
ms.author: sstein
ms.openlocfilehash: 1c78da3d7c559309c0563760e7062f01cf784648
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658806"
---
# <a name="revert-a-database-to-a-database-snapshot"></a>Восстановление базы данных до состояния, сохраненного в моментальном снимке
  При повреждении данных в базе данных в сети в некоторых случаях вместо восстановления базы данных из резервной копии будет уместно восстановить базу данных из моментального снимка базы данных, соответствующего времени, предшествующему повреждению. Например, с помощью возврата базы данных можно устранить такую серьезную недавнюю ошибку пользователя, как удаление таблицы. Однако все изменения данных, внесенные после создания моментального снимка, будут утеряны.  
  
-   **Перед началом работы**  
  
     [Ограничения](#Restrictions)  
  
     [Предварительные требования](#Prerequisites)  
  
     [Безопасность](#Security)  
  
-   **Восстановление базы данных из моментального снимка с помощью**:  [Transact-SQL](#TsqlProcedure)  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> Ограничения  
 Возврат не поддерживается в следующих условиях.  
  
-   У базы данных в текущее время должен быть один моментальный снимок, из которого необходимо возвратить состояние базы.  
  
-   В базе данных имеются доступные только для чтения или сжатые файловые группы.  
  
-   Какие-либо файлы находятся вне сети, хотя были в сети на момент создания снимка.  
  
 Перед тем как выполнять возврат, нужно учитывать следующие ограничения.  
  
-   Возврат не предназначен для восстановления носителей. . Моментальный снимок базы данных — это неполная копия файлов базы данных, поэтому в случае, если база данных или ее снимок будут повреждены, вероятно, возврат к снимку станет невозможным. Кроме того, даже если возврат возможен, в случае повреждения он вряд ли устранит проблему. Таким образом, создание регулярных резервных копий и тестирование плана восстановления абсолютно необходимы для защиты базы данных. Дополнительные сведения см. в разделе [Резервное копирование и восстановление баз данных SQL Server](../backup-restore/back-up-and-restore-of-sql-server-databases.md).  
  
    > [!NOTE]  
    >  Если необходима возможность восстановления базы данных-источника на момент времени, в который был создан моментальный снимок базы данных, используйте модель полного восстановления и реализуйте политику резервного копирования, позволяющую это сделать.  
  
-   Исходная база данных-источник перезаписывается базой данных, к которой выполняется возврат, при этом любые изменения, внесенные в базу данных после создания моментального снимка, будут утеряны.  
  
-   Операция возврата также перезаписывает старый файл журнала и перестраивает журнал. Поэтому выполнить повтор (накат) изменений возвращенной базы данных до момента ошибки пользователя будет невозможно. Вследствие этого рекомендуется создать резервную копию журнала перед возвратом базы данных.  
  
    > [!NOTE]  
    >  Хотя первоначальный журнал невозможно восстановить для наката базы данных, данные из этого файла журнала могут понадобиться при реконструкции потерянных данных.  
  
-   При возврате разрывается цепочка резервных копий журналов. Следовательно, прежде чем можно будет выполнять резервное копирование журналов возвращенной базы данных, необходимо создать полную резервную копию базы данных или файлов. Рекомендуется создать полную резервную копию базы данных.  
  
-   Во время операции возврата моментальный снимок и база данных-источник будут недоступны. База данных-источник и моментальный снимок помечаются как «Восстанавливается». Если во время операции возврата произойдет ошибка, то при следующем запуске базы данных будет предпринята попытка завершить возврат.  
  
-   Метаданные возвращенной базы данных совпадают с метаданными на момент снимка.  
  
-   Операция восстановления удаляет все полнотекстовые каталоги.  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a> Предварительные требования  
 Убедитесь, что исходная база данных и моментальный снимок базы данных удовлетворяют следующим предварительным требованиям.  
  
-   Убедитесь, что база данных не повреждена.  
  
    > [!NOTE]  
    >  Если база данных повреждена, ее необходимо восстановить из резервной копии. Дополнительные сведения см. в разделе [Выполнение полного восстановления базы данных (простая модель восстановления)](../backup-restore/complete-database-restores-simple-recovery-model.md) или [Выполнение полного восстановления базы данных (модель полного восстановления)](../backup-restore/complete-database-restores-full-recovery-model.md).  
  
-   Найдите последний моментальный снимок, созданный до ошибки. Дополнительные сведения см. в разделе [Просмотр моментального снимка базы данных (SQL Server)](view-a-database-snapshot-sql-server.md).  
  
-   Удалите все прочие моментальные снимки, существующие в базе данных. Дополнительные сведения см. в разделе [Удаление моментального снимка базы данных (Transact-SQL)](drop-a-database-snapshot-transact-sql.md).  
  
###  <a name="security"></a><a name="Security"></a> безопасность  
  
####  <a name="permissions"></a><a name="Permissions"></a> Permissions  
 Возвратить базу данных-источник к состоянию на момент создания моментального снимка базы данных может любой пользователь с разрешением RESTORE DATABASE.  
  
##  <a name="how-to-revert-a-database-to-a-database-snapshot-using-transact-sql"></a><a name="TsqlProcedure"></a> Как восстановить базу данных до моментального снимка базы данных (с использованием Transact-SQL)  
 **Восстановление базы данных до состояния, сохраненного в моментальном снимке**  
  
> [!NOTE]  
>  Пример этой процедуры см. в подразделе [Примеры (Transact-SQL)](#TsqlExample)далее в этом разделе.  
  
1.  Выберите моментальный снимок базы данных, до которого ее необходимо восстановить. Просмотреть моментальные снимки базы данных можно в [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] (см. раздел [Просмотр моментального снимка базы данных (SQL Server)](view-a-database-snapshot-sql-server.md)). Также базу данных-источник можно задать с помощью столбца **source_database_id** представления каталога [sys.databases (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-databases-transact-sql) .  
  
2.  Удалите другие моментальные снимки.  
  
     Дополнительные сведения об удалении моментальных снимков см. в разделе [Удаление моментального снимка базы данных (Transact-SQL)](drop-a-database-snapshot-transact-sql.md). Если база данных использует модель полного восстановления, перед тем как выполнять возврат, следует создать резервную копию журнала. Дополнительные сведения см. в разделе [Резервное копирование журнала транзакций (SQL Server)](../backup-restore/back-up-a-transaction-log-sql-server.md) или [Резервное копирование журнала транзакций при повреждении базы данных (SQL Server)](../backup-restore/back-up-the-transaction-log-when-the-database-is-damaged-sql-server.md).  
  
3.  Выполните операцию восстановления.  
  
     Чтобы выполнить операцию восстановления базы данных-источника, необходимо обладать разрешением RESTORE DATABASE. Чтобы восстановить базу данных, необходимо ввести следующую инструкцию Transact-SQL.  
  
     RESTORE DATABASE *database_name* FROM DATABASE_SNAPSHOT **=** _database_snapshot_name_  
  
     где *database_name* — это база данных-источник, а *database_snapshot_name* — имя моментального снимка, к состоянию на момент создания которого необходимо восстановить базу данных. Обратите внимание, что в данной инструкции необходимо задавать имя моментального снимка, а не устройство резервного копирования.  
  
     Дополнительные сведения см. в разделе [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql)невозможно.  
  
    > [!NOTE]  
    >  В процессе выполнения операции восстановления моментальный снимок и база данных-источник являются недоступными. База данных-источник и моментальный снимок помечаются как «Восстанавливаемый». В случае возникновения ошибки в процессе восстановления система попытается продолжить его при следующем запуске базы данных.  
  
4.  В случае смены владельца базы данных после создания ее моментального снимка, возможно, понадобится обновить соответствующую информацию после восстановления.  
  
    > [!NOTE]  
    >  После восстановления в базе данных сохраняются разрешения и настройки (например модель восстановления и сведения о владельце базы данных) моментального снимка базы данных.  
  
5.  Запустите базу данных.  
  
6.  Кроме того, можно создать резервную копию восстанавливаемой базы данных, особенно если в ней используется полная модель восстановления или модель восстановления с неполным протоколированием. Сведения о резервном копировании базы данных см. в разделе [Создание полной резервной копии базы данных (SQL Server)](../backup-restore/create-a-full-database-backup-sql-server.md).  
  
###  <a name="examples-transact-sql"></a><a name="TsqlExample"></a> Примеры (Transact-SQL)  
 В этом разделе содержатся примеры восстановления базы данных до состояния, соответствующего моментальному снимку.  
  
-   A. [Восстановление базы данных AdventureWorks к состоянию моментального снимка](#Reverting_AW)  
  
-   Б. [Восстановление базы данных Sales к состоянию моментального снимка](#Reverting_Sales)  
  
####  <a name="a-reverting-a-snapshot-on-the-adventureworks-database"></a><a name="Reverting_AW"></a> A. Восстановление базы данных AdventureWorks к состоянию моментального снимка  
 В этом примере предполагается наличие единственного моментального снимка базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] . Пример создания снимка, к состоянию на момент создания которого необходимо восстановить базу данных, см. в разделе [Создание моментального снимка базы данных (Transact-SQL)](create-a-database-snapshot-transact-sql.md).  
  
```  
USE master;  
-- Reverting AdventureWorks to AdventureWorks_dbss1800  
RESTORE DATABASE AdventureWorks from   
DATABASE_SNAPSHOT = 'AdventureWorks_dbss1800';  
GO  
```  
  
####  <a name="b-reverting-a-snapshot-on-the-sales-database"></a><a name="Reverting_Sales"></a> Б. Восстановление базы данных Sales к состоянию моментального снимка  
 В этом примере предполагается, что в базе данных **Sales** имеется два моментальных снимка: **sales_snapshot0600** и **sales_snapshot1200**. В примере происходит удаление более раннего моментального снимка, и база данных восстанавливается до состояния более позднего моментального снимка.  
  
 Код программы создания образца базы данных и моментальных снимков для данного примера см. в следующих разделах.  
  
-   Сведения о создании базы данных **Sales** и моментального снимка **sales_snapshot0600** см. в подразделах "Создание баз данных с файловыми группами" и "Создание моментального снимка базы данных" раздела [CREATE DATABASE (SQL Server Transact-SQL)](/sql/t-sql/statements/create-database-sql-server-transact-sql).  
  
-   Сведения о создании базы данных **sales_snapshot1200** см. в подразделе "Создание моментального снимка базы данных Sales" в разделе [Создание моментального снимка базы данных (Transact-SQL)](create-a-database-snapshot-transact-sql.md).  
  
```  
--Test to see if sales_snapshot0600 exists and if it   
-- does, delete it.  
IF EXISTS (SELECT dbid FROM sys.databases  
    WHERE NAME='sales_snapshot0600')  
    DROP DATABASE SalesSnapshot0600;  
GO  
-- Reverting Sales to sales_snapshot1200  
USE master;  
RESTORE DATABASE Sales FROM DATABASE_SNAPSHOT = 'sales_snapshot1200';  
GO  
```  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
  
-   [Создание моментального снимка базы данных (Transact-SQL)](create-a-database-snapshot-transact-sql.md)  
  
-   [Просмотр моментального снимка базы данных (SQL Server)](view-a-database-snapshot-sql-server.md)  
  
-   [Удаление моментального снимка базы данных (Transact-SQL)](drop-a-database-snapshot-transact-sql.md)  
  
## <a name="see-also"></a>См. также:  
 [Моментальные снимки базы данных (SQL Server)](database-snapshots-sql-server.md)   
 [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql)   
 [sys.databases (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-databases-transact-sql)   
 [Зеркальное отображение и моментальные снимки баз данных (SQL Server)](../../database-engine/database-mirroring/database-mirroring-and-database-snapshots-sql-server.md)  
  
  
