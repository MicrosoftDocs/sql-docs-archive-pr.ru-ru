---
title: Параметры сортировки автономной базы данных | Документация Майкрософт
ms.custom: ''
ms.date: 07/17/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- contained database, collations
ms.assetid: 4b44f6b9-2359-452f-8bb1-5520f2528483
author: stevestein
ms.author: sstein
ms.openlocfilehash: 2648dbedea7708c4f39c922c56bba96cf38b0c0e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87734138"
---
# <a name="contained-database-collations"></a>Параметры сортировки автономной базы данных
  На порядок сортировки и семантику сравнения текстовых данных влияют различные свойства, в том числе учет регистра, учет диакритических знаков и используемый базовый язык. Эти характеристики выражаются в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] посредством выбора параметров сортировки для данных. Подробное обсуждение параметров сортировки см. в разделе [Поддержка параметров сортировки и Юникода](../collations/collation-and-unicode-support.md).  
  
 Параметры сортировки применяются не только к данным, хранящимся в пользовательских таблицах, но и ко всему тексту, обрабатываемому [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], включая метаданные, временные объекты, имена переменных и т. д. Обработка таких объектов в автономных и неавтономных базах данных различается. Это изменение коснется небольшого числа пользователей и обеспечит независимость и единообразие экземпляров. При этом возможны некоторые затруднения, а также проблемы в сеансах, которые обращаются и к автономным и к неавтономным базам данных.  
  
 В этом разделе поясняется суть изменения и рассматриваются области, в которых оно может вызвать проблемы.  
  
## <a name="non-contained-databases"></a>Неавтономные базы данных  
 Все базы данных имеют параметры сортировки по умолчанию (их можно задать во время создания или изменения базы данных). Эти параметры сортировки используются для всех метаданных в базе данных, а также по умолчанию для всех строковых столбцов в базе данных. Пользователи могут выбрать другие параметры сортировки для любого столбца с помощью предложения `COLLATE`.  
  
### <a name="example-1"></a>Пример 1  
 Например, для работы в Пекине можно использовать параметры сортировки китайского языка:  
  
```sql  
ALTER DATABASE MyDB COLLATE Chinese_Simplified_Pinyin_100_CI_AS;  
```  
  
 Теперь для создаваемого столбца по умолчанию будут применяться параметры сортировки китайского языка, но в случае необходимости можно выбрать другие параметры.  
  
```sql  
CREATE TABLE MyTable  
      (mycolumn1 nvarchar,  
      mycolumn2 nvarchar COLLATE Frisian_100_CS_AS);  
GO  
SELECT name, collation_name  
FROM sys.columns  
WHERE name LIKE 'mycolumn%' ;  
GO  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```sql  
name            collation_name  
--------------- ----------------------------------  
mycolumn1       Chinese_Simplified_Pinyin_100_CI_AS  
mycolumn2       Frisian_100_CS_AS  
```  
  
 Это выглядит довольно простым, однако возникают некоторые проблемы. Поскольку параметры сортировки для столбца зависят от базы данных, в которой создается таблица, возникают проблемы с использованием временных таблиц, которые хранятся в `tempdb` . Параметры сортировки `tempdb` обычно соответствуют параметрам сортировки для экземпляра, который не должен соответствовать параметрам сортировки базы данных.  
  
### <a name="example-2"></a>Пример 2  
 Например, пусть база данных с китайскими параметрами сортировки (упомянутая выше) используется в экземпляре с параметрами сортировки **Latin1_General** :  
  
```sql  
CREATE TABLE T1 (T1_txt nvarchar(max)) ;  
GO  
CREATE TABLE #T2 (T2_txt nvarchar(max)) ;  
GO  
```  
  
 На первый взгляд кажется, что две таблицы имеют одинаковую схему, однако из-за различия в параметрах сортировки баз данных значения оказываются несовместимыми.  
  
```  
SELECT T1_txt, T2_txt  
FROM T1   
JOIN #T2   
    ON T1.T1_txt = #T2.T2_txt  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
 Сообщение 468, уровень 16, состояние 9, строка 2  
  
 Не удается разрешить конфликт параметров сортировки Latin1_General_100_CI_AS_KS_WS_SC и Chinese_Simplified_Pinyin_100_CI_AS в операции равенства.  
  
 Чтобы исправить эту проблему, можно явно задать параметры сортировки временной таблицы. В [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] эта задача несколько упрощается за счет поддержки ключевого слова `DATABASE_DEFAULT` для предложения `COLLATE`.  
  
```sql  
CREATE TABLE T1 (T1_txt nvarchar(max)) ;  
GO  
CREATE TABLE #T2 (T2_txt nvarchar(max) COLLATE DATABASE_DEFAULT);  
GO  
SELECT T1_txt, T2_txt  
FROM T1   
JOIN #T2   
    ON T1.T1_txt = #T2.T2_txt ;  
```  
  
 Теперь операция работает без ошибки.  
  
 Различия параметров сортировки также проявляются в обработке переменных. Рассмотрим следующую функцию:  
  
```  
CREATE FUNCTION f(@x INT) RETURNS INT  
AS BEGIN   
      DECLARE @I INT = 1  
      DECLARE @?? INT = 2  
      RETURN @x * @i  
END;  
```  
  
 Это довольно необычная функция. В параметрах сортировки с учетом регистра элемент @i в предложении RETURN не может быть привязан либо к, либо к @I @??. Если сортировка выполняется как Latin1_General без учета регистра, конструкция @i привязывается к @I и функция возвращает значение 1. Но в параметрах сортировки, не учитывающих регистр, выполняется @i Привязка к @??, и функция возвращает значение 2. Это может негативно отразиться на базе данных, которая перемещается между экземплярами с различными параметрами сортировки.  
  
## <a name="contained-databases"></a>Автономные базы данных  
 Поскольку задачей проектирования автономных баз данных является обеспечение их независимости, необходимо исключить зависимость от параметров сортировки экземпляра и базы данных `tempdb`. Для этого в автономных базах данных реализовано основное понятие параметров сортировки каталога. Параметры сортировки каталога используются для метаданных системы и временных объектов. Далее даны подробности.  
  
 В автономной базе данных используются параметры сортировки каталога **Latin1_General_100_CI_AS_WS_KS_SC**. Эти параметры сортировки одинаковы для всех автономных баз данных во всех экземплярах [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , и их нельзя изменить.  
  
 Параметры сортировки базы данных сохраняются, но используются только в качестве параметров сортировки по умолчанию для пользовательских данных. По умолчанию параметры сортировки базы данных совпадают с параметрами сортировки базы данных model, но могут быть изменены пользователем с помощью `CREATE` команды или, `ALTER DATABASE` как и при работе с неавтономными базами данных.  
  
 В предложении `CATALOG_DEFAULT` доступно новое ключевое слово `COLLATE`. Оно служит ярлыком для текущих параметров сортировки метаданных и в автономных и в неавтономных базах данных. Это значит, что в неавтономной базе данных конструкция `CATALOG_DEFAULT` возвращает текущие параметры сортировки базы данных, поскольку в метаданных применяются параметры сортировки базы данных. В автономной базе данных эти два значения могут различаться, поскольку пользователь может изменить параметры сортировки базы данных так, чтобы они отличались от параметров сортировки каталога.  
  
 В данной таблице представлен порядок обработки различных объектов в автономных и неавтономных базах данных.  
  
||||  
|-|-|-|  
|**Item**|**Неавтономная база данных**|**Автономная база данных**|  
|Пользовательские данные (по умолчанию)|DATABASE_DEFAULT|DATABASE_DEFAULT|  
|Временные данные (по умолчанию)|Параметры сортировки TempDB|DATABASE_DEFAULT|  
|Метаданные|DATABASE_DEFAULT / CATALOG_DEFAULT|CATALOG_DEFAULT|  
|Временные метаданные|Параметры сортировки TempDB|CATALOG_DEFAULT|  
|Переменные|Параметры сортировки экземпляра|CATALOG_DEFAULT|  
|Метки перехода|Параметры сортировки экземпляра|CATALOG_DEFAULT|  
|Имена курсоров|Параметры сортировки экземпляра|CATALOG_DEFAULT|  
  
 В ранее описанном примере с временной таблицей видно, что такой принцип работы параметров сортировки исключает необходимость явно задавать предложение `COLLATE` в большинстве случаев использования временной таблицы. В автономной базе данных этот код теперь работает без ошибок, даже в случае, когда параметры сортировки различаются для базы данных и для экземпляра.  
  
```sql  
CREATE TABLE T1 (T1_txt nvarchar(max)) ;  
GO  
CREATE TABLE #T2 (T2_txt nvarchar(max));  
GO  
SELECT T1_txt, T2_txt  
FROM T1   
JOIN #T2   
    ON T1.T1_txt = #T2.T2_txt ;  
```  
  
 Так происходит потому, что для `T1_txt` и `T2_txt` используются параметры сортировки автономной базы данных.  
  
## <a name="crossing-between-contained-and-uncontained-contexts"></a>Переход между автономными и неавтономными контекстами  
 Пока сеанс в автономной базе данных остается автономным, он должен оставаться в пределах базы данных, с которой установлено соединение. В этом случае работа ведется очевидным образом. Однако если сеанс переходит между автономными и неавтономными контекстами, то его обработка усложняется, поскольку требуется организовать связь между двумя наборами правил. Такое может случаться в частично автономной базе данных, поскольку пользователь может передать команду `USE` в другую базу данных. В этом случае различия в правилах параметров сортировки обрабатываются следующим образом.  
  
-   Правило параметров сортировки для пакета определяется базой данных, в которой начинается пакет.  
  
 Заметьте, что это решение принимается до обработки команд, включая первоначальную команду `USE`. Это значит, что если пакет начинается в автономной базе данных, но первая команда `USE` ссылается на неавтономную базу данных, то для пакета будут использоваться параметры сортировки для автономной базы данных. В отношении переменных это может приводить к различным результатам.  
  
-   Ссылка может обнаружить ровно одно соответствие. В этом случае ссылка будет работать без ошибок.  
  
-   Ссылка может не найти соответствия в текущих параметрах сортировки на прежней позиции. В этом случае происходит ошибка, показывающая, что переменная не существует, хотя очевидно, что она была создана.  
  
-   Ссылка может обнаружить несколько соответствий, которые прежде были различными. В этом случае также происходит ошибка.  
  
 Это показано в следующих примерах. Пусть имеется частично автономная база данных с именем `MyCDB` , для которой используются параметры сортировки каталога **Latin1_General_100_CI_AS_WS_KS_SC**. Пусть для экземпляра используются параметры сортировки `Latin1_General_100_CS_AS_WS_KS_SC`. Таким образом, два набора параметров сортировки различаются только учетом регистра.  
  
### <a name="example-1"></a>Пример 1  
 В следующем примере показан вариант, где ссылка обнаруживает ровно одно совпадение.  
  
```  
USE MyCDB;  
GO  
  
CREATE TABLE #a(x int);  
INSERT INTO #a VALUES(1);  
GO  
  
USE master;  
GO  
  
SELECT * FROM #a;  
GO  
  
Results:  
  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```  
x  
-----------  
1  
```  
  
 В данном случае конструкция #a привязывается к параметрам сортировки каталога (без учета регистра) и к параметрам сортировки экземпляра (с учетом регистра) и код работает.  
  
### <a name="example-2"></a>Пример 2  
 В следующим примере показан вариант, где ссылка не обнаруживает соответствие в текущих параметрах сортировки на прежней позиции.  
  
```  
USE MyCDB;  
GO  
  
CREATE TABLE #a(x int);  
INSERT INTO #A VALUES(1);  
GO  
```  
  
 Здесь конструкция #A привязывается к #a в параметрах сортировки по умолчанию (без учета регистра) и операция вставки работает.  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```  
(1 row(s) affected)  
```  
  
 Однако если работа скрипта продолжается...  
  
```  
USE master;  
GO  
  
SELECT * FROM #A;  
GO  
```  
  
 Возникает ошибка во время привязки к #A в параметрах сортировки экземпляра (с учетом регистра).  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
 Сообщение 208, уровень 16, состояние 0, строка 2  
  
 Недопустимое имя объекта «#A».  
  
### <a name="example-3"></a>Пример 3  
 В следующем примере показан вариант, где ссылка обнаруживает несколько соответствий, которые прежде были различными. Сначала мы начнем с `tempdb` (в котором используются те же параметры сортировки с учетом регистра, что и у нашего экземпляра), и выполните следующие инструкции.  
  
```  
USE tempdb;  
GO  
  
CREATE TABLE #a(x int);  
GO  
CREATE TABLE #A(x int);  
GO  
INSERT INTO #a VALUES(1);  
GO  
INSERT INTO #A VALUES(2);  
GO  
```  
  
 Он завершается успешно, поскольку в данных параметрах сортировки таблицы различны.  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
```  
(1 row(s) affected)  
(1 row(s) affected)  
```  
  
 Однако если перейти в автономную базу данных, то окажется, что привязка к этим таблицам уже невозможна.  
  
```  
USE MyCDB;  
GO  
SELECT * FROM #a;  
GO  
```  
  
 [!INCLUDE[ssResult](../../includes/ssresult-md.md)]  
  
 Сообщение 12800, уровень 16, состояние 1, строка 2  
  
 Не удается разрешить неоднозначную ссылку на временную таблицу с именем «#a». Возможные варианты: «#a» и «#A».  
  
## <a name="conclusion"></a>Заключение  
 Работа параметров сортировки в автономных базах данных несколько отличается от неавтономных баз данных. В целом эти изменения упрощают работу и обеспечивают независимость от экземпляра. У некоторых пользователей могут возникать проблемы, особенно если сеанс обращается и к автономным и к неавтономным базам данных.  
  
## <a name="see-also"></a>См. также:  
 [Автономные базы данных](contained-databases.md)  
  
  
