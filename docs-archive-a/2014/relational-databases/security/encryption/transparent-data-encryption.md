---
title: Прозрачное шифрование данных (TDE) | Документация Майкрософт
ms.custom: ''
ms.date: 11/23/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: security
ms.topic: conceptual
helpviewer_keywords:
- Transparent Data Encryption
- database encryption key, about
- TDE
- database encryption key
- TDE, about
- Transparent Data Encryption, about
- encryption [SQL Server], transparent data encryption
ms.assetid: c75d0d4b-4008-4e71-9a9d-cee2a566bd3b
author: jaszymas
ms.author: jaszymas
ms.openlocfilehash: a8118f0781d7c9e3d839c029c6bdaf8b01e074b0
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87664828"
---
# <a name="transparent-data-encryption-tde"></a>Прозрачное шифрование данных (TDE)
  *Прозрачное шифрование данных* (TDE) позволяет шифровать файлы данных [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] и [!INCLUDE[ssSDSfull](../../../includes/sssdsfull-md.md)] ; это называется шифрованием неактивных данных. Можно принять ряд мер предосторожности для защиты базы данных, таких как проектирование безопасной системы, шифрование конфиденциальных ресурсов и создание брандмауэра на серверах базы данных. Однако в случае похищения физического носителя (например, дисков или лент с резервными копиями) злоумышленник может просто восстановить или подключить базу данных и просмотреть данные. Одним из решений может стать шифрование конфиденциальных данных в базе данных и защита ключей, используемых при шифровании, с помощью сертификата. Это не позволит использовать данные ни одному человеку, не имеющему ключей, но такой тип защиты следует планировать заранее.

 Функция прозрачного шифрования данных выполняет шифрование и дешифрование ввода-вывода в реальном времени для файлов данных и журналов. При шифровании используется ключ шифрования базы данных (DEK), который хранится в загрузочной записи базы данных, где можно получить к нему доступ при восстановлении. Ключ шифрования базы данных является симметричным ключом, защищенным сертификатом, который хранится в базе данных master на сервере, или асимметричным ключом, защищенным модулем расширенного управления ключами. Функция прозрачного шифрования данных защищает "неактивные" данные, то есть файлы данных и журналов. Благодаря ей обеспечивается соответствие требованиям различных законов, постановлений и рекомендаций, действующих в разных отраслях. Это позволяет разработчикам программного обеспечения шифровать данные с помощью алгоритмов шифрования AES и 3DES, не меняя существующие приложения.

> [!IMPORTANT]
>  Функция прозрачного шифрования данных не обеспечивает шифрование каналов связи. Дополнительные сведения о способах шифрования данных, передаваемых по каналам связи, см. в разделе [Включение шифрования соединений в ядре СУБД (диспетчер конфигурации SQL Server)](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md).
> 
>  **См. также:**
> 
>  -   [Прозрачное шифрование данных в Базе данных SQL Azure](../../../database-engine/transparent-data-encryption-with-azure-sql-database.md)
> -   [Перемещение базы данных, защищаемой прозрачным шифрованием, в другой экземпляр SQL Server](move-a-tde-protected-database-to-another-sql-server.md)
> -   [Включение TDE с помощью расширенного управления ключами](enable-tde-on-sql-server-using-ekm.md)

## <a name="about-tde"></a>Сведения о прозрачном шифровании данных (TDE)
 Шифрование файлов базы данных выполняется на уровне страницы. Страницы в зашифрованной базе данных шифруются до записи на диск и дешифруются при чтении в память. Прозрачное шифрование данных не увеличивает размер зашифрованной базы данных.

 **Сведения, применимые к[!INCLUDE[ssSDS](../../../includes/sssds-md.md)]**

 При использовании прозрачного шифрования данных с [!INCLUDE[sqldbesa](../../../includes/sqldbesa-md.md)] V12  ([Предварительная версия в некоторых регионах](https://azure.microsoft.com/documentation/articles/sql-database-preview-whats-new/?WT.mc_id=TSQL_GetItTag)) [!INCLUDE[ssSDS](../../../includes/sssds-md.md)]автоматически создает для вас сертификат на уровне сервера, хранящийся в базе данных master. Чтобы переместить базу данных TDE в [!INCLUDE[ssSDS](../../../includes/sssds-md.md)] , вам необходимо расшифровать ее, переместить, а затем повторно включить TDE в целевой [!INCLUDE[ssSDS](../../../includes/sssds-md.md)]. Пошаговые инструкции по прозрачному шифрованию данных в [!INCLUDE[ssSDS](../../../includes/sssds-md.md)]можно найти в разделе [Transparent Data Encryption with Azure SQL Database](../../../database-engine/transparent-data-encryption-with-azure-sql-database.md).

 Просмотр состояния TDE применяется даже в подмножестве географических регионов, в которых сообщается, что версия семейства V12 [!INCLUDE[ssSDS](../../../includes/sssds-md.md)] теперь общедоступна. Прозрачное шифрование данных для [!INCLUDE[ssSDS](../../../includes/sssds-md.md)] не используется в рабочих базах данных до тех пор, пока [!INCLUDE[msCoName](../../../includes/msconame-md.md)] не объявит, что функция TDE становится общедоступной. Дополнительные сведения о [!INCLUDE[ssSDS](../../../includes/sssds-md.md)] V12 можно найти в разделе [Новые возможности версии 12 базы данных SQL](https://azure.microsoft.com/documentation/articles/sql-database-preview-whats-new/).

 **Сведения, применимые к[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]**

 После защиты базы данных ее можно восстановить с помощью правильного сертификата. Дополнительные сведения о сертификатах см. в разделе [SQL Server Certificates and Asymmetric Keys](../sql-server-certificates-and-asymmetric-keys.md).

 При включении функции прозрачного шифрования данных необходимо немедленно создать резервную копию сертификата и закрытого ключа, связанного с этим сертификатом. В случае если сертификат окажется недоступен или понадобится восстановить базу данных на другом сервере либо присоединить ее к другому серверу, необходимо иметь копии сертификата и закрытого ключа. Иначе будет невозможно открыть базу данных. Сертификат шифрования следует сохранить, даже если функция прозрачного шифрования в базе данных будет отключена. Даже если база данных не зашифрована, части журнала транзакций могут по-прежнему оставаться защищенными, а для некоторых операций будет требоваться сертификат до выполнения полного резервного копирования базы данных. Сертификат, который превысил свой срок хранения, все еще может быть использован для шифрования и расшифровки данных с помощью прозрачного шифрования данных.

 **Иерархия средств шифрования**

 На рисунке ниже показана архитектура прозрачного шифрования данных. При использовании прозрачного шифрования данных в [!INCLUDE[ssSDS](../../../includes/sssds-md.md)]пользователь может настраивать только элементы уровня базы данных (ключ шифрования базы данных и фрагменты ALTER DATABASE).

 ![Показывает иерархию, описанную в этом разделе.](../../../database-engine/media/tde-architecture.gif "Показывает иерархию, описанную в этом разделе.")

## <a name="using-transparent-data-encryption"></a>Использование прозрачного шифрования данных
 Чтобы использовать прозрачное шифрование данных, выполните следующие действия.

||
|-|
|**Применимо к**: [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].|

-   Создайте главный ключ

-   Создайте или получите сертификат, защищенный главным ключом

-   Создайте ключ шифрования базы данных и защитите его с помощью сертификата

-   Задайте ведение шифрования базы данных

 В следующем примере демонстрируется шифрование и дешифрование базы данных `AdventureWorks2012` с помощью сертификата с именем `MyServerCert`, установленного на сервере.

```
USE master;
GO
CREATE MASTER KEY ENCRYPTION BY PASSWORD = '<UseStrongPasswordHere>';
go
CREATE CERTIFICATE MyServerCert WITH SUBJECT = 'My DEK Certificate';
go
USE AdventureWorks2012;
GO
CREATE DATABASE ENCRYPTION KEY
WITH ALGORITHM = AES_128
ENCRYPTION BY SERVER CERTIFICATE MyServerCert;
GO
ALTER DATABASE AdventureWorks2012
SET ENCRYPTION ON;
GO
```

 Операции шифрования и дешифрования запланированы в фоновых потоках [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Состояние этих операций можно просмотреть в представлениях каталога и динамических административных представлениях в списке, представленном далее в этом разделе.

> [!CAUTION]
>  Файлы резервных копий баз данных, в которых включено TDE, также шифруются с помощью ключа шифрования базы данных. Поэтому для восстановления таких резервных копий необходимо иметь сертификат, защищающий ключ шифрования базы данных. Это значит, что помимо резервного копирования базы данных обязательно необходимо сохранять резервные копии сертификатов серверов, чтобы не допустить потери данных. Если сертификат станет недоступным, это приведет к потере данных. Дополнительные сведения см. в статье [SQL Server Certificates and Asymmetric Keys](../sql-server-certificates-and-asymmetric-keys.md).

## <a name="commands-and-functions"></a>Команды и функции
 Чтобы в следующих инструкциях можно было использовать сертификаты TDE, они должны быть зашифрованы главным ключом базы данных. Если они зашифрованы только паролем, то они будут отклонены инструкциями как шифраторы.

> [!IMPORTANT]
>  Если после использования сертификатов в TDE включить защиту паролем, база данных станет недоступной после перезапуска.

 В следующей таблице представлены ссылки и объяснения команд и функций TDE.

|Команда или функция|Назначение|
|-------------------------|-------------|
|[CREATE DATABASE ENCRYPTION KEY (Transact-SQL)](/sql/t-sql/statements/create-database-encryption-key-transact-sql)|Создает ключ, используемый для шифрования базы данных.|
|[ALTER DATABASE ENCRYPTION KEY (Transact-SQL)](/sql/t-sql/statements/alter-database-encryption-key-transact-sql)|Изменяет ключ, используемый для шифрования базы данных.|
|[DROP DATABASE ENCRYPTION KEY (Transact-SQL)](/sql/t-sql/statements/drop-database-transact-sql)|Удаляет ключ, использовавшийся для шифрования базы данных.|
|[Параметры ALTER DATABASE SET &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options)|Объясняет параметр `ALTER DATABASE`, который используется для включения TDE.|

## <a name="catalog-views-and-dynamic-management-views"></a>Представления каталога и динамические административные представления
 В следующей таблице показаны представления каталогов и динамические административные представления TDE.

|Представление каталога или динамическое административное представление|Назначение|
|---------------------------------------------|-------------|
|[sys.databases (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-databases-transact-sql)|Представление каталога со сведениями о базе данных.|
|[sys.certificates (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-certificates-transact-sql)|Представление каталога с сертификатами из базы данных.|
|[sys.dm_database_encryption_keys (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-database-encryption-keys-transact-sql)|Динамическое административное представление со сведениями о ключах шифрования, используемых в базе данных, и состоянии шифрования базы данных.|

## <a name="permissions"></a>Разрешения
 Для каждой функции или команды TDE действуют отдельные требования к разрешениям, описанные в таблицах выше.

 Для просмотра метаданных, связанных с TDE, необходимо разрешение VIEW DEFINITION на сертификат.

## <a name="considerations"></a>Рекомендации
 Во время проверки базы данных на повторное шифрование, выполняемой для операции шифрования, операции обслуживания базы данных отключаются. Для выполнения операции обслуживания базы данных можно использовать однопользовательский режим. Дополнительные сведения см. в разделе [Установка однопользовательского режима базы данных](../../databases/set-a-database-to-single-user-mode.md).

 Состояние шифрования базы данных можно определить с помощью динамического административного представления sys.dm_database_encryption_keys. Дополнительные сведения см. выше в подразделе "Представления каталога и динамические административные представления" этого раздела.

 В режиме TDE все файлы и файловые группы зашифрованы. Если какие-либо файловые группы в базе данных помечены признаком READ ONLY, то операция шифрования базы данных завершится сбоем.

 Если база данных используется в зеркальном отображении базы данных или в доставке журналов, то зашифрованы будут обе базы данных. Транзакции журналов при передаче между ними будут передаваться в зашифрованном виде.

> [!IMPORTANT]
>  Все новые полнотекстовые индексы будут шифроваться после включения шифрования базы данных. Ранее созданные полнотекстовые индексы будут импортированы во время обновления и станут доступны для TDE после загрузки данных в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Включение полнотекстового индекса в столбце может привести к тому, что во время полнотекстового индексирования данные из этого столбца будут записываться на диск в виде обычного текста. Не рекомендуется создавать полнотекстовый индекс на важных зашифрованных данных.

 Зашифрованные данные подвергаются сжатию в значительно меньшей степени, чем незашифрованные. Если TDE используется для шифрования базы данных, сжатие резервной копии не сможет значительно сжать хранилище резервных копий. Поэтому не рекомендуется совместное использование TDE и сжатия резервных копий.

### <a name="restrictions"></a>Ограничения
 При первом шифровании базы данных, изменении ключа или дешифровании базы данных не допускаются следующие операции:

-   удаление файла из файловой группы в базе данных;

-   удаление базы данных;

-   перевод базы данных в режим «вне сети»;

-   отсоединение базы данных;

-   перевод базы данных или файловой группы в состояние READ ONLY.

 При выполнении инструкций CREATE DATABASE ENCRYPTION KEY, ALTER DATABASE ENCRYPTION KEY, DROP DATABASE ENCRYPTION KEY или ALTER DATABASE...SET ENCRYPTION не допускаются следующие операции:

-   удаление файла из файловой группы в базе данных;

-   Удаление базы данных.

-   перевод базы данных в режим «вне сети»;

-   отсоединение базы данных;

-   перевод базы данных или файловой группы в состояние READ ONLY;

-   использование команды ALTER DATABASE;

-   запуск резервного копирования базы данных или файла базы данных;

-   запуск восстановления базы данных или файла базы данных;

-   создание моментального снимка.

 Следующие операции или условия запрещают выполнение инструкций CREATE DATABASE ENCRYPTION KEY, ALTER DATABASE ENCRYPTION KEY, DROP DATABASE ENCRYPTION KEY или ALTER DATABASE...SET ENCRYPTION.

-   база данных предназначена только для чтения, или в ней есть файловые группы, доступные только для чтения;

-   выполняется команда ALTER DATABASE;

-   выполняется какая-либо операция резервного копирования;

-   база данных находится в состоянии восстановления или в состоянии «вне сети»;

-   идет создание моментального снимка;

-   выполняется задача обслуживания базы данных.

 При создании файлов базы данных быстрая инициализация файлов недоступна при включенном TDE.

 Чтобы зашифровать ключ шифрования базы данных с помощью асимметричного ключа, используемый асимметричный ключ должен находиться в поставщике расширенного управления ключами.

### <a name="transparent-data-encryption-and-transaction-logs"></a>Прозрачное шифрование данных и журналы транзакций
 Включение TDE в базе данных приводит к «обнулению» оставшейся части виртуального журнала транзакций и принудительному началу нового виртуального журнала транзакций. Это гарантирует, что после включения шифрования базы данных в журналах транзакций не останется простого текста. Состояние шифрования файла журнала можно определить, просмотрев столбец `encryption_state` в представлении `sys.dm_database_encryption_keys`, как показано в примере:

```
USE AdventureWorks2012;
GO
/* The value 3 represents an encrypted state 
   on the database and transaction logs. */
SELECT *
FROM sys.dm_database_encryption_keys
WHERE encryption_state = 3;
GO
```

 Дополнительные сведения об архитектуре файлов журнала [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] см. в разделе [Журнал транзакций (SQL Server)](../../logs/the-transaction-log-sql-server.md).

 Все данные, записанные в журнале транзакций до изменения ключа шифрования базы данных, будут зашифрованы с помощью предыдущего ключа шифрования базы данных.

 После двукратного изменения ключа шифрования базы данных необходимо выполнить резервное копирование журнала перед следующим изменением ключа шифрования базы данных.

### <a name="transparent-data-encryption-and-the-tempdb-system-database"></a>Прозрачное шифрование данных и системная база данных tempdb
 Системная база данных tempdb будет шифроваться, если с помощью TDE шифруется любая другая база данных в экземпляре [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] . Это может влиять на производительность незашифрованных баз данных в том же экземпляре [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Дополнительные сведения о системной базе данных tempdb см. в разделе [База данных tempdb](../../databases/tempdb-database.md).

### <a name="transparent-data-encryption-and-replication"></a>Прозрачное шифрование данных и репликация
 Репликация данных не выполняется автоматически в зашифрованном виде из базы данных с включенным TDE. Необходимо отдельно включить TDE, если нужно защитить базы данных распространителя и подписчика. При репликации моментальных снимков и начальном распределении данных для репликации транзакций и репликации слиянием данные могут храниться в незашифрованных промежуточных файлах, например файлах BCP.  Во время репликации транзакций или репликации слиянием шифрование можно включить для защиты каналов связи. Дополнительные сведения см. в разделе [Включение шифрования соединений в компоненте Database Engine (диспетчер конфигураций SQL Server)](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md).

### <a name="transparent-data-encryption-and-filestream-data"></a>Прозрачное шифрование данных и данные FILESTREAM
 Данные FILESTREAM не шифруются, даже если включено прозрачное шифрование данных.

### <a name="transparent-data-encryption-and-buffer-pool-extension"></a>Прозрачное шифрование и расширение буферного пула
 Файлы, касающиеся расширения буферного пула, не шифруются, если база данных зашифрована с помощью прозрачного шифрования данных. Необходимо использовать средства шифрования на уровне файловой системы, такие как Bitlocker или файловая система EFS для файлов с расширением BPE.

## <a name="transparent-data-encryption-and-in-memory-oltp"></a>Прозрачное шифрование данных и In-Memory OLTP
 Прозрачное шифрование данных можно включить в базе данных, которая содержит объекты OLTP в памяти. Записи журнала OLTP в памяти шифруются, если TDE включено. Данные в файловой группе MEMORY_OPTIMIZED_DATA не шифруются при включенном TDE.

## <a name="see-also"></a>См. также:
 [Перемещение базы данных, защищенной TDE, в другую SQL Server](move-a-tde-protected-database-to-another-sql-server.md) [включить TDE с использованием расширенного управления ключами](enable-tde-on-sql-server-using-ekm.md) [ПРОЗРАЧНОЕ шифрование данных с помощью базы данных SQL Azure](../../../database-engine/transparent-data-encryption-with-azure-sql-database.md) [SQL Server шифрование](sql-server-encryption.md) [SQL Server и ключи шифрования базы данных &#40;](sql-server-and-database-encryption-keys-database-engine.md) ядро СУБД&#41;[центра безопасности для SQL Server ядро СУБД и базы данных SQL Azure](../security-center-for-sql-server-database-engine-and-azure-sql-database.md) [FileStream](../../blob/filestream-sql-server.md) &#40;SQL Server&#41;


