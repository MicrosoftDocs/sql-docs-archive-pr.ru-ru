---
title: Резервное копирование базы данных с оптимизированными для памяти таблицами | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 83d47694-e56d-4dae-b54e-14945bf8ba31
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 176448aa9d4bab4101ab2db12ffc9a8a7fd1a5b5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87655718"
---
# <a name="backing-up-a-database-with-memory-optimized-tables"></a><span data-ttu-id="fd46b-102">Резервное копирование базы данных с оптимизированными для памяти таблицами</span><span class="sxs-lookup"><span data-stu-id="fd46b-102">Backing Up a Database with Memory-Optimized Tables</span></span>
  <span data-ttu-id="fd46b-103">Резервные копии оптимизированных для памяти таблиц создаются в составе обычных резервных копий баз данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-103">Memory-optimized tables are backed up as part of regular database backups.</span></span> <span data-ttu-id="fd46b-104">Что же касается таблиц на дисках, то для обнаружения повреждений CHECKSUM пар файлов данных и разностных файлов проверяется в процессе резервного копирования базы данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-104">As for disk-based tables, the CHECKSUM of data and delta file pairs is validated as part of the database backup to detect storage corruption.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="fd46b-105">Во время резервного копирования, если обнаруживается ошибка CHECKSUM для одного или нескольких файлов в файловой группе, оптимизированной для памяти, невозможно будет восстановить и перезапустить базу данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-105">During a backup, if you detect a CHECKSUM error in one or more files in a memory-optimized filegroup, you will not be able to restore and restart the database.</span></span> <span data-ttu-id="fd46b-106">В таком случае потребуется восстановить базу данных из последней рабочей резервной копии.</span><span class="sxs-lookup"><span data-stu-id="fd46b-106">In that situation, you must, restore your database with the last known good backup.</span></span> <span data-ttu-id="fd46b-107">Если нет резервной копии, можно экспортировать данные из таблиц, оптимизированных для памяти, и таблиц на диске, после чего загрузить их обратно после удаления и повторного создания базы данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-107">If you don't have a backup, you can export the data from memory-optimized tables and disk-based tables and reload after you drop and recreate the database.</span></span>  
  
 <span data-ttu-id="fd46b-108">Полная резервная копия базы данных с одной или несколькими оптимизированными для памяти таблицами состоит из хранилища, выделенного для таблиц, находящихся на диске (если таковые имеются), активного журнала транзакций и пар файлов данных и разностных файлов (их также называют парами файлов контрольных точек) для оптимизированных для памяти таблиц.</span><span class="sxs-lookup"><span data-stu-id="fd46b-108">A full backup of a database with one or more memory-optimized tables consists of the allocated storage for disk-based tables (if any), the active transaction log, and the data and delta file pairs (also known as checkpoint file pairs) for memory-optimized tables.</span></span> <span data-ttu-id="fd46b-109">Однако, как описано в разделе [Устойчивость таблиц, оптимизированных для памяти](memory-optimized-tables.md), объем хранилища, используемый оптимизированными для памяти таблицами, может быть значительно больше, чем размер таблиц в памяти. Это оказывает влияние на размер резервной копии базы данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-109">However, as described in [Durability for Memory-Optimized Tables](memory-optimized-tables.md), the storage used by memory-optimized tables can be much larger than its size in memory, and it affects the size of the database backup.</span></span>  
  
## <a name="full-database-backup"></a><span data-ttu-id="fd46b-110">Полная резервная копия базы данных</span><span class="sxs-lookup"><span data-stu-id="fd46b-110">Full Database Backup</span></span>  
 <span data-ttu-id="fd46b-111">В этом описании основное внимание уделяется резервному копированию баз данных только с долговременными, оптимизированными для памяти таблицами, так как резервное копирование таблиц, записанных на диск, ничем не отличается.</span><span class="sxs-lookup"><span data-stu-id="fd46b-111">This discussion will focus on database backups for databases with just durable memory-optimized tables, because the backup for disk-based tables is the same.</span></span> <span data-ttu-id="fd46b-112">Пары файлов контрольных точек из оптимизированной для памяти файловой группы могут находиться в различных состояниях.</span><span class="sxs-lookup"><span data-stu-id="fd46b-112">The checkpoint file pairs in the memory-optimized filegroup could be in various states.</span></span> <span data-ttu-id="fd46b-113">В приведенной далее таблице указано, какая часть файлов заносится в резервную копию.</span><span class="sxs-lookup"><span data-stu-id="fd46b-113">The table below describes what part of the files is backed.</span></span>  
  
|<span data-ttu-id="fd46b-114">Состояние пары файлов контрольных точек</span><span class="sxs-lookup"><span data-stu-id="fd46b-114">Checkpoint File Pair State</span></span>|<span data-ttu-id="fd46b-115">Резервное копирование</span><span class="sxs-lookup"><span data-stu-id="fd46b-115">Backup</span></span>|  
|--------------------------------|------------|  
|<span data-ttu-id="fd46b-116">PRECREATED</span><span class="sxs-lookup"><span data-stu-id="fd46b-116">PRECREATED</span></span>|<span data-ttu-id="fd46b-117">Только метаданные файла</span><span class="sxs-lookup"><span data-stu-id="fd46b-117">File metadata only</span></span>|  
|<span data-ttu-id="fd46b-118">UNDER CONSTRUCTION</span><span class="sxs-lookup"><span data-stu-id="fd46b-118">UNDER CONSTRUCTION</span></span>|<span data-ttu-id="fd46b-119">Только метаданные файла</span><span class="sxs-lookup"><span data-stu-id="fd46b-119">File metadata only</span></span>|  
|<span data-ttu-id="fd46b-120">Активно</span><span class="sxs-lookup"><span data-stu-id="fd46b-120">Active</span></span>|<span data-ttu-id="fd46b-121">Метаданные файла и используемые байты</span><span class="sxs-lookup"><span data-stu-id="fd46b-121">File metadata plus used bytes</span></span>|  
|<span data-ttu-id="fd46b-122">Merge source</span><span class="sxs-lookup"><span data-stu-id="fd46b-122">Merge source</span></span>|<span data-ttu-id="fd46b-123">Метаданные файла и используемые байты</span><span class="sxs-lookup"><span data-stu-id="fd46b-123">File metadata plus used bytes</span></span>|  
|<span data-ttu-id="fd46b-124">Merge target</span><span class="sxs-lookup"><span data-stu-id="fd46b-124">Merge target</span></span>|<span data-ttu-id="fd46b-125">Только метаданные файла</span><span class="sxs-lookup"><span data-stu-id="fd46b-125">File metadata only</span></span>|  
|<span data-ttu-id="fd46b-126">REQUIRED FOR BACKUP/HA</span><span class="sxs-lookup"><span data-stu-id="fd46b-126">REQUIRED FOR BACKUP/HA</span></span>|<span data-ttu-id="fd46b-127">Метаданные файла и используемые байты</span><span class="sxs-lookup"><span data-stu-id="fd46b-127">File metadata plus used bytes</span></span>|  
|<span data-ttu-id="fd46b-128">IN TRANSITION TO TOMBSTONE</span><span class="sxs-lookup"><span data-stu-id="fd46b-128">IN TRANSITION TO TOMBSTONE</span></span>|<span data-ttu-id="fd46b-129">Только метаданные файла</span><span class="sxs-lookup"><span data-stu-id="fd46b-129">File metadata only</span></span>|  
|<span data-ttu-id="fd46b-130">TOMBSTONE</span><span class="sxs-lookup"><span data-stu-id="fd46b-130">TOMBSTONE</span></span>|<span data-ttu-id="fd46b-131">Только метаданные файла</span><span class="sxs-lookup"><span data-stu-id="fd46b-131">File metadata only</span></span>|  
  
 <span data-ttu-id="fd46b-132">Размер резервных копий баз данных, в которых есть одна или несколько оптимизированных для памяти таблиц, обычно больше, чем размер в памяти, но меньше, чем объем, занимаемый на диске.</span><span class="sxs-lookup"><span data-stu-id="fd46b-132">The size of database backups with one or more memory-optimized tables is typically larger than its size in memory but smaller than the on-disk storage.</span></span> <span data-ttu-id="fd46b-133">Дополнительный объем зависит от числа удаляемых строк и количества пар файла контрольных точек в состоянии Merge source и REQUIRED FOR BACKUP/HA, что косвенно зависит от рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="fd46b-133">The extra size will depend upon the number of deleted rows and the number of checkpoint file pairs in the states Merge source and REQUIRED FOR BACKUP/HA which indirectly depends upon the workload.</span></span> <span data-ttu-id="fd46b-134">Описание состояний для пар файлов контрольных точек см. в разделе [sys. dm_db_xtp_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="fd46b-134">For descriptions of the states for checkpoint file pairs, see [sys.dm_db_xtp_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql).</span></span>  
  
### <a name="estimating-size-of-full-database-backup"></a><span data-ttu-id="fd46b-135">Оценка размера полной резервной копии базы данных</span><span class="sxs-lookup"><span data-stu-id="fd46b-135">Estimating Size of Full Database Backup</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="fd46b-136">Не рекомендуется использовать значение BackupSizeInBytes для оценки размера резервной копии In-Memory OLTP.</span><span class="sxs-lookup"><span data-stu-id="fd46b-136">It's recommended that you not use the BackupSizeInBytes value to estimate the backup size for In-Memory OLTP.</span></span>  
  
 <span data-ttu-id="fd46b-137">Первый сценарий рабочей нагрузки предназначен (главным образом) для вставки.</span><span class="sxs-lookup"><span data-stu-id="fd46b-137">The first workload scenario is for (mostly) insert.</span></span> <span data-ttu-id="fd46b-138">В этом случае большинство файлов данных будут находиться в состоянии Active, полностью загружены и с очень небольшим числом удаленных строк.</span><span class="sxs-lookup"><span data-stu-id="fd46b-138">In this scenario, most data files will be in the Active state, fully loaded, and with very few deleted rows.</span></span> <span data-ttu-id="fd46b-139">Размер резервной копии базы данных будет близок к размеру данных в памяти.</span><span class="sxs-lookup"><span data-stu-id="fd46b-139">The size of database backup up will be close to the size of data in memory.</span></span>  
  
 <span data-ttu-id="fd46b-140">Второй сценарий рабочей нагрузки предназначен для частого выполнения операций вставки, удаления и обновления: в худшем случае каждая пара файлов контрольных точек загружается на 50% после учета для удаленных строк.</span><span class="sxs-lookup"><span data-stu-id="fd46b-140">The second workload scenario is for frequent insert, delete, and update operations: In the worst case, each of the checkpoint file pairs are 50% loaded, after accounting for the deleted rows.</span></span> <span data-ttu-id="fd46b-141">Поэтому размер резервной копии для базы данных будет по крайней мере в два раза больше размера данных в памяти.</span><span class="sxs-lookup"><span data-stu-id="fd46b-141">So the size of the database backup will at least be 2 times the size of data in memory.</span></span> <span data-ttu-id="fd46b-142">Кроме того, будет мало пар файла контрольных точек в состоянии Merge source и Required for backup/high availability, из-за чего размер резервной копии базы данных еще увеличится.</span><span class="sxs-lookup"><span data-stu-id="fd46b-142">Additionally, there will few checkpoint file pairs in states Merge source and Required for backup/high availability that will add to the size of database backup.</span></span>  
  
## <a name="differential-backups-of-databases-with-memory-optimized-tables"></a><span data-ttu-id="fd46b-143">Разностные резервные копии баз данных с таблицами, оптимизированными для памяти</span><span class="sxs-lookup"><span data-stu-id="fd46b-143">Differential Backups of Databases with Memory-Optimized Tables</span></span>  
 <span data-ttu-id="fd46b-144">Хранилище оптимизированных для памяти таблиц состоит из файлов данных и разностных файлов, как описано в разделе [Устойчивость таблиц, оптимизированных для памяти](memory-optimized-tables.md).</span><span class="sxs-lookup"><span data-stu-id="fd46b-144">The storage for memory-optimized tables consists of data and delta files as described in [Durability for Memory-Optimized Tables](memory-optimized-tables.md).</span></span> <span data-ttu-id="fd46b-145">Разностная резервная копия базы данных с таблицами, оптимизированными для памяти, содержит следующие данные.</span><span class="sxs-lookup"><span data-stu-id="fd46b-145">The differential backup of a database with memory-optimized tables contains the following data:</span></span>  
  
-   <span data-ttu-id="fd46b-146">Присутствие оптимизированный для памяти таблицы не влияет разностное резервное копирование файловых групп для хранения дисковых таблиц.</span><span class="sxs-lookup"><span data-stu-id="fd46b-146">Differential backup for filegroups storing disk-based tables is not affected by the presence of memory-optimized tables.</span></span>  
  
-   <span data-ttu-id="fd46b-147">Журнал активной транзакции тот же, что и в полной резервной копии базы данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-147">The active transaction log is the same as in a full database backup.</span></span>  
  
-   <span data-ttu-id="fd46b-148">Для файловой группы, оптимизированной для памяти, разностная резервная копия для определения данных и разностных файлов, подлежащих резервному копированию, использует тот же алгоритм, что и полная резервная копия, но затем отфильтровывает подмножество файлов следующим образом.</span><span class="sxs-lookup"><span data-stu-id="fd46b-148">For a memory-optimized data filegroup, the differential backup uses the same algorithm as full database backup to identify the data and delta files for backup but it then filters out the subset of files as follows:</span></span>  
  
    -   <span data-ttu-id="fd46b-149">Файл данных содержит новые вставленные строки и после его заполнения закрывается и помечается как файл только для чтения.</span><span class="sxs-lookup"><span data-stu-id="fd46b-149">A data file contains newly inserted rows and when it is full, it is closed and marked read-only.</span></span> <span data-ttu-id="fd46b-150">Файл данных копируется только в том случае, если он был закрыт после создания последней полной резервной копии базы данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-150">A data file is backed up only if it was closed after the last full database backup.</span></span> <span data-ttu-id="fd46b-151">Операция разностного резервного копирования копирует только те файлы данных, что содержат строки, вставленные с момента создания последней полной резервной копии базы данных, за исключением случаев обновления и удаления, при которых некоторые из вставленных строк уже могли быть помечены для сборки мусора или собраны ранее.</span><span class="sxs-lookup"><span data-stu-id="fd46b-151">The differential backup only backups up data files containing the inserted rows since the last full database backup with the exception of an update and delete scenario where it is possible that some of the inserted rows may have already been either marked for garbage collection or already garbage collected.</span></span>  
  
    -   <span data-ttu-id="fd46b-152">Разностный файл хранит ссылки на удаленные строки данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-152">A delta file stores references to the deleted data rows.</span></span> <span data-ttu-id="fd46b-153">Поскольку любая будущая транзакция может удалить строку, а разностный файл может измениться в любой момент своего существования, он не закрываются никогда.</span><span class="sxs-lookup"><span data-stu-id="fd46b-153">Since any future transaction can delete a row, a delta file can be modified anytime in its life time, it is never closed.</span></span> <span data-ttu-id="fd46b-154">Разностный файл всегда сохраняется в резервную копию.</span><span class="sxs-lookup"><span data-stu-id="fd46b-154">A delta file is always backed up.</span></span> <span data-ttu-id="fd46b-155">Разностные файлы обычно используют менее 10 % хранилища, поэтому они оказывают минимальное влияние на размер разностной резервной копии.</span><span class="sxs-lookup"><span data-stu-id="fd46b-155">Delta files typically use less than 10% of the storage, so delta files have a minimal impact on the size of differential backup.</span></span>  
  
 <span data-ttu-id="fd46b-156">Если таблицы, оптимизированные для памяти, являются значительной частью размера базы данных, то разностная резервная копии может значительно уменьшить размер резервной копии.</span><span class="sxs-lookup"><span data-stu-id="fd46b-156">If memory-optimized tables are a significant portion of your database size, the differential backup can significantly reduce the size of your database backup.</span></span>  
  
 <span data-ttu-id="fd46b-157">Для типичных рабочих нагрузок OLTP разностные резервные копии будут намного меньше, чем полные резервные копии баз данных.</span><span class="sxs-lookup"><span data-stu-id="fd46b-157">For typical OLTP workloads, the differential backups will be considerably smaller than the full database backups.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="fd46b-158">См. также:</span><span class="sxs-lookup"><span data-stu-id="fd46b-158">See Also</span></span>  
 [<span data-ttu-id="fd46b-159">Резервное копирование и восстановление оптимизированных для памяти таблиц</span><span class="sxs-lookup"><span data-stu-id="fd46b-159">Backup, Restore, and Recovery of Memory-Optimized Tables</span></span>](restore-and-recovery-of-memory-optimized-tables.md)  
  
  
