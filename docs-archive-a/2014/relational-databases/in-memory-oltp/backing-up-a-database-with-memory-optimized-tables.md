---
title: Резервное копирование базы данных с оптимизированными для памяти таблицами | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 83d47694-e56d-4dae-b54e-14945bf8ba31
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 176448aa9d4bab4101ab2db12ffc9a8a7fd1a5b5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87655718"
---
# <a name="backing-up-a-database-with-memory-optimized-tables"></a>Резервное копирование базы данных с оптимизированными для памяти таблицами
  Резервные копии оптимизированных для памяти таблиц создаются в составе обычных резервных копий баз данных. Что же касается таблиц на дисках, то для обнаружения повреждений CHECKSUM пар файлов данных и разностных файлов проверяется в процессе резервного копирования базы данных.  
  
> [!NOTE]  
>  Во время резервного копирования, если обнаруживается ошибка CHECKSUM для одного или нескольких файлов в файловой группе, оптимизированной для памяти, невозможно будет восстановить и перезапустить базу данных. В таком случае потребуется восстановить базу данных из последней рабочей резервной копии. Если нет резервной копии, можно экспортировать данные из таблиц, оптимизированных для памяти, и таблиц на диске, после чего загрузить их обратно после удаления и повторного создания базы данных.  
  
 Полная резервная копия базы данных с одной или несколькими оптимизированными для памяти таблицами состоит из хранилища, выделенного для таблиц, находящихся на диске (если таковые имеются), активного журнала транзакций и пар файлов данных и разностных файлов (их также называют парами файлов контрольных точек) для оптимизированных для памяти таблиц. Однако, как описано в разделе [Устойчивость таблиц, оптимизированных для памяти](memory-optimized-tables.md), объем хранилища, используемый оптимизированными для памяти таблицами, может быть значительно больше, чем размер таблиц в памяти. Это оказывает влияние на размер резервной копии базы данных.  
  
## <a name="full-database-backup"></a>Полная резервная копия базы данных  
 В этом описании основное внимание уделяется резервному копированию баз данных только с долговременными, оптимизированными для памяти таблицами, так как резервное копирование таблиц, записанных на диск, ничем не отличается. Пары файлов контрольных точек из оптимизированной для памяти файловой группы могут находиться в различных состояниях. В приведенной далее таблице указано, какая часть файлов заносится в резервную копию.  
  
|Состояние пары файлов контрольных точек|Резервное копирование|  
|--------------------------------|------------|  
|PRECREATED|Только метаданные файла|  
|UNDER CONSTRUCTION|Только метаданные файла|  
|Активно|Метаданные файла и используемые байты|  
|Merge source|Метаданные файла и используемые байты|  
|Merge target|Только метаданные файла|  
|REQUIRED FOR BACKUP/HA|Метаданные файла и используемые байты|  
|IN TRANSITION TO TOMBSTONE|Только метаданные файла|  
|TOMBSTONE|Только метаданные файла|  
  
 Размер резервных копий баз данных, в которых есть одна или несколько оптимизированных для памяти таблиц, обычно больше, чем размер в памяти, но меньше, чем объем, занимаемый на диске. Дополнительный объем зависит от числа удаляемых строк и количества пар файла контрольных точек в состоянии Merge source и REQUIRED FOR BACKUP/HA, что косвенно зависит от рабочей нагрузки. Описание состояний для пар файлов контрольных точек см. в разделе [sys. dm_db_xtp_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql).  
  
### <a name="estimating-size-of-full-database-backup"></a>Оценка размера полной резервной копии базы данных  
  
> [!IMPORTANT]  
>  Не рекомендуется использовать значение BackupSizeInBytes для оценки размера резервной копии In-Memory OLTP.  
  
 Первый сценарий рабочей нагрузки предназначен (главным образом) для вставки. В этом случае большинство файлов данных будут находиться в состоянии Active, полностью загружены и с очень небольшим числом удаленных строк. Размер резервной копии базы данных будет близок к размеру данных в памяти.  
  
 Второй сценарий рабочей нагрузки предназначен для частого выполнения операций вставки, удаления и обновления: в худшем случае каждая пара файлов контрольных точек загружается на 50% после учета для удаленных строк. Поэтому размер резервной копии для базы данных будет по крайней мере в два раза больше размера данных в памяти. Кроме того, будет мало пар файла контрольных точек в состоянии Merge source и Required for backup/high availability, из-за чего размер резервной копии базы данных еще увеличится.  
  
## <a name="differential-backups-of-databases-with-memory-optimized-tables"></a>Разностные резервные копии баз данных с таблицами, оптимизированными для памяти  
 Хранилище оптимизированных для памяти таблиц состоит из файлов данных и разностных файлов, как описано в разделе [Устойчивость таблиц, оптимизированных для памяти](memory-optimized-tables.md). Разностная резервная копия базы данных с таблицами, оптимизированными для памяти, содержит следующие данные.  
  
-   Присутствие оптимизированный для памяти таблицы не влияет разностное резервное копирование файловых групп для хранения дисковых таблиц.  
  
-   Журнал активной транзакции тот же, что и в полной резервной копии базы данных.  
  
-   Для файловой группы, оптимизированной для памяти, разностная резервная копия для определения данных и разностных файлов, подлежащих резервному копированию, использует тот же алгоритм, что и полная резервная копия, но затем отфильтровывает подмножество файлов следующим образом.  
  
    -   Файл данных содержит новые вставленные строки и после его заполнения закрывается и помечается как файл только для чтения. Файл данных копируется только в том случае, если он был закрыт после создания последней полной резервной копии базы данных. Операция разностного резервного копирования копирует только те файлы данных, что содержат строки, вставленные с момента создания последней полной резервной копии базы данных, за исключением случаев обновления и удаления, при которых некоторые из вставленных строк уже могли быть помечены для сборки мусора или собраны ранее.  
  
    -   Разностный файл хранит ссылки на удаленные строки данных. Поскольку любая будущая транзакция может удалить строку, а разностный файл может измениться в любой момент своего существования, он не закрываются никогда. Разностный файл всегда сохраняется в резервную копию. Разностные файлы обычно используют менее 10 % хранилища, поэтому они оказывают минимальное влияние на размер разностной резервной копии.  
  
 Если таблицы, оптимизированные для памяти, являются значительной частью размера базы данных, то разностная резервная копии может значительно уменьшить размер резервной копии.  
  
 Для типичных рабочих нагрузок OLTP разностные резервные копии будут намного меньше, чем полные резервные копии баз данных.  
  
## <a name="see-also"></a>См. также:  
 [Резервное копирование и восстановление оптимизированных для памяти таблиц](restore-and-recovery-of-memory-optimized-tables.md)  
  
  
