---
title: Определение необходимости переноса таблицы или хранимой процедуры в выполняющуюся в памяти OLTP | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
helpviewer_keywords:
- Analyze, Migrate, Report
- AMR
ms.assetid: c1ef96f1-290d-4952-8369-2f49f27afee2
author: rothja
ms.author: jroth
ms.openlocfilehash: 8e517cff394bc0c813e34763469f75147a0a16c5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87664197"
---
# <a name="determining-if-a-table-or-stored-procedure-should-be-ported-to-in-memory-oltp"></a>Определение, должна ли таблица или хранимая процедура быть перенесена в In-Memory OLTP
  Сборщик производительности транзакций в [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] позволяет оценить производительность приложения базы данных, выполняющаяся в памяти. В отчете об анализе производительности транзакции также показано, сколько работы необходимо выполнить, чтобы включить In-Memory OLTP в приложении. После определения дисковой таблицы, которая переносится в In-Memory OLTP, можно для упрощения миграции таблицы использовать [советник по оптимизации для выполнения в памяти](memory-optimization-advisor.md). Аналогичным образом [Native Compilation Advisor](native-compilation-advisor.md) позволяет перенести хранимую процедуру в изначально скомпилированную хранимую процедуру.  
  
 В этом разделе обсуждаются следующие темы:  
  
-   Настройка хранилища данных управления.  
  
-   Настройка сбора данных.  
  
-   Создайте отчеты анализа производительности транзакции, чтобы определить таблицы и хранимые процедуры, оказывающие критическое влияние на производительность.  
  
 Дополнительные сведения о методологиях миграции см. в разделе [Выполняемая в памяти OLTP — стандартные шаблоны рабочей нагрузки и вопросы миграции](https://msdn.microsoft.com/library/dn673538.aspx).  
  
 Сборщик данных о производительности транзакции и отчеты анализа производительности транзакции позволяют выполнить следующие задачи.  
  
-   Анализ рабочей нагрузки позволяет определить, улучшится ли производительность OLTP в памяти. Сборщик данных о производительности транзакции собирает и оценивает характеристики производительности вашей рабочей нагрузки. . Отчет анализа производительности транзакции затем порекомендует таблицы и хранимые процедуры, для которых преобразование в In-Memory OLTP будет наиболее полезным.  
  
-   Помощь с планированием и выполнением миграции в OLTP в памяти. Миграция из дисковой таблицы в оптимизированную для памяти таблицу может занять много времени. Помощник по оптимизации для памяти позволит определить несовместимые компоненты в таблице, которые необходимо удалить до перемещения таблицы в In-Memory OLTP. Помощник также позволяет понять последствия переноса таблицы в оптимизированную для памяти таблицу для приложения.  
  
     Можно проверить, будет ли применение In-Memory OLTP полезно для приложения, если потребуется спланировать миграцию в In-Memory OLTP или перенести некоторые таблицы и хранимые процедуры в In-Memory OLTP.  
  
    > [!IMPORTANT]  
    >  Производительность системы базы данных зависит от многих факторов, которые не все могут отслеживаться и измеряться сборщиком данных о производительности транзакции. Поэтому отчет анализа производительности транзакции не гарантирует, что фактическое улучшение производительности будет соответствовать прогнозируемому, если были сделаны какие-либо прогнозы.  
  
 Сборщик данных о производительности транзакций и возможность создания отчета об анализе производительности транзакций устанавливаются при выборе **средства управления — основные** **средства или инструменты управления — дополнительно** при установке [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] .  
  
## <a name="best-practices"></a>Рекомендации  
 Рекомендуемый рабочий процесс проиллюстрирован на следующей блок-схеме. Желтые узлы представляют необязательные процедуры.  
  
 ![Рабочий процесс AMR](../../database-engine/media/amr-1.gif "Рабочий процесс AMR")  
  
 Можно использовать любой способ для получения базового уровня производительности, в том числе журналы счетчиков производительности или монитор активности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Сведения, которые используются при определении базового уровня производительности и сравнении:  
  
-   Потребление ресурсов ЦП [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
-   Потребление памяти [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
-   Операции ввода-вывода [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
-   Пропускная способность транзакций экземпляра при обработке транзакций.  
  
 Сборщик данных о производительности транзакции записывает данные каждые 15 минут. Чтобы получить пригодные результаты, запускайте сборщик данных о производительности транзакции как минимум на один час. Чтобы получить наилучший результат, запустите сборщик данных на такое время, какое необходимо для сбора данных для ваших основных сценариев. Создавайте отчет анализа производительности транзакции только после завершения сбора данных.  
  
 Настройте сборщик данных о производительности для выполнения на своем экземпляре [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] в производственной среде и соберите данные на экземпляре [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] в среде разработки (тестовой), чтобы сократить издержки. Сведения о том, как сохранить данные в базе данных хранилища данных управления на удаленном [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляре, см. в разделе [Настройка сбора данных на удаленном экземпляре SQL Server](determining-if-a-table-or-stored-procedure-should-be-ported-to-in-memory-oltp.md#xxx).  
  
## <a name="performance-impacts"></a>Влияние на производительность  
 Сборщик данных о производительности транзакции состоит из двух наборов элементов сбора данных.  
  
-   Анализ сведений об использовании таблицы  
  
-   Анализ хранимой процедуры  
  
 Наборы элементов сбора собирают данные из трех динамических административных представлений (DMV) через каждые 15 минут и передают данные в базу данных, настроенную на использование в качестве хранилища данных управления. Передача собранных данных почти не оказывает влияния на производительность.  
  
## <a name="use-the-transaction-performance-collector"></a>Использование сборщика данных о производительности транзакции  
 Для выполнения следующих шагов требуется [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] в [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].  
  
> [!IMPORTANT]  
>  Не изменяйте схему (не добавляйте и не удаляйте базы данных, не создавайте и не удаляйте таблицы) во время профилирования. Если схема базы данных изменится во время сбора данных, то база данных может неточно отразиться в отчете.  
  
### <a name="configure-management-data-warehouse"></a>Настройка хранилища данных управления  
 Хранилище данных управления должно быть настроено для использования сборщика данных о производительности транзакции.  
  
 Версия экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], для которого будет выполнен сбор данных (профиль), должна совпадать с версией [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], в которой настроено хранилище данных управления, или быть старее.  
  
1.  В обозревателе объектов разверните узел **Управление**.  
  
2.  Щелкните правой кнопкой мыши **сбор данных** и выберите **задачи** , а затем **Настройте хранилище данных управления**. Запустится **Мастер настройки хранилища данных управления** .  
  
3.  Нажмите кнопку **Далее** , чтобы выбрать базу данных, которая будет использоваться в качестве хранилища управляющих данных.  
  
4.  Нажмите кнопку **создать** , чтобы создать новую базу данных для хранения данных профиля. После завершения создания базы данных нажмите кнопку **Далее** в мастере.  
  
5.  На следующем шаге мастера вы можете добавить пользователей и имена входа. Можно сопоставить имена входа с членствами роли для экземпляра MDW. Этого не требуется для сбора данных из локального экземпляра. Если вы не собираете данные из локального экземпляра, можно предоставить членство в роли базы данных `mdw_admin` учетной записи, которая будет выполнять профилируемые транзакции. По завершении нажмите кнопку **Далее**.  
  
6.  Убедитесь, что запущен агент [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
7.  На следующем экране нажмите кнопку **Готово** , чтобы выйти из мастера.  
  
### <a name="configure-data-collection-on-a-local-ssnoversion-instance"></a>Настройка сбора данных на локальном экземпляре [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]  
 Для сбора данных необходимо запустить агент [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Необходимо настроить только один сборщик данных на сервере.  
  
 Сборщик данных можно настроить на SQL Server 2012 или более поздней версии [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .  
  
 Настройка сбора данных для передачи в базу данных хранилища данных управления на том же экземпляре.  
  
1.  В **обозревателе объектов**разверните узел **Управление**.  
  
2.  Щелкните правой кнопкой мыши элемент **сбор данных**, выберите **задачи**, а затем **Настройте сбор данных**. Запустится **Мастер настройки сбора данных** .  
  
3.  Нажмите кнопку **Далее** , чтобы выбрать базу данных, в которой будут собираются данные профиля.  
  
4.  Выберите текущий экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] и базу данных хранилища данных управления в этом экземпляре.  
  
5.  В поле **выберите Наборы сборщиков данных, которые необходимо включить**, выберите наборы элементов **сбора "производительность транзакций**". По завершении нажмите кнопку **Далее**.  
  
6.  Проверьте выбранные параметры. Нажмите кнопку **назад** , чтобы изменить параметры. По завершении нажмите кнопку **Готово** .  
  
###  <a name="configure-data-collection-on-a-remote-ssnoversion-instance"></a><a name="xxx"></a>Настройка сбора данных на удаленном [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляре  
 Для сбора данных требуется запущенный агент [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на экземпляре, который будет собирать данные.  
  
 Сборщик данных можно настроить на SQL Server 2012 или более поздней версии [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .  
  
 Вам требуется настроить прокси-агент [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] с правильными учетными данными для сборщика данных, чтобы передавать данные в базу данных хранилища данных управления в экземпляре, отличном от экземпляра, в котором будут профилироваться транзакции. Чтобы включить прокси-агент [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], необходимо сначала настроить учетные данные с именем входа в домен. Имя входа в домен должно быть участником группы `mdw_admin` для базы данных хранилища данных управления. Сведения о создании учетных данных см. в разделе [как создать учетные данные (SQL Server Management Studio)](../security/authentication-access/create-a-credential.md) .  
  
 Настройка сбора данных для передачи в базу данных хранилища данных управления на другом экземпляре.  
  
1.  В экземпляре, содержащем дисковые объекты, которые требуется перенести в выполняющуюся в памяти OLTP, разверните узел **Управление** в обозревателе объектов.  
  
2.  Щелкните правой кнопкой мыши **сбор данных** и выберите **задачи** , а затем **Настройте сбор данных**. Запустится **Мастер настройки сбора данных** .  
  
3.  Нажмите кнопку **Далее** , чтобы выбрать базу данных, в которой будут собираются данные профиля.  
  
4.  Убедитесь, что база данных хранилища данных управления существует в другом экземпляре [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
5.  Выберите другой экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] и базу данных хранилища данных управления в этом экземпляре.  
  
     Версия экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], для которого будет выполнен сбор данных (профиль), должна совпадать с версией [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], в которой настроено хранилище данных управления, или быть старее.  
  
6.  В поле **выберите Наборы сборщиков данных, которые необходимо включить**, выберите наборы элементов **сбора "производительность транзакций**".  
  
7.  Установите флажок **использовать [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] прокси-агент для удаленных отправок**.  
  
8.  По завершении нажмите кнопку **Далее**.  
  
9. Выберите прокси.  
  
     Чтобы создать новую запись агента-посредника [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)],  
  
    1.  Нажмите кнопку **создать** , чтобы открыть диалоговое окно **Создание учетной записи-посредника** .  
  
    2.  В диалоговом окне **создать учетную запись-посредник** введите имя учетной записи-посредника, выберите учетные данные и при необходимости введите описание. Затем щелкните **субъекты**.  
  
    3.  Нажмите кнопку **Добавить** и выберите роль **msdb** .  
  
    4.  Выберите `dc_proxy` и нажмите кнопку **ОК**. Затем повторно нажмите **OK**.  
  
     После выбора правильного прокси-сервера нажмите кнопку **Далее**.  
  
10. Чтобы настроить системные наборы сбора, проверьте **системные наборы сбора** и нажмите кнопку **Далее**.  
  
11. Проверьте выбранные параметры. Нажмите кнопку **назад** , чтобы изменить параметры. По **Finish** завершении кликкк.  
  
 Теперь наборы сбора данных настроены и запущены на вашем экземпляре.  
  
### <a name="generate-reports"></a>Формирование отчета  
 Вы можете создать отчеты об анализе производительности транзакций, щелкнув правой кнопкой мыши базу данных хранилища данных управления и выбрав пункт **отчеты**, затем **хранилище данных управления**, а затем — **Обзор анализа производительности транзакций**.  
  
 Отчет собирает сведения обо всех пользовательских базах данных на сервере рабочей нагрузки. Если база данных хранилища данных управления (MDW) находится на локальном компьютере, в отчете будут показаны базы данных MDW.  
  
 Хранимая процедура с высоким коэффициентом расхода времени ЦП — кандидат для миграции. В отчете отображаются все ссылки на таблицу, поскольку скомпилированные хранимые процедуры могут ссылаться только на таблицы, оптимизированные для памяти, что может увеличить расходы времени при миграции.  
  
 Подробный отчет для таблицы состоит из трех разделов.  
  
-   Раздел статистики сканирования  
  
     Этот раздел содержит одну таблицу с собранными статистическими данными о сканированиях таблицы базы данных. Это следующие столбцы:  
  
    -   Процент от общего количества обращений. Процент операций сканирования и поиска в этой таблице от активности всей базы данных. Чем выше это значение, тем интенсивнее эта таблица использовалась по сравнению с другими таблицами в базе данных.  
  
    -   Статистика поиска или статистика сканирования диапазона. В этом столбце указывается число уточняющих запросов и сканирований диапазона (индекса и таблиц), выполненных для таблицы во время профилирования. Среднее значение для одной транзакции является приблизительным.  
  
    -   Приращение взаимодействия и собственное приращение. В этих столбцах указывается приблизительная сумма прироста производительности уточняющего запроса или сканирования диапазона, которой удалось бы добиться, если бы таблица была преобразована в оптимизированную для памяти таблицу.  
  
-   Раздел статистики блокировки  
  
     В этом разделе представлена таблица, в которой отображаются блокировки для таблицы базы данных. Дополнительные сведения о кратковременных блокировках и блокировках базы данных см. в разделе [архитектура блокировки](https://msdn.microsoft.com/library/aa224738\(v=sql.80\).aspx). Существуют следующие столбцы.  
  
    -   Процент от общего ожидания. Процент ожидания блокировок и кратковременных блокировок в этой таблице по сравнению с активностью базы данных. Чем выше это значение, тем интенсивнее эта таблица использовалась по сравнению с другими таблицами в базе данных.  
  
    -   Статистика кратковременных блокировок. В этих столбцах указывается число ожиданий кратковременных блокировок для запросов к этой таблице. Сведения об кратковременных блокировках см. в разделе [кратковременная блокировка](https://msdn.microsoft.com/library/aa224727\(v=SQL.80\).aspx). Чем больше это значение, тем больше конфликтов кратковременных блокировок в таблице.  
  
    -   Статистика блокировок. В этой группе столбцов указывается число получений и ожиданий блокировок для запросов к этой таблице. Дополнительные сведения о блокировках см. [в разделе Основные сведения о блокировке в SQL Server](https://msdn.microsoft.com/library/aa213039\(v=SQL.80\).aspx). Чем больше ожиданий, тем больше конфликтов блокировок в таблице.  
  
-   Раздел трудностей с миграцией  
  
     Этот раздел содержит таблицу со сведениями о трудностях, связанных с преобразованием этой таблицы базы данных в оптимизированную для памяти таблицу. Чем выше оценка трудности, тем сложнее преобразовать таблицу. Чтобы просмотреть сведения для преобразования этой таблицы базы данных, используйте [Помощник по оптимизации памяти](memory-optimization-advisor.md).  
  
 Статистика сканирования и состязаний для отчета о таблицах собирается и объединена из [sys. dm_db_index_operational_stats &#40;&#41;Transact-SQL ](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-index-operational-stats-transact-sql).  
  
 Подробный отчет для хранимой процедуры состоит из двух разделов.  
  
-   Раздел статистики выполнения  
  
     Этот раздел содержит таблицу с собранными статистическими данными о выполнении хранимой процедуры. Существуют следующие столбцы.  
  
    -   Время кэширования. Время, в течение которого план выполнения был кэширован. Если хранимая процедура выходит из кэша плана и заново в него входит, время будет указано для каждого кэша.  
  
    -   Всего времени ЦП. Общее время ЦП, затраченное хранимой процедурой во время профилирования. Чем больше это значение, тем больше ресурсов ЦП использовала хранимая процедура.  
  
    -   Общее время выполнения. Общее время выполнения, затраченное на хранимую процедуру во время профилирования. Чем больше разница между этим значением и временем ЦП, тем менее эффективно хранимая процедура использует ЦП.  
  
    -   Всего промахов кэша. Число промахов кэша (операций чтения из физического хранилища), вызванное выполнением хранимой процедуры во время профилирования.  
  
    -   Число выполнений. Количество выполнений этой хранимой процедуры во время профилирования.  
  
-   Раздел ссылок на таблицы  
  
     Этот раздел содержит таблицу, в которой показаны таблицы, на которые ссылается эта хранимая процедура. Перед преобразованием хранимой процедуры в скомпилированную в собственном коде хранимую процедуру все эти таблицы должны быть преобразованы в оптимизированные для памяти таблицы, при этом они должны находиться на одном сервере и в одной базе данных.  
  
 Статистика выполнения для подробного отчета о хранимых процедурах собираются и объединяется из [sys. dm_exec_procedure_stats &#40;&#41;Transact-SQL ](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-procedure-stats-transact-sql). Ссылки получаются из [каталога sys. sql_expression_dependencies &#40;&#41;Transact-SQL ](/sql/relational-databases/system-catalog-views/sys-sql-expression-dependencies-transact-sql).  
  
 Чтобы просмотреть сведения о преобразовании хранимой процедуры в скомпилированную в собственном код хранимую процедуру, используйте [Помощник по компиляции в машинный](native-compilation-advisor.md)код.  
  
## <a name="see-also"></a>См. также:  
 [Миграция в In-Memory OLTP](migrating-to-in-memory-oltp.md)  
  
  
