---
title: Создание хранимых процедур, скомпилированных в собственном коде | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: e6b34010-cf62-4f65-bbdf-117f291cde7b
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 3e8e8139427c7f2ad92eea856be8da542f65e344
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87657102"
---
# <a name="creating-natively-compiled-stored-procedures"></a>Создание хранимых процедур, скомпилированных в собственном коде
  Скомпилированные в собственном коде хранимые процедуры не реализуют полные возможности программирования [!INCLUDE[tsql](../../includes/tsql-md.md)] и контактную зону запросов. Некоторые конструкции [!INCLUDE[tsql](../../includes/tsql-md.md)] не могут быть использованы внутри хранимых процедур, скомпилированных в собственном коде. Дополнительные сведения см. [в разделе Поддерживаемые конструкции в хранимых процедурах, скомпилированных в собственном](../in-memory-oltp/supported-features-for-natively-compiled-t-sql-modules.md)виде.  
  
 Однако некоторые функции [!INCLUDE[tsql](../../includes/tsql-md.md)] поддерживаются только для хранимых процедур, скомпилированных в собственном коде:  
  
-   Блоки ATOMIC. Дополнительные сведения см. в статье [Atomic Blocks](atomic-blocks-in-native-procedures.md).  
  
-   Ограничения `NOT NULL` на параметры и переменные в хранимых процедурах, скомпилированных в собственном коде. Нельзя назначить значения `NULL` параметрам или переменным, объявленным как `NOT NULL`. Дополнительные сведения см. в статье [DECLARE @local_variable (Transact-SQL)](/sql/t-sql/language-elements/declare-local-variable-transact-sql).  
  
-   Привязка к схеме хранимых процедур, скомпилированных в собственном коде.  
  
 Скомпилированные в собственном коде хранимые процедуры создаются с помощью [CREATE PROCEDURE (Transact-SQL)](/sql/t-sql/statements/create-procedure-transact-sql). В следующем примере показаны оптимизированная для памяти таблица и скомпилированная в собственном коде хранимая процедура, используемая для вставки строк в таблицу.  
  
```sql  
create table dbo.Ord  
(OrdNo integer not null primary key nonclustered,   
 OrdDate datetime not null,   
 CustCode nvarchar(5) not null)   
 with (memory_optimized=on)  
go  
  
create procedure dbo.OrderInsert(@OrdNo integer, @CustCode nvarchar(5))  
with native_compilation, schemabinding, execute as owner  
as   
begin atomic with  
(transaction isolation level = snapshot,  
language = N'English')  
  
  declare @OrdDate datetime = getdate();  
  insert into dbo.Ord (OrdNo, CustCode, OrdDate) values (@OrdNo, @CustCode, @OrdDate);  
end  
go  
```  
  
 В образце кода `NATIVE_COMPILATION` указывает, что данная хранимая процедура [!INCLUDE[tsql](../../includes/tsql-md.md)] представляет собой хранимую процедуру, скомпилированную в собственном коде. Требуются следующие параметры.  
  
|Параметр|Описание|  
|------------|-----------------|  
|`SCHEMABINDING`|Скомпилированная в собственном коде хранимая процедура должна быть привязана к схеме объектов, на которые она ссылается. Это означает, что ссылки на таблицу со стороны процедуры не могут быть удалены. Таблицы, на которые ссылается процедура, должны включать имя схемы, а подстановочные знаки ( \* ) не допускаются в запросах. Параметр`SCHEMABINDING` поддерживается только для хранимых процедур, скомпилированных в собственном коде, в этой версии [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].|  
|`EXECUTE AS`|Хранимые процедуры, скомпилированные в собственном коде, не поддерживают `EXECUTE AS CALLER`, который является контекстом выполнения по умолчанию. Поэтому необходимо указать контекст выполнения. `EXECUTE AS OWNER`Поддерживаются параметры, `EXECUTE AS` *User*и `EXECUTE AS SELF` .|  
|`BEGIN ATOMIC`|Тело хранимой процедуры, скомпилированной в собственном коде, должно представлять собой только один блок ATOMIC. Блоки ATOMIC гарантируют атомарное выполнение хранимой процедуры. Если процедура вызывается вне контекста активной транзакции, то запускает новую транзакцию, которая фиксируется после блока ATOMIC. Блоки ATOMIC в хранимых процедурах, скомпилированных в собственном коде, имеют два обязательных параметра:<br /><br /> `TRANSACTION ISOLATION LEVEL`. См. раздел [уровни изоляции транзакций](../../database-engine/transaction-isolation-levels.md) для поддерживаемых уровней изоляции.<br /><br /> `LANGUAGE`. Для хранимой процедуры необходимо назначить один из доступных языков или псевдонимов языка.|  
  
 В случае `EXECUTE AS` и имени входа Windows ошибка может возникать из-за олицетворения с помощью `EXECUTE AS`. Если пользовательская учетная запись использует проверку подлинности Windows, должно иметься полное доверие между учетной записью службы, используемой для экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], и доменом имени входа Windows. Если полное доверие не установлено, при создании скомпилированной в собственном коде хранимой процедуры возвращается следующее сообщение об ошибке: MSG 15404. не удалось получить сведения о пользователе или группе Windows NT "Username", код ошибки 0x5.  
  
 Чтобы устранить эту неполадку, выполните следующее.  
  
-   Используйте для службы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] учетную запись из домена, к которому относится пользователь Windows.  
  
-   Если [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] использует учетную запись компьютера, например Network Service или Local System, то домен, на котором находится пользователь Windows, должен иметь доверенную связь с компьютером.  
  
-   Используйте проверку подлинности [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
 При создании скомпилированной в собственном коде хранимой процедуры также можно видеть ошибку 15517. Дополнительные сведения см. в разделе [MSSQLSERVER_15517](../errors-events/mssqlserver-15517-database-engine-error.md).  
  
## <a name="updating-a-natively-compiled-stored-procedure"></a>Обновление хранимой процедуры, скомпилированной в собственном коде  
 Выполнение операций изменения для скомпилированных в собственном коде хранимых процедур не поддерживается. Один из способов изменения скомпилированной в собственном коде хранимой процедуры — ее удаление и повторное создание.  
  
1.  Создайте скрипт для разрешений на хранимую процедуру.  
  
2.  Или же создайте скрипт для хранимой процедуры и сохраните в виде резервной копии.  
  
3.  Удалите хранимую процедуру.  
  
4.  Создайте измененную хранимую процедуру.  
  
5.  Повторно примените разрешения на основе скрипта к хранимой процедуре.  
  
 Недостаток данного подхода заключается в том, что приложение будет недоступно с начала выполнения шага 3 и до завершения шага 5. Это может занять несколько секунд, и клиенту, использующему приложение, могут быть выданы сообщения об ошибке.  
  
 Другой способ эффективного изменения скомпилированной в собственном коде хранимой процедуры заключается в предварительном создании новой версии хранимой процедуры. В данном примере скомпилированная в собственном коде хранимая процедура имеет соответствующий номер версии. Вызовем старую версию SP_Vold и новую версию SP_Vnew.  
  
1.  Сформируйте скрипт для разрешений на SP_Vold.  
  
2.  Создайте SP_Vnew.  
  
3.  Примените разрешения SP_Vold в SP_Vnew.  
  
4.  Ссылки на SP_Vold обновите на SP_Vnew. Для этого существует несколько способов, например:  
  
     Измените хранимую процедуру оболочки (на диске) так, чтобы она указывала на SP_Vnew. Недостаток этого подхода заключается в ухудшении производительности из-за косвенного обращения.  
  
    ```sql  
    ALTER PROCEDURE dbo.SP p1,...,pn  
    AS  
      EXEC dbo.SP_Vnew p1,...,pn  
    GO  
    ```  
  
5.  Удалите SP_Vold (необязательно).  
  
 Преимущество этого подхода заключается в том, что приложение не переходит в автономный режим. Однако для поддержания ссылок и постоянного указания на последнюю версию хранимой процедуры требуются дополнительные усилия.  
  
## <a name="see-also"></a>См. также:  
 [Скомпилированные в собственном коде хранимые процедуры](natively-compiled-stored-procedures.md)  
  
  
