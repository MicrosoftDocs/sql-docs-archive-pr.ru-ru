---
title: Восстановление оптимизированных для памяти таблиц | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 294975b7-e7d1-491b-b66a-fdb1100d2acc
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 5e702798ea68745a038407fb65af7726a5c5d50e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87666592"
---
# <a name="restore-and-recovery-of-memory-optimized-tables"></a><span data-ttu-id="1b924-102">Восстановление оптимизированных для памяти таблиц</span><span class="sxs-lookup"><span data-stu-id="1b924-102">Restore and Recovery of Memory-Optimized Tables</span></span>
  <span data-ttu-id="1b924-103">Базовый механизм восстановления баз данных с таблицами, оптимизированными для памяти, аналогичен методу для баз данных, содержащих только таблицы на диске.</span><span class="sxs-lookup"><span data-stu-id="1b924-103">The basic mechanism to recover or restore a database with memory-optimized tables is similar to databases with only disk-based tables.</span></span> <span data-ttu-id="1b924-104">Но в отличие от метода для таблиц на диске оптимизированные для памяти таблицы должны быть загружены в память до того, как база данных будет доступна для доступа пользователей.</span><span class="sxs-lookup"><span data-stu-id="1b924-104">But unlike disk-based tables, memory-optimized tables must be loaded into memory before database is available for user access.</span></span> <span data-ttu-id="1b924-105">При этом добавляется новый этап восстановления базы данных.</span><span class="sxs-lookup"><span data-stu-id="1b924-105">This adds a new step in the database recovery.</span></span> <span data-ttu-id="1b924-106">Измененные этапы восстановления баз данных изменяются следующим образом.</span><span class="sxs-lookup"><span data-stu-id="1b924-106">The modified steps in database recovery are changed as follows:</span></span>

 <span data-ttu-id="1b924-107">При перезапуске [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] для каждой базы данных выполняется этап восстановления, который состоит из следующих трех фаз.</span><span class="sxs-lookup"><span data-stu-id="1b924-107">When the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] restarts, each database goes through a recovery phase that consists of the following three phases:</span></span>

1.  <span data-ttu-id="1b924-108">Фаза анализа.</span><span class="sxs-lookup"><span data-stu-id="1b924-108">The analysis phase.</span></span> <span data-ttu-id="1b924-109">Во время этой фазы передача осуществляется в активные журналы транзакций для обнаружения фиксированных и незафиксированных транзакций.</span><span class="sxs-lookup"><span data-stu-id="1b924-109">During this phase, a pass is made on the active transaction logs to detect committed and uncommitted transactions.</span></span> <span data-ttu-id="1b924-110">Модуль In-Memory OLTP определяет контрольную точку для загрузки и выполняет предварительную загрузку соответствующих записей журналов системных таблиц.</span><span class="sxs-lookup"><span data-stu-id="1b924-110">The In-Memory OLTP engine identifies the checkpoint to load and preloads its system table log entries.</span></span> <span data-ttu-id="1b924-111">При этом также выполняется обработка определенных записей журналов распределения файлов.</span><span class="sxs-lookup"><span data-stu-id="1b924-111">It will also process some file allocation log records.</span></span>

2.  <span data-ttu-id="1b924-112">Стадия повтора.</span><span class="sxs-lookup"><span data-stu-id="1b924-112">The redo phase.</span></span> <span data-ttu-id="1b924-113">Эта фаза выполняется одновременно с таблицами на диске и с таблицами, оптимизированными для памяти.</span><span class="sxs-lookup"><span data-stu-id="1b924-113">This phase is run concurrently on both disk-based and memory-optimized tables.</span></span>

     <span data-ttu-id="1b924-114">Для дисковых таблиц база данных перемещается в текущий момент времени и в ней настраиваются блокировки для незафиксированных транзакций.</span><span class="sxs-lookup"><span data-stu-id="1b924-114">For disk-based tables, the database is moved to the current point in time and acquires locks taken by uncommitted transactions.</span></span>

     <span data-ttu-id="1b924-115">Для таблиц, оптимизированных для памяти, данные из пар данных и разностных файлов загружаются в память, а данные обновляются с учетом активных журналов транзакций на основе последней надежной контрольной точки.</span><span class="sxs-lookup"><span data-stu-id="1b924-115">For memory-optimized tables, data from the data and delta file pairs are loaded into memory and then update the data with the active transaction log based on the last durable checkpoint.</span></span>

     <span data-ttu-id="1b924-116">После описанных выше операция с таблицами на диске и таблицами, оптимизированными для памяти, база данных становится готова для доступа.</span><span class="sxs-lookup"><span data-stu-id="1b924-116">When the above operations on disk-based and memory-optimized tables are complete, the database is available for access.</span></span>

3.  <span data-ttu-id="1b924-117">Стадия отката.</span><span class="sxs-lookup"><span data-stu-id="1b924-117">The undo phase.</span></span> <span data-ttu-id="1b924-118">В этой фазе выполняется откат незафиксированных транзакций.</span><span class="sxs-lookup"><span data-stu-id="1b924-118">In this phase, the uncommitted transactions are rolled back.</span></span>

 <span data-ttu-id="1b924-119">Загрузка в память таблиц, оптимизированных для памяти, может повлиять на производительность целевого времени восстановления (RTO).</span><span class="sxs-lookup"><span data-stu-id="1b924-119">Loading memory-optimized tables into memory can affect performance of the recovery time objective (RTO).</span></span> <span data-ttu-id="1b924-120">Чтобы сократить время загрузки оптимизированных для памяти данных из файлов данных и разностных файлов, модуль In-Memory OLTP загружает данные и разностные параллельно следующим образом.</span><span class="sxs-lookup"><span data-stu-id="1b924-120">To improve the load time of memory-optimized data from data and delta files, the In-Memory OLTP engine loads the data/delta files in parallel as follows:</span></span>

-   <span data-ttu-id="1b924-121">Создание фильтра сопоставления данных.</span><span class="sxs-lookup"><span data-stu-id="1b924-121">Creating a Delta Map Filter.</span></span> <span data-ttu-id="1b924-122">Хранилище разностных файлов ссылается на удаленные строки.</span><span class="sxs-lookup"><span data-stu-id="1b924-122">Delta files store references to the deleted rows.</span></span> <span data-ttu-id="1b924-123">Один поток на контейнер считывает разностные файлы и создает фильтр сопоставления данных.</span><span class="sxs-lookup"><span data-stu-id="1b924-123">One thread per container reads the delta files and creates a delta map filter.</span></span> <span data-ttu-id="1b924-124">(Оптимизированная для памяти файловая группа данных может содержать один или несколько контейнеров.)</span><span class="sxs-lookup"><span data-stu-id="1b924-124">(A memory optimized data filegroup can have one or more containers.)</span></span>

-   <span data-ttu-id="1b924-125">Потоковая передача файлов данных.</span><span class="sxs-lookup"><span data-stu-id="1b924-125">Streaming the data files.</span></span>  <span data-ttu-id="1b924-126">После создания фильтра сопоставления разностных файлов файлы данных считываются с использованием числа потоков, идентичных логическим ЦП.</span><span class="sxs-lookup"><span data-stu-id="1b924-126">Once the delta-map filter is created, data files are read using as many threads as there are logical CPUs.</span></span> <span data-ttu-id="1b924-127">Каждый поток при чтении файла данных считывает строки данных, проверяет связанное сопоставление и только вставляет строку в таблицу, если эта строка не была помечена как удаленная.</span><span class="sxs-lookup"><span data-stu-id="1b924-127">Each thread reading the data file reads the data rows, checks the associated delta map and only inserts the row into table if this row has not been marked deleted.</span></span> <span data-ttu-id="1b924-128">Эта часть процесса восстановления в некоторых случаях может быть ограничена ресурсами ЦП, как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="1b924-128">This part of recovery can be CPU bound in some cases as noted below.</span></span>

 <span data-ttu-id="1b924-129">![Оптимизированные для памяти таблицы.](../../database-engine/media/memory-optimized-tables.gif "Оптимизированные для памяти таблицы.")</span><span class="sxs-lookup"><span data-stu-id="1b924-129">![Memory-optimized tables.](../../database-engine/media/memory-optimized-tables.gif "Memory-optimized tables.")</span></span>

 <span data-ttu-id="1b924-130">Оптимизированные таблицы для памяти обычно можно загрузить в память на скорости операций ввода-вывода, но существуют ситуации, когда скорость загрузки строк данных в память будет ниже.</span><span class="sxs-lookup"><span data-stu-id="1b924-130">Memory-optimized tables can generally be loaded into memory at the speed of I/O but there are cases when loading data rows into memory will be slower.</span></span> <span data-ttu-id="1b924-131">Особые случаи:</span><span class="sxs-lookup"><span data-stu-id="1b924-131">Specific cases are:</span></span>

-   <span data-ttu-id="1b924-132">Небольшое число контейнеров для хэш-индекса может привести к конфликту наложения, что снизит скорость операций вставки строк данных.</span><span class="sxs-lookup"><span data-stu-id="1b924-132">Low bucket count for hash index can lead to excessive collision causing data row inserts to be slower.</span></span> <span data-ttu-id="1b924-133">Обычно это приводит к большой нагрузке на ЦП, особенно в последней части операции восстановления.</span><span class="sxs-lookup"><span data-stu-id="1b924-133">This generally results in very high CPU utilization throughout, and especially towards the end of recovery.</span></span> <span data-ttu-id="1b924-134">Если настроить хэш-индекс правильно, он не должен влиять на время восстановления.</span><span class="sxs-lookup"><span data-stu-id="1b924-134">If you configured the hash index correctly, it should not impact the recovery time.</span></span>

-   <span data-ttu-id="1b924-135">Большие таблицы, оптимизированные для памяти, с одним или несколькими некластеризованными индексами, в отличие от хэш-индексов, в которых число контейнеров определяется во время создания, число некластеризованных индексов может увеличиваться не динамически, результатом чего является высокая загрузка ЦП.</span><span class="sxs-lookup"><span data-stu-id="1b924-135">Large memory-optimized tables with one or more nonclustered indexes, unlike a hash index whose bucket count is sized at create time, the nonclustered indexes grow dynamically, resulting in high CPU utilization.</span></span>

## <a name="restoring-a-database-with-memory-optimized-tables"></a><span data-ttu-id="1b924-136">Восстановление базы данных с помощью таблиц, оптимизированных для памяти</span><span class="sxs-lookup"><span data-stu-id="1b924-136">Restoring a Database with Memory-optimized tables</span></span>
 <span data-ttu-id="1b924-137">Известно, что на сервере имеется достаточно памяти для восстановления базы данных, однако существует требование, что память, необходимую базе данных, следует учитывать как часть существующего пула ресурсов.</span><span class="sxs-lookup"><span data-stu-id="1b924-137">You know that you have sufficient memory on the server to restore a database, but there's a requirement  that the memory needed by the database is accounted for as part of an existing Resource Pool.</span></span>  <span data-ttu-id="1b924-138">Вы знаете, что невозможно создать привязку к пулу ресурсов до тех пор, пока база данных не существует, поэтому выполните восстановление WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="1b924-138">You know that you cannot create the binding to the resource pool before the database exists, so you perform the restore WITH NORECOVERY.</span></span>  <span data-ttu-id="1b924-139">В результате учитывается образ диска для восстановления и создания базы данных, а не память In-Memory OLTP, так как база данных не подключается.</span><span class="sxs-lookup"><span data-stu-id="1b924-139">This causes the disk image of the database to be restored and the database to be created, but no In-Memory OLTP memory is consumed because the database is not brought online.</span></span>

 <span data-ttu-id="1b924-140">На этом этапе можно создать пул ресурсов для привязки базы данных, а затем использовать инструкцию RESTORE WITH RECOVERY, чтобы подключить восстановленную базу данных.</span><span class="sxs-lookup"><span data-stu-id="1b924-140">At this point, you can create the Resource Pool to Database binding, and then use RESTORE WITH RECOVERY to bring the restored database online.</span></span>  <span data-ttu-id="1b924-141">Поскольку привязка производится на месте перед подключением базы данных, использование памяти In-Memory OLTP учитывается правильно.</span><span class="sxs-lookup"><span data-stu-id="1b924-141">Since the binding is in place before the database is brought online, its In-Memory OLTP memory consumption is properly accounted for.</span></span> <span data-ttu-id="1b924-142">Для этого необходимо восстановить базу данных только один раз.</span><span class="sxs-lookup"><span data-stu-id="1b924-142">This requires restoring the database only once.</span></span> <span data-ttu-id="1b924-143">Первая команда RESTORE является информационной и только считывает заголовок резервной копии, а последняя — просто активирует восстановление без фактического восстановления всех битов.</span><span class="sxs-lookup"><span data-stu-id="1b924-143">The first RESTORE command is an informational command that only reads the backup header, and the last command simply triggers recovery without actually restoring any bits.</span></span>

## <a name="see-also"></a><span data-ttu-id="1b924-144">См. также:</span><span class="sxs-lookup"><span data-stu-id="1b924-144">See Also</span></span>
 [<span data-ttu-id="1b924-145">Резервное копирование и восстановление оптимизированных для памяти таблиц</span><span class="sxs-lookup"><span data-stu-id="1b924-145">Backup, Restore, and Recovery of Memory-Optimized Tables</span></span>](memory-optimized-tables.md)


