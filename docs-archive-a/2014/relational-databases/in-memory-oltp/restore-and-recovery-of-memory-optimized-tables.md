---
title: Восстановление оптимизированных для памяти таблиц | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 294975b7-e7d1-491b-b66a-fdb1100d2acc
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 5e702798ea68745a038407fb65af7726a5c5d50e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87666592"
---
# <a name="restore-and-recovery-of-memory-optimized-tables"></a>Восстановление оптимизированных для памяти таблиц
  Базовый механизм восстановления баз данных с таблицами, оптимизированными для памяти, аналогичен методу для баз данных, содержащих только таблицы на диске. Но в отличие от метода для таблиц на диске оптимизированные для памяти таблицы должны быть загружены в память до того, как база данных будет доступна для доступа пользователей. При этом добавляется новый этап восстановления базы данных. Измененные этапы восстановления баз данных изменяются следующим образом.

 При перезапуске [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] для каждой базы данных выполняется этап восстановления, который состоит из следующих трех фаз.

1.  Фаза анализа. Во время этой фазы передача осуществляется в активные журналы транзакций для обнаружения фиксированных и незафиксированных транзакций. Модуль In-Memory OLTP определяет контрольную точку для загрузки и выполняет предварительную загрузку соответствующих записей журналов системных таблиц. При этом также выполняется обработка определенных записей журналов распределения файлов.

2.  Стадия повтора. Эта фаза выполняется одновременно с таблицами на диске и с таблицами, оптимизированными для памяти.

     Для дисковых таблиц база данных перемещается в текущий момент времени и в ней настраиваются блокировки для незафиксированных транзакций.

     Для таблиц, оптимизированных для памяти, данные из пар данных и разностных файлов загружаются в память, а данные обновляются с учетом активных журналов транзакций на основе последней надежной контрольной точки.

     После описанных выше операция с таблицами на диске и таблицами, оптимизированными для памяти, база данных становится готова для доступа.

3.  Стадия отката. В этой фазе выполняется откат незафиксированных транзакций.

 Загрузка в память таблиц, оптимизированных для памяти, может повлиять на производительность целевого времени восстановления (RTO). Чтобы сократить время загрузки оптимизированных для памяти данных из файлов данных и разностных файлов, модуль In-Memory OLTP загружает данные и разностные параллельно следующим образом.

-   Создание фильтра сопоставления данных. Хранилище разностных файлов ссылается на удаленные строки. Один поток на контейнер считывает разностные файлы и создает фильтр сопоставления данных. (Оптимизированная для памяти файловая группа данных может содержать один или несколько контейнеров.)

-   Потоковая передача файлов данных.  После создания фильтра сопоставления разностных файлов файлы данных считываются с использованием числа потоков, идентичных логическим ЦП. Каждый поток при чтении файла данных считывает строки данных, проверяет связанное сопоставление и только вставляет строку в таблицу, если эта строка не была помечена как удаленная. Эта часть процесса восстановления в некоторых случаях может быть ограничена ресурсами ЦП, как описано ниже.

 ![Оптимизированные для памяти таблицы.](../../database-engine/media/memory-optimized-tables.gif "Оптимизированные для памяти таблицы.")

 Оптимизированные таблицы для памяти обычно можно загрузить в память на скорости операций ввода-вывода, но существуют ситуации, когда скорость загрузки строк данных в память будет ниже. Особые случаи:

-   Небольшое число контейнеров для хэш-индекса может привести к конфликту наложения, что снизит скорость операций вставки строк данных. Обычно это приводит к большой нагрузке на ЦП, особенно в последней части операции восстановления. Если настроить хэш-индекс правильно, он не должен влиять на время восстановления.

-   Большие таблицы, оптимизированные для памяти, с одним или несколькими некластеризованными индексами, в отличие от хэш-индексов, в которых число контейнеров определяется во время создания, число некластеризованных индексов может увеличиваться не динамически, результатом чего является высокая загрузка ЦП.

## <a name="restoring-a-database-with-memory-optimized-tables"></a>Восстановление базы данных с помощью таблиц, оптимизированных для памяти
 Известно, что на сервере имеется достаточно памяти для восстановления базы данных, однако существует требование, что память, необходимую базе данных, следует учитывать как часть существующего пула ресурсов.  Вы знаете, что невозможно создать привязку к пулу ресурсов до тех пор, пока база данных не существует, поэтому выполните восстановление WITH NORECOVERY.  В результате учитывается образ диска для восстановления и создания базы данных, а не память In-Memory OLTP, так как база данных не подключается.

 На этом этапе можно создать пул ресурсов для привязки базы данных, а затем использовать инструкцию RESTORE WITH RECOVERY, чтобы подключить восстановленную базу данных.  Поскольку привязка производится на месте перед подключением базы данных, использование памяти In-Memory OLTP учитывается правильно. Для этого необходимо восстановить базу данных только один раз. Первая команда RESTORE является информационной и только считывает заголовок резервной копии, а последняя — просто активирует восстановление без фактического восстановления всех битов.

## <a name="see-also"></a>См. также:
 [Резервное копирование и восстановление оптимизированных для памяти таблиц](memory-optimized-tables.md)


