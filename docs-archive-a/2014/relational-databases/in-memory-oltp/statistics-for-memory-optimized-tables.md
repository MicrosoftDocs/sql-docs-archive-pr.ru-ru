---
title: Статистика для оптимизированных для памяти таблиц | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: e644766d-1d1c-43d7-83ff-8ccfe4f3af9f
author: rothja
ms.author: jroth
ms.openlocfilehash: 0ae09d76c2642e23c56afcdd5ae4e1e468ef5883
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87749892"
---
# <a name="statistics-for-memory-optimized-tables"></a>Статистика для таблиц, оптимизированных для памяти
  Оптимизатор запросов использует статистику о столбцах для создания планов запросов, которые повышают производительность запросов. Статистические данные собираются из таблиц в базе данных и сохраняются в метаданных этой базы.  
  
 Статистические данные создаются автоматически, но также могут быть созданы вручную. Например, статистика создается автоматически для ключевых столбцов индекса при создании индекса. Дополнительные сведения о создании статистики см. в разделе [Statistics](../statistics/statistics.md).  
  
 Табличные данные обычно с течением времени изменяются по мере вставки, обновления и удаления строк. Это означает, что статистику необходимо периодически обновлять. По умолчанию статистика по дисковым таблицам обновляется автоматически, когда оптимизатор определяет, что она устарела.  
  
 Статистика для оптимизированных для памяти таблиц по умолчанию не обновляется. Вместо этого нужно обновлять ее вручную. Для отдельных столбцов, индексов или таблиц используйте [инструкцию UPDATE STATISTICS &#40;&#41;Transact-SQL](/sql/t-sql/statements/update-statistics-transact-sql) . Используйте [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) , чтобы обновить статистику для всех пользователей и внутренних таблиц в базе данных.  
  
 При использовании инструкции [CREATE STATISTICS &#40;языке Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) или [обновлении статистики &#40;transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql)необходимо указать `NORECOMPUTE` , чтобы отключить автоматическое обновление статистики для оптимизированных для памяти таблиц. Для таблиц на основе диска [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) только обновляет статистику, если таблица была изменена с момента последнего [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql). Для таблиц, оптимизированных для памяти, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) всегда создает обновленную статистику. [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) является хорошим вариантом для оптимизированных для памяти таблиц. в противном случае необходимо знать, какие таблицы имеют значительные изменения, чтобы можно было обновлять статистику по отдельности.  
  
 Статистика может быть создана или при выборочном анализе данных, или при выполнении полного сканирования. Выборочная статистика использует только образец данных таблиц для оценки распределения данных. Полная статистика просматривает всю таблицу для определения распределения данных. Статистика полного сканирования обычно более точна, но для ее вычисления требуется больше времени. Выборочную статистику можно получить быстрее.  
  
 Дисковые таблицы по умолчанию используют выборочную статистику. Оптимизированные для памяти таблицы поддерживают только полную статистику. При использовании инструкции [CREATE STATISTICS &#40;Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) или [UPDATE STATISTICS &#40;&#41;Transact-SQL ](/sql/t-sql/statements/update-statistics-transact-sql)необходимо указать `FULLSCAN` параметр для таблиц, оптимизированных для памяти.  
  
 Дополнительные замечания по статистике для оптимизированных для памяти таблиц.  
  
-   Индексы в оптимизированных для памяти таблицах создаются вместе с таблицей. Статистика по ключевым столбцам индекса создается, когда таблица пуста. В связи с этим необходимо обновить статистику после загрузки данных в таблицу.  
  
-   Для скомпилированных хранимых процедур планы выполнения запросов в процедуре оптимизируются при компиляции процедуры. Это происходит только при создании процедуры и при перезапуске сервера, но не при обновлении статистики. Таким образом, таблицы должны содержать показательный набор данных, и статистика должна быть актуальной на момент создания процедур. (Скомпилированные хранимые процедуры перекомпилируются в случае, если база данных была переведена в режим «вне сети», а потом возвращена «в сеть», либо в случае перезапуска сервера.)  
  
## <a name="guidelines-for-statistics-when-deploying-memory-optimized-tables"></a>Рекомендации по использованию статистики при развертывании оптимизированных для памяти таблиц  
 Чтобы убедиться, что оптимизатор запросов имеет актуальную статистику при создании планов запросов, разверните оптимизированные для памяти таблицы, выполнив следующие пять действий.  
  
1.  Создайте таблицы и индексы. Индексы указываются встроенными в инструкциях `CREATE TABLE`.  
  
2.  Загрузите данные в таблицы.  
  
3.  Обновите статистику для таблиц.  
  
4.  Создайте хранимые процедуры, обращающиеся к таблицам.  
  
5.  Запустите рабочую нагрузку, которая может содержать сочетание скомпилированных и интерпретируемых хранимых процедур [!INCLUDE[tsql](../../../includes/tsql-md.md)] , а также нерегламентированных пакетов.  
  
 Создание скомпилированных хранимых процедур после загрузки данных и обновления статистики гарантирует то, что оптимизатор имеет статистические данные для оптимизированных для памяти таблиц. Это обеспечит формирование эффективных планов запросов при компиляции процедуры.  
  
## <a name="guidelines-for-maintaining-statistics-on-memory-optimized-tables"></a>Рекомендации по поддержанию статистики для таблиц, оптимизированных для памяти  
 Чтобы иметь актуальную статистику, регулярно обновляйте статистику для оптимизированных для памяти таблиц.  
  
 Если данные часто изменяются, точно так же необходимо обновлять статистику. Например, обновляйте статистику таблицы после пакетного обновления. После обновления статистики удалите и воссоздайте и скомпилированные хранимые процедуры, чтобы они обновились с учетом новой статистики.  
  
 .  
  
 Не обновляйте статистику во время пиковой рабочей нагрузки.  
  
 Обновление статистики:  
  
-   Используйте [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] для [Create a Maintenance Plan](../maintenance-plans/create-a-maintenance-plan.md) c [задачей обновления статистики](../maintenance-plans/update-statistics-task-maintenance-plan.md)  
  
-   Или обновите статистику с помощью скрипта [!INCLUDE[tsql](../../../includes/tsql-md.md)] , как описано ниже.  
  
 Чтобы обновить статистику для отдельной таблицы, оптимизированной для памяти (*myschema*. *Mytable*), выполните следующий скрипт:  
  
```  
UPDATE STATISTICS myschema.Mytable WITH FULLSCAN, NORECOMPUTE  
```  
  
 Чтобы обновить статистику для всех оптимизированных для памяти таблиц текущей базы данных, выполните следующий скрипт:  
  
```sql  
DECLARE @sql NVARCHAR(MAX) = N''  
  
SELECT @sql += N'  
   UPDATE STATISTICS ' + quotename(schema_name(schema_id)) + N'.' + quotename(name) + N' WITH FULLSCAN, NORECOMPUTE'  
FROM sys.tables WHERE is_memory_optimized=1  
  
EXEC sp_executesql @sql  
```  
  
 Чтобы обновить статистику для всех таблиц в базе данных, выполните [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).  
  
 В следующем примере сообщается, когда статистика по оптимизированным для памяти таблицам обновлялась последний раз. Эти сведения помогут решить, нужно ли обновить статистику.  
  
```sql  
select t.object_id, t.name, sp.last_updated as 'stats_last_updated'  
from sys.tables t join sys.stats s on t.object_id=s.object_id cross apply sys.dm_db_stats_properties(t.object_id, s.stats_id) sp  
where t.is_memory_optimized=1  
```  
  
## <a name="see-also"></a>См. также:  
 [Таблицы, оптимизированные для памяти](memory-optimized-tables.md)  
  
  
