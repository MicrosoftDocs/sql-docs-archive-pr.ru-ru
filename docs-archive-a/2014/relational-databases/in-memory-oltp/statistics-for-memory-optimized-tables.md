---
title: Статистика для оптимизированных для памяти таблиц | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: e644766d-1d1c-43d7-83ff-8ccfe4f3af9f
author: rothja
ms.author: jroth
ms.openlocfilehash: 0ae09d76c2642e23c56afcdd5ae4e1e468ef5883
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87749892"
---
# <a name="statistics-for-memory-optimized-tables"></a><span data-ttu-id="22d77-102">Статистика для таблиц, оптимизированных для памяти</span><span class="sxs-lookup"><span data-stu-id="22d77-102">Statistics for Memory-Optimized Tables</span></span>
  <span data-ttu-id="22d77-103">Оптимизатор запросов использует статистику о столбцах для создания планов запросов, которые повышают производительность запросов.</span><span class="sxs-lookup"><span data-stu-id="22d77-103">The query optimizer uses statistics about columns to create query plans that improve query performance.</span></span> <span data-ttu-id="22d77-104">Статистические данные собираются из таблиц в базе данных и сохраняются в метаданных этой базы.</span><span class="sxs-lookup"><span data-stu-id="22d77-104">Statistics are collected from the tables in the database and stored in the database metadata.</span></span>  
  
 <span data-ttu-id="22d77-105">Статистические данные создаются автоматически, но также могут быть созданы вручную.</span><span class="sxs-lookup"><span data-stu-id="22d77-105">Statistics are created automatically, but can also be created manually.</span></span> <span data-ttu-id="22d77-106">Например, статистика создается автоматически для ключевых столбцов индекса при создании индекса.</span><span class="sxs-lookup"><span data-stu-id="22d77-106">For example, statistics are created automatically for index key columns when the index is created.</span></span> <span data-ttu-id="22d77-107">Дополнительные сведения о создании статистики см. в разделе [Statistics](../statistics/statistics.md).</span><span class="sxs-lookup"><span data-stu-id="22d77-107">For more information about creating statistics see [Statistics](../statistics/statistics.md).</span></span>  
  
 <span data-ttu-id="22d77-108">Табличные данные обычно с течением времени изменяются по мере вставки, обновления и удаления строк.</span><span class="sxs-lookup"><span data-stu-id="22d77-108">Table data typically changes over time as rows are inserted, updated, and deleted.</span></span> <span data-ttu-id="22d77-109">Это означает, что статистику необходимо периодически обновлять.</span><span class="sxs-lookup"><span data-stu-id="22d77-109">This means statistics need to be updated periodically.</span></span> <span data-ttu-id="22d77-110">По умолчанию статистика по дисковым таблицам обновляется автоматически, когда оптимизатор определяет, что она устарела.</span><span class="sxs-lookup"><span data-stu-id="22d77-110">By default, statistics on disk-based tables are updated automatically when the optimizer determines they might be out of date.</span></span>  
  
 <span data-ttu-id="22d77-111">Статистика для оптимизированных для памяти таблиц по умолчанию не обновляется.</span><span class="sxs-lookup"><span data-stu-id="22d77-111">Statistics on memory-optimized tables are not updated by default.</span></span> <span data-ttu-id="22d77-112">Вместо этого нужно обновлять ее вручную.</span><span class="sxs-lookup"><span data-stu-id="22d77-112">Instead, you need to update them manually.</span></span> <span data-ttu-id="22d77-113">Для отдельных столбцов, индексов или таблиц используйте [инструкцию UPDATE STATISTICS &#40;&#41;Transact-SQL](/sql/t-sql/statements/update-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="22d77-113">Use [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) for individual columns, indexes, or tables.</span></span> <span data-ttu-id="22d77-114">Используйте [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) , чтобы обновить статистику для всех пользователей и внутренних таблиц в базе данных.</span><span class="sxs-lookup"><span data-stu-id="22d77-114">Use [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) to update statistics for all user and internal tables in the database.</span></span>  
  
 <span data-ttu-id="22d77-115">При использовании инструкции [CREATE STATISTICS &#40;языке Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) или [обновлении статистики &#40;transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql)необходимо указать `NORECOMPUTE` , чтобы отключить автоматическое обновление статистики для оптимизированных для памяти таблиц.</span><span class="sxs-lookup"><span data-stu-id="22d77-115">When using [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) or [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), you must specify `NORECOMPUTE` to disable automatic statistics update for memory-optimized tables.</span></span> <span data-ttu-id="22d77-116">Для таблиц на основе диска [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) только обновляет статистику, если таблица была изменена с момента последнего [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="22d77-116">For disk based tables, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) only updates statistics if the table has been modified since the last [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span> <span data-ttu-id="22d77-117">Для таблиц, оптимизированных для памяти, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) всегда создает обновленную статистику.</span><span class="sxs-lookup"><span data-stu-id="22d77-117">For memory-optimized tables, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) always generates updated statistics.</span></span> <span data-ttu-id="22d77-118">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) является хорошим вариантом для оптимизированных для памяти таблиц. в противном случае необходимо знать, какие таблицы имеют значительные изменения, чтобы можно было обновлять статистику по отдельности.</span><span class="sxs-lookup"><span data-stu-id="22d77-118">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) is a good option for memory-optimized tables; otherwise you need to know which tables have significant changes so you can update statistics individually.</span></span>  
  
 <span data-ttu-id="22d77-119">Статистика может быть создана или при выборочном анализе данных, или при выполнении полного сканирования.</span><span class="sxs-lookup"><span data-stu-id="22d77-119">Statistics can either be generated by either sampling the data or performing a full scan.</span></span> <span data-ttu-id="22d77-120">Выборочная статистика использует только образец данных таблиц для оценки распределения данных.</span><span class="sxs-lookup"><span data-stu-id="22d77-120">Sampled statistics only use a sample of the table data to estimate the data distribution.</span></span> <span data-ttu-id="22d77-121">Полная статистика просматривает всю таблицу для определения распределения данных.</span><span class="sxs-lookup"><span data-stu-id="22d77-121">Fullscan statistics scan the entire table to determine the data distribution.</span></span> <span data-ttu-id="22d77-122">Статистика полного сканирования обычно более точна, но для ее вычисления требуется больше времени.</span><span class="sxs-lookup"><span data-stu-id="22d77-122">Fullscan statistics are usually more accurate but take longer to compute.</span></span> <span data-ttu-id="22d77-123">Выборочную статистику можно получить быстрее.</span><span class="sxs-lookup"><span data-stu-id="22d77-123">Sampled statistics can be collected faster.</span></span>  
  
 <span data-ttu-id="22d77-124">Дисковые таблицы по умолчанию используют выборочную статистику.</span><span class="sxs-lookup"><span data-stu-id="22d77-124">Disk-based tables use sampled statistics by default.</span></span> <span data-ttu-id="22d77-125">Оптимизированные для памяти таблицы поддерживают только полную статистику.</span><span class="sxs-lookup"><span data-stu-id="22d77-125">Memory-optimized tables only support fullscan statistics.</span></span> <span data-ttu-id="22d77-126">При использовании инструкции [CREATE STATISTICS &#40;Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) или [UPDATE STATISTICS &#40;&#41;Transact-SQL ](/sql/t-sql/statements/update-statistics-transact-sql)необходимо указать `FULLSCAN` параметр для таблиц, оптимизированных для памяти.</span><span class="sxs-lookup"><span data-stu-id="22d77-126">When using [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) or [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), you must specify the `FULLSCAN` option for memory-optimized tables.</span></span>  
  
 <span data-ttu-id="22d77-127">Дополнительные замечания по статистике для оптимизированных для памяти таблиц.</span><span class="sxs-lookup"><span data-stu-id="22d77-127">Additional considerations for statistics on memory-optimized tables:</span></span>  
  
-   <span data-ttu-id="22d77-128">Индексы в оптимизированных для памяти таблицах создаются вместе с таблицей.</span><span class="sxs-lookup"><span data-stu-id="22d77-128">Indexes on memory-optimized tables are created with the table.</span></span> <span data-ttu-id="22d77-129">Статистика по ключевым столбцам индекса создается, когда таблица пуста.</span><span class="sxs-lookup"><span data-stu-id="22d77-129">The statistics on the index key columns are created when the table is empty.</span></span> <span data-ttu-id="22d77-130">В связи с этим необходимо обновить статистику после загрузки данных в таблицу.</span><span class="sxs-lookup"><span data-stu-id="22d77-130">Therefore, these statistics need to be updated after data is loaded into the table.</span></span>  
  
-   <span data-ttu-id="22d77-131">Для скомпилированных хранимых процедур планы выполнения запросов в процедуре оптимизируются при компиляции процедуры.</span><span class="sxs-lookup"><span data-stu-id="22d77-131">For natively compiled stored procedures, execution plans for queries in the procedure are optimized when the procedure is compiled.</span></span> <span data-ttu-id="22d77-132">Это происходит только при создании процедуры и при перезапуске сервера, но не при обновлении статистики.</span><span class="sxs-lookup"><span data-stu-id="22d77-132">This happens only when the procedure is created and when the server restarts, not when statistics are updated.</span></span> <span data-ttu-id="22d77-133">Таким образом, таблицы должны содержать показательный набор данных, и статистика должна быть актуальной на момент создания процедур.</span><span class="sxs-lookup"><span data-stu-id="22d77-133">Therefore, the tables need to contain a representative set of data and statistics need to be up-to-date before the procedures are created.</span></span> <span data-ttu-id="22d77-134">(Скомпилированные хранимые процедуры перекомпилируются в случае, если база данных была переведена в режим «вне сети», а потом возвращена «в сеть», либо в случае перезапуска сервера.)</span><span class="sxs-lookup"><span data-stu-id="22d77-134">(Natively compiled stored procedures are recompiled if the database is taken offline and brought back online, or if there is a server restart.)</span></span>  
  
## <a name="guidelines-for-statistics-when-deploying-memory-optimized-tables"></a><span data-ttu-id="22d77-135">Рекомендации по использованию статистики при развертывании оптимизированных для памяти таблиц</span><span class="sxs-lookup"><span data-stu-id="22d77-135">Guidelines for Statistics When Deploying Memory-Optimized Tables</span></span>  
 <span data-ttu-id="22d77-136">Чтобы убедиться, что оптимизатор запросов имеет актуальную статистику при создании планов запросов, разверните оптимизированные для памяти таблицы, выполнив следующие пять действий.</span><span class="sxs-lookup"><span data-stu-id="22d77-136">To ensure that the query optimizer has up-to-date statistics when creating query plans, deploy memory-optimized tables using these five steps:</span></span>  
  
1.  <span data-ttu-id="22d77-137">Создайте таблицы и индексы.</span><span class="sxs-lookup"><span data-stu-id="22d77-137">Create tables and indexes.</span></span> <span data-ttu-id="22d77-138">Индексы указываются встроенными в инструкциях `CREATE TABLE`.</span><span class="sxs-lookup"><span data-stu-id="22d77-138">Indexes are specified inline in the `CREATE TABLE` statements.</span></span>  
  
2.  <span data-ttu-id="22d77-139">Загрузите данные в таблицы.</span><span class="sxs-lookup"><span data-stu-id="22d77-139">Load data into the tables.</span></span>  
  
3.  <span data-ttu-id="22d77-140">Обновите статистику для таблиц.</span><span class="sxs-lookup"><span data-stu-id="22d77-140">Update statistics on the tables.</span></span>  
  
4.  <span data-ttu-id="22d77-141">Создайте хранимые процедуры, обращающиеся к таблицам.</span><span class="sxs-lookup"><span data-stu-id="22d77-141">Create stored procedures that access the tables.</span></span>  
  
5.  <span data-ttu-id="22d77-142">Запустите рабочую нагрузку, которая может содержать сочетание скомпилированных и интерпретируемых хранимых процедур [!INCLUDE[tsql](../../../includes/tsql-md.md)] , а также нерегламентированных пакетов.</span><span class="sxs-lookup"><span data-stu-id="22d77-142">Run the workload, which can contain a mix of natively compiled and interpreted [!INCLUDE[tsql](../../../includes/tsql-md.md)] stored procedures, as well as ad hoc batches.</span></span>  
  
 <span data-ttu-id="22d77-143">Создание скомпилированных хранимых процедур после загрузки данных и обновления статистики гарантирует то, что оптимизатор имеет статистические данные для оптимизированных для памяти таблиц.</span><span class="sxs-lookup"><span data-stu-id="22d77-143">Creating natively compiled stored procedures after you load the data and update the statistics ensures that the optimizer has statistics available for the memory-optimized tables.</span></span> <span data-ttu-id="22d77-144">Это обеспечит формирование эффективных планов запросов при компиляции процедуры.</span><span class="sxs-lookup"><span data-stu-id="22d77-144">This will ensure efficient query plans when the procedure is compiled.</span></span>  
  
## <a name="guidelines-for-maintaining-statistics-on-memory-optimized-tables"></a><span data-ttu-id="22d77-145">Рекомендации по поддержанию статистики для таблиц, оптимизированных для памяти</span><span class="sxs-lookup"><span data-stu-id="22d77-145">Guidelines for Maintaining Statistics on Memory-Optimized Tables</span></span>  
 <span data-ttu-id="22d77-146">Чтобы иметь актуальную статистику, регулярно обновляйте статистику для оптимизированных для памяти таблиц.</span><span class="sxs-lookup"><span data-stu-id="22d77-146">To keep statistics up-to-date, regularly update the statistics on memory-optimized tables.</span></span>  
  
 <span data-ttu-id="22d77-147">Если данные часто изменяются, точно так же необходимо обновлять статистику.</span><span class="sxs-lookup"><span data-stu-id="22d77-147">If data changes frequently, you should update statistics frequently.</span></span> <span data-ttu-id="22d77-148">Например, обновляйте статистику таблицы после пакетного обновления.</span><span class="sxs-lookup"><span data-stu-id="22d77-148">For example, update table statistics after a batch update.</span></span> <span data-ttu-id="22d77-149">После обновления статистики удалите и воссоздайте и скомпилированные хранимые процедуры, чтобы они обновились с учетом новой статистики.</span><span class="sxs-lookup"><span data-stu-id="22d77-149">After you update statistics, drop and recreate natively compiled stored procedures so they can benefit from the updated statistics.</span></span>  
  
 <span data-ttu-id="22d77-150">.</span><span class="sxs-lookup"><span data-stu-id="22d77-150">.</span></span>  
  
 <span data-ttu-id="22d77-151">Не обновляйте статистику во время пиковой рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="22d77-151">Do not update statistics during peak workload.</span></span>  
  
 <span data-ttu-id="22d77-152">Обновление статистики:</span><span class="sxs-lookup"><span data-stu-id="22d77-152">To update statistics:</span></span>  
  
-   <span data-ttu-id="22d77-153">Используйте [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] для [Create a Maintenance Plan](../maintenance-plans/create-a-maintenance-plan.md) c [задачей обновления статистики](../maintenance-plans/update-statistics-task-maintenance-plan.md)</span><span class="sxs-lookup"><span data-stu-id="22d77-153">Use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] to [Create a Maintenance Plan](../maintenance-plans/create-a-maintenance-plan.md) with an [Update Statistic Task](../maintenance-plans/update-statistics-task-maintenance-plan.md)</span></span>  
  
-   <span data-ttu-id="22d77-154">Или обновите статистику с помощью скрипта [!INCLUDE[tsql](../../../includes/tsql-md.md)] , как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="22d77-154">Or, update statistics through a [!INCLUDE[tsql](../../../includes/tsql-md.md)] script, as discussed below.</span></span>  
  
 <span data-ttu-id="22d77-155">Чтобы обновить статистику для отдельной таблицы, оптимизированной для памяти (*myschema*.</span><span class="sxs-lookup"><span data-stu-id="22d77-155">To update the statistics for a single memory-optimized table (*myschema*.</span></span> <span data-ttu-id="22d77-156">*Mytable*), выполните следующий скрипт:</span><span class="sxs-lookup"><span data-stu-id="22d77-156">*Mytable*), run the following script:</span></span>  
  
```  
UPDATE STATISTICS myschema.Mytable WITH FULLSCAN, NORECOMPUTE  
```  
  
 <span data-ttu-id="22d77-157">Чтобы обновить статистику для всех оптимизированных для памяти таблиц текущей базы данных, выполните следующий скрипт:</span><span class="sxs-lookup"><span data-stu-id="22d77-157">To update statistics for all memory-optimized tables in the current database, run the following script:</span></span>  
  
```sql  
DECLARE @sql NVARCHAR(MAX) = N''  
  
SELECT @sql += N'  
   UPDATE STATISTICS ' + quotename(schema_name(schema_id)) + N'.' + quotename(name) + N' WITH FULLSCAN, NORECOMPUTE'  
FROM sys.tables WHERE is_memory_optimized=1  
  
EXEC sp_executesql @sql  
```  
  
 <span data-ttu-id="22d77-158">Чтобы обновить статистику для всех таблиц в базе данных, выполните [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="22d77-158">To update statistics for all tables in the database, run [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="22d77-159">В следующем примере сообщается, когда статистика по оптимизированным для памяти таблицам обновлялась последний раз.</span><span class="sxs-lookup"><span data-stu-id="22d77-159">The following sample reports when the statistics on memory-optimized tables were last updated.</span></span> <span data-ttu-id="22d77-160">Эти сведения помогут решить, нужно ли обновить статистику.</span><span class="sxs-lookup"><span data-stu-id="22d77-160">This information can help you decide if you need to update the statistics.</span></span>  
  
```sql  
select t.object_id, t.name, sp.last_updated as 'stats_last_updated'  
from sys.tables t join sys.stats s on t.object_id=s.object_id cross apply sys.dm_db_stats_properties(t.object_id, s.stats_id) sp  
where t.is_memory_optimized=1  
```  
  
## <a name="see-also"></a><span data-ttu-id="22d77-161">См. также:</span><span class="sxs-lookup"><span data-stu-id="22d77-161">See Also</span></span>  
 [<span data-ttu-id="22d77-162">Таблицы, оптимизированные для памяти</span><span class="sxs-lookup"><span data-stu-id="22d77-162">Memory-Optimized Tables</span></span>](memory-optimized-tables.md)  
  
  
