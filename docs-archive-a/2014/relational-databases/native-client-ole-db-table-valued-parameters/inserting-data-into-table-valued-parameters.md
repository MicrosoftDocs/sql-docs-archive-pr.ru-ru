---
title: Вставка данных в параметры, возвращающие табличные значения | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters, inserting data into
ms.assetid: 9c1a3234-4675-40d3-b473-8df06208f880
author: rothja
ms.author: jroth
ms.openlocfilehash: 38e33c6e58bc2633591fa80e095ceafe46f67045
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87657749"
---
# <a name="inserting-data-into-table-valued-parameters"></a><span data-ttu-id="17423-102">Вставка данных в параметры, возвращающие табличные значения</span><span class="sxs-lookup"><span data-stu-id="17423-102">Inserting Data into Table-Valued Parameters</span></span>
  <span data-ttu-id="17423-103">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]Поставщик OLE DB собственного клиента поддерживает две модели для указания данных для строк параметров, возвращающих табличное значение: модель push-уведомлений и модель извлечения.</span><span class="sxs-lookup"><span data-stu-id="17423-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider supports two models for the consumer to specify data for table valued parameter rows: a push model and a pull model.</span></span> <span data-ttu-id="17423-104">Образец, в котором демонстрируется применение модели по запросу, см. в разделе [Образцы программирования служб SQL Server](https://msftdpprodsamples.codeplex.com/).</span><span class="sxs-lookup"><span data-stu-id="17423-104">A sample that demonstrates the pull model is available; see [SQL Server Data Programming Samples](https://msftdpprodsamples.codeplex.com/).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="17423-105">Столбец возвращающего табличное значение параметра должен содержать во всех строках либо значения по умолчанию, либо значения, отличные от значений по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="17423-105">A table-valued parameter column must have either non-default values in all rows or default values in all rows.</span></span> <span data-ttu-id="17423-106">Нельзя, чтобы в одних строках были значения по умолчанию, а в других — значения, отличные от них.</span><span class="sxs-lookup"><span data-stu-id="17423-106">It is not possible to have default values in some rows but not others.</span></span> <span data-ttu-id="17423-107">Следовательно, в привязках табличных параметров единственными значениями состояния, разрешенными для столбца набора строк возвращающего табличное значение параметра, являются DBSTATUS_S_ISNULL и DBSTATUS_S_OK.</span><span class="sxs-lookup"><span data-stu-id="17423-107">Therefore, in table-valued parameter bindings, the only status values allowed for table-valued parameter rowset column data are DBSTATUS_S_ISNULL and DBSTATUS_S_OK.</span></span> <span data-ttu-id="17423-108">Значение DBSTATUS_S_DEFAULT приведет к сбою, и значению состояния привязки будет присвоено значение DBSTATUS_E_BADSTATUS.</span><span class="sxs-lookup"><span data-stu-id="17423-108">DBSTATUS_S_DEFAULT will result in a failure and the bound status value will be set to DBSTATUS_E_BADSTATUS.</span></span>  
  
## <a name="push-model-loads-all-table-valued-paremeter-data-in-memory"></a><span data-ttu-id="17423-109">Принудительная модель (загружает все данные табличного параметра в память)</span><span class="sxs-lookup"><span data-stu-id="17423-109">Push Model (Loads All Table-Valued Paremeter Data in Memory)</span></span>  
 <span data-ttu-id="17423-110">Принудительная модель напоминает использование наборов параметров (то есть параметра DBPARAMS в методе ICommand::Execute).</span><span class="sxs-lookup"><span data-stu-id="17423-110">The push model is similar to the use of parameter sets (that is, the DBPARAMS parameter in ICommand::Execute).</span></span> <span data-ttu-id="17423-111">Принудительная модель используется только в том случае, если объекты набора строк возвращающего табличное значение параметра применяются без пользовательской реализации интерфейсов IRowset.</span><span class="sxs-lookup"><span data-stu-id="17423-111">The push model is only used if table-valued parameter rowset objects are used without a customized implementation of IRowset interfaces.</span></span> <span data-ttu-id="17423-112">Принудительная модель рекомендуется в том случае, если набор строк возвращающего табличное значение параметра содержит небольшое число строк и не потребует от приложения большого объема памяти.</span><span class="sxs-lookup"><span data-stu-id="17423-112">The push model is recommended when the number of rows in the table-valued parameter rowset is small and is not expected to put excessive memory pressure on the application.</span></span> <span data-ttu-id="17423-113">Эта модель проще, поскольку она не нуждается в больших возможностях приложения потребителя, довольствуясь стандартными возможностями приложений OLE DB.</span><span class="sxs-lookup"><span data-stu-id="17423-113">This is simpler than the pull model, because it does not require any more functionality from the consumer application than what is currently common in typical OLE DB applications.</span></span>  
  
 <span data-ttu-id="17423-114">Ожидается, что перед выполнением команды потребитель предоставит поставщику все данные для возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="17423-114">The consumer is expected to provide all the table-valued parameter data to the provider before executing a command.</span></span> <span data-ttu-id="17423-115">Для этого он заполняет объект набора строк табличного параметра для каждого возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="17423-115">To provide the data, the consumer populates a table-valued parameter rowset object for each table-valued parameter.</span></span> <span data-ttu-id="17423-116">Объект набора строк возвращающего табличное значение параметра реализует для набора строк операции Insert, Set и Delete, которые потребитель будет использовать для обработки данных возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="17423-116">The table-valued parameter rowset object exposes rowset Insert, Set, and Delete operations, which the consumer will use to manipulate the table-valued parameter data.</span></span> <span data-ttu-id="17423-117">Поставщик получает данные из объекта набора строк возвращающего табличное значение параметра во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="17423-117">The provider will fetch the data from this table-valued parameter rowset object at execution time.</span></span>  
  
 <span data-ttu-id="17423-118">Как только набор строк возвращающего табличное значение параметра предоставляется потребителю, он может начать работу с ним как с набором строк.</span><span class="sxs-lookup"><span data-stu-id="17423-118">When a table-valued parameter rowset object is provided to the consumer, the consumer can process it as a rowset object.</span></span> <span data-ttu-id="17423-119">Затем потребитель получает сведения о типе каждого столбца (тип, максимальная длина, точность и масштаб) с помощью интерфейсного метода IColumnsInfo::GetColumnInfo или IColumnsRowset::GetColumnsRowset.</span><span class="sxs-lookup"><span data-stu-id="17423-119">The consumer can obtain the type information of each column (type, maximum length, precision, and scale) by using the IColumnsInfo::GetColumnInfo or IColumnsRowset::GetColumnsRowset interface method.</span></span> <span data-ttu-id="17423-120">После этого потребитель создает метод доступа для определения привязок для данных.</span><span class="sxs-lookup"><span data-stu-id="17423-120">The consumer then creates an accessor to specify the bindings for the data.</span></span> <span data-ttu-id="17423-121">Следующий шаг — вставка строк данных в набор строк возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="17423-121">The next step is to insert rows of data into the table-valued parameter rowset.</span></span> <span data-ttu-id="17423-122">Это можно выполнить, используя IRowsetChange::InsertRow.</span><span class="sxs-lookup"><span data-stu-id="17423-122">This can be done by using IRowsetChange::InsertRow.</span></span> <span data-ttu-id="17423-123">Методы IRowsetChange::SetData и IRowsetChange::DeleteRows также могут использоваться в объекте набора строк возвращающего табличное значение параметра, если необходимо управление данными.</span><span class="sxs-lookup"><span data-stu-id="17423-123">IRowsetChange::SetData or IRowsetChange::DeleteRows can also be used on the table-valued parameter rowset object if you have to manipulate the data.</span></span> <span data-ttu-id="17423-124">Для объекта набора строк возвращающего табличное значение параметра имеется счетчик ссылок, как и у объектов потока.</span><span class="sxs-lookup"><span data-stu-id="17423-124">Table-valued parameter rowset objects are reference counted, similar to stream objects.</span></span>  
  
 <span data-ttu-id="17423-125">При использовании IColumnsRowset::GetColumnsRowset на объекте набора строк результирующего столбца будут происходить последующие вызовы методов IRowset::GetNextRows, IRowset::GetData и IRowset::ReleaseRows.</span><span class="sxs-lookup"><span data-stu-id="17423-125">If IColumnsRowset::GetColumnsRowset is used, there will be subsequent calls to IRowset::GetNextRows, IRowset::GetData, and IRowset::ReleaseRows methods on the rowset object of the resulting column.</span></span>  
  
 <span data-ttu-id="17423-126">После того [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , как поставщик OLE DB собственного клиента начинает выполнять команду, значения возвращающего табличное значение параметра будут получены из объекта набора строк возвращающего табличное значений параметра и отправлены на сервер.</span><span class="sxs-lookup"><span data-stu-id="17423-126">After the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider begins executing the command, the table-valued parameter values will be fetched from this table-valued parameter rowset object and sent to the server.</span></span>  
  
 <span data-ttu-id="17423-127">Принудительная модель требует минимальных затрат от потребителя, но использует больше памяти, чем модель по запросу, поскольку все данные возвращающего табличное значение параметра во время выполнения приходится хранить в памяти.</span><span class="sxs-lookup"><span data-stu-id="17423-127">The push model requires minimal work by the consumer, but uses more memory than the pull model, because all the table-valued parameter data has to be in memory at execution time.</span></span>  
  
## <a name="pull-model-obtaining-table-valued-parameter-data-on-demand-from-the-consumer"></a><span data-ttu-id="17423-128">Модель «по запросу» (получает данные возвращающего табличное значение параметра по запросу потребителя)</span><span class="sxs-lookup"><span data-stu-id="17423-128">Pull Model (Obtaining Table-Valued Parameter Data on Demand from the Consumer)</span></span>  
 <span data-ttu-id="17423-129">Применение модели по запросу выгодно в следующих двух случаях.</span><span class="sxs-lookup"><span data-stu-id="17423-129">The pull model is useful for two scenarios:</span></span>  
  
-   <span data-ttu-id="17423-130">Для создания потока строк.</span><span class="sxs-lookup"><span data-stu-id="17423-130">To stream rows.</span></span>  
  
-   <span data-ttu-id="17423-131">Если в качестве значения возвращающего табличное значение параметра используется набор строк от другого поставщика.</span><span class="sxs-lookup"><span data-stu-id="17423-131">If a rowset from another provider is being used as the table-valued parameter value.</span></span>  
  
 <span data-ttu-id="17423-132">В модели получения по запросу заказчик предоставляет данные поставщику по запросу.</span><span class="sxs-lookup"><span data-stu-id="17423-132">In the pull model, the consumer provides data on demand to the provider.</span></span> <span data-ttu-id="17423-133">Этот подход следует использовать в том случае, если приложение реализует множество операций вставки и хранение набора строк возвращающего табличное значение параметра потребовало бы большого объема памяти.</span><span class="sxs-lookup"><span data-stu-id="17423-133">Use this approach if your application has many data insertions, and table-valued parameter rowset data in memory would result in excessive memory access.</span></span> <span data-ttu-id="17423-134">Если используются несколько поставщиков OLE DB, то модель по запросу позволяет потребителю предоставлять любые объекты наборов строк в качестве значения возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="17423-134">If multiple OLE DB providers are used, the consumer pull model enables the consumer to provide any rowset object as the table-valued parameter value.</span></span>  
  
 <span data-ttu-id="17423-135">Для применения модели по запросу потребитель должен предоставить собственную реализацию объекта набора строк.</span><span class="sxs-lookup"><span data-stu-id="17423-135">To use the pull model, consumers have to provide their own implementation of a rowset object.</span></span> <span data-ttu-id="17423-136">При использовании модели по запросу с наборами строк возвращающего табличное значение параметра (CLSID_ROWSET_TVP) потребителю необходимо выполнить статистическую обработку объекта набора строк возвращающего табличное значение параметра, которые поставщик передает с помощью метода ITableDefinitionWithConstraints::CreateTableWithConstraints или IOpenRowset::OpenRowset.</span><span class="sxs-lookup"><span data-stu-id="17423-136">When using the pull model with table-valued parameter rowsets (CLSID_ROWSET_TVP), the consumer is required to aggregate the table-valued parameter rowset object that the provider exposes through the ITableDefinitionWithConstraints::CreateTableWithConstraints method or the IOpenRowset::OpenRowset method.</span></span> <span data-ttu-id="17423-137">Ожидается, что объект потребителя переопределяет только реализацию интерфейса IRowset.</span><span class="sxs-lookup"><span data-stu-id="17423-137">The consumer object is only expected to override the IRowset interface implementation.</span></span> <span data-ttu-id="17423-138">Должны быть переопределены следующие функции.</span><span class="sxs-lookup"><span data-stu-id="17423-138">You must override the following functions:</span></span>  
  
-   <span data-ttu-id="17423-139">IRowset::GetNextRows</span><span class="sxs-lookup"><span data-stu-id="17423-139">IRowset::GetNextRows</span></span>  
  
-   <span data-ttu-id="17423-140">IRowset::AddRefRows</span><span class="sxs-lookup"><span data-stu-id="17423-140">IRowset::AddRefRows</span></span>  
  
-   <span data-ttu-id="17423-141">IRowset::GetData</span><span class="sxs-lookup"><span data-stu-id="17423-141">IRowset::GetData</span></span>  
  
-   <span data-ttu-id="17423-142">IRowset::ReleaseRows</span><span class="sxs-lookup"><span data-stu-id="17423-142">IRowset::ReleaseRows</span></span>  
  
-   <span data-ttu-id="17423-143">IRowset::RestartPosition</span><span class="sxs-lookup"><span data-stu-id="17423-143">IRowset::RestartPosition</span></span>  
  
 <span data-ttu-id="17423-144">Поставщик OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] считывает одновременно одну или несколько строк из объекта набора строк потребителя для поддержки потокового поведения возвращающих табличное значение параметров.</span><span class="sxs-lookup"><span data-stu-id="17423-144">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider will read one or more rows at a time from the consumer rowset object to support streaming behavior in table-valued parameters.</span></span> <span data-ttu-id="17423-145">Например, пользователь может иметь данные набора строк возвращающего табличное значение параметра на диске (а не в памяти) и реализовать считывание данных с диска, если это требуется поставщиком OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="17423-145">For example, the user might have the table-valued parameter rowset data on disk (not in memory) and might implement the functionality to read data from the disk when required by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider.</span></span>  
  
 <span data-ttu-id="17423-146">Потребитель будет передавать свой формат данных в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] собственный клиент OLE DB поставщика с помощью IAccessor:: CreateAccessor в объекте набора строк возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="17423-146">The consumer will communicate its data format to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider by using IAccessor::CreateAccessor on the table-valued parameter rowset object.</span></span> <span data-ttu-id="17423-147">При считывании данных из буфера потребителя поставщик удостоверяется, что все изменяемые столбцы со значениями, отличающимися от значений по умолчанию, доступны хотя бы через один дескриптор метода доступа и использует соответствующие дескрипторы для считывания данных столбца.</span><span class="sxs-lookup"><span data-stu-id="17423-147">When reading data from the consumer buffer, the provider verifies that all the writable and non-default columns are available through at least one accessor handle, and uses the corresponding handles to read columns data.</span></span> <span data-ttu-id="17423-148">Чтобы избежать неоднозначности, между столбцом набора строк возвращающего табличное значение параметра и привязкой должно быть однозначное соответствие.</span><span class="sxs-lookup"><span data-stu-id="17423-148">To avoid ambiguity, there should be a one-to-one correspondence between a table-valued parameter rowset column and a binding.</span></span> <span data-ttu-id="17423-149">Повторяющиеся привязки к одному и тому же столбцу приведут к ошибке.</span><span class="sxs-lookup"><span data-stu-id="17423-149">Duplicate bindings to the same column will result in an error.</span></span> <span data-ttu-id="17423-150">Кроме того, элементы *iOrdinal* каждого метода доступа DBBindings должны быть последовательно упорядочены.</span><span class="sxs-lookup"><span data-stu-id="17423-150">Also, each accessor is expected to have the *iOrdinal* member of DBBindings in sequence.</span></span> <span data-ttu-id="17423-151">Метод IRowset::GetData будет вызываться ровно столько раз, сколько существует методов доступа для одной строки, а порядок вызовов определяется порядком возрастания значений *iOrdinal*.</span><span class="sxs-lookup"><span data-stu-id="17423-151">There will be as many calls to IRowset::GetData as the number of accessors per row, and the order of calls will be based on the order of *iOrdinal* value from lower to higher values.</span></span>  
  
 <span data-ttu-id="17423-152">Ожидается, что поставщик реализует большую часть интерфейсов, предоставляемых объектом набора строк возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="17423-152">The provider is expected to implement most of the interfaces exposed by the table-valued parameter rowset object.</span></span> <span data-ttu-id="17423-153">Потребитель реализует объект набора строк с минимальным количеством интерфейсов (IRowset).</span><span class="sxs-lookup"><span data-stu-id="17423-153">The consumer will implement a rowset object with minimal interfaces (IRowset).</span></span> <span data-ttu-id="17423-154">Благодаря передаче интерфейсов вслепую оставшиеся интерфейсы объекта набора строк реализуются объектом набора строк возвращающего табличное значение параметра.</span><span class="sxs-lookup"><span data-stu-id="17423-154">Because of blind aggregation, the remaining mandatory rowset object interfaces will be implemented by the table-valued parameter rowset object.</span></span>  
  
 <span data-ttu-id="17423-155">Для всех остальных объектов набора строк (например, получаемых для поставщиков OLE DB), предоставленный потребителем набор строк должен реализовать все обязательные интерфейсы объектов набора строк, как указано в спецификации OLE DB.</span><span class="sxs-lookup"><span data-stu-id="17423-155">For any other rowset object, such as rowset objects obtained for any OLE DB provider, the consumer-provided rowset must implement all the mandatory rowset object interfaces as specified in the OLE DB specification.</span></span>  
  
 <span data-ttu-id="17423-156">Во время выполнения поставщик OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняет обратный вызов объекта набора строк для выборки строк и считывания данных столбца.</span><span class="sxs-lookup"><span data-stu-id="17423-156">At the time of execution, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider will call back to the rowset object to fetch rows and read column data.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="17423-157">См. также:</span><span class="sxs-lookup"><span data-stu-id="17423-157">See Also</span></span>  
 <span data-ttu-id="17423-158">[Возвращающие табличное значение параметры &#40;OLE DB&#41;](table-valued-parameters-ole-db.md) </span><span class="sxs-lookup"><span data-stu-id="17423-158">[Table-Valued Parameters &#40;OLE DB&#41;](table-valued-parameters-ole-db.md) </span></span>  
 [<span data-ttu-id="17423-159">Использование возвращающих табличные значения параметров &#40;OLE DB&#41;</span><span class="sxs-lookup"><span data-stu-id="17423-159">Use Table-Valued Parameters &#40;OLE DB&#41;</span></span>](../native-client-ole-db-how-to/use-table-valued-parameters-ole-db.md)  
  
