---
title: Восстановление страниц (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
f1_keywords:
- sql12.swb.restorepage.general.f1
helpviewer_keywords:
- restoring pages [SQL Server]
- pages [SQL Server], restoring
- databases [SQL Server], damaged
- page restores [SQL Server]
- pages [SQL Server], damaged
- restoring [SQL Server], pages
ms.assetid: 07e40950-384e-4d84-9ac5-84da6dd27a91
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 6fb008314b9cb156f1cc575bda71b6364eca6e3a
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87730754"
---
# <a name="restore-pages-sql-server"></a>Восстановление страниц (SQL Server)
  В этом разделе описано, как восстанавливать страницы в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] с помощью среды [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] или [!INCLUDE[tsql](../../includes/tsql-md.md)]. Задачей восстановления страниц является восстановление одной или нескольких поврежденных страниц без восстановления всей базы данных. Обычно страницы, являющиеся кандидатами на восстановление, в результате ошибок доступа помечаются как «подозрительные». Информация об указанных подозрительных страницах хранится в таблице [suspect_pages](/sql/relational-databases/system-tables/suspect-pages-transact-sql) базы данных **msdb** .  
  
 **В этом разделе**  
  
-   **Перед началом работы**  
  
     [Области использования функции восстановления страниц](#WhenUseful)  
  
     [Ограничения](#Restrictions)  
  
     [Рекомендации](#Recommendations)  
  
     [Безопасность](#Security)  
  
-   **Восстановление страниц с помощью:**  
  
     [Среда SQL Server Management Studio](#SSMSProcedure)  
  
     [Transact-SQL](#TsqlProcedure)  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="when-is-a-page-restore-useful"></a><a name="WhenUseful"></a> Области использования функции восстановления страниц  
 Восстановление страницы предназначено для исправления отдельных поврежденных страниц. Восстановление нескольких отдельных страниц может потребовать меньше времени, чем восстановление файла, и уменьшить объем данных, которые будут недоступны во время операции восстановления вне сети. Но в тех случаях, когда в файле требуется восстановление относительно большого числа страниц, может оказаться более эффективным восстановить весь файл. Большое количество таких страниц на устройстве может быть признаком приближающегося сбоя оборудования. В этом случае попробуйте вместо восстановления страниц восстановить файл целиком, по возможности в другое место, и отремонтировать устройство.  
  
 Более того, не все страницы с ошибками нужно восстанавливать. Проблема может относиться к кэшированным данным, например во вторичном индексе. Эта проблема разрешается повторным вычислением этих данных. Например, если администратор базы данных удалил, а затем перестроил вторичный индекс, то поврежденные данные после исправления не отражаются в таблице [suspect_pages](/sql/relational-databases/system-tables/suspect-pages-transact-sql) .  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> Ограничения  
  
-   Восстановление страницы применяется к базам данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , где используется модель полного восстановления или модель восстановления с неполным протоколированием. Поддержка восстановления страниц осуществляется только для файловых групп, доступных для чтения и записи.  
  
-   Только страницы базы данных могут быть восстановлены. Восстановление страниц не может быть использовано для восстановления нижеприведенных компонентов:  
  
    -   Журнал транзакций  
  
    -   Страницы размещения: страницы глобальной карты распределения (GAM), страницы общей глобальной карты (SGAM) и страницы свободного места на странице (PFS).  
  
    -   Страница 0 всех файлов данных (загрузочная страница файла)  
  
    -   Страница 1:9 (загрузочная страница базы данных)  
  
    -   Полнотекстовый каталог  
  
-   Для базы данных, использующей модель восстановления с неполным протоколированием, восстановление страниц требует выполнения следующих дополнительных условий.  
  
    -   Создание резервных копий в момент, когда файловая группа или данные страницы находятся в режиме «вне сети», затруднительно для данных с неполным протоколированием, поскольку данные в режиме «вне сети» не записываются в журнал. Пребывание любой страницы в режиме «вне сети» может помешать резервному копированию журнала. В этом случае следует использовать команду DBCC REPAIR, так как при этом потери данных будут меньше, чем при восстановлении из самой последней резервной копии.  
  
    -   Когда при резервном копировании журнала базы данных с неполным протоколированием выявляется поврежденная страница, оно завершается ошибкой, если не указано предложение WITH CONTINUE_AFTER_ERROR.  
  
    -   Восстановление страниц обычно не работает в модели восстановления с неполным протоколированием.  
  
         Лучший способ выполнить восстановление страницы — это установить для базы данных модель полного восстановления и выполнить попытку резервного копирования журнала. Если восстановление журнала работает, то можно продолжить и выполнить восстановление страницы. В случае ошибка резервного копирования журнала придется либо потерять все изменения с момента предыдущего резервного копирования журнала, либо попытаться выполнить проверку базы данных (DBCC) с параметром REPAIR_ALLOW_DATA_LOSS.  
  
###  <a name="recommendations"></a><a name="Recommendations"></a> Рекомендации  
  
-   Сценарии восстановления страницы  
  
     Восстановление страниц в режиме «вне сети»  
     Все выпуски [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] поддерживают восстановление страниц, когда база данных находится в автономном режиме. На время проведения восстановление страниц в автономном режиме база данных переключается в соответствующий режим. В конце последовательности восстановления база данных переходит в режим «в сети».  
  
     Восстановление страниц в оперативном режиме  
     [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Выпуск Enterprise поддерживает восстановление страниц в оперативном режиме. Но если база данных работает в режиме "вне сети", то используется функция автономного восстановления. В большинстве случаев поврежденная страница может быть восстановлена во время работы базы данных в режиме «в сети», включая файловую группу, в которой должна быть восстановлена страница. Если первичная файловая группа находится в режиме «в сети», а одна или несколько дополнительных файловых групп находятся в режиме «вне сети», используются операции оперативного восстановления. Иногда для восстановления поврежденной страницы необходимо использовать функции автономного восстановления. Например, повреждение некоторых важных страниц может привести к проблемам с запуском базы данных.  
  
    > [!WARNING]  
    >  Если поврежденные страницы содержат критические метаданные баз данных, то во время попытки восстановление страниц в оперативном режиме при выполнении необходимых обновлений метаданных может произойти ошибка. В этом случае можно выполнить восстановление страниц в автономном режиме, но сначала необходимо создать [резервную копию заключительного фрагмента журнала](tail-log-backups-sql-server.md) (путем резервного копирования журнала транзакций с параметром RESTORE WITH NORECOVERY).  
  
-   Для восстановления страниц используются усовершенствованные функции отчетов об ошибках на уровне страниц (включая контрольные суммы страниц) и функции отслеживания. Страницы, определенные как имеющие такие ошибки, как контрольное суммирование или прерванная запись, т. е. *поврежденные страницы*, можно восстановить с помощью операции восстановления страниц. Восстанавливаются только явно определенные страницы. Каждая указанная страница заменяется копией страницы из указанной резервной копии данных.  
  
     При восстановлении последующих резервных копий журналов они применяются только к файлам базы данных, содержащим хотя бы одну восстанавливаемую страницу. Для перевода файловой группы в состояние, соответствующее текущему файлу журнала, необходимо применить непрерывную последовательность резервных копий журнала к последнему экземпляру, полученному в результате полного или разностного восстановления. Как и при восстановлении файлов, набор данных наката продвигается одним проходом повторения журнала. Для успешного выполнения операции восстановления состояние восстановленных страниц должно соответствовать состоянию базы данных.  
  
###  <a name="security"></a><a name="Security"></a> безопасность  
  
####  <a name="permissions"></a><a name="Permissions"></a> Permissions  
 Если восстанавливаемая база данных не существуют, для выполнения инструкции RESTORE у пользователя должны быть разрешения CREATE DATABASE. Если база данных существует, разрешения на выполнение инструкции RESTORE по умолчанию предоставлены членам предопределенных ролей сервера **sysadmin** и **dbcreator** , а также владельцу базы данных (**dbo**) (для параметра FROM DATABASE_SNAPSHOT база данных всегда существует).  
  
 Разрешения на выполнение инструкции RESTORE даются ролям, в которых данные о членстве всегда доступны серверу. Так как членство в предопределенной роли базы данных может быть проверено только тогда, когда база данных доступна и не повреждена, что не всегда имеет место при выполнении инструкции RESTORE, члены предопределенной роли базы данных **db_owner** не имеют разрешений RESTORE.  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> Использование среды SQL Server Management Studio  
 Начиная с [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], среда [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] поддерживает восстановление страниц.  
  
#### <a name="to-restore-pages"></a>Восстановление страниц  
  
1.  После подключения к соответствующему экземпляру компонента [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)]в обозревателе объектов разверните дерево сервера, щелкнув имя сервера.  
  
2.  Разверните узел **Базы данных**. В зависимости от типа восстанавливаемой базы данных выберите пользовательскую базу данных или раскройте узел **Системные базы данных**и выберите системную базу данных.  
  
3.  Щелкните правой кнопкой мыши базу данных, выберите пункт **Задачи**, затем пункт **Восстановить**и пункт **Страница**. Откроется диалоговое окно **Восстановление страницы** .  
  
     **Восстановление**  
     В этом разделе выполняется та же функция, что и в пункте **Восстановить в** из раздела [Восстановление базы данных (страница "Общие")](../../integration-services/general-page-of-integration-services-designers-options.md).  
  
     **База данных**  
     Задает базу данных для восстановления. Можно ввести новую базу данных или выбрать уже существующую из раскрывающегося списка. Список включает все базы данных на сервере, за исключением системных баз данных **master** и **tempdb**.  
  
    > [!WARNING]  
    >  Для восстановления резервной копии, защищенной паролем, необходимо использовать инструкцию [RESTORE](/sql/t-sql/statements/restore-statements-transact-sql) .  
  
     **Резервная копия заключительного фрагмента журнала**  
     Введите или выберите имя файла в поле **Устройство резервного копирования** , где будет сохранена резервная копия заключительного фрагмента журнала для базы данных.  
  
     **Резервные наборы данных**  
     В этом разделе рассматриваются резервные наборы данных, участвующие в восстановлении.  
  
    |Заголовок|Значения|  
    |------------|------------|  
    |**имя**;|Имя резервного набора данных.|  
    |**Компонент**|Компонент, сохраненный в резервной копии: **база данных**, **файл** или **\<blank>** (для журналов транзакций).|  
    |**Тип**|Тип выполняемого резервного копирования: **Полное**, **Разностное**или **Журнал транзакций**.|  
    |**Server**|Имя экземпляра компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)] , выполнившего операцию резервного копирования.|  
    |**База данных**|Имя базы данных, участвовавшей в операции резервного копирования.|  
    |**Положение**|Расположение резервного набора данных в томе.|  
    |**Первый номер LSN**|Регистрационный номер в журнале первой транзакции в резервном наборе данных. Пустой для резервных копий файлов.|  
    |**Последний номер LSN**|Регистрационный номер в журнале последней транзакции в резервном наборе данных. Пустой для резервных копий файлов.|  
    |**Номер LSN для контрольной точки**|Регистрационный номер транзакции в журнале (номер LSN) для последней контрольной точки на время создания резервной копии.|  
    |**Полный номер LSN**|Номер LSN в журнале последнего полного резервного копирования базы данных.|  
    |**Дата начала**|Дата и время начала операции резервного копирования, указанные в региональных настройках клиента.|  
    |**Дата завершения**|Дата и время завершения операции резервного копирования, указанные в формате, соответствующем региональным настройкам клиента.|  
    |**Размер**|Размер резервного набора данных в байтах.|  
    |**Имя пользователя**|Имя пользователя, выполнившего операцию резервного копирования.|  
    |**Истечение срока**|Дата и время истечения срока действия резервного набора данных.|  
  
     Выберите **Проверка** для проверки целостности файлов резервных копий, необходимых для операции восстановления страниц.  
  
4.  Чтобы найти поврежденные страницы, выберите нужную базу данных поле **База данных** и нажмите кнопку **Проверить страницы базы данных**. Выполнение этой операции занимает длительное время.  
  
    > [!WARNING]  
    >  Чтобы восстановить конкретные неповрежденные страницы, нажмите кнопку **Добавить** и введите **Идентификатор файла** и **Идентификатор страница** для восстанавливаемых страниц.  
  
5.  Для определения восстанавливаемых страниц используется сетка страниц. Изначально эта сетка заполняется с использованием системной таблицы [suspect_pages](/sql/relational-databases/system-tables/suspect-pages-transact-sql) . Для добавления или удаления страниц из сетки используйте команды **Добавить** или **Удалить**. Дополнительные сведения см. в разделе [Управление таблицей suspect_pages (SQL Server)](manage-the-suspect-pages-table-sql-server.md).  
  
6.  В сетке **Резервные наборы данных** перечислены резервные наборы в плане восстановления по умолчанию. При необходимости нажмите кнопку **Проверить** , чтобы убедиться, не выполняя восстановление, что резервные копии могут быть прочитаны, а резервные наборы данных являются полными. Дополнительные сведения см. в разделе [RESTORE VERIFYONLY (Transact-SQL)](/sql/t-sql/statements/restore-statements-verifyonly-transact-sql).  
  
     **Страницы**  
  
7.  Чтобы восстановить страницы, перечисленные в сетке страниц, нажмите кнопку **ОК**.  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> Использование Transact-SQL  
 Чтобы указать страницу в инструкции RESTORE DATABASE, понадобится идентификатор файла, содержащего страницу, и идентификатор страницы. Необходимый синтаксис выглядит следующим образом:  
  
 `RESTORE DATABASE <database_name>`  
  
 `PAGE = '<file: page> [ ,... n ] ' [ ,... n ]`  
  
 `FROM <backup_device> [ ,... n ]`  
  
 `WITH NORECOVERY`  
  
 Дополнительные сведения о параметрах PAGE см. в разделе [Аргументы RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-arguments-transact-sql). Дополнительные сведения о синтаксисе RESTORE DATABASE см. в разделе [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql).  
  
#### <a name="to-restore-pages"></a>Восстановление страниц  
  
1.  Получите идентификаторы поврежденных страниц, подлежащих восстановлению. Контрольное суммирование или прерванная запись возвращают идентификатор страницы, обеспечивая сведения, необходимые для указания страниц. Чтобы определить идентификатор поврежденной страницы, используйте любой из нижеследующих источников.  
  
    |Источник идентификатора страницы|Раздел|  
    |-----------------------|-----------|  
    |**msdb.suspect_pages**|[Управление таблицей suspect_pages (SQL Server)](manage-the-suspect-pages-table-sql-server.md)|  
    |Журнал ошибок|[Просмотр журнала ошибок SQL Server (среда SQL Server Management Studio)](../../ssms/sql-server-management-studio-ssms.md)|  
    |История событий|[Наблюдение и обработка событий](../../ssms/agent/monitor-and-respond-to-events.md)|  
    |DBCC|[DBCC (Transact-SQL)](/sql/t-sql/database-console-commands/dbcc-transact-sql)|  
    |Поставщик WMI|[Основные понятия о поставщике WMI для событий сервера](../wmi-provider-server-events/wmi-provider-for-server-events-concepts.md)|  
  
2.  Начните восстановление страниц с полной резервной копии базы данных либо резервной копии файла или файловой группы, содержащей страницу. В инструкции RESTORE DATABASE используйте предложение PAGE для перечисления идентификаторов всех страниц, подлежащих восстановлению.  
  
3.  Примените последние разностные резервные копии.  
  
4.  Примените последующие резервные копии журнала.  
  
5.  Создайте новую резервную копию журнала базы данных, включающую в себя итоговый номер LSN восстановленных страниц, то есть момент, когда последняя из восстановленных страниц переведена в режим «вне сети». Итоговый номер LSN, устанавливаемый в качестве части первого восстановления в последовательности, является номером LSN цели повтора. Накат файла «в сети», содержащего страницу, сможет остановиться у номера LSN цели повтора. Чтобы выяснить текущий номер LSN цели повтора файла, обратитесь к столбцу **redo_target_lsn** в **sys.master_files**. Дополнительные сведения см. в разделе [sys.master_files (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-master-files-transact-sql).  
  
6.  Восстановите новую резервную копию журнала. Как только эта новая резервная копия журнала будет применена, восстановление страниц завершается, и страницы готовы к использованию.  
  
    > [!NOTE]  
    >  Эта последовательность аналогична последовательности восстановления файла. Фактически восстановление страниц и восстановление файлов могут выполняться как части одной и той же последовательности.  
  
###  <a name="example-transact-sql"></a><a name="TsqlExample"></a> Примеры (Transact-SQL)  
 В этом примере восстанавливаются четыре поврежденные страницы файла `B` в режиме `NORECOVERY`. Далее, после применения двух резервных копий журналов с параметром `NORECOVERY`, следует восстановление резервной копии заключительного фрагмента журнала с параметром `RECOVERY`. В этом примере выполняется восстановление в сети. В следующем примере идентификатором файла `B` является `1`, а идентификаторами поврежденных страниц — `57`, `202`, `916`и `1016`.  
  
```sql  
RESTORE DATABASE <database> PAGE='1:57, 1:202, 1:916, 1:1016'  
   FROM <file_backup_of_file_B>   
   WITH NORECOVERY;  
RESTORE LOG <database> FROM <log_backup>   
   WITH NORECOVERY;  
RESTORE LOG <database> FROM <log_backup>   
   WITH NORECOVERY;   
BACKUP LOG <database> TO <new_log_backup>;   
RESTORE LOG <database> FROM <new_log_backup> WITH RECOVERY;  
GO  
```  
  
## <a name="see-also"></a>См. также:  
 [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql)   
 [Применение резервных копий журналов транзакций (SQL Server)](transaction-log-backups-sql-server.md)   
 [Управление таблицей suspect_pages (SQL Server)](manage-the-suspect-pages-table-sql-server.md)   
 [Резервное копирование и восстановление баз данных SQL Server](back-up-and-restore-of-sql-server-databases.md)  
  
  
