---
title: Восстановление файлов (модель полного восстановления) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- file restores [SQL Server]
- full recovery model [SQL Server], performing restores
- restoring files [SQL Server], Transact-SQL restore sequence
- restoring files [SQL Server]
- file restores [SQL Server], full recovery model
- restoring files [SQL Server], full recovery model
- Transact-SQL restore sequence
- file restores [SQL Server], Transact-SQL restore sequence
ms.assetid: d2236a2a-4cf1-4c3f-b542-f73f6096e15c
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 488515ec900867f13d33580402e36a3f98747bb2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87731762"
---
# <a name="file-restores-full-recovery-model"></a>Файлы из резервных копий (модель полного восстановления)
  Сведения этого раздела относятся только к тем базам данных, которые содержат несколько файловых групп в модели полного восстановления или модели восстановления с неполным протоколированием.  
  
 Цель восстановления файлов — восстановить один или несколько поврежденных файлов, не восстанавливая всю базу данных. Сценарий восстановления файлов состоит из одной последовательности восстановления, которая копирует данные, выполняет накат и восстанавливает соответствующие данные.  
  
 Если восстанавливаемая файловая группа предназначена для чтения и записи, то после восстановления последних данных или разностной резервной копии необходимо применение резервных копий журналов. При этом производится накат файловой группы до текущих активных записей журнальных файлов. Точка восстановления обычно рядом с концом журнала, но это не обязательно.  
  
 Если файловая группа доступна только для чтения, применение резервных копий журналов не нужно, и поэтому оно будет пропущено. Если резервирование проводилось после того, как файл был переведен в режим только для чтения, то эта копия является последней для восстановления. Накат вперед заканчивается в целевой момент.  
  
 Существуют следующие сценарии восстановления файлов.  
  
-   Восстановление файлов в режиме «вне сети»  
  
     При *автономном восстановлении файлов*база данных находится в режиме «вне сети», в то время как происходит восстановление поврежденных файлов или файловых групп. В конце последовательности восстановления база данных переходит в режим «в сети».  
  
     Автономное восстановление файлов поддерживают все выпуски [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .  
  
-   Восстановление файлов в сети  
  
     При *оперативном восстановлении файлов*, если база данных во время восстановления находится в режиме «в сети», то остается в этом режиме в течение времени восстановления файлов. Однако каждая файловая группа, в которой восстанавливается файл, во время операции восстановления находится в состоянии «вне сети». После восстановления всех файлов, входящих в файловую группу в режиме «вне сети», она автоматически переключается в режим «в сети».  
  
     Дополнительные сведения о поддержке оперативного восстановления страниц и файлов см. в разделе [Возможности, поддерживаемые различными выпусками SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md). Дополнительные сведения об оперативном восстановлении см. в разделе [Оперативное восстановление (SQL Server)](online-restore-sql-server.md).  
  
    > [!TIP]  
    >  Если желательно, чтобы база данных находилась в режиме "вне сети" для восстановления файлов, переведите ее в этот режим перед запуском последовательности восстановления, выполнив следующую инструкцию [ALTER DATABASE](/sql/t-sql/statements/alter-database-transact-sql-set-options): ALTER DATABASE *имя_базы_данных* SET OFFLINE.  
  
  
  
##  <a name="restoring-damaged-files-from-file-backups"></a><a name="Overview"></a> Восстановление поврежденных файлов из резервных копий файлов  
  
1.  Перед восстановлением одного или нескольких поврежденных файлов попробуйте создать [резервную копию заключительного фрагмента журнала](tail-log-backups-sql-server.md).  
  
     Если журнал был поврежден, то невозможно создать резервную копию заключительного фрагмента журнала и приходится восстанавливать всю базу данных.  
  
     Сведения о создании резервной копии журналов транзакций см. в разделе [Резервные копии журналов транзакций (SQL Server)](transaction-log-backups-sql-server.md).  
  
    > [!IMPORTANT]  
    >  Для восстановления файлов вне сети необходимо всегда снимать резервную копию заключительного фрагмента журнала перед восстановлением резервной копии файлов. Для восстановления файлов вне сети необходимо всегда снимать резервную копию журнала перед восстановлением резервной копии файлов. Это необходимо из-за того, что файл должен быть восстановлен в состояние, согласованное с оставшейся частью базы данных.  
  
2.  Восстановите каждый поврежденный файл из самой последней резервной копии этого файла.  
  
3.  Восстановите самую последнюю разностную резервную копию файлов, если она существует, для каждого восстановленного файла.  
  
4.  Восстановите резервные копии журнала транзакций в последовательности, начиная с резервной копии, покрывающей самый старый из восстановленных файлов, и заканчивая резервной копией заключительного фрагмента журнала, созданной на этапе 1.  
  
     Необходимо восстановить резервные копии журналов транзакций, созданные после резервных копий файлов, для приведения базы данных в согласованное состояние. Накат резервных копий журналов транзакций может производиться быстро, поскольку применяются только изменения для восстановленных файлов. Восстановление отдельных файлов может привести к лучшим результатам, чем восстановление всей базы данных целиком, так как в последнем случае неповрежденные файлы не будут скопированы и будут откачены назад. Однако вся цепочка резервных копий журналов должна быть читаема.  
  
5.  Восстановите базу данных по журналам транзакций.  
  
> [!NOTE]  
>  Резервные копии файлов могут использоваться для восстановления базы данных на более ранний момент времени. Для этого необходимо восстановить полный набор резервных копий файлов, затем восстановить резервные копии журналов транзакций в последовательности до достижения нужной точки, следующей за концом самой последней восстановленной резервной копии файла. Дополнительные сведения о восстановлении на данный момент времени см. в разделе [Восстановление базы данных SQL Server до определенного момента времени (модель полного восстановления)](restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md).  
  
## <a name="transact-sql-restore-sequence-for-an-offline-file-restore-full-recovery-model"></a>Последовательность восстановления Transact-SQL для восстановления файлов вне сети (модель полного восстановления)  
 Сценарий восстановления файлов состоит из одной последовательности восстановления, которая копирует данные, выполняет накат и восстанавливает соответствующие данные.  
  
 В этом разделе показаны основные параметры инструкции [RESTORE](/sql/t-sql/statements/restore-statements-transact-sql) для последовательности восстановления файлов. Синтаксис и прочие подробности, несущественные для данной цели, опущены.  
  
 Пример показывает автономное восстановление вторичных файлов `A` и `B`с параметром WITH NORECOVERY. Далее используются две резервные копий журналов с параметром NORECOVERY, затем резервная копия заключительного фрагмента журнала и выполняется восстановление с параметром WITH NORECOVERY.  
  
> [!NOTE]  
>  Следующая простая последовательность восстановления начинается с перевода файла в состояние «вне сети», после чего создается резервная копия заключительного фрагмента журнала.  
  
```  
--Take the file offline.  
ALTER DATABASE database_name MODIFY FILE SET OFFLINE;  
-- Back up the currently active transaction log.  
BACKUP LOG database_name  
   TO <tail_log_backup>  
   WITH NORECOVERY;  
GO   
-- Restore the files.  
RESTORE DATABASE database_name FILE=name   
   FROM <file_backup_of_file_A>   
   WITH NORECOVERY;  
RESTORE DATABASE database_name FILE=<name> ......  
   FROM <file_backup_of_file_B>   
   WITH NORECOVERY;  
-- Restore the log backups.  
RESTORE LOG database_name FROM <log_backup>   
   WITH NORECOVERY;  
RESTORE LOG database_name FROM <log_backup>   
   WITH NORECOVERY;  
RESTORE LOG database_name FROM <tail_log_backup>   
   WITH RECOVERY;  
```  
  
## <a name="examples"></a>Примеры  
  
-   [Пример. Оперативное восстановление файла, доступного для чтения и записи &#40;модель полного восстановления&#41;](example-online-restore-of-a-read-write-file-full-recovery-model.md)  
  
-   [Пример. Оперативное восстановление файла, доступного только для чтения &#40;модель полного восстановления&#41;](example-online-restore-of-a-read-only-file-full-recovery-model.md)  
  
-   [Пример. Автономное восстановление основной и еще одной файловой группы &#40;модель полного восстановления&#41;](example-offline-restore-of-primary-and-one-other-filegroup-full-recovery-model.md)  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
 **Восстановление файлов и файловых групп**  
  
-   [Восстановление файлов в новое место (SQL Server)](restore-files-to-a-new-location-sql-server.md)  
  
-   [Восстановление файлов и файловых групп (SQL Server)](restore-files-and-filegroups-sql-server.md)  
  
-   <xref:Microsoft.SqlServer.Management.Smo.Restore.SqlRestore%2A> (SMO)  
  

  
## <a name="see-also"></a>См. также:  
 [Резервное копирование и восстановление: взаимодействие и совместимость &#40;SQL Server&#41;](backup-and-restore-interoperability-and-coexistence-sql-server.md)   
 [Разностные резервные копии (SQL Server)](differential-backups-sql-server.md)   
 [Полные резервные копии файлов (SQL Server)](full-file-backups-sql-server.md)   
 [Общие сведения о резервном копировании (SQL Server)](backup-overview-sql-server.md)   
 [Обзор процессов восстановления (SQL Server)](restore-and-recovery-overview-sql-server.md)   
 [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql)   
 [Выполнение полного восстановления базы данных (простая модель восстановления)](complete-database-restores-simple-recovery-model.md)   
 [Поэтапное восстановление (SQL Server)](piecemeal-restores-sql-server.md)  
  
  
