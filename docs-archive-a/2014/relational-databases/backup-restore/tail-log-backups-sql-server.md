---
title: Резервные копии заключительного фрагмента журнала (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- backing up [SQL Server], tail of log
- transaction log backups [SQL Server], tail-log backups
- NO_TRUNCATE clause
- backups [SQL Server], log backups
- tail-log backups
- backups [SQL Server], tail-log backups
ms.assetid: 313ddaf6-ec54-4a81-a104-7ffa9533ca58
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: cd7c505701a4edb1f66ca516d06179b2eb1a222d
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87655783"
---
# <a name="tail-log-backups-sql-server"></a><span data-ttu-id="c2f68-102">Резервные копии заключительного фрагмента журнала (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c2f68-102">Tail-Log Backups (SQL Server)</span></span>
  <span data-ttu-id="c2f68-103">В данном разделе рассматриваются вопросы резервного копирования и восстановления только тех баз данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , которые используют модель полного восстановления или модель восстановления с неполным протоколированием.</span><span class="sxs-lookup"><span data-stu-id="c2f68-103">This topic is relevant only for backup and restore of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] databases that are using the full or bulk-logged recovery models.</span></span>  
  
 <span data-ttu-id="c2f68-104">В *резервную копию заключительного фрагмента журнала* попадают все записи, резервная копия которых еще не была создана ( *заключительный фрагмент журнала*), что позволяет предотвратить потерю работы и сохранить неповрежденную цепочку журналов.</span><span class="sxs-lookup"><span data-stu-id="c2f68-104">A *tail-log backup* captures any log records that have not yet been backed up (the *tail of the log*) to prevent work loss and to keep the log chain intact.</span></span> <span data-ttu-id="c2f68-105">Для восстановления базы данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] на последний момент времени необходимо предварительно выполнить резервное копирование заключительного фрагмента журнала ее транзакций.</span><span class="sxs-lookup"><span data-stu-id="c2f68-105">Before you can recover a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database to its latest point in time, you must back up the tail of its transaction log.</span></span> <span data-ttu-id="c2f68-106">Заключительный фрагмент журнала является становится последней рассматриваемой частью резервной копии в плане восстановления базы данных.</span><span class="sxs-lookup"><span data-stu-id="c2f68-106">The tail-log backup will be the last backup of interest in the recovery plan for the database.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c2f68-107">Не для всех сценариев восстановления требуется резервная копия заключительного фрагмента журнала.</span><span class="sxs-lookup"><span data-stu-id="c2f68-107">Not all restore scenarios require a tail-log backup.</span></span> <span data-ttu-id="c2f68-108">Резервная копия заключительного фрагмента журнала не нужна, если точка восстановления содержится в более ранней резервной копии журнала.</span><span class="sxs-lookup"><span data-stu-id="c2f68-108">You do not need a tail-log backup if the recovery point is contained in an earlier log backup.</span></span> <span data-ttu-id="c2f68-109">Кроме того, резервная копия заключительного фрагмента журнала не требуется при перемещении или замещении (перезаписи) базы данных, при котором не нужно восстанавливать ее на определенный момент времени после создания ее последней резервной копии.</span><span class="sxs-lookup"><span data-stu-id="c2f68-109">Also, a tail-log backup is unnecessary if you are moving or replacing (overwriting) a database and do not need to restore it to a point of time after its most recent backup.</span></span>  
  
 
  
##  <a name="scenarios-that-require-a-tail-log-backup"></a><a name="TailLogScenarios"></a> <span data-ttu-id="c2f68-110">Сценарии, в которых требуется резервная копия заключительного фрагмента журнала.</span><span class="sxs-lookup"><span data-stu-id="c2f68-110">Scenarios That Require a Tail-Log Backup</span></span>  
 <span data-ttu-id="c2f68-111">Рекомендуется формировать резервную копию заключительного фрагмента журнала в следующих сценариях.</span><span class="sxs-lookup"><span data-stu-id="c2f68-111">We recommend that you take a tail-log backup in the following scenarios:</span></span>  
  
-   <span data-ttu-id="c2f68-112">Если база данных находится в режиме «в сети» и следующим действием над базой данных должна быть операция восстановления, то прежде необходимо выполнить резервное копирование заключительного фрагмента журнала.</span><span class="sxs-lookup"><span data-stu-id="c2f68-112">If the database is online and you plan to perform a restore operation on the database, begin by backing up the tail of the log.</span></span> <span data-ttu-id="c2f68-113">Чтобы избежать ошибок в оперативной базе данных, необходимо использовать... Параметр WITH NORECOVERY инструкции [BACKUP](/sql/t-sql/statements/backup-transact-sql) [!INCLUDE[tsql](../../includes/tsql-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="c2f68-113">To avoid an error for an online database, you must use the ... WITH NORECOVERY option of the [BACKUP](/sql/t-sql/statements/backup-transact-sql)[!INCLUDE[tsql](../../includes/tsql-md.md)] statement.</span></span>  
  
-   <span data-ttu-id="c2f68-114">Если база данных, работающая в режиме «вне в сети», не запускается и необходимо восстановить базу данных, то в первую очередь необходимо выполнить резервное копирование заключительного фрагмента журнала.</span><span class="sxs-lookup"><span data-stu-id="c2f68-114">If a database is offline and fails to start and you need to restore the database, first back up the tail of the log.</span></span> <span data-ttu-id="c2f68-115">Так как в это время никакие транзакции не выполняются, параметр WITH NORECOVERY использовать не обязательно.</span><span class="sxs-lookup"><span data-stu-id="c2f68-115">Because no transactions can occur at this time, using the WITH NORECOVERY is optional.</span></span>  
  
-   <span data-ttu-id="c2f68-116">Если база данных повреждена, попытайтесь получить резервную копию заключительного фрагмента журнала, используя параметр WITH CONTINUE_AFTER_ERROR инструкции BACKUP.</span><span class="sxs-lookup"><span data-stu-id="c2f68-116">If a database is damaged, try to take a tail-log backup by using the WITH CONTINUE_AFTER_ERROR option of the BACKUP statement.</span></span>  
  
     <span data-ttu-id="c2f68-117">Резервное копирование заключительного фрагмента журнала поврежденной базы данных может быть успешно выполнено только в том случае, если файлы журнала не повреждены, а база данных находится в режиме, который поддерживает резервное копирование заключительного фрагмента журнала, и не содержит какие-либо изменения с неполным протоколированием.</span><span class="sxs-lookup"><span data-stu-id="c2f68-117">On a damaged database backing up the tail of the log can succeed only if the log files are undamaged, the database is in a state that supports tail-log backups, and the database does not contain any bulk-logged changes.</span></span> <span data-ttu-id="c2f68-118">Если резервная копия заключительного фрагмента журнала не может быть создана, то любые транзакции, зафиксированные после создания последней резервной копии журнала, будут потеряны.</span><span class="sxs-lookup"><span data-stu-id="c2f68-118">If a tail-log backup cannot be created, any transactions committed after the latest log backup are lost.</span></span>  
  
 <span data-ttu-id="c2f68-119">В следующей таблице представлена сводка параметров BACKUP NORECOVERY и CONTINUE_AFTER_ERROR.</span><span class="sxs-lookup"><span data-stu-id="c2f68-119">The following table summarizes the BACKUP NORECOVERY and CONTINUE_AFTER_ERROR options.</span></span>  
  
|<span data-ttu-id="c2f68-120">Параметр BACKUP LOG</span><span class="sxs-lookup"><span data-stu-id="c2f68-120">BACKUP LOG option</span></span>|<span data-ttu-id="c2f68-121">Комментарии</span><span class="sxs-lookup"><span data-stu-id="c2f68-121">Comments</span></span>|  
|-----------------------|--------------|  
|<span data-ttu-id="c2f68-122">NORECOVERY</span><span class="sxs-lookup"><span data-stu-id="c2f68-122">NORECOVERY</span></span>|<span data-ttu-id="c2f68-123">Если планируется продолжить операцию восстановления базы данных, используйте параметр NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="c2f68-123">Use NORECOVERY whenever you intend to continue with a restore operation on the database.</span></span> <span data-ttu-id="c2f68-124">NORECOVERY переводит базу данных в состояние восстановления.</span><span class="sxs-lookup"><span data-stu-id="c2f68-124">NORECOVERY takes the database into the restoring state.</span></span> <span data-ttu-id="c2f68-125">Это гарантирует, что после создания резервной копии заключительного фрагмента журнала база данных не изменится.</span><span class="sxs-lookup"><span data-stu-id="c2f68-125">This guarantees that the database does not change after the tail-log backup.</span></span>  <span data-ttu-id="c2f68-126">Если параметры NO_TRUNCATE или COPY_ONLY не заданы, то журнал усекается.</span><span class="sxs-lookup"><span data-stu-id="c2f68-126">The log is truncated unless the NO_TRUNCATE option or COPY_ONLY option is also specified.</span></span><br /><br /> <span data-ttu-id="c2f68-127">Важно избегать использования NO_TRUNCATE, за исключением случаев, когда база данных повреждена. \*\* \* \* \* \* \*\*</span><span class="sxs-lookup"><span data-stu-id="c2f68-127">**\*\* Important \*\*** We recommend that you avoid using NO_TRUNCATE, except when the database is damaged.</span></span>|  
|<span data-ttu-id="c2f68-128">CONTINUE_AFTER_ERROR</span><span class="sxs-lookup"><span data-stu-id="c2f68-128">CONTINUE_AFTER_ERROR</span></span>|<span data-ttu-id="c2f68-129">Параметр CONTINUE_AFTER_ERROR следует указывать только в том случае, если создается резервная копия заключительного фрагмента журнала поврежденной базы данных.</span><span class="sxs-lookup"><span data-stu-id="c2f68-129">Use CONTINUE_AFTER_ERROR only if you are backing up the tail of a damaged database.</span></span><br /><br /> <span data-ttu-id="c2f68-130">Примечание. при использовании резервного копирования заключительного фрагмента журнала поврежденной базы данных некоторые метаданные, обычно захваченные в резервных копиях журналов, могут быть недоступны.</span><span class="sxs-lookup"><span data-stu-id="c2f68-130">Note: When you use back up the tail of the log on a damaged database, some of the metadata ordinarily captured in log backups might be unavailable.</span></span> <span data-ttu-id="c2f68-131">Дополнительные сведения см. в подразделе [Резервное копирование заключительного фрагмента журнала с неполными метаданными резервной копии](#IncompleteMetadata) ниже в данном разделе.</span><span class="sxs-lookup"><span data-stu-id="c2f68-131">For more information, see [Tail-Log Backups That Have Incomplete Backup Metadata](#IncompleteMetadata), later in this topic.</span></span>|  
  
##  <a name="tail-log-backups-that-have-incomplete-backup-metadata"></a><a name="IncompleteMetadata"></a><span data-ttu-id="c2f68-132">Резервные копии заключительного фрагмента журнала с неполными метаданными резервного копирования</span><span class="sxs-lookup"><span data-stu-id="c2f68-132">Tail-Log Backups That Have Incomplete Backup Metadata</span></span>  
 <span data-ttu-id="c2f68-133">Резервное копирование заключительного фрагмента журнала захватывает конец журнала даже в тех случаях, когда база данных работает вне сети, повреждена или в ней не хватает файлов данных.</span><span class="sxs-lookup"><span data-stu-id="c2f68-133">Tail log backups capture the tail of the log even if the database is offline, damaged, or missing data files.</span></span> <span data-ttu-id="c2f68-134">В результате этого метаданные команд восстановления данных и базы данных **msdb**могут быть неполными.</span><span class="sxs-lookup"><span data-stu-id="c2f68-134">This might cause incomplete metadata from the restore information commands and **msdb**.</span></span> <span data-ttu-id="c2f68-135">Однако несмотря на неполноту метаданных, захваченный журнал будет полным и готовым к использованию.</span><span class="sxs-lookup"><span data-stu-id="c2f68-135">However, only the metadata is incomplete; the captured log is complete and usable.</span></span>  
  
 <span data-ttu-id="c2f68-136">Если резервная копия заключительного фрагмента журнала содержит неполные метаданные, то параметр [has_incomplete_metadata](/sql/relational-databases/system-tables/backupset-transact-sql) в таблице **backupset** принимает значение **1**.</span><span class="sxs-lookup"><span data-stu-id="c2f68-136">If a tail-log backup has incomplete metadata, in the [backupset](/sql/relational-databases/system-tables/backupset-transact-sql) table, **has_incomplete_metadata** is set to **1**.</span></span> <span data-ttu-id="c2f68-137">Кроме того, выходной аргумент [HasIncompleteMetadata](/sql/t-sql/statements/restore-statements-headeronly-transact-sql)инструкции **RESTORE HEADERONLY** принимает значение **1**.</span><span class="sxs-lookup"><span data-stu-id="c2f68-137">Also, in the output of [RESTORE HEADERONLY](/sql/t-sql/statements/restore-statements-headeronly-transact-sql), **HasIncompleteMetadata** is set to **1**.</span></span>  
  
 <span data-ttu-id="c2f68-138">Если метаданные в резервной копии заключительного фрагмента журнала неполные, то в таблице [backupfilegroup](/sql/relational-databases/system-tables/backupfilegroup-transact-sql) большая часть сведений о файловых группах того времени в резервной копии заключительного фрагмента журнала будет утеряна.</span><span class="sxs-lookup"><span data-stu-id="c2f68-138">If the metadata in a tail-log backup is incomplete, the [backupfilegroup](/sql/relational-databases/system-tables/backupfilegroup-transact-sql) table will be missing most of the information about filegroups at the time of the tail-log backup.</span></span> <span data-ttu-id="c2f68-139">Большинство столбцов таблицы **backupfilegroup** содержит значение NULL, другие значения имеют следующие столбцы:</span><span class="sxs-lookup"><span data-stu-id="c2f68-139">Most of the **backupfilegroup** table columns are NULL; the only meaningful columns are as follows:</span></span>  
  
-   <span data-ttu-id="c2f68-140">**backup_set_id**</span><span class="sxs-lookup"><span data-stu-id="c2f68-140">**backup_set_id**</span></span>  
  
-   <span data-ttu-id="c2f68-141">**filegroup_id**</span><span class="sxs-lookup"><span data-stu-id="c2f68-141">**filegroup_id**</span></span>  
  
-   <span data-ttu-id="c2f68-142">**type**</span><span class="sxs-lookup"><span data-stu-id="c2f68-142">**type**</span></span>  
  
-   <span data-ttu-id="c2f68-143">**type_desc**</span><span class="sxs-lookup"><span data-stu-id="c2f68-143">**type_desc**</span></span>  
  
-   <span data-ttu-id="c2f68-144">**is_readonly**</span><span class="sxs-lookup"><span data-stu-id="c2f68-144">**is_readonly**</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="c2f68-145">Связанные задачи</span><span class="sxs-lookup"><span data-stu-id="c2f68-145">Related Tasks</span></span>  
 <span data-ttu-id="c2f68-146">Инструкции по созданию резервной копии журнала транзакций см. в разделе [Резервное копирование журнала транзакций при повреждении базы данных (SQL Server)](back-up-the-transaction-log-when-the-database-is-damaged-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="c2f68-146">To create a tail-log backup, see [Back Up the Transaction Log When the Database Is Damaged &#40;SQL Server&#41;](back-up-the-transaction-log-when-the-database-is-damaged-sql-server.md).</span></span>  
  
 <span data-ttu-id="c2f68-147">Инструкции по восстановлению резервной копии журнала транзакций см. в разделе [Восстановление резервной копии журнала транзакций (SQL Server)](restore-a-transaction-log-backup-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="c2f68-147">To restore a transaction log backup, see [Restore a Transaction Log Backup &#40;SQL Server&#41;](restore-a-transaction-log-backup-sql-server.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c2f68-148">См. также:</span><span class="sxs-lookup"><span data-stu-id="c2f68-148">See Also</span></span>  
 <span data-ttu-id="c2f68-149">[BACKUP (Transact-SQL)](/sql/t-sql/statements/backup-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="c2f68-149">[BACKUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-transact-sql) </span></span>  
 <span data-ttu-id="c2f68-150">[RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="c2f68-150">[RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql) </span></span>  
 <span data-ttu-id="c2f68-151">[Резервное копирование и восстановление баз данных SQL Server](back-up-and-restore-of-sql-server-databases.md) </span><span class="sxs-lookup"><span data-stu-id="c2f68-151">[Back Up and Restore of SQL Server Databases](back-up-and-restore-of-sql-server-databases.md) </span></span>  
 <span data-ttu-id="c2f68-152">[Резервные копии только для копирования (SQL Server)](copy-only-backups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c2f68-152">[Copy-Only Backups &#40;SQL Server&#41;](copy-only-backups-sql-server.md) </span></span>  
 <span data-ttu-id="c2f68-153">[Резервные копии журналов транзакций (SQL Server)](transaction-log-backups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c2f68-153">[Transaction Log Backups &#40;SQL Server&#41;](transaction-log-backups-sql-server.md) </span></span>  
 [<span data-ttu-id="c2f68-154">Применение резервных копий журналов транзакций (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c2f68-154">Apply Transaction Log Backups &#40;SQL Server&#41;</span></span>](apply-transaction-log-backups-sql-server.md)  
  
  
