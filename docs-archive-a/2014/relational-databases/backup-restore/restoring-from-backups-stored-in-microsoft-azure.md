---
title: Восстановление из резервных копий, хранящихся в Azure | Документация Майкрософт
ms.custom: ''
ms.date: 03/07/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 6ae358b2-6f6f-46e0-a7c8-f9ac6ce79a0e
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 68b270f18cb4dbc2724c5a062afae54fa711acec
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87666671"
---
# <a name="restoring-from-backups-stored-in-azure"></a><span data-ttu-id="10a0c-102">Восстановление из резервных копий, хранящихся в Azure</span><span class="sxs-lookup"><span data-stu-id="10a0c-102">Restoring From Backups Stored in Azure</span></span>
  <span data-ttu-id="10a0c-103">В этом разделе представлены вопросы восстановления базы данных с помощью резервной копии в службе хранилища BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="10a0c-103">This topic outlines the considerations when restoring a database using a backup stored in the Azure Blob storage service.</span></span> <span data-ttu-id="10a0c-104">Это относится к резервным копиям, созданным либо с помощью резервного копирования SQL Server на URL-адрес, либо с помощью служб [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="10a0c-104">This applies to backups created either by using SQL Server Backup to URL backup or by [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)].</span></span>  
  
 <span data-ttu-id="10a0c-105">Рекомендуется ознакомиться с этим разделом, если у вас есть резервные копии в службе хранилища BLOB-объектов Azure, которые планируется восстановить. После этого изучите разделы, в которых описана процедура восстановления базы данных. Она аналогична для локальных резервных копий и резервных копий в Azure.</span><span class="sxs-lookup"><span data-stu-id="10a0c-105">We recommend reviewing this topic if you have backups stored in the Azure Blob storage service that you plan to restore, and then review the topics that describe the steps on how to restore a database which is the same for both on-premises and azure backups.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="10a0c-106">Обзор</span><span class="sxs-lookup"><span data-stu-id="10a0c-106">Overview</span></span>  
 <span data-ttu-id="10a0c-107">Средства и методы, используемые для восстановления базы данных из локальной резервной копии, применимы для восстановления базы данных из облака.</span><span class="sxs-lookup"><span data-stu-id="10a0c-107">The tools and methods that are used to restore a database from an on-premises backup apply to restoring a database from a cloud backup.</span></span>  <span data-ttu-id="10a0c-108">Далее рассматриваются эти вопросы, а также различия, которые нужно учитывать при использовании резервных копий в службе хранилища BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="10a0c-108">The following sections describe these considerations and any differences you should know about when you use backups stored in the Azure Blob storage service.</span></span>  
  
### <a name="using-transact-sql"></a><span data-ttu-id="10a0c-109">Использование Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="10a0c-109">Using Transact-SQL</span></span>  
  
-   <span data-ttu-id="10a0c-110">Так как SQL Server должен подключиться к внешнему источнику данных для получения файлов резервных копий, для проверки подлинности учетной записи хранения используются учетные данные SQL.</span><span class="sxs-lookup"><span data-stu-id="10a0c-110">Since SQL Server must connect to an external source to retrieve the backup files, SQL Credential is used to authenticate to the storage account.</span></span> <span data-ttu-id="10a0c-111">Соответственно, в инструкции RESTORE необходимо указать параметр WITH CREDENTIAL.</span><span class="sxs-lookup"><span data-stu-id="10a0c-111">Consequently, the RESTORE statement requires WITH CREDENTIAL option.</span></span> <span data-ttu-id="10a0c-112">Дополнительные сведения см. в статье [Резервное копирование и восстановление SQL Server с помощью службы хранилищ больших двоичных объектов Windows Azure](sql-server-backup-and-restore-with-microsoft-azure-blob-storage-service.md).</span><span class="sxs-lookup"><span data-stu-id="10a0c-112">For more information, see [SQL Server Backup and Restore with Azure Blob Storage Service](sql-server-backup-and-restore-with-microsoft-azure-blob-storage-service.md).</span></span>  
  
-   <span data-ttu-id="10a0c-113">Если вы используете [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)] для управления вашими резервными копиями в облаке, можно просматривать все доступные резервные копии в хранилище с помощью функции **smart_admin.fn_available_backups** .</span><span class="sxs-lookup"><span data-stu-id="10a0c-113">If you are using the [!INCLUDE[ss_smartbackup](../../includes/ss-smartbackup-md.md)] to manage your backups to the cloud, you can review all the available backups in the storage, by using the **smart_admin.fn_available_backups** system function.</span></span> <span data-ttu-id="10a0c-114">Эта функция возвращает все доступные резервные копии для базы данных в таблице.</span><span class="sxs-lookup"><span data-stu-id="10a0c-114">This system function returns all the available backups for a database in a table.</span></span> <span data-ttu-id="10a0c-115">Поскольку результаты возвращаются в виде таблицы, их можно фильтровать и сортировать.</span><span class="sxs-lookup"><span data-stu-id="10a0c-115">As the results are returned in a table, you can filter or sort the results.</span></span> <span data-ttu-id="10a0c-116">Дополнительные сведения см. в разделе [smart_admin. fn_available_backups &#40;&#41;Transact-SQL ](/sql/relational-databases/system-functions/managed-backup-fn-available-backups-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="10a0c-116">For more information, see [smart_admin.fn_available_backups &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/managed-backup-fn-available-backups-transact-sql).</span></span>  
  
### <a name="using-sql-server-management-studio"></a><span data-ttu-id="10a0c-117">Использование среды SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="10a0c-117">Using SQL Server Management Studio</span></span>  
  
-   <span data-ttu-id="10a0c-118">Для восстановления базы данных из SQL Server Management Studio используется задача восстановления.</span><span class="sxs-lookup"><span data-stu-id="10a0c-118">The restore task is used to restore a database using the SQL Server Management Studio.</span></span> <span data-ttu-id="10a0c-119">На странице носителя резервных копий теперь доступен параметр **URL-адрес** для отображения файлов резервных копий, размещенных в службе хранилища BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="10a0c-119">The backup media page now includes the **URL** option to show backup files stored in the Azure Blob storage service.</span></span> <span data-ttu-id="10a0c-120">Также необходимо указать учетные данные SQL, которые используются для проверки подлинности учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="10a0c-120">You also must provide the SQL Credential that is used to authenticate to the storage account.</span></span> <span data-ttu-id="10a0c-121">После этого сетка **Восстанавливаемые резервные наборы данных** заполняется всеми резервными копиями, доступными в хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="10a0c-121">The **Backup sets to restore** grid is then populated with the available backups in the Azure Blob storage.</span></span> <span data-ttu-id="10a0c-122">Дополнительные сведения см. в разделе [Восстановление из хранилища SQL Azure с помощью среды SQL Server Management Studio](sql-server-backup-to-url.md#RestoreSSMS).</span><span class="sxs-lookup"><span data-stu-id="10a0c-122">For more information, see [Restoring from Azure storage Using SQL Server Management Studio](sql-server-backup-to-url.md#RestoreSSMS).</span></span>  
  
### <a name="optimizing-restores"></a><span data-ttu-id="10a0c-123">Оптимизация восстановления</span><span class="sxs-lookup"><span data-stu-id="10a0c-123">Optimizing Restores</span></span>  
 <span data-ttu-id="10a0c-124">Чтобы снизить время восстановления, добавьте учетной записи пользователя SQL Server право **Выполнение задач по обслуживанию томов** .</span><span class="sxs-lookup"><span data-stu-id="10a0c-124">To reduce restore write time, Add **perform volume maintenance tasks** user right to the SQL Server user account.</span></span> <span data-ttu-id="10a0c-125">Дополнительные сведения см. в разделе [Инициализация файлов базы данных](https://go.microsoft.com/fwlink/?LinkId=271622).</span><span class="sxs-lookup"><span data-stu-id="10a0c-125">For more information, see [Database File Initialization](https://go.microsoft.com/fwlink/?LinkId=271622).</span></span> <span data-ttu-id="10a0c-126">Если при включенной быстрой инициализации файлов операция восстановления по-прежнему идет медленно, посмотрите размер файла журнала для экземпляра, где была создана резервная копия базы данных.</span><span class="sxs-lookup"><span data-stu-id="10a0c-126">If restore is still slow with instant file initialization turned on, look at the size of the log file on the instance where the database was backed up.</span></span> <span data-ttu-id="10a0c-127">Если размер журнала очень большой (несколько ГБ), то ожидается, что восстановление будет идти медленно.</span><span class="sxs-lookup"><span data-stu-id="10a0c-127">If the log is very large in size (multiple GBs), it would be expected that restore would be slow.</span></span> <span data-ttu-id="10a0c-128">Во время восстановления файл журнала необходимо обнулить, что занимает значительное количество времени.</span><span class="sxs-lookup"><span data-stu-id="10a0c-128">During restore the log file must be zeroed which takes a significant amount of time.</span></span>  
  
 <span data-ttu-id="10a0c-129">Для сокращения времени восстановления, рекомендуется использовать сжатые резервные копии.</span><span class="sxs-lookup"><span data-stu-id="10a0c-129">To reduce restore times it is recommended that you use compressed backups.</span></span>  <span data-ttu-id="10a0c-130">Для резервных копий, чей размер превышает 25 ГБ, используйте [служебную программу AzCopy](https://docs.microsoft.com/archive/blogs/windowsazurestorage/azcopy-uploadingdownloading-files-for-windows-azure-blobs) для загрузки на локальный привод и для последующего выполнения восстановления.</span><span class="sxs-lookup"><span data-stu-id="10a0c-130">For backup sizes exceeding 25 GB, use [AzCopy utility](https://docs.microsoft.com/archive/blogs/windowsazurestorage/azcopy-uploadingdownloading-files-for-windows-azure-blobs) to download to the local drive and then perform the restore.</span></span> <span data-ttu-id="10a0c-131">За дополнительными рекомендациями относительно резервных копий, обратитесь к [SQL Server Backup to URL Best Practices and Troubleshooting](sql-server-backup-to-url-best-practices-and-troubleshooting.md).</span><span class="sxs-lookup"><span data-stu-id="10a0c-131">For other backup best practices and recommendations, see [SQL Server Backup to URL Best Practices and Troubleshooting](sql-server-backup-to-url-best-practices-and-troubleshooting.md).</span></span>  
  
 <span data-ttu-id="10a0c-132">Также при выполнении восстановления можно включить флаг трассировки 3051, что приведет к формированию подробного журнала.</span><span class="sxs-lookup"><span data-stu-id="10a0c-132">You can also turn on Trace Flag 3051 when doing the restore to generate a detailed log.</span></span> <span data-ttu-id="10a0c-133">Этот файл журнала помещается в каталог журнала и получает имя в следующем формате: BackupToUrl-\<instancename>-\<dbname>-action-\<PID>.log.</span><span class="sxs-lookup"><span data-stu-id="10a0c-133">This log file is placed in the log directory, and is named using the format: BackupToUrl-\<instancename>-\<dbname>-action-\<PID>.log.</span></span> <span data-ttu-id="10a0c-134">В файле журнала сохраняются сведения о каждом круговом пути со службой хранилища Azure, включая время операции, что может быть полезно при диагностике проблемы.</span><span class="sxs-lookup"><span data-stu-id="10a0c-134">The log file includes information about each round trip to Azure Storage including timing that can be helpful in diagnosing the issue.</span></span>  
  
### <a name="topics-on-performing-restore-operations"></a><span data-ttu-id="10a0c-135">Разделы об операциях восстановления</span><span class="sxs-lookup"><span data-stu-id="10a0c-135">Topics on Performing Restore Operations</span></span>  
  
-   [<span data-ttu-id="10a0c-136">Выполнение полного восстановления базы данных (простая модель восстановления)</span><span class="sxs-lookup"><span data-stu-id="10a0c-136">Complete Database Restores &#40;Simple Recovery Model&#41;</span></span>](complete-database-restores-simple-recovery-model.md)  
  
-   [<span data-ttu-id="10a0c-137">RESTORE (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="10a0c-137">RESTORE &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/restore-statements-transact-sql)  
  
-   [<span data-ttu-id="10a0c-138">Выполнение полного восстановления базы данных (модель полного восстановления)</span><span class="sxs-lookup"><span data-stu-id="10a0c-138">Complete Database Restores &#40;Full Recovery Model&#41;</span></span>](complete-database-restores-full-recovery-model.md)  
  
-   [<span data-ttu-id="10a0c-139">Восстановление файлов (простая модель восстановления)</span><span class="sxs-lookup"><span data-stu-id="10a0c-139">File Restores &#40;Simple Recovery Model&#41;</span></span>](file-restores-simple-recovery-model.md)  
  
-   [<span data-ttu-id="10a0c-140">Файлы из резервных копий (модель полного восстановления)</span><span class="sxs-lookup"><span data-stu-id="10a0c-140">File Restores &#40;Full Recovery Model&#41;</span></span>](file-restores-full-recovery-model.md)  
  
-   [<span data-ttu-id="10a0c-141">Поэтапное восстановление (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="10a0c-141">Piecemeal Restores &#40;SQL Server&#41;</span></span>](piecemeal-restores-sql-server.md)  
  
  
