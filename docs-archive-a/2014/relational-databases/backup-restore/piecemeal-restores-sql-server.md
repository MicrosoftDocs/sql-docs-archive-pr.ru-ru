---
title: Поэтапное восстановление (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- partial updates [SQL Server]
- staged restores [SQL Server]
- piecemeal restores [SQL Server]
- restoring [SQL Server], piecemeal restore scenario
ms.assetid: 208f55e0-0762-4cfb-85c4-d36a76ea0f5b
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: ebc4ea11780908f847946a01338571211b57678a
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87731750"
---
# <a name="piecemeal-restores-sql-server"></a><span data-ttu-id="70ecb-102">Поэтапное восстановление (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="70ecb-102">Piecemeal Restores (SQL Server)</span></span>
  <span data-ttu-id="70ecb-103">Этот раздел касается только баз данных в выпуске [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise Edition, которые содержат несколько файлов или файловых групп, а для простой модели — только файловых групп, предназначенных только для чтения.</span><span class="sxs-lookup"><span data-stu-id="70ecb-103">This topic is relevant only for databases in the Enterprise edition of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] that contain multiple files or filegroups; and, under the simple model, only for read-only filegroups.</span></span>  
  
 <span data-ttu-id="70ecb-104">Дополнительные сведения о поэтапном восстановлении и оптимизированных для памяти таблицах см. в разделе [Поэтапное восстановление баз данных с таблицами, оптимизированными для памяти](../in-memory-oltp/memory-optimized-tables.md).</span><span class="sxs-lookup"><span data-stu-id="70ecb-104">For information about piecemeal restore and memory-optimized tables, see [Piecemeal Restore of Databases With Memory-Optimized Tables](../in-memory-oltp/memory-optimized-tables.md).</span></span>  
  
 <span data-ttu-id="70ecb-105">*Поэтапное восстановление* позволяет восстанавливать поэтапно базы данных, содержащие несколько файловых групп.</span><span class="sxs-lookup"><span data-stu-id="70ecb-105">*Piecemeal restore* allows databases that contain multiple filegroups to be restored and recovered in stages.</span></span> <span data-ttu-id="70ecb-106">Поэтапное восстановление включает в себя ряд последовательностей восстановления, начиная с первичной файловой группы и, в некоторых случаях, с одной или несколькими вторичными файловыми группами.</span><span class="sxs-lookup"><span data-stu-id="70ecb-106">Piecemeal restore involves a series of restore sequences, starting with the primary filegroup and, in some cases, one or more secondary filegroups.</span></span> <span data-ttu-id="70ecb-107">Поэтапное восстановление поддерживает проверки, обеспечивающие согласованность базы данных.</span><span class="sxs-lookup"><span data-stu-id="70ecb-107">Piecemeal restore maintains checks to ensure that the database will be consistent in the end.</span></span> <span data-ttu-id="70ecb-108">По завершении последовательности восстановления восстановленные файлы (если они правильны и согласуются с текущим состоянием базы данных) могут быть сразу использованы в режиме «в сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-108">After the restore sequence is completed, recovered files, if they are valid and consistent with the database, can be brought online directly.</span></span>  
  
 <span data-ttu-id="70ecb-109">Поэтапное восстановление может использоваться со всеми моделями восстановления, но более эффективно — в сочетании с моделью восстановления с неполным протоколированием или моделью полного восстановления, чем с простой моделью.</span><span class="sxs-lookup"><span data-stu-id="70ecb-109">Piecemeal restore works with all recovery models, but is more flexible for the full and bulk-logged models than for the simple model.</span></span>  
  
 <span data-ttu-id="70ecb-110">Каждое поэтапное восстановление начинается с начальной последовательности восстановления, называемой *последовательностью частичного восстановления*.</span><span class="sxs-lookup"><span data-stu-id="70ecb-110">Every piecemeal restore starts with an initial restore sequence called the *partial-restore sequence*.</span></span> <span data-ttu-id="70ecb-111">Последовательность частичного восстановления восстанавливает по меньшей мере первичную файловую группу и — в простой модели восстановления — файловые группы с режимом доступа «чтение и запись».</span><span class="sxs-lookup"><span data-stu-id="70ecb-111">Minimally, the partial-restore sequence restores and recovers the primary filegroup and, under the simple recovery model, all read/write filegroups.</span></span> <span data-ttu-id="70ecb-112">Во время последовательности частичного восстановления вся база данных переводится в режим «вне сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-112">During the piecemeal-restore sequence, the whole database must go offline.</span></span> <span data-ttu-id="70ecb-113">После этого этапа база данных переводится в режим «в сети», а все восстановленные файловые группы становятся доступны.</span><span class="sxs-lookup"><span data-stu-id="70ecb-113">Thereafter, the database is online and restored filegroups are available.</span></span> <span data-ttu-id="70ecb-114">Однако невосстановленные файловые группы будут оставаться вне сети и будут недоступны.</span><span class="sxs-lookup"><span data-stu-id="70ecb-114">However, any unrestored filegroups remain offline and are not accessible.</span></span> <span data-ttu-id="70ecb-115">Файловые группы можно восстановить и перевести в состояние вне сети позднее, с помощью восстановления файлов.</span><span class="sxs-lookup"><span data-stu-id="70ecb-115">Any offline filegroups, however, can be restored and brought online later by a file restore.</span></span>  
  
 <span data-ttu-id="70ecb-116">Вне зависимости от модели восстановления базы данных, последовательность частичного восстановления начинается с инструкции RESTORE DATABASE с параметром PARTIAL, которая восстанавливает полную резервную копию.</span><span class="sxs-lookup"><span data-stu-id="70ecb-116">Regardless of the recovery model that is used by the database, the partial-restore sequence starts with a RESTORE DATABASE statement that restores a full backup and specifies the PARTIAL option.</span></span> <span data-ttu-id="70ecb-117">Параметр PARTIAL запускает новое поэтапное восстановление, поэтому необходимо указать параметр PARTIAL только один раз в начальной инструкции последовательности частичного восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-117">The PARTIAL option always starts a new piecemeal restore; therefore, you must specify PARTIAL only one time in the initial statement of the partial-restore sequence.</span></span> <span data-ttu-id="70ecb-118">В конце последовательности частичного восстановления, когда база данных переводится в режим «в сети», оставшиеся файлы переводятся в состояние «ожидание восстановления», потому что их восстановление было отложено.</span><span class="sxs-lookup"><span data-stu-id="70ecb-118">When the partial restore sequence finishes and the database is brought online, the state of the remaining files becomes "recovery pending" because their recovery has been postponed.</span></span>  
  
 <span data-ttu-id="70ecb-119">Впоследствии поэтапное восстановление обычно состоит из одной или нескольких последовательностей восстановления, которые называются *последовательностями восстановления файловых групп*.</span><span class="sxs-lookup"><span data-stu-id="70ecb-119">Subsequently, a piecemeal restore typically includes one or more restore sequences, which are called *filegroup-restore sequences*.</span></span> <span data-ttu-id="70ecb-120">Можно отложить выполнение последовательности восстановления файловых групп на любой период.</span><span class="sxs-lookup"><span data-stu-id="70ecb-120">You can wait to perform a specific filegroup-restore sequence for as long as you want.</span></span> <span data-ttu-id="70ecb-121">Каждая последовательность восстановления файловых групп восстанавливает одну или более файловых групп к точке, согласованной с базой данных.</span><span class="sxs-lookup"><span data-stu-id="70ecb-121">Each filegroup-restore sequence restores and recovers one or more offline filegroups to a point consistent with the database.</span></span> <span data-ttu-id="70ecb-122">Число и время следующих друг за другом последовательностей восстановления групп файлов зависит от цели восстановления, количества восстанавливаемых групп файлов в режиме «вне сети» и того, сколько групп файлов восстанавливается в одной последовательности восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-122">The timing and number of filegroup-restore sequences depends on your recovery goal, the number of offline filegroups you want to restore, and on how many of them you restore per filegroup-restore sequence.</span></span>  
  
 <span data-ttu-id="70ecb-123">Точные требования к выполнению поэтапного восстановления зависят от модели восстановления базы данных.</span><span class="sxs-lookup"><span data-stu-id="70ecb-123">The exact requirements for performing a piecemeal restore depend on the recovery model of the database.</span></span> <span data-ttu-id="70ecb-124">Дополнительные сведения см. в разделе «Восстановление по простой модели восстановления» и «Поэтапное восстановление по модели полного восстановления» ниже.</span><span class="sxs-lookup"><span data-stu-id="70ecb-124">For more information, see "Piecemeal Restore Under the Simple Recovery Model" and "Piecemeal Restore Under the Full Recovery Model," later in this topic.</span></span>  
  
## <a name="piecemeal-restore-scenarios"></a><span data-ttu-id="70ecb-125">Сценарии поэтапного восстановления</span><span class="sxs-lookup"><span data-stu-id="70ecb-125">Piecemeal Restore Scenarios</span></span>  
 <span data-ttu-id="70ecb-126">Все выпуски [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] поддерживают поэтапное восстановление вне сети.</span><span class="sxs-lookup"><span data-stu-id="70ecb-126">All editions of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] support offline piecemeal restores.</span></span> <span data-ttu-id="70ecb-127">В выпуске Enterprise Edition поэтапное восстановление можно выполнять по сети или автономно.</span><span class="sxs-lookup"><span data-stu-id="70ecb-127">In the Enterprise edition, a piecemeal restore can be either online or offline.</span></span> <span data-ttu-id="70ecb-128">Следствия поэтапных восстановлений как в сети, так и вне сети, описаны ниже.</span><span class="sxs-lookup"><span data-stu-id="70ecb-128">The implications of offline and online piecemeal restores are as follows:</span></span>  
  
-   <span data-ttu-id="70ecb-129">Сценарий поэтапного восстановления в режиме «вне сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-129">Offline piecemeal restore scenario</span></span>  
  
     <span data-ttu-id="70ecb-130">В последовательности поэтапного восстановления вне сети база данных находится в режиме «в сети» после завершения последовательности частичного восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-130">In an offline piecemeal restore, the database is online after the partial-restore sequence.</span></span> <span data-ttu-id="70ecb-131">Еще не восстановленные файловые группы остаются в режиме «вне сети», но по необходимости они могут быть восстановлены после перевода базы данных в этот режим.</span><span class="sxs-lookup"><span data-stu-id="70ecb-131">Filegroups that have not yet been restored remain offline, but they can be restored as you need them after taking the database offline.</span></span>  
  
-   <span data-ttu-id="70ecb-132">Сценарий поэтапного восстановления в режиме «в сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-132">Online piecemeal restore scenario</span></span>  
  
     <span data-ttu-id="70ecb-133">Во время поэтапного восстановления в сети после завершения последовательности частичного восстановления база данных переводится в режим «в сети», и первичная файловая группа и все восстановленные вторичные группы становятся доступны.</span><span class="sxs-lookup"><span data-stu-id="70ecb-133">In an online piecemeal restore, after the partial-restore sequence, the database is online, and the primary filegroup and any recovered secondary filegroups are available.</span></span> <span data-ttu-id="70ecb-134">Еще не восстановленные файловые группы остаются в режиме «вне сети», но по необходимости они могут быть восстановлены, при этом база данных останется в режиме «в сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-134">Filegroups that have not yet been restored remain offline, but they can be restored as needed while the database remains online.</span></span>  
  
     <span data-ttu-id="70ecb-135">Поэтапное восстановление в сети может включать в себя отложенные транзакции.</span><span class="sxs-lookup"><span data-stu-id="70ecb-135">Online piecemeal restores can involve deferred transactions.</span></span> <span data-ttu-id="70ecb-136">Если в сценарии поэтапного восстановления происходит восстановление только подмножества файловых групп, то транзакции в базе данных, которые зависят от групп файлов в режиме «в сети», откладываются.</span><span class="sxs-lookup"><span data-stu-id="70ecb-136">When only a subset of filegroups has been restored, transactions in the database that depend on online filegroups might become deferred.</span></span> <span data-ttu-id="70ecb-137">Это нормально, так как база данных должна быть полностью согласованной.</span><span class="sxs-lookup"><span data-stu-id="70ecb-137">This is typical, because the whole database must be consistent.</span></span> <span data-ttu-id="70ecb-138">Дополнительные сведения см. в разделе [Отложенные транзакции (SQL Server)](deferred-transactions-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="70ecb-138">For more information, see [Deferred Transactions &#40;SQL Server&#41;](deferred-transactions-sql-server.md).</span></span>  
  
-   [!INCLUDE[hek_1](../../includes/hek-1-md.md)] <span data-ttu-id="70ecb-139">сценарий поэтапного восстановления</span><span class="sxs-lookup"><span data-stu-id="70ecb-139">piecemeal restore scenario</span></span>  
  
     <span data-ttu-id="70ecb-140">Сведения о поэтапном восстановлении баз данных выполняющейся в памяти OLTP см. в разделе [Поэтапное резервное копирование и восстановление баз данных с таблицами, оптимизированными для памяти](../in-memory-oltp/memory-optimized-tables.md).</span><span class="sxs-lookup"><span data-stu-id="70ecb-140">For information on Piecemeal Restores of In-Memory OLTP databases see [Piecemeal Backup and Restore of Databases With Memory-Optimized Tables](../in-memory-oltp/memory-optimized-tables.md).</span></span>  
  
## <a name="restrictions"></a><span data-ttu-id="70ecb-141">Ограничения</span><span class="sxs-lookup"><span data-stu-id="70ecb-141">Restrictions</span></span>  
 <span data-ttu-id="70ecb-142">Если последовательность частичного восстановления исключает любые файловые группы [FILESTREAM](../blob/filestream-sql-server.md) , восстановление на момент времени не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="70ecb-142">If a partial restore sequence excludes any [FILESTREAM](../blob/filestream-sql-server.md) filegroup, point-in-time restore is not supported.</span></span> <span data-ttu-id="70ecb-143">Можно принудительно продолжить последовательность восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-143">You can force the restore sequence to continue.</span></span> <span data-ttu-id="70ecb-144">Тем не менее файловые группы FILESTREAM, не вошедшие в инструкцию RESTORE, больше невозможно восстановить.</span><span class="sxs-lookup"><span data-stu-id="70ecb-144">However the FILESTREAM filegroups that are omitted from your RESTORE statement can never be restored.</span></span> <span data-ttu-id="70ecb-145">Для принудительного продолжения восстановления на момент времени укажите параметр CONTINUE_AFTER_ERROR вместе с параметром STOPAT, STOPATMARK или STOPBEFOREMARK, который также необходимо указать в своих последующих инструкциях RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="70ecb-145">To force a point-in-time restore, specify the CONTINUE_AFTER_ERROR option together with the STOPAT, STOPATMARK, or STOPBEFOREMARK option, which you must also specify in your subsequent RESTORE LOG statements.</span></span> <span data-ttu-id="70ecb-146">Если указать параметр CONTINUE_AFTER_ERROR, выполняется последовательность частичного восстановления, а файловая группа FILESTREAM становится невосстановимой.</span><span class="sxs-lookup"><span data-stu-id="70ecb-146">If you specify CONTINUE_AFTER_ERROR, the partial restore sequence succeeds and the FILESTREAM filegroup becomes unrecoverable.</span></span>  
  
## <a name="piecemeal-restore-under-the-simple-recovery-model"></a><span data-ttu-id="70ecb-147">Поэтапное восстановление по простой модели восстановления</span><span class="sxs-lookup"><span data-stu-id="70ecb-147">Piecemeal Restore Under the Simple Recovery Model</span></span>  
 <span data-ttu-id="70ecb-148">В простой модели восстановления последовательность поэтапного восстановления должна начинаться с полного или частичного резервного копирования базы данных.</span><span class="sxs-lookup"><span data-stu-id="70ecb-148">Under the simple recovery model, the piecemeal restore sequence must start with a full database or partial backup.</span></span> <span data-ttu-id="70ecb-149">Потом, если восстанавливаемая резервная копия является базовой копией для разностного копирования, восстановите последнюю разностную резервную копию.</span><span class="sxs-lookup"><span data-stu-id="70ecb-149">Then, if the restored backup is a differential base, restore the latest differential backup next.</span></span>  
  
 <span data-ttu-id="70ecb-150">Если во время выполнения первой последовательности частичного восстановления восстанавливается только подмножество файловых групп с разрешениями на чтение и запись, все невосстановленные файловые группы пропадают при восстановлении частично восстановленной базы данных.</span><span class="sxs-lookup"><span data-stu-id="70ecb-150">During the first partial restore sequence, if you restore only a subset of read/write filegroups, any unrestored filegroups become defunct when you recover the partially restored database.</span></span> <span data-ttu-id="70ecb-151">Устранение из частичного восстановления файловых групп, доступных для чтения и записи, применимо только в следующих случаях.</span><span class="sxs-lookup"><span data-stu-id="70ecb-151">Omitting a read/write filegroup from the partial-restore sequence is appropriate only in the following cases:</span></span>  
  
-   <span data-ttu-id="70ecb-152">Планируется, что невосстановленные файловые группы должны стать нефункционирующими.</span><span class="sxs-lookup"><span data-stu-id="70ecb-152">You intend for the unrestored filegroups to become defunct.</span></span>  
  
-   <span data-ttu-id="70ecb-153">В точке восстановления, которую достигнет последовательность восстановления, все невосстановленные файловые группы стали доступны только для чтения, удалены или оказались нефункционирующими (во время предыдущего восстановления в последовательности частичного восстановления).</span><span class="sxs-lookup"><span data-stu-id="70ecb-153">The restore sequence will arrive at a recovery point at which each unrestored filegroup has become read-only, dropped, or defunct (during a previous restore in the partial-restore sequence).</span></span>  
  
-   <span data-ttu-id="70ecb-154">Полная резервная копия была создана, когда база данных использовала простую модель восстановления, но в точке восстановления база данных использовала модель полного восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-154">The full backup was taken while the database was using the simple recovery model, but the recovery point is at a time when the database is using the full recovery model.</span></span> <span data-ttu-id="70ecb-155">Дополнительные сведения см. в разделе «Выполнение поэтапного восстановления базы данных, модель восстановления которой была переключена с простой на полную» ниже.</span><span class="sxs-lookup"><span data-stu-id="70ecb-155">For more information, see "Performing a Piecemeal Restore of a Database Whose Recovery Model Has Been Switched from Simple to Full," later in this topic.</span></span>  
  
### <a name="requirements-for-piecemeal-restore-under-the-simple-recovery-model"></a><span data-ttu-id="70ecb-156">Требования к поэтапному восстановлению по простой модели восстановления</span><span class="sxs-lookup"><span data-stu-id="70ecb-156">Requirements for Piecemeal Restore Under the Simple Recovery Model</span></span>  
 <span data-ttu-id="70ecb-157">В простой модели восстановления начальный этап восстанавливает по меньшей мере первичную файловую группу и все вторичные файловые группы с режимом доступа «чтение и запись».</span><span class="sxs-lookup"><span data-stu-id="70ecb-157">Under the simple recovery model, the initial stage restores and recovers the primary filegroup and all read/write secondary filegroups.</span></span> <span data-ttu-id="70ecb-158">По завершении начального этапа восстановленные файлы (если они правильны и согласуются с текущим состоянием базы данных) могут быть сразу использованы в режиме «в сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-158">After the initial stage is completed, recovered files, if they are valid and consistent with the database, can be brought online directly.</span></span>  
  
 <span data-ttu-id="70ecb-159">После этого файловые группы, доступные только для чтения, могут восстанавливаться за один или несколько дополнительных этапов.</span><span class="sxs-lookup"><span data-stu-id="70ecb-159">Thereafter, read-only filegroups can be restored in one or more additional stages.</span></span>  
  
 <span data-ttu-id="70ecb-160">Поэтапное восстановление может осуществляться для вторичной файловой группы, доступной только для чтения, если по отношению к ней выполняются следующие условия.</span><span class="sxs-lookup"><span data-stu-id="70ecb-160">Piecemeal restore is available for a read-only secondary filegroup only if the following are true:</span></span>  
  
-   <span data-ttu-id="70ecb-161">Во время резервного копирования файловая группа была доступна только для чтения.</span><span class="sxs-lookup"><span data-stu-id="70ecb-161">Was read-only when backed up.</span></span>  
  
-   <span data-ttu-id="70ecb-162">Файловая группа осталась доступной только для чтения (логически согласована с первичной файловой группой).</span><span class="sxs-lookup"><span data-stu-id="70ecb-162">Has remained read-only (keeping it logically consistent with the primary filegroup).</span></span>  
  
 <span data-ttu-id="70ecb-163">Чтобы выполнить поэтапное восстановление, необходимо выполнить следующие рекомендации.</span><span class="sxs-lookup"><span data-stu-id="70ecb-163">To perform a piecemeal restore, the following guidelines must be followed:</span></span>  
  
-   <span data-ttu-id="70ecb-164">Полный набор резервных копий для поэтапного восстановления базы данных с простой моделью восстановления должен содержать следующее.</span><span class="sxs-lookup"><span data-stu-id="70ecb-164">A complete set of backups for the piecemeal restore of a simple recovery model database must contain the following:</span></span>  
  
    -   <span data-ttu-id="70ecb-165">Частичную или полную резервную копию базы данных, в которой содержатся первичная файловая группа и все файловые группы, доступные для чтения и записи во время резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="70ecb-165">A partial or full database backup that contains the primary filegroup and all filegroups that were read/write at the time of the backup.</span></span>  
  
    -   <span data-ttu-id="70ecb-166">Резервную копию каждого файла, доступного только для чтения.</span><span class="sxs-lookup"><span data-stu-id="70ecb-166">A backup of each read-only file.</span></span>  
  
-   <span data-ttu-id="70ecb-167">Чтобы резервная копия файла, доступного только для чтения, была согласована с первичной файловой группой, вторичная файловая группа должна была быть доступной только для чтения с момента резервного копирования до завершения процедуры резервного копирования, содержащей первичную файловую группу.</span><span class="sxs-lookup"><span data-stu-id="70ecb-167">For the backup of a read-only file to be consistent with the primary filegroup, the secondary filegroup must have been read-only from when it was backed up until the backup that contains the primary filegroup was completed.</span></span> <span data-ttu-id="70ecb-168">Можно применять разностные резервные копии файлов, если они были получены после того, как файловая группа стала доступной только для чтения.</span><span class="sxs-lookup"><span data-stu-id="70ecb-168">You can use differential file backups, if they were taken after the filegroup became read-only.</span></span>  
  
### <a name="piecemeal-restore-stages-simple-recovery-model"></a><span data-ttu-id="70ecb-169">Этапы поэтапного восстановления (простая модель восстановления)</span><span class="sxs-lookup"><span data-stu-id="70ecb-169">Piecemeal Restore Stages (Simple Recovery Model)</span></span>  
 <span data-ttu-id="70ecb-170">Сценарий поэтапного восстановления состоит из двух этапов.</span><span class="sxs-lookup"><span data-stu-id="70ecb-170">The piecemeal restore scenario involves the following stages:</span></span>  
  
-   <span data-ttu-id="70ecb-171">Начальный этап (восстановление первичной файловой группы и всех файловых групп, доступных для чтения и записи).</span><span class="sxs-lookup"><span data-stu-id="70ecb-171">Initial stage (restore and recover the primary filegroup and all read/write filegroups)</span></span>  
  
     <span data-ttu-id="70ecb-172">На начальном этапе выполняется частичное восстановление.</span><span class="sxs-lookup"><span data-stu-id="70ecb-172">The initial stage performs a partial restore.</span></span> <span data-ttu-id="70ecb-173">Последовательность частичного восстановления восстанавливает первичную файловую группу, все вторичные файловые группы, доступные для чтения и записи, и (дополнительно) некоторые файловые группы, доступные только для чтения.</span><span class="sxs-lookup"><span data-stu-id="70ecb-173">The partial restore sequence restores the primary filegroup, all read/write secondary filegroups, and (optionally) some of the read-only filegroups.</span></span> <span data-ttu-id="70ecb-174">Во время начального этапа вся база данных переводится в режим «вне сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-174">During the initial stage, the whole database must go offline.</span></span> <span data-ttu-id="70ecb-175">После завершения начального этапа база данных переводится в режим «в сети» и восстановленные файловые группы доступны.</span><span class="sxs-lookup"><span data-stu-id="70ecb-175">After the initial stage, the database is online, and restored filegroups are available.</span></span> <span data-ttu-id="70ecb-176">Однако все невосстановленные файловые группы, доступные только для чтения, остаются в режиме «вне сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-176">However, any read-only filegroups that have not yet been restored, remain offline.</span></span>  
  
     <span data-ttu-id="70ecb-177">Первая инструкция RESTORE начального этапа должна делать следующее.</span><span class="sxs-lookup"><span data-stu-id="70ecb-177">The first RESTORE statement in the initial stage must do the following:</span></span>  
  
    -   <span data-ttu-id="70ecb-178">Использовать частичную или полную резервную копию, в которой содержатся первичная файловая группа и все файловые группы, доступные для чтения и записи во время резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="70ecb-178">Use a partial or full database backup that contains the primary filegroup and all filegroups that were read/write at the time of the backup.</span></span> <span data-ttu-id="70ecb-179">Часто последовательность частичного восстановления начинают с восстановления из частичной резервной копии.</span><span class="sxs-lookup"><span data-stu-id="70ecb-179">It is common to start a partial restore sequence by restoring a partial backup.</span></span>  
  
    -   <span data-ttu-id="70ecb-180">Задавать параметр PARTIAL, который указывает на начало поэтапного восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-180">Specify the PARTIAL option, which indicates the start of a piecemeal restore.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="70ecb-181">Параметр PARTIAL выполняет проверку безопасности на предмет возможности использования восстановленной базы данных в качестве рабочей.</span><span class="sxs-lookup"><span data-stu-id="70ecb-181">The PARTIAL option performs safety checks that ensure that the resulting database is suited for use as a production database.</span></span>  
  
    -   <span data-ttu-id="70ecb-182">Указывать параметр READ_WRITE_FILEGROUPS, если резервная копия является полной.</span><span class="sxs-lookup"><span data-stu-id="70ecb-182">Specify the READ_WRITE_FILEGROUPS option if the backup is a full database backup.</span></span>  
  
-   <span data-ttu-id="70ecb-183">Пока база данных находится в режиме «в сети», можно применить одно или несколько восстановлений файлов, чтобы восстановить файлы вне сети, доступные только для чтения, которые были доступны только для чтения во время резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="70ecb-183">While the database is online, you can use one or more online file restores to restore and recover offline read-only files that were read-only at the time of backup.</span></span> <span data-ttu-id="70ecb-184">Выбор времени восстановлений файлов в сети зависит от того, когда данные необходимо перевести в режим «в сети».</span><span class="sxs-lookup"><span data-stu-id="70ecb-184">The timing of the online file restores depends on when you want to have the data online.</span></span>  
  
     <span data-ttu-id="70ecb-185">Нужно ли восстанавливать данные в файл? Это зависит от следующих соображений:</span><span class="sxs-lookup"><span data-stu-id="70ecb-185">Whether you must restore data to a file depends on the following:</span></span>  
  
    -   <span data-ttu-id="70ecb-186">Правильные файлы, доступные только для чтения, согласованные с базой данных, могут быть использованы в режиме «в сети» сразу после восстановления файлов без восстановления каких-либо данных с резервных копий.</span><span class="sxs-lookup"><span data-stu-id="70ecb-186">Valid read-only files that are consistent with the database can be brought online directly by recovering them without restoring any data.</span></span>  
  
    -   <span data-ttu-id="70ecb-187">Поврежденные и несогласованные с базой данных файлы восстанавливаются с резервной копии перед восстановлением данных по журналу транзакций.</span><span class="sxs-lookup"><span data-stu-id="70ecb-187">Files that are damaged or inconsistent with the database must be restored before they are recovered.</span></span>  
  
### <a name="examples"></a><span data-ttu-id="70ecb-188">Примеры</span><span class="sxs-lookup"><span data-stu-id="70ecb-188">Examples</span></span>  
  
-   [<span data-ttu-id="70ecb-189">Пример. Поэтапное восстановление базы данных &#40;простая модель восстановления&#41;</span><span class="sxs-lookup"><span data-stu-id="70ecb-189">Example: Piecemeal Restore of Database &#40;Simple Recovery Model&#41;</span></span>](example-piecemeal-restore-of-database-simple-recovery-model.md)  
  
-   [<span data-ttu-id="70ecb-190">Пример. Поэтапное восстановление отдельных файловых групп &#40;простая модель восстановления&#41;</span><span class="sxs-lookup"><span data-stu-id="70ecb-190">Example: Piecemeal Restore of Only Some Filegroups &#40;Simple Recovery Model&#41;</span></span>](example-piecemeal-restore-of-only-some-filegroups-simple-recovery-model.md)  
  
## <a name="piecemeal-restore-under-the-full-recovery-model"></a><span data-ttu-id="70ecb-191">Поэтапное восстановление по модели полного восстановления</span><span class="sxs-lookup"><span data-stu-id="70ecb-191">Piecemeal Restore Under the Full Recovery Model</span></span>  
 <span data-ttu-id="70ecb-192">В модели полного восстановления или восстановления с неполным протоколированием поэтапное восстановление доступно для всех баз данных, содержащих по несколько файловых групп, и базу данных можно восстановить до любого момента времени.</span><span class="sxs-lookup"><span data-stu-id="70ecb-192">Under the full recovery model or bulk-logged recovery model, piecemeal restore is available for any database that contains multiple filegroups and you can restore a database to any point in time.</span></span> <span data-ttu-id="70ecb-193">Последовательности восстановления поэтапного восстановления ведут себя следующим образом.</span><span class="sxs-lookup"><span data-stu-id="70ecb-193">The restore sequences of a piecemeal restore behave as follows:</span></span>  
  
-   <span data-ttu-id="70ecb-194">последовательностью частичного восстановления</span><span class="sxs-lookup"><span data-stu-id="70ecb-194">Partial-restore sequence</span></span>  
  
     <span data-ttu-id="70ecb-195">Последовательность частичного восстановления восстанавливает первичную файловую группу и, возможно, некоторые из вторичных групп.</span><span class="sxs-lookup"><span data-stu-id="70ecb-195">The partial restore sequence restores the primary filegroup and, optionally, some of the secondary filegroups.</span></span>  
  
     <span data-ttu-id="70ecb-196">Первая инструкция RESTORE RESTORE DATABASE начального этапа должна делать следующее.</span><span class="sxs-lookup"><span data-stu-id="70ecb-196">The first RESTORE DATABASE statement must do the following:</span></span>  
  
    -   <span data-ttu-id="70ecb-197">Задавать параметр PARTIAL.</span><span class="sxs-lookup"><span data-stu-id="70ecb-197">Specify the PARTIAL option.</span></span> <span data-ttu-id="70ecb-198">Он указывает на начало поэтапного восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-198">This indicates the start of a piecemeal restore.</span></span>  
  
    -   <span data-ttu-id="70ecb-199">Использовать любую полную резервную копию, содержащую первичную файловую группу.</span><span class="sxs-lookup"><span data-stu-id="70ecb-199">Use any full database backup that contains the primary filegroup.</span></span> <span data-ttu-id="70ecb-200">Часто последовательность частичного восстановления начинают с восстановления из частичной резервной копии.</span><span class="sxs-lookup"><span data-stu-id="70ecb-200">The common practice is to start a partial restore sequence by restoring a partial backup.</span></span>  
  
    -   <span data-ttu-id="70ecb-201">Чтобы выполнить восстановление на момент времени, необходимо задать время в последовательности частичного восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-201">To restore to a specific point in time, you must specify the time in the partial restore sequence.</span></span> <span data-ttu-id="70ecb-202">Каждый последующий этап последовательности восстановления должен задавать тот же самый момент времени.</span><span class="sxs-lookup"><span data-stu-id="70ecb-202">Every successive step of the restore sequence must specify the same point in time.</span></span>  
  
-   <span data-ttu-id="70ecb-203">Последовательности восстановления групп файлов переводят дополнительные группы файлов в режиме «в сети» до достижения согласованности с базой данных.</span><span class="sxs-lookup"><span data-stu-id="70ecb-203">Filegroup-restore sequences bring additional filegroups online to a point consistent with the database.</span></span>  
  
     <span data-ttu-id="70ecb-204">В выпуске Enterprise Edition любая автономная вторичная файловая группа может быть восстановлена, пока база данных остается в сети.</span><span class="sxs-lookup"><span data-stu-id="70ecb-204">In the Enterprise edition, any offline secondary filegroup can be restored and recovered while the database remains online.</span></span> <span data-ttu-id="70ecb-205">Если данный доступный только для чтения файл не поврежден и согласуется с текущим состоянием базы данных, его восстанавливать не нужно.</span><span class="sxs-lookup"><span data-stu-id="70ecb-205">If a specific read-only file is undamaged and consistent with the database, the file does not have to be restored.</span></span> <span data-ttu-id="70ecb-206">Дополнительные сведения см. в разделе [Восстановление базы данных без восстановления данных (Transact-SQL)](recover-a-database-without-restoring-data-transact-sql.md).</span><span class="sxs-lookup"><span data-stu-id="70ecb-206">For more information, see [Recover a Database Without Restoring Data &#40;Transact-SQL&#41;](recover-a-database-without-restoring-data-transact-sql.md).</span></span>  
  
### <a name="applying-log-backups"></a><span data-ttu-id="70ecb-207">Применение резервных копий журнала</span><span class="sxs-lookup"><span data-stu-id="70ecb-207">Applying Log Backups</span></span>  
 <span data-ttu-id="70ecb-208">Если файловая группа доступна только для чтения с момента, предшествующего созданию резервной копии файловых групп, использование резервных копий журналов не нужно, и эта группа пропускается при восстановлении файлов.</span><span class="sxs-lookup"><span data-stu-id="70ecb-208">If a read-only filegroup has been read-only since before the file backup was created, applying log backups to the filegroup is unnecessary and is skipped by file restore.</span></span> <span data-ttu-id="70ecb-209">Если файловая группа доступна для чтения и для записи, то с целью перевода файловой группы в состояние, соответствующее текущему файлу журнала, необходимо применить непрерывную последовательность резервных копий журнала к последнему экземпляру, полученному в результате полного или разностного восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-209">If the filegroup is read/write, an unbroken chain of log backups must be applied to the last full or differential restore to bring the filegroup forward to the current log file.</span></span>  
  
### <a name="examples"></a><span data-ttu-id="70ecb-210">Примеры</span><span class="sxs-lookup"><span data-stu-id="70ecb-210">Examples</span></span>  
  
-   [<span data-ttu-id="70ecb-211">Пример. Поэтапное восстановление базы данных &#40;модель полного восстановления&#41;</span><span class="sxs-lookup"><span data-stu-id="70ecb-211">Example: Piecemeal Restore of Database &#40;Full Recovery Model&#41;</span></span>](example-piecemeal-restore-of-database-full-recovery-model.md)  
  
-   [<span data-ttu-id="70ecb-212">Пример. Поэтапное восстановление только некоторых файловых групп &#40;модель полного восстановления&#41;</span><span class="sxs-lookup"><span data-stu-id="70ecb-212">Example: Piecemeal Restore of Only Some Filegroups &#40;Full Recovery Model&#41;</span></span>](example-piecemeal-restore-of-only-some-filegroups-full-recovery-model.md)  
  
## <a name="performing-a-piecemeal-restore-of-a-database-whose-recovery-model-has-been-switched-from-simple-to-full"></a><span data-ttu-id="70ecb-213">Выполнение поэтапного восстановления базы данных, модель восстановления которой была переключена с простой на полную</span><span class="sxs-lookup"><span data-stu-id="70ecb-213">Performing a Piecemeal Restore of a Database Whose Recovery Model Has Been Switched from Simple to Full</span></span>  
 <span data-ttu-id="70ecb-214">Можно выполнить поэтапное восстановление базы данных, модель восстановления которой была переключена с простой на полную с момента полного частичного резервного копирования или резервного копирования базы данных.</span><span class="sxs-lookup"><span data-stu-id="70ecb-214">You can perform a piecemeal restore of a database that has been switched from the simple recovery model to the full recovery model since the full partial or database backup.</span></span> <span data-ttu-id="70ecb-215">Например, рассмотрим базу данных, для которой можно выполнить следующее:</span><span class="sxs-lookup"><span data-stu-id="70ecb-215">For example, consider a database for which you take the following steps:</span></span>  
  
1.  <span data-ttu-id="70ecb-216">создать частичную резервную копию (backup_1);</span><span class="sxs-lookup"><span data-stu-id="70ecb-216">Create a partial backup (backup_1) of a simple-model database.</span></span>  
  
2.  <span data-ttu-id="70ecb-217">через некоторый период времени изменить модель восстановления на полную;</span><span class="sxs-lookup"><span data-stu-id="70ecb-217">After some time, change the recovery model to full.</span></span>  
  
3.  <span data-ttu-id="70ecb-218">создать разностную резервную копию;</span><span class="sxs-lookup"><span data-stu-id="70ecb-218">Create a differential backup.</span></span>  
  
4.  <span data-ttu-id="70ecb-219">начать создание резервных копий журналов.</span><span class="sxs-lookup"><span data-stu-id="70ecb-219">Start taking log backups.</span></span>  
  
 <span data-ttu-id="70ecb-220">Следовательно, верна следующая последовательность:</span><span class="sxs-lookup"><span data-stu-id="70ecb-220">Thereafter, the following sequence is valid:</span></span>  
  
1.  <span data-ttu-id="70ecb-221">частичное восстановление, в котором пропущены некоторые вторичные файловые группы;</span><span class="sxs-lookup"><span data-stu-id="70ecb-221">A partial restore that omits some secondary filegroups.</span></span>  
  
2.  <span data-ttu-id="70ecb-222">разностное восстановление, за которым следуют другие необходимые восстановления;</span><span class="sxs-lookup"><span data-stu-id="70ecb-222">A differential restore followed by any other needed restores.</span></span>  
  
3.  <span data-ttu-id="70ecb-223">последующее восстановление файлов из доступных для чтения и записи вторичных файловых групп из частичной резервной копии backup_1 с параметром WITH NORECOVERY;</span><span class="sxs-lookup"><span data-stu-id="70ecb-223">Later, a file restore of a read/write secondary filegroup WITH NORECOVERY from the backup_1 partial backup</span></span>  
  
4.  <span data-ttu-id="70ecb-224">разностные резервные копии, следующие за любыми другими резервными копиями, восстановленными в исходной последовательности поэтапного восстановления, чтобы восстановить данные до первоначальной точки восстановления.</span><span class="sxs-lookup"><span data-stu-id="70ecb-224">The differential backup followed by any other backups that were restored in the original piecemeal restore sequence to restore the data up to the original recovery point.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="70ecb-225">См. также:</span><span class="sxs-lookup"><span data-stu-id="70ecb-225">See Also</span></span>  
 <span data-ttu-id="70ecb-226">[Применение резервных копий журналов транзакций (SQL Server)](transaction-log-backups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="70ecb-226">[Apply Transaction Log Backups &#40;SQL Server&#41;](transaction-log-backups-sql-server.md) </span></span>  
 <span data-ttu-id="70ecb-227">[RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="70ecb-227">[RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql) </span></span>  
 <span data-ttu-id="70ecb-228">[Восстановление базы данных SQL Server до определенного момента времени (модель полного восстановления)](restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="70ecb-228">[Restore a SQL Server Database to a Point in Time &#40;Full Recovery Model&#41;](restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md) </span></span>  
 <span data-ttu-id="70ecb-229">[Обзор процессов восстановления (SQL Server)](restore-and-recovery-overview-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="70ecb-229">[Restore and Recovery Overview &#40;SQL Server&#41;](restore-and-recovery-overview-sql-server.md) </span></span>  
 [<span data-ttu-id="70ecb-230">Планирование и выполнение последовательностей восстановления (модель полного восстановления)</span><span class="sxs-lookup"><span data-stu-id="70ecb-230">Plan and Perform Restore Sequences &#40;Full Recovery Model&#41;</span></span>](plan-and-perform-restore-sequences-full-recovery-model.md)  
  
  
