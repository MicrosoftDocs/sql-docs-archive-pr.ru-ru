---
title: Отложенные транзакции (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- I/O [SQL Server], database recovery
- restoring pages [SQL Server]
- deferred transactions
- modifying transaction deferred state
ms.assetid: 6fc0f9b6-d3ea-4971-9f27-d0195d1ff718
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 188a0409fbad3f12283adacafbfcb5f176650b72
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658853"
---
# <a name="deferred-transactions-sql-server"></a><span data-ttu-id="38119-102">Отложенные транзакции (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="38119-102">Deferred Transactions (SQL Server)</span></span>
  <span data-ttu-id="38119-103">В [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise поврежденная транзакция может быть отложена, если данные, которые требуются для отката (отмены), находятся в режиме "вне сети" во время запуска базы данных.</span><span class="sxs-lookup"><span data-stu-id="38119-103">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise, a corrupted transaction can become deferred if data required by rollback (undo) is offline during database startup.</span></span> <span data-ttu-id="38119-104">*Отложенная транзакция* представляет собой транзакцию, которая не фиксируется по завершении стадии наката и которая вызывает ошибку, препятствующую ее откату.</span><span class="sxs-lookup"><span data-stu-id="38119-104">A *deferred transaction* is a transaction that is uncommitted when the roll forward phase finishes and that has encountered an error that prevents it from being rolled back.</span></span> <span data-ttu-id="38119-105">Поскольку нельзя выполнить откат этой транзакции, она откладывается.</span><span class="sxs-lookup"><span data-stu-id="38119-105">Because the transaction cannot be rolled back, it is deferred.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="38119-106">Поврежденные транзакции откладываются только в выпуске [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span><span class="sxs-lookup"><span data-stu-id="38119-106">Corrupted transactions are deferred only in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span></span> <span data-ttu-id="38119-107">В других выпусках [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]поврежденная транзакция вызывает сбой запуска.</span><span class="sxs-lookup"><span data-stu-id="38119-107">In other editions of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], a corrupted transaction causes startup to fail.</span></span>  
  
 <span data-ttu-id="38119-108">Обычно отложенная транзакция встречается, когда во время наката в базе данных происходит ошибка ввода-вывода, которая не позволяет считать нужную для транзакции страницу.</span><span class="sxs-lookup"><span data-stu-id="38119-108">Generally, a deferred transaction occurs because, while the database was being rolled forward, an I/O error prevented reading a page that was required by the transaction.</span></span> <span data-ttu-id="38119-109">Еще одной причиной возникновения отложенных транзакций может стать ошибка на файловом уровне.</span><span class="sxs-lookup"><span data-stu-id="38119-109">However, an error at the file level can also cause deferred transactions.</span></span> <span data-ttu-id="38119-110">Отложенная транзакция может возникнуть,если последовательность частичного восстановления останавливается из-за необходимости отката, а требуемые для этого данные находятся в режиме «вне сети».</span><span class="sxs-lookup"><span data-stu-id="38119-110">A deferred transaction can also occur when a partial restore sequence stops at a point at which transaction rollback is necessary and a transaction requires data that is offline.</span></span>  
  
 <span data-ttu-id="38119-111">Пользовательские транзакции, для которых выполняется откат и в которых возникает ошибка ввода-вывода, вызывают переключение всей базы данных в режим «вне сети».</span><span class="sxs-lookup"><span data-stu-id="38119-111">User transactions that are rolling back and hit an I/O error cause the whole database to go offline.</span></span> <span data-ttu-id="38119-112">При повторном переводе базы данных в режим «в сети» повтор заново запрашивает все имевшиеся ранее блокировки и производит попытку произвести откат всех незавершенных транзакций.</span><span class="sxs-lookup"><span data-stu-id="38119-112">When the database is brought back online, the redo reacquires all the locks it had and tries to roll back all the uncommitted transactions.</span></span> <span data-ttu-id="38119-113">Все измененные транзакцией данные остаются соответствующим образом заблокированными до тех пор, пока не завершится откат транзакции.</span><span class="sxs-lookup"><span data-stu-id="38119-113">All data modified by a transaction remains appropriately locked until the transaction can roll back.</span></span> <span data-ttu-id="38119-114">Транзакции, для которых невозможно выполнить откат, снимают блокировки после устранения повреждения и перезапуска базы данных либо после восстановления «в сети», когда отложенные транзакции разрешаются в режиме «в сети» базы данных.</span><span class="sxs-lookup"><span data-stu-id="38119-114">Transactions that cannot be rolled back will give up their locks when the corruption is fixed and the database restarted or, after an online restore, when the deferred transactions are resolved while the database remains online.</span></span> <span data-ttu-id="38119-115">До этого момента отложенная транзакция удерживает блокировки, предотвращающие определенные операции над базой данных в целом.</span><span class="sxs-lookup"><span data-stu-id="38119-115">Until that point, a deferred transaction can hold locks that prevent certain operations on the database as a whole.</span></span> <span data-ttu-id="38119-116">Например, если отложенная транзакция содержит инструкцию CREATE TABLE, ни один пользователь не сможет создать таблицу до тех пор, пока отложенная транзакция не будет разрешена.</span><span class="sxs-lookup"><span data-stu-id="38119-116">For example, if a deferred transaction contains a CREATE TABLE instruction, no user can create a table until the deferred transaction has been resolved.</span></span>  
  
 <span data-ttu-id="38119-117">Отложенные транзакции могут также возникать, когда поэтапное восстановление восстанавливает базу данных до точки, в которой одна или несколько активных транзакций затрагивают еще не восстановленную файловую группу, находящуюся в режиме «вне сети».</span><span class="sxs-lookup"><span data-stu-id="38119-117">Deferred transaction can also occur because a piecemeal restore recovers a database to a point at which one or more active transactions are affecting a filegroup that has not yet been restored and is offline.</span></span> <span data-ttu-id="38119-118">Поскольку нельзя выполнить откат этих транзакций, они откладываются.</span><span class="sxs-lookup"><span data-stu-id="38119-118">Because the transactions cannot be rolled back, they become deferred.</span></span>  
  
 <span data-ttu-id="38119-119">В следующей таблице перечисляются действия, ведущие к тому, что база данных начинает восстановление и формирование результата при возникновении проблемы с вводом-выводом.</span><span class="sxs-lookup"><span data-stu-id="38119-119">The following table lists the actions that cause a database to perform recovery and the outcome if an I/O problem occurs.</span></span>  
  
|<span data-ttu-id="38119-120">Действие</span><span class="sxs-lookup"><span data-stu-id="38119-120">Action</span></span>|<span data-ttu-id="38119-121">Разрешение (если возникает проблема ввода-вывода или нужные данные находятся в режиме «вне сети»)</span><span class="sxs-lookup"><span data-stu-id="38119-121">Resolution (if I/O problems occur or required data is offline)</span></span>|  
|------------|-----------------------------------------------------------------------|  
|<span data-ttu-id="38119-122">Запуск сервера</span><span class="sxs-lookup"><span data-stu-id="38119-122">Server start</span></span>|<span data-ttu-id="38119-123">Отложенная транзакция</span><span class="sxs-lookup"><span data-stu-id="38119-123">Deferred transaction</span></span>|  
|<span data-ttu-id="38119-124">Восстановить</span><span class="sxs-lookup"><span data-stu-id="38119-124">Restore</span></span>|<span data-ttu-id="38119-125">Отложенная транзакция</span><span class="sxs-lookup"><span data-stu-id="38119-125">Deferred transaction</span></span>|  
|<span data-ttu-id="38119-126">Attach</span><span class="sxs-lookup"><span data-stu-id="38119-126">Attach</span></span>|<span data-ttu-id="38119-127">Присоединение завершается с ошибкой</span><span class="sxs-lookup"><span data-stu-id="38119-127">Attach fails</span></span>|  
|<span data-ttu-id="38119-128">Автоматический перезапуск</span><span class="sxs-lookup"><span data-stu-id="38119-128">Autorestart</span></span>|<span data-ttu-id="38119-129">Отложенная транзакция</span><span class="sxs-lookup"><span data-stu-id="38119-129">Deferred transaction</span></span>|  
|<span data-ttu-id="38119-130">Создание базы данных или моментального снимка базы данных</span><span class="sxs-lookup"><span data-stu-id="38119-130">Create database or database snapshot</span></span>|<span data-ttu-id="38119-131">Создание завершается с ошибкой</span><span class="sxs-lookup"><span data-stu-id="38119-131">Creation fails</span></span>|  
|<span data-ttu-id="38119-132">Повтор при зеркальном отображении базы данных</span><span class="sxs-lookup"><span data-stu-id="38119-132">Redo on database mirroring</span></span>|<span data-ttu-id="38119-133">Отложенная транзакция</span><span class="sxs-lookup"><span data-stu-id="38119-133">Deferred transaction</span></span>|  
|<span data-ttu-id="38119-134">Файловая группа находится в режиме «вне сети»</span><span class="sxs-lookup"><span data-stu-id="38119-134">Filegroup is offline</span></span>|<span data-ttu-id="38119-135">Отложенная транзакция</span><span class="sxs-lookup"><span data-stu-id="38119-135">Deferred transaction</span></span>|  
  
## <a name="moving-a-transaction-out-of-the-deferred-state"></a><span data-ttu-id="38119-136">Вывод транзакции из состояния DEFERRED</span><span class="sxs-lookup"><span data-stu-id="38119-136">Moving a Transaction Out of the DEFERRED State</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="38119-137">Отложенная транзакция удерживает журнал транзакций активным.</span><span class="sxs-lookup"><span data-stu-id="38119-137">Deferred transactions keep the transaction log active.</span></span> <span data-ttu-id="38119-138">Файл виртуального журнала, содержащий все отложенные транзакции, нельзя усекать, пока эти транзакции не выйдут из отложенного состояния.</span><span class="sxs-lookup"><span data-stu-id="38119-138">A virtual log file that contains any deferred transactions cannot be truncated until those transactions are moved out of the deferred state.</span></span> <span data-ttu-id="38119-139">Дополнительные сведения об усечении журнала см. в разделе [Создание резервной копии журнала транзакций (SQL Server)](../logs/the-transaction-log-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="38119-139">For more information about log truncation, see [The Transaction Log &#40;SQL Server&#41;](../logs/the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="38119-140">Для вывода транзакции из отложенного состояния база данных должна запуститься без ошибок ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="38119-140">To move the transaction out of the deferred state, the database must start cleanly without any I/O errors.</span></span> <span data-ttu-id="38119-141">При наличии отложенных транзакций необходимо восстановить работу источника ошибок ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="38119-141">If deferred transactions exist, you must fix the source of the I/O errors.</span></span> <span data-ttu-id="38119-142">Ниже приводятся доступные решения, перечисленные в том порядке, в каком они обычно применяются.</span><span class="sxs-lookup"><span data-stu-id="38119-142">The available solutions, listed in the order in which they are typically tried, are as follows:</span></span>  
  
-   <span data-ttu-id="38119-143">Перезапуск базы данных.</span><span class="sxs-lookup"><span data-stu-id="38119-143">Restart the database.</span></span> <span data-ttu-id="38119-144">Если проблема временная, база данных должна запускаться без отложенных транзакций.</span><span class="sxs-lookup"><span data-stu-id="38119-144">If the problem was transient, the database should start without deferred transactions.</span></span>  
  
-   <span data-ttu-id="38119-145">Если транзакции были отложены из-за того, что файловая группа была в режиме «вне сети», вновь переведите файловую группу в режим «в сети».</span><span class="sxs-lookup"><span data-stu-id="38119-145">If the transactions were deferred because a filegroup was offline, bring the filegroup back online.</span></span>  
  
     <span data-ttu-id="38119-146">Для возвращения файловой группы из режима «вне сети» в режим «в сети» воспользуйтесь следующей инструкцией [!INCLUDE[tsql](../../includes/tsql-md.md)] :</span><span class="sxs-lookup"><span data-stu-id="38119-146">To bring an offline filegroup back online, use the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement:</span></span>  
  
    ```  
    RESTORE DATABASE database_name FILEGROUP=<filegroup_name>  
    ```  
  
-   <span data-ttu-id="38119-147">восстановить базу данных.</span><span class="sxs-lookup"><span data-stu-id="38119-147">Restore the database.</span></span> <span data-ttu-id="38119-148">После восстановления «в сети» разрешаются отложенные транзакции.</span><span class="sxs-lookup"><span data-stu-id="38119-148">After an online restore, any deferred transactions are resolved.</span></span>  
  
     <span data-ttu-id="38119-149">В полной модели восстановления или модели с неполным протоколированием восстановление страницы в режиме «в сети» может решить проблему (там, где это поддерживается), если причиной возникновения отложенных транзакций являются лишь несколько поврежденных страниц.</span><span class="sxs-lookup"><span data-stu-id="38119-149">Under the full or bulk-logged recovery model, if the deferred transactions were caused by only a few corrupted pages, an online page restore might resolve the errors (where supported).</span></span>  
  
-   <span data-ttu-id="38119-150">Если файловая группа, состояние «вне сети» которой является причиной отложенных транзакций, больше не требуется, отключите эту файловую группу.</span><span class="sxs-lookup"><span data-stu-id="38119-150">If you are no longer require a filegroup whose offline status is causing deferred transactions, make the offline filegroup defunct.</span></span> <span data-ttu-id="38119-151">Транзакции, отложенные из-за того, что файловая группа находилась в режиме «вне сети», выходят из отложенного состояния после того, как эта файловая группа перестанет функционировать.</span><span class="sxs-lookup"><span data-stu-id="38119-151">Transactions that were deferred because the filegroup was offline are moved out of the deferred state after the filegroup becomes defunct.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="38119-152">Восстановление уничтоженной файловой группы невозможно.</span><span class="sxs-lookup"><span data-stu-id="38119-152">A defunct filegroup can never be recovered.</span></span>  
  
     <span data-ttu-id="38119-153">Дополнительные сведения см. в статье [Удаление уничтоженных файловых групп (SQL Server)](remove-defunct-filegroups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="38119-153">For more information, see [Remove Defunct Filegroups &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md).</span></span>  
  
-   <span data-ttu-id="38119-154">Если транзакции отложены из-за повреждения страницы, а резервная копия базы данных отсутствует, для восстановления базы данных воспользуйтесь следующей процедурой.</span><span class="sxs-lookup"><span data-stu-id="38119-154">If transactions were deferred because of a bad page and if a good backup of the database does not exist, use the following process to repair the database:</span></span>  
  
    -   <span data-ttu-id="38119-155">Вначале переведите базу данных в аварийный режим, выполнив следующую инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)] :</span><span class="sxs-lookup"><span data-stu-id="38119-155">First put the database into emergency mode by executing the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement:</span></span>  
  
        ```  
        ALTER DATABASE <database_name> SET EMERGENCY  
        ```  
  
         <span data-ttu-id="38119-156">Сведения об аварийном режиме см. в разделе [Database States](../databases/database-states.md).</span><span class="sxs-lookup"><span data-stu-id="38119-156">For information about emergency mode, see [Database States](../databases/database-states.md).</span></span>  
  
    -   <span data-ttu-id="38119-157">Затем восстановите базу данных, используя параметр DBCC REPAIR_ALLOW_DATA_LOSS в одной из следующих инструкций DBCC: [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql), [DBCC CHECKALLOC](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql) или [DBCC CHECKTABLE](/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="38119-157">Then, repair the database by using the DBCC REPAIR_ALLOW_DATA_LOSS option in one of the following DBCC statements: [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql), [DBCC CHECKALLOC](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql), or [DBCC CHECKTABLE](/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql).</span></span>  
  
         <span data-ttu-id="38119-158">При возникновении страницы с поврежденными данными DBCC освобождает эту страницу и исправляет связанные с ней ошибки.</span><span class="sxs-lookup"><span data-stu-id="38119-158">When DBCC encounters the bad page, DBCC deallocates it and repairs any related errors.</span></span> <span data-ttu-id="38119-159">Такой подход дает возможность возвратить базу данных в режиме «в сети» в физически согласованное состояние.</span><span class="sxs-lookup"><span data-stu-id="38119-159">This approach enables the database to be brought back online in a physically consistent state.</span></span> <span data-ttu-id="38119-160">Но при этом могут быть также потеряны дополнительные данные, поэтому этот подход должен применяться только в исключительных случаях.</span><span class="sxs-lookup"><span data-stu-id="38119-160">However, additional data might also be lost; therefore, this approach should be used as a last resort.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="38119-161">См. также:</span><span class="sxs-lookup"><span data-stu-id="38119-161">See Also</span></span>  
 <span data-ttu-id="38119-162">[Обзор процессов восстановления (SQL Server)](restore-and-recovery-overview-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="38119-162">[Restore and Recovery Overview &#40;SQL Server&#41;](restore-and-recovery-overview-sql-server.md) </span></span>  
 <span data-ttu-id="38119-163">[Удаление уничтоженных файловых групп (SQL Server)](remove-defunct-filegroups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="38119-163">[Remove Defunct Filegroups &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md) </span></span>  
 <span data-ttu-id="38119-164">[Восстановления файлов (модель полного восстановления)](file-restores-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="38119-164">[File Restores &#40;Full Recovery Model&#41;](file-restores-full-recovery-model.md) </span></span>  
 <span data-ttu-id="38119-165">[Восстановление файлов (простая модель восстановления)](file-restores-simple-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="38119-165">[File Restores &#40;Simple Recovery Model&#41;](file-restores-simple-recovery-model.md) </span></span>  
 <span data-ttu-id="38119-166">[Восстановление страниц (SQL Server)](restore-pages-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="38119-166">[Restore Pages &#40;SQL Server&#41;](restore-pages-sql-server.md) </span></span>  
 <span data-ttu-id="38119-167">[Поэтапное восстановление (SQL Server)](piecemeal-restores-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="38119-167">[Piecemeal Restores &#40;SQL Server&#41;](piecemeal-restores-sql-server.md) </span></span>  
 <span data-ttu-id="38119-168">[ALTER DATABASE (Transact-SQL)](/sql/t-sql/statements/alter-database-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="38119-168">[ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql) </span></span>  
 [<span data-ttu-id="38119-169">RESTORE (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="38119-169">RESTORE &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/restore-statements-transact-sql)  
  
  
