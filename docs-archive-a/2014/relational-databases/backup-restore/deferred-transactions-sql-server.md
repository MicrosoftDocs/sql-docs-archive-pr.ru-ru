---
title: Отложенные транзакции (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- I/O [SQL Server], database recovery
- restoring pages [SQL Server]
- deferred transactions
- modifying transaction deferred state
ms.assetid: 6fc0f9b6-d3ea-4971-9f27-d0195d1ff718
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 188a0409fbad3f12283adacafbfcb5f176650b72
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658853"
---
# <a name="deferred-transactions-sql-server"></a>Отложенные транзакции (SQL Server)
  В [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise поврежденная транзакция может быть отложена, если данные, которые требуются для отката (отмены), находятся в режиме "вне сети" во время запуска базы данных. *Отложенная транзакция* представляет собой транзакцию, которая не фиксируется по завершении стадии наката и которая вызывает ошибку, препятствующую ее откату. Поскольку нельзя выполнить откат этой транзакции, она откладывается.  
  
> [!NOTE]  
>  Поврежденные транзакции откладываются только в выпуске [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise. В других выпусках [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]поврежденная транзакция вызывает сбой запуска.  
  
 Обычно отложенная транзакция встречается, когда во время наката в базе данных происходит ошибка ввода-вывода, которая не позволяет считать нужную для транзакции страницу. Еще одной причиной возникновения отложенных транзакций может стать ошибка на файловом уровне. Отложенная транзакция может возникнуть,если последовательность частичного восстановления останавливается из-за необходимости отката, а требуемые для этого данные находятся в режиме «вне сети».  
  
 Пользовательские транзакции, для которых выполняется откат и в которых возникает ошибка ввода-вывода, вызывают переключение всей базы данных в режим «вне сети». При повторном переводе базы данных в режим «в сети» повтор заново запрашивает все имевшиеся ранее блокировки и производит попытку произвести откат всех незавершенных транзакций. Все измененные транзакцией данные остаются соответствующим образом заблокированными до тех пор, пока не завершится откат транзакции. Транзакции, для которых невозможно выполнить откат, снимают блокировки после устранения повреждения и перезапуска базы данных либо после восстановления «в сети», когда отложенные транзакции разрешаются в режиме «в сети» базы данных. До этого момента отложенная транзакция удерживает блокировки, предотвращающие определенные операции над базой данных в целом. Например, если отложенная транзакция содержит инструкцию CREATE TABLE, ни один пользователь не сможет создать таблицу до тех пор, пока отложенная транзакция не будет разрешена.  
  
 Отложенные транзакции могут также возникать, когда поэтапное восстановление восстанавливает базу данных до точки, в которой одна или несколько активных транзакций затрагивают еще не восстановленную файловую группу, находящуюся в режиме «вне сети». Поскольку нельзя выполнить откат этих транзакций, они откладываются.  
  
 В следующей таблице перечисляются действия, ведущие к тому, что база данных начинает восстановление и формирование результата при возникновении проблемы с вводом-выводом.  
  
|Действие|Разрешение (если возникает проблема ввода-вывода или нужные данные находятся в режиме «вне сети»)|  
|------------|-----------------------------------------------------------------------|  
|Запуск сервера|Отложенная транзакция|  
|Восстановить|Отложенная транзакция|  
|Attach|Присоединение завершается с ошибкой|  
|Автоматический перезапуск|Отложенная транзакция|  
|Создание базы данных или моментального снимка базы данных|Создание завершается с ошибкой|  
|Повтор при зеркальном отображении базы данных|Отложенная транзакция|  
|Файловая группа находится в режиме «вне сети»|Отложенная транзакция|  
  
## <a name="moving-a-transaction-out-of-the-deferred-state"></a>Вывод транзакции из состояния DEFERRED  
  
> [!IMPORTANT]  
>  Отложенная транзакция удерживает журнал транзакций активным. Файл виртуального журнала, содержащий все отложенные транзакции, нельзя усекать, пока эти транзакции не выйдут из отложенного состояния. Дополнительные сведения об усечении журнала см. в разделе [Создание резервной копии журнала транзакций (SQL Server)](../logs/the-transaction-log-sql-server.md).  
  
 Для вывода транзакции из отложенного состояния база данных должна запуститься без ошибок ввода-вывода. При наличии отложенных транзакций необходимо восстановить работу источника ошибок ввода-вывода. Ниже приводятся доступные решения, перечисленные в том порядке, в каком они обычно применяются.  
  
-   Перезапуск базы данных. Если проблема временная, база данных должна запускаться без отложенных транзакций.  
  
-   Если транзакции были отложены из-за того, что файловая группа была в режиме «вне сети», вновь переведите файловую группу в режим «в сети».  
  
     Для возвращения файловой группы из режима «вне сети» в режим «в сети» воспользуйтесь следующей инструкцией [!INCLUDE[tsql](../../includes/tsql-md.md)] :  
  
    ```  
    RESTORE DATABASE database_name FILEGROUP=<filegroup_name>  
    ```  
  
-   восстановить базу данных. После восстановления «в сети» разрешаются отложенные транзакции.  
  
     В полной модели восстановления или модели с неполным протоколированием восстановление страницы в режиме «в сети» может решить проблему (там, где это поддерживается), если причиной возникновения отложенных транзакций являются лишь несколько поврежденных страниц.  
  
-   Если файловая группа, состояние «вне сети» которой является причиной отложенных транзакций, больше не требуется, отключите эту файловую группу. Транзакции, отложенные из-за того, что файловая группа находилась в режиме «вне сети», выходят из отложенного состояния после того, как эта файловая группа перестанет функционировать.  
  
    > [!IMPORTANT]  
    >  Восстановление уничтоженной файловой группы невозможно.  
  
     Дополнительные сведения см. в статье [Удаление уничтоженных файловых групп (SQL Server)](remove-defunct-filegroups-sql-server.md).  
  
-   Если транзакции отложены из-за повреждения страницы, а резервная копия базы данных отсутствует, для восстановления базы данных воспользуйтесь следующей процедурой.  
  
    -   Вначале переведите базу данных в аварийный режим, выполнив следующую инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)] :  
  
        ```  
        ALTER DATABASE <database_name> SET EMERGENCY  
        ```  
  
         Сведения об аварийном режиме см. в разделе [Database States](../databases/database-states.md).  
  
    -   Затем восстановите базу данных, используя параметр DBCC REPAIR_ALLOW_DATA_LOSS в одной из следующих инструкций DBCC: [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql), [DBCC CHECKALLOC](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql) или [DBCC CHECKTABLE](/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql).  
  
         При возникновении страницы с поврежденными данными DBCC освобождает эту страницу и исправляет связанные с ней ошибки. Такой подход дает возможность возвратить базу данных в режиме «в сети» в физически согласованное состояние. Но при этом могут быть также потеряны дополнительные данные, поэтому этот подход должен применяться только в исключительных случаях.  
  
## <a name="see-also"></a>См. также:  
 [Обзор процессов восстановления (SQL Server)](restore-and-recovery-overview-sql-server.md)   
 [Удаление уничтоженных файловых групп (SQL Server)](remove-defunct-filegroups-sql-server.md)   
 [Восстановления файлов (модель полного восстановления)](file-restores-full-recovery-model.md)   
 [Восстановление файлов (простая модель восстановления)](file-restores-simple-recovery-model.md)   
 [Восстановление страниц (SQL Server)](restore-pages-sql-server.md)   
 [Поэтапное восстановление (SQL Server)](piecemeal-restores-sql-server.md)   
 [ALTER DATABASE (Transact-SQL)](/sql/t-sql/statements/alter-database-transact-sql)   
 [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql)  
  
  
