---
title: Подготовка команд | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client OLE DB provider, commands
- prepared statements [SQL Server Native Client]
- commands [OLE DB]
- command preparation [SQL Server Native Client]
ms.assetid: 09ec0c6c-0a44-4766-b9b7-5092f676ee54
author: rothja
ms.author: jroth
ms.openlocfilehash: e06e6afab622953452a00751e3a55d49fc7b8ec7
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87729477"
---
# <a name="preparing-commands"></a><span data-ttu-id="56c07-102">Подготовка команд</span><span class="sxs-lookup"><span data-stu-id="56c07-102">Preparing Commands</span></span>
  <span data-ttu-id="56c07-103">Поставщик OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] поддерживает подготовку команды для оптимизированного многократного выполнения, однако подготовка команды создает дополнительную нагрузку; поэтому потребителю нет необходимости подготавливать команду для ее выполнения более одного раза.</span><span class="sxs-lookup"><span data-stu-id="56c07-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports command preparation for optimized multiple execution of a single command; however, command preparation generates overhead, and a consumer does not need to prepare a command to execute it more than once.</span></span> <span data-ttu-id="56c07-104">Как правило, подготовку команды следует выполнять в том случае, если планируется ее не менее чем четырехкратное выполнение.</span><span class="sxs-lookup"><span data-stu-id="56c07-104">In general, a command should be prepared if it will be executed more than three times.</span></span>  
  
 <span data-ttu-id="56c07-105">По соображениям производительности подготовка команды откладывается до ее выполнения.</span><span class="sxs-lookup"><span data-stu-id="56c07-105">For performance reasons, the command preparation is deferred until the command is executed.</span></span> <span data-ttu-id="56c07-106">Это поведение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="56c07-106">This is the default behavior.</span></span> <span data-ttu-id="56c07-107">Об ошибках, содержащихся в подготавливаемой команде, не будет ничего известно до ее выполнения или до выполнения операции с метасвойством.</span><span class="sxs-lookup"><span data-stu-id="56c07-107">Any errors in the command being prepared are not known until the command is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="56c07-108">При установке свойства [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] SSPROP_DEFERPREPARE в значение FALSE это поведение по умолчанию может быть отключено.</span><span class="sxs-lookup"><span data-stu-id="56c07-108">Setting the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] property SSPROP_DEFERPREPARE to FALSE can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="56c07-109">Если команда выполняется напрямую (без предварительной подготовки), то [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] создает и кэширует план выполнения.</span><span class="sxs-lookup"><span data-stu-id="56c07-109">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], when a command is executed directly (without preparing it first), an execution plan is created and cached.</span></span> <span data-ttu-id="56c07-110">При повторном выполнении инструкции SQL [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] применяет эффективный алгоритм сопоставления новой инструкции с существующим планом выполнения и повторно использует для этой инструкции тот же план выполнения.</span><span class="sxs-lookup"><span data-stu-id="56c07-110">If the SQL statement is executed again, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] has an efficient algorithm to match the new statement with the existing execution plan in the cache, and reuses the execution plan for that statement.</span></span>  
  
 <span data-ttu-id="56c07-111">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] предусматривает встроенную поддержку подготавливаемых и выполняемых инструкций.</span><span class="sxs-lookup"><span data-stu-id="56c07-111">For prepared commands, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] provides native support for preparing and executing command statements.</span></span> <span data-ttu-id="56c07-112">При подготовке инструкции [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] создает план выполнения, кэширует его и возвращает поставщику дескриптор этого плана.</span><span class="sxs-lookup"><span data-stu-id="56c07-112">When you prepare a statement, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an execution plan, caches it, and returns a handle to this execution plan to the provider.</span></span> <span data-ttu-id="56c07-113">Поставщик пользуется этим дескриптором для повторного выполнения инструкции.</span><span class="sxs-lookup"><span data-stu-id="56c07-113">The provider then uses this handle to execute the statement repeatedly.</span></span> <span data-ttu-id="56c07-114">Хранимые процедуры не создаются.</span><span class="sxs-lookup"><span data-stu-id="56c07-114">No stored procedures are created.</span></span> <span data-ttu-id="56c07-115">Поскольку дескриптор прямо указывает на план выполнения инструкции SQL, а не сопоставляет инструкцию с планом выполнения, содержащимся в кэше (как при прямом выполнении), значительно эффективнее выполнить подготовку инструкции, а не выполнять ее напрямую, если известно, что инструкция будет использоваться многократно.</span><span class="sxs-lookup"><span data-stu-id="56c07-115">Because the handle directly identifies the execution plan for an SQL statement instead of matching the statement to the execution plan in the cache (as is the case for direct execution), it is more efficient to prepare a statement than to execute it directly, if you know the statement will be executed more than a few times.</span></span>  
  
 <span data-ttu-id="56c07-116">В [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] подготовленные инструкции не могут применяться для создания временных объектов (например, временных таблиц) и не могут ссылаться на создающие их системные хранимые процедуры.</span><span class="sxs-lookup"><span data-stu-id="56c07-116">In [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the prepared statements cannot be used to create temporary objects and cannot reference system stored procedures that create temporary objects, such as temporary tables.</span></span> <span data-ttu-id="56c07-117">Эти процедуры следует выполнять напрямую.</span><span class="sxs-lookup"><span data-stu-id="56c07-117">These procedures must be executed directly.</span></span>  
  
 <span data-ttu-id="56c07-118">Некоторые команды не могут быть подготовлены.</span><span class="sxs-lookup"><span data-stu-id="56c07-118">Some commands should never be prepared.</span></span> <span data-ttu-id="56c07-119">Например, команды, указывающие выполнение хранимой процедуры или содержащие недопустимый текст для создания хранимой процедуры [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], подготавливаться не должны.</span><span class="sxs-lookup"><span data-stu-id="56c07-119">For example, commands that specify stored procedure execution or include invalid text for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] stored procedure creation should not be prepared.</span></span>  
  
 <span data-ttu-id="56c07-120">При создании временной хранимой процедуры поставщик OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняет временную хранимую процедуру и возвращает результаты, как если бы выполнялась сама инструкция.</span><span class="sxs-lookup"><span data-stu-id="56c07-120">If a temporary stored procedure is created, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider executes the temporary stored procedure, returning results as if the statement itself was executed.</span></span>  
  
 <span data-ttu-id="56c07-121">Создание временных хранимых процедур управляется свойством инициализации SSPROP_INIT_USEPROCFORPREP, определяемым поставщиком OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="56c07-121">Temporary stored procedure creation is controlled by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider -specific initialization property SSPROP_INIT_USEPROCFORPREP.</span></span> <span data-ttu-id="56c07-122">Если свойство имеет значение SSPROPVAL_USEPROCFORPREP_ON или SSPROPVAL_USEPROCFORPREP_ON_DROP, то поставщик OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] при подготовке команды выполняет попытку создать хранимую процедуру.</span><span class="sxs-lookup"><span data-stu-id="56c07-122">If the property value is either SSPROPVAL_USEPROCFORPREP_ON or SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider attempts to create a stored procedure when a command is prepared.</span></span> <span data-ttu-id="56c07-123">Хранимая процедура будет создана успешно, если пользователь приложения имеет все необходимые разрешения [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="56c07-123">Stored procedure creation succeeds if the application user has sufficient [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] permissions.</span></span>  
  
 <span data-ttu-id="56c07-124">Для потребителей, изредка теряющих соединение, создание временных хранимых процедур может потребовать значительных ресурсов базы **tempdb**, системной базы данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], в которой создаются временные объекты.</span><span class="sxs-lookup"><span data-stu-id="56c07-124">For consumers that infrequently disconnect, creation of temporary stored procedures can require significant resources of **tempdb**, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] system database in which temporary objects are created.</span></span> <span data-ttu-id="56c07-125">Если свойство SSPROP_INIT_USEPROCFORPREP имеет значение SSPROPVAL_USEPROCFORPREP_ ON, то временные хранимые процедуры, созданные поставщиком OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], удаляются только после потери соединения сеанса, создавшего команду, с экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="56c07-125">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ ON, temporary stored procedures created by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider are dropped only when the session that created the command loses its connection to the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="56c07-126">Если это соединение по умолчанию, созданное при инициализации источника данных, то временная хранимая процедура удаляется только тогда, когда источник данных становится неинициализированным.</span><span class="sxs-lookup"><span data-stu-id="56c07-126">If that connection is the default connection created on data source initialization, the temporary stored procedure is dropped only when the data source becomes uninitialized.</span></span>  
  
 <span data-ttu-id="56c07-127">Если свойство SSPROP_INIT_USEPROCFORPREP имеет значение SSPROPVAL_USEPROCFORPREP_ON_DROP, то временные хранимые процедуры поставщика OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] будут удаляться только в следующих случаях.</span><span class="sxs-lookup"><span data-stu-id="56c07-127">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider temporary stored procedures are dropped when one of the following occurs:</span></span>  
  
-   <span data-ttu-id="56c07-128">Потребитель вызывает метод **ICommandText::SetCommandText** для задания новой команды.</span><span class="sxs-lookup"><span data-stu-id="56c07-128">The consumer uses **ICommandText::SetCommandText** to indicate a new command.</span></span>  
  
-   <span data-ttu-id="56c07-129">Потребитель вызывает метод **ICommandPrepare::Unprepare** для указания на то, что текст команды больше не нужен.</span><span class="sxs-lookup"><span data-stu-id="56c07-129">The consumer uses **ICommandPrepare::Unprepare** to indicate that it no longer requires the command text.</span></span>  
  
-   <span data-ttu-id="56c07-130">Потребитель освобождает все ссылки на объект команды, связанной с временной хранимой процедурой.</span><span class="sxs-lookup"><span data-stu-id="56c07-130">The consumer releases all references to the command object using the temporary stored procedure.</span></span>  
  
 <span data-ttu-id="56c07-131">Объект команды имеет в базе данных **tempdb** не более одной хранимой процедуры.</span><span class="sxs-lookup"><span data-stu-id="56c07-131">A command object has at most one temporary stored procedure in **tempdb**.</span></span> <span data-ttu-id="56c07-132">Любая существующая временная хранимая процедура представляет текущий текст команды для этого объекта.</span><span class="sxs-lookup"><span data-stu-id="56c07-132">Any existing temporary stored procedure represents the current command text of a specific command object.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="56c07-133">См. также:</span><span class="sxs-lookup"><span data-stu-id="56c07-133">See Also</span></span>  
 [<span data-ttu-id="56c07-134">Команды</span><span class="sxs-lookup"><span data-stu-id="56c07-134">Commands</span></span>](commands.md)  
  
  
