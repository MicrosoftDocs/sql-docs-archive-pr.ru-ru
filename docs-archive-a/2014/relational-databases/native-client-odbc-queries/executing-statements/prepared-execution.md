---
title: Подготовленное выполнение | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- deferred statement preparation
- prepared execution [ODBC]
- SQLPrepare function
- ODBC applications, statements
- SQLExecute function
- statements [ODBC], prepared execution
ms.assetid: f3a9d32b-6cd7-4f0c-b38d-c8ccc4ee40c3
author: rothja
ms.author: jroth
ms.openlocfilehash: 33ab9f35cd9d3eaf04e688a89390b5eb3f00ae58
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87655120"
---
# <a name="prepared-execution"></a><span data-ttu-id="7c58f-102">Подготовленное выполнение</span><span class="sxs-lookup"><span data-stu-id="7c58f-102">Prepared Execution</span></span>
  <span data-ttu-id="7c58f-103">API-интерфейс ODBC определяет подготовленное выполнение как способ уменьшить расходы на синтаксический анализ и компиляцию, связанные с повторным выполнением инструкции [!INCLUDE[tsql](../../../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="7c58f-103">The ODBC API defines prepared execution as a way to reduce the parsing and compiling overhead associated with repeatedly executing a [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span> <span data-ttu-id="7c58f-104">Приложение строит строку символов, содержащую инструкцию SQL, а затем выполняет ее в два этапа.</span><span class="sxs-lookup"><span data-stu-id="7c58f-104">The application builds a character string containing an SQL statement and then executes it in two stages.</span></span> <span data-ttu-id="7c58f-105">Он вызывает [функцию SQLPrepare](https://go.microsoft.com/fwlink/?LinkId=59360) один раз, чтобы инструкция была проанализирована и скомпилирована в план выполнения с помощью [!INCLUDE[ssDE](../../../includes/ssde-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="7c58f-105">It calls [SQLPrepare Function](https://go.microsoft.com/fwlink/?LinkId=59360) once to have the statement parsed and compiled into an execution plan by the [!INCLUDE[ssDE](../../../includes/ssde-md.md)].</span></span> <span data-ttu-id="7c58f-106">Затем он вызывает **SQLExecute** для каждого выполнения подготовленного плана выполнения.</span><span class="sxs-lookup"><span data-stu-id="7c58f-106">It then calls **SQLExecute** for each execution of the prepared execution plan.</span></span> <span data-ttu-id="7c58f-107">Это снижает расход ресурсов на синтаксический анализ и компиляцию при каждом выполнении.</span><span class="sxs-lookup"><span data-stu-id="7c58f-107">This saves the parsing and compiling overhead on each execution.</span></span> <span data-ttu-id="7c58f-108">Подготовленное выполнение часто используется приложениями для многократного выполнения параметризованных инструкций SQL.</span><span class="sxs-lookup"><span data-stu-id="7c58f-108">Prepared execution is commonly used by applications to repeatedly execute the same, parameterized SQL statement.</span></span>  
  
 <span data-ttu-id="7c58f-109">В большинстве баз данных подготовленное выполнение инструкций, которые выполняются более трех или четырех раз, быстрее, чем прямое выполнение, в первую очередь потому, что инструкция компилируется только один раз, в то время как инструкции, выполняемые прямо, компилируются при каждом выполнении.</span><span class="sxs-lookup"><span data-stu-id="7c58f-109">For most databases, prepared execution is faster than direct execution for statements executed more than three or four times primarily because the statement is compiled only once, while statements executed directly are compiled each time they are executed.</span></span> <span data-ttu-id="7c58f-110">Подготовленное выполнение может также снизить объем сетевого трафика, поскольку драйвер при каждом выполнении инструкции может передавать источнику данных идентификатор плана выполнения и значения параметров, а не целую инструкцию SQL.</span><span class="sxs-lookup"><span data-stu-id="7c58f-110">Prepared execution can also provide a reduction in network traffic because the driver can send an execution plan identifier and the parameter values, rather than an entire SQL statement, to the data source each time the statement is executed.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="7c58f-111">сокращается разница в производительности между прямым и подготовленным выполнением с помощью улучшенных алгоритмов для обнаружения и повторного использования планов выполнения из **SQLExecDirect**.</span><span class="sxs-lookup"><span data-stu-id="7c58f-111">reduces the performance difference between direct and prepared execution through improved algorithms for detecting and reusing execution plans from **SQLExecDirect**.</span></span> <span data-ttu-id="7c58f-112">В результате некоторые преимущества производительности выполнения подготовленных инструкций распространяются на прямое выполнение инструкций.</span><span class="sxs-lookup"><span data-stu-id="7c58f-112">This makes some of the performance benefits of prepared execution available to statements executed directly.</span></span> <span data-ttu-id="7c58f-113">Дополнительные сведения см. в разделе [прямое выполнение](direct-execution.md).</span><span class="sxs-lookup"><span data-stu-id="7c58f-113">For more information, see [Direct Execution](direct-execution.md).</span></span>  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="7c58f-114">также обеспечивает собственную поддержку подготовленного выполнения.</span><span class="sxs-lookup"><span data-stu-id="7c58f-114">also provides native support for prepared execution.</span></span> <span data-ttu-id="7c58f-115">План выполнения строится на основе **SQLPrepare** и более поздних версий при вызове **SQLExecute** .</span><span class="sxs-lookup"><span data-stu-id="7c58f-115">An execution plan is built on **SQLPrepare** and later executed when **SQLExecute** is called.</span></span> <span data-ttu-id="7c58f-116">Поскольку [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] не требуется создавать временные хранимые процедуры в **SQLPrepare**, дополнительные издержки на системные таблицы в **базе данных tempdb**отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="7c58f-116">Because [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is not required to build temporary stored procedures on **SQLPrepare**, there is no extra overhead on the system tables in **tempdb**.</span></span>  
  
 <span data-ttu-id="7c58f-117">По соображениям производительности подготовка инструкции откладывается до вызова **SQLExecute** или операции метасвойства (например, [SQLDescribeCol](../../native-client-odbc-api/sqldescribecol.md) или [SQLDescribeParam](../../native-client-odbc-api/sqldescribeparam.md) в ODBC).</span><span class="sxs-lookup"><span data-stu-id="7c58f-117">For performance reasons, the statement preparation is deferred until **SQLExecute** is called or a metaproperty operation (such as [SQLDescribeCol](../../native-client-odbc-api/sqldescribecol.md) or [SQLDescribeParam](../../native-client-odbc-api/sqldescribeparam.md) in ODBC) is performed.</span></span> <span data-ttu-id="7c58f-118">Это поведение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7c58f-118">This is the default behavior.</span></span> <span data-ttu-id="7c58f-119">Любые ошибки в подготавливаемой инструкции неизвестны до выполнения инструкции или до выполнения операции над метасвойством.</span><span class="sxs-lookup"><span data-stu-id="7c58f-119">Any errors in the statement being prepared are not known until the statement is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="7c58f-120">Установив атрибут инструкции SQL_SOPT_SS_DEFER_PREPARE в специфичное для ODBC-драйвера собственного клиента [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] значение SQL_DP_OFF, можно отключить это поведение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7c58f-120">Setting the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver-specific statement attribute SQL_SOPT_SS_DEFER_PREPARE to SQL_DP_OFF can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="7c58f-121">В случае отложенной подготовки вызов метода **SQLDescribeCol** или **SQLDescribeParam** перед вызовом **SQLExecute** создает дополнительный обмен данными с сервером.</span><span class="sxs-lookup"><span data-stu-id="7c58f-121">In case of deferred prepare, calling either **SQLDescribeCol** or **SQLDescribeParam** before calling **SQLExecute** generates an extra roundtrip to the server.</span></span> <span data-ttu-id="7c58f-122">В **SQLDescribeCol**драйвер УДАЛЯЕТ предложение WHERE из запроса и отправляет его на сервер с параметром SET FMTONLY ON для получения описания столбцов в первом результирующем наборе, возвращенном запросом.</span><span class="sxs-lookup"><span data-stu-id="7c58f-122">On **SQLDescribeCol**, the driver removes the WHERE clause from the query and sends it to the server with SET FMTONLY ON to get the description of the columns in the first result set returned by the query.</span></span> <span data-ttu-id="7c58f-123">В **SQLDescribeParam**драйвер вызывает сервер, чтобы получить описание выражений или столбцов, на которые ссылаются маркеры параметров в запросе.</span><span class="sxs-lookup"><span data-stu-id="7c58f-123">On **SQLDescribeParam**, the driver calls the server to get a description of the expressions or columns referenced by any parameter markers in the query.</span></span> <span data-ttu-id="7c58f-124">Этот метод также имеет несколько ограничений, таких как невозможность обработки параметров вложенных запросов.</span><span class="sxs-lookup"><span data-stu-id="7c58f-124">This method also has some restrictions, such as not being able to resolve parameters in subqueries.</span></span>  
  
 <span data-ttu-id="7c58f-125">Чрезмерное использование **SQLPrepare** с [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] драйвером ODBC для собственного клиента снижает производительность, особенно при подключении к более ранним версиям SQL Server.</span><span class="sxs-lookup"><span data-stu-id="7c58f-125">Excess use of **SQLPrepare** with the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver degrades performance, especially when connected to earlier versions of SQL Server.</span></span> <span data-ttu-id="7c58f-126">Не следует использовать подготовленное выполнение для инструкций, исполняемых один раз.</span><span class="sxs-lookup"><span data-stu-id="7c58f-126">Prepared execution should not be used for statements executed a single time.</span></span> <span data-ttu-id="7c58f-127">Подготовленное выполнение медленнее, чем прямое выполнение, для однократного выполнения инструкции, потому что оно требует дополнительного обращения клиента к серверу.</span><span class="sxs-lookup"><span data-stu-id="7c58f-127">Prepared execution is slower than direct execution for a single execution of a statement because it requires an extra network roundtrip from the client to the server.</span></span> <span data-ttu-id="7c58f-128">В предыдущих версиях [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] оно также создает временную хранимую процедуру.</span><span class="sxs-lookup"><span data-stu-id="7c58f-128">On earlier versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] it also generates a temporary stored procedure.</span></span>  
  
 <span data-ttu-id="7c58f-129">В [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] подготовленные инструкции нельзя применять для создания временных объектов.</span><span class="sxs-lookup"><span data-stu-id="7c58f-129">Prepared statements cannot be used to create temporary objects on [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="7c58f-130">Некоторые ранние приложения ODBC использовались **SQLPrepare** в любое время [SQLBindParameter](../../native-client-odbc-api/sqlbindparameter.md) .</span><span class="sxs-lookup"><span data-stu-id="7c58f-130">Some early ODBC applications used **SQLPrepare** any time [SQLBindParameter](../../native-client-odbc-api/sqlbindparameter.md) was used.</span></span> <span data-ttu-id="7c58f-131">**SQLBindParameter** не требует использования **SQLPrepare**, его можно использовать с **SQLExecDirect**.</span><span class="sxs-lookup"><span data-stu-id="7c58f-131">**SQLBindParameter** does not require the use of **SQLPrepare**, it can be used with **SQLExecDirect**.</span></span> <span data-ttu-id="7c58f-132">Например, используйте **SQLExecDirect** с **SQLBindParameter** для получения кода возврата или выходных параметров из хранимой процедуры, которая выполняется только один раз.</span><span class="sxs-lookup"><span data-stu-id="7c58f-132">For example, use **SQLExecDirect** with **SQLBindParameter** to retrieve the return code or output parameters from a stored procedure that is only executed one time.</span></span> <span data-ttu-id="7c58f-133">Не используйте **SQLPrepare** с **SQLBindParameter** , если одна и та же инструкция не будет выполняться несколько раз.</span><span class="sxs-lookup"><span data-stu-id="7c58f-133">Do not use **SQLPrepare** with **SQLBindParameter** unless the same statement will be executed multiple times.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7c58f-134">См. также:</span><span class="sxs-lookup"><span data-stu-id="7c58f-134">See Also</span></span>  
 [<span data-ttu-id="7c58f-135">Исполнение инструкций &#40;ODBC&#41;</span><span class="sxs-lookup"><span data-stu-id="7c58f-135">Executing Statements &#40;ODBC&#41;</span></span>](executing-statements-odbc.md)  
  
  
