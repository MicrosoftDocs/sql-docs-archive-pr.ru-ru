---
title: Общие сведения о пространственных индексах | Документация Майкрософт
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- spatial indexes [SQL Server]
ms.assetid: b1ae7b78-182a-459e-ab28-f743e43f8293
author: MladjoA
ms.author: mlandzic
ms.openlocfilehash: 36406bd60b4204469aca3d20862020870a8832fe
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87665279"
---
# <a name="spatial-indexes-overview"></a><span data-ttu-id="e1814-102">Общие сведения о пространственных индексах</span><span class="sxs-lookup"><span data-stu-id="e1814-102">Spatial Indexes Overview</span></span>
  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="e1814-103">поддерживает пространственные данные и пространственные индексы.</span><span class="sxs-lookup"><span data-stu-id="e1814-103">supports spatial data and spatial indexes.</span></span> <span data-ttu-id="e1814-104">*Пространственный индекс* представляет собой тип расширенного индекса, позволяющий индексировать пространственные столбцы.</span><span class="sxs-lookup"><span data-stu-id="e1814-104">A *spatial index* is a type of extended index that allows you to index a spatial column.</span></span> <span data-ttu-id="e1814-105">Пространственный столбец представляет собой столбец таблицы, в котором содержатся данные пространственного типа, например `geometry` или `geography`.</span><span class="sxs-lookup"><span data-stu-id="e1814-105">A spatial column is a table column that contains data of a spatial data type, such as `geometry` or `geography`.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="e1814-106">Подробное описание и примеры использования функций обработки пространственных данных, появившихся в [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], включая функции, работающие с пространственными индексами, можно получить, скачав технический документ [Новые функции обработки пространственных данных в SQL Server 2012](https://go.microsoft.com/fwlink/?LinkId=226407).</span><span class="sxs-lookup"><span data-stu-id="e1814-106">For a detailed description and examples of spatial features introduced in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], including features that affect spatial indexes, download the white paper, [New Spatial Features in SQL Server 2012](https://go.microsoft.com/fwlink/?LinkId=226407).</span></span>

##  <a name="about-spatial-indexes"></a><a name="about"></a> <span data-ttu-id="e1814-107">О пространственных индексах</span><span class="sxs-lookup"><span data-stu-id="e1814-107">About Spatial Indexes</span></span>

###  <a name="decomposing-indexed-space-into-a-grid-hierarchy"></a><a name="decompose"></a> <span data-ttu-id="e1814-108">Декомпозиция индексированного пространства в сеточную иерархию</span><span class="sxs-lookup"><span data-stu-id="e1814-108">Decomposing Indexed Space into a Grid Hierarchy</span></span>
 <span data-ttu-id="e1814-109">В [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]пространственные индексы строятся с помощью сбалансированных деревьев, что означает, что индексы должны представлять двумерные пространственные данные в линейном порядке сбалансированных деревьев.</span><span class="sxs-lookup"><span data-stu-id="e1814-109">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], spatial indexes are built using B-trees, which means that the indexes must represent the 2-dimensional spatial data in the linear order of B-trees.</span></span> <span data-ttu-id="e1814-110">Поэтому перед считыванием данных в пространственный индекс [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] проводит иерархическую декомпозицию пространства.</span><span class="sxs-lookup"><span data-stu-id="e1814-110">Therefore, before reading data into a spatial index, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] implements a hierarchical uniform decomposition of space.</span></span> <span data-ttu-id="e1814-111">В процессе создания индекса происходит *декомпозиция* пространства в четырехуровневую *сеточную иерархию*.</span><span class="sxs-lookup"><span data-stu-id="e1814-111">The index-creation process *decomposes* the space into a four-level *grid hierarchy*.</span></span> <span data-ttu-id="e1814-112">Эти уровни называют *Уровень 1* (верхний), *Уровень 2*, *Уровень 3*и *Уровень 4*.</span><span class="sxs-lookup"><span data-stu-id="e1814-112">These levels are referred to as *level 1* (the top level), *level 2*, *level 3*, and *level 4*.</span></span>

 <span data-ttu-id="e1814-113">Каждый последующий уровень содержит дальнейшую декомпозицию уровня выше, так что каждая ячейка уровня выше содержит полную сетку следующего уровня.</span><span class="sxs-lookup"><span data-stu-id="e1814-113">Each successive level further decomposes the level above it, so each upper-level cell contains a complete grid at the next level.</span></span> <span data-ttu-id="e1814-114">На заданном уровне все сетки имеют одинаковое число ячеек на обеих осях (например, 4x4 или 8x8), и все ячейки имеют одинаковый размер.</span><span class="sxs-lookup"><span data-stu-id="e1814-114">On a given level, all the grids have the same number of cells along both axes (for example, 4x4 or 8x8), and the cells are all one size.</span></span>

 <span data-ttu-id="e1814-115">На следующем рисунке показана декомпозиция верхней правой ячейки на каждом уровне сеточной иерархии в сетку 4x4.</span><span class="sxs-lookup"><span data-stu-id="e1814-115">The following illustration shows the decomposition for the upper-right cell at each level of the grid hierarchy into a 4x4 grid.</span></span> <span data-ttu-id="e1814-116">Фактически, таким образом декомпозиция выполняется для всех ячеек.</span><span class="sxs-lookup"><span data-stu-id="e1814-116">In reality, all the cells are decomposed in this way.</span></span> <span data-ttu-id="e1814-117">Например, декомпозиция пространства в четыре уровня сеток 4x4 фактически приводит к созданию 65 536 ячеек четвертого уровня.</span><span class="sxs-lookup"><span data-stu-id="e1814-117">Thus, for example, decomposing a space into four levels of 4x4 grids actually produces a total of 65,536 level-four cells.</span></span>

 <span data-ttu-id="e1814-118">![Четыре уровня рекурсивной тесселяции](../../database-engine/media/spndx-recursive-levels-telescoped.gif "Четыре уровня рекурсивной тесселяции")</span><span class="sxs-lookup"><span data-stu-id="e1814-118">![Four-levels of recursive tessellation](../../database-engine/media/spndx-recursive-levels-telescoped.gif "Four-levels of recursive tessellation")</span></span>

> [!NOTE]
>  <span data-ttu-id="e1814-119">Декомпозиция пространства в пространственный индекс не зависит от единиц измерения в данных приложения.</span><span class="sxs-lookup"><span data-stu-id="e1814-119">The decomposition of space for a spatial index is independent of the unit of measurement that the application data uses.</span></span>

 <span data-ttu-id="e1814-120">Ячейки в сеточной иерархии нумеруются в линейном порядке с использованием варианта заполнения пространства кривой Гильберта.</span><span class="sxs-lookup"><span data-stu-id="e1814-120">Grid hierarchy cells are numbered in a linear fashion by using a variation of the Hilbert space-filling curve.</span></span> <span data-ttu-id="e1814-121">Однако на данном рисунке используется простая построковая нумерация вместо нумерации, которая фактически создается кривой Гильберта.</span><span class="sxs-lookup"><span data-stu-id="e1814-121">For the purpose of illustration, however, this discussion uses a simple row-wise numbering, instead of the numbering that is actually produced by the Hilbert curve.</span></span> <span data-ttu-id="e1814-122">На следующем рисунке несколько многоугольников, представляющих здания, и линий, представляющих улицы, помещены в сетку 4x4 уровня 1.</span><span class="sxs-lookup"><span data-stu-id="e1814-122">In the following illustration, several polygons that represent buildings, and lines that represent streets, have already been placed into a 4x4, level-1 grid.</span></span> <span data-ttu-id="e1814-123">Ячейки первого уровня нумеруются от 1 до 16, начиная с верхней левой.</span><span class="sxs-lookup"><span data-stu-id="e1814-123">The level-1 cells are numbered from 1 through 16, starting with the upper-left cell.</span></span>

 <span data-ttu-id="e1814-124">![Полигоны и линии, помещены в сетку 4x4 уровня 1](../../database-engine/media/spndx-level-1-objects.gif "Полигоны и линии, помещены в сетку 4x4 уровня 1")</span><span class="sxs-lookup"><span data-stu-id="e1814-124">![Polygons and lines placed into a 4x4 level-1 grid](../../database-engine/media/spndx-level-1-objects.gif "Polygons and lines placed into a 4x4 level-1 grid")</span></span>

#### <a name="grid-density"></a><span data-ttu-id="e1814-125">Плотность сетки</span><span class="sxs-lookup"><span data-stu-id="e1814-125">Grid Density</span></span>
 <span data-ttu-id="e1814-126">Число ячеек по осям сетки определяет ее *плотность*: чем больше число, тем плотнее сетка.</span><span class="sxs-lookup"><span data-stu-id="e1814-126">The number of cells along the axes of a grid determines its *density*: the larger the number, the denser the grid.</span></span> <span data-ttu-id="e1814-127">Например, сетка 8x8 (которая порождает 64 ячейки) плотнее сетки 4x4 (которая порождает 16 ячеек).</span><span class="sxs-lookup"><span data-stu-id="e1814-127">For example, an 8x8 grid (which produces 64 cells), is denser than a 4x4 grid (which produces 16 cells).</span></span> <span data-ttu-id="e1814-128">Плотность сетки определяется по уровням.</span><span class="sxs-lookup"><span data-stu-id="e1814-128">Grid density is defined on a per-level basis.</span></span>

 <span data-ttu-id="e1814-129">Инструкция [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] поддерживает использование предложения GRIDS, которое позволяет указывать различные плотности сетки на разных уровнях.</span><span class="sxs-lookup"><span data-stu-id="e1814-129">The [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement supports a GRIDS clause that enables you to specify different grid densities at different levels.</span></span> <span data-ttu-id="e1814-130">Плотность сетки для данного уровня задается с помощью одного из следующих ключевых слов.</span><span class="sxs-lookup"><span data-stu-id="e1814-130">The grid density for a given level is specified by using one of the following keywords.</span></span>

|<span data-ttu-id="e1814-131">Ключевое слово</span><span class="sxs-lookup"><span data-stu-id="e1814-131">Keyword</span></span>|<span data-ttu-id="e1814-132">Конфигурация сетки</span><span class="sxs-lookup"><span data-stu-id="e1814-132">Grid configuration</span></span>|<span data-ttu-id="e1814-133">Число ячеек</span><span class="sxs-lookup"><span data-stu-id="e1814-133">Number of cells</span></span>|
|-------------|------------------------|---------------------|
|<span data-ttu-id="e1814-134">LOW</span><span class="sxs-lookup"><span data-stu-id="e1814-134">LOW</span></span>|<span data-ttu-id="e1814-135">4X4</span><span class="sxs-lookup"><span data-stu-id="e1814-135">4X4</span></span>|<span data-ttu-id="e1814-136">16</span><span class="sxs-lookup"><span data-stu-id="e1814-136">16</span></span>|
|<span data-ttu-id="e1814-137">MEDIUM</span><span class="sxs-lookup"><span data-stu-id="e1814-137">MEDIUM</span></span>|<span data-ttu-id="e1814-138">8X8</span><span class="sxs-lookup"><span data-stu-id="e1814-138">8X8</span></span>|<span data-ttu-id="e1814-139">64</span><span class="sxs-lookup"><span data-stu-id="e1814-139">64</span></span>|
|<span data-ttu-id="e1814-140">HIGH.</span><span class="sxs-lookup"><span data-stu-id="e1814-140">HIGH</span></span>|<span data-ttu-id="e1814-141">16X16</span><span class="sxs-lookup"><span data-stu-id="e1814-141">16X16</span></span>|<span data-ttu-id="e1814-142">256</span><span class="sxs-lookup"><span data-stu-id="e1814-142">256</span></span>|

 <span data-ttu-id="e1814-143">В [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], если уровень совместимости базы данных имеет значение 100 или ниже, по умолчанию используется значение MEDIUM на всех уровнях.</span><span class="sxs-lookup"><span data-stu-id="e1814-143">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], when the database compatibility level is set to 100 or lower, then the default is MEDIUM on all levels.</span></span> <span data-ttu-id="e1814-144">Если уровень совместимости базы данных имеет значение 110 или выше, то по умолчанию используется автоматическая схема сетки.</span><span class="sxs-lookup"><span data-stu-id="e1814-144">When the database compatibility level is set to 110 or higher, then the default is an auto grid scheme.</span></span>

 <span data-ttu-id="e1814-145">Управление процессом декомпозиции производится заданием плотности сетки, отличной от значения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e1814-145">You can control the decomposition process by specifying non-default grid densities.</span></span> <span data-ttu-id="e1814-146">Например, может оказаться полезным использование разных плотностей сеток на разных уровнях для точной настройки индекса, исходя из размера индексируемого пространства и объектов в пространственном столбце.</span><span class="sxs-lookup"><span data-stu-id="e1814-146">For example, different grid densities on different levels might be useful for fine tuning an index based on the size of the indexed space and the objects in the spatial column.</span></span>

> [!NOTE]
>  <span data-ttu-id="e1814-147">Значения плотности сеток в пространственном индексе можно просмотреть в столбцах level_1_grid, level_2_grid, level_3_grid и level_4_grid представления каталога [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) , если уровень совместимости базы данных имеет значение 100 или ниже.</span><span class="sxs-lookup"><span data-stu-id="e1814-147">The grid densities of a spatial index are visible in the level_1_grid, level_2_grid, level_3_grid, and level_4_grid columns of the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view when the database compatibility level is set to 100 or lower.</span></span> <span data-ttu-id="e1814-148">`GEOMETRY_AUTO_GRID` / `GEOGRAPHY_AUTO_GRID` Параметры схемы тесселяции не заполняют эти столбцы.</span><span class="sxs-lookup"><span data-stu-id="e1814-148">The `GEOMETRY_AUTO_GRID`/`GEOGRAPHY_AUTO_GRID` tessellation scheme options do not populate these columns.</span></span> <span data-ttu-id="e1814-149">представление каталога sys. spatial_index_tessellations содержит `NULL` значения для этих столбцов, если используются параметры автоматической сетки.</span><span class="sxs-lookup"><span data-stu-id="e1814-149">sys.spatial_index_tessellations catalog view has `NULL` values for these columns when the auto grid options are used.</span></span>

###  <a name="tessellation"></a><a name="tessellation"></a> <span data-ttu-id="e1814-150">Тесселяция</span><span class="sxs-lookup"><span data-stu-id="e1814-150">Tessellation</span></span>
 <span data-ttu-id="e1814-151">После декомпозиции индексированного пространства в сеточную иерархию пространственный индекс построчно считывает данные из пространственного столбца.</span><span class="sxs-lookup"><span data-stu-id="e1814-151">After decomposition of an indexed space into a grid hierarchy, the spatial index reads the data from the spatial column, row by row.</span></span> <span data-ttu-id="e1814-152">После считывания данных для пространственного объекта (или экземпляра) пространственный индекс выполняет *процесс тесселяции* для этого объекта.</span><span class="sxs-lookup"><span data-stu-id="e1814-152">After reading the data for a spatial object (or instance), the spatial index performs a *tessellation process* for that object.</span></span> <span data-ttu-id="e1814-153">Процесс тесселяции помещает объект в cеточную иерархию, устанавливая связь между ним и набором ячеек сетки, с которыми он соприкасается (*контактные ячейки*).</span><span class="sxs-lookup"><span data-stu-id="e1814-153">The tessellation processfits the object into the grid hierarchy by associating the object with a set of grid cells that it touches (*touched cells*).</span></span> <span data-ttu-id="e1814-154">Начиная с уровня 1 сеточной иерархии, процесс тесселяции сначала обрабатывает уровень *в ширину* .</span><span class="sxs-lookup"><span data-stu-id="e1814-154">Starting at level 1 of the grid hierarchy, the tessellation process proceeds *breadth first* across the level.</span></span> <span data-ttu-id="e1814-155">В принципе процесс может продолжиться для всех четырех уровней, по одному уровню за раз.</span><span class="sxs-lookup"><span data-stu-id="e1814-155">Potentially, the process can continue through all four levels, one level at a time.</span></span>

 <span data-ttu-id="e1814-156">Результатом процесса тесселяции является набор контактных ячеек, которые записываются в пространственный индекс объекта.</span><span class="sxs-lookup"><span data-stu-id="e1814-156">The output of the tessellation process is a set of touched cells that are recorded in the spatial index for the object.</span></span> <span data-ttu-id="e1814-157">Ссылаясь на эти записанные ячейки, пространственный индекс может найти объект в пространстве по его расположению относительно других объектов в пространственном столбце, которые также хранятся в индексе.</span><span class="sxs-lookup"><span data-stu-id="e1814-157">By referring to these recorded cells, the spatial index can locate the object in space relative to other objects in the spatial column that are also stored in the index.</span></span>

#### <a name="tessellation-rules"></a><span data-ttu-id="e1814-158">Правила тесселяции</span><span class="sxs-lookup"><span data-stu-id="e1814-158">Tessellation Rules</span></span>
 <span data-ttu-id="e1814-159">Чтобы ограничить число контактных ячеек, записываемых для объекта, при проведении тесселяции применяется ряд правил тесселяции.</span><span class="sxs-lookup"><span data-stu-id="e1814-159">To limit the number of touched cells that are recorded for an object, the tessellation process applies several tessellation rules.</span></span> <span data-ttu-id="e1814-160">Эти правила определяют глубину процесса тесселяции и контактные ячейки, которые записываются в индекс.</span><span class="sxs-lookup"><span data-stu-id="e1814-160">These rules determine the depth of the tessellation process and which of the touched cells are recorded in the index.</span></span>

 <span data-ttu-id="e1814-161">Ниже приведены эти правила.</span><span class="sxs-lookup"><span data-stu-id="e1814-161">These rules are as follows:</span></span>

-   <span data-ttu-id="e1814-162">Правило покрытия</span><span class="sxs-lookup"><span data-stu-id="e1814-162">The covering rule</span></span>

     <span data-ttu-id="e1814-163">Если объект полностью покрывает ячейку, говорят, что эта ячейка *накрыта* объектом.</span><span class="sxs-lookup"><span data-stu-id="e1814-163">If the object completely covers a cell, that cell is said to be *covered* by the object.</span></span> <span data-ttu-id="e1814-164">Накрытая ячейка считается и не подвергается тесселяции.</span><span class="sxs-lookup"><span data-stu-id="e1814-164">A covered cell is counted and is not tessellated.</span></span> <span data-ttu-id="e1814-165">Это правило применяется на всех уровнях сеточной иерархии.</span><span class="sxs-lookup"><span data-stu-id="e1814-165">This rule applies at all levels of the grid hierarchy.</span></span> <span data-ttu-id="e1814-166">Это правило упрощает процесс тесселяции и сокращает объем данных, записываемых в пространственный индекс.</span><span class="sxs-lookup"><span data-stu-id="e1814-166">The covering rule simplifies the tessellation process and reduces the amount of data that a spatial index records.</span></span>

-   <span data-ttu-id="e1814-167">Правило ячеек на объект</span><span class="sxs-lookup"><span data-stu-id="e1814-167">The cells-per-object rule</span></span>

     <span data-ttu-id="e1814-168">Это правило проверяет *ограничение ячеек на объект*, определяющее максимальное число ячеек, которые могут быть подсчитаны для каждого объекта, за исключением первого уровня.</span><span class="sxs-lookup"><span data-stu-id="e1814-168">This rule enforces the *cells-per-object limit*, which determines the maximum number of cells that can be counted for each object, except on level 1.</span></span> <span data-ttu-id="e1814-169">На более низких уровнях правило ячеек на объект определяет объем данных, которые могут быть записаны об объекте.</span><span class="sxs-lookup"><span data-stu-id="e1814-169">At lower levels, the cells-per-object rule controls the amount of information that can be recorded about the object.</span></span>

-   <span data-ttu-id="e1814-170">Правило самой глубокой ячейки</span><span class="sxs-lookup"><span data-stu-id="e1814-170">The deepest-cell rule</span></span>

     <span data-ttu-id="e1814-171">Правило самой глубокой ячейки создает наилучшее приближение для объекта, записывая только самые нижние ячейки, созданные при тесселяции объекта.</span><span class="sxs-lookup"><span data-stu-id="e1814-171">The deepest-cell rule generates the best approximation of an object by recording only the bottom-most cells that have been tessellated for the object.</span></span> <span data-ttu-id="e1814-172">Родительские ячейки не включаются в счетчик ячеек на объект и не записываются в индекс.</span><span class="sxs-lookup"><span data-stu-id="e1814-172">Parent cells do not contribute to the cells-per-object count, and they are not recorded in the index.</span></span>

 <span data-ttu-id="e1814-173">Эти правила тесселяции применяются рекурсивно на каждом уровне сетки.</span><span class="sxs-lookup"><span data-stu-id="e1814-173">These tessellation rules are applied recursively on each grid level.</span></span> <span data-ttu-id="e1814-174">В оставшейся части этого раздела правила тесселяции описываются более подробно.</span><span class="sxs-lookup"><span data-stu-id="e1814-174">The rest of this section describes the tessellation rules in more detail.</span></span>

#### <a name="covering-rule"></a><span data-ttu-id="e1814-175">Правило покрытия</span><span class="sxs-lookup"><span data-stu-id="e1814-175">Covering Rule</span></span>
 <span data-ttu-id="e1814-176">Если объект полностью покрывает ячейку, говорят, что эта ячейка *накрыта* объектом.</span><span class="sxs-lookup"><span data-stu-id="e1814-176">If an object completely covers a cell, that cell is said to be *covered* by the object.</span></span> <span data-ttu-id="e1814-177">Например, на следующем рисунке одна из ячеек второго уровня (15.11) полностью накрыта средней частью восьмиугольника.</span><span class="sxs-lookup"><span data-stu-id="e1814-177">For example, in the following illustration, one of the second-level cells, 15.11, is completely covered by the middle portion of an octagon.</span></span>

 <span data-ttu-id="e1814-178">![Оптимизация покрытия](../../database-engine/media/spndx-opt-covering.gif "Оптимизация покрытия")</span><span class="sxs-lookup"><span data-stu-id="e1814-178">![Covering optimization](../../database-engine/media/spndx-opt-covering.gif "Covering optimization")</span></span>

 <span data-ttu-id="e1814-179">Накрытая ячейка считается и записывается в индекс, и дальнейшая тесселяция для ячейки не проводится.</span><span class="sxs-lookup"><span data-stu-id="e1814-179">A covered cell is counted and recorded in the index, and the cell is not tessellated any further.</span></span>

#### <a name="cells-per-object-rule"></a><span data-ttu-id="e1814-180">Правило ячеек на объект</span><span class="sxs-lookup"><span data-stu-id="e1814-180">Cells-Per-Object Rule</span></span>
 <span data-ttu-id="e1814-181">Экстент тесселяции для каждого объекта в основном зависит от *ограничения ячеек на объект* в пространственном индексе.</span><span class="sxs-lookup"><span data-stu-id="e1814-181">The extent of tessellation of each object depends primarily on the *cells-per-object limit* of the spatial index.</span></span> <span data-ttu-id="e1814-182">Это ограничение определяет максимальное число ячеек, которые могут считаться в процессе тесселяции объекта.</span><span class="sxs-lookup"><span data-stu-id="e1814-182">This limit defines the maximum number of cells that tessellation can count per object.</span></span> <span data-ttu-id="e1814-183">Однако имейте в виду, что правило ячеек на объект не действует для уровня 1, поэтому данное ограничение может быть превышено.</span><span class="sxs-lookup"><span data-stu-id="e1814-183">Note, however, that the cells-per-object rule is not enforced for level 1, so it is possible to exceed this limit.</span></span> <span data-ttu-id="e1814-184">Если счет на уровне 1 достигает или превышает ограничение ячеек на объект, на нижних уровнях дальнейшая тесселяция не проводится.</span><span class="sxs-lookup"><span data-stu-id="e1814-184">If the level-1 count reaches, or exceeds, the cells-per-object limit, no further tessellation occurs at the lower levels.</span></span>

 <span data-ttu-id="e1814-185">Пока счет меньше ограничения ячеек на объект, процесс тесселяции продолжается.</span><span class="sxs-lookup"><span data-stu-id="e1814-185">As long as the count is less than the cells-per-object limit, the tessellation process continues.</span></span> <span data-ttu-id="e1814-186">Начиная с контактной ячейки с минимальным номером (например, ячейка 15.6 на предыдущем рисунке), процесс проверяет каждую ячейку и принимает решение, считать ее или проводить тесселяцию.</span><span class="sxs-lookup"><span data-stu-id="e1814-186">Starting with the lowest-number touched cell (for example, cell 15.6 in the preceding illustration), the process tests each cell to evaluate whether to count it or tessellate it.</span></span> <span data-ttu-id="e1814-187">Если при тесселяции ячейки будет превышено ограничение ячеек на объект, то ячейка будет посчитана, но тесселяция для нее проведена не будет.</span><span class="sxs-lookup"><span data-stu-id="e1814-187">If tessellating a cell would exceed the cells-per-object limit, the cell is counted and not tessellated.</span></span> <span data-ttu-id="e1814-188">В противном случае проводится тесселяция ячейки, а ячейки нижнего уровня, соприкасающиеся с объектом, считаются.</span><span class="sxs-lookup"><span data-stu-id="e1814-188">Otherwise, the cell is tessellated, and the lower-level cells that are touched by the object are counted.</span></span> <span data-ttu-id="e1814-189">Процесс тесселяции продолжается, таким образом, в ширину по всему уровню.</span><span class="sxs-lookup"><span data-stu-id="e1814-189">The tessellation process continues in this way, breadth-wise, across the level.</span></span> <span data-ttu-id="e1814-190">Этот процесс повторяется рекурсивно для сеток нижнего уровня тесселированных ячеек, пока не будет достигнуто ограничение или все ячейки не будут подсчитаны.</span><span class="sxs-lookup"><span data-stu-id="e1814-190">This process is repeated recursively for the lower-level grids of the tessellated cells until the limit is reached or there are no more cells to count.</span></span>

 <span data-ttu-id="e1814-191">Например, рассмотрим предыдущий рисунок, где восьмиугольник полностью помещается в ячейку 15 сетки уровня 1.</span><span class="sxs-lookup"><span data-stu-id="e1814-191">For example, consider the preceding illustration, which shows an octagon that fits completely into cell 15 of the level-1 grid.</span></span> <span data-ttu-id="e1814-192">На этом рисунке для ячейки 15 была проведена тесселяция, которая разбила восьмиугольник на девять ячеек уровня 2.</span><span class="sxs-lookup"><span data-stu-id="e1814-192">In the figure, cell 15 has been tessellated, dissecting the octagon into nine level-2 cells.</span></span> <span data-ttu-id="e1814-193">На рисунке предполагается, что ограничение ячеек на объект равно 9 или больше.</span><span class="sxs-lookup"><span data-stu-id="e1814-193">This illustration assumes that the cells-per-object limit is 9 or more.</span></span> <span data-ttu-id="e1814-194">Однако, если бы ограничение ячеек на объект равнялось 8 или меньше, то для ячейки 15 тесселяция бы не проводилась и для объекта считалась бы только ячейка 15.</span><span class="sxs-lookup"><span data-stu-id="e1814-194">If the cells-per-object limit were 8 or less, however, cell 15 would not be tessellated, and only that cell 15 would be counted for the object.</span></span>

 <span data-ttu-id="e1814-195">По умолчанию ограничение ячеек на объект равно 16, что обеспечивает разумный компромисс между охватом и точностью для большинства пространственных индексов.</span><span class="sxs-lookup"><span data-stu-id="e1814-195">By default, the cells-per-object limit is 16 cells per object, which provides a satisfactory trade-off between space and precision for most spatial indexes.</span></span> <span data-ttu-id="e1814-196">Однако инструкция [CREATE ПРОСТРАНСТВЕННОГО индекса](/sql/t-sql/statements/create-spatial-index-transact-sql) [!INCLUDE[tsql](../../../includes/tsql-md.md)] поддерживает предложение CELLS_PER_OBJECT `=` *n* , которое позволяет указать ограничение ячеек на объект в диапазоне от 1 до 8192 включительно.</span><span class="sxs-lookup"><span data-stu-id="e1814-196">However, the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement supports a CELLS_PER_OBJECT`=`*n* clause that enables you to specify a cells-per-object limit between 1 and 8192, inclusive.</span></span>

> [!NOTE]
>  <span data-ttu-id="e1814-197">Параметр **cells_per_object** пространственного индекса можно найти в представлении каталога [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="e1814-197">The **cells_per_object** setting of a spatial index is visible in the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="deepest-cell-rule"></a><span data-ttu-id="e1814-198">Правило самой глубокой ячейки</span><span class="sxs-lookup"><span data-stu-id="e1814-198">Deepest-Cell Rule</span></span>
 <span data-ttu-id="e1814-199">Правило самой глубокой ячейки учитывает тот факт, что каждая ячейка нижнего уровня принадлежит ячейке над ней. Ячейка уровня 4 принадлежит ячейке уровня 3, ячейка уровня 3 принадлежит ячейке уровня 2, а ячейка уровня 2 принадлежит ячейке уровня 1.</span><span class="sxs-lookup"><span data-stu-id="e1814-199">The deepest-cell rule exploits the fact that every lower-level cell belongs to the cell above it: a level-4 cell belongs to a level-3 cell, a level-3 cell belongs to a level-2 cell, and a level-2 cell belongs to a level-1 cell.</span></span> <span data-ttu-id="e1814-200">Например, объект, который относится к ячейке 1.1.1.1, также принадлежит ячейке 1.1.1, ячейке 1.1 и ячейке 1.</span><span class="sxs-lookup"><span data-stu-id="e1814-200">For example, an object that belongs to cell 1.1.1.1 also belongs to cell 1.1.1, cell 1.1, and cell 1.</span></span> <span data-ttu-id="e1814-201">Сведения о таких иерархических связях ячеек встроены в обработчик запросов.</span><span class="sxs-lookup"><span data-stu-id="e1814-201">Knowledge of such cell-hierarchy relationships is built into the query processor.</span></span> <span data-ttu-id="e1814-202">Поэтому в индекс необходимо записывать только ячейки самого нижнего уровня, минимизируя объем данных, хранящихся в индексе.</span><span class="sxs-lookup"><span data-stu-id="e1814-202">Therefore, only the deepest-level cells need to be recorded in the index, minimizing the information that the index needs to store.</span></span>

 <span data-ttu-id="e1814-203">На следующем рисунке проводится тесселяция относительно небольшого ромбовидного многоугольника.</span><span class="sxs-lookup"><span data-stu-id="e1814-203">In the following illustration, a relatively small diamond-shaped polygon is tessellated.</span></span> <span data-ttu-id="e1814-204">В индексе используется ограничение ячеек на объект, по умолчанию равное 16, которое для этого небольшого объекта не достигается.</span><span class="sxs-lookup"><span data-stu-id="e1814-204">The index uses the default cells-per-object limit of 16, which is not reached for this small object.</span></span> <span data-ttu-id="e1814-205">Таким образом, тесселяция продолжается до уровня 4.</span><span class="sxs-lookup"><span data-stu-id="e1814-205">Therefore, tessellation continues down to level 4.</span></span> <span data-ttu-id="e1814-206">Многоугольник располагается в следующих ячейках на уровнях с 1 по 3: 4, 4.4, 4.4.10 и 4.4.14.</span><span class="sxs-lookup"><span data-stu-id="e1814-206">The polygon resides in the following level-1 through level-3 cells: 4, 4.4, and 4.4.10 and 4.4.14.</span></span> <span data-ttu-id="e1814-207">Однако, согласно правилу самой глубокой ячейки, тесселяция учитывает только двенадцать ячеек на уровне 4: 4.4.10.13-15 и 4.4.14.1-3, 4.4.14.5-7 и 4.4.14.9-11.</span><span class="sxs-lookup"><span data-stu-id="e1814-207">However, using the deepest-cell rule, the tessellation counts only the twelve level-4 cells: 4.4.10.13-15 and 4.4.14.1-3, 4.4.14.5-7, and 4.4.14.9-11.</span></span>

 <span data-ttu-id="e1814-208">![Оптимизация по правилу самой глубокой ячейки](../../database-engine/media/spndx-opt-deepest-cell.gif "Оптимизация по правилу самой глубокой ячейки")</span><span class="sxs-lookup"><span data-stu-id="e1814-208">![Deepest-cell optimization](../../database-engine/media/spndx-opt-deepest-cell.gif "Deepest-cell optimization")</span></span>

###  <a name="tessellation-schemes"></a><a name="schemes"></a> <span data-ttu-id="e1814-209">Схемы тесселяции</span><span class="sxs-lookup"><span data-stu-id="e1814-209">Tessellation Schemes</span></span>
 <span data-ttu-id="e1814-210">Поведение пространственного индекса частично зависит от используемой *схемы тесселяции*.</span><span class="sxs-lookup"><span data-stu-id="e1814-210">The behavior of a spatial index depends partly on its *tessellation scheme*.</span></span> <span data-ttu-id="e1814-211">Схема тесселяции зависит от типа данных.</span><span class="sxs-lookup"><span data-stu-id="e1814-211">The tessellation scheme is data-type specific.</span></span> <span data-ttu-id="e1814-212">В [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]пространственные индексы поддерживают две схемы тесселяции.</span><span class="sxs-lookup"><span data-stu-id="e1814-212">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], spatial indexes support two tessellation schemes:</span></span>

-   <span data-ttu-id="e1814-213">*Тесселяция геометрической сетки*, которая является схемой для `geometry` типа данных.</span><span class="sxs-lookup"><span data-stu-id="e1814-213">*Geometry grid tessellation*, which is the scheme for the `geometry` data type.</span></span>

-   <span data-ttu-id="e1814-214">*Тесселяция географической сетки*, которая применяется к столбцам `geography` типа данных.</span><span class="sxs-lookup"><span data-stu-id="e1814-214">*Geography grid tessellation*, which applies to columns of the `geography` data type.</span></span>

> [!NOTE]
>  <span data-ttu-id="e1814-215">Параметр **tessellation_scheme** пространственного индекса можно найти в представлении каталога [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="e1814-215">The **tessellation_scheme** setting of a spatial index is visible in the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="geometry-grid-tessellation-scheme"></a><span data-ttu-id="e1814-216">Схема тесселяции сетки геометрических объектов</span><span class="sxs-lookup"><span data-stu-id="e1814-216">Geometry Grid Tessellation Scheme</span></span>
 <span data-ttu-id="e1814-217">Схема тесселяции GEOMETRY_AUTO_GRID используется по умолчанию для типа данных `geometry` в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] и более поздних версиях.</span><span class="sxs-lookup"><span data-stu-id="e1814-217">GEOMETRY_AUTO_GRID tessellation is the default tessellation scheme for the `geometry` data type for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and later.</span></span>  <span data-ttu-id="e1814-218">Схема тесселяции GEOMETRY_GRID является единственной доступной для геометрических типов данных в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="e1814-218">GEOMETRY_GRID tessellation is the only tessellation scheme available for geometry data types in [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="e1814-219">В этом разделе рассматриваются аспекты тесселяции сетки геометрических объектов, релевантные для пространственных индексов: поддерживаемые методы и ограничивающие прямоугольники.</span><span class="sxs-lookup"><span data-stu-id="e1814-219">This section discusses aspects of geometry grid tessellation that are relevant to working with spatial indexes: supported methods and bounding boxes.</span></span>

> [!NOTE]
>  <span data-ttu-id="e1814-220">Можно явно указать эту схему тесселяции с помощью предложения USING (GEOMETRY_AUTO_GRID/GEOMETRY_GRID) инструкции [CREATE ПРОСТРАНСТВЕННОГО индекса](/sql/t-sql/statements/create-spatial-index-transact-sql) [!INCLUDE[tsql](../../../includes/tsql-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="e1814-220">You can explicitly specify this tessellation scheme by using the USING (GEOMETRY_AUTO_GRID/GEOMETRY_GRID) clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

##### <a name="the-bounding-box"></a><span data-ttu-id="e1814-221">Ограничивающий прямоугольник</span><span class="sxs-lookup"><span data-stu-id="e1814-221">The Bounding Box</span></span>
 <span data-ttu-id="e1814-222">Геометрические данные занимают плоскость, которая может быть бесконечной.</span><span class="sxs-lookup"><span data-stu-id="e1814-222">Geometric data occupies a plane that can be infinite.</span></span> <span data-ttu-id="e1814-223">Однако в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]для пространственного индекса требуется конечное пространство.</span><span class="sxs-lookup"><span data-stu-id="e1814-223">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], however, a spatial index requires a finite space.</span></span> <span data-ttu-id="e1814-224">Для определения конечного пространства для декомпозиции схеме тесселяции сетки геометрических объектов требуется *ограничивающий прямоугольник*.</span><span class="sxs-lookup"><span data-stu-id="e1814-224">To establish a finite space for decomposition, the geometry grid tessellation scheme requires a rectangular *bounding box*.</span></span> <span data-ttu-id="e1814-225">Ограничивающий прямоугольник определяется четырьмя координатами: `(` _x-min_**,**_y-min_ `)` и `(` _x-max_**,**_y-max_ `)` , которые хранятся в виде свойств пространственного индекса.</span><span class="sxs-lookup"><span data-stu-id="e1814-225">The bounding box is defined by four coordinates, `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)`, which are stored as properties of the spatial index.</span></span> <span data-ttu-id="e1814-226">Эти координаты представляют следующее.</span><span class="sxs-lookup"><span data-stu-id="e1814-226">These coordinates represent the following:</span></span>

-   <span data-ttu-id="e1814-227">*x-min* — это координата левого нижнего угла ограничивающего прямоугольника по оси X.</span><span class="sxs-lookup"><span data-stu-id="e1814-227">*x-min* is the x-coordinate of the lower-left corner of the bounding box.</span></span>

-   <span data-ttu-id="e1814-228">*y-min* — это координата левого нижнего угла по оси Y.</span><span class="sxs-lookup"><span data-stu-id="e1814-228">*y-min* is the y-coordinate of the lower-left corner.</span></span>

-   <span data-ttu-id="e1814-229">*x-max* — это координата верхнего правого угла по оси X.</span><span class="sxs-lookup"><span data-stu-id="e1814-229">*x-max* is the x-coordinate of the upper-right corner.</span></span>

-   <span data-ttu-id="e1814-230">*y-max* — это координата верхнего правого угла по оси Y.</span><span class="sxs-lookup"><span data-stu-id="e1814-230">*y-max* is the y-coordinate of upper-right corner.</span></span>

> [!NOTE]
>  <span data-ttu-id="e1814-231">Эти координаты задаются предложением BOUNDING_BOX инструкции [CREATE ПРОСТРАНСТВЕННОГО индекса](/sql/t-sql/statements/create-spatial-index-transact-sql) [!INCLUDE[tsql](../../../includes/tsql-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="e1814-231">These coordinates are specified by the BOUNDING_BOX clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

 <span data-ttu-id="e1814-232">Координаты `(` _x-min_**,**_y-min_ `)` и `(` _x-max_**,**_y-max_ `)` определяют размещение и размеры ограничивающего прямоугольника.</span><span class="sxs-lookup"><span data-stu-id="e1814-232">The `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)` coordinates determine the placement and dimensions of the bounding box.</span></span> <span data-ttu-id="e1814-233">Пространство за пределами ограничивающего прямоугольника считается одной ячейкой с номером 0.</span><span class="sxs-lookup"><span data-stu-id="e1814-233">The space outside of the bounding box is treated as a single cell that is numbered 0.</span></span>

 <span data-ttu-id="e1814-234">В пространственном индексе проводится декомпозиция пространства внутри ограничивающего прямоугольника.</span><span class="sxs-lookup"><span data-stu-id="e1814-234">The spatial index decomposes the space inside the bounding box.</span></span> <span data-ttu-id="e1814-235">Сетка уровня 1 сеточной иерархии заполняет ограничивающий прямоугольник.</span><span class="sxs-lookup"><span data-stu-id="e1814-235">The level-1 grid of the grid hierarchy fills the bounding box.</span></span> <span data-ttu-id="e1814-236">Чтобы поместить геометрический объект в сеточную иерархию, пространственный индекс сравнивает координаты объекта с координатами ограничивающего прямоугольника.</span><span class="sxs-lookup"><span data-stu-id="e1814-236">To place a geometric object in the grid hierarchy, the spatial index compares the coordinates of the object to the bounding-box coordinates.</span></span>

 <span data-ttu-id="e1814-237">На следующем рисунке показаны точки, определяемые `(` координатами _x-min_**,**_y-min_ `)` и `(` _x-max_**,**_y-max_ `)` ограничивающего прямоугольника.</span><span class="sxs-lookup"><span data-stu-id="e1814-237">The following illustration shows the points defined by the `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)` coordinates of the bounding box.</span></span> <span data-ttu-id="e1814-238">Верхний уровень сеточной иерархии показан как решетка 4x4.</span><span class="sxs-lookup"><span data-stu-id="e1814-238">The top-level of the grid hierarchy is shown as a 4x4 grid.</span></span> <span data-ttu-id="e1814-239">На данном рисунке нижние уровни опущены.</span><span class="sxs-lookup"><span data-stu-id="e1814-239">For the purpose of illustration, the lower levels are omitted.</span></span> <span data-ttu-id="e1814-240">Пространство за пределами ограничивающего прямоугольника обозначается нулем (0).</span><span class="sxs-lookup"><span data-stu-id="e1814-240">The space outside of the bounding box is indicated by a zero (0).</span></span> <span data-ttu-id="e1814-241">Обратите внимание, что объект A частично выходит за пределы ограничивающего прямоугольника, а объект B находится полностью вне прямоугольника в ячейке 0.</span><span class="sxs-lookup"><span data-stu-id="e1814-241">Note that object 'A' extends partly beyond the box, and object 'B' lies completely outside the box in cell 0.</span></span>

 <span data-ttu-id="e1814-242">![Ограничивающий прямоугольник, показывающий координаты и ячейку 0.](../../database-engine/media/spndx-bb-4x4-objects.gif "Ограничивающий прямоугольник, показывающий координаты и ячейку 0.")</span><span class="sxs-lookup"><span data-stu-id="e1814-242">![Bounding box showing coordinates and cell 0.](../../database-engine/media/spndx-bb-4x4-objects.gif "Bounding box showing coordinates and cell 0.")</span></span>

 <span data-ttu-id="e1814-243">Ограничивающий прямоугольник относится к некоторой части пространственных данных приложения.</span><span class="sxs-lookup"><span data-stu-id="e1814-243">A bounding box corresponds to some portion of an application's spatial data.</span></span> <span data-ttu-id="e1814-244">Приложение само определяет, будет ли ограничивающий прямоугольник индекса полностью включать данные из пространственного столбца или только их часть.</span><span class="sxs-lookup"><span data-stu-id="e1814-244">Whether the bounding-box of the index completely contains the data stored in the spatial column, or only contains a portion, is up to the application.</span></span> <span data-ttu-id="e1814-245">Пространственный индекс имеет смысл использовать только для операций с объектами, полностью находящимися внутри ограничивающего прямоугольника.</span><span class="sxs-lookup"><span data-stu-id="e1814-245">Only operations computed on objects that are entirely inside of the bounding box benefit from the spatial index.</span></span> <span data-ttu-id="e1814-246">Поэтому для максимально эффективного использования пространственного индекса по столбцу `geometry` необходимо указать ограничивающий прямоугольник, содержащий все объекты или большинство из них.</span><span class="sxs-lookup"><span data-stu-id="e1814-246">Therefore, to gain the greatest advantage from a spatial index on a `geometry` column, you need to specify a bounding-box that contains all or most of the objects.</span></span>

> [!NOTE]
>  <span data-ttu-id="e1814-247">Плотности сеток в пространственном индексе можно просмотреть в столбцах bounding_box_xmin, bounding_box_ymin, bounding_box_xmax и bounding_box_ymax представления каталога [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="e1814-247">The grid densities of a spatial index are visible in the bounding_box_xmin, bounding_box_ymin, bounding_box_xmax, and bounding_box_ymax columns of the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="the-geography-grid-tessellation-scheme"></a><span data-ttu-id="e1814-248">Схема тесселяции сетки географических объектов</span><span class="sxs-lookup"><span data-stu-id="e1814-248">The Geography Grid Tessellation Scheme</span></span>
 <span data-ttu-id="e1814-249">Эта схема тесселяции применяется только к столбцу `geography`.</span><span class="sxs-lookup"><span data-stu-id="e1814-249">This tessellation scheme applies only to a `geography` column.</span></span> <span data-ttu-id="e1814-250">В этом разделе рассматриваются методы, поддерживаемые тесселяцией географических объектов, и описывается, как геодезическое пространство проецируется на плоскость, которая затем подвергается декомпозиции в сеточную иерархию.</span><span class="sxs-lookup"><span data-stu-id="e1814-250">This section summarizes the methods that are supported by geography grid tessellation and discusses how geodetic space is projected onto a plane, which is then decomposed into a grid hierarchy.</span></span>

> [!NOTE]
>  <span data-ttu-id="e1814-251">Можно явно указать эту схему тесселяции с помощью предложения USING (GEOGRAPHY_AUTO_GRID/GEOGRAPHY_GRID) инструкции [CREATE ПРОСТРАНСТВЕННОГО индекса](/sql/t-sql/statements/create-spatial-index-transact-sql) [!INCLUDE[tsql](../../../includes/tsql-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="e1814-251">You can explicitly specify this tessellation scheme by using the USING (GEOGRAPHY_AUTO_GRID/GEOGRAPHY_GRID) clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

##### <a name="projection-of-the-geodetic-space-onto-a-plane"></a><span data-ttu-id="e1814-252">Проекция геодезического пространства на плоскость</span><span class="sxs-lookup"><span data-stu-id="e1814-252">Projection of the Geodetic Space onto a Plane</span></span>
 <span data-ttu-id="e1814-253">При вычислениях с экземплярами `geography` (объектами) пространство, содержащее объекты, считается геодезическим эллипсоидом.</span><span class="sxs-lookup"><span data-stu-id="e1814-253">Computations on `geography` instances (objects) treat the space containing the objects as a geodetic ellipsoid.</span></span> <span data-ttu-id="e1814-254">Для декомпозиции этого пространства схема тесселяции сетки географических объектов разделяет эллипсоид на верхнюю и нижнюю полушария, а затем выполняет следующие шаги.</span><span class="sxs-lookup"><span data-stu-id="e1814-254">To decompose this space, the geography grid tessellation scheme divides the surface of the ellipsoid into its upper and lower hemispheres and then performs the following steps:</span></span>

1.  <span data-ttu-id="e1814-255">Проецирует каждое полушарие на грани четырехсторонней пирамиды.</span><span class="sxs-lookup"><span data-stu-id="e1814-255">Projects each hemisphere onto the facets of a quadrilateral pyramid.</span></span>

2.  <span data-ttu-id="e1814-256">Делает обе пирамиды плоскими.</span><span class="sxs-lookup"><span data-stu-id="e1814-256">Flattens the two pyramids.</span></span>

3.  <span data-ttu-id="e1814-257">Соединяет плоские пирамиды для создания неевклидовой плоскости.</span><span class="sxs-lookup"><span data-stu-id="e1814-257">Joins the flattened pyramids to form a non-Euclidean plane.</span></span>

 <span data-ttu-id="e1814-258">На следующем рисунке показано схематическое представление трехэтапного процесса декомпозиции.</span><span class="sxs-lookup"><span data-stu-id="e1814-258">The following illustration shows a schematic view of the three-step decomposition process.</span></span> <span data-ttu-id="e1814-259">В пирамидах пунктирные линии представляют границы четырех граней каждой пирамиды.</span><span class="sxs-lookup"><span data-stu-id="e1814-259">In the pyramids, the dotted lines represent the boundaries of the four facets of each pyramid.</span></span> <span data-ttu-id="e1814-260">На шагах 1 и 2 показан геодезический эллипсоид, зеленая горизонтальная линия представляет экваториальную долготу, а ряд зеленых вертикальных линий представляют несколько широт.</span><span class="sxs-lookup"><span data-stu-id="e1814-260">Steps 1 and 2 illustrate the geodetic ellipsoid, using a green horizontal line to represent the equatorial longitude line and a series of green vertical lines to represent several latitude lines.</span></span> <span data-ttu-id="e1814-261">На шаге 1 показано проецирование двух полушарий на пирамиды.</span><span class="sxs-lookup"><span data-stu-id="e1814-261">Step 1 shows the pyramids being projected over the two hemispheres.</span></span> <span data-ttu-id="e1814-262">На шаге 2 показано уплощение пирамид.</span><span class="sxs-lookup"><span data-stu-id="e1814-262">Step 2 shows the pyramids being flattened.</span></span> <span data-ttu-id="e1814-263">На шаге 3 показаны плоские пирамиды после их объединения в плоскость и число спроецированных линий долготы.</span><span class="sxs-lookup"><span data-stu-id="e1814-263">Step 3 illustrates the flattened pyramids, after they have been combined to form a plane, showing a number of projected longitude lines.</span></span> <span data-ttu-id="e1814-264">Обратите внимание, что эти спроецированные линии выпрямлены и различаются по длине в зависимости от места проецирования на пирамиду.</span><span class="sxs-lookup"><span data-stu-id="e1814-264">Notice that these projected lines are straightened and vary in length, depending on where they fall on the pyramids.</span></span>

 <span data-ttu-id="e1814-265">![Проекция эллипсоида на плоскость](../../database-engine/media/spndx-geodetic-projection.gif "Проекция эллипсоида на плоскость")</span><span class="sxs-lookup"><span data-stu-id="e1814-265">![Projection of the ellipsoid onto a plane](../../database-engine/media/spndx-geodetic-projection.gif "Projection of the ellipsoid onto a plane")</span></span>

 <span data-ttu-id="e1814-266">После проецирования пространства на плоскость проводится ее декомпозиция в четырехуровневую сеточную иерархию.</span><span class="sxs-lookup"><span data-stu-id="e1814-266">Once the space has been projected onto the plane, the plane is decomposed into the four-level grid hierarchy.</span></span> <span data-ttu-id="e1814-267">На разных уровнях могут использоваться разные плотности сетки.</span><span class="sxs-lookup"><span data-stu-id="e1814-267">Different levels can use different grid densities.</span></span> <span data-ttu-id="e1814-268">На следующем рисунке показана плоскость после ее декомпозиции в сетку 4x4 уровня 1.</span><span class="sxs-lookup"><span data-stu-id="e1814-268">The following illustration shows the plane after it has been decomposed into a 4x4 level-1 grid.</span></span> <span data-ttu-id="e1814-269">На данном рисунке нижние уровни сеточной иерархии опущены.</span><span class="sxs-lookup"><span data-stu-id="e1814-269">For the purposes of illustration, the lower-levels of the grid hierarchy are omitted.</span></span> <span data-ttu-id="e1814-270">На самом деле плоскость подвергается полной декомпозиции в четырехуровневую сеточную иерархию.</span><span class="sxs-lookup"><span data-stu-id="e1814-270">In actuality, the plane is fully decomposed into a four-level grid hierarchy.</span></span> <span data-ttu-id="e1814-271">После окончания декомпозиции географические данные из столбца geography считываются по строкам, и для каждого объекта выполняется процедура тесселяции.</span><span class="sxs-lookup"><span data-stu-id="e1814-271">After the decomposition process finishes, the geographic data is read, row by row, from the geography column, and the tessellation process is performed for each object in turn.</span></span>

 <span data-ttu-id="e1814-272">![Географическая сетка уровня 1](../../database-engine/media/spndx-geodetic-level1grid.gif "Географическая сетка уровня 1")</span><span class="sxs-lookup"><span data-stu-id="e1814-272">![Level-1 geography grid](../../database-engine/media/spndx-geodetic-level1grid.gif "Level-1 geography grid")</span></span>

##  <a name="methods-supported-by-spatial-indexes"></a><a name="methods"></a><span data-ttu-id="e1814-273">Методы, поддерживаемые пространственными индексами</span><span class="sxs-lookup"><span data-stu-id="e1814-273">Methods Supported by Spatial Indexes</span></span>

###  <a name="geometry-methods-supported-by-spatial-indexes"></a><a name="geometry"></a><span data-ttu-id="e1814-274">Геометрические методы, поддерживаемые пространственными индексами</span><span class="sxs-lookup"><span data-stu-id="e1814-274">Geometry Methods Supported by Spatial Indexes</span></span>
 <span data-ttu-id="e1814-275">При определенных условиях пространственные индексы поддерживают следующие геометрические методы на основе наборов: STContains(), STDistance(), STEquals(), STIntersects(), STOverlaps(), STTouches() и STWithin().</span><span class="sxs-lookup"><span data-stu-id="e1814-275">Spatial indexes support the following set-oriented geometry methods under certain conditions: STContains(), STDistance(), STEquals(), STIntersects(), STOverlaps(), STTouches(), and STWithin().</span></span> <span data-ttu-id="e1814-276">Чтобы пространственный индекс поддерживал эти методы, в запросе их необходимо использовать в пределах предложения WHERE или JOIN ON, включив в состав предиката следующего общего вида:</span><span class="sxs-lookup"><span data-stu-id="e1814-276">To be supported by a spatial index, these methods must be used within the WHERE or JOIN ON clause of a query, and they must occur within a predicate of the following general form:</span></span>

 <span data-ttu-id="e1814-277">*Geometry1*. *method_name*(*Geometry2*)*comparison_operator \* \* valid_number*</span><span class="sxs-lookup"><span data-stu-id="e1814-277">*geometry1*.*method_name*(*geometry2*)*comparison_operator\*\*valid_number*</span></span>

 <span data-ttu-id="e1814-278">Чтобы получить ненулевой результат, аргументы *geometry1* и *geometry2* должны иметь одинаковый [идентификатор пространственной ссылки (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span><span class="sxs-lookup"><span data-stu-id="e1814-278">To return a non-null result, *geometry1* and *geometry2* must have the same [spatial reference identifier (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span></span> <span data-ttu-id="e1814-279">В противном случае метод возвращает значение NULL.</span><span class="sxs-lookup"><span data-stu-id="e1814-279">Otherwise, the method returns NULL.</span></span>

 <span data-ttu-id="e1814-280">Пространственные индексы поддерживают предикаты следующих форм:</span><span class="sxs-lookup"><span data-stu-id="e1814-280">Spatial indexes support the following predicate forms:</span></span>

-   <span data-ttu-id="e1814-281">*geometry1*.[STContains](/sql/t-sql/spatial-geometry/stcontains-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="e1814-281">*geometry1*.[STContains](/sql/t-sql/spatial-geometry/stcontains-geometry-data-type)(*geometry2*) = 1</span></span>

-   <span data-ttu-id="e1814-282">*Geometry1*. [STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) *номер* <</span><span class="sxs-lookup"><span data-stu-id="e1814-282">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) < *number*</span></span>

-   <span data-ttu-id="e1814-283">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <= *номер*</span><span class="sxs-lookup"><span data-stu-id="e1814-283">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <= *number*</span></span>

-   <span data-ttu-id="e1814-284">*geometry1*.[STEquals](/sql/t-sql/spatial-geometry/stequals-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="e1814-284">*geometry1*.[STEquals](/sql/t-sql/spatial-geometry/stequals-geometry-data-type)(*geometry2*)= 1</span></span>

-   <span data-ttu-id="e1814-285">*geometry1*.[STIntersects](/sql/t-sql/spatial-geometry/stintersects-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="e1814-285">*geometry1*.[STIntersects](/sql/t-sql/spatial-geometry/stintersects-geometry-data-type)(*geometry2*)= 1</span></span>

-   <span data-ttu-id="e1814-286">*geometry1.*</span><span class="sxs-lookup"><span data-stu-id="e1814-286">*geometry1.*</span></span> <span data-ttu-id="e1814-287">[STOverlaps](/sql/t-sql/spatial-geometry/stoverlaps-geometry-data-type) *(geometry2) = 1*</span><span class="sxs-lookup"><span data-stu-id="e1814-287">[STOverlaps](/sql/t-sql/spatial-geometry/stoverlaps-geometry-data-type) *(geometry2) = 1*</span></span>

-   <span data-ttu-id="e1814-288">*geometry1*.[STTouches](/sql/t-sql/spatial-geometry/sttouches-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="e1814-288">*geometry1*.[STTouches](/sql/t-sql/spatial-geometry/sttouches-geometry-data-type)(*geometry2*) = 1</span></span>

-   <span data-ttu-id="e1814-289">*geometry1*.[STWithin](/sql/t-sql/spatial-geometry/stwithin-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="e1814-289">*geometry1*.[STWithin](/sql/t-sql/spatial-geometry/stwithin-geometry-data-type)(*geometry2*)= 1</span></span>

###  <a name="geography-methods-supported-by-spatial-indexes"></a><a name="geography"></a><span data-ttu-id="e1814-290">Географические методы, поддерживаемые пространственными индексами</span><span class="sxs-lookup"><span data-stu-id="e1814-290">Geography Methods Supported by Spatial Indexes</span></span>
 <span data-ttu-id="e1814-291">При определенных условиях пространственные индексы поддерживают следующие географические методы для работы с наборами: STIntersects(),STEquals(), and STDistance().</span><span class="sxs-lookup"><span data-stu-id="e1814-291">Under certain conditions, spatial indexes support the following set-oriented geography methods: STIntersects(),STEquals(), and STDistance().</span></span> <span data-ttu-id="e1814-292">Чтобы пространственный индекс поддерживал эти методы, их необходимо использовать в предложении WHERE запроса, включив в состав предиката следующего общего вида:</span><span class="sxs-lookup"><span data-stu-id="e1814-292">To be supported by a spatial index, these methods must be used within the WHERE clause of a query, and they must occur within a predicate of the following general form:</span></span>

 <span data-ttu-id="e1814-293">*geography1*. *method_name*(*geography2*)*comparison_operator \* \* valid_number*</span><span class="sxs-lookup"><span data-stu-id="e1814-293">*geography1*.*method_name*(*geography2*)*comparison_operator\*\*valid_number*</span></span>

 <span data-ttu-id="e1814-294">Чтобы получить ненулевой результат, аргументы *geography1* и *geography2* должны иметь одинаковый [идентификатор пространственной ссылки (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span><span class="sxs-lookup"><span data-stu-id="e1814-294">To return a non-null result, *geography1* and *geography2* must have the same [Spatial Reference Identifier (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span></span> <span data-ttu-id="e1814-295">В противном случае метод возвращает значение NULL.</span><span class="sxs-lookup"><span data-stu-id="e1814-295">Otherwise, the method returns NULL.</span></span>

 <span data-ttu-id="e1814-296">Пространственные индексы поддерживают предикаты следующих форм:</span><span class="sxs-lookup"><span data-stu-id="e1814-296">Spatial indexes support the following predicate forms:</span></span>

-   <span data-ttu-id="e1814-297">*geography1*.[STIntersects](/sql/t-sql/spatial-geography/stintersects-geography-data-type)(*geography2*)= 1</span><span class="sxs-lookup"><span data-stu-id="e1814-297">*geography1*.[STIntersects](/sql/t-sql/spatial-geography/stintersects-geography-data-type)(*geography2*)= 1</span></span>

-   <span data-ttu-id="e1814-298">*geography1*.[STEquals](/sql/t-sql/spatial-geography/stequals-geography-data-type)(*geography2*)= 1</span><span class="sxs-lookup"><span data-stu-id="e1814-298">*geography1*.[STEquals](/sql/t-sql/spatial-geography/stequals-geography-data-type)(*geography2*)= 1</span></span>

-   <span data-ttu-id="e1814-299">*geography1*. [STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) *номер* <</span><span class="sxs-lookup"><span data-stu-id="e1814-299">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) < *number*</span></span>

-   <span data-ttu-id="e1814-300">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <= *номер*</span><span class="sxs-lookup"><span data-stu-id="e1814-300">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <= *number*</span></span>

### <a name="queries-that-use-spatial-indexes"></a><span data-ttu-id="e1814-301">Запросы, использующие пространственные индексы</span><span class="sxs-lookup"><span data-stu-id="e1814-301">Queries that use Spatial Indexes</span></span>
 <span data-ttu-id="e1814-302">Пространственные индексы поддерживаются только в запросах, содержащих оператор пространственного индекса в предложении `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="e1814-302">Spatial indexes are only supported in queries that include an indexed spatial operator in the `WHERE` clause.</span></span> <span data-ttu-id="e1814-303">Пример синтаксиса.</span><span class="sxs-lookup"><span data-stu-id="e1814-303">For example syntax such as:</span></span>

```
[spatial object].SpatialMethod([reference spatial object]) [ = | < ] [const literal or variable]
```

 <span data-ttu-id="e1814-304">Оптимизатор запросов учитывает коммутативность пространственных операций (что `@a.STIntersects(@b) = @b.STInterestcs(@a)` ).</span><span class="sxs-lookup"><span data-stu-id="e1814-304">The query optimizer understands the commutativity of spatial operations (that `@a.STIntersects(@b) = @b.STInterestcs(@a)` ).</span></span> <span data-ttu-id="e1814-305">Однако пространственный индекс не будет использоваться, если в начале сравнения нет пространственного оператора (например, `WHERE 1 = spatial op` не будет использовать пространственный индекс).</span><span class="sxs-lookup"><span data-stu-id="e1814-305">However, the spatial index will not be used if the beginning of a comparison does not contain the spatial operator (for example `WHERE 1 = spatial op` will not use the spatial index).</span></span> <span data-ttu-id="e1814-306">Для использования пространственного индекса перепишите сравнение (например, `WHERE spatial op = 1`).</span><span class="sxs-lookup"><span data-stu-id="e1814-306">To use the spatial index, rewrite the comparison (for example `WHERE spatial op = 1`).</span></span>

 <span data-ttu-id="e1814-307">Как и при использовании любого другого индекса, если пространственный индекс поддерживается, то решение его использовать принимается, исходя из затрат, поэтому оптимизатор запросов может не принять решение об использовании, даже если для этого соблюдены все требования.</span><span class="sxs-lookup"><span data-stu-id="e1814-307">As with any other index, when a spatial index is supported, the use of the spatial index is chosen based on cost, so the query optimizer might not choose to use the spatial index even though all requirements for using it are met.</span></span> <span data-ttu-id="e1814-308">Используйте инструкции showplan, чтобы определить, использовался ли пространственный индекс и нужно ли предоставлять указания для принудительного использования плана запроса.</span><span class="sxs-lookup"><span data-stu-id="e1814-308">Use showplan to see if the spatial index was used and if necessary provide query hints to force a desired query plan.</span></span>

 <span data-ttu-id="e1814-309">Ближайший соседний тип запроса также поддерживает пространственные индексы, но только если используется определенный синтаксис запроса.</span><span class="sxs-lookup"><span data-stu-id="e1814-309">The nearest neighbor type of query also supports spatial indexes however only if a specific query syntax is written.</span></span> <span data-ttu-id="e1814-310">Правильный синтаксис:</span><span class="sxs-lookup"><span data-stu-id="e1814-310">The appropriate syntax is:</span></span>

```
SELECT TOP(K) [WITH TIES] * 
FROM <Table> AS T [WITH(INDEX(<SpatialIndex>))]
WHERE <SpatialColumn>.STDistance(@reference_object) IS NOT NULL
ORDER BY <SpatialColumn>.STDistance(@reference_object) [;]
```

## <a name="see-also"></a><span data-ttu-id="e1814-311">См. также:</span><span class="sxs-lookup"><span data-stu-id="e1814-311">See Also</span></span>
 [<span data-ttu-id="e1814-312">Пространственные данные (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e1814-312">Spatial Data &#40;SQL Server&#41;</span></span>](../spatial/spatial-data-sql-server.md)


