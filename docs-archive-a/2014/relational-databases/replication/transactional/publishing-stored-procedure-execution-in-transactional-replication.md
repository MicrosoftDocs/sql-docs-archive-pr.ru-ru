---
title: Публикация выполнения хранимых процедур в репликации транзакций | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- publishing [SQL Server replication], stored procedure execution
- articles [SQL Server replication], stored procedures and
- transactional replication, publishing stored procedure execution
ms.assetid: f4686f6f-c224-4f07-a7cb-92f4dd483158
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0fb5c40db46772cabcb5d1df19e03aced749e1c6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87738186"
---
# <a name="publishing-stored-procedure-execution-in-transactional-replication"></a><span data-ttu-id="91894-102">Публикация выполнения хранимых процедур в репликации транзакций</span><span class="sxs-lookup"><span data-stu-id="91894-102">Publishing Stored Procedure Execution in Transactional Replication</span></span>
  <span data-ttu-id="91894-103">Если существует одна или несколько хранимых процедур, выполняемых на издателе и влияющих на опубликованные таблицы, рассмотрите возможность включения в публикацию этих хранимых процедур в виде статей выполнения хранимых процедур.</span><span class="sxs-lookup"><span data-stu-id="91894-103">If you have one or more stored procedures that execute at the Publisher and affect published tables, consider including those stored procedures in your publication as stored procedure execution articles.</span></span> <span data-ttu-id="91894-104">Определение процедуры (инструкция CREATE PROCEDURE) реплицируется на подписчик при инициализации подписки. Когда процедура выполняется на издателе, репликация выполняет соответствующую процедуру на подписчике.</span><span class="sxs-lookup"><span data-stu-id="91894-104">The definition of the procedure (the CREATE PROCEDURE statement) is replicated to the Subscriber when the subscription is initialized; when the procedure is executed at the Publisher, replication executes the corresponding procedure at the Subscriber.</span></span> <span data-ttu-id="91894-105">Это может обеспечить значительное повышение производительности в случаях, когда выполняются крупные пакетные операции, поскольку реплицируется только выполнение процедуры и исключается необходимость репликации отдельных изменений для каждой строки.</span><span class="sxs-lookup"><span data-stu-id="91894-105">This can provide significantly better performance for cases where large batch operations are performed, because only the procedure execution is replicated, bypassing the need to replicate the individual changes for each row.</span></span> <span data-ttu-id="91894-106">Например, предположим, что создана следующая хранимая процедура в базе данных публикации:</span><span class="sxs-lookup"><span data-stu-id="91894-106">For example, assume you create the following stored procedure in the publication database:</span></span>  
  
```  
CREATE PROC give_raise AS  
UPDATE EMPLOYEES SET salary = salary * 1.10  
```  
  
 <span data-ttu-id="91894-107">Процедура на 10 процентов увеличивает зарплату каждого из 10000 сотрудников компании.</span><span class="sxs-lookup"><span data-stu-id="91894-107">This procedure gives each of the 10,000 employees in your company a 10 percent pay increase.</span></span> <span data-ttu-id="91894-108">При выполнении этой хранимой процедуры на издателе, обновляется зарплата для каждого сотрудника.</span><span class="sxs-lookup"><span data-stu-id="91894-108">When you execute this stored procedure at the Publisher, it updates the salary for each employee.</span></span> <span data-ttu-id="91894-109">Без репликации выполнения хранимой процедуры обновление будет отправлено подписчикам в виде большой многошаговой транзакции:</span><span class="sxs-lookup"><span data-stu-id="91894-109">Without the replication of stored procedure execution, the update would be sent to Subscribers as a large, multi-step transaction:</span></span>  
  
```  
BEGIN TRAN  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 1'  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 2'  
```  
  
 <span data-ttu-id="91894-110">Это повторится для всех 10000 обновлений.</span><span class="sxs-lookup"><span data-stu-id="91894-110">And this repeats for 10,000 updates.</span></span>  
  
 <span data-ttu-id="91894-111">С помощью репликации выполнения хранимой процедуры отправляется только команда для выполнения хранимой процедуры на подписчике вместо записи всех обновлений в базу данных распространителя и последующей отправки этих значений по сети на подписчик:</span><span class="sxs-lookup"><span data-stu-id="91894-111">With the replication of stored procedure execution, replication sends only the command to execute the stored procedure at the Subscriber, rather than writing all the updates to the distribution database and then sending them over the network to the Subscriber:</span></span>  
  
```  
EXEC give_raise  
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="91894-112">Репликация хранимых процедур подходит не для всех приложений.</span><span class="sxs-lookup"><span data-stu-id="91894-112">Stored procedure replication is not appropriate for all applications.</span></span> <span data-ttu-id="91894-113">Если статья отфильтрована горизонтально так, что наборы строк на издателе и подписчике различаются, выполнение одной и той же хранимой процедуры на каждом из них приведет к разным результатам.</span><span class="sxs-lookup"><span data-stu-id="91894-113">If an article is filtered horizontally, so that there are different sets of rows at the Publisher than at the Subscriber, executing the same stored procedure at both returns different results.</span></span> <span data-ttu-id="91894-114">Аналогично, если обновления основаны на вложенных запросах другой, нереплицируемой таблицы, выполнение одной и той же хранимой процедуры на подписчике и на издателе приведет к разным результатам.</span><span class="sxs-lookup"><span data-stu-id="91894-114">Similarly, if an update is based on a subquery of another, nonreplicated table, executing the same stored procedure at both the Publisher and Subscriber returns different results.</span></span>  
  
 <span data-ttu-id="91894-115">**Публикация выполнения хранимой процедуры**</span><span class="sxs-lookup"><span data-stu-id="91894-115">**To publish the execution of a stored procedure**</span></span>  
  
-   <span data-ttu-id="91894-116">SQL Server Management Studio: [Публикация выполнения хранимой процедуры в публикации транзакций (среда SQL Server Management Studio)](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span><span class="sxs-lookup"><span data-stu-id="91894-116">SQL Server Management Studio: [Publish the Execution of a Stored Procedure in a Transactional Publication &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span></span>  
  
-   <span data-ttu-id="91894-117">Программирование репликации на языке Transact-SQL: выполните [sp_addarticle &#40;Transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) и укажите для параметра значение "Serializable proc exec" (рекомендуется) или "proc exec" **@type** .</span><span class="sxs-lookup"><span data-stu-id="91894-117">Replication Transact-SQL Programming: execute [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) and specify a value of 'serializable proc exec' (recommended) or 'proc exec' for the parameter **@type**.</span></span> <span data-ttu-id="91894-118">Дополнительные сведения об определении статей см. в [этой статье](../publish/define-an-article.md).</span><span class="sxs-lookup"><span data-stu-id="91894-118">For more information about defining articles, see [Define an Article](../publish/define-an-article.md).</span></span>  
  
## <a name="modifying-the-procedure-at-the-subscriber"></a><span data-ttu-id="91894-119">Изменение процедуры на подписчике</span><span class="sxs-lookup"><span data-stu-id="91894-119">Modifying the Procedure at the Subscriber</span></span>  
 <span data-ttu-id="91894-120">По умолчанию определение хранимой процедуры на издателе отправляется каждому подписчику.</span><span class="sxs-lookup"><span data-stu-id="91894-120">By default, the stored procedure definition at the Publisher is propagated to each Subscriber.</span></span> <span data-ttu-id="91894-121">Тем не менее хранимую процедуру можно также изменить на подписчике.</span><span class="sxs-lookup"><span data-stu-id="91894-121">However, you can also modify the stored procedure at the Subscriber.</span></span> <span data-ttu-id="91894-122">Эта возможность используется, когда требуется разная логика для выполнения процедуры на подписчике и на издателе.</span><span class="sxs-lookup"><span data-stu-id="91894-122">This is useful if you want different logic to be executed at the Publisher and Subscriber.</span></span> <span data-ttu-id="91894-123">В качестве примера рассмотрим **sp_big_delete**, хранимую процедуру на издателе, которая выполняет две функции: процедура удаляет 1 000 000 строк из реплицируемой таблицы **big_table1** и обновляет нереплицируемую таблицу **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="91894-123">For example, consider **sp_big_delete**, a stored procedure at the Publisher that has two functions: it deletes 1,000,000 rows from the replicated table **big_table1** and updates the nonreplicated table **big_table2**.</span></span> <span data-ttu-id="91894-124">Чтобы уменьшить необходимый объем сетевых ресурсов, следует передать удаление 1 миллиона строк в виде хранимой процедуры посредством публикации **sp_big_delete**.</span><span class="sxs-lookup"><span data-stu-id="91894-124">To reduce the demand on network resources, you should propagate the 1 million row delete as a stored procedure by publishing **sp_big_delete**.</span></span> <span data-ttu-id="91894-125">На подписчике можно изменить хранимую процедуру **sp_big_delete** , чтобы удалить только 1 миллион строк, но не выполнять последующее обновление таблицы **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="91894-125">At the Subscriber, you can modify **sp_big_delete** to delete only the 1 million rows and not perform the subsequent update to **big_table2**.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="91894-126">По умолчанию любые изменения, совершенные с помощью инструкции ALTER PROCEDURE на издателе, передаются подписчику.</span><span class="sxs-lookup"><span data-stu-id="91894-126">By default, any changes made using ALTER PROCEDURE at the Publisher are propagated to the Subscriber.</span></span> <span data-ttu-id="91894-127">Чтобы предотвратить это, необходимо отключить распространение изменений схемы перед выполнением инструкции ALTER PROCEDURE.</span><span class="sxs-lookup"><span data-stu-id="91894-127">To prevent this, disable the propagation of schema changes before executing ALTER PROCEDURE.</span></span> <span data-ttu-id="91894-128">Сведения об изменениях в схеме см. в разделе [Внесение изменений в схемы баз данных публикации](../publish/make-schema-changes-on-publication-databases.md).</span><span class="sxs-lookup"><span data-stu-id="91894-128">For information about schema changes, see [Make Schema Changes on Publication Databases](../publish/make-schema-changes-on-publication-databases.md).</span></span>  
  
## <a name="types-of-stored-procedure-execution-articles"></a><span data-ttu-id="91894-129">Типы статей выполнения хранимых процедур</span><span class="sxs-lookup"><span data-stu-id="91894-129">Types of Stored Procedure Execution Articles</span></span>  
 <span data-ttu-id="91894-130">Существует два разных способа публикации выполнения хранимой процедуры: сериализуемая статья выполнения процедуры и статья выполнения процедуры.</span><span class="sxs-lookup"><span data-stu-id="91894-130">There are two different ways in which the execution of a stored procedure can be published: serializable procedure execution article and procedure execution article.</span></span>  
  
-   <span data-ttu-id="91894-131">Рекомендуется использовать сериализуемый вариант процедуры, поскольку для него выполнение процедуры реплицируется только в том случае, когда процедура выполняется в контексте сериализуемой транзакции.</span><span class="sxs-lookup"><span data-stu-id="91894-131">The serializable option is recommended because it replicates the procedure execution only if the procedure is executed within the context of a serializable transaction.</span></span> <span data-ttu-id="91894-132">Если хранимая процедура выполняется вне сериализуемой транзакции, изменения данных в опубликованных таблицах реплицируются в виде серий DML-инструкций.</span><span class="sxs-lookup"><span data-stu-id="91894-132">If the stored procedure is executed from outside a serializable transaction, changes to data in published tables are replicated as a series of DML statements.</span></span> <span data-ttu-id="91894-133">Такое поведение позволяет согласовывать данные на подписчике с данными на издателе.</span><span class="sxs-lookup"><span data-stu-id="91894-133">This behavior contributes to making data at the Subscriber consistent with data at the Publisher.</span></span> <span data-ttu-id="91894-134">Эта возможность особенно удобна для пакетных операций, таких как большие операции очистки.</span><span class="sxs-lookup"><span data-stu-id="91894-134">This is especially useful for batch operations, such as large cleanup operations.</span></span>  
  
-   <span data-ttu-id="91894-135">С помощью параметра выполнения процедуры можно реплицировать выполнение процедуры на все подписчики независимо от того, удачно ли были выполнены отдельные инструкции хранимой процедуры.</span><span class="sxs-lookup"><span data-stu-id="91894-135">With the procedure execution option, it is possible that execution could be replicated to all Subscribers regardless of whether individual statements in the stored procedure were successful.</span></span> <span data-ttu-id="91894-136">Более того, поскольку изменения данных, совершаемые хранимой процедурой, могут произойти в нескольких транзакциях, возможна несогласованность данных на подписчиках с данными на издателе.</span><span class="sxs-lookup"><span data-stu-id="91894-136">Furthermore, because changes made to data by the stored procedure can occur within multiple transactions, data at the Subscribers might not be consistent with data at the Publisher.</span></span> <span data-ttu-id="91894-137">Для устранения этих проблем необходимо, чтобы подписчики были доступны только для чтения, и использовать уровень изоляции выше read uncommitted.</span><span class="sxs-lookup"><span data-stu-id="91894-137">To address these issues, it is required that Subscribers are read-only and that you use an isolation level greater than read uncommitted.</span></span> <span data-ttu-id="91894-138">Если используется изоляция read uncommitted, изменения данных в опубликованных таблицах реплицируются в виде последовательности DML-инструкций.</span><span class="sxs-lookup"><span data-stu-id="91894-138">If you use read uncommitted, changes to data in published tables are replicated as a series of DML statements.</span></span>  
  
 <span data-ttu-id="91894-139">В следующем примере показывается, почему рекомендуется настройка репликации процедур в виде сериализуемых статей процедур.</span><span class="sxs-lookup"><span data-stu-id="91894-139">The following example illustrates why it is recommended that you set up replication of procedures as serializable procedure articles.</span></span>  
  
```  
BEGIN TRANSACTION T1  
SELECT @var = max(col1) FROM tableA  
UPDATE tableA SET col2 = <value>   
   WHERE col1 = @var   
  
BEGIN TRANSACTION T2  
INSERT tableA VALUES <values>  
COMMIT TRANSACTION T2  
```  
  
 <span data-ttu-id="91894-140">В предыдущем примере предполагалось, что инструкция SELECT транзакции Т1 выполняется раньше инструкции INSERT транзакции Т2.</span><span class="sxs-lookup"><span data-stu-id="91894-140">In the previous example, it is assumed that the SELECT in transaction T1 happens before the INSERT in transaction T2.</span></span>  
  
 <span data-ttu-id="91894-141">Если процедура выполняется не в рамках сериализуемой транзакции (с уровнем изоляции, заданным как SERIALIZABLE), транзакции Т2 будет разрешено вставлять новые строки в рамках инструкции SELECT в Т1 и завершить действие до завершения и фиксации транзакции Т1.</span><span class="sxs-lookup"><span data-stu-id="91894-141">If the procedure is not executed within a serializable transaction (with isolation level set to SERIALIZABLE), transaction T2 will be allowed to insert a new row within the range of the SELECT statement in T1 and it will commit before T1.</span></span> <span data-ttu-id="91894-142">Это также означает, что процедура будет применяться на подписчике до транзакции Т1.</span><span class="sxs-lookup"><span data-stu-id="91894-142">This also means that it will be applied at the Subscriber before T1.</span></span> <span data-ttu-id="91894-143">При применении транзакции Т1 на подписчике инструкция SELECT потенциально может возвратить иное значение, нежели на издателе, и привести к иному возвращаемому значению инструкции UPDATE.</span><span class="sxs-lookup"><span data-stu-id="91894-143">When T1 is applied at the Subscriber, the SELECT can potentially return a different value than at the Publisher and can result in a different outcome from the UPDATE.</span></span>  
  
 <span data-ttu-id="91894-144">Если процедура выполняется в рамках сериализуемой транзакции, транзакции Т2 нельзя будет вставлять строки в диапазоне, охваченном инструкцией SELECT транзакции Т2.</span><span class="sxs-lookup"><span data-stu-id="91894-144">If the procedure is executed within a serializable transaction, transaction T2 will not be allowed to insert within the range covered by the SELECT statement in T2.</span></span> <span data-ttu-id="91894-145">Эти действия будут блокированы до момента завершения и фиксации транзакции Т1, гарантируя таким образом те же самые результаты на подписчике.</span><span class="sxs-lookup"><span data-stu-id="91894-145">It will be blocked until T1 commits ensuring the same results at the Subscriber.</span></span>  
  
 <span data-ttu-id="91894-146">Блокировки удерживаются дольше, когда процедура выполняется в рамках сериализуемой транзакции, и могут привести к снижению степени параллелизма.</span><span class="sxs-lookup"><span data-stu-id="91894-146">Locks will be held longer when you execute the procedure within a serializable transaction and may result in reduced concurrency.</span></span>  
  
## <a name="the-xact_abort-setting"></a><span data-ttu-id="91894-147">Настройки XACT_ABORT</span><span class="sxs-lookup"><span data-stu-id="91894-147">The XACT_ABORT Setting</span></span>  
 <span data-ttu-id="91894-148">При репликации выполнения хранимой процедуры настройка сеанса, в котором выполняется хранимая процедура, должна задавать значение XACT_ABORT ON.</span><span class="sxs-lookup"><span data-stu-id="91894-148">When replicating stored procedure execution, the setting for the session executing the stored procedure should specify XACT_ABORT ON.</span></span> <span data-ttu-id="91894-149">Если значение параметра XACT_ABORT установлено в OFF и во время выполнения процедуры на издателе возникает ошибка, то такая же ошибка возникнет на подписчике и вызовет сбой в работе агента распространителя.</span><span class="sxs-lookup"><span data-stu-id="91894-149">If XACT_ABORT is set to OFF, and an error occurs during execution of the procedure at the Publisher, the same error will occur at the Subscriber, causing the Distribution Agent to fail.</span></span> <span data-ttu-id="91894-150">Значение параметра XACT_ABORT ON гарантирует полный откат процедуры в случае возникновения ошибок во время выполнения процедуры на издателе, что позволяет исключить сбои в работе агента распространителя.</span><span class="sxs-lookup"><span data-stu-id="91894-150">Specifying XACT_ABORT ON ensures that any errors encountered during execution at the Publisher cause the entire execution to be rolled back, avoiding the Distribution Agent failure.</span></span> <span data-ttu-id="91894-151">Дополнительные сведения о настройке XACT_ABORT см. в статье [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="91894-151">For more information about setting XACT_ABORT, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="91894-152">Если требуется использование настройки XACT_ABORT OFF, укажите для агента распространителя параметр **-SkipErrors** .</span><span class="sxs-lookup"><span data-stu-id="91894-152">If you require a setting of XACT_ABORT OFF, specify the **-SkipErrors** parameter for the Distribution Agent.</span></span> <span data-ttu-id="91894-153">Это позволит агенту продолжить применение изменений на подписчике, даже если возникнет ошибка.</span><span class="sxs-lookup"><span data-stu-id="91894-153">This allows the agent to continue applying changes at the Subscriber even if an error is encountered.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="91894-154">См. также:</span><span class="sxs-lookup"><span data-stu-id="91894-154">See Also</span></span>  
 [<span data-ttu-id="91894-155">Article Options for Transactional Replication</span><span class="sxs-lookup"><span data-stu-id="91894-155">Article Options for Transactional Replication</span></span>](article-options-for-transactional-replication.md)  
  
  
