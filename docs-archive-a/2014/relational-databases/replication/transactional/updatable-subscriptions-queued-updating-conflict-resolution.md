---
title: Обнаружение и разрешение конфликтов обновлений посредством очередей | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- conflict resolution [SQL Server replication], queued updating subscriptions
- viewing queued updating conflicts
- conflict resolution [SQL Server replication]
- queued updating subscriptions [SQL Server replication]
- articles [SQL Server replication], conflict resolution
ms.assetid: 084ac587-25e7-4bd0-a385-556bbe07d02f
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 8c4608347ab119e25caa45b0ee4a592a953e34a4
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87668753"
---
# <a name="queued-updating-conflict-detection-and-resolution"></a><span data-ttu-id="49382-102">Queued Updating Conflict Detection and Resolution</span><span class="sxs-lookup"><span data-stu-id="49382-102">Queued Updating Conflict Detection and Resolution</span></span>
  <span data-ttu-id="49382-103">Поскольку подписки, обновляемые посредством очередей, допускают изменения одних и тех же данных в различных местоположениях, при синхронизации данных у издателя могут возникать конфликты.</span><span class="sxs-lookup"><span data-stu-id="49382-103">Because queued updating subscriptions allow modifications to the same data at multiple locations, there may be conflicts when data is synchronized at the Publisher.</span></span> <span data-ttu-id="49382-104">Системой репликации обнаруживаются любые конфликты, возникающие при синхронизации изменений с издателем, которые затем разрешаются с помощью политики разрешения конфликтов, выбранной при создании публикации.</span><span class="sxs-lookup"><span data-stu-id="49382-104">Replication detects any conflicts when changes are synchronized with the Publisher and resolves those conflicts using the resolution policy you selected when creating the publication.</span></span> <span data-ttu-id="49382-105">Могут возникнуть следующие конфликты.</span><span class="sxs-lookup"><span data-stu-id="49382-105">The following conflicts can occur:</span></span>  
  
-   <span data-ttu-id="49382-106">Конфликты обновления и вставки.</span><span class="sxs-lookup"><span data-stu-id="49382-106">Update and insert conflicts.</span></span> <span data-ttu-id="49382-107">Этот конфликт происходит, когда одни и те же данные изменяются в разных местах.</span><span class="sxs-lookup"><span data-stu-id="49382-107">This conflict happens when the same data is changed at two locations.</span></span> <span data-ttu-id="49382-108">Одно изменение вступает в силу, а другое нет. При этом говорят о выигрыше одного изменения относительно другого.</span><span class="sxs-lookup"><span data-stu-id="49382-108">One change wins, and the other one loses.</span></span>  
  
-   <span data-ttu-id="49382-109">Конфликты при удалении данных.</span><span class="sxs-lookup"><span data-stu-id="49382-109">Delete conflicts.</span></span> <span data-ttu-id="49382-110">Данный конфликт происходит, когда одна и та же строка удаляется в одном месте и изменяется в другом.</span><span class="sxs-lookup"><span data-stu-id="49382-110">This conflict occurs when the same row is deleted at one location and changed at the other.</span></span>  
  
 <span data-ttu-id="49382-111">Процесс обнаружения и разрешения конфликтов может потребовать много времени и ресурсов, поэтому рекомендуется минимизировать количество конфликтов приложения, создавая секции данных таким образом, чтобы разные подписчики изменяли разные подмножества данных.</span><span class="sxs-lookup"><span data-stu-id="49382-111">Conflict detection and resolution can be a time-consuming and resource-intensive process; therefore, it is best to minimize conflicts in the application by creating data partitions so that different Subscribers modify different subsets of data.</span></span>  
  
## <a name="detecting-conflicts"></a><span data-ttu-id="49382-112">Обнаружение конфликтов</span><span class="sxs-lookup"><span data-stu-id="49382-112">Detecting Conflicts</span></span>  
 <span data-ttu-id="49382-113">При создании публикации и включении обновления посредством очередей система репликации добавляет в базовую таблицу столбец **uniqueidentifier** (**msrepl_tran_version**) со значением по умолчанию **newid()** .</span><span class="sxs-lookup"><span data-stu-id="49382-113">When creating a publication and enabling queued updating, replication adds a **uniqueidentifier** column (**msrepl_tran_version**) with the default of **newid()** to the underlying table.</span></span> <span data-ttu-id="49382-114">Когда опубликованные данные изменяются у издателя или подписчика, строка получает новый глобально уникальный идентификатор (GUID), указывающий на существование новой версии строки.</span><span class="sxs-lookup"><span data-stu-id="49382-114">When published data is changed at either the Publisher or the Subscriber, the row receives a new globally unique identifier (GUID) to indicate that a new row version exists.</span></span> <span data-ttu-id="49382-115">Этот столбец используется агентом чтения очереди во время синхронизации для обнаружения конфликтов.</span><span class="sxs-lookup"><span data-stu-id="49382-115">The Queue Reader Agent uses this column during synchronization to determine if a conflict exists.</span></span>  
  
 <span data-ttu-id="49382-116">Транзакция в очереди содержит и старое, и новое значение версии строки.</span><span class="sxs-lookup"><span data-stu-id="49382-116">A transaction in a queue maintains the old and new row version values.</span></span> <span data-ttu-id="49382-117">При применении транзакции у издателя осуществляется сравнение значений GUID из транзакции и значения GUID в публикации.</span><span class="sxs-lookup"><span data-stu-id="49382-117">When the transaction is applied at the Publisher, the GUIDs from the transaction and the GUID in the publication are compared.</span></span> <span data-ttu-id="49382-118">Если старое значение GUID, хранимое в транзакции, совпадает со значением GUID в публикации, то публикация обновляется, и строке назначается новое значение GUID, созданное подписчиком.</span><span class="sxs-lookup"><span data-stu-id="49382-118">If the old GUID stored in the transaction matches the GUID in the publication, the publication is updated and the row is assigned the new GUID that was generated by the Subscriber.</span></span> <span data-ttu-id="49382-119">Благодаря обновлению публикации значением GUID из транзакции обеспечивается совпадение версий строк в публикации и в транзакции.</span><span class="sxs-lookup"><span data-stu-id="49382-119">By updating the publication with the GUID from the transaction, you have matching row versions in the publication and in the transaction.</span></span>  
  
 <span data-ttu-id="49382-120">Если старое значение GUID, хранимое в транзакции, не совпадает со значением GUID в публикации, обнаруживается конфликт.</span><span class="sxs-lookup"><span data-stu-id="49382-120">If the old GUID stored in the transaction does not match the GUID in the publication, a conflict is detected.</span></span> <span data-ttu-id="49382-121">Новое значение идентификатора GUID в публикации указывает на существование двух разных версий строки: одной в транзакции, предоставленной подписчиком, и более новой версии, существующей у издателя.</span><span class="sxs-lookup"><span data-stu-id="49382-121">The new GUID in the publication indicates that two different row versions exist: one in the transaction being submitted by the Subscriber and a newer one that exists on the Publisher.</span></span> <span data-ttu-id="49382-122">Это означает, что другой подписчик или издатель обновил ту же самую строку в публикации перед тем, как была синхронизирована данная транзакция подписчика.</span><span class="sxs-lookup"><span data-stu-id="49382-122">In this case, another Subscriber or the Publisher updated the same row in the publication before this Subscriber transaction was synchronized.</span></span>  
  
 <span data-ttu-id="49382-123">В отличие от репликации слиянием столбец GUID используется не для идентификации самой строки, а для проверки факта ее изменения.</span><span class="sxs-lookup"><span data-stu-id="49382-123">Unlike merge replication, the use of a GUID column is not used to identify the row itself, but is used to check if the row has changed.</span></span>  
  
## <a name="resolving-conflicts"></a><span data-ttu-id="49382-124">Разрешение конфликтов</span><span class="sxs-lookup"><span data-stu-id="49382-124">Resolving Conflicts</span></span>  
 <span data-ttu-id="49382-125">При создании публикации, обновляемой посредством очередей, выбирается сопоставитель конфликтов для использования при обнаружении конфликтов.</span><span class="sxs-lookup"><span data-stu-id="49382-125">When you create a publication using queued updating, you select a conflict resolver to be used if any conflicts are detected.</span></span> <span data-ttu-id="49382-126">Сопоставитель конфликтов определяет, как агент чтения очереди обрабатывает разные версии одной и той же строки, обнаруженные при синхронизации.</span><span class="sxs-lookup"><span data-stu-id="49382-126">The conflict resolver governs how the Queue Reader Agent handles different versions of the same row encountered during synchronization.</span></span> <span data-ttu-id="49382-127">Политику устранения конфликтов можно изменить после создания публикации до тех пор, пока отсутствуют подписки на публикацию.</span><span class="sxs-lookup"><span data-stu-id="49382-127">You can change the conflict resolution policy after the publication is created as long as there are no subscriptions to the publication.</span></span> <span data-ttu-id="49382-128">У сопоставителя конфликтов имеются следующие варианты выбора:</span><span class="sxs-lookup"><span data-stu-id="49382-128">The conflict resolver choices are the following:</span></span>  
  
-   <span data-ttu-id="49382-129">Побеждает издатель (по умолчанию)</span><span class="sxs-lookup"><span data-stu-id="49382-129">Publisher wins (the default)</span></span>  
  
-   <span data-ttu-id="49382-130">Побеждает издатель, и подписка повторно инициализируется</span><span class="sxs-lookup"><span data-stu-id="49382-130">Publisher wins and the subscription is reinitialized</span></span>  
  
-   <span data-ttu-id="49382-131">Побеждает подписчик</span><span class="sxs-lookup"><span data-stu-id="49382-131">Subscriber wins</span></span>  
  
 <span data-ttu-id="49382-132">Записи о конфликтах сохраняются и их можно просмотреть при помощи средства просмотра конфликтов.</span><span class="sxs-lookup"><span data-stu-id="49382-132">Conflicts are recorded and can be viewed using the Conflict Viewer.</span></span>  
  
 <span data-ttu-id="49382-133">**Установка политики устранения конфликтов обновления посредством очередей**</span><span class="sxs-lookup"><span data-stu-id="49382-133">**To set the queued updating conflict resolution policy**</span></span>  
  
-   [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]<span data-ttu-id="49382-134">: [Настройка параметров разрешения конфликтов для обновления посредством очередей (среда SQL Server Management Studio)](../publish/create-an-updatable-subscription-to-a-transactional-publication.md)</span><span class="sxs-lookup"><span data-stu-id="49382-134">: [Set Queued Updating Conflict Resolution Options &#40;SQL Server Management Studio&#41;](../publish/create-an-updatable-subscription-to-a-transactional-publication.md)</span></span>  
  
-   <span data-ttu-id="49382-135">Программирование репликации на Transact-SQL: [Enable Updating Subscriptions for Transactional Publications](../publish/enable-updating-subscriptions-for-transactional-publications.md)</span><span class="sxs-lookup"><span data-stu-id="49382-135">Replication Transact-SQL programming: [Enable Updating Subscriptions for Transactional Publications](../publish/enable-updating-subscriptions-for-transactional-publications.md)</span></span>  
  
 <span data-ttu-id="49382-136">**Просмотр конфликтов данных**</span><span class="sxs-lookup"><span data-stu-id="49382-136">**To view data conflicts**</span></span>  
  
-   [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]<span data-ttu-id="49382-137">: [Просмотр конфликтов данных для публикаций транзакций (среда SQL Server Management Studio)](../view-data-conflicts-for-transactional-publications-sql-server-management-studio.md)</span><span class="sxs-lookup"><span data-stu-id="49382-137">: [View Data Conflicts for Transactional Publications &#40;SQL Server Management Studio&#41;](../view-data-conflicts-for-transactional-publications-sql-server-management-studio.md)</span></span>  
  
### <a name="publisher-wins"></a><span data-ttu-id="49382-138">Побеждает издатель</span><span class="sxs-lookup"><span data-stu-id="49382-138">Publisher Wins</span></span>  
 <span data-ttu-id="49382-139">Когда параметр устранения конфликтов имеет значение «Побеждает издатель», согласованность транзакций поддерживается на основании данных издателя.</span><span class="sxs-lookup"><span data-stu-id="49382-139">When the conflict resolution is set to the Publisher wins, transactional consistency is maintained based on the data at the Publisher.</span></span> <span data-ttu-id="49382-140">Происходит откат конфликтной транзакции у инициировавшего ее подписчика.</span><span class="sxs-lookup"><span data-stu-id="49382-140">The conflicting transaction is rolled back at the Subscriber that initiated it.</span></span>  
  
 <span data-ttu-id="49382-141">Агент чтения очереди обнаруживает конфликт, после чего создаются компенсирующие команды, которые передаются подписчику путем внесения их в базу данных распространителя.</span><span class="sxs-lookup"><span data-stu-id="49382-141">The Queue Reader Agent detects a conflict and compensating commands are generated and propagated to the Subscriber by posting them in the distribution database.</span></span> <span data-ttu-id="49382-142">Затем агент распространителя применяет компенсирующие команды в отношении подписчика, инициировавшего конфликтную транзакцию.</span><span class="sxs-lookup"><span data-stu-id="49382-142">The Distribution Agent then applies the compensating commands to the Subscriber that originated the conflicting transaction.</span></span> <span data-ttu-id="49382-143">Компенсирующие операции обновляют строки у подписчика для соответствия строкам у издателя.</span><span class="sxs-lookup"><span data-stu-id="49382-143">The compensating actions update the rows on the Subscriber to match the rows on the Publisher.</span></span>  
  
 <span data-ttu-id="49382-144">До применения компенсирующих команд можно считать результаты транзакции, откат которой в конечном итоге будет выполнен на подписчике.</span><span class="sxs-lookup"><span data-stu-id="49382-144">Until the compensating commands are applied, it is possible to read the results of a transaction that will eventually be rolled back at the Subscriber.</span></span> <span data-ttu-id="49382-145">Это эквивалентно «грязному» чтению (уровень изоляции незафиксированной операции чтения).</span><span class="sxs-lookup"><span data-stu-id="49382-145">This is equivalent to a dirty read (read uncommitted isolation level).</span></span> <span data-ttu-id="49382-146">Компенсация последующих зависимых транзакций, которые могут произойти, отсутствует.</span><span class="sxs-lookup"><span data-stu-id="49382-146">There is no compensation for the subsequent dependent transactions that can occur.</span></span> <span data-ttu-id="49382-147">Однако при этом соблюдаются границы транзакций, и все действия в пределах транзакции либо завершаются, либо, в случае конфликта, выполняется их откат.</span><span class="sxs-lookup"><span data-stu-id="49382-147">However, transaction boundaries are honored and all the actions within a transaction are either committed, or in the case of a conflict, rolled back.</span></span>  
  
### <a name="publisher-wins-and-the-subscription-is-reinitialized"></a><span data-ttu-id="49382-148">Побеждает издатель, и подписка повторно инициализируется</span><span class="sxs-lookup"><span data-stu-id="49382-148">Publisher Wins and the Subscription Is Reinitialized</span></span>  
 <span data-ttu-id="49382-149">Повторная инициализация подписчика с целью разрешения конфликтов поддерживает строгую согласованность транзакций на подписчике, но она может занимать много времени, если публикация содержит большое количество данных.</span><span class="sxs-lookup"><span data-stu-id="49382-149">Reinitializing the Subscriber to resolve conflicts maintains strict transactional consistency at the Subscriber, but it can be time consuming if the publication contains large amounts of data.</span></span>  
  
 <span data-ttu-id="49382-150">Когда агент чтения очереди обнаруживает конфликт, все остальные транзакции в очереди (включая конфликтные транзакции) отклоняются, а подписчик помечается для повторной инициализации.</span><span class="sxs-lookup"><span data-stu-id="49382-150">When the Queue Reader Agent detects a conflict, all remaining transactions in the queue (including the transaction in conflict) are rejected, and the Subscriber is marked for reinitialization.</span></span> <span data-ttu-id="49382-151">Следующий моментальный снимок, создаваемый для публикации, применяется агентом распространителя к подписчику.</span><span class="sxs-lookup"><span data-stu-id="49382-151">The next snapshot generated for the publication is applied by the Distribution Agent to the Subscriber.</span></span>  
  
### <a name="subscriber-wins"></a><span data-ttu-id="49382-152">Побеждает подписчик</span><span class="sxs-lookup"><span data-stu-id="49382-152">Subscriber Wins</span></span>  
 <span data-ttu-id="49382-153">Обнаружение конфликтов в соответствии с политикой «Побеждает подписчик» означает, что побеждает последняя транзакция подписчика, обновляющая издателя.</span><span class="sxs-lookup"><span data-stu-id="49382-153">Conflict detection under the Subscriber wins policy means the last Subscriber transaction to update the Publisher wins.</span></span> <span data-ttu-id="49382-154">В этом случае при обнаружении конфликта продолжает использоваться транзакция, отправленная подписчиком, а издатель обновляется.</span><span class="sxs-lookup"><span data-stu-id="49382-154">In this case, when a conflict is detected, the transaction sent by the Subscriber is still used and the Publisher is updated.</span></span> <span data-ttu-id="49382-155">Эта политика подходит для приложений, в которых подобные изменения не нарушают целостность данных.</span><span class="sxs-lookup"><span data-stu-id="49382-155">This policy is suitable for applications where such changes do not compromise data integrity.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="49382-156">См. также:</span><span class="sxs-lookup"><span data-stu-id="49382-156">See Also</span></span>  
 [<span data-ttu-id="49382-157">Updatable Subscriptions for Transactional Replication</span><span class="sxs-lookup"><span data-stu-id="49382-157">Updatable Subscriptions for Transactional Replication</span></span>](updatable-subscriptions-for-transactional-replication.md)  
  
  
