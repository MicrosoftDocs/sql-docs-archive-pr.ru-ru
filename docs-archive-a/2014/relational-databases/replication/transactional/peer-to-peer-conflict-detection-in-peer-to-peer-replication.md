---
title: Обнаружение конфликтов в одноранговой репликации | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- transactional replication, peer-to-peer replication
- peer-to-peer transactional replication, conflict detection
ms.assetid: 754a1070-59bc-438d-998b-97fdd77d45ca
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 301a751bf5b5959ab1fc434ac2a583a6b0378fdd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87664850"
---
# <a name="conflict-detection-in-peer-to-peer-replication"></a>Обнаружение конфликтов в одноранговой репликации
  Одноранговая репликация транзакций дает возможность вставлять, обновлять и удалять данные в любом узле топологии и передавать изменения в данных на другие узлы. Данные можно изменять в любом узле, поэтому изменения, вносимые на различных узлах, могут конфликтовать друг с другом. Если строка изменяется на нескольких узлах, это может вызвать конфликт или даже потерю обновления, когда эта строка передается на другие узлы.  
  
 Одноранговая репликация в [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] и более поздних версиях предоставляет возможность включить обнаружение конфликтов во всей одноранговой топологии. Этот режим помогает избежать проблемы, которые вызываются необнаруженными конфликтами, в том числе недопустимым поведением приложения и потерянными обновлениями. При включенном режиме обнаружения конфликтов конфликтующее изменение по умолчанию рассматривается как критическая ошибка, вызывающая сбой агента распространителя. В случае конфликта топология остается в несогласованном состоянии, пока конфликт не будет разрешен, а данные согласованы во всей топологии.  
  
> [!NOTE]  
>  Чтобы избежать возможной несогласованности данных, убедитесь, что в одноранговой топологии отсутствуют конфликты, даже при включенном обнаружении конфликтов. Чтобы операции записи выполнялись только на одном узле, приложения, получающие доступ к данным и изменяющие их, должны секционировать операции вставки, обновления и удаления. Такое секционирование обеспечивает тот факт, что изменения конкретной строки на одном узле синхронизируются с остальными узлами в топологии, прежде чем эта строка будет изменена другим узлом. Если приложению требуется усложненное обнаружение конфликтов, используйте репликацию слиянием. Дополнительные сведения см. в статьях [Merge Replication](../merge/merge-replication.md) (Репликация слиянием) и [Detect and Resolve Merge Replication Conflicts](../merge/advanced-merge-replication-conflict-detection-and-resolution.md) (Обнаружение и разрешение конфликтов репликации слиянием).  
  
## <a name="understanding-conflicts-and-conflict-detection"></a>Основные сведения о конфликтах и обнаружении конфликтов  
 В одной базе данных изменения, вносимые в одну строку различными приложениями, не создают конфликта. Это происходит потому, что транзакции сериализуются, а для обработки параллельных изменений используются блокировки. В асинхронной распределенной системе, какой является одноранговая репликация, транзакции воздействуют на каждый узел независимо друг от друга, при этом механизм сериализации транзакций по нескольким узлам отсутствует. Здесь можно использовать протокол, такой как двухфазная фиксация, но это приводит к существенному снижению производительности.  
  
 В таких системах, как одноранговая репликация, конфликты не обнаруживаются, если изменения фиксируются на отдельных узлах. Но они обнаруживаются в случаях, когда эти изменения реплицируются и применяются на других узлах. При выполнении одноранговой репликации конфликты обнаруживаются с помощью хранимых процедур, которые применяют изменения к каждому узлу в соответствии с содержимым скрытого столбца в каждой опубликованной таблице. В этом скрытом столбце хранится идентификатор, сочетающий в себе *идентификатор инициатора* , указываемый пользователем для каждого узла, и версию строки. В ходе синхронизации агент распределителя выполняет процедуры для каждой таблицы. Эти процедуры выполняют операции вставки, обновления и удаления с других узлов. Если одна из этих процедур обнаруживает конфликт при считывании значения скрытого столбца, она фиксирует ошибку 22815 со степенью серьезности 16.  
  
 `A conflict of type '%s' was detected at peer %d between peer %d (incoming), transaction id %s  and peer %d (on disk), transaction id %s`  
  
 По умолчанию при возникновении этой ошибки агент распространителя прекращает применение изменений к данному узлу. Сведения об обработке выявленных конфликтов см. ниже в разделе «Обработка конфликтов».  
  
> [!NOTE]  
>  Работать со скрытым столбцом может только пользователь, вошедший в систему через выделенное административное соединение. Информацию о DAC вы найдете в статье [Диагностическое соединение для администраторов баз данных](../../../database-engine/configure-windows/diagnostic-connection-for-database-administrators.md).  
  
 При выполнении одноранговой репликации обнаруживаются следующие типы конфликтов.  
  
-   Вставка-вставка  
  
     Все строки во всех таблицах, участвующих в одноранговой репликации, уникальным образом идентифицируются с помощью значений первичного ключа. Конфликт «вставка-вставка» имеет место тогда, когда вставка строки с одним и тем же значением ключа осуществляется более чем на одном узле.  
  
-   Обновление-обновление  
  
     Происходит, когда одна и та же строка обновляется более чем на одном узле.  
  
-   Вставка-обновление  
  
     Происходит, когда строка обновляется на одном узле, а на другом та же строка удаляется и затем вновь вставляется.  
  
-   Вставка-удаление  
  
     Происходит, если строка удаляется на одном узле, а на другом та же строка удаляется и затем вновь вставляется.  
  
-   Обновление-удаление  
  
     Происходит, когда строка обновляется на одном узле, а на другом та же строка удаляется.  
  
-   Удаление-удаление  
  
     Происходит, когда строка удаляется более чем на одном узле.  
  
## <a name="enabling-conflict-detection"></a>Активизация функции обнаружения конфликтов  
 Для использования обнаружения конфликтов на всех узлах должен выполняться [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] или более поздней версии; кроме того, обнаружение должно быть включено на всех узлах. В [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] и более поздних версий по умолчанию средства обнаружения конфликтов активизированы в [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]. Мы рекомендуем включать функцию обнаружения конфликтов — даже в тех случаях, когда возникновение конфликтов не ожидается. Средства обнаружения конфликтов могут быть включены и отключены с помощью среды [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] или хранимых процедур на языке [!INCLUDE[tsql](../../../includes/tsql-md.md)] .  
  
-   Включение и отключение средств обнаружения в [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] осуществляется либо на странице **Параметры подписки** диалогового окна **Свойства публикации** , либо на странице **Настройка топологии** мастера настройки одноранговой топологии.  
  
     Если настройка режима обнаружения конфликтов осуществляется с помощью среды [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)], агент распределителя прекращает применение изменений при обнаружении конфликта.  
  
-   Кроме того, режим обнаружения можно включать и отключать с помощью следующих хранимых процедур: [sp_addpublication](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql) или [sp_configure_peerconflictdetection](/sql/relational-databases/system-stored-procedures/sp-configure-peerconflictdetection-transact-sql).  
  
     В случае настройки режима обнаружения конфликтов с помощью хранимых процедур пользователь может указать, должен ли агент распространителя прекратить применение изменений при обнаружении конфликта. По умолчанию агент прекращает применение изменений. Рекомендуется использовать настройки по умолчанию.  
  
## <a name="handling-conflicts"></a>Обработка конфликтов  
 Когда в ходе одноранговой репликации имеет место конфликт, формируется предупреждение об обнаружении конфликтов в одноранговой репликации. Рекомендуется настраивать это предупреждение таким образом, чтобы оповещение происходило при возникновении конфликта. Дополнительные сведения об оповещениях см. в статье [Использование предупреждений для событий агента репликации](../agents/use-alerts-for-replication-agent-events.md).  
  
 По прекращении действий агента распространителя и после направления предупреждения обрабатывайте происшедший конфликт в соответствии с одним из следующих подходов.  
  
-   Выполните повторную инициализацию узла, на котором был обнаружен конфликт, с резервной копии узла, содержащей необходимые данные (рекомендуемый подход). Этот метод гарантирует сохранение данных в согласованном состоянии.  
  
-   Попытайтесь вновь синхронизировать узел, дав возможность агенту распространителя продолжить применение изменений.  
  
    1.  Выполнить [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql): укажите "p2p_continue_onconflict" для @property параметра и `true` для @value параметра.  
  
    2.  Перезапустите агент распространителя.  
  
    3.  Проверьте обнаруженные конфликты с помощью средства просмотра конфликтов и определите вовлеченные в конфликты строки, тип конфликта, а также выигравшую сторону. Конфликт разрешается в соответствии со значением идентификатора инициатора, указанным пользователем во время настройки: победителем в конфликте становится строка, инициированная на узле с самым высоким значением идентификатора. Дополнительные сведения см. в статье [Просмотр конфликтов данных для публикаций транзакций (среда SQL Server Management Studio)](../view-data-conflicts-for-transactional-publications-sql-server-management-studio.md).  
  
    4.  Выполните проверку и убедитесь в том, что конвергенция конфликтующих строк завершилась верно. Дополнительные сведения см. в статье [Проверка реплицированных данных](../validate-data-at-the-subscriber.md).  
  
        > [!NOTE]  
        >  Если по выполнении этого шага несогласованность данных сохраняется, необходимо вручную обновить строки узла с самым высоким приоритетом, а затем разрешить распространение изменений с этого узла. Если в топологии более нет конфликтующих изменений, все узлы будут приведены в согласованное состояние.  
  
    5.  Выполнить [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql): укажите "p2p_continue_onconflict" для @property параметра и `false` для @value параметра.  
  
## <a name="see-also"></a>См. также:  
 [Peer-to-Peer Transactional Replication](peer-to-peer-transactional-replication.md)  
  
  
