---
title: Стратегии резервного копирования и восстановления для репликации слиянием | Документация Майкрософт
ms.custom: ''
ms.date: 03/09/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- recovery [SQL Server replication], merge replication
- backups [SQL Server replication], merge replication
- restoring [SQL Server replication], merge replication
- merge replication [SQL Server replication], backup and restore
ms.assetid: b8ae31c6-d76f-4dd7-8f46-17d023ca3eca
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 45e3259d93af4735569fcb6b6a9c7b9eddd52730
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87736263"
---
# <a name="strategies-for-backing-up-and-restoring-merge-replication"></a><span data-ttu-id="c350d-102">Стратегия резервного копирования и восстановления из копии для репликации слиянием</span><span class="sxs-lookup"><span data-stu-id="c350d-102">Strategies for Backing Up and Restoring Merge Replication</span></span>
  <span data-ttu-id="c350d-103">Для репликации слиянием регулярно создавайте резервные копии следующих баз данных:</span><span class="sxs-lookup"><span data-stu-id="c350d-103">For merge replication, back up the following databases regularly:</span></span>  
  
-   <span data-ttu-id="c350d-104">База данных публикаций на издателе.</span><span class="sxs-lookup"><span data-stu-id="c350d-104">The publication database at the Publisher</span></span>   
-   <span data-ttu-id="c350d-105">База данных распространителя на распространителе.</span><span class="sxs-lookup"><span data-stu-id="c350d-105">The distribution database at the Distributor</span></span>    
-   <span data-ttu-id="c350d-106">База данных подписок на каждом подписчике.</span><span class="sxs-lookup"><span data-stu-id="c350d-106">The subscription database at each Subscriber</span></span>    
-   <span data-ttu-id="c350d-107">Системные базы данных **master** и **msdb** на издателе, распространителе и на всех подписчиках.</span><span class="sxs-lookup"><span data-stu-id="c350d-107">The **master** and **msdb** system databases at the Publisher, Distributor and all Subscribers.</span></span> <span data-ttu-id="c350d-108">Резервные копии этих баз данных и копия соответствующей базы данных репликации должны быть сделаны одновременно.</span><span class="sxs-lookup"><span data-stu-id="c350d-108">These databases should be backed up at the same time as each other and the relevant replication database.</span></span> <span data-ttu-id="c350d-109">Например, создавайте резервную копию баз данных **master** и **msdb** на издателе одновременно с резервной копией базы данных публикаций.</span><span class="sxs-lookup"><span data-stu-id="c350d-109">For example, back up the **master** and **msdb** databases at the Publisher at the same time you back up the publication database.</span></span> <span data-ttu-id="c350d-110">Если база данных публикаций восстановлена, убедитесь, что базы данных **master** и **msdb** согласованы с базой данных публикаций по настройке и конфигурации репликации.</span><span class="sxs-lookup"><span data-stu-id="c350d-110">If the publication database is restored, ensure that the **master** and **msdb** database are consistent with the publication database in terms of replication configuration and settings.</span></span>  
  
 <span data-ttu-id="c350d-111">Если резервное копирование журналов выполняется регулярно, любые изменения, касающиеся репликации, будут заноситься в резервные копии журнала.</span><span class="sxs-lookup"><span data-stu-id="c350d-111">If you perform regular log backups, any replication-related changes should be captured in the log backups.</span></span> <span data-ttu-id="c350d-112">Если резервные копии журналов не создаются, резервное копирование следует выполнять при каждом изменении параметров репликации.</span><span class="sxs-lookup"><span data-stu-id="c350d-112">If you don't perform log backups, a backup should be performed whenever a setting relevant to replication is changed.</span></span> <span data-ttu-id="c350d-113">Дополнительные сведения см. в статье [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md).</span><span class="sxs-lookup"><span data-stu-id="c350d-113">For more information, see [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md).</span></span>  
  
 <span data-ttu-id="c350d-114">Выберите один из описываемых далее подходов к резервному копированию и восстановлению базы данных публикаций, затем следуйте рекомендациям, приведенным для базы данных распространителя и базы данных подписок.</span><span class="sxs-lookup"><span data-stu-id="c350d-114">Choose one of the approaches detailed below for backing up and restoring the publication database, and then follow the recommendations listed for the distribution database and subscription databases.</span></span>  
  
## <a name="backing-up-and-restoring-the-publication-database"></a><span data-ttu-id="c350d-115">Резервное копирование и восстановление базы данных публикаций</span><span class="sxs-lookup"><span data-stu-id="c350d-115">Backing Up and Restoring the Publication Database</span></span>  
 <span data-ttu-id="c350d-116">Существует два подхода к восстановлению базы данных публикаций слиянием.</span><span class="sxs-lookup"><span data-stu-id="c350d-116">There are two approaches to restoring a merge publication database.</span></span> <span data-ttu-id="c350d-117">После восстановления базы данных публикаций из резервной копии следует:</span><span class="sxs-lookup"><span data-stu-id="c350d-117">After restoring the publication database from a backup, you should either:</span></span>  
  
-   <span data-ttu-id="c350d-118">Либо синхронизировать базу данных публикаций с базой данных подписок.</span><span class="sxs-lookup"><span data-stu-id="c350d-118">Synchronize the publication database with a subscription database.</span></span>  
  
-   <span data-ttu-id="c350d-119">Либо повторно инициализировать все подписки на публикации в базе данных публикаций.</span><span class="sxs-lookup"><span data-stu-id="c350d-119">Reinitialize all subscriptions to the publications in the publication database.</span></span>  
  
 <span data-ttu-id="c350d-120">Применение любого их этих методов гарантирует, что после восстановления издатель и все подписчики будут синхронизированы.</span><span class="sxs-lookup"><span data-stu-id="c350d-120">Using either of these methods ensures that after a restore is performed, the Publisher and all Subscribers are synchronized.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c350d-121">Если какие-либо таблицы содержат столбцы идентификаторов, следует обеспечить после восстановления назначение правильных диапазонов идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="c350d-121">If any tables contain identity columns, you must ensure the correct identity ranges are assigned after a restore.</span></span> <span data-ttu-id="c350d-122">Дополнительные сведения см. в статье [Репликация столбцов идентификаторов](../publish/replicate-identity-columns.md).</span><span class="sxs-lookup"><span data-stu-id="c350d-122">For more information, see [Replicate Identity Columns](../publish/replicate-identity-columns.md).</span></span>  
  
### <a name="synchronizing-the-publication-database"></a><span data-ttu-id="c350d-123">Синхронизация базы данных публикаций</span><span class="sxs-lookup"><span data-stu-id="c350d-123">Synchronizing the Publication Database</span></span>  
 <span data-ttu-id="c350d-124">Синхронизация базы данных публикаций с базой данных подписок позволяет загружать из одной или нескольких баз данных подписок те изменения, которые были сделаны ранее в базе данных публикаций, но не были представлены в восстановленной резервной копии.</span><span class="sxs-lookup"><span data-stu-id="c350d-124">Synchronizing a publication database with a subscription database allows you to upload from one or more subscription databases those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="c350d-125">Передаваемые данные зависят от того, как отфильтрованы публикации:</span><span class="sxs-lookup"><span data-stu-id="c350d-125">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
-   <span data-ttu-id="c350d-126">Если публикации не отфильтрованы, должна существовать возможность обновления базы данных публикаций посредством синхронизации с самым обновленным подписчиком.</span><span class="sxs-lookup"><span data-stu-id="c350d-126">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
-   <span data-ttu-id="c350d-127">Если же публикация отфильтрована, то базу данных публикации, возможно, не удастся обновить.</span><span class="sxs-lookup"><span data-stu-id="c350d-127">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="c350d-128">Рассмотрим таблицу, которая разделена так, что каждая подписка получает данные клиентов только из одного региона: север, восток, юг и запад.</span><span class="sxs-lookup"><span data-stu-id="c350d-128">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="c350d-129">Если существует по крайней мере один подписчик из каждой секции данных, синхронизация с подписчиком из каждой секции должна обновить базу данных публикаций.</span><span class="sxs-lookup"><span data-stu-id="c350d-129">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="c350d-130">Однако если данные в западной секции, например не были реплицированы на какие-либо подписчики, эти данные на издателе невозможно будет обновить.</span><span class="sxs-lookup"><span data-stu-id="c350d-130">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c350d-131">Результатом синхронизации базы данных публикаций с базой данных подписок может быть восстановление опубликованных таблиц до более современного состояния, чем состояние других неопубликованных таблиц, восстановленных из резервной копии.</span><span class="sxs-lookup"><span data-stu-id="c350d-131">Synchronizing a publication database with a subscription database can result in published tables being restored to a point in time that is more recent than the point in time of other non-published tables restored from the backup.</span></span>  
  
 <span data-ttu-id="c350d-132">При синхронизации с подписчиком, на котором запущена версия [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , предшествующая [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], подписка не может быть анонимной. Это должна быть клиентская или серверная подписка (в предыдущих версиях такие подписки называются локальными или глобальными).</span><span class="sxs-lookup"><span data-stu-id="c350d-132">If you synchronize with a Subscriber that is running a version of [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] prior to [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span>  
  
 <span data-ttu-id="c350d-133">Чтобы синхронизировать подписку, см. разделы [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) и [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span><span class="sxs-lookup"><span data-stu-id="c350d-133">To synchronize a subscription, see [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) and [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span></span>  
  
### <a name="reinitializing-all-subscriptions"></a><span data-ttu-id="c350d-134">Повторная инициализация всех подписок</span><span class="sxs-lookup"><span data-stu-id="c350d-134">Reinitializing all Subscriptions</span></span>  
 <span data-ttu-id="c350d-135">Повторная инициализация всех подписок гарантирует, что все подписчики находятся в состоянии, согласованном с восстановленной базой данных публикаций.</span><span class="sxs-lookup"><span data-stu-id="c350d-135">Reinitializing all subscriptions ensures all Subscribers are in a state consistent with the restored publication database.</span></span> <span data-ttu-id="c350d-136">Такой подход следует применять, если требуется вернуть всю топологию в предыдущее состояние, представленное резервной копией базы данных публикаций.</span><span class="sxs-lookup"><span data-stu-id="c350d-136">This approach should be used if you want to return an entire topology to the previous state represented by a given publication database backup.</span></span> <span data-ttu-id="c350d-137">Например, повторная инициализация всех подписок может потребоваться, если восстановление базы данных публикаций до более ранней точки используется в качестве механизма возврата из ошибочно выполненной пакетной операции.</span><span class="sxs-lookup"><span data-stu-id="c350d-137">For example, you might want to reinitialize all subscriptions if you are restoring a publication database to an earlier point in time as a mechanism to recover from an erroneously performed batch operation.</span></span>  
  
 <span data-ttu-id="c350d-138">Если выбран данный вариант, создайте новый моментальный снимок для его доставки на повторно инициализированные подписчики сразу после восстановления базы данных публикаций.</span><span class="sxs-lookup"><span data-stu-id="c350d-138">If you choose this option, generate a new snapshot for delivery to reinitialized Subscribers immediately after restoring your publication database.</span></span>  
  
 <span data-ttu-id="c350d-139">Чтобы повторно инициализировать подписку, см. раздел [Reinitialize a Subscription](../reinitialize-a-subscription.md).</span><span class="sxs-lookup"><span data-stu-id="c350d-139">To reinitialize a subscription, see [Reinitialize a Subscription](../reinitialize-a-subscription.md).</span></span>  
  
 <span data-ttu-id="c350d-140">Чтобы создать и применить моментальный снимок, см. разделы [Create и Apply the Initial Snapshot](../create-and-apply-the-initial-snapshot.md) и [Create a Snapshot for a Merge Publication with Parameterized Filters](../create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md).</span><span class="sxs-lookup"><span data-stu-id="c350d-140">To create and apply a snapshot, see [Create and Apply the Initial Snapshot](../create-and-apply-the-initial-snapshot.md) and [Create a Snapshot for a Merge Publication with Parameterized Filters](../create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md).</span></span>  
  
## <a name="backing-up-and-restoring-the-distribution-database"></a><span data-ttu-id="c350d-141">Резервное копирование и восстановление базы данных распространителя</span><span class="sxs-lookup"><span data-stu-id="c350d-141">Backing Up and Restoring the Distribution Database</span></span>  
 <span data-ttu-id="c350d-142">При репликации слиянием база данных распространителя должна регулярно подвергаться резервному копированию, и она может быть восстановлена без дополнительных условий до тех пор, пока время, истекшее с момента создания используемой резервной копии, не превышает кратчайший срок хранения всех публикаций, использующих распространитель.</span><span class="sxs-lookup"><span data-stu-id="c350d-142">With merge replication, the distribution database should be backed up regularly, and can be restored without any special considerations as long as the backup used is no older than the shortest retention period of all publications that use the Distributor.</span></span> <span data-ttu-id="c350d-143">Например, если есть три публикации со сроками хранения 10, 20 и 30 дней соответственно, то используемая резервная копия не должна быть старше 10 дней.</span><span class="sxs-lookup"><span data-stu-id="c350d-143">For example, if there are three publications with retention periods of 10, 20, and 30 days, respectively, the backup used to restore the database should not be more than 10 days old.</span></span> <span data-ttu-id="c350d-144">База данных распространителя играет ограниченную роль в репликации слиянием: она не хранит данных, используемых для отслеживания изменений, и не служит временным хранилищем изменений репликации слиянием, которые должны пересылаться в базы данных подписок (как это делается при репликации транзакций).</span><span class="sxs-lookup"><span data-stu-id="c350d-144">The distribution database has a limited role in merge replication: it does not store any data used in change tracking and it does not provide temporary storage of merge replication changes to be forwarded to subscription databases (as it does in transactional replication).</span></span>  
  
## <a name="backing-up-and-restoring-a-subscription-database"></a><span data-ttu-id="c350d-145">Резервное копирование и восстановление базы данных подписок</span><span class="sxs-lookup"><span data-stu-id="c350d-145">Backing Up and Restoring a Subscription Database</span></span>  
 <span data-ttu-id="c350d-146">Чтобы гарантировать успешное восстановление базы данных подписок, подписчики должны синхронизироваться с издателем до резервного копирования базы данных подписок; подписчики также должны синхронизироваться после восстановления базы данных подписок.</span><span class="sxs-lookup"><span data-stu-id="c350d-146">To ensure successful recovery of a subscription database, Subscribers should synchronize with the Publisher before the subscription database is backed up; they should also synchronize after the subscription database is restored:</span></span>  
  
-   <span data-ttu-id="c350d-147">Синхронизация с издателем до резервного копирования базы данных подписок гарантирует, что если подписчик восстанавливается из резервной копии, подписки все равно будут находиться в пределах срока хранения публикации.</span><span class="sxs-lookup"><span data-stu-id="c350d-147">Synchronizing with the Publisher before a subscription database backup helps ensure that if a Subscriber is restored from backup, the subscription is still within the publication retention period.</span></span> <span data-ttu-id="c350d-148">Например, предположим, что срок хранения публикации равен 10 дням.</span><span class="sxs-lookup"><span data-stu-id="c350d-148">For example, assume a publication with a retention period of 10 days.</span></span> <span data-ttu-id="c350d-149">Последняя синхронизация была 8 дней назад, а теперь выполняется резервное копирование.</span><span class="sxs-lookup"><span data-stu-id="c350d-149">The last synchronization was 8 days ago, and now the backup is performed.</span></span> <span data-ttu-id="c350d-150">Если через 4 дня будет произведено восстановление из резервной копии, то последняя синхронизация окажется 12-дневной давности, то есть за пределами срока хранения публикации.</span><span class="sxs-lookup"><span data-stu-id="c350d-150">If the backup is restored 4 days later, the last synchronization will have occurred 12 days ago, which is past the retention period.</span></span> <span data-ttu-id="c350d-151">В этом случае потребуется повторная инициализация подписчика.</span><span class="sxs-lookup"><span data-stu-id="c350d-151">In this case, you would have to reinitialize the Subscriber.</span></span> <span data-ttu-id="c350d-152">Если подписчик был синхронизован перед резервным копированием, база данных подписок будет находиться в пределах срока хранения публикации.</span><span class="sxs-lookup"><span data-stu-id="c350d-152">If the Subscriber had synchronized before the backup, the subscription database would be within the retention period.</span></span>  
  
     <span data-ttu-id="c350d-153">Время с момента создания резервной копии не должна превышать кратчайший срок хранения всех публикаций, на которые подписывается подписчик.</span><span class="sxs-lookup"><span data-stu-id="c350d-153">The backup should be no older than the shortest retention period of all publications to which the Subscriber subscribes.</span></span> <span data-ttu-id="c350d-154">Например, если подписчик подписывается на три публикации со сроками хранения 10, 20 и 30 дней соответственно, то резервная копия, используемая для восстановления, не должна быть старше 10 дней.</span><span class="sxs-lookup"><span data-stu-id="c350d-154">For example, if a Subscriber subscribes to three publications with retention periods of 10, 20, and 30 days, respectively, the backup used to restore the database should not be more than 10 days old.</span></span>  
  
-   <span data-ttu-id="c350d-155">Синхронизация базы данных подписок с каждой из ее публикаций после восстановления гарантирует, что подписчик обновлен в соответствии со всеми изменениями издателя.</span><span class="sxs-lookup"><span data-stu-id="c350d-155">Synchronizing the subscription database with each of its publications following a restore ensures that the Subscriber is up to date with all changes at the Publisher.</span></span>  
  
 <span data-ttu-id="c350d-156">Чтобы установить срок хранения публикации, выполните действия из статьи [Установка срока действия подписок](../publish/set-the-expiration-period-for-subscriptions.md).</span><span class="sxs-lookup"><span data-stu-id="c350d-156">To set the publication retention period, see [Set the Expiration Period for Subscriptions](../publish/set-the-expiration-period-for-subscriptions.md).</span></span>  
  
 <span data-ttu-id="c350d-157">Чтобы синхронизировать подписку, см. разделы [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) и [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span><span class="sxs-lookup"><span data-stu-id="c350d-157">To synchronize a subscription, see [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) and [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span></span>  
  
## <a name="backing-up-and-restoring-a-republishing-database"></a><span data-ttu-id="c350d-158">Резервное копирование и восстановление переиздаваемой базы данных</span><span class="sxs-lookup"><span data-stu-id="c350d-158">Backing Up and Restoring a Republishing Database</span></span>  
 <span data-ttu-id="c350d-159">Когда база данных подписывается на данные издателя и в свою очередь публикует те же самые данные для других баз данных подписок, ее называют переиздающей базой данных.</span><span class="sxs-lookup"><span data-stu-id="c350d-159">When a database subscribes to data from a Publisher and in turn publishes that same data to other subscription databases, it is referred to as a republishing database.</span></span> <span data-ttu-id="c350d-160">При восстановлении переиздающей базы данных следуйте инструкциям, описанным в подразделах «Резервное копирование и восстановление базы данных публикаций» и «Резервное копирование и восстановление базы данных подписок» этого раздела.</span><span class="sxs-lookup"><span data-stu-id="c350d-160">When restoring a republishing database, follow the guidelines described in "Backing Up and Restoring a Publication Database" and "Backing Up and Restoring a Subscription Database" in this topic.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c350d-161">См. также:</span><span class="sxs-lookup"><span data-stu-id="c350d-161">See Also</span></span>  
 <span data-ttu-id="c350d-162">[Резервное копирование и восстановление баз данных SQL Server](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span><span class="sxs-lookup"><span data-stu-id="c350d-162">[Back Up and Restore of SQL Server Databases](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span></span>  
 [<span data-ttu-id="c350d-163">Создание резервной копии и восстановление из копий реплицируемых баз данных</span><span class="sxs-lookup"><span data-stu-id="c350d-163">Back Up and Restore Replicated Databases</span></span>](back-up-and-restore-replicated-databases.md)  
  
  
