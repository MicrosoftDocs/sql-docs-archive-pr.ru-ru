---
title: Оптимизация производительности параметризованного фильтра с помощью предварительно вычисляемых секций | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- precomputed partitions [SQL Server replication]
- merge replication precomputed partitions [SQL Server replication]
- merge replication precomputed partitions [SQL Server replication], about precomputed partitions
ms.assetid: 85654bf4-e25f-4f04-8e34-bbbd738d60fa
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 4ad0a33f0a5951256ff94bc78e7f09a88c05f227
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87749736"
---
# <a name="optimize-parameterized-filter-performance-with-precomputed-partitions"></a><span data-ttu-id="2097a-102">Оптимизация производительности параметризованного фильтра с помощью предварительно вычисляемых секций</span><span class="sxs-lookup"><span data-stu-id="2097a-102">Optimize Parameterized Filter Performance with Precomputed Partitions</span></span>
  <span data-ttu-id="2097a-103">Предварительно вычисляемые секции — это способ оптимизации производительности, который может использоваться с фильтрованными публикациями слиянием.</span><span class="sxs-lookup"><span data-stu-id="2097a-103">Precomputed partitions is a performance optimization that can be used with filtered merge publications.</span></span> <span data-ttu-id="2097a-104">Предварительно вычисляемые секции необходимы также для использования логических записей в фильтрованных публикациях.</span><span class="sxs-lookup"><span data-stu-id="2097a-104">Precomputed partitions is also a requirement for using logical records on filtered publications.</span></span> <span data-ttu-id="2097a-105">Дополнительные сведения о логических записях см. в статье [Группирование изменений в связанных строках с помощью логических записей](group-changes-to-related-rows-with-logical-records.md).</span><span class="sxs-lookup"><span data-stu-id="2097a-105">For more information about logical records, see [Group Changes to Related Rows with Logical Records](group-changes-to-related-rows-with-logical-records.md).</span></span>  
  
 <span data-ttu-id="2097a-106">При синхронизации подписчика с издателем издатель должен оценить фильтры подписчика, чтобы определить, какие строки принадлежат секции подписчика или его набору данных.</span><span class="sxs-lookup"><span data-stu-id="2097a-106">When a Subscriber synchronizes with a Publisher, the Publisher must evaluate the Subscriber's filters to determine which rows belong to that Subscriber's partition, or data set.</span></span> <span data-ttu-id="2097a-107">Процесс определения принадлежности изменений секциям на издателе для каждого подписчика, получающего набор фильтрованных данных, называется *оценкой секции*.</span><span class="sxs-lookup"><span data-stu-id="2097a-107">This process of determining partition membership of changes at the Publisher for each Subscriber receiving a filtered dataset is referred to as *partition evaluation*.</span></span> <span data-ttu-id="2097a-108">Без использования предварительно вычисляемых секций оценка секции должна выполняться для каждого изменения, вносимого в отфильтрованный столбец на издателе с момента последнего запуска агента слияния для определенного подписчика, и этот процесс необходимо повторить для каждого подписчика, синхронизируемого с издателем.</span><span class="sxs-lookup"><span data-stu-id="2097a-108">Without precomputed partitions, partition evaluation must be performed for each change made to a filtered column at the Publisher since the last time the Merge Agent ran for a specific Subscriber, and this process has to be repeated for every Subscriber that synchronizes with the Publisher.</span></span>  
  
 <span data-ttu-id="2097a-109">Однако если издатель и подписчик работают в [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] или более поздней версии и используются предварительно вычисленные секции, членство в секции для всех изменений на издателе предварительно вычислено и сохраняется во время внесения изменений.</span><span class="sxs-lookup"><span data-stu-id="2097a-109">However, if the Publisher and Subscriber are running on [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version and you use precomputed partitions, partition membership for all changes at the Publisher is precomputed and persisted at the time that the changes are made.</span></span> <span data-ttu-id="2097a-110">В результате, когда подписчик синхронизируется с издателем, он может немедленно начать загрузку изменений, соответствующих его секции, без необходимости прохождения через процесс оценки секции.</span><span class="sxs-lookup"><span data-stu-id="2097a-110">As a result, when a Subscriber synchronizes with the Publisher, it can immediately start to download changes relevant to its partition without having to go through the partition evaluation process.</span></span> <span data-ttu-id="2097a-111">Такой принцип работы приводит к увеличению производительности, если публикация имеет большое количество изменений, подписчиков или статей.</span><span class="sxs-lookup"><span data-stu-id="2097a-111">This can lead to significant performance gains when a publication has a large number of changes, Subscribers, or articles in the publication.</span></span>  
  
 <span data-ttu-id="2097a-112">В дополнение к использованию предварительно вычисляемых секций выполните предварительное создание моментальных снимков или разрешите подписчикам запрашивать создание и применение моментального снимка при первоначальной синхронизации.</span><span class="sxs-lookup"><span data-stu-id="2097a-112">In addition to using precomputed partitions, pre-generate snapshots and/or allow Subscribers to request snapshot generation and application the first time they synchronize.</span></span> <span data-ttu-id="2097a-113">Используйте один или оба этих параметра, чтобы предоставить моментальные снимки публикациям, использующим параметризованные фильтры.</span><span class="sxs-lookup"><span data-stu-id="2097a-113">Use one or both of these options to provide snapshots for publications that use parameterized filters.</span></span> <span data-ttu-id="2097a-114">Если не указать один из этих параметров, подписки будут инициализированы с помощью серии инструкций SELECT и INSERT, а не с использованием программы **bcp** . Этот процесс — гораздо более медленный.</span><span class="sxs-lookup"><span data-stu-id="2097a-114">If you do not specify one of these options, subscriptions are initialized using a series of SELECT and INSERT statements, rather than using the **bcp** utility; this process is much slower.</span></span> <span data-ttu-id="2097a-115">Дополнительные сведения см. в статье [Snapshots for Merge Publications with Parameterized Filters](../snapshots-for-merge-publications-with-parameterized-filters.md).</span><span class="sxs-lookup"><span data-stu-id="2097a-115">For more information, see [Snapshots for Merge Publications with Parameterized Filters](../snapshots-for-merge-publications-with-parameterized-filters.md).</span></span>  
  
 <span data-ttu-id="2097a-116">**Использование предварительно вычисляемых секций**</span><span class="sxs-lookup"><span data-stu-id="2097a-116">**To use precomputed partitions**</span></span>  
  
 <span data-ttu-id="2097a-117">Предварительно вычисляемые секции включены по умолчанию для всех новых и существующих публикаций, соответствующих описанным выше требованиям.</span><span class="sxs-lookup"><span data-stu-id="2097a-117">Precomputed partitions are enabled by default on all new and existing publications that adhere to the guidelines described above.</span></span> <span data-ttu-id="2097a-118">Эту настройку можно изменить с помощью среды [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] или программно.</span><span class="sxs-lookup"><span data-stu-id="2097a-118">The setting can be changed through [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] or programmatically.</span></span> <span data-ttu-id="2097a-119">Дополнительные сведения см. в разделе [Optimize Parameterized Row Filters](../publish/optimize-parameterized-row-filters.md).</span><span class="sxs-lookup"><span data-stu-id="2097a-119">For more information, see [Optimize Parameterized Row Filters](../publish/optimize-parameterized-row-filters.md).</span></span>  
  
## <a name="requirements-for-using-precomputed-partitions"></a><span data-ttu-id="2097a-120">Требования к использованию предварительно вычисляемых секций</span><span class="sxs-lookup"><span data-stu-id="2097a-120">Requirements for Using Precomputed Partitions</span></span>  
 <span data-ttu-id="2097a-121">В случае соответствия следующим требованиям новые публикации слиянием создаются по умолчанию с включенными предварительно вычисляемыми секциями, а существующие публикации автоматически обновляются для использования этой функции.</span><span class="sxs-lookup"><span data-stu-id="2097a-121">If the following requirements are met, new merge publications are, by default, created with precomputed partitions enabled, and existing publications are automatically upgraded to use the feature.</span></span> <span data-ttu-id="2097a-122">Если публикация не соответствует требованиям, включение предварительно вычисляемых секций возможно после изменения публикации.</span><span class="sxs-lookup"><span data-stu-id="2097a-122">If a publication does not meet the requirements, it can be changed, and then precomputed partitions can be enabled.</span></span> <span data-ttu-id="2097a-123">Если некоторые статьи соответствуют этим требованиям, а другие не соответствуют, рассмотрите возможность создания двух публикаций, в одной из которых будут включены предварительно вычисляемые секции.</span><span class="sxs-lookup"><span data-stu-id="2097a-123">If some articles meet these requirements and some do not, consider creating two publications, with one enabled for precomputed partitions.</span></span>  
  
### <a name="requirements-for-filter-clauses"></a><span data-ttu-id="2097a-124">Требования, предъявляемые к предложениям фильтра</span><span class="sxs-lookup"><span data-stu-id="2097a-124">Requirements for Filter Clauses</span></span>  
  
-   <span data-ttu-id="2097a-125">Любые функции, используемые в параметризованных фильтрах строк, например: HOST_NAME() и SUSER_SNAME() — должны находиться непосредственно в предложении параметризованного фильтра, а не быть вложенными в представление или динамическую функцию.</span><span class="sxs-lookup"><span data-stu-id="2097a-125">Any functions used in parameterized row filters, such as HOST_NAME() and SUSER_SNAME(), should appear directly in the parameterized filter clause and not be nested inside of a view or dynamic function.</span></span> <span data-ttu-id="2097a-126">Дополнительные сведения об этих функциях см. в статьях о [HOST_NAME (Transact-SQL)](/sql/t-sql/functions/host-name-transact-sql), [SUSER_SNAME (Transact-SQL)](/sql/t-sql/functions/suser-sname-transact-sql) и [параметризованных фильтрах строк](parameterized-filters-parameterized-row-filters.md).</span><span class="sxs-lookup"><span data-stu-id="2097a-126">For more information about these functions, see [HOST_NAME &#40;Transact-SQL&#41;](/sql/t-sql/functions/host-name-transact-sql), [SUSER_SNAME &#40;Transact-SQL&#41;](/sql/t-sql/functions/suser-sname-transact-sql), and [Parameterized Row Filters](parameterized-filters-parameterized-row-filters.md).</span></span>  
  
-   <span data-ttu-id="2097a-127">Значения, возвращаемые каждому подписчику, не должны изменяться после создания секции.</span><span class="sxs-lookup"><span data-stu-id="2097a-127">The values returned for each Subscriber should not change after the partition is created.</span></span> <span data-ttu-id="2097a-128">Например, если в фильтре используется HOST_NAME() (и при этом значение HOST_NAME() не переопределяется), не изменяйте имя компьютера подписчика.</span><span class="sxs-lookup"><span data-stu-id="2097a-128">For example, if you use HOST_NAME() in a filter (and do not override the HOST_NAME() value) do not change the computer name at the Subscriber.</span></span>  
  
-   <span data-ttu-id="2097a-129">Фильтры соединения не должны содержать динамических функций (например, HOST_NAME() и SUSER_SNAME(), которые возвращают разные значения в зависимости от синхронизируемого подписчика).</span><span class="sxs-lookup"><span data-stu-id="2097a-129">Join filters should not contain dynamic functions (functions such as HOST_NAME() and SUSER_SNAME() that evaluate to a different value depending upon the Subscriber that is synchronizing).</span></span> <span data-ttu-id="2097a-130">Динамические функции должны содержаться только в параметризованных фильтрах строк.</span><span class="sxs-lookup"><span data-stu-id="2097a-130">Only parameterized row filters should contain dynamic functions.</span></span>  
  
-   <span data-ttu-id="2097a-131">В предложении фильтра нельзя использовать недетерминированные функции.</span><span class="sxs-lookup"><span data-stu-id="2097a-131">Nondeterministic functions cannot be used in a filter clause.</span></span> <span data-ttu-id="2097a-132">Дополнительные сведения о недетерминированных функциях см. в разделе [Deterministic and Nondeterministic Functions](../../user-defined-functions/deterministic-and-nondeterministic-functions.md).</span><span class="sxs-lookup"><span data-stu-id="2097a-132">For more information about nondeterministic functions, see [Deterministic and Nondeterministic Functions](../../user-defined-functions/deterministic-and-nondeterministic-functions.md).</span></span>  
  
-   <span data-ttu-id="2097a-133">Представления, на которые имеются ссылки в предложениях фильтра соединения или параметризованного фильтра, не должны содержать динамические функции.</span><span class="sxs-lookup"><span data-stu-id="2097a-133">Views referenced in join filter clauses or parameterized filter clauses should not contain dynamic functions.</span></span>  
  
-   <span data-ttu-id="2097a-134">В публикации не должно быть циклических связей фильтра соединения.</span><span class="sxs-lookup"><span data-stu-id="2097a-134">There should be no circular join filter relationships in the publication.</span></span>  
  
### <a name="database-collation"></a><span data-ttu-id="2097a-135">Параметры сортировки базы данных</span><span class="sxs-lookup"><span data-stu-id="2097a-135">Database Collation</span></span>  
  
-   <span data-ttu-id="2097a-136">Если используются предварительно вычисляемые секции, то при сравнениях всегда применяются параметры сортировки базы данных, а не порядок сортировки таблицы или столбца.</span><span class="sxs-lookup"><span data-stu-id="2097a-136">When precomputed partitions are used, the collation of the database is always used when making comparisons, rather than the collation of the table or column.</span></span> <span data-ttu-id="2097a-137">Рассмотрим следующий сценарий.</span><span class="sxs-lookup"><span data-stu-id="2097a-137">Consider the following scenario:</span></span>  
  
    -   <span data-ttu-id="2097a-138">База данных с параметрами сортировки, учитывающими регистр символов, содержит таблицу с порядком сортировки не учитывающим регистр символов.</span><span class="sxs-lookup"><span data-stu-id="2097a-138">A database with a case-sensitive collation contains a table with a case-insensitive collation.</span></span>  
  
    -   <span data-ttu-id="2097a-139">Таблица содержит столбец **ComputerName**, который сравнивается с именем узла размещения подписчика в параметризованном фильтре.</span><span class="sxs-lookup"><span data-stu-id="2097a-139">The table contains a column **ComputerName**, which is compared against the host name of the Subscriber in a parameterized filter.</span></span>  
  
    -   <span data-ttu-id="2097a-140">Таблица содержит одну строку со значением «МОЙКОМПЬЮТЕР» и одну строку со значением «мойкомпьютер» в том же столбце.</span><span class="sxs-lookup"><span data-stu-id="2097a-140">The table contains one row with the value "MYCOMPUTER" and one row with the value "mycomputer" in this column.</span></span>  
  
     <span data-ttu-id="2097a-141">Если подписчик синхронизируется с узлом по имени «мойкомпьютер», подписчик получит только одну строку, потому что сравнение учитывает регистр символов (параметры сортировки базы данных).</span><span class="sxs-lookup"><span data-stu-id="2097a-141">If the Subscriber synchronizes with a host name of "mycomputer", the Subscriber receives only one row because the comparison is case-sensitive (the collation of the database).</span></span> <span data-ttu-id="2097a-142">Если предварительно вычисляемые секции не используются, подписчик получит обе строки, поскольку таблица имеет параметры сортировки, не зависящие от регистра.</span><span class="sxs-lookup"><span data-stu-id="2097a-142">If precomputed partitions are not used, the Subscriber receives both rows, because the table has a case-insensitive collation.</span></span>  
  
## <a name="performance-of-precomputed-partitions"></a><span data-ttu-id="2097a-143">Производительность предварительно вычисляемых секций</span><span class="sxs-lookup"><span data-stu-id="2097a-143">Performance of Precomputed Partitions</span></span>  
 <span data-ttu-id="2097a-144">При использовании предварительно вычисляемых секций имеет место определенная потеря производительности, когда изменения передаются с подписчика на издатель, но большая часть времени процесса слияния затрачивается на оценку секций и на загрузку изменений с издателя на подписчик, поэтому чистый выигрыш в производительности может быть довольно значительным.</span><span class="sxs-lookup"><span data-stu-id="2097a-144">There is a small performance cost with precomputed partitions when changes are uploaded from the Subscriber to the Publisher, but the bulk of merge processing time is spent evaluating partitions and downloading changes from the Publisher to the Subscriber, so the net gain can still be significant.</span></span> <span data-ttu-id="2097a-145">Увеличение производительности может быть разным в зависимости от числа одновременно синхронизирующихся подписчиков, а также от количества обновлений в синхронизации, в которых строки переносятся из одной секции в другую.</span><span class="sxs-lookup"><span data-stu-id="2097a-145">The performance benefit will vary, depending on the number of Subscribers synchronizing concurrently and the number of updates per synchronization that move rows from one partition to another.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2097a-146">См. также:</span><span class="sxs-lookup"><span data-stu-id="2097a-146">See Also</span></span>  
 [<span data-ttu-id="2097a-147">Параметризованные фильтры строк</span><span class="sxs-lookup"><span data-stu-id="2097a-147">Parameterized Row Filters</span></span>](parameterized-filters-parameterized-row-filters.md)  
  
  
