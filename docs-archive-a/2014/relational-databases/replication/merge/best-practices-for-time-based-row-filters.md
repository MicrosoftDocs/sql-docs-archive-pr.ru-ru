---
title: Рекомендации для фильтров строк на основе времени | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- best practices
ms.assetid: 773c5c62-fd44-44ab-9c6b-4257dbf8ffdb
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: ccaafe71d4137fd4b31eec412c1e35595861bdd0
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87654216"
---
# <a name="best-practices-for-time-based-row-filters"></a><span data-ttu-id="59d41-102">Оптимальные методы для фильтров строк на основе времени</span><span class="sxs-lookup"><span data-stu-id="59d41-102">Best Practices for Time-Based Row Filters</span></span>
  <span data-ttu-id="59d41-103">Пользователям приложений часто требуется подмножество данных из таблицы, относящихся к определенному времени.</span><span class="sxs-lookup"><span data-stu-id="59d41-103">Users of applications often require a time-based subset of data from a table.</span></span> <span data-ttu-id="59d41-104">Например, менеджеру по продажам могут понадобиться данные заказов за последнюю неделю, или планировщику событий требуются данные о событиях на следующей неделе.</span><span class="sxs-lookup"><span data-stu-id="59d41-104">For instance, a salesperson might require data for orders in the last week, or an event planner might require data for events in the upcoming week.</span></span> <span data-ttu-id="59d41-105">Во многих случаях приложения используют для этого запросы, содержащие функцию `GETDATE()`.</span><span class="sxs-lookup"><span data-stu-id="59d41-105">In many cases, applications use queries containing the `GETDATE()` function to accomplish this.</span></span> <span data-ttu-id="59d41-106">Рассмотрим следующую инструкцию фильтра строк:</span><span class="sxs-lookup"><span data-stu-id="59d41-106">Consider the following row filter statement:</span></span>  
  
```  
WHERE SalesPersonID = CONVERT(INT,HOST_NAME()) AND OrderDate >= (GETDATE()-6)  
```  
  
 <span data-ttu-id="59d41-107">С фильтром такого типа обычно подразумевается, что при выполнении агента слияния происходят две вещи: строки, удовлетворяющие условиям фильтра, реплицируются в подписчиках, а строки, больше не удовлетворяющие условию, удаляются в подписчиках.</span><span class="sxs-lookup"><span data-stu-id="59d41-107">With a filter of this type, it is usually assumed that two things always occur when the Merge Agent runs: rows that satisfy this filter are replicated to Subscribers; and rows that no longer satisfy this filter are cleaned up at Subscribers.</span></span> <span data-ttu-id="59d41-108">(Дополнительные сведения о фильтрации с помощью `HOST_NAME()` см. в разделе [параметризованные фильтры строк](parameterized-filters-parameterized-row-filters.md).) Однако репликация слиянием реплицирует и очищает данные, которые изменились со времени последней синхронизации, независимо от того, как вы определили фильтр строк для этих данных.</span><span class="sxs-lookup"><span data-stu-id="59d41-108">(For more information about filtering with `HOST_NAME()`, see [Parameterized Row Filters](parameterized-filters-parameterized-row-filters.md).) However, merge replication only replicates and cleans up data that has changed since the last synchronization, regardless of how you define a row filter for that data.</span></span>  
  
 <span data-ttu-id="59d41-109">Чтобы репликация слиянием могла обработать строку, данные в строке должны удовлетворять условиям фильтра строк и должны измениться с момента последней синхронизации.</span><span class="sxs-lookup"><span data-stu-id="59d41-109">For merge replication to process a row, the data in the row must satisfy the row filter, and it must have changed since the last synchronization.</span></span> <span data-ttu-id="59d41-110">В случае таблицы **SalesOrderHeader** при вставке строки вводится **OrderDate** .</span><span class="sxs-lookup"><span data-stu-id="59d41-110">In the case of the **SalesOrderHeader** table, **OrderDate** is entered when a row is inserted.</span></span> <span data-ttu-id="59d41-111">Строки правильно реплицируются на подписчик, потому что вставка является изменением данных.</span><span class="sxs-lookup"><span data-stu-id="59d41-111">Rows are replicated to the Subscriber as expected because the insert is a data change.</span></span> <span data-ttu-id="59d41-112">Однако если в подписчике имеются строки, больше не удовлетворяющие условиям фильтра (заказы старше семи дней), они не удаляются из подписчика, если не были обновлены по какой-то другой причине.</span><span class="sxs-lookup"><span data-stu-id="59d41-112">However, if there are rows at the Subscriber that no longer satisfy the filter (they are for orders older than seven days), they are not removed from the Subscriber unless they were updated for some other reason.</span></span>  
  
 <span data-ttu-id="59d41-113">Пример планировщика событий делает более понятной проблему этого типа фильтрации.</span><span class="sxs-lookup"><span data-stu-id="59d41-113">The case of the event planner further highlights the issue with this type of filtering.</span></span> <span data-ttu-id="59d41-114">Рассмотрим следующий фильтр для таблицы **Events** :</span><span class="sxs-lookup"><span data-stu-id="59d41-114">Consider the following filter for an **Events** table:</span></span>  
  
```  
WHERE EventCoordID = CONVERT(INT,HOST_NAME()) AND EventDate <= (GETDATE()+6)  
```  
  
 <span data-ttu-id="59d41-115">В таблице, содержащей события, вставки должны выполняться задолго до даты события.</span><span class="sxs-lookup"><span data-stu-id="59d41-115">For a table that contains events, inserts might be made well ahead of the event date.</span></span> <span data-ttu-id="59d41-116">Если вставка для события была выполнена месяц назад и строка не обновлялась по какой-то другой причине, эта строка не реплицируется на подписчик, даже если удовлетворяет условиям фильтра строк.</span><span class="sxs-lookup"><span data-stu-id="59d41-116">If the insert for an event in the coming week was made a month ago and the row was not updated for another reason, the row is not replicated to the Subscriber even if it satisfies the row filter.</span></span>  
  
 <span data-ttu-id="59d41-117">Кроме того, в зависимости от настройки публикации репликация слиянием вычисляет фильтры в разное время:</span><span class="sxs-lookup"><span data-stu-id="59d41-117">In addition, depending on how the publication is configured, merge replication evaluates filters at different times:</span></span>  
  
-   <span data-ttu-id="59d41-118">Если в публикации используются предварительно вычисляемые секции (по умолчанию), фильтры вычисляются при вставке или обновлении строк.</span><span class="sxs-lookup"><span data-stu-id="59d41-118">If a publication uses precomputed partitions (the default), filters are evaluated when a row is inserted or updated.</span></span>  
  
-   <span data-ttu-id="59d41-119">Если в публикации не используются предварительно вычисляемые секции, фильтры вычисляются при выполнении агента слияния.</span><span class="sxs-lookup"><span data-stu-id="59d41-119">If the publication does not use precomputed partitions, filters are evaluated when the Merge Agent runs.</span></span>  
  
 <span data-ttu-id="59d41-120">Дополнительные сведения о предварительно вычисляемых секциях см. в статье [Оптимизация производительности параметризованного фильтра с помощью предварительно вычисляемых секций](parameterized-filters-optimize-for-precomputed-partitions.md).</span><span class="sxs-lookup"><span data-stu-id="59d41-120">For more information about precomputed partitions, see [Optimize Parameterized Filter Performance with Precomputed Partitions](parameterized-filters-optimize-for-precomputed-partitions.md).</span></span> <span data-ttu-id="59d41-121">Время вычисления фильтра влияет на то, какие данные удовлетворяют условиям фильтра.</span><span class="sxs-lookup"><span data-stu-id="59d41-121">The time at which the filter is evaluated affects what data satisfies the filter.</span></span> <span data-ttu-id="59d41-122">Например, если в публикации используются предварительно вычисляемые секции, а данные синхронизируются каждые два дня, подмножество данных для менеджера по продажам может включать строки на два дня старше, чем ожидалось.</span><span class="sxs-lookup"><span data-stu-id="59d41-122">For example, if a publication uses precomputed partitions, and you synchronize data every two days, the subset of data for the salesperson could include rows up to two days older than expected.</span></span>  
  
## <a name="recommendations-for-using-time-based-row-filters"></a><span data-ttu-id="59d41-123">Рекомендации по использованию фильтров строк на основе времени</span><span class="sxs-lookup"><span data-stu-id="59d41-123">Recommendations for Using Time-Based Row Filters</span></span>  
 <span data-ttu-id="59d41-124">Следующий метод обеспечивает простой и надежный подход к фильтрации, основанной на времени:</span><span class="sxs-lookup"><span data-stu-id="59d41-124">The following method provides a robust and straightforward approach to filtering based on time:</span></span>  
  
-   <span data-ttu-id="59d41-125">Добавьте в таблицу столбец с типом данных `bit`.</span><span class="sxs-lookup"><span data-stu-id="59d41-125">Add a column to the table of data type `bit`.</span></span> <span data-ttu-id="59d41-126">Он используется для указания, должна ли реплицироваться строка.</span><span class="sxs-lookup"><span data-stu-id="59d41-126">This column is used to indicate whether a row should be replicated.</span></span>  
  
-   <span data-ttu-id="59d41-127">Используйте фильтр строк, который ссылается на добавленный столбец, а не на временной столбец.</span><span class="sxs-lookup"><span data-stu-id="59d41-127">Use a row filter that references the new column rather than a time-based column.</span></span>  
  
-   <span data-ttu-id="59d41-128">Создайте задание агента SQL Server (или задание, запланированное с помощью другого механизма), которое будет обновлять этот столбец перед запуском агента слияния.</span><span class="sxs-lookup"><span data-stu-id="59d41-128">Create a SQL Server Agent job (or a job scheduled through another mechanism) that updates the column before the Merge Agent is scheduled to run.</span></span>  
  
 <span data-ttu-id="59d41-129">Такой подход решает недостатки использования функции `GETDATE()` или другого метода на основе времени и помогает избежать необходимости определять время вычисления фильтров для секций.</span><span class="sxs-lookup"><span data-stu-id="59d41-129">This approach addresses the shortcomings of using `GETDATE()` or another time-based method and avoids the problem of having to determine when filters are evaluated for partitions.</span></span> <span data-ttu-id="59d41-130">Рассмотрим следующий пример для таблицы **Events** :</span><span class="sxs-lookup"><span data-stu-id="59d41-130">Consider the following example of an **Events** table:</span></span>  
  
|<span data-ttu-id="59d41-131">**EventID**</span><span class="sxs-lookup"><span data-stu-id="59d41-131">**EventID**</span></span>|<span data-ttu-id="59d41-132">**EventName**</span><span class="sxs-lookup"><span data-stu-id="59d41-132">**EventName**</span></span>|<span data-ttu-id="59d41-133">**EventCoordID**</span><span class="sxs-lookup"><span data-stu-id="59d41-133">**EventCoordID**</span></span>|<span data-ttu-id="59d41-134">**EventDate**</span><span class="sxs-lookup"><span data-stu-id="59d41-134">**EventDate**</span></span>|<span data-ttu-id="59d41-135">**Репликация**</span><span class="sxs-lookup"><span data-stu-id="59d41-135">**Replicate**</span></span>|  
|-----------------|-------------------|----------------------|-------------------|-------------------|  
|<span data-ttu-id="59d41-136">1</span><span class="sxs-lookup"><span data-stu-id="59d41-136">1</span></span>|<span data-ttu-id="59d41-137">Прием</span><span class="sxs-lookup"><span data-stu-id="59d41-137">Reception</span></span>|<span data-ttu-id="59d41-138">112</span><span class="sxs-lookup"><span data-stu-id="59d41-138">112</span></span>|<span data-ttu-id="59d41-139">2006-10-04</span><span class="sxs-lookup"><span data-stu-id="59d41-139">2006-10-04</span></span>|<span data-ttu-id="59d41-140">1</span><span class="sxs-lookup"><span data-stu-id="59d41-140">1</span></span>|  
|<span data-ttu-id="59d41-141">2</span><span class="sxs-lookup"><span data-stu-id="59d41-141">2</span></span>|<span data-ttu-id="59d41-142">Обед</span><span class="sxs-lookup"><span data-stu-id="59d41-142">Dinner</span></span>|<span data-ttu-id="59d41-143">112</span><span class="sxs-lookup"><span data-stu-id="59d41-143">112</span></span>|<span data-ttu-id="59d41-144">2006-10-10</span><span class="sxs-lookup"><span data-stu-id="59d41-144">2006-10-10</span></span>|<span data-ttu-id="59d41-145">0</span><span class="sxs-lookup"><span data-stu-id="59d41-145">0</span></span>|  
|<span data-ttu-id="59d41-146">3</span><span class="sxs-lookup"><span data-stu-id="59d41-146">3</span></span>|<span data-ttu-id="59d41-147">Вечеринка</span><span class="sxs-lookup"><span data-stu-id="59d41-147">Party</span></span>|<span data-ttu-id="59d41-148">112</span><span class="sxs-lookup"><span data-stu-id="59d41-148">112</span></span>|<span data-ttu-id="59d41-149">2006-10-11</span><span class="sxs-lookup"><span data-stu-id="59d41-149">2006-10-11</span></span>|<span data-ttu-id="59d41-150">0</span><span class="sxs-lookup"><span data-stu-id="59d41-150">0</span></span>|  
|<span data-ttu-id="59d41-151">4</span><span class="sxs-lookup"><span data-stu-id="59d41-151">4</span></span>|<span data-ttu-id="59d41-152">Свадьба</span><span class="sxs-lookup"><span data-stu-id="59d41-152">Wedding</span></span>|<span data-ttu-id="59d41-153">112</span><span class="sxs-lookup"><span data-stu-id="59d41-153">112</span></span>|<span data-ttu-id="59d41-154">2006-10-12</span><span class="sxs-lookup"><span data-stu-id="59d41-154">2006-10-12</span></span>|<span data-ttu-id="59d41-155">0</span><span class="sxs-lookup"><span data-stu-id="59d41-155">0</span></span>|  
  
 <span data-ttu-id="59d41-156">Фильтр строк для этой таблицы будет выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="59d41-156">The row filter for this table would then look like this:</span></span>  
  
```  
WHERE EventCoordID = CONVERT(INT,HOST_NAME()) AND Replicate = 1  
```  
  
 <span data-ttu-id="59d41-157">Задание агента SQL Server перед запуском агента слияния может выполнять инструкции [!INCLUDE[tsql](../../../includes/tsql-md.md)] , похожие на следующие:</span><span class="sxs-lookup"><span data-stu-id="59d41-157">The SQL Server Agent job could execute [!INCLUDE[tsql](../../../includes/tsql-md.md)] statements similar to the following before each Merge Agent run:</span></span>  
  
```  
UPDATE Events SET Replicate = 0 WHERE Replicate = 1  
GO  
UPDATE Events SET Replicate = 1 WHERE EventDate <= GETDATE()+6  
GO  
```  
  
 <span data-ttu-id="59d41-158">Первая строка сбрасывает столбец **Replicate** на **0**, а вторая устанавливает значение столбца на **1** для событий, которые произойдут в течение следующих семи дней.</span><span class="sxs-lookup"><span data-stu-id="59d41-158">The first line resets the **Replicate** column to **0**, and the second line sets the column to **1** for events that occur in the next seven days.</span></span> <span data-ttu-id="59d41-159">Если эта инструкция [!INCLUDE[tsql](../../../includes/tsql-md.md)] будет выполнена 10/07/2006, таблица обновляется следующим образом:</span><span class="sxs-lookup"><span data-stu-id="59d41-159">If this [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement runs on 10/07/2006, the table is updated to:</span></span>  
  
|<span data-ttu-id="59d41-160">**EventID**</span><span class="sxs-lookup"><span data-stu-id="59d41-160">**EventID**</span></span>|<span data-ttu-id="59d41-161">**EventName**</span><span class="sxs-lookup"><span data-stu-id="59d41-161">**EventName**</span></span>|<span data-ttu-id="59d41-162">**EventCoordID**</span><span class="sxs-lookup"><span data-stu-id="59d41-162">**EventCoordID**</span></span>|<span data-ttu-id="59d41-163">**EventDate**</span><span class="sxs-lookup"><span data-stu-id="59d41-163">**EventDate**</span></span>|<span data-ttu-id="59d41-164">**Репликация**</span><span class="sxs-lookup"><span data-stu-id="59d41-164">**Replicate**</span></span>|  
|-----------------|-------------------|----------------------|-------------------|-------------------|  
|<span data-ttu-id="59d41-165">1</span><span class="sxs-lookup"><span data-stu-id="59d41-165">1</span></span>|<span data-ttu-id="59d41-166">Прием</span><span class="sxs-lookup"><span data-stu-id="59d41-166">Reception</span></span>|<span data-ttu-id="59d41-167">112</span><span class="sxs-lookup"><span data-stu-id="59d41-167">112</span></span>|<span data-ttu-id="59d41-168">2006-10-04</span><span class="sxs-lookup"><span data-stu-id="59d41-168">2006-10-04</span></span>|<span data-ttu-id="59d41-169">0</span><span class="sxs-lookup"><span data-stu-id="59d41-169">0</span></span>|  
|<span data-ttu-id="59d41-170">2</span><span class="sxs-lookup"><span data-stu-id="59d41-170">2</span></span>|<span data-ttu-id="59d41-171">Обед</span><span class="sxs-lookup"><span data-stu-id="59d41-171">Dinner</span></span>|<span data-ttu-id="59d41-172">112</span><span class="sxs-lookup"><span data-stu-id="59d41-172">112</span></span>|<span data-ttu-id="59d41-173">2006-10-10</span><span class="sxs-lookup"><span data-stu-id="59d41-173">2006-10-10</span></span>|<span data-ttu-id="59d41-174">1</span><span class="sxs-lookup"><span data-stu-id="59d41-174">1</span></span>|  
|<span data-ttu-id="59d41-175">3</span><span class="sxs-lookup"><span data-stu-id="59d41-175">3</span></span>|<span data-ttu-id="59d41-176">Вечеринка</span><span class="sxs-lookup"><span data-stu-id="59d41-176">Party</span></span>|<span data-ttu-id="59d41-177">112</span><span class="sxs-lookup"><span data-stu-id="59d41-177">112</span></span>|<span data-ttu-id="59d41-178">2006-10-11</span><span class="sxs-lookup"><span data-stu-id="59d41-178">2006-10-11</span></span>|<span data-ttu-id="59d41-179">1</span><span class="sxs-lookup"><span data-stu-id="59d41-179">1</span></span>|  
|<span data-ttu-id="59d41-180">4</span><span class="sxs-lookup"><span data-stu-id="59d41-180">4</span></span>|<span data-ttu-id="59d41-181">Свадьба</span><span class="sxs-lookup"><span data-stu-id="59d41-181">Wedding</span></span>|<span data-ttu-id="59d41-182">112</span><span class="sxs-lookup"><span data-stu-id="59d41-182">112</span></span>|<span data-ttu-id="59d41-183">2006-10-12</span><span class="sxs-lookup"><span data-stu-id="59d41-183">2006-10-12</span></span>|<span data-ttu-id="59d41-184">1</span><span class="sxs-lookup"><span data-stu-id="59d41-184">1</span></span>|  
  
 <span data-ttu-id="59d41-185">События следующей недели теперь помечены как готовые к репликации.</span><span class="sxs-lookup"><span data-stu-id="59d41-185">The events for the next week are now flagged as being ready to replicate.</span></span> <span data-ttu-id="59d41-186">При следующем запуске агента слияния для подписки, которую использует координатор событий 112, строки 2, 3 и 4 будут загружены на подписчик, а строка 1 будет из него удалена.</span><span class="sxs-lookup"><span data-stu-id="59d41-186">The next time the Merge Agent runs for the subscription that event coordinator 112 uses, rows 2, 3, and 4 will be downloaded to the Subscriber and row 1 will be removed from the Subscriber.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="59d41-187">См. также:</span><span class="sxs-lookup"><span data-stu-id="59d41-187">See Also</span></span>  
 <span data-ttu-id="59d41-188">[GETDATE (Transact-SQL)](/sql/t-sql/functions/getdate-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="59d41-188">[GETDATE &#40;Transact-SQL&#41;](/sql/t-sql/functions/getdate-transact-sql) </span></span>  
 <span data-ttu-id="59d41-189">[Реализация заданий](../../../ssms/agent/implement-jobs.md) </span><span class="sxs-lookup"><span data-stu-id="59d41-189">[Implement Jobs](../../../ssms/agent/implement-jobs.md) </span></span>  
 [<span data-ttu-id="59d41-190">Параметризованные фильтры строк</span><span class="sxs-lookup"><span data-stu-id="59d41-190">Parameterized Row Filters</span></span>](parameterized-filters-parameterized-row-filters.md)  
  
  
