---
title: Репликация столбцов идентификаторов | Документация Майкрософт
ms.custom: ''
ms.date: 10/04/2016
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- identities [SQL Server replication]
- identity values [SQL Server replication]
- merge replication [SQL Server replication], identity range management
- publishing [SQL Server replication], identity columns
- transactional replication, identity range management
- identity columns [SQL Server], replication
ms.assetid: eb2f23a8-7ec2-48af-9361-0e3cb87ebaf7
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: c899d902e403e9f7cdbdfd1a83cde110e627ab11
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87656313"
---
# <a name="replicate-identity-columns"></a><span data-ttu-id="2f754-102">Репликация столбцов идентификаторов</span><span class="sxs-lookup"><span data-stu-id="2f754-102">Replicate Identity Columns</span></span>
  <span data-ttu-id="2f754-103">Когда столбцу назначается свойство IDENTITY, [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] автоматически создает последовательные номера для новых строк, вставляемых в таблицу, которая содержит столбец идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-103">When you assign an IDENTITY property to a column, [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] automatically generates sequential numbers for new rows inserted in the table containing the identity column.</span></span> <span data-ttu-id="2f754-104">Дополнительные сведения см. в статье о [свойстве IDENTITY (Transact-SQL)](/sql/t-sql/statements/create-table-transact-sql-identity-property).</span><span class="sxs-lookup"><span data-stu-id="2f754-104">For more information, see [IDENTITY &#40;Property&#41; &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-table-transact-sql-identity-property).</span></span> <span data-ttu-id="2f754-105">Так как столбцы идентификаторов могут быть включены как часть первичного ключа, важно исключить появление повторяющихся значений в столбцах идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-105">Because identity columns might be included as a part of the primary key, it is important to avoid duplicate values in the identity columns.</span></span> <span data-ttu-id="2f754-106">Для использования столбцов идентификаторов в топологии репликации, имеющей обновления на нескольких узлах, все узлы топологии репликации должны использовать разные диапазоны значений идентификаторов, чтобы исключить появление повторяющихся идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-106">To use identity columns in a replication topology that has updates at more than one node, each node in the replication topology must use a different range of identity values, so that duplicates do not occur.</span></span>  
  
 <span data-ttu-id="2f754-107">Например, для издателя может быть задано значение в диапазоне от 1 до 100, для подписчика А в диапазоне от 101 от 200, а для подписчика Б в диапазоне от 201 до 300.</span><span class="sxs-lookup"><span data-stu-id="2f754-107">For example, the Publisher could be assigned the range 1-100, Subscriber A the range 101-200, and Subscriber B the range 201-300.</span></span> <span data-ttu-id="2f754-108">Если строка вставляется в издателе и идентификатор имеет значение, равное, например, 65, это значение реплицируется на все подписчики.</span><span class="sxs-lookup"><span data-stu-id="2f754-108">If a row is inserted at the Publisher and the identity value is, for example, 65, that value is replicated to each Subscriber.</span></span> <span data-ttu-id="2f754-109">Когда репликация вставляет данные на каждый подписчик, она не увеличивает значение столбца идентификаторов в таблице подписчика; вместо этого вставляется буквенное значение 65.</span><span class="sxs-lookup"><span data-stu-id="2f754-109">When replication inserts data at each Subscriber, it does not increment the identity column value in the Subscriber table; instead, the literal value 65 is inserted.</span></span> <span data-ttu-id="2f754-110">Увеличение значения столбца идентификаторов вызывается только пользовательскими вставками, а не вставками агента репликации.</span><span class="sxs-lookup"><span data-stu-id="2f754-110">Only user inserts, but not replication agent inserts cause the identity column value to be incremented.</span></span>  
  
 <span data-ttu-id="2f754-111">Репликация обрабатывает столбцы идентификаторов в публикациях и подписках всех типов, что позволяет управлять столбцами вручную или разрешать механизму репликации автоматически управлять столбцами.</span><span class="sxs-lookup"><span data-stu-id="2f754-111">Replication handles identity columns across all publication and subscription types, allowing you to manage the columns manually or have replication manage them automatically.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2f754-112">Добавление столбца идентификаторов в опубликованную таблицу не поддерживается, поскольку это может привести к расхождению данных при репликации столбца на подписчик.</span><span class="sxs-lookup"><span data-stu-id="2f754-112">Adding an identity column to a published table is not supported, because it can result in non-convergence when the column is replicated to the Subscriber.</span></span> <span data-ttu-id="2f754-113">Значения в столбце идентификаторов на издателе зависят от порядка, в котором строки изменяемой таблицы хранятся физически.</span><span class="sxs-lookup"><span data-stu-id="2f754-113">The values in the identity column at the Publisher depend on the order in which the rows for the affected table are physically stored.</span></span> <span data-ttu-id="2f754-114">Строки могут храниться по-разному на подписчике. Поэтому значение для столбца идентификаторов может быть разным для одинаковых строк.</span><span class="sxs-lookup"><span data-stu-id="2f754-114">The rows might be stored differently at the Subscriber; therefore the value for the identity column can be different for the same rows.</span></span>  
  
## <a name="specifying-an-identity-range-management-option"></a><span data-ttu-id="2f754-115">Указание режима управления диапазонами идентификаторов</span><span class="sxs-lookup"><span data-stu-id="2f754-115">Specifying an Identity Range Management Option</span></span>  
 <span data-ttu-id="2f754-116">Репликация предоставляет три режима управления диапазонами идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-116">Replication offers three identity range management options:</span></span>  
  
-   <span data-ttu-id="2f754-117">Автоматический.</span><span class="sxs-lookup"><span data-stu-id="2f754-117">Automatic.</span></span> <span data-ttu-id="2f754-118">Используется для репликации слиянием и репликации транзакций с обновлениями на подписчике.</span><span class="sxs-lookup"><span data-stu-id="2f754-118">Used for merge replication and transactional replication with updates at the Subscriber.</span></span> <span data-ttu-id="2f754-119">Укажите диапазоны размера для издателя и подписчиков, и репликация будет автоматически управлять назначением новых диапазонов.</span><span class="sxs-lookup"><span data-stu-id="2f754-119">Specify size ranges for the Publisher and Subscribers, and replication automatically manages the assignment of new ranges.</span></span> <span data-ttu-id="2f754-120">Репликация устанавливает параметр NOT FOR REPLICATION для столбца идентификаторов на подписчике, чтобы увеличение значения на подписчике вызывалось только пользовательскими вставками.</span><span class="sxs-lookup"><span data-stu-id="2f754-120">Replication sets the NOT FOR REPLICATION option on the identity column at the Subscriber, so that only user inserts cause the value to be incremented at the Subscriber.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="2f754-121">Для получения новых диапазонов подписчики должны синхронизироваться с издателем.</span><span class="sxs-lookup"><span data-stu-id="2f754-121">Subscribers must synchronize with the Publisher to receive new ranges.</span></span> <span data-ttu-id="2f754-122">Поскольку диапазоны идентификаторов назначаются подписчикам автоматически, существует возможность исчерпания всех диапазонов идентификаторов каким-либо подписчиком, если он будет многократно повторять запросы новых диапазонов.</span><span class="sxs-lookup"><span data-stu-id="2f754-122">Because Subscribers are assigned identity ranges automatically, it is possible for any Subscriber to exhaust the entire supply of identity ranges if it repeatedly requests new ranges.</span></span>  
  
-   <span data-ttu-id="2f754-123">Вручную.</span><span class="sxs-lookup"><span data-stu-id="2f754-123">Manual.</span></span> <span data-ttu-id="2f754-124">Используется для репликации моментальных снимков и репликации транзакций без обновлений на подписчике, для одноранговой репликации транзакций или если приложение должно программно управлять диапазонами идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-124">Used for snapshot and transactional replication without updates at the Subscriber, peer-to-peer transactional replication, or if your application must control identity ranges programmatically.</span></span> <span data-ttu-id="2f754-125">Если указывается ручной режим управления, следует обеспечить назначение диапазонов издателю и каждому подписчику, а также назначение новых диапазонов при использовании исходных диапазонов.</span><span class="sxs-lookup"><span data-stu-id="2f754-125">If you specify manual management, you must ensure that ranges are assigned to the Publisher and each Subscriber and that new ranges are assigned if the initial ranges are used.</span></span> <span data-ttu-id="2f754-126">Репликация устанавливает параметр NOT FOR REPLICATION для столбца идентификаторов на подписчике.</span><span class="sxs-lookup"><span data-stu-id="2f754-126">Replication sets the NOT FOR REPLICATION option on the identity column at the Subscriber.</span></span>  
  
-   <span data-ttu-id="2f754-127">Нет.</span><span class="sxs-lookup"><span data-stu-id="2f754-127">None.</span></span> <span data-ttu-id="2f754-128">Этот режим рекомендуется только для обеспечения обратной совместимости с предыдущими версиями [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] и доступен только из интерфейса хранимой процедуры для публикаций транзакций.</span><span class="sxs-lookup"><span data-stu-id="2f754-128">This option is recommended only for backwards compatibility with earlier versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and is available only from the stored procedure interface for transactional publications.</span></span>  
  
 <span data-ttu-id="2f754-129">Сведения об указании варианта управления диапазонами идентификаторов см. в [этой статье](manage-identity-columns.md).</span><span class="sxs-lookup"><span data-stu-id="2f754-129">To specify an identity range management option, see [Manage Identity Columns](manage-identity-columns.md).</span></span>  
  
## <a name="assigning-identity-ranges"></a><span data-ttu-id="2f754-130">Назначение диапазонов идентификаторов</span><span class="sxs-lookup"><span data-stu-id="2f754-130">Assigning Identity Ranges</span></span>  
 <span data-ttu-id="2f754-131">Репликация слиянием и репликация транзакций используют разные методы для назначения диапазонов. Эти методы описаны в данном разделе.</span><span class="sxs-lookup"><span data-stu-id="2f754-131">Merge replication and transactional replication use different methods for assigning ranges; these methods are described in this section.</span></span>  
  
 <span data-ttu-id="2f754-132">Существует два типа диапазонов, которые необходимо учитывать при репликации столбцов идентификаторов: диапазоны, назначаемые издателю и подписчикам, и диапазон типа данных в столбце.</span><span class="sxs-lookup"><span data-stu-id="2f754-132">There are two types of ranges to take into account when replicating identity columns: the ranges assigned to the Publisher and Subscribers, and the range of the data type in the column.</span></span> <span data-ttu-id="2f754-133">Следующая таблица показывает доступные диапазоны для типов данных, обычно используемых в столбцах идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-133">The following table shows the ranges available for the data types typically used in identity columns.</span></span> <span data-ttu-id="2f754-134">Диапазон используется во всех узлах топологии.</span><span class="sxs-lookup"><span data-stu-id="2f754-134">The range is used across all nodes in a topology.</span></span> <span data-ttu-id="2f754-135">Например, если вы используете `smallint` начальное значение 1 с шагом 1, максимальное число вставок равно 32 767 для издателя и всех подписчиков.</span><span class="sxs-lookup"><span data-stu-id="2f754-135">For example, if you use `smallint` starting at 1 with an increment of 1, the maximum number of inserts is 32,767 for the Publisher and all Subscribers.</span></span> <span data-ttu-id="2f754-136">Реальное число вставок зависит от наличия промежутков в используемых значениях и от использования порогового значения.</span><span class="sxs-lookup"><span data-stu-id="2f754-136">The actual number of inserts depends on whether there are gaps in the values used and whether a threshold value is used.</span></span> <span data-ttu-id="2f754-137">Дополнительные сведения о пороговых значениях см. в следующих разделах: «Репликация слиянием» и «Репликация транзакций с подписками, обновляемыми посредством очередей».</span><span class="sxs-lookup"><span data-stu-id="2f754-137">For more information about thresholds, see the following sections "Merge Replication" and "Transactional Replication with Queued Updating Subscriptions".</span></span>  
  
 <span data-ttu-id="2f754-138">Если издатель после вставки исчерпывает свой диапазон идентификаторов, он может автоматически назначить новый диапазон при условии, что вставка была выполнена членом предопределенной роли **db_owner** базы данных.</span><span class="sxs-lookup"><span data-stu-id="2f754-138">If the Publisher exhausts its identity range after an insert, it can automatically assign a new range if the insert was performed by a member of the **db_owner** fixed database role.</span></span> <span data-ttu-id="2f754-139">Если вставка была выполнена пользователем, не являющимся членом этой роли, следует выполнить [sp_adjustpublisheridentityrange &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-adjustpublisheridentityrange-transact-sql) от имени агента чтения журнала, агента слияния или пользователя, входящего в роль **db_owner**.</span><span class="sxs-lookup"><span data-stu-id="2f754-139">If the insert was performed by a user not in that role, the Log Reader Agent, Merge Agent, or a user who is a member of the **db_owner** role must run [sp_adjustpublisheridentityrange &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-adjustpublisheridentityrange-transact-sql).</span></span> <span data-ttu-id="2f754-140">Чтобы назначение нового диапазона для публикаций транзакций происходило автоматически, должен выполняться агент чтения журнала (по умолчанию агент функционирует в непрерывном режиме).</span><span class="sxs-lookup"><span data-stu-id="2f754-140">For transactional publications, the Log Reader Agent must be running to automatically allocate a new range (the default is for the agent to run continuously).</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="2f754-141">Во время вставки большого пакета триггер репликации запускается только один раз, а не каждый раз при вставке строки.</span><span class="sxs-lookup"><span data-stu-id="2f754-141">During a large batch insert the replication trigger is fired only once, not for each row of the insert.</span></span> <span data-ttu-id="2f754-142">Это может привести к ошибке инструкции вставки, если диапазон идентификаторов исчерпан в ходе большой вставки, например при выполнении инструкции `INSERT INTO`.</span><span class="sxs-lookup"><span data-stu-id="2f754-142">This can lead to a failure of the insert statement if an identity range is exhausted during an large insert, such as an `INSERT INTO` statement.</span></span>  
  
|<span data-ttu-id="2f754-143">Тип данных</span><span class="sxs-lookup"><span data-stu-id="2f754-143">Data type</span></span>|<span data-ttu-id="2f754-144">Диапазон</span><span class="sxs-lookup"><span data-stu-id="2f754-144">Range</span></span>|  
|---------------|-----------|  
|`tinyint`|<span data-ttu-id="2f754-145">Режимом автоматического управления не поддерживается</span><span class="sxs-lookup"><span data-stu-id="2f754-145">Not supported for automatic management</span></span>|  
|`smallint`|<span data-ttu-id="2f754-146">от -2^15 (-32 768) до 2^15-1 (32 767)</span><span class="sxs-lookup"><span data-stu-id="2f754-146">-2^15 (-32,768) to 2^15-1 (32,767)</span></span>|  
|`int`|<span data-ttu-id="2f754-147">от -2^31 (-2 147 483 648) до 2^31-1 (2 147 483 647)</span><span class="sxs-lookup"><span data-stu-id="2f754-147">-2^31 (-2,147,483,648) to 2^31-1 (2,147,483,647)</span></span>|  
|`bigint`|<span data-ttu-id="2f754-148">от -2^63 (-9 223 372 036 854 775 808) до 2^63-1 (9 223 372 036 854 775 807)</span><span class="sxs-lookup"><span data-stu-id="2f754-148">-2^63 (-9,223,372,036,854,775,808) to 2^63-1 (9,223,372,036,854,775,807)</span></span>|  
|<span data-ttu-id="2f754-149">`decimal` и `numeric`</span><span class="sxs-lookup"><span data-stu-id="2f754-149">`decimal` and `numeric`</span></span>|<span data-ttu-id="2f754-150">от -10^38+1 до 10^38-1</span><span class="sxs-lookup"><span data-stu-id="2f754-150">-10^38+1 through 10^38-1</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="2f754-151">Сведения о том, как создать автоматически увеличивающееся числовое значение, которое может использоваться в нескольких таблицах или вызываться из приложений без ссылки на какие-либо таблицы, см. в разделе [Порядковые номера](../../sequence-numbers/sequence-numbers.md).</span><span class="sxs-lookup"><span data-stu-id="2f754-151">To create an automatically incrementing number that can be used in multiple tables or that can be called from applications without referencing any table, see [Sequence Numbers](../../sequence-numbers/sequence-numbers.md).</span></span>  
  
### <a name="merge-replication"></a><span data-ttu-id="2f754-152">Репликация слиянием</span><span class="sxs-lookup"><span data-stu-id="2f754-152">Merge Replication</span></span>  
 <span data-ttu-id="2f754-153">Диапазоны идентификаторов управляются издателем и распространяются на подписчики агентом слияния (в иерархии переиздания диапазоны управляются корневым издателем и переиздающими подписчиками).</span><span class="sxs-lookup"><span data-stu-id="2f754-153">Identity ranges are managed by the Publisher and propagated to Subscribers by the Merge Agent (in a republishing hierarchy, ranges are managed by the root Publisher and the republishers).</span></span> <span data-ttu-id="2f754-154">Значения идентификаторов назначаются из пула на издателе.</span><span class="sxs-lookup"><span data-stu-id="2f754-154">The identity values are assigned from a pool at the Publisher.</span></span> <span data-ttu-id="2f754-155">Если вы добавляете в публикацию статью со столбцом идентификаторов с помощью мастера создания публикации или хранимой процедуры [sp_addmergearticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql), нужно указать значения следующих параметров.</span><span class="sxs-lookup"><span data-stu-id="2f754-155">When you add an article with an identity column to a publication in the New Publication Wizard or by using [sp_addmergearticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql), you specify values for:</span></span>  
  
-   <span data-ttu-id="2f754-156">Параметр \*\* \@ identity_range\*\* , который управляет размером диапазона идентификаторов, изначально выделенного как издателю, так и подписчикам с клиентскими подписками.</span><span class="sxs-lookup"><span data-stu-id="2f754-156">The **\@identity_range** parameter, which controls the identity range size initially allocated both to the Publisher and to Subscribers with client subscriptions.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="2f754-157">Для подписчиков, использующих предыдущие версии [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , этот параметр (а не параметр \*\* \@ pub_identity_range\*\* ) также управляет размером диапазона идентификаторов при повторной публикации подписчиков.</span><span class="sxs-lookup"><span data-stu-id="2f754-157">For Subscribers running previous versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], this parameter (rather than the **\@pub_identity_range** parameter) also controls the identity range size at republishing Subscribers.</span></span>  
  
-   <span data-ttu-id="2f754-158">Параметр \*\* \@ pub_identity_range\*\* , который управляет размером диапазона идентификаторов для повторной публикации, выделенной для подписчиков с серверными подписками (требуется для повторной публикации данных).</span><span class="sxs-lookup"><span data-stu-id="2f754-158">The **\@pub_identity_range** parameter, which controls the identity range size for republishing allocated to Subscribers with server subscriptions (required for republishing data).</span></span> <span data-ttu-id="2f754-159">Все подписчики с серверными подписками получают диапазон для переиздания, даже если они реально не переиздают данные.</span><span class="sxs-lookup"><span data-stu-id="2f754-159">All Subscribers with server subscriptions receive a range for republishing, even if they don't actually republish data.</span></span>  
  
-   <span data-ttu-id="2f754-160">Параметр \*\* \@ threshold\*\* , который используется для определения того, когда для подписки на [!INCLUDE[ssEW](../../../includes/ssew-md.md)] или предыдущую версию требуется новый диапазон удостоверений [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="2f754-160">The **\@threshold** parameter, which is used to determine when a new range of identities is required for a subscription to [!INCLUDE[ssEW](../../../includes/ssew-md.md)] or a previous version of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="2f754-161">Например, можно указать 10000 для \*\* \@ identity_range\*\* и 500000 для \*\* \@ pub_identity_range\*\*.</span><span class="sxs-lookup"><span data-stu-id="2f754-161">For example, you could specify 10000 for **\@identity_range** and 500000 for **\@pub_identity_range**.</span></span> <span data-ttu-id="2f754-162">Издателю и всем подписчикам, на которых запущена [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] или более поздняя версия, включая подписчик с серверной подпиской, назначается основной диапазон 10 000.</span><span class="sxs-lookup"><span data-stu-id="2f754-162">The Publisher and all Subscribers running [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version, including the Subscriber with the server subscription, are assigned a primary range of 10000.</span></span> <span data-ttu-id="2f754-163">Подписчику с серверной подпиской также назначается основной диапазон 500000, который может использоваться подписчиками, которые синхронизируются с подписчиком повторной публикации (необходимо также указать \*\* \@ identity_range**, \*\* \@ pub_identity_range**и \*\* \@ пороговое значение\*\* для статей в публикации на подписчике, на котором выполняется публикация).</span><span class="sxs-lookup"><span data-stu-id="2f754-163">The Subscriber with the server subscription is also assigned a primary range of 500000, which can be used by Subscribers that synchronize with the republishing Subscriber (you must also specify **\@identity_range**, **\@pub_identity_range**, and **\@threshold** for the articles in the publication at the republishing Subscriber).</span></span>  
  
 <span data-ttu-id="2f754-164">Каждый подписчик, использующий [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] или более позднюю версию, также получает дополнительный диапазон идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-164">Each Subscriber running [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version also receives a secondary identity range.</span></span> <span data-ttu-id="2f754-165">Дополнительный диапазон равен по размеру основному диапазону. При исчерпании основного диапазона используется дополнительный диапазон, и агент слияния назначает подписчику новый диапазон.</span><span class="sxs-lookup"><span data-stu-id="2f754-165">The secondary range is equal in size to the primary range; when the primary range is exhausted, the secondary range is used, and the Merge Agent assigns a new range to the Subscriber.</span></span> <span data-ttu-id="2f754-166">Новый диапазон становится дополнительным диапазоном, и процесс продолжается по мере использования подписчиком значений идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-166">The new range becomes the secondary range, and the process continues as the Subscriber uses identity values.</span></span>  
  
  
### <a name="transactional-replication-with-queued-updating-subscriptions"></a><span data-ttu-id="2f754-167">Репликация транзакций с подписками посредством очередей</span><span class="sxs-lookup"><span data-stu-id="2f754-167">Transactional Replication with Queued Updating Subscriptions</span></span>  
 <span data-ttu-id="2f754-168">Диапазоны идентификаторов управляются распространителем и передаются на подписчики агентом распространителя.</span><span class="sxs-lookup"><span data-stu-id="2f754-168">Identity ranges are managed by the Distributor and propagated to Subscribers by the Distribution Agent.</span></span> <span data-ttu-id="2f754-169">Значения идентификаторов назначаются из пула на распространителе.</span><span class="sxs-lookup"><span data-stu-id="2f754-169">The identity values are assigned from a pool at the Distributor.</span></span> <span data-ttu-id="2f754-170">Размер пула основан на размере типа данных и приращении, используемом для столбца идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-170">The pool size is based on the size of the data type and the increment used for the identity column.</span></span> <span data-ttu-id="2f754-171">Если вы добавляете в публикацию статью со столбцом идентификаторов с помощью мастера создания публикации или хранимой процедуры [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql), нужно указать значения следующих параметров.</span><span class="sxs-lookup"><span data-stu-id="2f754-171">When you add an article with an identity column to a publication in the New Publication Wizard or by using [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql), you specify values for:</span></span>  
  
-   <span data-ttu-id="2f754-172">Параметр \*\* \@ identity_range\*\* , который управляет размером диапазона идентификаторов, изначально выделенного для всех подписчиков.</span><span class="sxs-lookup"><span data-stu-id="2f754-172">The **\@identity_range** parameter, which controls the identity range size initially allocated to all Subscribers.</span></span>  
  
-   <span data-ttu-id="2f754-173">Параметр \*\* \@ pub_identity_range\*\* , который управляет размером диапазона идентификаторов, выделенного издателю.</span><span class="sxs-lookup"><span data-stu-id="2f754-173">The **\@pub_identity_range** parameter, which controls the identity range size allocated to the Publisher.</span></span>  
  
-   <span data-ttu-id="2f754-174">Параметр \*\* \@ threshold\*\* , который используется для определения того, когда для подписки требуется новый диапазон удостоверений.</span><span class="sxs-lookup"><span data-stu-id="2f754-174">The **\@threshold** parameter, which is used to determine when a new range of identities is required for a subscription.</span></span>  
  
 <span data-ttu-id="2f754-175">Например, можно указать 10000 для \*\* \@ pub_identity_range**, 1000 для \*\* \@ identity_range** (предполагая меньше обновлений на подписчике) и 80 процентов для \*\* \@ порогового значения\*\*.</span><span class="sxs-lookup"><span data-stu-id="2f754-175">For example, you could specify 10000 for **\@pub_identity_range**, 1000 for **\@identity_range** (assuming fewer updates at the Subscriber), and 80 percent for **\@threshold**.</span></span> <span data-ttu-id="2f754-176">После 800 вставок на подписчике (80 процентов от 1000) подписчику назначается новый диапазон.</span><span class="sxs-lookup"><span data-stu-id="2f754-176">After 800 inserts at a Subscriber (80 percent of 1000), a Subscriber is assigned a new range.</span></span> <span data-ttu-id="2f754-177">После 8000 вставок на издателе ему назначается новый диапазон.</span><span class="sxs-lookup"><span data-stu-id="2f754-177">After 8000 inserts at the Publisher, the Publisher is assigned a new range.</span></span> <span data-ttu-id="2f754-178">Когда назначается новый диапазон идентификаторов, появляется зазор в значениях диапазона идентификаторов в таблице.</span><span class="sxs-lookup"><span data-stu-id="2f754-178">When a new range is assigned, there will be a gap in the identity range values in the table.</span></span> <span data-ttu-id="2f754-179">При указании более высоких пороговых значений зазоры становятся меньше, но при этом уменьшается отказоустойчивость системы: если агент распространителя не может быть запущен по каким-либо причинам, подписчик может быстрее исчерпать диапазон доступных идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-179">Specifying a higher threshold results in smaller gaps, but the system is less fault-tolerant: if the Distribution Agent cannot run for some reason, a Subscriber could more easily run out of identities.</span></span>  
  
## <a name="assigning-ranges-for-manual-identity-range-management"></a><span data-ttu-id="2f754-180">Назначение диапазонов для ручного управления диапазонами идентификаторов</span><span class="sxs-lookup"><span data-stu-id="2f754-180">Assigning ranges for manual identity range management</span></span>  
 <span data-ttu-id="2f754-181">Если указывается ручное управление диапазонами идентификаторов, следует убедиться, что издатель и каждый подписчик используют разные диапазоны идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-181">If you specify manual identity range management, you must ensure that the Publisher and each Subscriber use different identity ranges.</span></span> <span data-ttu-id="2f754-182">Например, рассмотрим таблицу на издателе со столбцом идентификаторов, определенным как `IDENTITY(1,1)`: столбец идентификаторов начинается с 1 и увеличивается с шагом 1 при каждой вставке строки.</span><span class="sxs-lookup"><span data-stu-id="2f754-182">For example, consider a table at the Publisher with an identity column defined as `IDENTITY(1,1)`: the identity column starts at 1 and is incremented by 1 each time a row is inserted.</span></span> <span data-ttu-id="2f754-183">Если таблица на издателе имеет 5 000 строк и ожидается увеличение таблицы на протяжении существования приложения, издатель может использовать диапазон от 1 до 10 000.</span><span class="sxs-lookup"><span data-stu-id="2f754-183">If the table at the Publisher has 5,000 rows, and you expect some growth in the table over the life of the application, the Publisher could use the range 1-10,000.</span></span> <span data-ttu-id="2f754-184">При наличии двух подписчиков подписчик А может использовать диапазон от 10 001 до 20 000, а подписчик Б может использовать диапазон от 20 001 до 30 000.</span><span class="sxs-lookup"><span data-stu-id="2f754-184">Given two Subscribers, Subscriber A could use 10,001-20,000, and Subscriber B could use 20,001-30,000.</span></span>  
  
 <span data-ttu-id="2f754-185">После инициализации подписчика с помощью моментального снимка или иным способом выполните DBCC CHECKIDENT, чтобы назначить подписчику начальную точку для его диапазона идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="2f754-185">After a Subscriber is initialized with a snapshot or through another means, execute DBCC CHECKIDENT to assign the Subscriber a starting point for its identity range.</span></span> <span data-ttu-id="2f754-186">Например, на подписчике А следовало бы выполнить `DBCC CHECKIDENT('<TableName>','reseed',10001)`.</span><span class="sxs-lookup"><span data-stu-id="2f754-186">For example, at Subscriber A, you would execute `DBCC CHECKIDENT('<TableName>','reseed',10001)`.</span></span> <span data-ttu-id="2f754-187">На подписчике B следовало бы выполнить `CHECKIDENT('<TableName>','reseed',20001)`.</span><span class="sxs-lookup"><span data-stu-id="2f754-187">At Subscriber B, you would execute `CHECKIDENT('<TableName>','reseed',20001)`.</span></span>  
  
 <span data-ttu-id="2f754-188">Чтобы назначить новые диапазоны издателю или подписчикам, выполните DBCC CHECKIDENT и укажите новое значение для повторной установки начальных значений таблицы.</span><span class="sxs-lookup"><span data-stu-id="2f754-188">To assign new ranges to the Publisher or Subscribers, execute DBCC CHECKIDENT and specify a new value to reseed the table.</span></span> <span data-ttu-id="2f754-189">Необходим какой-либо способ, чтобы определить, когда должен назначаться новый диапазон.</span><span class="sxs-lookup"><span data-stu-id="2f754-189">You should have some way to determine when a new range must be assigned.</span></span> <span data-ttu-id="2f754-190">Например, приложение могло бы иметь механизм, который обнаруживает, когда узел близок к исчерпыванию своего диапазона, и назначает новый диапазон, используя DBCC CHECKIDENT.</span><span class="sxs-lookup"><span data-stu-id="2f754-190">For example, your application could have a mechanism that detects when a node is about to use up its range and assign a new range using DBCC CHECKIDENT.</span></span> <span data-ttu-id="2f754-191">Можно также добавить проверочное ограничение, чтобы исключить добавление строки, если это приведет к использованию значения идентификатора, находящегося за пределами диапазона.</span><span class="sxs-lookup"><span data-stu-id="2f754-191">You can also add a check constraint to ensure that a row cannot be added if it would cause an out of range identity value to be used.</span></span>  
  
## <a name="handling-identity-ranges-after-a-database-restore"></a><span data-ttu-id="2f754-192">Обработка диапазонов идентификаторов после восстановления базы данных</span><span class="sxs-lookup"><span data-stu-id="2f754-192">Handling Identity Ranges after a Database Restore</span></span>  
 <span data-ttu-id="2f754-193">Если при восстановлении подписчика из резервной копии используется автоматическое управление диапазонами идентификаторов, новый диапазон значений идентификаторов запрашивается автоматически.</span><span class="sxs-lookup"><span data-stu-id="2f754-193">If you are using automatic identity range management, when a Subscriber is restored from a backup, it automatically requests a new range of identity values.</span></span> <span data-ttu-id="2f754-194">Если издатель восстанавливается из резервной копии, следует убедиться, что издателю назначен соответствующий диапазон.</span><span class="sxs-lookup"><span data-stu-id="2f754-194">If a Publisher is restored from a backup, you must ensure that the Publisher is assigned an appropriate range.</span></span> <span data-ttu-id="2f754-195">Для репликации слиянием назначьте новый диапазон с помощью [sp_restoremergeidentityrange (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-restoremergeidentityrange-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2f754-195">For merge replication, assign a new range using [sp_restoremergeidentityrange &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-restoremergeidentityrange-transact-sql).</span></span> <span data-ttu-id="2f754-196">Для репликации транзакций определите максимальное использованное значение и затем установите начальную точку для новых диапазонов.</span><span class="sxs-lookup"><span data-stu-id="2f754-196">For transactional replication, determine the highest value that has been used and then set the starting point for new ranges.</span></span> <span data-ttu-id="2f754-197">Используйте следующую процедуру после восстановления базы данных публикации.</span><span class="sxs-lookup"><span data-stu-id="2f754-197">Use the following procedure after the publication database has been restored:</span></span>  
  
1.  <span data-ttu-id="2f754-198">Остановите все действия на всех подписчиках.</span><span class="sxs-lookup"><span data-stu-id="2f754-198">Stop all activity on all Subscribers.</span></span>  
  
2.  <span data-ttu-id="2f754-199">Для каждой опубликованной таблицы, которая содержит столбец идентификаторов, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="2f754-199">For each published table that includes an identity column:</span></span>  
  
    1.  <span data-ttu-id="2f754-200">В базе данных подписок на каждом подписчике выполните `IDENT_CURRENT('<TableName>')`.</span><span class="sxs-lookup"><span data-stu-id="2f754-200">In the subscription database at each Subscriber, execute `IDENT_CURRENT('<TableName>')`.</span></span>  
  
    2.  <span data-ttu-id="2f754-201">Запишите максимальное значение, найденное среди всех подписчиков.</span><span class="sxs-lookup"><span data-stu-id="2f754-201">Record the highest value found across all Subscribers.</span></span>  
  
    3.  <span data-ttu-id="2f754-202">В базе данных публикаций на издателе выполните `DBCC CHECKIDENT(<TableName>','reseed',<HighestValueFound+1>`.</span><span class="sxs-lookup"><span data-stu-id="2f754-202">In the publication database at the Publisher, execute `DBCC CHECKIDENT(<TableName>','reseed',<HighestValueFound+1>`).</span></span>  
  
    4.  <span data-ttu-id="2f754-203">В базе данных публикаций на издателе выполните `sp_adjustpublisheridentityrange <PublicationName>, <TableName>`.</span><span class="sxs-lookup"><span data-stu-id="2f754-203">In the publication database at the Publisher, execute `sp_adjustpublisheridentityrange <PublicationName>, <TableName>`.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="2f754-204">Если значение в столбце идентификаторов настроено на уменьшение, а не на увеличение, запишите минимальное найденное значение, а затем повторно задайте это значение в качестве начального условия.</span><span class="sxs-lookup"><span data-stu-id="2f754-204">If the value in the identity column is set to decrement rather than increment, record the lowest value found, and then reseed with that value.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2f754-205">См. также:</span><span class="sxs-lookup"><span data-stu-id="2f754-205">See Also</span></span>  
 <span data-ttu-id="2f754-206">[BACKUP (Transact-SQL)](/sql/t-sql/statements/backup-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2f754-206">[BACKUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-transact-sql) </span></span>  
 <span data-ttu-id="2f754-207">[DBCC CHECKIDENT (Transact-SQL)](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2f754-207">[DBCC CHECKIDENT &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) </span></span>  
 <span data-ttu-id="2f754-208">[IDENT_CURRENT (Transact-SQL)](/sql/t-sql/functions/ident-current-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2f754-208">[IDENT_CURRENT &#40;Transact-SQL&#41;](/sql/t-sql/functions/ident-current-transact-sql) </span></span>  
 <span data-ttu-id="2f754-209">[Свойство IDENTITY (Transact-SQL)](/sql/t-sql/statements/create-table-transact-sql-identity-property) </span><span class="sxs-lookup"><span data-stu-id="2f754-209">[IDENTITY &#40;Property&#41; &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-table-transact-sql-identity-property) </span></span>  
 [<span data-ttu-id="2f754-210">sp_adjustpublisheridentityrange (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="2f754-210">sp_adjustpublisheridentityrange &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-adjustpublisheridentityrange-transact-sql)  
  
  
