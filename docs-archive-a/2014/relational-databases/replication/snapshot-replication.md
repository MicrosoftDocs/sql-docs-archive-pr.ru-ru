---
title: Репликация моментального снимка | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- snapshot replication [SQL Server], about snapshot replication
- snapshot replication [SQL Server]
ms.assetid: 5d745f22-9c6b-4e11-8c62-bc50e9a8bf38
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 6192c196e31c4c5772099074c79b3c6c4ca7aeed
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87752123"
---
# <a name="snapshot-replication"></a><span data-ttu-id="25cc2-102">Репликация моментальных снимков</span><span class="sxs-lookup"><span data-stu-id="25cc2-102">Snapshot Replication</span></span>
  <span data-ttu-id="25cc2-103">Репликация моментальных снимков распространяет данные точно в том виде, в котором они были представлены в определенный момент времени, и не наблюдает за обновлением этих данных.</span><span class="sxs-lookup"><span data-stu-id="25cc2-103">Snapshot replication distributes data exactly as it appears at a specific moment in time and does not monitor for updates to the data.</span></span> <span data-ttu-id="25cc2-104">Во время синхронизации формируется моментальный снимок и отсылается подписчикам целиком.</span><span class="sxs-lookup"><span data-stu-id="25cc2-104">When synchronization occurs, the entire snapshot is generated and sent to Subscribers.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="25cc2-105">Репликация моментальных снимков может использоваться сама по себе, но процесс создания моментального снимка (который создает копию всех объектов и данных, заданных публикацией) также часто используется для предоставления первоначального набора данных и объектов базы данных для публикации транзакций и публикации слиянием.</span><span class="sxs-lookup"><span data-stu-id="25cc2-105">Snapshot replication can be used by itself, but the snapshot process (which creates a copy of all of the objects and data specified by a publication) is also commonly used to provide the initial set of data and database objects for transactional and merge publications.</span></span>  
  
 <span data-ttu-id="25cc2-106">Использование репликации моментальных снимков самой по себе наиболее приемлемо, когда выполняется одно или несколько следующих условий:</span><span class="sxs-lookup"><span data-stu-id="25cc2-106">Using snapshot replication by itself is most appropriate when one or more of the following is true:</span></span>  
  
-   <span data-ttu-id="25cc2-107">Данные изменяются редко.</span><span class="sxs-lookup"><span data-stu-id="25cc2-107">Data changes infrequently.</span></span>  
  
-   <span data-ttu-id="25cc2-108">Допустимо на определенный период времени иметь копии данных, устаревших по отношению к издателю.</span><span class="sxs-lookup"><span data-stu-id="25cc2-108">It is acceptable to have copies of data that are out of date with respect to the Publisher for a period of time.</span></span>  
  
-   <span data-ttu-id="25cc2-109">Репликация небольших объемов данных.</span><span class="sxs-lookup"><span data-stu-id="25cc2-109">Replicating small volumes of data.</span></span>  
  
-   <span data-ttu-id="25cc2-110">Большой объем изменений производится за короткий период времени.</span><span class="sxs-lookup"><span data-stu-id="25cc2-110">A large volume of changes occurs over a short period of time.</span></span>  
  
 <span data-ttu-id="25cc2-111">Репликация моментальных снимков наиболее приемлема, если изменения данных значительны, но редки.</span><span class="sxs-lookup"><span data-stu-id="25cc2-111">Snapshot replication is most appropriate when data changes are substantial but infrequent.</span></span> <span data-ttu-id="25cc2-112">Например, если торговая организация ведет прайс-лист на товары, и цены обновляются в одно и то же время раз или два раза в год, рекомендуется производить репликацию всего моментального снимка данных после их изменений.</span><span class="sxs-lookup"><span data-stu-id="25cc2-112">For example, if a sales organization maintains a product price list and the prices are all updated at the same time once or twice each year, replicating the entire snapshot of data after it has changed is recommended.</span></span> <span data-ttu-id="25cc2-113">При наличии определенных типов данных наиболее подходящими могут быть более частые моментальные снимки.</span><span class="sxs-lookup"><span data-stu-id="25cc2-113">Given certain types of data, more frequent snapshots may also be appropriate.</span></span> <span data-ttu-id="25cc2-114">Например, если относительно небольшая таблица обновляется на издателе в течение дня, но допустима некоторая задержка, то изменения могут доставляться ночью в виде моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="25cc2-114">For example, if a relatively small table is updated at the Publisher during the day, but some latency is acceptable, changes can be delivered nightly as a snapshot.</span></span>  
  
 <span data-ttu-id="25cc2-115">Репликация моментальных снимков создает более низкую непрерывную нагрузку на издателе, чем репликация транзакций, поскольку добавочные изменения не отслеживаются.</span><span class="sxs-lookup"><span data-stu-id="25cc2-115">Snapshot replication has a lower continuous overhead on the Publisher than transactional replication, because incremental changes are not tracked.</span></span> <span data-ttu-id="25cc2-116">Однако если реплицируемый набор данных очень большой, для создания и применения моментального снимка потребуется значительное количество ресурсов.</span><span class="sxs-lookup"><span data-stu-id="25cc2-116">However, if the dataset set being replicated is very large, it will require substantial resources to generate and apply the snapshot.</span></span> <span data-ttu-id="25cc2-117">Стоит рассмотреть общий размер набора данных и частоту изменений данных при оценке необходимости использования репликации моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="25cc2-117">Consider the size of the entire data set and the frequency of changes to the data when evaluating whether to utilize snapshot replication.</span></span>  
  
 <span data-ttu-id="25cc2-118">**В этом разделе**</span><span class="sxs-lookup"><span data-stu-id="25cc2-118">**In this topic**</span></span>  
  
 [<span data-ttu-id="25cc2-119">Принцип работы репликации моментальных снимков</span><span class="sxs-lookup"><span data-stu-id="25cc2-119">How Snapshot Replication Works</span></span>](#HowWorks)  
  
 [<span data-ttu-id="25cc2-120">Агент моментальных снимков</span><span class="sxs-lookup"><span data-stu-id="25cc2-120">Snapshot Agent</span></span>](#SnapshotAgent)  
  
 [<span data-ttu-id="25cc2-121">Агенты распространителя и слияния</span><span class="sxs-lookup"><span data-stu-id="25cc2-121">Distribution and Merge Agents</span></span>](#DistAgent)  
  
##  <a name="how-snapshot-replication-works"></a><a name="HowWorks"></a> <span data-ttu-id="25cc2-122">Принцип работы репликации моментальных снимков</span><span class="sxs-lookup"><span data-stu-id="25cc2-122">How Snapshot Replication Works</span></span>  
 <span data-ttu-id="25cc2-123">По умолчанию все три типа репликации для инициализации подписчиков используют моментальный снимок.</span><span class="sxs-lookup"><span data-stu-id="25cc2-123">By default, all three types of replication use a snapshot to initialize Subscribers.</span></span> <span data-ttu-id="25cc2-124">Агент моментальных снимков [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] всегда создает файлы моментальных снимков, но агент, доставляющий файлы, меняется в зависимости от используемого типа репликации.</span><span class="sxs-lookup"><span data-stu-id="25cc2-124">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Snapshot Agent always generates the snapshot files, but the agent that delivers the files differs depending on the type of replication being used.</span></span> <span data-ttu-id="25cc2-125">Репликация моментальных снимков и репликация транзакций используют для доставки этих файлов агент распространителя, в то время как репликация слиянием использует агент слияния [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="25cc2-125">Snapshot replication and transactional replication use the Distribution Agent to deliver the files, whereas merge replication uses the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Merge Agent.</span></span> <span data-ttu-id="25cc2-126">Агент моментальных снимков выполняется на распространителе.</span><span class="sxs-lookup"><span data-stu-id="25cc2-126">The Snapshot Agent runs at the Distributor.</span></span> <span data-ttu-id="25cc2-127">Агент распространителя и агент слияния выполняются на распространителе для принудительных подписок и на подписчиках для подписок по запросу.</span><span class="sxs-lookup"><span data-stu-id="25cc2-127">The Distribution Agent and Merge Agent run at the Distributor for push subscriptions, or at Subscribers for pull subscriptions.</span></span>  
  
 <span data-ttu-id="25cc2-128">Моментальные снимки могут создаваться и применяться или непосредственно после создания подписки, или в соответствии с расписанием, установленным при создании публикации.</span><span class="sxs-lookup"><span data-stu-id="25cc2-128">Snapshots can be generated and applied either immediately after the subscription is created or according to a schedule set at the time the publication is created.</span></span> <span data-ttu-id="25cc2-129">Агент моментальных снимков подготавливает файлы моментального снимка, содержащие схему и данные опубликованных таблиц и объектов базы данных, сохраняет эти файлы в папке моментальных снимков для издателя и записывает данные слежения в базу данных распространителя на распространителе.</span><span class="sxs-lookup"><span data-stu-id="25cc2-129">The Snapshot Agent prepares snapshot files containing the schema and data of published tables and database objects, stores the files in the snapshot folder for the Publisher, and records tracking information in the distribution database on the Distributor.</span></span> <span data-ttu-id="25cc2-130">При настройке распространителя указывается папка моментальных снимков по умолчанию, но можно указать и другое расположение публикации вместо или дополнительно к расположению по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="25cc2-130">You specify a default snapshot folder when you configure a Distributor, but you can specify an alternate location for a publication instead of or in addition to the default.</span></span>  
  
 <span data-ttu-id="25cc2-131">В дополнение к стандартному процессу создания моментального снимка, описанному в этом подразделе, для публикаций слиянием с параметризованными фильтрами используется процесс создания моментального снимка из двух частей.</span><span class="sxs-lookup"><span data-stu-id="25cc2-131">In addition to the standard snapshot process described in this topic, a two-part snapshot process is used for merge publications with parameterized filters.</span></span>  
  
 <span data-ttu-id="25cc2-132">На следующей иллюстрации показаны основные компоненты репликации моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="25cc2-132">The following illustration shows the principal components of snapshot replication.</span></span>  
  
 <span data-ttu-id="25cc2-133">![Компоненты и поток данных репликации моментальных снимков](media/snapshot.gif "Компоненты и поток данных репликации моментальных снимков")</span><span class="sxs-lookup"><span data-stu-id="25cc2-133">![Snapshot replication components and data flow](media/snapshot.gif "Snapshot replication components and data flow")</span></span>  
  
##  <a name="snapshot-agent"></a><a name="SnapshotAgent"></a> <span data-ttu-id="25cc2-134">агент моментальных снимков</span><span class="sxs-lookup"><span data-stu-id="25cc2-134">Snapshot Agent</span></span>  
 <span data-ttu-id="25cc2-135">Для репликации слиянием моментальный снимок формируется при каждом запуске агента моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="25cc2-135">For merge replication, a snapshot is generated every time the Snapshot Agent runs.</span></span> <span data-ttu-id="25cc2-136">Для репликации транзакций формирование моментального снимка зависит от настроек свойства публикации **immediate_sync**.</span><span class="sxs-lookup"><span data-stu-id="25cc2-136">For transactional replication, snapshot generation depends on the setting of the publication property **immediate_sync**.</span></span> <span data-ttu-id="25cc2-137">Если значение свойства установлено в TRUE (значение по умолчанию при использовании мастера создания публикаций), моментальный снимок создается при каждом запуске агента моментальных снимков и может быть применен к подписчику в любое время.</span><span class="sxs-lookup"><span data-stu-id="25cc2-137">If the property is set to TRUE (the default when using the New Publication Wizard), a snapshot is generated every time the Snapshot Agent runs, and it can be applied to a Subscriber at any time.</span></span> <span data-ttu-id="25cc2-138">Если значение свойства установлено в FALSE (значение по умолчанию при использовании хранимой процедуры **sp_addpublication**), моментальный снимок создается только в том случае, если после запуска агента моментальных снимков была добавлена новая подписка. Для проведения синхронизации подписчики должны ждать завершения работы агента моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="25cc2-138">If the property is set to FALSE (the default when using **sp_addpublication**), the snapshot is generated only if a new subscription has been added since the last Snapshot Agent run; Subscribers must wait for the Snapshot Agent to complete before they can synchronize.</span></span>  
  
 <span data-ttu-id="25cc2-139">Агент моментальных снимков выполняет следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="25cc2-139">The Snapshot Agent performs the following steps:</span></span>  
  
1.  <span data-ttu-id="25cc2-140">Устанавливает соединение распространителя с издателем, а затем, если это необходимо, блокирует публикуемые таблицы:</span><span class="sxs-lookup"><span data-stu-id="25cc2-140">Establishes a connection from the Distributor to the Publisher, and then takes locks on published tables if necessary:</span></span>  
  
    -   <span data-ttu-id="25cc2-141">Для публикаций слиянием агент моментальных снимков не устанавливает никаких блокировок.</span><span class="sxs-lookup"><span data-stu-id="25cc2-141">For merge publications, the Snapshot Agent does not take any locks.</span></span>  
  
    -   <span data-ttu-id="25cc2-142">Для публикаций транзакций агент моментальных снимков по умолчанию устанавливает блокировки только на начальной фазе формирования моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="25cc2-142">For transactional publications, by default the Snapshot Agent take locks only during the initial phase of snapshot generation.</span></span>  
  
    -   <span data-ttu-id="25cc2-143">Для публикаций моментальных снимков блокировки удерживаются на всем протяжении процесса формирования моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="25cc2-143">For snapshot publications, locks are held during the entire snapshot generation process.</span></span>  
  
2.  <span data-ttu-id="25cc2-144">Записывает копию схемы таблиц для каждой статьи в sch-файл.</span><span class="sxs-lookup"><span data-stu-id="25cc2-144">Writes a copy of the table schema for each article to a .sch file.</span></span> <span data-ttu-id="25cc2-145">Если публикуются другие объекты базы данных, например индексы, ограничения, хранимые процедуры, представления, пользовательские функции и тому подобное, формируются дополнительные файлы скриптов.</span><span class="sxs-lookup"><span data-stu-id="25cc2-145">If other database objects are published, such as indexes, constraints, stored procedures, views, user-defined functions, and so on, additional script files are generated.</span></span>  
  
3.  <span data-ttu-id="25cc2-146">Копирует данные из опубликованной таблицы на издателе и записывает данные в папку моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="25cc2-146">Copies the data from the published table at the Publisher and writes the data to the snapshot folder.</span></span> <span data-ttu-id="25cc2-147">Моментальный снимок формируется как набор файлов программы массового копирования (BCP).</span><span class="sxs-lookup"><span data-stu-id="25cc2-147">The snapshot is generated as a set of bulk copy program (BCP) files.</span></span>  
  
4.  <span data-ttu-id="25cc2-148">Для публикаций моментальных снимков и публикаций транзакций агент моментальных снимков присоединяет строки к таблицам **MSrepl_commands** и **MSrepl_transactions** в базе данных распространителя.</span><span class="sxs-lookup"><span data-stu-id="25cc2-148">For snapshot and transactional publications, the Snapshot Agent appends rows to the **MSrepl_commands** and **MSrepl_transactions** tables in the distribution database.</span></span> <span data-ttu-id="25cc2-149">Записи в таблице **MSrepl_commands** представляют собой команды, указывающие местонахождение sch- и bcp-файлов, а также любых других файлов моментального снимка, и ссылки на любые скрипты, выполняемые до или после моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="25cc2-149">The entries in the **MSrepl_commands** table are commands indicating the location of .sch and .bcp files, any other snapshot files, and references to any pre- or post-snapshot scripts.</span></span> <span data-ttu-id="25cc2-150">Записи в таблице **MSrepl_transactions** представляют собой команды, относящиеся к синхронизации подписчика.</span><span class="sxs-lookup"><span data-stu-id="25cc2-150">The entries in the **MSrepl_transactions** table are commands relevant to synchronizing the Subscriber.</span></span>  
  
     <span data-ttu-id="25cc2-151">Для публикаций слиянием агент моментальных снимков выполняет дополнительные шаги.</span><span class="sxs-lookup"><span data-stu-id="25cc2-151">For merge publications, the Snapshot Agent performs additional steps.</span></span>  
  
5.  <span data-ttu-id="25cc2-152">Снимает любые блокировки с опубликованных таблиц.</span><span class="sxs-lookup"><span data-stu-id="25cc2-152">Releases any locks on published tables.</span></span>  
  
 <span data-ttu-id="25cc2-153">Во время формирования моментального снимка нельзя внести изменения в схемы опубликованных таблиц.</span><span class="sxs-lookup"><span data-stu-id="25cc2-153">During snapshot generation, you cannot make schema changes on published tables.</span></span> <span data-ttu-id="25cc2-154">После того как файлы моментального снимка сформированы, их можно просмотреть в папке моментальных снимков с помощью проводника Windows.</span><span class="sxs-lookup"><span data-stu-id="25cc2-154">After the snapshot files are generated, you can view them in the snapshot folder using Windows Explorer.</span></span>  
  
##  <a name="distribution-agent-and-merge-agent"></a><a name="DistAgent"></a> <span data-ttu-id="25cc2-155">Агент распространителя и агент слияния</span><span class="sxs-lookup"><span data-stu-id="25cc2-155">Distribution Agent and Merge Agent</span></span>  
 <span data-ttu-id="25cc2-156">В случае публикаций моментальных снимков, каждый раз, когда для публикации выполняется агент распространителя, он перемещает новый моментальный снимок каждому подписчику, который еще не был синхронизирован, был отмечен для повторной инициализации или включает новые статьи.</span><span class="sxs-lookup"><span data-stu-id="25cc2-156">For snapshot publications, each time the Distribution Agent runs for the publication, it moves a new snapshot to each Subscriber that has not yet been synchronized, has been marked for reinitialization, or includes new articles.</span></span>  
  
 <span data-ttu-id="25cc2-157">В случае репликации моментальных снимков и репликации транзакций агент распространителя выполняет следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="25cc2-157">For snapshot and transactional replication, the Distribution Agent performs the following steps:</span></span>  
  
1.  <span data-ttu-id="25cc2-158">Устанавливает соединение с распространителем.</span><span class="sxs-lookup"><span data-stu-id="25cc2-158">Establishes a connection to the Distributor.</span></span>  
  
2.  <span data-ttu-id="25cc2-159">Анализирует таблицы **MSrepl_commands** и **MSrepl_transactions** в базе данных распространителя на распространителе.</span><span class="sxs-lookup"><span data-stu-id="25cc2-159">Examines the **MSrepl_commands** and **MSrepl_transactions** tables in the distribution database on the Distributor.</span></span> <span data-ttu-id="25cc2-160">Агент считывает местонахождение файлов моментального снимка из первой таблицы и команды синхронизации подписчика из обеих таблиц.</span><span class="sxs-lookup"><span data-stu-id="25cc2-160">The agent reads the location of the snapshot files from the first table and Subscriber synchronization commands from both tables.</span></span>  
  
3.  <span data-ttu-id="25cc2-161">Применяет схему и команды к базе данных подписки.</span><span class="sxs-lookup"><span data-stu-id="25cc2-161">Applies the schema and commands to the subscription database.</span></span>  
  
 <span data-ttu-id="25cc2-162">В случае отсутствия фильтрации для публикации репликации слиянием агент слияния выполняет следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="25cc2-162">For an unfiltered merge replication publication, the Merge Agent performs the following steps:</span></span>  
  
1.  <span data-ttu-id="25cc2-163">Устанавливает соединение с издателем.</span><span class="sxs-lookup"><span data-stu-id="25cc2-163">Establishes a connection to the Publisher.</span></span>  
  
2.  <span data-ttu-id="25cc2-164">Анализирует таблицу **sysmergeschemachange** на издателе и определяет, существует ли новый моментальный снимок, который следует применить на подписчике.</span><span class="sxs-lookup"><span data-stu-id="25cc2-164">Examines the **sysmergeschemachange** table on the Publisher and determines whether there is a new snapshot that should be applied at the Subscriber.</span></span>  
  
3.  <span data-ttu-id="25cc2-165">Если доступен новый моментальный снимок, агент слияния применяет к базе данных подписки файлы моментального снимка из местоположения, указанного параметром **sysmergeschemachange**.</span><span class="sxs-lookup"><span data-stu-id="25cc2-165">If a new snapshot is available, the Merge Agent applies to the subscription database the snapshot files from the location specified in **sysmergeschemachange**.</span></span>  
  
  
