---
title: Оценка количества элементов (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 11/24/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- cardinality estimator
- CE (cardinality estimator)
- estimating cardinality
ms.assetid: baa8a304-5713-4cfe-a699-345e819ce6df
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: aa56127f649d71bfcc8825322f8bf729175d41df
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87668836"
---
# <a name="cardinality-estimation-sql-server"></a><span data-ttu-id="7a0af-102">Оценка количества элементов (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7a0af-102">Cardinality Estimation (SQL Server)</span></span>
  <span data-ttu-id="7a0af-103">Логика оценки количества элементов, называемая механизмом оценки количества элементов, переработана в [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] в целях улучшения качества планов запросов и тем самым повышения производительности запросов.</span><span class="sxs-lookup"><span data-stu-id="7a0af-103">The cardinality estimation logic, called the cardinality estimator, is re-designed in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] to improve the quality of query plans, and therefore to improve query performance.</span></span> <span data-ttu-id="7a0af-104">Новый механизм оценки количества элементов состоит из предположений и алгоритмов, которые отлично подходят для современных рабочих нагрузок OLTP и хранилища данных.</span><span class="sxs-lookup"><span data-stu-id="7a0af-104">The new cardinality estimator incorporates assumptions and algorithms that work well on modern OLTP and data warehousing workloads.</span></span> <span data-ttu-id="7a0af-105">Он основан на глубоком исследовании оценки количества элементов для современных рабочих нагрузок и нашем опыте усовершенствования этого механизма, накопленном за последние 15 лет.</span><span class="sxs-lookup"><span data-stu-id="7a0af-105">It is based on in-depth cardinality estimation research on modern workloads, and our learnings over the past 15 years of improving the SQL Server cardinality estimator.</span></span> <span data-ttu-id="7a0af-106">Отзывы от клиентов свидетельствуют, что эти изменения положительно сказываются на большинстве запросов либо все остается по прежнему, хотя производительность небольшого числа запросов может снизиться по сравнению с использованием предыдущего механизма оценки количества элементов.</span><span class="sxs-lookup"><span data-stu-id="7a0af-106">Feedback from customers shows that while most queries will benefit from the change or remain unchanged, a small number might show regressions compared to the previous cardinality estimator.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7a0af-107">Оценка количества элементов — это прогноз количества строк в результате запроса.</span><span class="sxs-lookup"><span data-stu-id="7a0af-107">Cardinality estimates are a prediction of the number of rows in the query result.</span></span> <span data-ttu-id="7a0af-108">Оптимизатор запросов использует эти оценки, чтобы выбрать план выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="7a0af-108">The query optimizer uses these estimates to choose a plan for executing the query.</span></span> <span data-ttu-id="7a0af-109">Качество плана запроса имеет прямое влияние на повышение производительности запроса.</span><span class="sxs-lookup"><span data-stu-id="7a0af-109">The quality of the query plan has a direct impact on improving query performance.</span></span>  
  
## <a name="performance-testing-and-tuning-recommendations"></a><span data-ttu-id="7a0af-110">Рекомендации по тестированию и настройке производительности</span><span class="sxs-lookup"><span data-stu-id="7a0af-110">Performance Testing and Tuning Recommendations</span></span>  
 <span data-ttu-id="7a0af-111">В [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]новый механизм оценки количества элементов включается для всех вновь создаваемых баз данных.</span><span class="sxs-lookup"><span data-stu-id="7a0af-111">The new cardinality estimator is enabled for all new databases created in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span></span> <span data-ttu-id="7a0af-112">Однако при обновлении до [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] новый механизм оценки количества элементов не включается для существующих баз данных.</span><span class="sxs-lookup"><span data-stu-id="7a0af-112">However, upgrading to [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] does not enable the new cardinality estimator on existing databases.</span></span>  
  
 <span data-ttu-id="7a0af-113">Чтобы обеспечить наилучшую производительность запросов, следуйте приведенным ниже рекомендациям по тестированию рабочей нагрузки с помощью нового механизма оценки количества элементов, прежде чем включать его в работающей системе.</span><span class="sxs-lookup"><span data-stu-id="7a0af-113">To ensure the best query performance, use these recommendations to test your workload with the new cardinality estimator before enabling it on your production system.</span></span>  
  
1.  <span data-ttu-id="7a0af-114">Обновите все существующие базы данных, чтобы они использовали новый механизм оценки количества элементов.</span><span class="sxs-lookup"><span data-stu-id="7a0af-114">Upgrade all existing databases to use the new cardinality estimator.</span></span> <span data-ttu-id="7a0af-115">Для этого используйте [уровень совместимости ALTER database &#40;&#41;Transact-SQL](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) , чтобы установить уровень совместимости базы данных 120.</span><span class="sxs-lookup"><span data-stu-id="7a0af-115">To do this, use [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 120.</span></span>  
  
2.  <span data-ttu-id="7a0af-116">Запустите тестовую рабочую нагрузку с новым механизмом оценки количества элементов и устраните все выявленные проблемы производительности таким же образом, как это делается в настоящее время.</span><span class="sxs-lookup"><span data-stu-id="7a0af-116">Run your test workload with the new cardinality estimator, and then troubleshoot any new performance issues in the same manner you currently troubleshoot performance issues.</span></span>  
  
3.  <span data-ttu-id="7a0af-117">Если после запуска рабочей нагрузки с новым механизмом оценки количества элементов (при уровне совместимости базы данных в 120 (SQL Server 2014)) производительность конкретного запроса снизилась, можно выполнить запрос с флагом трассировки 9481 для использования версии средства оценки количества элементов, представленного в [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] и более ранних выпусках.</span><span class="sxs-lookup"><span data-stu-id="7a0af-117">Once your workload is running with the new cardinality estimator (database compatibility level 120 (SQL Server 2014)), and a specific query has regressed, you can run the query with trace flag 9481 to use the version of the cardinality estimator used in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] and earlier.</span></span> <span data-ttu-id="7a0af-118">Описание выполнения запроса с флагом трассировки см. в статье базы знаний [Включение оптимизатора запросов SQL Server, влияющего на план выполнения, которым можно управлять с помощью разных флагов трассировки на уровне конкретного запроса](https://support.microsoft.com/kb/2801413).</span><span class="sxs-lookup"><span data-stu-id="7a0af-118">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
4.  <span data-ttu-id="7a0af-119">Если вы не можете изменить все базы данных одновременно, чтобы использовать новый механизм оценки количества элементов, можно использовать бывший механизм оценки количества элементов для всех баз данных, используя [уровень совместимости ALTER database &#40;&#41;Transact-SQL](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) , чтобы установить уровень совместимости базы данных 110.</span><span class="sxs-lookup"><span data-stu-id="7a0af-119">If you cannot change all of the databases at once to use the new cardinality estimator, you can use the former cardinality estimator for all databases by using [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 110.</span></span>  
  
5.  <span data-ttu-id="7a0af-120">Если рабочая нагрузка работает при уровне совместимости базы данных, равном 110, и требуется протестировать или выполнить определенный запрос с новым механизмом оценки количества элементов, то можно выполнить этот запрос с флагом трассировки 2312 для использования версии средства оценки количества элементов, представленной в SQL Server 2014.</span><span class="sxs-lookup"><span data-stu-id="7a0af-120">If your workload is running with database compatibility level 110 and you want to test or run a specific query with the new cardinality estimator, you can run the query with trace flag 2312 to use the SQL Server 2014 version of the cardinality estimator.</span></span>  <span data-ttu-id="7a0af-121">Описание выполнения запроса с флагом трассировки см. в статье базы знаний [Включение оптимизатора запросов SQL Server, влияющего на план выполнения, которым можно управлять с помощью разных флагов трассировки на уровне конкретного запроса](https://support.microsoft.com/kb/2801413).</span><span class="sxs-lookup"><span data-stu-id="7a0af-121">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
## <a name="new-xevents"></a><span data-ttu-id="7a0af-122">Новые события XEvent</span><span class="sxs-lookup"><span data-stu-id="7a0af-122">New XEvents</span></span>  
 <span data-ttu-id="7a0af-123">Для поддержки новых планов запросов появились два новых события XEvents query_optimizer_estimate_cardinality.</span><span class="sxs-lookup"><span data-stu-id="7a0af-123">There are two new query_optimizer_estimate_cardinality XEvents to support the new query plans.</span></span>  
  
-   <span data-ttu-id="7a0af-124">*query_optimizer_estimate_cardinality* возникает, когда оптимизатор запросов определяет количество элементов в реляционном выражении.</span><span class="sxs-lookup"><span data-stu-id="7a0af-124">*query_optimizer_estimate_cardinality* occurs when the query optimizer estimates the cardinality on a relational expression.</span></span>  
  
-   <span data-ttu-id="7a0af-125">*query_optimizer_force_both_cardinality_estimation*_behaviors возникает, когда включены оба флага трассировки 2312 и 9481 с целью заставить одновременно работать и старый и новый механизмы оценки количества элементов.</span><span class="sxs-lookup"><span data-stu-id="7a0af-125">*query_optimizer_force_both_cardinality_estimation*_behaviors occurs when both traceflags 2312 and 9481 are enabled, attempting to force both old and new cardinality estimation behavior at the same time.</span></span>  
  
## <a name="examples"></a><span data-ttu-id="7a0af-126">Примеры</span><span class="sxs-lookup"><span data-stu-id="7a0af-126">Examples</span></span>  
 <span data-ttu-id="7a0af-127">В следующих примерах показаны некоторые изменения, реализованные в новом механизме оценки количества элементов.</span><span class="sxs-lookup"><span data-stu-id="7a0af-127">The following examples show some of the changes in the new cardinality estimates.</span></span> <span data-ttu-id="7a0af-128">Код оценки количества элементов был переписан.</span><span class="sxs-lookup"><span data-stu-id="7a0af-128">The code for estimating cardinality has been rewritten.</span></span> <span data-ttu-id="7a0af-129">Логика этого сложна, поэтому предоставлять полный список всех изменений невозможно.</span><span class="sxs-lookup"><span data-stu-id="7a0af-129">The logic is complex and it is not possible to provide an exhaustive list of all changes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7a0af-130">Эти образцы приведены в качестве основополагающих сведений.</span><span class="sxs-lookup"><span data-stu-id="7a0af-130">These examples are provided as conceptual information.</span></span> <span data-ttu-id="7a0af-131">Каких-либо действий со стороны пользователя для изменения методов проектирования баз данных и запросов не требуется.</span><span class="sxs-lookup"><span data-stu-id="7a0af-131">No action is required on your part to change the way you design databases and queries.</span></span>  
  
### <a name="example-a-new-cardinality-estimates-use-an-average-cardinality-for-recently-added-ascending-data"></a><span data-ttu-id="7a0af-132">Пример А. В новых механизмах оценки количества элементов используется среднее количество элементов для недавно добавленных восходящих данных</span><span class="sxs-lookup"><span data-stu-id="7a0af-132">Example A. New cardinality estimates use an average cardinality for recently added ascending data</span></span>  
 <span data-ttu-id="7a0af-133">В этом примере показано, как с помощью нового механизма оценки количества элементов можно улучшить оценку количества элементов для данных по возрастанию, которые превышают максимальное значение в таблице во время последнего обновления статистики.</span><span class="sxs-lookup"><span data-stu-id="7a0af-133">This example demonstrates how the new cardinality estimator can improve cardinality estimates for ascending data that exceeds the maximum value in the table during the most recent statistics update.</span></span>  
  
```  
SELECT item, category, amount FROM dbo.Sales AS s WHERE Date = '2013-12-19';  
```  
  
 <span data-ttu-id="7a0af-134">В данном примере новые строки добавляются в таблицу продаж каждый день, запрос возвращает данные, полученные в 19.12.2013, а статистика последний раз обновлялась 18.12.2013.</span><span class="sxs-lookup"><span data-stu-id="7a0af-134">In this example, new rows are added to the Sales table each day, the query asks for sales that occurred on 12/19/2013, and statistics were last updated on 12/18/2013.</span></span> <span data-ttu-id="7a0af-135">Предыдущий механизм оценки количества элементов предполагает, что значения от 19.12.2013 отсутствуют, поскольку эта дата следует после максимальной даты, а значения за 19.12.2013 отсутствуют, так как статистика не обновлялась.</span><span class="sxs-lookup"><span data-stu-id="7a0af-135">The previous cardinality estimator assumes the 12/19/2013 values do not exist since the date exceeds the maximum date and statistics have not been updated to include the 12/19/2013 values.</span></span> <span data-ttu-id="7a0af-136">Эта ситуация, известная как проблема ключа по возрастанию, возникает, когда данные загружаются в течение дня, а затем к ним выполняются запросы до обновления статистики.</span><span class="sxs-lookup"><span data-stu-id="7a0af-136">This situation, known as the ascending key problem, will occur if you load data during the day, and then run queries against the data before statistics are updated.</span></span>  
  
 <span data-ttu-id="7a0af-137">Это поведение изменено.</span><span class="sxs-lookup"><span data-stu-id="7a0af-137">This behavior has changed.</span></span> <span data-ttu-id="7a0af-138">Теперь, даже если статистика не обновлена для данных, которые были добавлены с момента последнего обновления статистики, в новом механизме оценки количества элементов предполагается, что значения существуют, и в качестве оценки количества элементов используется среднее количество элементов для каждого значения в столбце.</span><span class="sxs-lookup"><span data-stu-id="7a0af-138">Now, even if statistics have not been updated for the most recent ascending data that is added since the last statistics update, the new cardinality estimator assumes the values exist and uses the average cardinality for each value in the column as the cardinality estimate.</span></span>  
  
### <a name="example-b-new-cardinality-estimates-assume-filtered-predicates-on-the-same-table-have-some-correlation"></a><span data-ttu-id="7a0af-139">Пример Б. Новые средства оценки количества элементов предполагают, что отфильтрованные предикаты из одной таблицы имеют определенную корреляцию.</span><span class="sxs-lookup"><span data-stu-id="7a0af-139">Example B. New cardinality estimates assume filtered predicates on the same table have some correlation</span></span>  
 <span data-ttu-id="7a0af-140">Для данного примера предположим, что число строк в таблице «Автомобили» равно 1000. Запрос «Марка» имеет 200 совпадений для «Honda», запрос «Модель» имеет 50 совпадений для «Civic», а все модели Civic относятся к марке Honda.</span><span class="sxs-lookup"><span data-stu-id="7a0af-140">For this example, assume the table Cars as 1000 rows, Make has 200 matches for 'Honda', Model has 50 matches for 'Civic', and that all of the Civics are Hondas.</span></span> <span data-ttu-id="7a0af-141">Поэтому 20% значений из столбца «Марка» — это Honda, 5% значений из столбца «Модель» — это Civic и фактическое количество вариантов Honda Civic равно 50.</span><span class="sxs-lookup"><span data-stu-id="7a0af-141">Therefore, 20% of the values in the Make column are 'Honda', 5% of the values in the Model column are 'Civic', and the actual number of Honda Civics is 50.</span></span> <span data-ttu-id="7a0af-142">В предыдущих оценках количества элементов предполагается, что значения из столбцов «Марка» и «Модель» не зависят друг от друга.</span><span class="sxs-lookup"><span data-stu-id="7a0af-142">The previous cardinality estimates assume the values in the Make and the Model columns are independent of each other.</span></span> <span data-ttu-id="7a0af-143">В предыдущих оценках оптимизатора запросов имеется 10 Honda граждан (. 05 \* .20 \* 1000 строк = 10 строк).</span><span class="sxs-lookup"><span data-stu-id="7a0af-143">The previous query optimizer estimates there are 10 Honda Civics (.05 \* .20 \* 1000 rows = 10 rows).</span></span>  
  
```  
SELECT year, purchase_price FROM dbo.Cars WHERE Make = 'Honda' AND Model = 'Civic';  
```  
  
 <span data-ttu-id="7a0af-144">Это поведение изменено.</span><span class="sxs-lookup"><span data-stu-id="7a0af-144">This behavior has changed.</span></span> <span data-ttu-id="7a0af-145">Теперь при формировании новых оценок количества элементов предполагается, что столбцы марки и модели имеют *некоторую* корреляцию.</span><span class="sxs-lookup"><span data-stu-id="7a0af-145">Now, the new cardinality estimates assume the Make and Model columns have *some* correlation.</span></span> <span data-ttu-id="7a0af-146">Оптимизатор запросов определяет, что количество элементов больше, путем добавления экспоненциального компонента в формулу оценки.</span><span class="sxs-lookup"><span data-stu-id="7a0af-146">The query optimizer estimates a higher cardinality by adding an exponential component to the estimation equation.</span></span> <span data-ttu-id="7a0af-147">Теперь оптимизатор запросов вычисляет, что 22,36 строк (05 \* SQRT (. 20) \* 1000 строк = 22,36 строк) соответствует предикату.</span><span class="sxs-lookup"><span data-stu-id="7a0af-147">The query optimizer now estimates that 22.36 rows ( .05 \* SQRT(.20) \* 1000 rows = 22.36 rows ) match the predicate.</span></span> <span data-ttu-id="7a0af-148">Для этого варианта и определенного распределения данных оценка в 22,36 строки более близка к фактическим 50 строкам, которые будут возвращены запросом.</span><span class="sxs-lookup"><span data-stu-id="7a0af-148">For this scenario and specific data distribution, 22.36 rows is closer to the actual 50 rows that the query will return.</span></span>  
  
 <span data-ttu-id="7a0af-149">Обратите внимание, что новая логика механизма оценки количества элементов предусматривает сортировку по избирательности предиката и увеличивает экспоненту.</span><span class="sxs-lookup"><span data-stu-id="7a0af-149">Note, the new cardinality estimator logic sorts the predicate selectivities and increases the exponent.</span></span> <span data-ttu-id="7a0af-150">Например, если предикат избирательности был 05, .20 и .25, то оценка количества элементов будет равна (. 05 \* SQRT (. 20) \* Sqrt (sqrt (. 25))).</span><span class="sxs-lookup"><span data-stu-id="7a0af-150">For example, if the predicate selectivities were .05, .20, and .25, the cardinality estimate would be (.05 \* SQRT(.20) \* SQRT(SQRT(.25)) ).</span></span>  
  
### <a name="example-c-new-cardinality-estimates-assume-filtered-predicates-on-different-tables-are-independent"></a><span data-ttu-id="7a0af-151">Пример В. В новых механизмах оценки количества элементов предполагается, что отфильтрованные предикаты из разных таблиц не зависят друг от друга</span><span class="sxs-lookup"><span data-stu-id="7a0af-151">Example C. New cardinality estimates assume filtered predicates on different tables are independent</span></span>  
 <span data-ttu-id="7a0af-152">В этом примере в предыдущем механизме оценки количества элементов предполагается, что фильтры предикатов s.type и r.date связаны друг с другом.</span><span class="sxs-lookup"><span data-stu-id="7a0af-152">For this example, the previous cardinality estimator assumes that the predicate filters s.type and r.date are correlated.</span></span> <span data-ttu-id="7a0af-153">Однако результаты теста современных рабочих нагрузок показали, что фильтры предикатов для столбцов из различных таблиц обычно не связаны друг с другом.</span><span class="sxs-lookup"><span data-stu-id="7a0af-153">However, test results on modern workloads showed that predicate filters on columns in different tables are usually not correlated with each other.</span></span>  
  
```  
SELECT s.ticket, s.customer, r.store FROM dbo.Sales AS s CROSS JOIN dbo.Returns AS r  
WHERE s.ticket = r.ticket AND s.type = 'toy' AND r.date = '2013-12-19';  
```  
  
 <span data-ttu-id="7a0af-154">Это поведение изменено.</span><span class="sxs-lookup"><span data-stu-id="7a0af-154">This behavior has changed.</span></span> <span data-ttu-id="7a0af-155">Теперь в новой логике механизма оценки количества элементов предполагается, что фильтр s.type не связан с фильтром r.date.</span><span class="sxs-lookup"><span data-stu-id="7a0af-155">Now, the new cardinality estimator logic assumes that s.type is not correlated with r.date.</span></span> <span data-ttu-id="7a0af-156">На практике это означает, что возврат игрушек происходит каждый день, а не только в какой-то определенный день.</span><span class="sxs-lookup"><span data-stu-id="7a0af-156">In practical terms, the assumption is that toys are returned every day and not only on a specific day.</span></span> <span data-ttu-id="7a0af-157">В этом случае новые оценки количества элементов будут выражаться меньшим числом, чем предыдущие оценки количества элементов.</span><span class="sxs-lookup"><span data-stu-id="7a0af-157">In this case, the new cardinality estimates will be a smaller number than the previous cardinality estimates.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7a0af-158">См. также:</span><span class="sxs-lookup"><span data-stu-id="7a0af-158">See Also</span></span>  
 [<span data-ttu-id="7a0af-159">Наблюдение и настройка производительности</span><span class="sxs-lookup"><span data-stu-id="7a0af-159">Monitor and Tune for Performance</span></span>](monitor-and-tune-for-performance.md)  
  
  
