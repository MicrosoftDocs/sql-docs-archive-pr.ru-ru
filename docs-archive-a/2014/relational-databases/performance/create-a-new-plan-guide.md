---
title: Создание структуры плана | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
f1_keywords:
- sql12.swb.designer.newplanguide.f1
helpviewer_keywords:
- creating plan guides
- plan guides [SQL Server]. creating
ms.assetid: e1ad78bb-4857-40ea-a0c6-dcf5c28aef2f
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 60ba31e2a63575a316db5befb397bea59c0ad1e6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87668834"
---
# <a name="create-a-new-plan-guide"></a>Создание структуры плана
  Структуру плана в [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] можно создать с помощью среды [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] или [!INCLUDE[tsql](../../includes/tsql-md.md)]. Структура плана влияет на оптимизацию запросов путем присоединения указаний запросов или фиксированного плана запросов к ним. В структуре плана указывается оператор [!INCLUDE[tsql](../../includes/tsql-md.md)] , который нужно оптимизировать, и либо предложение OPTION, которое содержит указания запросов, которые будут использоваться, либо специальный план запроса, который используется для оптимизации запроса. Когда запрос выполняется, оптимизатор запросов сопоставляет инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)] со структурой плана и либо присоединяет условие OPTION к запросу в процессе выполнения, либо использует указанный план запроса.  
  
 **В этом разделе**  
  
-   **Перед началом работы**  
  
     [Ограничения](#Restrictions)  
  
     [Безопасность](#Security)  
  
-   **Создание структуры плана**  
  
     [Среда SQL Server Management Studio](#SSMSProcedure)  
  
     [Transact-SQL](#TsqlProcedure)  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> Ограничения  
  
-   Аргументы процедуры sp_create_plan_guide должны задаваться в указанном порядке. При задании значений параметрам процедуры `sp_create_plan_guide` все имена параметров необходимо указывать явно или вообще не указывать. Например, если указан параметр `@name =`, необходимо также указать параметры `@stmt =`, `@type =` и т. д. Подобным образом, если параметр `@name =` пропущен и указано только его значение, имена остальных параметров должны быть также пропущены и должны быть указаны только их значения. Имена аргументов приводятся исключительно в целях описания, чтобы помочь разобраться с синтаксисом. [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не проверяет соответствие указанных имен параметров их позициям.  
  
-   Можно создать несколько структур планов OBJECT или SQL для одного и того же запроса и пакета либо модуля. Однако только одна структура плана может быть включена в данный момент времени.  
  
-   Нельзя создавать структуры планов типа OBJECT для значения @module_or_batch, ссылающегося на хранимую процедуру, функцию или триггер DML, который задает предложение WITH ENCRYPTION или является временным.  
  
-   Попытка удаления или изменения функции, хранимой процедуры или триггера DML, на которые имеется ссылка в структуре плана (как включенных, так и отключенных), приводит к ошибке. Попытка удалить таблицу, для которой определен триггер, имеющий соответствующую ссылку в структуре плана, также вызывает ошибку.  
  
###  <a name="security"></a><a name="Security"></a> безопасность  
  
####  <a name="permissions"></a><a name="Permissions"></a> Permissions  
 Для создания структуры плана типа OBJECT необходимо разрешение ALTER на соответствующий объект. Чтобы создать структуру плана типа SQL или TEMPLATE, необходимо обладать разрешением ALTER на текущую базу данных.  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> Использование среды SQL Server Management Studio  
  
#### <a name="to-create-a-plan-guide"></a>Создание структуры плана  
  
1.  Щелкните значок «+», чтобы развернуть базу данных, в которой требуется создать структуру плана, затем щелкните значок «+», чтобы развернуть папку **Программирование** .  
  
2.  Щелкните правой кнопкой мыши папку **структуры планов** и выберите пункт **создать структуру плана...**.  
  
3.  В поле **Имя** диалогового окна **Создание структуры плана** введите имя новой структуры плана.  
  
4.  В поле **Инструкция** введите инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)] , к которой должна быть применена структура плана.  
  
5.  В списке **Тип области** выберите сущность, в которой содержится инструкция [!INCLUDE[tsql](../../includes/tsql-md.md)] . Это указывает контекст для сопоставления оператора [!INCLUDE[tsql](../../includes/tsql-md.md)] со структурой плана. Возможными значениями являются **OBJECT**, **SQL**и **TEMPLATE**.  
  
6.  В поле **Поток области** введите текст пакета, в котором содержится инструкция [!INCLUDE[tsql](../../includes/tsql-md.md)] . Текст пакета не может содержать инструкцию USE``*database* . Поле **Поток области** доступно, только если в качестве второго типа выбран тип **SQL** . Если типом области является SQL, а поле пакета области пустое, в качестве текста пакета используется значение, указанное в поле **Инструкция** .  
  
7.  В списке **Имя схемы области** введите имя схемы, в которой содержится объект. Поле **Имя схемы области** доступно, только если в качестве второго типа выбран тип области **Объект** .  
  
8.  В поле **Имя области объекта** введите имя хранимой процедуры [!INCLUDE[tsql](../../includes/tsql-md.md)] , определяемой пользователем скалярной функции, функции с табличным значением из нескольких инструкций или триггера DML, в котором содержится инструкция [!INCLUDE[tsql](../../includes/tsql-md.md)] . Поле **Имя объекта области** доступно, только если выбран тип области **Объект** .  
  
9. В поле **Параметры** введите имя параметра и тип данных для всех параметров, внедренных в инструкции [!INCLUDE[tsql](../../includes/tsql-md.md)] .  
  
     Параметры применяются только при выполнении одного из следующих условий.  
  
    -   Тип области равен **SQL** или **TEMPLATE**. Если тип области равен **TEMPLATE**, то параметры не могут иметь значение NULL.  
  
    -   Инструкция [!INCLUDE[tsql](../../includes/tsql-md.md)] передается при помощи хранимой процедуры sp_executesql с указанием значения параметра, или компонент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняет внутреннюю отправку инструкции после ее параметризации.  
  
10. В поле **Подсказки** введите указания запросов или план запроса, применяемые к инструкции [!INCLUDE[tsql](../../includes/tsql-md.md)] . Чтобы задать одно или несколько указаний запроса, введите предложение OPTION.  
  
11. Нажмите кнопку **ОК**.  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> Использование Transact-SQL  
  
#### <a name="to-create-a-plan-guide"></a>Создание структуры плана  
  
1.  В **обозревателе объектов**подключитесь к экземпляру компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)].  
  
2.  На стандартной панели выберите пункт **Создать запрос**.  
  
3.  Скопируйте следующий пример в окно запроса и нажмите кнопку **Выполнить**.  
  
    ```  
    -- creates a plan guide named Guide1 based on a SQL statement  
    EXEC sp_create_plan_guide   
        @name = N'Guide1',   
        @stmt = N'SELECT TOP 1 *   
                  FROM Sales.SalesOrderHeader   
                  ORDER BY OrderDate DESC',   
        @type = N'SQL',  
        @module_or_batch = NULL,   
        @params = NULL,   
        @hints = N'OPTION (MAXDOP 1)';  
  
    ```  
  
 Дополнительные сведения см. в разделе [sp_create_plan_guide (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-create-plan-guide-transact-sql).  
  
  
