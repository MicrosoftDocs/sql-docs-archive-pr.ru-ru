---
title: Статистика | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- statistical information [SQL Server], query optimization
- query performance [SQL Server], statistics
- query optimization statistics [SQL Server]
- statistical information [SQL Server], database options
- query optimization statistics [SQL Server], about query optimization statistics
- statistical information [SQL Server], guidelines
- statistical information [SQL Server]
- using statistics [SQL Server]
- statistical information [SQL Server], indexes
- index statistics [SQL Server]
- query optimizer [SQL Server], statistics
- statistics [SQL Server]
ms.assetid: b86a88ba-4f7c-4e19-9fbd-2f8bcd3be14a
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0f0950e48245bed53581d2f91b120ab9555aa562
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87667630"
---
# <a name="statistics"></a><span data-ttu-id="2cfd2-102">Статистика</span><span class="sxs-lookup"><span data-stu-id="2cfd2-102">Statistics</span></span>
  <span data-ttu-id="2cfd2-103">Оптимизатор запросов использует статистику для создания планов запросов, которые повышают производительность запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-103">The query optimizer uses statistics to create query plans that improve query performance.</span></span> <span data-ttu-id="2cfd2-104">Для большинства запросов оптимизатор уже создает необходимую статистику для формирования высококачественного плана запроса, но в некоторых случаях для достижения наилучших результатов нужно создать дополнительные статистические данные или изменить структуру запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-104">For most queries, the query optimizer already generates the necessary statistics for a high quality query plan; in a few cases, you need to create additional statistics or modify the query design for best results.</span></span> <span data-ttu-id="2cfd2-105">В этом разделе обсуждаются основные статистические понятия и предоставляются рекомендации по эффективному использованию статистики для оптимизации запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-105">This topic discusses statistics concepts and provides guidelines for using query optimization statistics effectively.</span></span>  
  
##  <a name="components-and-concepts"></a><a name="DefinitionQOStatistics"></a> <span data-ttu-id="2cfd2-106">Компоненты и основные понятия</span><span class="sxs-lookup"><span data-stu-id="2cfd2-106">Components and Concepts</span></span>  
 <span data-ttu-id="2cfd2-107">Статистика</span><span class="sxs-lookup"><span data-stu-id="2cfd2-107">Statistics</span></span>  
 <span data-ttu-id="2cfd2-108">Статистика для оптимизации запросов — это объекты, содержащие статистические сведения о распределении значений в одном или нескольких столбцах таблицы или индексированного представления.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-108">Statistics for query optimization are objects that contain statistical information about the distribution of values in one or more columns of a table or indexed view.</span></span> <span data-ttu-id="2cfd2-109">Оптимизатор запросов использует эти статистические данные для оценки количества *элементов*или количества строк в результатах запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-109">The query optimizer uses these statistics to estimate the *cardinality*, or number of rows, in the query result.</span></span> <span data-ttu-id="2cfd2-110">Эти *оценки количества элементов* позволяют оптимизатору запросов создавать высококачественный план запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-110">These *cardinality estimates* enable the query optimizer to create a high-quality query plan.</span></span> <span data-ttu-id="2cfd2-111">Например, оптимизатор запросов может использовать оценочное количество элементов, чтобы выбрать оператор index seek вместо оператора index scan, который потребляет больше ресурсов, и благодаря этому повысить производительность запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-111">For example, the query optimizer could use cardinality estimates to choose the index seek operator instead of the more resource-intensive index scan operator, and in doing so improve query performance.</span></span>  
  
 <span data-ttu-id="2cfd2-112">Каждый объект статистики создается для списка из одного или нескольких столбцов таблицы и содержит гистограмму, в которой отображается распределение значений в первом столбце.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-112">Each statistics object is created on a list of one or more table columns and includes a histogram displaying the distribution of values in the first column.</span></span> <span data-ttu-id="2cfd2-113">Объекты статистики для нескольких столбцов также хранят статистические сведения о корреляции значений между столбцами.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-113">Statistics objects on multiple columns also store statistical information about the correlation of values among the columns.</span></span> <span data-ttu-id="2cfd2-114">Эти статистические данные корреляции называются значениями *плотности*и получаются из числа уникальных строк значений столбцов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-114">These correlation statistics, or *densities*, are derived from the number of distinct rows of column values.</span></span> <span data-ttu-id="2cfd2-115">Дополнительные сведения об объектах статистики см. в статье [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-115">For more information about statistics objects, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="2cfd2-116">Отфильтрованная статистика</span><span class="sxs-lookup"><span data-stu-id="2cfd2-116">Filtered Statistics</span></span>  
 <span data-ttu-id="2cfd2-117">Отфильтрованная статистика может повысить производительность запросов, которые выполняют выборку из четко определенных подмножеств данных.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-117">Filtered statistics can improve query performance for queries that select from well-defined subsets of data.</span></span> <span data-ttu-id="2cfd2-118">Отфильтрованная статистика использует предикат фильтра для выбора подмножества данных, включенных в статистику.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-118">Filtered statistics use a filter predicate to select the subset of data that is included in the statistics.</span></span> <span data-ttu-id="2cfd2-119">Грамотно отфильтрованная статистика может улучшить план выполнения запроса по сравнению со статистикой по полной таблице.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-119">Well-designed filtered statistics can improve the query execution plan compared with full-table statistics.</span></span> <span data-ttu-id="2cfd2-120">Дополнительные сведения о предикате фильтра см. в статье [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-120">For more information about the filter predicate, see [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span></span> <span data-ttu-id="2cfd2-121">Дополнительные сведения об условиях создания отфильтрованной статистики см. в подразделе [Условия создания статистики](#UpdateStatistics) этого раздела.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-121">For more information about when to create filtered statistics, see the [When to Create Statistics](#UpdateStatistics) section in this topic.</span></span> <span data-ttu-id="2cfd2-122">Пример использования можно просмотреть в записи блога [Использование отфильтрованных статистик с секционированными таблицами](https://go.microsoft.com/fwlink/?LinkId=178505)на веб-сайте SQLCAT.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-122">For a case study, see the blog entry, [Using Filtered Statistics with Partitioned Tables](https://go.microsoft.com/fwlink/?LinkId=178505), on the SQLCAT Web site.</span></span>  
  
 <span data-ttu-id="2cfd2-123">Параметры статистики</span><span class="sxs-lookup"><span data-stu-id="2cfd2-123">Statistics Options</span></span>  
 <span data-ttu-id="2cfd2-124">Предусмотрены три параметра, которые влияют на условия и методы создания и обновления статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-124">There are three options that you can set that affect when and how statistics are created and updated.</span></span> <span data-ttu-id="2cfd2-125">Эти параметры задаются только на уровне базы данных.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-125">These options are set at the database level only.</span></span>  
  
 <span data-ttu-id="2cfd2-126">Параметр AUTO_CREATE_STATISTICS</span><span class="sxs-lookup"><span data-stu-id="2cfd2-126">AUTO_CREATE_STATISTICS Option</span></span>  
 <span data-ttu-id="2cfd2-127">Если включен параметр AUTO_CREATE_STATISTICS (автоматическое создание статистики), то оптимизатор запросов в случае необходимости создает статистику по отдельным столбцам в предикате запроса, чтобы улучшить оценку количества элементов для плана запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-127">When the automatic create statistics option, AUTO_CREATE_STATISTICS, is on, the query optimizer creates statistics on individual columns in the query predicate, as necessary, to improve cardinality estimates for the query plan.</span></span> <span data-ttu-id="2cfd2-128">Такая статистика по отдельным столбцам создается для столбцов, у которых отсутствует гистограмма в существующем объекте статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-128">These single-column statistics are created on columns that do not already have a histogram in an existing statistics object.</span></span> <span data-ttu-id="2cfd2-129">Параметр AUTO_CREATE_STATISTICS не определяет, создается ли статистика для индексов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-129">The AUTO_CREATE_STATISTICS option does not determine whether statistics get created for indexes.</span></span> <span data-ttu-id="2cfd2-130">Кроме того, этот параметр не создает отфильтрованную статистику.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-130">This option also does not generate filtered statistics.</span></span> <span data-ttu-id="2cfd2-131">Он применяется строго к статистике по отдельным столбцам для всей таблицы.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-131">It applies strictly to single-column statistics for the full table.</span></span>  
  
 <span data-ttu-id="2cfd2-132">Если оптимизатор запросов создает статистику в результате использования параметра AUTO_CREATE_STATISTICS, то имя статистики начинается с `_WA`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-132">When the query optimizer creates statistics as a result of using the AUTO_CREATE_STATISTICS option, the statistics name starts with `_WA`.</span></span> <span data-ttu-id="2cfd2-133">С помощью следующего запроса можно определить, создал ли оптимизатор запросов статистику для столбца предиката запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-133">You can use the following query to determine if the query optimizer has created statistics for a query predicate column.</span></span>  
  
```  
SELECT OBJECT_NAME(s.object_id) AS object_name,  
    COL_NAME(sc.object_id, sc.column_id) AS column_name,  
    s.name AS statistics_name  
FROM sys.stats AS s JOIN sys.stats_columns AS sc  
    ON s.stats_id = sc.stats_id AND s.object_id = sc.object_id  
WHERE s.name like '_WA%'  
ORDER BY s.name;  
```  
  
 <span data-ttu-id="2cfd2-134">Параметр AUTO_UPDATE_STATISTICS</span><span class="sxs-lookup"><span data-stu-id="2cfd2-134">AUTO_UPDATE_STATISTICS Option</span></span>  
 <span data-ttu-id="2cfd2-135">Если включен параметр AUTO_UPDATE_STATISTICS (автоматическое обновление статистики), то оптимизатор запросов определяет, когда статистика может оказаться устаревшей, и обновляет ее, если она используется в запросе.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-135">When the automatic update statistics option, AUTO_UPDATE_STATISTICS, is on, the query optimizer determines when statistics might be out-of-date and then updates them when they are used by a query.</span></span> <span data-ttu-id="2cfd2-136">Статистика становится устаревшей, после того как операции вставки, обновления, удаления или слияния изменяют распределение данных в таблице или индексированном представлении.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-136">Statistics become out-of-date after insert, update, delete, or merge operations change the data distribution in the table or indexed view.</span></span> <span data-ttu-id="2cfd2-137">Оптимизатор запросов определяет, когда статистика может оказаться устаревшей, подсчитывая операции изменения данных с момента последнего обновления статистики и сравнивая количество изменений с пороговым значением.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-137">The query optimizer determines when statistics might be out-of-date by counting the number of data modifications since the last statistics update and comparing the number of modifications to a threshold.</span></span> <span data-ttu-id="2cfd2-138">Пороговое значение основано на количестве строк в таблице или индексированном представлении.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-138">The threshold is based on the number of rows in the table or indexed view.</span></span>  
  
 <span data-ttu-id="2cfd2-139">Оптимизатор запросов проверяет наличие устаревшей статистики перед компиляцией запроса и до выполнения кэшированного плана запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-139">The query optimizer checks for out-of-date statistics before compiling a query and before executing a cached query plan.</span></span> <span data-ttu-id="2cfd2-140">Перед компиляцией запроса оптимизатор запросов с помощью столбцов, таблиц и индексированных представлений в предикате запроса определяет, какая статистика могла устареть.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-140">Before compiling a query, the query optimizer uses the columns, tables, and indexed views in the query predicate to determine which statistics might be out-of-date.</span></span> <span data-ttu-id="2cfd2-141">Перед выполнением кэшированного плана запроса компонент [!INCLUDE[ssDE](../../../includes/ssde-md.md)] проверяет, ссылается ли план запроса на актуальную статистику.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-141">Before executing a cached query plan, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] verifies that the query plan references up-to-date statistics.</span></span>  
  
 <span data-ttu-id="2cfd2-142">Параметр AUTO_UPDATE_STATISTICS применяется к объектам статистики, создаваемым для индексов, отдельных столбцов в предикатах запросов, и к статистике, создаваемой инструкцией [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="2cfd2-142">The AUTO_UPDATE_STATISTICS option applies to statistics objects created for indexes, single-columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="2cfd2-143">Этот параметр также применяется к отфильтрованной статистике.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-143">This option also applies to filtered statistics.</span></span>  
  
 <span data-ttu-id="2cfd2-144">AUTO_UPDATE_STATISTICS_ASYNC</span><span class="sxs-lookup"><span data-stu-id="2cfd2-144">AUTO_UPDATE_STATISTICS_ASYNC</span></span>  
 <span data-ttu-id="2cfd2-145">Параметр AUTO_UPDATE_STATISTICS_ASYNC, который управляет асинхронным обновлением статистики, определяет, какой режим обновления статистики, синхронный или асинхронный, использует оптимизатор запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-145">The asynchronous statistics update option, AUTO_UPDATE_STATISTICS_ASYNC, determines whether the query optimizer uses synchronous or asynchronous statistics updates.</span></span> <span data-ttu-id="2cfd2-146">По умолчанию параметр асинхронного обновления статистики отключен, и оптимизатор запросов обновляет статистику синхронно.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-146">By default, the asynchronous statistics update option is off, and the query optimizer updates statistics synchronously.</span></span> <span data-ttu-id="2cfd2-147">Параметр AUTO_UPDATE_STATISTICS_ASYNC применяется к объектам статистики, создаваемым для индексов, отдельных столбцов в предикатах запросов, и к статистике, создаваемой инструкцией [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="2cfd2-147">The AUTO_UPDATE_STATISTICS_ASYNC option applies to statistics objects created for indexes, single columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span>  
  
 <span data-ttu-id="2cfd2-148">Обновление статистики может выполняться синхронно (режим по умолчанию) или асинхронно.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-148">Statistics updates can be either synchronous (the default) or asynchronous.</span></span> <span data-ttu-id="2cfd2-149">При синхронном обновлении статистики запросы всегда компилируются и выполняются с актуальной статистикой. Если статистика оказывается устаревшей, то оптимизатор запросов ожидает появления обновленной статистики перед компиляцией и выполнением запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-149">With synchronous statistics updates, queries always compile and execute with up-to-date statistics; When statistics are out-of-date, the query optimizer waits for updated statistics before compiling and executing the query.</span></span> <span data-ttu-id="2cfd2-150">При асинхронном обновлении статистики запросы компилируются с существующей статистикой, даже если она устарела. Если на момент компиляции запроса статистика оказывается устаревшей, то оптимизатор запросов может выбрать неоптимальный план запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-150">With asynchronous statistics updates, queries compile with existing statistics even if the existing statistics are out-of-date; The query optimizer could choose a suboptimal query plan if statistics are out-of-date when the query compiles.</span></span> <span data-ttu-id="2cfd2-151">Запросы, которые компилируются после выполнения асинхронного обновления, будут усовершенствованы благодаря использованию обновленной статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-151">Queries that compile after the asynchronous updates have completed will benefit from using the updated statistics.</span></span>  
  
 <span data-ttu-id="2cfd2-152">Использовать синхронную статистику рекомендуется при выполнении операций, изменяющих распределение данных, таких как усечение таблицы или массовое обновление большой процентной доли строк.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-152">Consider using synchronous statistics when you perform operations that change the distribution of data, such as truncating a table or performing a bulk update of a large percentage of the rows.</span></span> <span data-ttu-id="2cfd2-153">Если после выполнения операции статистика не будет обновлена, то использование синхронной статистики обеспечит создание актуальной статистики перед выполнением запросов к изменившимся данным.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-153">If you do not update the statistics after completing the operation, using synchronous statistics will ensure statistics are up-to-date before executing queries on the changed data.</span></span>  
  
 <span data-ttu-id="2cfd2-154">Асинхронная статистика рекомендуется для достижения более прогнозируемого времени ответа на запросы в следующих сценариях.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-154">Consider using asynchronous statistics to achieve more predictable query response times for the following scenarios:</span></span>  
  
-   <span data-ttu-id="2cfd2-155">Приложение часто выполняет один и тот же запрос, схожие запросы или схожие кэшированные планы запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-155">Your application frequently executes the same query, similar queries, or similar cached query plans.</span></span> <span data-ttu-id="2cfd2-156">Асинхронное обновление статистики может обеспечить более прогнозируемое время ответа на запрос по сравнению с синхронным обновлением статистики, поскольку оптимизатор запросов может выполнять входящие запросы, не ожидая появления актуальной статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-156">Your query response times might be more predictable with asynchronous statistics updates than with synchronous statistics updates because the query optimizer can execute incoming queries without waiting for up-to-date statistics.</span></span> <span data-ttu-id="2cfd2-157">Это устраняет задержку в некоторых запросах, но не влияет на другие запросы.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-157">This avoids delaying some queries and not others.</span></span>  
  
-   <span data-ttu-id="2cfd2-158">Были случаи, когда в приложении истекало время ожидания клиентских запросов в результате ожидания обновленной статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-158">Your application has experienced client request time outs caused by one or more queries waiting for updated statistics.</span></span> <span data-ttu-id="2cfd2-159">В некоторых случаях ожидание синхронной статистики может вызвать аварийное завершение приложений, в которых задано малое время ожидания.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-159">In some cases, waiting for synchronous statistics could cause applications with aggressive time outs to fail.</span></span>  
  
 <span data-ttu-id="2cfd2-160">INCREMENTAL STATS</span><span class="sxs-lookup"><span data-stu-id="2cfd2-160">INCREMENTAL STATS</span></span>  
 <span data-ttu-id="2cfd2-161">При значении ON статистики создаются как статистики отдельно по секциям.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-161">When ON, the statistics created are per partition statistics.</span></span> <span data-ttu-id="2cfd2-162">При значении OFF дерево статистик удаляется и [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] повторно вычисляет статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-162">When OFF, the statistics tree is dropped and [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] re-computes the statistics.</span></span> <span data-ttu-id="2cfd2-163">Значение по умолчанию — OFF.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-163">The default is OFF.</span></span> <span data-ttu-id="2cfd2-164">Этот параметр переопределяет свойство уровня базы данных INCREMENTAL.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-164">This setting overrides the database level INCREMENTAL property.</span></span>  
  
 <span data-ttu-id="2cfd2-165">Когда в большую таблицу добавляются новые секции, статистики должны быть обновлены для включения новых секций.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-165">When new partitions are added to a large table, statistics should be updated to include the new partitions.</span></span> <span data-ttu-id="2cfd2-166">Однако время, требуемое для сканирования всей таблицы (параметр FULLSCAN или SAMPLE) может быть весьма большим.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-166">However the time required to scan the entire table (FULLSCAN or SAMPLE option) might be quite long.</span></span> <span data-ttu-id="2cfd2-167">Кроме того, в сканировании всей таблицы нет необходимости, поскольку могут требоваться только статистики для новых секций.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-167">Also, scanning the entire table isn't necessary because only the statistics on the new partitions might be needed.</span></span> <span data-ttu-id="2cfd2-168">Параметр добавочных статистик создает и хранит статистические данные для каждой из секций и при обновлении обновляет статистику только для тех секций, которым требуются новые статистики</span><span class="sxs-lookup"><span data-stu-id="2cfd2-168">The incremental option creates and stores statistics on a per partition basis, and when updated, only refreshes statistics on those partitions that need new statistics</span></span>  
  
 <span data-ttu-id="2cfd2-169">Если статистики по секциям не поддерживаются, параметр пропускается и выводится предупреждение.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-169">If per partition statistics are not supported the option is ignored and a warning is generated.</span></span> <span data-ttu-id="2cfd2-170">Добавочные статистики не поддерживаются для следующих типов статистических данных.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-170">Incremental stats are not supported for following statistics types:</span></span>  
  
-   <span data-ttu-id="2cfd2-171">Статистики, созданные с индексами, не выровненными по секциям для базовой таблицы.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-171">Statistics created with indexes that are not partition-aligned with the base table.</span></span>  
  
-   <span data-ttu-id="2cfd2-172">Статистики, созданные в доступных для чтения базах данных-получателях AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-172">Statistics created on AlwaysOn readable secondary databases.</span></span>  
  
-   <span data-ttu-id="2cfd2-173">Статистики, созданные в базах данных, доступных только для чтения.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-173">Statistics created on read-only databases.</span></span>  
  
-   <span data-ttu-id="2cfd2-174">Статистики, созданные по фильтрованным индексам.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-174">Statistics created on filtered indexes.</span></span>  
  
-   <span data-ttu-id="2cfd2-175">Статистика, созданная по представлениям.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-175">Statistics created on views.</span></span>  
  
-   <span data-ttu-id="2cfd2-176">Статистики, созданные по внутренним таблицам.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-176">Statistics created on internal tables.</span></span>  
  
-   <span data-ttu-id="2cfd2-177">Статистики, созданные с пространственными индексами или XML-индексами.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-177">Statistics created with spatial indexes or XML indexes.</span></span>  
  
||  
|-|  
|<span data-ttu-id="2cfd2-178">**Применимо к**: с [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] до [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="2cfd2-178">**Applies to**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] through [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>|  
  
##  <a name="when-to-create-statistics"></a><a name="CreateStatistics"></a><span data-ttu-id="2cfd2-179">Время создания статистики</span><span class="sxs-lookup"><span data-stu-id="2cfd2-179">When to Create Statistics</span></span>  
 <span data-ttu-id="2cfd2-180">Оптимизатор запросов самостоятельно создает статистику следующим образом.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-180">The query optimizer already creates statistics in the following ways:</span></span>  
  
1.  <span data-ttu-id="2cfd2-181">Оптимизатор запросов создает статистику для индексов таблиц или представлений в момент создания индекса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-181">The query optimizer creates statistics for indexes on tables or views when the index is created.</span></span> <span data-ttu-id="2cfd2-182">Такая статистика создается по ключевым столбцам индекса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-182">These statistics are created on the key columns of the index.</span></span> <span data-ttu-id="2cfd2-183">Если индекс является отфильтрованным, то оптимизатор запросов создает отфильтрованную статистику по тому же подмножеству строк, которое указано для отфильтрованного индекса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-183">If the index is a filtered index, the query optimizer creates filtered statistics on the same subset of rows specified for the filtered index.</span></span> <span data-ttu-id="2cfd2-184">Дополнительные сведения об отфильтрованных индексах см. в статье [Создание отфильтрованных индексов](../indexes/create-filtered-indexes.md) и [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-184">For more information about filtered indexes, see [Create Filtered Indexes](../indexes/create-filtered-indexes.md) and [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span></span>  
  
2.  <span data-ttu-id="2cfd2-185">Если включен параметр AUTO_CREATE_STATISTICS, оптимизатор запросов создает статистику для отдельных столбцов в предикатах запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-185">The query optimizer creates statistics for single columns in query predicates when AUTO_CREATE_STATISTICS is on.</span></span>  
  
 <span data-ttu-id="2cfd2-186">Для большинства запросов эти два метода создания статистики обеспечивают создание высококачественного плана запроса. В некоторых случаях план запроса можно усовершенствовать, создав дополнительную статистику с помощью инструкции [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="2cfd2-186">For most queries, these two methods for creating statistics ensure a high-quality query plan; in a few cases, you can improve query plans by creating additional statistics with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="2cfd2-187">Эта дополнительная статистика может фиксировать статистическую корреляцию, которую не учитывает оптимизатор запросов при создании статистики для индексов или отдельных столбцов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-187">These additional statistics can capture statistical correlations that the query optimizer does not account for when it creates statistics for indexes or single columns.</span></span> <span data-ttu-id="2cfd2-188">Приложение может иметь дополнительные статистические корреляции в данных таблицы; если учесть такие корреляции в объекте статистики, то оптимизатор запросов может усовершенствовать планы запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-188">Your application might have additional statistical correlations in the table data that, if calculated into a statistics object, could enable the query optimizer to improve query plans.</span></span> <span data-ttu-id="2cfd2-189">Например, план запроса можно улучшить путем использования отфильтрованной статистики по подмножеству строк данных или статистики по нескольким столбцам предиката запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-189">For example, filtered statistics on a subset of data rows or multicolumn statistics on query predicate columns might improve the query plan.</span></span>  
  
 <span data-ttu-id="2cfd2-190">Если статистика создается инструкцией CREATE STATISTICS, рекомендуется оставлять параметр AUTO_CREATE_STATISTICS включенным, чтобы оптимизатор запросов продолжал регулярно создавать статистику по отдельным столбцам предиката запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-190">When creating statistics with the CREATE STATISTICS statement, we recommend keeping the AUTO_CREATE_STATISTICS option on so that the query optimizer continues to routinely create single-column statistics for query predicate columns.</span></span> <span data-ttu-id="2cfd2-191">Дополнительные сведения о предикатах запросов см. в разделе [Условие поиска (Transact-SQL)](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-191">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="2cfd2-192">Создание статистики с помощью инструкции CREATE STATISTICS рекомендуется, когда выполняется любое из следующих условий.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-192">Consider creating statistics with the CREATE STATISTICS statement when any of the following applies:</span></span>  
  
-   <span data-ttu-id="2cfd2-193">Помощник по настройке ядра СУБД ( [!INCLUDE[ssDE](../../../includes/ssde-md.md)] ) рекомендует создание статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-193">The [!INCLUDE[ssDE](../../../includes/ssde-md.md)] Tuning Advisor suggests creating statistics.</span></span>  
  
-   <span data-ttu-id="2cfd2-194">Предикат запроса содержит несколько коррелирующих столбцов, которые еще не включены в один индекс.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-194">The query predicate contains multiple correlated columns that are not already in the same index.</span></span>  
  
-   <span data-ttu-id="2cfd2-195">Запрос выполняет выборку из подмножества данных.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-195">The query selects from a subset of data.</span></span>  
  
-   <span data-ttu-id="2cfd2-196">Для запроса отсутствует статистика.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-196">The query has missing statistics.</span></span>  
  
### <a name="query-predicate-contains-multiple-correlated-columns"></a><span data-ttu-id="2cfd2-197">Предикат запроса содержит несколько коррелирующих столбцов</span><span class="sxs-lookup"><span data-stu-id="2cfd2-197">Query Predicate Contains Multiple Correlated Columns</span></span>  
 <span data-ttu-id="2cfd2-198">Если предикат запроса содержит несколько столбцов, между которыми есть связи и зависимости, то статистика по нескольким столбцам может усовершенствовать план запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-198">When a query predicate contains multiple columns that have cross-column relationships and dependencies, statistics on the multiple columns might improve the query plan.</span></span> <span data-ttu-id="2cfd2-199">Статистика по нескольким столбцам содержит статистику корреляции между столбцами, называемую *плотностью*, которая недоступна в статистике по отдельным столбцам.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-199">Statistics on multiple columns contain cross-column correlation statistics, called *densities*, that are not available in single-column statistics.</span></span> <span data-ttu-id="2cfd2-200">Плотность может повысить точность оценки количества элементов, если результаты запроса зависят от связей между данными из нескольких столбцов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-200">Densities can improve cardinality estimates when query results depend on data relationships among multiple columns.</span></span>  
  
 <span data-ttu-id="2cfd2-201">Если столбцы уже принадлежат одному индексу, то объект статистики по нескольким столбцам уже существует и его не нужно создавать вручную.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-201">If the columns are already in the same index, the multicolumn statistics object already exists and it is not necessary to create it manually.</span></span> <span data-ttu-id="2cfd2-202">Если столбцы не принадлежат одному индексу, можно создать статистику по нескольким столбцам, создав индекс по столбцам или воспользовавшись инструкцией CREATE STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-202">If the columns are not already in the same index, you can create multicolumn statistics by creating an index on the columns or by using the CREATE STATISTICS statement.</span></span> <span data-ttu-id="2cfd2-203">На поддержание индекса расходуется больше системных ресурсов по сравнению с объектом статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-203">It requires more system resources to maintain an index than a statistics object.</span></span> <span data-ttu-id="2cfd2-204">Если приложению не нужен индекс по нескольким столбцам, можно сэкономить системные ресурсы, создав объект статистики и не создавая индекс.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-204">If the application does not require the multicolumn index, you can economize on system resources by creating the statistics object without creating the index.</span></span>  
  
 <span data-ttu-id="2cfd2-205">Во время создания статистики по нескольким столбцам порядок столбцов в определении объекта статистики влияет на эффективность применения плотности для оценки количества элементов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-205">When creating multicolumn statistics, the order of the columns in the statistics object definition affects the effectiveness of densities for making cardinality estimates.</span></span> <span data-ttu-id="2cfd2-206">Объект статистики хранит значения плотности для каждого префикса ключевых столбцов в определении объекта статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-206">The statistics object stores densities for each prefix of key columns in the statistics object definition.</span></span> <span data-ttu-id="2cfd2-207">Дополнительные сведения о плотностях см. в статье [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-207">For more information about densities, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="2cfd2-208">Чтобы получить значения плотности, полезные для оценки количества элементов, столбцы в предикате запроса должны совпадать с одним из префиксов столбцов в определении объекта статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-208">To create densities that are useful for cardinality estimates, the columns in the query predicate must match one of the prefixes of columns in the statistics object definition.</span></span> <span data-ttu-id="2cfd2-209">Например, следующий код создает объект статистики по столбцам `LastName`, `MiddleName`и `FirstName`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-209">For example, the following creates a multicolumn statistics object on the columns `LastName`, `MiddleName`, and `FirstName`.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
IF EXISTS (SELECT name FROM sys.stats  
    WHERE name = 'LastFirst'  
    AND object_ID = OBJECT_ID ('Person.Person'))  
DROP STATISTICS Person.Person.LastFirst;  
GO  
CREATE STATISTICS LastFirst ON Person.Person (LastName, MiddleName, FirstName);  
GO  
```  
  
 <span data-ttu-id="2cfd2-210">В этом примере объект статистики `LastFirst` содержит значения плотности для префиксов следующих столбцов: (`LastName`), (`LastName, MiddleName`) и (`LastName, MiddleName, FirstName`).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-210">In this example, the statistics object `LastFirst` has densities for the following column prefixes: (`LastName`), (`LastName, MiddleName`), and (`LastName, MiddleName, FirstName`).</span></span> <span data-ttu-id="2cfd2-211">Для (`LastName, FirstName`) плотность недоступна.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-211">The density is not available for (`LastName, FirstName`).</span></span> <span data-ttu-id="2cfd2-212">Если в запросе используются `LastName` и `FirstName` , но не используется `MiddleName`, то плотность будет недоступна для оценки количества элементов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-212">If the query uses `LastName` and `FirstName` without using `MiddleName`, the density is not available for cardinality estimates.</span></span>  
  
### <a name="query-selects-from-a-subset-of-data"></a><span data-ttu-id="2cfd2-213">Запрос выполняет выборку из подмножества данных</span><span class="sxs-lookup"><span data-stu-id="2cfd2-213">Query Selects from a Subset of Data</span></span>  
 <span data-ttu-id="2cfd2-214">Когда оптимизатор запросов создает статистику по отдельным столбцам и индексам, статистика создается по значениям во всех строках.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-214">When the query optimizer creates statistics for single columns and indexes, it creates the statistics for the values in all rows.</span></span> <span data-ttu-id="2cfd2-215">Если запросы выполняют выборку из подмножества строк и в этом подмножестве присутствует уникальное распределение данных, то отфильтрованная статистика может улучшить планы запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-215">When queries select from a subset of rows, and that subset of rows has a unique data distribution, filtered statistics can improve query plans.</span></span> <span data-ttu-id="2cfd2-216">Отфильтрованную статистику можно создать с помощью инструкции CREATE STATISTICS с предложением WHERE, чтобы определить выражение предиката фильтра.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-216">You can create filtered statistics by using the CREATE STATISTICS statement with the WHERE clause to define the filter predicate expression.</span></span>  
  
 <span data-ttu-id="2cfd2-217">Например, используем образец [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], где каждый продукт в таблице Production.Product относится к одной из четырех категорий в таблице Production.ProductCategory: велосипеды, запасные части, одежда и аксессуары.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-217">For example, using [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], each product in the Production.Product table belongs to one of four categories in the Production.ProductCategory table: Bikes, Components, Clothing, and Accessories.</span></span> <span data-ttu-id="2cfd2-218">Каждая из этих категорий содержит различные данные, распределенные по весу: вес велосипеда находится в диапазоне от 13,77 до 30,0, вес запчастей — в диапазоне от 2,12 до 1050,00, иногда встречаются значения NULL, значения веса одежды и аксессуаров также равны NULL.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-218">Each of the categories has a different data distribution for weight: bike weights range from 13.77 to 30.0, component weights range from 2.12 to 1050.00 with some NULL values, clothing weights are all NULL, and accessory weights are also NULL.</span></span>  
  
 <span data-ttu-id="2cfd2-219">В примере с категорией Bikes отфильтрованная статистика по весу всех велосипедов предоставит оптимизатору запросов более точную статистику, а также повысит качество плана запроса по сравнению с полнотабличной статистикой или несуществующей статистикой по столбцу Weight.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-219">Using Bikes as an example, filtered statistics on all bike weights will provide more accurate statistics to the query optimizer and can improve the query plan quality compared with full-table statistics or nonexistent statistics on the Weight column.</span></span> <span data-ttu-id="2cfd2-220">Столбец с весами велосипедов будет хорошим образцом для отфильтрованной статистики, но необязательно окажется удачным выбором для отфильтрованного индекса, если число уточняющих запросов веса относительно мало.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-220">The bike weight column is a good candidate for filtered statistics but not necessarily a good candidate for a filtered index if the number of weight lookups is relatively small.</span></span> <span data-ttu-id="2cfd2-221">Прирост производительности уточняющих запросов, обеспечиваемый отфильтрованным индексом, может оказаться меньше, чем дополнительные расходы на хранение и сопровождение, сопряженные с добавлением отфильтрованного индекса в базу данных.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-221">The performance gain for lookups that a filtered index provides might not outweigh the additional maintenance and storage cost for adding a filtered index to the database.</span></span>  
  
 <span data-ttu-id="2cfd2-222">Следующая инструкция создает отфильтрованную статистику `BikeWeights` по всем подкатегориям из категории Bikes.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-222">The following statement creates the `BikeWeights` filtered statistics on all of the subcategories for Bikes.</span></span> <span data-ttu-id="2cfd2-223">Отфильтрованное выражение предиката определяет велосипеды, выполняя перечисление всех подкатегорий велосипедов со сравнением `Production.ProductSubcategoryID IN (1,2,3)`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-223">The filtered predicate expression defines bikes by enumerating all of the bike subcategories with the comparison `Production.ProductSubcategoryID IN (1,2,3)`.</span></span> <span data-ttu-id="2cfd2-224">В предикате нельзя использовать имя категории Bikes, поскольку оно хранится в таблице Production.ProductCategory, а все столбцы в критерии фильтра должны быть в одной таблице.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-224">The predicate cannot use the Bikes category name because it is stored in the Production.ProductCategory table, and all columns in the filter expression must be in the same table.</span></span>  
  
 [!code-sql[StatisticsDDL#FilteredStats2](../../snippets/tsql/SQL14/tsql/statisticsddl/transact-sql/filteredstats.sql#filteredstats2)]  
  
 <span data-ttu-id="2cfd2-225">Оптимизатор запросов может использовать отфильтрованную статистику `BikeWeights` для улучшения плана запроса в следующем запросе, выбирающем все велосипеды, имеющие вес, превышающий `25`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-225">The query optimizer can use the `BikeWeights` filtered statistics to improve the query plan for the following query that selects all of the bikes that weigh more than `25`.</span></span>  
  
```  
SELECT P.Weight AS Weight, S.Name AS BikeName  
FROM Production.Product AS P  
    JOIN Production.ProductSubcategory AS S   
    ON P.ProductSubcategoryID = S.ProductSubcategoryID  
WHERE P.ProductSubcategoryID IN (1,2,3) AND P.Weight > 25  
ORDER BY P.Weight;  
GO  
```  
  
### <a name="query-identifies-missing-statistics"></a><span data-ttu-id="2cfd2-226">Запрос определяет пропущенную статистику</span><span class="sxs-lookup"><span data-stu-id="2cfd2-226">Query Identifies Missing Statistics</span></span>  
 <span data-ttu-id="2cfd2-227">Если в результате ошибки или другого события оптимизатору запросов не удается создать статистику, то он создает план запроса, не используя статистику.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-227">If an error or other event prevents the query optimizer from creating statistics, the query optimizer creates the query plan without using statistics.</span></span> <span data-ttu-id="2cfd2-228">Оптимизатор запросов помечает статистику как отсутствующую и пытается восстановить ее перед следующим выполнением запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-228">The query optimizer marks the statistics as missing and attempts to regenerate the statistics the next time the query is executed.</span></span>  
  
 <span data-ttu-id="2cfd2-229">Потерянная статистика отображается в виде предупреждений (имя таблицы красным шрифтом) на графическом отображении плана выполнения запроса в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span><span class="sxs-lookup"><span data-stu-id="2cfd2-229">Missing statistics are indicated as warnings (table name in red text) when the execution plan of a query is graphically displayed using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="2cfd2-230">Кроме того, определить отсутствие статистики можно с помощью наблюдения за классом событий **Missing Column Statistics** с помощью приложения [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)].</span><span class="sxs-lookup"><span data-stu-id="2cfd2-230">Additionally, monitoring the **Missing Column Statistics** event class by using [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] indicates when statistics are missing.</span></span> <span data-ttu-id="2cfd2-231">Дополнительные сведения см. в статье [Категория событий "Ошибки и предупреждения" (компонент Database Engine)](../event-classes/errors-and-warnings-event-category-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-231">For more information, see [Errors and Warnings Event Category &#40;Database Engine&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span></span>  
  
 <span data-ttu-id="2cfd2-232">Если статистика отсутствует, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-232">If statistics are missing, perform the following steps:</span></span>  
  
-   <span data-ttu-id="2cfd2-233">Убедитесь, что включены параметры AUTO_CREATE_STATISTICS и AUTO_UPDATE_STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-233">Verify that AUTO_CREATE_STATISTICS and AUTO_UPDATE_STATISTICS are on.</span></span>  
  
-   <span data-ttu-id="2cfd2-234">Убедитесь, что база данных доступна не только для чтения.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-234">Verify that the database is not read-only.</span></span> <span data-ttu-id="2cfd2-235">Если база данных доступна только для чтения, оптимизатор запросов не сможет сохранить статистику.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-235">If the database is read-only, the query optimizer cannot save statistics.</span></span>  
  
-   <span data-ttu-id="2cfd2-236">Создайте отсутствующую статистику инструкцией CREATE STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-236">Create the missing statistics by using the CREATE STATISTICS statement.</span></span>  
  
 <span data-ttu-id="2cfd2-237">Если статистика для доступной только для чтения базы данных или доступного только для чтения моментального снимка отсутствует или устарела, компонент [!INCLUDE[ssDE](../../../includes/ssde-md.md)] создаст и будет поддерживать временную статистику в базе данных `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-237">When statistics on a read-only database or read-only snapshot are missing or stale, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates and maintains temporary statistics in `tempdb`.</span></span> <span data-ttu-id="2cfd2-238">Когда компонент [!INCLUDE[ssDE](../../../includes/ssde-md.md)] создает временную статистику, перед именем статистики добавляется суффикс _readonly_database_statistic для проведения различия между временной статистикой и постоянной.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-238">When the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates temporary statistics, the statistics name is appended with the suffix _readonly_database_statistic to differentiate the temporary statistics from the permanent statistics.</span></span> <span data-ttu-id="2cfd2-239">Суффикс _readonly_database_statistic зарезервирован для статистики, создаваемой [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="2cfd2-239">The suffix _readonly_database_statistic is reserved for statistics generated by [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="2cfd2-240">Скрипты для временной статистики могут создаваться и воспроизводиться в базе данных для чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-240">Scripts for the temporary statistics can be created and reproduced on a read-write database.</span></span> <span data-ttu-id="2cfd2-241">При создании скрипта [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] изменяет суффикс имени статистики с _readonly_database_statistic на _readonly_database_statistic_scripted.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-241">When scripted, [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] changes the suffix of the statistics name from _readonly_database_statistic to _readonly_database_statistic_scripted.</span></span>  
  
 <span data-ttu-id="2cfd2-242">Только [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] может создавать и обновлять временную статистику.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-242">Only [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] can create and update temporary statistics.</span></span> <span data-ttu-id="2cfd2-243">Тем не менее можно удалять временную статистику и наблюдать за свойствами статистики с помощью тех же инструментов, которые используются для постоянной статистики:</span><span class="sxs-lookup"><span data-stu-id="2cfd2-243">However, you can delete temporary statistics and monitor statistics properties using the same tools that you use for permanent statistics:</span></span>  
  
-   <span data-ttu-id="2cfd2-244">Удаление временной статистики осуществляется с использованием инструкции [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="2cfd2-244">Delete temporary statistics using the [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="2cfd2-245">Наблюдение за статистикой ведется с помощью представлений каталога **sys.stats** и **sys.stats_columns** .</span><span class="sxs-lookup"><span data-stu-id="2cfd2-245">Monitor statistics using the **sys.stats** and **sys.stats_columns** catalog views.</span></span> <span data-ttu-id="2cfd2-246">**sys_stats** включает столбец **is_temporary** для указания на то, какая статистика является постоянной, а какая временной.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-246">**sys_stats** includes the **is_temporary** column, to indicate which statistics are permanent and which are temporary.</span></span>  
  
 <span data-ttu-id="2cfd2-247">Поскольку временная статистика хранится в базе данных `tempdb`, перезапуск службы [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] вызывает исчезновение всей временной статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-247">Because temporary statistics are stored in `tempdb`, a restart of the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service causes all temporary statistics to disappear.</span></span>  
  
##  <a name="when-to-update-statistics"></a><a name="UpdateStatistics"></a><span data-ttu-id="2cfd2-248">Время обновления статистики</span><span class="sxs-lookup"><span data-stu-id="2cfd2-248">When to Update Statistics</span></span>  
 <span data-ttu-id="2cfd2-249">Оптимизатор запросов определяет, когда статистика может оказаться устаревшей, а затем обновляет ее, если она необходима для плана запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-249">The query optimizer determines when statistics might be out-of-date and then updates them when they are needed for a query plan.</span></span> <span data-ttu-id="2cfd2-250">В некоторых случаях можно улучшить план запроса и тем самым повысить производительность запроса, обновляя статистику чаще, чем она обновляется при включенном параметре AUTO_UPDATE_STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-250">In some cases you can improve the query plan and therefore improve query performance by updating statistics more frequently than occur when AUTO_UPDATE_STATISTICS is on.</span></span> <span data-ttu-id="2cfd2-251">Статистику можно обновлять инструкцией UPDATE STATISTICS или хранимой процедурой sp_updatestats.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-251">You can update statistics with the UPDATE STATISTICS statement or the stored procedure sp_updatestats.</span></span>  
  
 <span data-ttu-id="2cfd2-252">Обновление статистики гарантирует, что запросы будут компилироваться с актуальной статистикой.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-252">Updating statistics ensures that queries compile with up-to-date statistics.</span></span> <span data-ttu-id="2cfd2-253">Однако обновление статистики вызывает перекомпиляцию запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-253">However, updating statistics causes queries to recompile.</span></span> <span data-ttu-id="2cfd2-254">Рекомендуется не обновлять статистику слишком часто, поскольку необходимо найти баланс между выигрышем в производительности за счет усовершенствованных планов запросов и потерей времени на перекомпиляцию запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-254">We recommend not updating statistics too frequently because there is a performance tradeoff between improving query plans and the time it takes to recompile queries.</span></span> <span data-ttu-id="2cfd2-255">Критерии выбора компромиссного решения зависят от приложения.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-255">The specific tradeoffs depend on your application.</span></span>  
  
 <span data-ttu-id="2cfd2-256">При обновлении статистики инструкцией UPDATE STATISTICS или хранимой процедурой sp_updatestats рекомендуется оставлять параметр AUTO_UPDATE_STATISTICS включенным, чтобы оптимизатор запросов продолжал регулярно обновлять статистику.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-256">When updating statistics with UPDATE STATISTICS or sp_updatestats, we recommend keeping AUTO_UPDATE_STATISTICS set to ON so that the query optimizer continues to routinely update statistics.</span></span> <span data-ttu-id="2cfd2-257">Дополнительные сведения об обновлении статистики по столбцу, индексу, таблице или индексированному представлению см. в разделе [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-257">For more information about how to update statistics on a column, an index, a table, or an indexed view, see [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span></span> <span data-ttu-id="2cfd2-258">Сведения об обновлении статистики по всем определяемым пользователем таблицам и внутренним таблицам в базе данных см. в описании хранимой процедуры [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-258">For information about how to update statistics for all user-defined and internal tables in the database, see the stored procedure [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="2cfd2-259">Чтобы определить время последнего обновления статистики, используйте функцию [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="2cfd2-259">To determine when statistics were last updated, use the [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) function.</span></span>  
  
 <span data-ttu-id="2cfd2-260">Обновление статистики рекомендуется в следующих ситуациях.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-260">Consider updating statistics for the following conditions:</span></span>  
  
-   <span data-ttu-id="2cfd2-261">Запросы выполняются медленно.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-261">Query execution times are slow.</span></span>  
  
-   <span data-ttu-id="2cfd2-262">Выполняются операции вставки в ключевые столбцы, отсортированные по возрастанию или по убыванию.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-262">Insert operations occur on ascending or descending key columns.</span></span>  
  
-   <span data-ttu-id="2cfd2-263">После операций обслуживания.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-263">After maintenance operations.</span></span>  
  
### <a name="query-execution-times-are-slow"></a><span data-ttu-id="2cfd2-264">Запросы выполняются медленно</span><span class="sxs-lookup"><span data-stu-id="2cfd2-264">Query Execution Times Are Slow</span></span>  
 <span data-ttu-id="2cfd2-265">Если время ответа на запросы велико или непрогнозируемо, убедитесь, что для запросов есть актуальная статистика, и только потом выполняйте дальнейшие шаги по диагностике.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-265">If query response times are slow or unpredictable, ensure that queries have up-to-date statistics before performing additional troubleshooting steps.</span></span>  
  
### <a name="insert-operations-occur-on-ascending-or-descending-key-columns"></a><span data-ttu-id="2cfd2-266">Выполняются операции вставки в ключевые столбцы, отсортированные по возрастанию или по убыванию</span><span class="sxs-lookup"><span data-stu-id="2cfd2-266">Insert Operations Occur on Ascending or Descending Key Columns</span></span>  
 <span data-ttu-id="2cfd2-267">Для статистики по ключевым столбцам, отсортированным по возрастанию или убыванию (например, столбец IDENTITY или столбцы отметок реального времени), может понадобиться более частое обновление, чем выполняемое оптимизатором запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-267">Statistics on ascending or descending key columns, such as IDENTITY or real-time timestamp columns, might require more frequent statistics updates than the query optimizer performs.</span></span> <span data-ttu-id="2cfd2-268">Операции вставки добавляют новые значения в столбцы, отсортированные по возрастанию или по убыванию.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-268">Insert operations append new values to ascending or descending columns.</span></span> <span data-ttu-id="2cfd2-269">Число добавляемых строк может оказаться слишком маленьким и не вызвать обновление статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-269">The number of rows added might be too small to trigger a statistics update.</span></span> <span data-ttu-id="2cfd2-270">Если статистика не является актуальной и запросы выполняют выборку из недавно добавленных строк, то в текущей статистике не будет оценки количества элементов для этих новых значений.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-270">If statistics are not up-to-date and queries select from the most recently added rows, the current statistics will not have cardinality estimates for these new values.</span></span> <span data-ttu-id="2cfd2-271">Это может привести к неправильной оценке количества элементов и замедлить выполнение запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-271">This can result in inaccurate cardinality estimates and slow query performance.</span></span>  
  
 <span data-ttu-id="2cfd2-272">Например, запрос, который выполняет выборку из дат самых последних заказов на продажу, будет иметь неправильную оценку количества элементов, если статистика не обновлена и не содержит оценки количества элементов для дат самых последних заказов на продажу.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-272">For example, a query that selects from the most recent sales order dates will have inaccurate cardinality estimates if the statistics are not updated to include cardinality estimates for the most recent sales order dates.</span></span>  
  
### <a name="after-maintenance-operations"></a><span data-ttu-id="2cfd2-273">После операций обслуживания</span><span class="sxs-lookup"><span data-stu-id="2cfd2-273">After Maintenance Operations</span></span>  
 <span data-ttu-id="2cfd2-274">Обновление статистики рекомендуется после выполнения процедур обслуживания, которые изменяют распределение данных, таких как усечение таблицы или массовая вставка большого количества строк (в процентном отношении).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-274">Consider updating statistics after performing maintenance procedures that change the distribution of data, such as truncating a table or performing a bulk insert of a large percentage of the rows.</span></span> <span data-ttu-id="2cfd2-275">В будущем это может предотвратить задержки в обработке запросов, вызванные ожиданием автоматического обновления статистики.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-275">This can avoid future delays in query processing while queries wait for automatic statistics updates.</span></span>  
  
 <span data-ttu-id="2cfd2-276">Такие операции, как перестроение, дефрагментация и реорганизация индекса, не изменяют распределение данных,</span><span class="sxs-lookup"><span data-stu-id="2cfd2-276">Operations such as rebuilding, defragmenting, or reorganizing an index do not change the distribution of data.</span></span> <span data-ttu-id="2cfd2-277">и поэтому после выполнения операций ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG и ALTER INDEX REORGANIZE не нужно обновлять статистику.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-277">Therefore, you do not need to update statistics after performing ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG, or ALTER INDEX REORGANIZE operations.</span></span> <span data-ttu-id="2cfd2-278">Однако оптимизатор запросов обновляет статистику, когда выполняется перестроение индекса для таблицы или представления с помощью инструкции ALTER INDEX REBUILD или DBCC DBREINDEX. Такое обновление статистики является побочным эффектом повторного создания индекса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-278">The query optimizer updates statistics when you rebuild an index on a table or view with ALTER INDEX REBUILD or DBCC DBREINDEX, however; this statistics update is a byproduct of re-creating the index.</span></span> <span data-ttu-id="2cfd2-279">Оптимизатор запросов не обновляет статистику после операций DBCC INDEXDEFRAG и ALTER INDEX REORGANIZE.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-279">The query optimizer does not update statistics after DBCC INDEXDEFRAG or ALTER INDEX REORGANIZE operations.</span></span>  
  
##  <a name="queries-that-use-statistics-effectively"></a><a name="DesignStatistics"></a><span data-ttu-id="2cfd2-280">Запросы, которые эффективно используют статистику</span><span class="sxs-lookup"><span data-stu-id="2cfd2-280">Queries That Use Statistics Effectively</span></span>  
 <span data-ttu-id="2cfd2-281">Некоторые особенности реализации запросов, например использование локальных переменных и сложных выражений в предикате запроса, могут привести к созданию неоптимальных планов запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-281">Certain query implementations, such as local variables and complex expressions in the query predicate, can lead to suboptimal query plans.</span></span> <span data-ttu-id="2cfd2-282">Этого можно избежать, если следовать рекомендациям по конструированию запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-282">Following query design guidelines for using statistics effectively can help to avoid this.</span></span> <span data-ttu-id="2cfd2-283">Дополнительные сведения о предикатах запросов см. в разделе [Условие поиска (Transact-SQL)](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-283">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="2cfd2-284">Планы запросов можно усовершенствовать, если выполнить рекомендации по конструированию запросов. Они эффективно применяют статистику для улучшения *оценки количества элементов* для выражений, переменных и функций, используемых в предикатах запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-284">You can improve query plans by applying query design guidelines that use statistics effectively to improve *cardinality estimates* for expressions, variables, and functions used in query predicates.</span></span> <span data-ttu-id="2cfd2-285">Если оптимизатору запросов неизвестно значение выражения, переменной или функции, то он не может определить значение для уточняющего запроса в гистограмме и поэтому не может получить из гистограммы наилучшую оценку количества элементов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-285">When the query optimizer does not know the value of an expression, variable, or function, it does not know which value to lookup in the histogram and therefore cannot retrieve the best cardinality estimate from the histogram.</span></span> <span data-ttu-id="2cfd2-286">Вместо этого оптимизатор запросов выполняет оценку количества элементов на основании среднего числа строк на каждое уникальное значение для всех строк гистограммы, включенных в выборку.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-286">Instead, the query optimizer bases the cardinality estimate on the average number of rows per distinct value for all of the sampled rows in the histogram.</span></span> <span data-ttu-id="2cfd2-287">В результате оценка количества элементов оказывается неоптимальной и производительность запросов может снизиться.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-287">This leads to suboptimal cardinality estimates and can hurt query performance.</span></span>  
  
 <span data-ttu-id="2cfd2-288">Следующие рекомендации показывают, как составлять запросы, чтобы усовершенствовать планы запроса благодаря улучшению оценки количества элементов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-288">The following guidelines describe how to write queries to improve query plans by improving cardinality estimates.</span></span>  
  
### <a name="improving-cardinality-estimates-for-expressions"></a><span data-ttu-id="2cfd2-289">Улучшение оценки количества элементов для выражений</span><span class="sxs-lookup"><span data-stu-id="2cfd2-289">Improving Cardinality Estimates for Expressions</span></span>  
 <span data-ttu-id="2cfd2-290">Чтобы улучшить оценку количества элементов для выражений, выполните следующие рекомендации.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-290">To improve cardinality estimates for expressions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="2cfd2-291">По возможности упрощайте выражения, содержащие константы.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-291">Whenever possible, simplify expressions with constants in them.</span></span> <span data-ttu-id="2cfd2-292">Оптимизатор запросов не вычисляет все функции и выражения, содержащие константы, перед оценкой количества элементов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-292">The query optimizer does not evaluate all functions and expressions containing constants prior to determining cardinality estimates.</span></span> <span data-ttu-id="2cfd2-293">Например, следует упростить выражение ABS(`-100) to 100`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-293">For example, simplify the expression ABS(`-100) to 100`.</span></span>  
  
-   <span data-ttu-id="2cfd2-294">Если в выражении используется несколько переменных, рекомендуется создать вычисляемый столбец для выражения, а затем создать статистику или индекс по вычисляемому столбцу.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-294">If the expression uses multiple variables, consider creating a computed column for the expression and then create statistics or an index on the computed column.</span></span> <span data-ttu-id="2cfd2-295">Например, предикат запроса `WHERE PRICE + Tax > 100` может иметь лучшую оценку количества элементов, если создать вычисляемый столбец для выражения `Price + Tax`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-295">For example, the query predicate `WHERE PRICE + Tax > 100` might have a better cardinality estimate if you create a computed column for the expression `Price + Tax`.</span></span>  
  
### <a name="improving-cardinality-estimates-for-variables-and-functions"></a><span data-ttu-id="2cfd2-296">Улучшение оценки количества элементов для переменных и функций</span><span class="sxs-lookup"><span data-stu-id="2cfd2-296">Improving Cardinality Estimates for Variables and Functions</span></span>  
 <span data-ttu-id="2cfd2-297">Чтобы улучшить оценку количества элементов для переменных и функций, выполните следующие рекомендации.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-297">To improve the cardinality estimates for variables and functions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="2cfd2-298">Если в предикате запроса используется локальная переменная, рекомендуется переписать запрос так, чтобы вместо локальной переменной в нем использовался параметр.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-298">If the query predicate uses a local variable, consider rewriting the query to use a parameter instead of a local variable.</span></span> <span data-ttu-id="2cfd2-299">Значение локальной переменной неизвестно в момент, когда оптимизатор запросов создает план выполнения запросов.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-299">The value of a local variable is not known when the query optimizer creates the query execution plan.</span></span> <span data-ttu-id="2cfd2-300">Если в запросе используется параметр, то оптимизатор запросов использует оценку количества элементов для первого фактического значения параметра, передаваемого хранимой процедуре.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-300">When a query uses a parameter, the query optimizer uses the cardinality estimate for the first actual parameter value that is passed to the stored procedure.</span></span>  
  
-   <span data-ttu-id="2cfd2-301">Для хранения результатов функции с табличным значением с несколькими инструкциями рекомендуется использовать стандартную или временную таблицу.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-301">Consider using a standard table or temporary table to hold the results of multi-statement table-valued functions.</span></span> <span data-ttu-id="2cfd2-302">Оптимизатор запросов не создает статистику для функций с табличным значением с несколькими инструкциями.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-302">The query optimizer does not create statistics for multi-statement table-valued functions.</span></span> <span data-ttu-id="2cfd2-303">Такой подход позволяет оптимизатору запросов создавать статистику по столбцам таблицы и использовать их для создания улучшенного плана запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-303">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span>  
  
-   <span data-ttu-id="2cfd2-304">Вместо табличных переменных рекомендуется использовать стандартную или временную таблицу.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-304">Consider using a standard table or temporary table as a replacement for table variables.</span></span> <span data-ttu-id="2cfd2-305">Оптимизатор запросов не создает статистику для табличных переменных.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-305">The query optimizer does not create statistics for table variables.</span></span> <span data-ttu-id="2cfd2-306">Такой подход позволяет оптимизатору запросов создавать статистику по столбцам таблицы и использовать их для создания улучшенного плана запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-306">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span> <span data-ttu-id="2cfd2-307">При выборе между временной таблицей и табличной переменной следует учитывать, что табличные переменные, используемые в хранимых процедурах, вызывают меньше перекомпиляций хранимой процедуры, чем временные таблицы.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-307">There are tradeoffs in determining whether to use a temporary table or a table variable; Table variables used in stored procedures cause fewer recompilations of the stored procedure than temporary tables.</span></span> <span data-ttu-id="2cfd2-308">В зависимости от приложения использование временной таблицы вместо табличной переменной не обязательно приведет к повышению производительности.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-308">Depending on the application, using a temporary table instead of a table variable might not improve performance.</span></span>  
  
-   <span data-ttu-id="2cfd2-309">Если хранимая процедура содержит запрос, в котором используется переданный параметр, не следует изменять значение параметра в рамках хранимой процедуры до того, как он будет использоваться в запросе.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-309">If a stored procedure contains a query that uses a passed-in parameter, avoid changing the parameter value within the stored procedure before using it in the query.</span></span> <span data-ttu-id="2cfd2-310">Оценка количество элементов для запроса основывается на значение переданного параметра, а не на обновленном значении.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-310">The cardinality estimates for the query are based on the passed-in parameter value and not the updated value.</span></span> <span data-ttu-id="2cfd2-311">Чтобы исключить изменение значения параметра, можно переписать запрос так, чтобы использовать две хранимые процедуры.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-311">To avoid changing the parameter value, you can rewrite the query to use two stored procedures.</span></span>  
  
     <span data-ttu-id="2cfd2-312">Например, следующая хранимая процедура `Sales.GetRecentSales` изменяет значение параметра `@date` , если `@date is NULL`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-312">For example, the following stored procedure `Sales.GetRecentSales` changes the value of the parameter `@date` when `@date is NULL`.</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
     <span data-ttu-id="2cfd2-313">Если при первом вызове хранимой процедуры `Sales.GetRecentSales` для параметра `@date` передается значение NULL, то оптимизатор запросов выполнит компиляцию хранимой процедуры с оценкой количества элементов для `@date = NULL` , даже если при вызове предиката запроса не указывалось `@date = NULL`.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-313">If the first call to the stored procedure `Sales.GetRecentSales` passes a NULL for the `@date` parameter, the query optimizer will compile the stored procedure with the cardinality estimate for `@date = NULL` even though the query predicate is not called with `@date = NULL`.</span></span> <span data-ttu-id="2cfd2-314">Такая оценка количества элементов может значительно отличаться от количества строк в фактическом результате запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-314">This cardinality estimate might be significantly different than the number of rows in the actual query result.</span></span> <span data-ttu-id="2cfd2-315">В итоге оптимизатор запросов может выбрать неоптимальный план запроса.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-315">As a result, the query optimizer might choose a suboptimal query plan.</span></span> <span data-ttu-id="2cfd2-316">Чтобы избежать подобной ситуации, можно переписать хранимую процедуру, разбив ее на две процедуры следующим образом:</span><span class="sxs-lookup"><span data-stu-id="2cfd2-316">To help avoid this, you can rewrite the stored procedure into two procedures as follows:</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNullRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        EXEC Sales.GetNonNullRecentSales @date;  
    END  
    GO  
    IF OBJECT_ID ( 'Sales.GetNonNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNonNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNonNullRecentSales (@date datetime)  
    AS BEGIN  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
### <a name="improving-cardinality-estimates-with-query-hints"></a><span data-ttu-id="2cfd2-317">Улучшение оценки количества элементов с помощью указаний запросов</span><span class="sxs-lookup"><span data-stu-id="2cfd2-317">Improving Cardinality Estimates with Query Hints</span></span>  
 <span data-ttu-id="2cfd2-318">Чтобы улучшить оценку количества элементов для локальных переменных, можно использовать указания запросов OPTIMIZE FOR и OPTIMIZE FOR UNKNOWN с параметром RECOMPILE.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-318">To improve cardinality estimates for local variables, you can use the OPTIMIZE FOR or OPTIMIZE FOR UNKNOWN query hints with RECOMPILE.</span></span> <span data-ttu-id="2cfd2-319">Дополнительные сведения см. в разделе [Указания запросов (Transact-SQL)](/sql/t-sql/queries/hints-transact-sql-query).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-319">For more information, see [Query Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span></span>  
  
 <span data-ttu-id="2cfd2-320">Для некоторых приложений повторная компиляция запроса при каждом выполнении может занять слишком продолжительное время.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-320">For some applications, recompiling the query each time it executes might take too much time.</span></span> <span data-ttu-id="2cfd2-321">Указание запроса OPTIMIZE FOR может повысить производительность даже в случае, когда параметр RECOMPILE не используется.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-321">The OPTIMIZER FOR query hint can help even if you don't use the RECOMPILE option.</span></span> <span data-ttu-id="2cfd2-322">Например, можно добавить параметр OPTIMIZE FOR к хранимой процедуре Sales.GetRecentSales, чтобы указать определенную дату.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-322">For example, you could add an OPTIMIZER FOR option to the stored procedure Sales.GetRecentSales to specify a specific date.</span></span> <span data-ttu-id="2cfd2-323">В следующем примере параметр OPTIMIZE FOR добавляется к процедуре Sales.GetRecentSales.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-323">The following example adds the OPTIMIZE FOR option to the Sales.GetRecentSales procedure.</span></span>  
  
```sql
USE AdventureWorks2012;  
GO  
IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
    DROP PROCEDURE Sales.GetRecentSales;  
GO  
CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
AS BEGIN  
    IF @date is NULL  
        SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
    SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
    WHERE h.SalesOrderID = d.SalesOrderID  
    AND h.OrderDate > @date  
    OPTION ( OPTIMIZE FOR ( @date = '2004-05-01 00:00:00.000'))  
END;  
GO  
```  
  
### <a name="improving-cardinality-estimates-with-plan-guides"></a><span data-ttu-id="2cfd2-324">Улучшение оценки количества элементов с помощью структур плана</span><span class="sxs-lookup"><span data-stu-id="2cfd2-324">Improving Cardinality Estimates with Plan Guides</span></span>  
 <span data-ttu-id="2cfd2-325">Для некоторых приложений рекомендации по конструированию запросов могут не действовать, поскольку запрос невозможно изменить или указание запроса RECOMPILE может вызвать слишком много повторных компиляций.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-325">For some applications, query design guidelines might not apply because you cannot change the query or using the RECOMPILE query hint might be cause too many recompiles.</span></span> <span data-ttu-id="2cfd2-326">С помощью структур плана можно задавать другие указания, такие как USE PLAN, чтобы управлять работой запроса, пока идет согласование изменений приложения с поставщиком приложения.</span><span class="sxs-lookup"><span data-stu-id="2cfd2-326">You can use plan guides to specify other hints, such as USE PLAN, to control the behavior of the query while investigating application changes with the application vendor.</span></span> <span data-ttu-id="2cfd2-327">Дополнительные сведения о структурах планов см. в разделе [Руководства планов](../performance/plan-guides.md).</span><span class="sxs-lookup"><span data-stu-id="2cfd2-327">For more information about plan guides, see [Plan Guides](../performance/plan-guides.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2cfd2-328">См. также:</span><span class="sxs-lookup"><span data-stu-id="2cfd2-328">See Also</span></span>  
 <span data-ttu-id="2cfd2-329">[CREATE STATISTICS (Transact-SQL)](/sql/t-sql/statements/create-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2cfd2-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span></span>  
 <span data-ttu-id="2cfd2-330">[UPDATE STATISTICS (Transact-SQL)](/sql/t-sql/statements/update-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2cfd2-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span></span>  
 <span data-ttu-id="2cfd2-331">[sp_updatestats (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2cfd2-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span></span>  
 <span data-ttu-id="2cfd2-332">[DBCC SHOW_STATISTICS (Transact-SQL)](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2cfd2-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span></span>  
 <span data-ttu-id="2cfd2-333">[Параметры ALTER DATABASE SET (Transact-SQL)](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span><span class="sxs-lookup"><span data-stu-id="2cfd2-333">[ALTER DATABASE SET Options &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span></span>  
 <span data-ttu-id="2cfd2-334">[DROP STATISTICS (Transact-SQL)](/sql/t-sql/statements/drop-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2cfd2-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span></span>  
 <span data-ttu-id="2cfd2-335">[CREATE INDEX (Transact-SQL)](/sql/t-sql/statements/create-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2cfd2-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span></span>  
 <span data-ttu-id="2cfd2-336">[ALTER INDEX (Transact-SQL)](/sql/t-sql/statements/alter-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="2cfd2-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span></span>  
 [<span data-ttu-id="2cfd2-337">Создание отфильтрованных индексов</span><span class="sxs-lookup"><span data-stu-id="2cfd2-337">Create Filtered Indexes</span></span>](../indexes/create-filtered-indexes.md)  
