---
title: Занятие 6. Миграция базы данных с исходного компьютера на конечный компьютер в Azure | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: database-engine
ms.topic: conceptual
ms.assetid: d9134ade-7b03-4c5c-8ed3-3bc369a61691
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: b9af8a260493561f9728d1677b7667bd3f36cb46
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87666588"
---
# <a name="lesson-6-migrate-a-database-from-a-source-machine-on-premises-to-a-destination-machine-in-azure"></a>Занятие 6: Перенос базы данных с исходного локального компьютера на целевой компьютер в Azure
  В этом занятии предполагается, что у вас уже есть другой SQL Server, который может находиться на другом локальном компьютере или на виртуальной машине в Azure. Сведения о том, как создать виртуальную машину SQL Server в Azure, см. в статье [Подготовка виртуальной машины SQL Server в Azure](https://www.windowsazure.com/manage/windows/common-tasks/install-sql-server/). После подготовки SQL Server виртуальной машины в Azure убедитесь, что вы можете подключиться к экземпляру SQL Server на этой виртуальной машине с помощью SQL Server Management Studio на другом компьютере.  
  
 Для этого занятия также предполагается, что вы уже выполнили следующие шаги.  
  
-   У вас есть учетная запись хранения Azure.  
  
-   Вы создали контейнер в учетной записи хранения Azure.  
  
-   Создали политику в контейнере с правами на чтение, запись и перечисление. Создали ключ SAS.  
  
-   Создали учетные данные SQL Server на исходном компьютере.  
  
-   Вы уже создали целевую виртуальную машину SQL Server в Azure. Рекомендуется создать ее, выбрав образ платформы, содержащий SQL Server 2014.  
  
 Чтобы перенести базу данных из локальной SQL Server в другую виртуальную машину в Azure, выполните следующие действия.  
  
1.  На исходном компьютере (в этом учебнике это локальный компьютер) откройте окно запросов среды SQL Server Management Studio. Отсоедините базу данных, чтобы переместить ее на другой компьютер, выполнив следующие инструкции:  
  
    ```  
    -- Detach the database in the source machine   
    USE master  
    EXEC sp_detach_db 'TestDB1', 'true';  
    ```  
  
2.  Если требуется перенести базу данных на целевой компьютер, сначала его необходимо подготовить. Для этого необходимо создать на целевом компьютере учетные данные SQL Server. Если это зашифрованная база данных, необходимо также импортировать сертификат с исходного компьютера на целевой.  
  
    1.  Для создания учетных данных SQL Server на целевом компьютере выполните следующие действия.  
  
        1.  Подключитесь к целевому компьютеру с помощью среды SQL Server Management Studio, которая работает на исходном компьютере.  Или запустите среду SQL Server Management Studio непосредственно на целевом компьютере.  
  
        2.  На панели инструментов Стандартная выберите пункт **Создать запрос**.  
  
        3.  Скопируйте и вставьте следующий пример в окно запроса (при необходимости измените). Следующая инструкция создает SQL Server учетные данные для хранения сертификата общего доступа контейнера хранилища.  
  
            ```sql  
  
            USE master   
            GO   
            CREATE CREDENTIAL [http://teststorageaccnt.blob.core.windows.net/testcontainer]   
            WITH IDENTITY='SHARED ACCESS SIGNATURE',   
            SECRET = 'your SAS key'   
            GO  
  
            ```  
  
        4.  Чтобы увидеть все доступные учетные данные, можно выполнить следующую инструкцию в окне запроса:  
  
            ```sql  
            SELECT * from sys.credentials   
            ```  
  
        5.  После установления соединения с целевым сервером откройте окно запроса и выполните команду:  
  
            ```sql  
  
            -- Create a master key and a server certificate   
            USE master   
            GO   
            CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'MySQLKey01'; -- You may use a different password.   
            GO   
            CREATE CERTIFICATE MySQLCert   
            FROM FILE = 'C:\certs\MySQLCert.CER'   
            WITH PRIVATE KEY   
            (   
            FILE = 'C:\certs\MySQLPrivateKeyFile.PVK',   
            DECRYPTION BY PASSWORD = 'MySQLKey01'   
            );   
            GO  
  
            ```  
  
             После завершения этого шага сертификат шифрования, резервная копия которого была получена с исходного компьютера, будет импортирован на целевой компьютер. Далее можно присоединить файлы данных на целевом компьютере.  
  
    2.  Затем создайте базу данных с файлами данных и журналов, указывающими на существующие файлы в службе хранилища Azure, с помощью команды FOR ATTACH. В окне запроса введите следующую инструкцию:  
  
        ```sql  
  
        --Create a database on the destination server   
        CREATE DATABASE TestDB1onDest   
        ON   
        (NAME = TestDB1_data,   
            FILENAME = 'https://teststorageaccnt.blob.core.windows.net/testcontainer/TestDB1Data.mdf' )   
        LOG ON   
         (NAME = TestDB1_log,   
            FILENAME = 'https://teststorageaccnt.blob.core.windows.net/testcontainer/TestDB1Log.ldf')   
        FOR ATTACH   
        GO  
  
        ```  
  
    3.  В обозревателе объектов щелкните «Базы данных» и щелкните правой кнопкой «Обновить». Вы должны увидеть созданную базу данных TestDB1onDest.  
  
    4.  Затем в окне запроса выполните следующую инструкцию:  
  
        ```sql  
  
        USE TestDB1onDest   
        SELECT * FROM Table1;   
        GO  
  
        ```  
  
         Должен быть приведен список всех данных, введенных на занятии 4.  
  
 Обратите внимание, что зашифрованная база данных была передана в другой вычислительный экземпляр без перемещения данных.  
  
 Чтобы создать базу данных с файлами данных и журналов, указывающими на существующие файлы в службе хранилища Azure с помощью SQL Server Management Studio пользовательского интерфейса, выполните следующие действия.  
  
1.  В **обозревателе объектов**подключитесь к экземпляру компонента SQL Server Database Engine и разверните его.  
  
2.  Щелкните правой кнопкой мыши элемент **Базы данных**, а затем выберите пункт **Создать базу данных**. Затем щелкните правой кнопкой мыши TestDB1. Щелкните «Задачи» и выберите команду «Отсоединить». В диалоговом окне отсоединения установите флажок «Удалить соединения». Нажмите кнопку **ОК**.  
  
3.  Подключитесь к целевому компьютеру, на котором установлен SQL Server 2014 CTP2 или более поздняя версия. Чтобы подготовить целевой компьютер, на нем необходимо создать учетные данные SQL Server, которые указывают на тот же контейнер, размещенный в TestDB1. Если вы собираетесь повторно присоединить базу данных на том же компьютере, то нет необходимости создавать другие учетные данные.  
  
4.  В **обозревателе объектов**щелкните правой кнопкой мыши **базы данных** и выберите команду **присоединить**.  
  
5.  Чтобы указать присоединяемую базу данных, в диалоговом окне **Присоединение баз данных** нажмите кнопку **Добавить**. В диалоговом окне « **Размещение файлов базы данных** » выполните следующие действия.  
  
     В качестве расположения файла данных базы данных введите: `https://teststorageaccnt.blob.core.windows.net/testcontainer/` .  
  
     В качестве имени файла введите: `TestDB1Data.mdf` .  
  
6.  Нажмите кнопку **ОК**.  
  
     ![SQL 14 CTP2](../tutorials/media/ss-was-tutlesson-6-7.gif "SQL 14 CTP2")  
  
 **Следующее занятие:**  
  
 [Занятие 7: Перенос файлов данных в службу хранилища Azure](../relational-databases/lesson-6-generate-activity-and-backup-log-using-file-snapshot-backup.md)  
  
