---
title: Работа с информацией об изменениях (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- change data [SQL Server]
- change data capture [SQL Server], query function scenarios
- change data capture [SQL Server], LSN boundaries
- change data capture [SQL Server], query functions
ms.assetid: 5346b852-1af8-4080-b278-12efb9b735eb
author: rothja
ms.author: jroth
ms.openlocfilehash: 018d5add95e5d0936f6055e1c6710b6a8ddabdab
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87665897"
---
# <a name="work-with-change-data-sql-server"></a><span data-ttu-id="b4736-102">Работа с информацией об изменениях (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="b4736-102">Work with Change Data (SQL Server)</span></span>
  <span data-ttu-id="b4736-103">Информация об изменениях сделана доступной для клиентов системы отслеживания измененных данных через функции с табличным значением.</span><span class="sxs-lookup"><span data-stu-id="b4736-103">Change data is made available to change data capture consumers through table-valued functions (TVFs).</span></span> <span data-ttu-id="b4736-104">Всем запросам этих функций требуются два параметра для определения диапазона регистрационных номеров транзакций в журнале, которые нужно учитывать при разработке возвращаемого результирующего набора.</span><span class="sxs-lookup"><span data-stu-id="b4736-104">All queries of these functions require two parameters to define the range of Log Sequence Numbers (LSNs) that are eligible for consideration when developing the returned result set.</span></span> <span data-ttu-id="b4736-105">Необходимо рассмотреть как верхнее, так и нижнее значения номеров LSN, ограничивающие этот интервал.</span><span class="sxs-lookup"><span data-stu-id="b4736-105">Both the upper and lower LSN values that bound the interval are considered to be included within the interval.</span></span>  
  
 <span data-ttu-id="b4736-106">Для помощи в определении соответствующих значений LSN имеется несколько функций, которые можно использовать в запросах с возвращающими табличное значение функциями.</span><span class="sxs-lookup"><span data-stu-id="b4736-106">Several functions are provided to help determine appropriate LSN values for use in querying a TVF.</span></span> <span data-ttu-id="b4736-107">Функция [sys.fn_cdc_get_min_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-min-lsn-transact-sql) возвращает наименьший номер LSN, связанный с периодом действия экземпляра системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="b4736-107">The function [sys.fn_cdc_get_min_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-min-lsn-transact-sql) returns the smallest LSN that is associated with a capture instance validity interval.</span></span> <span data-ttu-id="b4736-108">Периодом действия является интервал времени, в течение которого информация об изменениях остается доступной для экземпляров системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="b4736-108">The validity interval is the time interval for which change data is currently available for its capture instances.</span></span> <span data-ttu-id="b4736-109">Функция [sys.fn_cdc_get_max_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-max-lsn-transact-sql) возвращает наибольший номер LSN для периода действия.</span><span class="sxs-lookup"><span data-stu-id="b4736-109">The function [sys.fn_cdc_get_max_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-max-lsn-transact-sql) returns the largest LSN in the validity interval.</span></span> <span data-ttu-id="b4736-110">Функции [sys.fn_cdc_map_time_to_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-map-time-to-lsn-transact-sql) и [sys.fn_cdc_map_lsn_to_time](/sql/relational-databases/system-functions/sys-fn-cdc-map-lsn-to-time-transact-sql) помогают расположить значения номеров LSN на стандартной временной шкале.</span><span class="sxs-lookup"><span data-stu-id="b4736-110">The functions [sys.fn_cdc_map_time_to_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-map-time-to-lsn-transact-sql) and [sys.fn_cdc_map_lsn_to_time](/sql/relational-databases/system-functions/sys-fn-cdc-map-lsn-to-time-transact-sql) are available to help place LSN values on a conventional timeline.</span></span> <span data-ttu-id="b4736-111">Поскольку система отслеживания измененных данных использует закрытые интервалы запроса, иногда требуется создать следующий номер LSN, чтобы убедиться, что изменения не повторяются в последовательных окнах запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-111">Because change data capture uses closed query intervals, it is sometimes necessary to generate the next LSN value in a sequence to ensure that changes are not duplicated in consecutive query windows.</span></span> <span data-ttu-id="b4736-112">Функции [sys.fn_cdc_increment_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-increment-lsn-transact-sql) и [sys.fn_cdc_decrement_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-decrement-lsn-transact-sql) используются, если значению номера LSN необходима добавочная корректировка.</span><span class="sxs-lookup"><span data-stu-id="b4736-112">The functions [sys.fn_cdc_increment_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-increment-lsn-transact-sql) and [sys.fn_cdc_decrement_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-decrement-lsn-transact-sql) are useful when an incremental adjustment to an LSN value is required.</span></span>  
  
##  <a name="validating-lsn-boundaries"></a><a name="LSN"></a> <span data-ttu-id="b4736-113">Проверка границ номера LSN</span><span class="sxs-lookup"><span data-stu-id="b4736-113">Validating LSN Boundaries</span></span>  
 <span data-ttu-id="b4736-114">Рекомендуется проверять границы диапазона номера LSN перед использованием их в запросе возвращающей табличное значение функции.</span><span class="sxs-lookup"><span data-stu-id="b4736-114">We recommend validating the LSN boundaries that are to be used in a TVF query before their use.</span></span> <span data-ttu-id="b4736-115">Конечные точки, имеющие значения null или выходящие за границы периода действия экземпляра отслеживания, вызовут ошибку, которую возвратит возвращающая табличное значение функция отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="b4736-115">Null endpoints or endpoints that lie outside the validity interval for a capture instance will force an error to be returned by a change data capture TVF.</span></span>  
  
 <span data-ttu-id="b4736-116">Например, если параметр, с помощью которого определяется интервал запроса, является недопустимым или выходит за пределы допустимого диапазона значений, либо если он не является допустимым параметр фильтра строки, то для запроса возвращается следующая ошибка для всех изменений.</span><span class="sxs-lookup"><span data-stu-id="b4736-116">For example, the following error is returned for a query for all changes when a parameter that is used to define the query interval is not valid, or is out of range, or the row filter option is invalid.</span></span>  
  
 `Msg 313, Level 16, State 3, Line 1`  
  
 `An insufficient number of arguments were supplied for the procedure or function cdc.fn_cdc_get_all_changes_ ...`  
  
 <span data-ttu-id="b4736-117">Следующая ошибка возвращается для запроса `net changes`.</span><span class="sxs-lookup"><span data-stu-id="b4736-117">The corresponding error returned for a `net changes` query is the following:</span></span>  
  
 `Msg 313, Level 16, State 3, Line 1`  
  
 `An insufficient number of arguments were supplied for the procedure or function cdc.fn_cdc_get_net_changes_ ...`  
  
> [!NOTE]  
>  <span data-ttu-id="b4736-118">Установлено, что содержимое сообщения 313 неверно и поэтому не объясняет действительную причину ошибки.</span><span class="sxs-lookup"><span data-stu-id="b4736-118">It is recognized that the message for Msg 313 is misleading and does not convey the actual cause of the failure.</span></span> <span data-ttu-id="b4736-119">Это неверное применение сообщения объясняется неспособностью получить явную ошибку из  возвращающей табличное значение функции.</span><span class="sxs-lookup"><span data-stu-id="b4736-119">This awkward usage stems from the inability to raise an explicit error from within a TVF.</span></span> <span data-ttu-id="b4736-120">Тем не менее сочли, что лучше возвратить пусть даже неверное значение ошибки, чем возвратить пустой результат.</span><span class="sxs-lookup"><span data-stu-id="b4736-120">Nevertheless, the value of returning a recognizable, if inaccurate, error was deemed preferable to simply returning an empty result.</span></span> <span data-ttu-id="b4736-121">Ведь пустой результирующий набор невозможно отличить от допустимого запроса, возвращающего отсутствие изменений.</span><span class="sxs-lookup"><span data-stu-id="b4736-121">An empty result set would not be distinguishable from a valid query returning no changes.</span></span>  
  
 <span data-ttu-id="b4736-122">Ошибки авторизации возвращают ошибку при запросе всех изменений, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="b4736-122">Authorization failures will return failures when querying for all changes, as shown:</span></span>  
  
 `Msg 229, Level 14, State 5, Line 1`  
  
 `The SELECT permission was denied on the object 'fn_cdc_get_all_changes_...', database 'MyDB', schema 'cdc'.`  
  
 <span data-ttu-id="b4736-123">То же самое относится к запросам суммарных изменений.</span><span class="sxs-lookup"><span data-stu-id="b4736-123">The same is true when querying for net changes:</span></span>  
  
 `Msg 229, Level 14, State 5, Line 1`  
  
 `The SELECT permission was denied on the object fn_cdc_get_net_changes_...', database 'MyDB', schema 'cdc'.`  
  
 <span data-ttu-id="b4736-124">Представленный ниже шаблон «Перечисление суммарных изменений с помощью TRY CATCH» показывает, как перехватить эти известные ошибки возвращающих табличные значения функций и возвратить более понятные сведения об ошибке.</span><span class="sxs-lookup"><span data-stu-id="b4736-124">See the template Enumerate Net Changes Using TRY CATCH for a demonstration of how to intercept these known TVF errors and return more meaningful information about the failure.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="b4736-125">Чтобы найти шаблоны системы отслеживания измененных данных в среде SQL Server Management Studio, в меню **Вид** выберите **Обозреватель шаблонов**, разверните элемент **Шаблоны SQL Server** , затем папку **Система отслеживания измененных данных** .</span><span class="sxs-lookup"><span data-stu-id="b4736-125">To locate change data capture templates in SQL Server Management Studio, on the **View** menu, click **Template Explorer**, expand **SQL Server Templates** and then expand the **Change Data Capture** folder.</span></span>  
  
##  <a name="query-functions"></a><a name="Functions"></a> <span data-ttu-id="b4736-126">Функции запросов</span><span class="sxs-lookup"><span data-stu-id="b4736-126">Query Functions</span></span>  
 <span data-ttu-id="b4736-127">В зависимости от характеристик отслеживаемой исходной таблицы и конфигурации экземпляра системы отслеживания создается одна или две возвращающие табличное значение функции для выполнения запросов информации об изменениях.</span><span class="sxs-lookup"><span data-stu-id="b4736-127">Depending on the characteristics of the source table being tracked and the way in which its capture instance is configured, either one or two TVFs for querying change data are generated.</span></span>  
  
-   <span data-ttu-id="b4736-128">Функция [cdc.fn_cdc_get_all_changes_<экземпляр_отслеживания>](/sql/relational-databases/system-functions/cdc-fn-cdc-get-all-changes-capture-instance-transact-sql) возвращает все изменения, внесенные в течение указанного интервала.</span><span class="sxs-lookup"><span data-stu-id="b4736-128">The function [cdc.fn_cdc_get_all_changes_<capture_instance>](/sql/relational-databases/system-functions/cdc-fn-cdc-get-all-changes-capture-instance-transact-sql) returns all changes that occurred for the specified interval.</span></span> <span data-ttu-id="b4736-129">Эта функция создается всегда.</span><span class="sxs-lookup"><span data-stu-id="b4736-129">This function is always generated.</span></span> <span data-ttu-id="b4736-130">Записи всегда возвращаются отсортированными, вначале по номеру LSN зафиксированной транзакции изменения, затем по порядковому значению изменения в его транзакции.</span><span class="sxs-lookup"><span data-stu-id="b4736-130">Entries are always returned sorted, first by the transaction commit LSN of the change, and then by a value that sequences the change within its transaction.</span></span> <span data-ttu-id="b4736-131">В зависимости от выбранного параметра фильтра строки возвращается обновленная строка (параметр фильтра строки «all») или новое и старое значения обновленной строки (параметр фильтра строки «all update old»).</span><span class="sxs-lookup"><span data-stu-id="b4736-131">Depending on the row filter option chosen, either the final row is returned on update (row filter option "all") or both the new and old values are returned on update (row filter option "all update old"').</span></span>  
  
-   <span data-ttu-id="b4736-132">Функция [cdc.fn_cdc_get_net_changes_<экземпляр_отслеживания>](/sql/relational-databases/system-functions/cdc-fn-cdc-get-net-changes-capture-instance-transact-sql) создается, если параметр @supports_net_changes имеет значение 1, когда включена исходная таблица.</span><span class="sxs-lookup"><span data-stu-id="b4736-132">The function [cdc.fn_cdc_get_net_changes_<capture_instance>](/sql/relational-databases/system-functions/cdc-fn-cdc-get-net-changes-capture-instance-transact-sql) is generated when the parameter @supports_net_changes is set to 1 when the source table is enabled.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="b4736-133">Этот параметр поддерживается, только если в исходной таблице определен первичный ключ либо параметр @index_name использовался для идентификации уникального индекса.</span><span class="sxs-lookup"><span data-stu-id="b4736-133">This option is only supported if the source table has a defined primary key or if the parameter @index_name has been used to identify a unique index.</span></span>  
  
     <span data-ttu-id="b4736-134">Функция **netchanges** возвращает одно изменение на каждую измененную строку исходной таблицы.</span><span class="sxs-lookup"><span data-stu-id="b4736-134">The **netchanges** function returns one change per modified source table row.</span></span> <span data-ttu-id="b4736-135">Если в течение интервала запроса для строки было зарегистрировано несколько изменений, то значения столбцов будут отражать конечное содержимое строки.</span><span class="sxs-lookup"><span data-stu-id="b4736-135">If more than one change is logged for the row during the specified interval, the column values will reflect the final contents of the row.</span></span> <span data-ttu-id="b4736-136">Чтобы правильно определить операцию, необходимую для обновления целевой среды, возвращающая табличное значение функция должна учитывать как начальную, так и конечную операции со строкой в течение интервала запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-136">To correctly identify the operation that is necessary to update the target environment, the TVF must consider both the initial operation on the row during the interval and the final operation on the row.</span></span> <span data-ttu-id="b4736-137">При указании параметра фильтра строк «all» запрос `net changes` будет возвращать операции вставки, удаления или обновления (новые значения).</span><span class="sxs-lookup"><span data-stu-id="b4736-137">When the row filter option 'all' is specified, the operations that are returned by a `net changes` query will either be insert, delete, or update (new values).</span></span> <span data-ttu-id="b4736-138">Обратите внимание, что этот параметр всегда возвращает значение маски обновления как значение NULL, потому что вычисление статистической маски требует значительных затрат.</span><span class="sxs-lookup"><span data-stu-id="b4736-138">This option always returns the update mask as null because there is a cost associated with computing an aggregate mask.</span></span> <span data-ttu-id="b4736-139">Если требуется статистическая маска, отражающая все изменения строки, используется параметр «all with mask».</span><span class="sxs-lookup"><span data-stu-id="b4736-139">If you require an aggregate mask that reflects all changes to a row, use the 'all with mask' option.</span></span> <span data-ttu-id="b4736-140">Если для последующей обработки не требуется разделения операций вставки и обновления, то используется параметр «all with merge».</span><span class="sxs-lookup"><span data-stu-id="b4736-140">If downstream processing does not require inserts and updates to be distinguished, use the 'all with merge' option.</span></span> <span data-ttu-id="b4736-141">В этом случае будут присутствовать только два значения операции: 1— для операции удаления и 5 — для операций вставки и обновления.</span><span class="sxs-lookup"><span data-stu-id="b4736-141">In this case, the operation value will only take on two values: 1 for delete and 5 for an operation that could be either an insert or an update.</span></span> <span data-ttu-id="b4736-142">Этот параметр отключает дополнительные вычисления, позволяющие определить тип производной операции: операция вставки или обновления. Если в таком различении нет необходимости, то использование этого параметра может увеличить производительность.</span><span class="sxs-lookup"><span data-stu-id="b4736-142">This option eliminates the additional processing needed to determine whether the derived operation should be an insert or an update, and can improve the performance of the query when this differentiation is not necessary.</span></span>  
  
 <span data-ttu-id="b4736-143">Маска обновления, возвращаемая функцией запроса — это компактное представление всех изменений столбцов, связанных со строкой информации об изменениях.</span><span class="sxs-lookup"><span data-stu-id="b4736-143">The update mask that is returned from a query function is a compact representation that identifies all columns that changed in a row of change data.</span></span> <span data-ttu-id="b4736-144">Обычно такие данные нужны только для небольшого подмножества отслеживаемых столбцов.</span><span class="sxs-lookup"><span data-stu-id="b4736-144">Typically, this information is only required for a small subset of the captured columns.</span></span> <span data-ttu-id="b4736-145">Имеются функции, способные помочь при извлечении информации из маски в форме, которая напрямую может использоваться приложениями.</span><span class="sxs-lookup"><span data-stu-id="b4736-145">Functions are available to assist in extracting information from the mask in a form that is more directly usable by applications.</span></span> <span data-ttu-id="b4736-146">Функция [sys.fn_cdc_get_column_ordinal](/sql/relational-databases/system-functions/sys-fn-cdc-get-column-ordinal-transact-sql) возвращает порядковый номер именованного столбца для данного экземпляра системы отслеживания. Функция [sys.fn_cdc_is_bit_set](/sql/relational-databases/system-functions/sys-fn-cdc-is-bit-set-transact-sql) возвращает четность бита в предоставленной маске на основе переданного функцией порядкового номера.</span><span class="sxs-lookup"><span data-stu-id="b4736-146">The function [sys.fn_cdc_get_column_ordinal](/sql/relational-databases/system-functions/sys-fn-cdc-get-column-ordinal-transact-sql) returns the ordinal position of a named column for a given capture instance, whereas the function [sys.fn_cdc_is_bit_set](/sql/relational-databases/system-functions/sys-fn-cdc-is-bit-set-transact-sql) returns the parity of the bit in the provided mask based on the ordinal that was passed in the function call.</span></span> <span data-ttu-id="b4736-147">Совместное использование этих двух функций позволяет эффективно извлекать информацию из маски обновления и возвращать ее в информации об изменениях.</span><span class="sxs-lookup"><span data-stu-id="b4736-147">Together, these two functions allow information from the update mask to be efficiently extracted and returned with the request for change data.</span></span> <span data-ttu-id="b4736-148">См. представленный ниже шаблон «Перечисление суммарных изменений с помощью параметра "All With Mask"», в котором показано использование этих функций.</span><span class="sxs-lookup"><span data-stu-id="b4736-148">See the template Enumerate Net Changes Using All With Mask for a demonstration of how these functions are used.</span></span>  
  
##  <a name="query-function-scenarios"></a><a name="Scenarios"></a> <span data-ttu-id="b4736-149">Сценарий функции запроса</span><span class="sxs-lookup"><span data-stu-id="b4736-149">Query Function Scenarios</span></span>  
 <span data-ttu-id="b4736-150">В следующем разделе описан типичный сценарий запроса сведений системы отслеживания измененных данных с использованием функций запроса cdc.fn_cdc_get_all_changes_<экземпляр_отслеживания> и cdc.fn_cdc_get_net_changes_<экземпляр_отслеживания>.</span><span class="sxs-lookup"><span data-stu-id="b4736-150">The following sections describe common scenarios for querying change data capture data by using the query functions cdc.fn_cdc_get_all_changes_<capture_instance> and cdc.fn_cdc_get_net_changes_<capture_instance>.</span></span>  
  
### <a name="querying-for-all-changes-within-the-capture-instance-validity-interval"></a><span data-ttu-id="b4736-151">Выполнение запроса для получения всех изменений в течение периода действия экземпляра системы отслеживания</span><span class="sxs-lookup"><span data-stu-id="b4736-151">Querying for All Changes Within the Capture Instance Validity Interval</span></span>  
 <span data-ttu-id="b4736-152">Наиболее простым запросом информации об изменениях является запрос, который возвращает всю текущую информацию об изменениях за период действия экземпляра системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="b4736-152">The most straightforward request for change data is one that returns all of the current change data in a capture instance's validity interval.</span></span> <span data-ttu-id="b4736-153">Чтобы выполнить такой запрос, вначале определите нижнюю и верхнюю границу номера LSN периода действия.</span><span class="sxs-lookup"><span data-stu-id="b4736-153">To make this request, first determine the lower and upper LSN boundaries of the validity interval.</span></span> <span data-ttu-id="b4736-154">Затем с помощью этих значений определите параметры @from_lsn и @to_lsn, передаваемые функции запроса cdc.fn_cdc_get_all_changes_<экземпляр_отслеживания> или cdc.fn_cdc_get_net_changes_<экземпляр_отслеживания>.</span><span class="sxs-lookup"><span data-stu-id="b4736-154">Then, use these values to identify the parameters @from_lsn and @to_lsn passed to the query function cdc.fn_cdc_get_all_changes_<capture_instance> or cdc.fn_cdc_get_net_changes_<capture_instance>.</span></span> <span data-ttu-id="b4736-155">Для получения нижней границы воспользуйтесь функцией [sys.fn_cdc_get_min_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-min-lsn-transact-sql) , для получения верхней границы — функцией [sys.fn_cdc_get_max_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-max-lsn-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="b4736-155">Use the function [sys.fn_cdc_get_min_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-min-lsn-transact-sql) to obtain the lower bound, and [sys.fn_cdc_get_max_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-max-lsn-transact-sql) to obtain the upper bound.</span></span> <span data-ttu-id="b4736-156">Образец кода для запроса всех текущих действительных изменений с помощью помощи функции запроса cdc.fn_cdc_get_all_changes_<экземпляр_отслеживания> см. в шаблоне «Перечисление всех изменений для действительного диапазона».</span><span class="sxs-lookup"><span data-stu-id="b4736-156">See the template Enumerate All Changes for the Valid Range for sample code to query for all current valid changes by using the query function cdc.fn_cdc_get_all_changes_<capture_instance>.</span></span> <span data-ttu-id="b4736-157">См. шаблон «Перечисление суммарных изменений для действительного диапазона», в котором демонстрируется подобный пример использования функции cdc.fn_cdc_get_net_changes_<экземпляр_отслеживания>.</span><span class="sxs-lookup"><span data-stu-id="b4736-157">See the template Enumerate Net Changes for the Valid Range for a similar example of using the function cdc.fn_cdc_get_net_changes_<capture_instance>.</span></span>  
  
### <a name="querying-for-all-new-changes-since-the-last-set-of-changes"></a><span data-ttu-id="b4736-158">Выполнение запроса для получения всех новых изменений со времени последнего набора изменений</span><span class="sxs-lookup"><span data-stu-id="b4736-158">Querying for All New Changes Since the Last Set of Changes</span></span>  
 <span data-ttu-id="b4736-159">Для типичных приложений выполнение запросов для получения информации об изменениях будет бесконечным процессом, выполняющим периодические запросы всех изменений, внесенных со времени последнего запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-159">For typical applications, querying for change data will be an ongoing process, making periodic requests for all of the changes that occurred since the last request.</span></span> <span data-ttu-id="b4736-160">Для таких запросов можно с помощью функции [sys.fn_cdc_increment_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-increment-lsn-transact-sql) получать нижнюю границу текущего запроса из верхней границы предыдущего запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-160">For such queries, you can use the function [sys.fn_cdc_increment_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-increment-lsn-transact-sql) to derive the lower bound of the current query from the upper bound of the previous query.</span></span> <span data-ttu-id="b4736-161">Этот метод гарантирует, что строки не повторяются, поскольку интервал запроса рассматривается как замкнутый интервал (интервал, в который включены обе конечные точки).</span><span class="sxs-lookup"><span data-stu-id="b4736-161">This method ensures that no rows are repeated because the query interval is always treated as a closed interval where both end-points are included in the interval.</span></span> <span data-ttu-id="b4736-162">Затем с помощью функции [sys.fn_cdc_get_max_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-max-lsn-transact-sql) получите верхнюю конечную точку интервала нового запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-162">Then, use the function [sys.fn_cdc_get_max_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-max-lsn-transact-sql) to obtain the high end-point for the new request interval.</span></span> <span data-ttu-id="b4736-163">См. шаблон «Перечисление всех изменений со времени предыдущего запроса», в котором демонстрируется образец кода для систематического перемещения окна запроса для получения всех изменений со времени последнего запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-163">See the template Enumerate All Changes Since Previous Request for sample code to systematically move the query window to obtain all changes since the last request.</span></span>  
  
### <a name="querying-for-all-new-changes-up-until-now"></a><span data-ttu-id="b4736-164">Запрос всех новых изменений до настоящего момента</span><span class="sxs-lookup"><span data-stu-id="b4736-164">Querying for all New Changes Up Until Now</span></span>  
 <span data-ttu-id="b4736-165">Типичным ограничением, которое накладывается на изменения, возвращаемые функцией запроса, является включение только изменений, которые были внесены между предыдущим запросом до текущих даты и времени.</span><span class="sxs-lookup"><span data-stu-id="b4736-165">A typical constraint that is placed on the changes returned by a query function is to include only the changes that occurred between the previous request until the current date and time.</span></span> <span data-ttu-id="b4736-166">Для такого запроса примените функцию sys.fn_cdc_increment_lsn к значению @from_lsn, с помощью которого определялась нижняя граница в предыдущем запросе.</span><span class="sxs-lookup"><span data-stu-id="b4736-166">For this query, apply the function sys.fn_cdc_increment_lsn to the @from_lsn value that was used in the previous request to determine the lower bound.</span></span> <span data-ttu-id="b4736-167">Поскольку верхняя граница на интервале времени выражается как момент времени, она может быть преобразована в значение номера LSN до его использования функцией запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-167">Because the upper bound on the time interval is expressed as a specific point in time, it must be converted to an LSN value before it can be used by a query function.</span></span> <span data-ttu-id="b4736-168">Перед преобразованием значения типа данных datetime в соответствующее значение номера LSN необходимо убедиться, чтобы процесс отслеживания обработал все изменения, зафиксированные до заданной верхней границы.</span><span class="sxs-lookup"><span data-stu-id="b4736-168">Before the datetime value can be converted to a corresponding LSN value, you must ensure that the capture process has processed all changes that were committed through the specified upper bound.</span></span> <span data-ttu-id="b4736-169">Это необходимо для того, чтобы гарантировать распространение всех соответствующих изменений в таблицу изменений.</span><span class="sxs-lookup"><span data-stu-id="b4736-169">This is required to ensure that all the qualifying changes have been propagated to the change table.</span></span> <span data-ttu-id="b4736-170">Одним из способов сделать это является структурирование цикла ожидания, который периодически проверяет, не превышено ли заданное время завершения интервала запроса текущим зафиксированным номером LSN, максимальным по всем таблицам изменений базы данных.</span><span class="sxs-lookup"><span data-stu-id="b4736-170">One way to do this is to structure a wait loop that periodically checks to see if the current maximum commit lsn recorded for any database change table exceeds the desired end time of the request interval.</span></span>  
  
 <span data-ttu-id="b4736-171">После того как в цикле задержки будет установлено, что процесс отслеживания уже обработал все релевантные записи журнала, определите с помощью [sys.fn_cdc_map_time_to_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-map-time-to-lsn-transact-sql) новую верхнюю конечную точку, выражаемую как значение номера LSN.</span><span class="sxs-lookup"><span data-stu-id="b4736-171">After the delay loop verifies that the capture process has already processed all the relevant log entries, use the function [sys.fn_cdc_map_time_to_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-map-time-to-lsn-transact-sql) to determine the new high end-point expressed as an LSN value.</span></span> <span data-ttu-id="b4736-172">Чтобы гарантировать получение всех записей, зафиксированных до указанного времени, вызовите функцию sys.fn_cdc_map_time_to_lsn с параметром «largest less than or equal» (самое большое значение, меньше или равно).</span><span class="sxs-lookup"><span data-stu-id="b4736-172">To ensure that all entries that were committed through the specified time are retrieved, call the function sys.fn_cdc_map_time_to_lsn, and use the option 'largest less than or equal'.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="b4736-173">В периоды отсутствия активности в таблицу cdc.lsn_time_mapping добавляется фиктивная запись, чтобы отметить тот факт, что процесс отслеживания обработал изменения вплоть до данного времени фиксации.</span><span class="sxs-lookup"><span data-stu-id="b4736-173">In periods of inactivity, a dummy entry is added to the table cdc.lsn_time_mapping to mark the fact that the capture process has processed the changes up to a given commit time.</span></span> <span data-ttu-id="b4736-174">Это позволяет избежать впечатления, будто процесс отслеживания задержался, если для процесса просто нет недавних изменений.</span><span class="sxs-lookup"><span data-stu-id="b4736-174">This prevents it from appearing that the capture process has fallen behind when there are simply no recent changes to process.</span></span>  
  
 <span data-ttu-id="b4736-175">Шаблон «Перечисление всех изменений вплоть до настоящего момента» демонстрирует, как используется предыдущая стратегия для запроса информации об изменениях.</span><span class="sxs-lookup"><span data-stu-id="b4736-175">The template Enumerate All Changes Up Until Now demonstrates how to use the previous strategy to query for change data.</span></span>  
  
### <a name="adding-a-commit-time-to-an-all-changes-result-set"></a><span data-ttu-id="b4736-176">Добавление времени фиксации к результирующему набору всех изменений</span><span class="sxs-lookup"><span data-stu-id="b4736-176">Adding a Commit Time to an All Changes Result Set</span></span>  
 <span data-ttu-id="b4736-177">Время фиксации каждой транзакции с соответствующей записью в таблице изменений базы данных доступно в таблице [cdc.lsn_time_mapping](/sql/relational-databases/system-tables/cdc-lsn-time-mapping-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="b4736-177">The commit time of each transaction with an associated entry in a database change table is available in the table [cdc.lsn_time_mapping](/sql/relational-databases/system-tables/cdc-lsn-time-mapping-transact-sql).</span></span> <span data-ttu-id="b4736-178">Соединяя значение __$start_lsn, возвращаемое в запросе для всех изменений, со значением start_lsn записи таблицы cdc.lsn_time_mapping, можно возвратить tran_end_time вместе с информвцией об изменениях для отметки изменения временем фиксации транзакции в источнике.</span><span class="sxs-lookup"><span data-stu-id="b4736-178">By joining the __$start_lsn value returned in a request for all changes with the start_lsn value of a cdc.lsn_time_mapping table entry, you can return the tran_end_time along with the change data to stamp the change with the commit time of the transaction at the source.</span></span> <span data-ttu-id="b4736-179">Шаблон «Добавление времени фиксации к результирующему набору всех изменений» демонстрирует, как выполнить такое соединение.</span><span class="sxs-lookup"><span data-stu-id="b4736-179">The template Append Commit Time to All Changes Result Set demonstrates how to perform this join.</span></span>  
  
### <a name="joining-change-data-with-other-data-from-the-same-transaction"></a><span data-ttu-id="b4736-180">Соединение информации об изменениях с другими данными из той же транзакции</span><span class="sxs-lookup"><span data-stu-id="b4736-180">Joining Change Data with Other Data from the Same Transaction</span></span>  
 <span data-ttu-id="b4736-181">Иногда имеет смысл соединить информацию об изменениях с другими данными, касающимися транзакции, если она зафиксирована на источнике.</span><span class="sxs-lookup"><span data-stu-id="b4736-181">Occasionally, it is useful to join change data with other information gathered about the transaction when it committed at the source.</span></span> <span data-ttu-id="b4736-182">Из столбца tran_begin_lsn в таблице cdc.lsn_time_mapping передается информация, необходимая для выполнения такого соединения.</span><span class="sxs-lookup"><span data-stu-id="b4736-182">The tran_begin_lsn column in the table cdc.lsn_time_mapping provides the information needed to perform such a join.</span></span> <span data-ttu-id="b4736-183">Когда происходит обновление источника, значение database_transaction_begin_lsn из системного динамического представления [sys.dm_tran_database_transactions](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql) должно быть сохранено вместе со всеми другими данными, соединяемыми с информацией об изменениях.</span><span class="sxs-lookup"><span data-stu-id="b4736-183">When the update of the source occurs, the value for database_transaction_begin_lsn from the system dynamic view [sys.dm_tran_database_transactions](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql) must be saved along with any other information to be joined with the change data.</span></span> <span data-ttu-id="b4736-184">Функция fn_convertnumericlsntobinary используется для сравнения значений database_transaction_begin_lsn и tran_begin_lsn.</span><span class="sxs-lookup"><span data-stu-id="b4736-184">Use the function fn_convertnumericlsntobinary to compare the database_transaction_begin_lsn and tran_begin_lsn values.</span></span> <span data-ttu-id="b4736-185">Код для создания этой функции доступен в шаблоне «Создание функции fn_convertnumericlsntobinary».</span><span class="sxs-lookup"><span data-stu-id="b4736-185">The code to create this function is available in the template Create Function fn_convertnumericlsntobinary.</span></span> <span data-ttu-id="b4736-186">Шаблон «Возвращение всех изменений с помощью конкретного значения tran_begin_lsn» демонстрирует, как можно повлиять на соединение.</span><span class="sxs-lookup"><span data-stu-id="b4736-186">The template Return All Changes with a Given tran_begin_lsn demonstrates how to effect the join.</span></span>  
  
### <a name="querying-using-datetime-wrapper-functions"></a><span data-ttu-id="b4736-187">Выполнение запросов с помощью функций-оболочек DateTime</span><span class="sxs-lookup"><span data-stu-id="b4736-187">Querying Using Datetime Wrapper Functions</span></span>  
 <span data-ttu-id="b4736-188">В сценарии типичного приложения для выполнения запросов информации об изменениях периодически запрашиваются при помощи скользящего окна, ограниченного значениями типа datetime.</span><span class="sxs-lookup"><span data-stu-id="b4736-188">A typical application scenario for querying for change data is to periodically request change data by using a sliding window bounded by datetime values.</span></span> <span data-ttu-id="b4736-189">Для этого класса клиентов в системе отслеживания измененных данных предусмотрена хранимая процедура [sys.sp_cdc_generate_wrapper_function](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-generate-wrapper-function-transact-sql) , которая формирует скрипты создания пользовательских функций-оболочек для функций запроса системы отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="b4736-189">For this class of consumers, change data capture provides the stored procedure [sys.sp_cdc_generate_wrapper_function](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-generate-wrapper-function-transact-sql) that generates scripts to create custom wrapper functions for the change data capture query functions.</span></span> <span data-ttu-id="b4736-190">Эти пользовательские оболочки позволяют выражать интервал запроса как пару даты и времени.</span><span class="sxs-lookup"><span data-stu-id="b4736-190">These custom wrappers allow the query interval to be expressed as a datetime pair.</span></span>  
  
 <span data-ttu-id="b4736-191">Параметры вызова хранимой процедуры позволяют формировать оболочки для всех экземпляров системы отслеживания, к которым вызывающий имеет доступ, или только для указанного экземпляра системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="b4736-191">Calling options for the stored procedure allow for wrappers to be generated for all capture instances that the caller has access to, or only a specified capture instance.</span></span> <span data-ttu-id="b4736-192">Среди поддерживаемых параметров также есть возможность указывать, должна ли включаться верхняя конечная точка интервала отслеживания, какие из доступных отслеживаемых столбцов должны быть включены в результирующий набор и какие из включенных столбцов должны иметь соответствующие флаги обновления.</span><span class="sxs-lookup"><span data-stu-id="b4736-192">Supported options also include the ability to specify whether the high end-point of the capture interval should be open or closed, which of the available captured columns should be included in the result set and which of the included columns should have associated update flags.</span></span> <span data-ttu-id="b4736-193">Процедура возвращает результирующий набор с двумя столбцами: имя формируемой функции, производное от имени экземпляра системы отслеживания, и инструкция создания для хранимой процедуры оболочки.</span><span class="sxs-lookup"><span data-stu-id="b4736-193">The procedure returns a result set with two columns: the generated function name, which is derivable from the capture instance name, and the create statement for the wrapper stored procedure.</span></span> <span data-ttu-id="b4736-194">Также создается функция упаковки запроса всех изменений.</span><span class="sxs-lookup"><span data-stu-id="b4736-194">The function to wrap the all changes query is always generated.</span></span> <span data-ttu-id="b4736-195">Если во время создания экземпляра системы отслеживания параметр @supports_net_changes установлен, то формируется также функция-оболочка для функции суммарных изменений.</span><span class="sxs-lookup"><span data-stu-id="b4736-195">If the @supports_net_changes parameter was set when the capture instance was created, the function to wrap the net changes function is also generated.</span></span>  
  
 <span data-ttu-id="b4736-196">За вызов хранимой процедуры создания скрипта формирующей инструкции создания для хранимых процедур оболочки, а также за выполнение результирующих скриптов создания функций отвечает разработчик.</span><span class="sxs-lookup"><span data-stu-id="b4736-196">It is the responsibility of the application designer to call the script generation stored procedure to generate the create statements for the wrapper stored procedures, and to execute the resulting create scripts to create the functions.</span></span> <span data-ttu-id="b4736-197">Это не происходит автоматически при создании экземпляра системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="b4736-197">This does not occur automatically when a capture instance is created.</span></span>  
  
 <span data-ttu-id="b4736-198">Оболочками datetime владеет пользователь, и эти оболочки не создаются в схеме (используемой по умолчанию) вызывающего.</span><span class="sxs-lookup"><span data-stu-id="b4736-198">Datetime wrappers are owned by the user, and not are created in the default schema of the caller.</span></span> <span data-ttu-id="b4736-199">Сформированная функция подходит без каких-либо изменений для большинства пользователей.</span><span class="sxs-lookup"><span data-stu-id="b4736-199">The generated function is suitable without modification for most users.</span></span> <span data-ttu-id="b4736-200">Однако созданный скрипт всегда можно настроить дополнительно до создания функции.</span><span class="sxs-lookup"><span data-stu-id="b4736-200">However, further customization can always be applied to the generated script prior to creating the function.</span></span>  
  
 <span data-ttu-id="b4736-201">Именем функции-оболочки для запроса всех изменений является fn_all_changes_, за которым следует имя экземпляра системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="b4736-201">The name of the function to wrap the all changes query is fn_all_changes_ followed by the capture instance name.</span></span> <span data-ttu-id="b4736-202">Для оболочки суммарных изменений используется префикс fn_net_changes_.</span><span class="sxs-lookup"><span data-stu-id="b4736-202">The prefix that is used for the net changes wrapper is fn_net_changes_.</span></span> <span data-ttu-id="b4736-203">Обе функции принимают три аргумента, так же как и соответствующие им возвращающие табличные значения функции системы отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="b4736-203">Both functions take three arguments, just as their associated change data capture TVFs do.</span></span> <span data-ttu-id="b4736-204">Однако интервал запроса для оболочек ограничен двумя значениями datetime вместо двух значений LSN.</span><span class="sxs-lookup"><span data-stu-id="b4736-204">However, the query interval for the wrappers is bounded by two datetime values instead of than by two LSN values.</span></span> <span data-ttu-id="b4736-205">Параметр @row_filter_option для обоих наборов функций один и тот же.</span><span class="sxs-lookup"><span data-stu-id="b4736-205">The @row_filter_option parameter for both sets of functions are the same.</span></span>  
  
 <span data-ttu-id="b4736-206">Создаваемые функции-оболочки поддерживают следующее соглашение о временной шкале систематического прохода для системы отслеживания измененных данных. Предполагается, что параметр @end_time предыдущего интервала будет использоваться как параметр @start_time последующего интервала.</span><span class="sxs-lookup"><span data-stu-id="b4736-206">The generated wrapper functions support the following convention for systematically walking the change data capture timeline: It is expected that the @end_time parameter of the previous interval be used as the @start_time parameter of the subsequent interval.</span></span> <span data-ttu-id="b4736-207">Функция-оболочка обеспечивает сопоставление значений datetime со значениями номера LSN. Она также обеспечивает, что при соблюдении этого соглашения не будет потерь или повторений данных.</span><span class="sxs-lookup"><span data-stu-id="b4736-207">The wrapper function takes care of mapping the datetime values to LSN values and ensuring that no data is lost or repeated if this convention is followed.</span></span>  
  
 <span data-ttu-id="b4736-208">Оболочки можно создавать для поддержки закрытой или открытой верхней границы для заданного окна запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-208">The wrappers can be generated to support either a closed upper bound or an open upper bound on the specified query window.</span></span> <span data-ttu-id="b4736-209">Это означает, что вызывающий может указывать, будут ли включаться в интервал записи, для которых время фиксации совпадает с верхней границей интервала извлекаемых данных.</span><span class="sxs-lookup"><span data-stu-id="b4736-209">That is, the caller can specify whether entries having a commit time equal to the upper bound of the extraction interval are to be included within the interval.</span></span> <span data-ttu-id="b4736-210">По умолчанию верхняя граница включается в интервал.</span><span class="sxs-lookup"><span data-stu-id="b4736-210">By default, the upper bound is included.</span></span>  
  
 <span data-ttu-id="b4736-211">Если в качестве значения параметра @from_lsn или @to_lsn функции созданного запроса, возвращающей табличное значение, указано NULL, то она не завершается успешно, тогда как функции-оболочки datetime используют значение NULL, чтобы оболочки datetime могли возвратить все текущие изменения.</span><span class="sxs-lookup"><span data-stu-id="b4736-211">While the generated query TVFs fail if supplied a null value for either the @from_lsn value or the @to_lsn value, the datetime wrapper functions use null to allow the datetime wrappers to return all current changes.</span></span> <span data-ttu-id="b4736-212">Это означает, что если значение NULL передается оболочке datetime как нижняя конечная точка окна запроса, то нижняя конечная точка периода действия экземпляра системы отслеживания используется в базовой инструкции SELECT, которая применяется к функции запроса, возвращающей табличное значение.</span><span class="sxs-lookup"><span data-stu-id="b4736-212">That is, if null is passed as the low end-point of the query window to the datetime wrapper, the low end point of the capture instance validity interval is used in the underlying SELECT statement that is applied to the query TVF.</span></span> <span data-ttu-id="b4736-213">Аналогично, если NULL передается как верхняя конечная точка окна запроса, то верхняя конечная точка периода действия экземпляра системы отслеживания используется при выборе из функции запроса, возвращающей табличное значение.</span><span class="sxs-lookup"><span data-stu-id="b4736-213">Similarly, if null is passed as the high end-point of the query window, the high end-point of the capture instance validity interval is used when selecting from the query TVF.</span></span>  
  
 <span data-ttu-id="b4736-214">В результирующий набор, возвращаемый функцией-оболочкой, включаются все запрошенные столбцы, за которыми следует столбец операции, записанный как один или два символа для идентификации операции, связанной со строкой.</span><span class="sxs-lookup"><span data-stu-id="b4736-214">The result set returned by a wrapper function includes all the requested columns followed by an operation column, recoded as one or two characters to identify the operation that is associated with the row.</span></span> <span data-ttu-id="b4736-215">Флаги обновления при запросе возвращаются как битовые столбцы после кода операции в порядке, указанном параметром @update_flag_list.</span><span class="sxs-lookup"><span data-stu-id="b4736-215">If update flags have been requested, they appear as bit columns after the operation code, in the order specified in the @update_flag_list parameter.</span></span> <span data-ttu-id="b4736-216">Сведения о параметрах вызова для настройки формируемых оболочек datetime см. в разделе [sys.sp_cdc_generate_wrapper_function (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-generate-wrapper-function-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="b4736-216">For information about the calling options for customizing the generated datetime wrappers, see [sys.sp_cdc_generate_wrapper_function &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-generate-wrapper-function-transact-sql).</span></span>  
  
 <span data-ttu-id="b4736-217">Шаблон «Создание возвращающей табличное значение функции-оболочки с помощью флага обновления» показывает, как настроить в созданной функции-оболочке присоединение флага обновления для заданного столбца к результирующему набору запросом суммарных изменений.</span><span class="sxs-lookup"><span data-stu-id="b4736-217">The template Instantiate a Wrapper TVF With Update Flag shows how to customize a generated wrapper function to append an update flag for a specified column to the result set returned by a net changes query.</span></span> <span data-ttu-id="b4736-218">Шаблон «Возвращающие табличное значение функции-оболочки CDC для схемы» показывает, как создавать оболочки datetime для возвращающих табличное значение функций запроса для всех экземпляров системы отслеживания, созданных для исходных таблиц в схеме конкретной базы данных.</span><span class="sxs-lookup"><span data-stu-id="b4736-218">The template Instantiate CDC Wrapper TVFs for a Schema shows how to instantiate the Datetime Wrappers for the Query TVFs for all of the capture instances created for the source tables in a given database schema.</span></span>  
  
 <span data-ttu-id="b4736-219">Использование оболочки datetime для запроса информации об изменениях, см. на примере шаблона «Получение суммарных изменений с помощью оболочки с флагами обновления».</span><span class="sxs-lookup"><span data-stu-id="b4736-219">For an example that uses a datetime wrapper to query for change data, see the template Get Net Changes Using Wrapper With Update Flags.</span></span> <span data-ttu-id="b4736-220">Этот шаблон демонстрирует, как выполнить запрос для суммарных изменений, если в функции-оболочке настроено возвращение флагов обновления.</span><span class="sxs-lookup"><span data-stu-id="b4736-220">This template demonstrates how to query for net changes with a wrapper function when the wrapper is configured to return update flags.</span></span> <span data-ttu-id="b4736-221">Следует отметить, что параметр фильтра строки «all with mask» необходим для того, чтобы базовая функция запроса при обновлении возвращала маску обновления, отличную от NULL.</span><span class="sxs-lookup"><span data-stu-id="b4736-221">Note that the row filter option 'all with mask' is required for the underlying query function to return a non-null update mask on update.</span></span> <span data-ttu-id="b4736-222">Значения NULL передаются для нижней и верхней границ интервала datetime, чтобы функция использовала нижнюю и верхнюю конечные точки интервала действия для экземпляра системы отслеживания при выполнении базового запроса на основе LSN.</span><span class="sxs-lookup"><span data-stu-id="b4736-222">Null values are passed for both the lower and upper datetime interval boundaries to signal the function to use the low end point and the high end point of the validity interval for the capture instance when performing the underlying LSN based query.</span></span> <span data-ttu-id="b4736-223">Запрос возвращает одну строку для каждого изменения исходной строки, которое происходит в допустимом диапазоне для экземпляра системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="b4736-223">The query returns one row for each modification to a source row that occurred within the valid range for the capture instance.</span></span>  
  
### <a name="using-the-datetime-wrapper-functions-to-transition-between-capture-instances"></a><span data-ttu-id="b4736-224">Переход между экземплярами системы отслеживания с помощью функций-оболочек datetime</span><span class="sxs-lookup"><span data-stu-id="b4736-224">Using the Datetime Wrapper Functions to Transition Between Capture Instances</span></span>  
 <span data-ttu-id="b4736-225">Система отслеживание измененных данных поддерживает до двух экземпляров для одной отслеживаемой исходной таблицы.</span><span class="sxs-lookup"><span data-stu-id="b4736-225">Change data capture supports up to two capture instances for a single tracked source table.</span></span> <span data-ttu-id="b4736-226">Основным случаем применения этой возможности является согласование перехода между несколькими экземплярами системы отслеживания, если изменения языка описания данных DDL в исходной таблице расширяют набор доступных для отслеживания столбцов.</span><span class="sxs-lookup"><span data-stu-id="b4736-226">The principal use of this capability is to accommodate a transition between multiple capture instances when data definition language (DDL) changes to the source table expand the set of available columns for tracking.</span></span> <span data-ttu-id="b4736-227">При переходе к новому экземпляру системы отслеживания одним из способов защиты приложения более высокого уровня от изменений в именах базовых функций запроса является использование функции-оболочки для упаковки базового вызова.</span><span class="sxs-lookup"><span data-stu-id="b4736-227">When transitioning to a new capture instance, one way to protect higher application levels from changes in the names of the underlying query functions is to use a wrapper function to wrap the underlying call.</span></span> <span data-ttu-id="b4736-228">Затем следует обеспечить, чтобы имя функции-оболочки оставалось неизменным.</span><span class="sxs-lookup"><span data-stu-id="b4736-228">Then, ensure that the name of the wrapper function remains the same.</span></span> <span data-ttu-id="b4736-229">Когда должно произойти переключение, старая функция-оболочка должна быть удалена; при этом должна быть создана новая функция-оболочка с тем же именем, содержащая ссылку на новые функции запроса.</span><span class="sxs-lookup"><span data-stu-id="b4736-229">When the switch is to occur, the old wrapper function can be dropped, and a new one with the same name created that references the new query functions.</span></span> <span data-ttu-id="b4736-230">При первом изменении созданного скрипта создания функции-оболочки с тем же именем можно сделать переключение на новый экземпляр системы отслеживания, не затрагивая приложение более высокого уровня.</span><span class="sxs-lookup"><span data-stu-id="b4736-230">By first modifying the generated script to create a wrapper function of the same name, you can make the switch to a new capture instance without affecting higher application layers.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="b4736-231">См. также:</span><span class="sxs-lookup"><span data-stu-id="b4736-231">See Also</span></span>  
 <span data-ttu-id="b4736-232">[Отслеживание измененных данных (SQL Server)](../track-changes/track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="b4736-232">[Track Data Changes &#40;SQL Server&#41;](../track-changes/track-data-changes-sql-server.md) </span></span>  
 <span data-ttu-id="b4736-233">[О фиксации измененных данных (SQL Server)](../track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="b4736-233">[About Change Data Capture &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="b4736-234">[Включение и отключение отслеживания измененных данных (SQL Server)](../track-changes/enable-and-disable-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="b4736-234">[Enable and Disable Change Data Capture &#40;SQL Server&#41;](../track-changes/enable-and-disable-change-data-capture-sql-server.md) </span></span>  
 [<span data-ttu-id="b4736-235">Администрирование и наблюдение за отслеживанием измененных данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="b4736-235">Administer and Monitor Change Data Capture &#40;SQL Server&#41;</span></span>](../track-changes/administer-and-monitor-change-data-capture-sql-server.md)  
  
  
