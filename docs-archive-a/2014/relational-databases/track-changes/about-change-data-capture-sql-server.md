---
title: Об отслеживании измененных данных (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- change data capture [SQL Server], about
- change data capture [SQL Server]
- 22832 (Database Engine error)
ms.assetid: 7d8c4684-9eb1-4791-8c3b-0f0bb15d9634
author: rothja
ms.author: jroth
ms.openlocfilehash: cf8045ff45e7467a626bee85857ae8319f5d2649
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87665914"
---
# <a name="about-change-data-capture-sql-server"></a><span data-ttu-id="6c96f-102">Об отслеживании измененных данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="6c96f-102">About Change Data Capture (SQL Server)</span></span>
  <span data-ttu-id="6c96f-103">Система отслеживания измененных данных регистрирует операции вставки, обновления и удаления, которые применяются к таблице [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="6c96f-103">Change data capture records insert, update, and delete activity that is applied to a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] table.</span></span> <span data-ttu-id="6c96f-104">Тем самым обеспечивается доступ к подробностям этих изменений в легко обрабатываемом реляционном формате.</span><span class="sxs-lookup"><span data-stu-id="6c96f-104">This makes the details of the changes available in an easily consumed relational format.</span></span> <span data-ttu-id="6c96f-105">Сведения о столбцах и метаданных, которые требуются для применения изменений к целевой среде, отслеживаются в измененных строках и хранятся в таблицах изменений, отражающих структуру столбцов исходных таблиц.</span><span class="sxs-lookup"><span data-stu-id="6c96f-105">Column information and the metadata that is required to apply the changes to a target environment is captured for the modified rows and stored in change tables that mirror the column structure of the tracked source tables.</span></span> <span data-ttu-id="6c96f-106">Чтобы потребители данных могли систематически получать доступ к информации об изменениях, предоставляются функции с табличным значением.</span><span class="sxs-lookup"><span data-stu-id="6c96f-106">Table-valued functions are provided to allow systematic access to the change data by consumers.</span></span>  
  
 <span data-ttu-id="6c96f-107">Хорошим примером потребителя данных, для которого предназначена эта технология, является приложение для извлечения, преобразования и загрузки данных (ETL).</span><span class="sxs-lookup"><span data-stu-id="6c96f-107">A good example of a data consumer that is targeted by this technology is an extraction, transformation, and loading (ETL) application.</span></span> <span data-ttu-id="6c96f-108">ETL-приложение постепенно загружает информацию об изменениях из исходных таблиц [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в хранилище или витрину данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-108">An ETL application incrementally loads change data from [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] source tables to a data warehouse or data mart.</span></span> <span data-ttu-id="6c96f-109">Хотя представление исходных таблиц в хранилище данных должно отражать изменения в этих таблицах, использование технологии, которая обновляла бы реплики исходной таблицы, в данном случае не подходит.</span><span class="sxs-lookup"><span data-stu-id="6c96f-109">Although the representation of the source tables within the data warehouse must reflect changes in the source tables, an end-to-end technology that refreshes a replica of the source is not appropriate.</span></span> <span data-ttu-id="6c96f-110">Вместо этого необходим надежный поток информации об изменениях, структурированный таким образом, чтобы клиенты могли применить его к другим целевым предоставлениям данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-110">Instead, you need a reliable stream of change data that is structured so that consumers can apply it to dissimilar target representations of the data.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="6c96f-111">.</span><span class="sxs-lookup"><span data-stu-id="6c96f-111">change data capture provides this technology.</span></span>  
  
## <a name="change-data-capture-data-flow"></a><span data-ttu-id="6c96f-112">Поток данных системы отслеживания измененных данных</span><span class="sxs-lookup"><span data-stu-id="6c96f-112">Change Data Capture Data Flow</span></span>  
 <span data-ttu-id="6c96f-113">На следующем рисунке показан основной поток данных для системы отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-113">The following illustration shows the principal data flow for change data capture.</span></span>  
  
 <span data-ttu-id="6c96f-114">![Поток данных системы отслеживания измененных данных](../../database-engine/media/cdcdataflow.gif "Поток данных системы отслеживания измененных данных")</span><span class="sxs-lookup"><span data-stu-id="6c96f-114">![Change data capture data flow](../../database-engine/media/cdcdataflow.gif "Change data capture data flow")</span></span>  
  
 <span data-ttu-id="6c96f-115">Источником измененных данных для системы отслеживания является журнал транзакций [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="6c96f-115">The source of change data for change data capture is the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] transaction log.</span></span> <span data-ttu-id="6c96f-116">По мере того, как в исходных отслеживаемых таблицах выполняются операции вставки, обновления и удаления, в журнал добавляются записи, описывающие эти изменения.</span><span class="sxs-lookup"><span data-stu-id="6c96f-116">As inserts, updates, and deletes are applied to tracked source tables, entries that describe those changes are added to the log.</span></span> <span data-ttu-id="6c96f-117">Журнал служит входом для процесса отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-117">The log serves as input to the capture process.</span></span> <span data-ttu-id="6c96f-118">Процесс считывает журнал и добавляет данные изменений в таблицу изменений, связанную с отслеживаемой таблицей.</span><span class="sxs-lookup"><span data-stu-id="6c96f-118">This reads the log and adds information about changes to the tracked table's associated change table.</span></span> <span data-ttu-id="6c96f-119">Предусмотрены функции для перечисления изменений, появляющихся в таблицах изменений в заданном диапазоне, а также для возврата данных в виде отфильтрованного результирующего набора.</span><span class="sxs-lookup"><span data-stu-id="6c96f-119">Functions are provided to enumerate the changes that appear in the change tables over a specified range, returning the information in the form of a filtered result set.</span></span> <span data-ttu-id="6c96f-120">Отфильтрованный результирующий набор обычно используется процессом приложения для обновления представления источника во внешней среде.</span><span class="sxs-lookup"><span data-stu-id="6c96f-120">The filtered result set is typically used by an application process to update a representation of the source in some external environment.</span></span>  
  
## <a name="understanding-change-data-capture-and-the-capture-instance"></a><span data-ttu-id="6c96f-121">Основные сведения о системе отслеживания измененных данных и экземпляре системы отслеживания</span><span class="sxs-lookup"><span data-stu-id="6c96f-121">Understanding Change Data Capture and the Capture Instance</span></span>  
 <span data-ttu-id="6c96f-122">Прежде чем можно будет отслеживать изменения в отдельных таблицах базы данных, необходимо явно активировать систему отслеживания измененных данных в этой базе данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-122">Before changes to any individual tables within a database can be tracked, change data capture must be explicitly enabled for the database.</span></span> <span data-ttu-id="6c96f-123">Это делается с помощью хранимой процедуры [sys.sp_cdc_enable_db](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-enable-db-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="6c96f-123">This is done by using the stored procedure [sys.sp_cdc_enable_db](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-enable-db-transact-sql).</span></span> <span data-ttu-id="6c96f-124">После того как база данных будет активирована, с помощью хранимой процедуры [sys.sp_cdc_enable_table](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-enable-table-transact-sql)исходные таблицы можно определить как отслеживаемые.</span><span class="sxs-lookup"><span data-stu-id="6c96f-124">When the database is enabled, source tables can be identified as tracked tables by using the stored procedure [sys.sp_cdc_enable_table](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-enable-table-transact-sql).</span></span> <span data-ttu-id="6c96f-125">Если для таблицы активирована система отслеживания измененных данных, создается связанный экземпляр системы отслеживания изменений для распространения данных об изменениях в исходной таблице.</span><span class="sxs-lookup"><span data-stu-id="6c96f-125">When a table is enabled for change data capture, an associated capture instance is created to support the dissemination of the change data in the source table.</span></span> <span data-ttu-id="6c96f-126">Экземпляр системы отслеживания состоит из таблицы изменений и одной-двух функций запроса.</span><span class="sxs-lookup"><span data-stu-id="6c96f-126">The capture instance consists of a change table and up to two query functions.</span></span> <span data-ttu-id="6c96f-127">Метаданные, подробно описывающие подробности конфигурации экземпляра системы отслеживания, сохраняются в таблицах отслеживания измененных метаданных `cdc.change_tables`, `cdc.index_columns` и `cdc.captured_columns`.</span><span class="sxs-lookup"><span data-stu-id="6c96f-127">Metadata that describes the configuration details of the capture instance is retained in the change data capture metadata tables `cdc.change_tables`, `cdc.index_columns`, and `cdc.captured_columns`.</span></span> <span data-ttu-id="6c96f-128">Эти сведения можно получить с помощью хранимой процедуры [sys.sp_cdc_help_change_data_capture](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-change-data-capture-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="6c96f-128">This information can be retrieved by using the stored procedure [sys.sp_cdc_help_change_data_capture](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-change-data-capture-transact-sql).</span></span>  
  
 <span data-ttu-id="6c96f-129">Все объекты, связанные с экземпляром системы отслеживания, создаются в схеме системы отслеживания измененных данных для активированной базы данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-129">All objects that are associated with a capture instance are created in the change data capture schema of the enabled database.</span></span> <span data-ttu-id="6c96f-130">Именем экземпляра системы отслеживания должно быть допустимое имя объекта, уникальное для всех экземпляров системы отслеживания этой базы данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-130">The requirements for the capture instance name is that it be a valid object name, and that it be unique across the database capture instances.</span></span> <span data-ttu-id="6c96f-131">Имя по умолчанию — \<*schema name*_*table name*> для таблицы-источника.</span><span class="sxs-lookup"><span data-stu-id="6c96f-131">By default, the name is \<*schema name*_*table name*> of the source table.</span></span> <span data-ttu-id="6c96f-132">Связанная с ним таблица изменений именуется путем добавления ключевого слова `_CT` к имени экземпляра системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-132">Its associated change table is named by appending `_CT` to the capture instance name.</span></span> <span data-ttu-id="6c96f-133">Функция, которая используется для запроса всех изменений, именуется путем добавления к началу имени экземпляра системы отслеживания префикса `fn_cdc_get_all_changes_`.</span><span class="sxs-lookup"><span data-stu-id="6c96f-133">The function that is used to query for all changes is named by prepending `fn_cdc_get_all_changes_` to the capture instance name.</span></span> <span data-ttu-id="6c96f-134">Если экземпляр отслеживания настроен для поддержки `net changes` , то `net_changes` также создается функция запроса с именем, добавляемым в \*\*fn_cdc_get_net_changes \_ \*\* в качестве имени экземпляра отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-134">If the capture instance is configured to support `net changes`, the `net_changes` query function is also created and named by prepending **fn_cdc_get_net_changes\_** to the capture instance name.</span></span>  
  
## <a name="change-table"></a><span data-ttu-id="6c96f-135">Таблица изменений</span><span class="sxs-lookup"><span data-stu-id="6c96f-135">Change Table</span></span>  
 <span data-ttu-id="6c96f-136">Первые пять столбцов таблицы изменений для системы отслеживания измененных данных являются столбцами метаданных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-136">The first five columns of a change data capture change table are metadata columns.</span></span> <span data-ttu-id="6c96f-137">Они предоставляют дополнительные сведения, относящиеся к регистрируемому изменению.</span><span class="sxs-lookup"><span data-stu-id="6c96f-137">These provide additional information that is relevant to the recorded change.</span></span> <span data-ttu-id="6c96f-138">Остальные столбцы отражают опознанные отслеживаемые столбцы исходной таблицы по имени и типу.</span><span class="sxs-lookup"><span data-stu-id="6c96f-138">The remaining columns mirror the identified captured columns from the source table in name and, typically, in type.</span></span> <span data-ttu-id="6c96f-139">В этих столбцах хранятся данные отслеживаемых столбцов из исходной таблицы.</span><span class="sxs-lookup"><span data-stu-id="6c96f-139">These columns hold the captured column data that is gathered from the source table.</span></span>  
  
 <span data-ttu-id="6c96f-140">Каждая операция вставки или удаления, которая была выполнена в исходной таблице, отражается как одна строка в таблице изменений.</span><span class="sxs-lookup"><span data-stu-id="6c96f-140">Each insert or delete operation that is applied to a source table appears as a single row within the change table.</span></span> <span data-ttu-id="6c96f-141">Столбцы данных в строке, отражающей результаты операции вставки, содержат значения столбов после вставки.</span><span class="sxs-lookup"><span data-stu-id="6c96f-141">The data columns of the row that results from an insert operation contain the column values after the insert.</span></span> <span data-ttu-id="6c96f-142">Столбцы данных в строке, отражающей результаты операции удаления, содержат значения столбов перед удалением.</span><span class="sxs-lookup"><span data-stu-id="6c96f-142">The data columns of the row that results from a delete operation contain the column values before the delete.</span></span> <span data-ttu-id="6c96f-143">Операции обновления требуется одна строка для определения значений столбца перед обновлением, и еще одна строка — для значений столбца после обновления.</span><span class="sxs-lookup"><span data-stu-id="6c96f-143">An update operation requires one row entry to identify the column values before the update, and a second row entry to identify the column values after the update.</span></span>  
  
 <span data-ttu-id="6c96f-144">Каждая строка в таблице изменений содержит также дополнительные метаданные, позволяющие интерпретировать операции изменения.</span><span class="sxs-lookup"><span data-stu-id="6c96f-144">Each row in a change table also contains additional metadata to allow interpretation of the change activity.</span></span> <span data-ttu-id="6c96f-145">Столбец __$start_lsn определяет номер LSN фиксации, который был присвоен изменению.</span><span class="sxs-lookup"><span data-stu-id="6c96f-145">The column __$start_lsn identifies the commit log sequence number (LSN) that was assigned to the change.</span></span> <span data-ttu-id="6c96f-146">Зафиксированный номер LSN определяет как операции изменения, которые были проведены в рамках одной транзакции, так и порядок транзакций.</span><span class="sxs-lookup"><span data-stu-id="6c96f-146">The commit LSN both identifies changes that were committed within the same transaction, and orders those transactions.</span></span> <span data-ttu-id="6c96f-147">Столбец \_\_$seqval можно использовать для упорядочивания дополнительных изменений в этой транзакции.</span><span class="sxs-lookup"><span data-stu-id="6c96f-147">The column \_\_$seqval can be used to order more changes that occur in the same transaction.</span></span> <span data-ttu-id="6c96f-148">Столбец \_\_$operation регистрирует операцию, связанную с изменением: 1 = удаление, 2 = вставка, 3 = обновление (исходный образ), 4 = обновление (образ после операции).</span><span class="sxs-lookup"><span data-stu-id="6c96f-148">The column \_\_$operation records the operation that is associated with the change: 1 = delete, 2 = insert, 3 = update (before image), and 4 = update (after image).</span></span> <span data-ttu-id="6c96f-149">Столбец \_\_$update_mask — это переменная в виде битовой маски, в которой каждому отслеживаемому столбцу соответствует один бит.</span><span class="sxs-lookup"><span data-stu-id="6c96f-149">The column \_\_$update_mask is a variable bit mask with one defined bit for each captured column.</span></span> <span data-ttu-id="6c96f-150">Для записей операций вставки и удаления все биты в маске обновления всегда будут установленными.</span><span class="sxs-lookup"><span data-stu-id="6c96f-150">For insert and delete entries, the update mask will always have all bits set.</span></span> <span data-ttu-id="6c96f-151">У строк операций обновления будут установлены только биты, соответствующие измененным столбцам.</span><span class="sxs-lookup"><span data-stu-id="6c96f-151">Update rows, however, will only have those bits set that correspond to changed columns.</span></span>  
  
## <a name="change-data-capture-validity-interval-for-a-database"></a><span data-ttu-id="6c96f-152">Период действия системы отслеживания измененных данных в базе данных</span><span class="sxs-lookup"><span data-stu-id="6c96f-152">Change Data Capture Validity Interval for a Database</span></span>  
 <span data-ttu-id="6c96f-153">Период действия системы отслеживания измененных данных для базы данных — это время, в течение которого данные изменений доступны для экземпляров отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-153">The change data capture validity interval for a database is the time during which change data is available for capture instances.</span></span> <span data-ttu-id="6c96f-154">Период действия начинается с создания первого экземпляра отслеживания для таблицы базы данных и продолжается до настоящего времени.</span><span class="sxs-lookup"><span data-stu-id="6c96f-154">The validity interval begins when the first capture instance is created for a database table, and continues to the present time.</span></span>  
  
 <span data-ttu-id="6c96f-155">Данные, хранящиеся в таблицах изменений, будут неуправляемо расти, если периодически и систематически не усекать эти данные.</span><span class="sxs-lookup"><span data-stu-id="6c96f-155">Data that is deposited in change tables will grow unmanageably if you do not periodically and systematically prune the data.</span></span> <span data-ttu-id="6c96f-156">Процесс очистки системы отслеживания измененных данных отвечает за политику принудительной очистки данных по истечении срока их хранения.</span><span class="sxs-lookup"><span data-stu-id="6c96f-156">The change data capture cleanup process is responsible for enforcing the retention-based cleanup policy.</span></span> <span data-ttu-id="6c96f-157">Прежде всего он перемещает нижнюю конечную точку периода действия в соответствии с ограничениями по времени.</span><span class="sxs-lookup"><span data-stu-id="6c96f-157">First, it moves the low endpoint of the validity interval to satisfy the time restriction.</span></span> <span data-ttu-id="6c96f-158">Затем записи таблицы изменений, у которых истек срок действия, удаляются.</span><span class="sxs-lookup"><span data-stu-id="6c96f-158">Then, it removes expired change table entries.</span></span> <span data-ttu-id="6c96f-159">По умолчанию эти данные сохраняются три дня.</span><span class="sxs-lookup"><span data-stu-id="6c96f-159">By default, three days of data is retained.</span></span>  
  
 <span data-ttu-id="6c96f-160">В верхней конечной точке по мере того, как процесс отслеживания фиксирует каждый новый пакет информации об изменениях, новые записи добавляются к `cdc.lsn_time_mapping` для каждой транзакции, для которой имеются записи в таблице изменений.</span><span class="sxs-lookup"><span data-stu-id="6c96f-160">At the high end, as the capture process commits each new batch of change data, new entries are added to `cdc.lsn_time_mapping` for each transaction that has change table entries.</span></span> <span data-ttu-id="6c96f-161">В таблице сопоставлений сохраняются регистрационный номер транзакции в журнале и время фиксации транзакции (столбцы start_lsn и tran_end_time соответственно).</span><span class="sxs-lookup"><span data-stu-id="6c96f-161">Within the mapping table, both a commit Log Sequence Number (LSN) and a transaction commit time (columns start_lsn and tran_end_time, respectively) are retained.</span></span> <span data-ttu-id="6c96f-162">Максимальное значение номера LSN, обнаруженное в `cdc.lsn_time_mapping`, представляет верхнюю конечную точку диапазона периода действия.</span><span class="sxs-lookup"><span data-stu-id="6c96f-162">The maximum LSN value that is found in `cdc.lsn_time_mapping` represents the high water mark of the database validity window.</span></span> <span data-ttu-id="6c96f-163">Соответствующее ей время фиксации используется как базовое значение, из которого очистка данных по истечении срока хранения вычисляет новое значение нижней конечной точки.</span><span class="sxs-lookup"><span data-stu-id="6c96f-163">Its corresponding commit time is used as the base from which retention based cleanup computes a new low water mark.</span></span>  
  
 <span data-ttu-id="6c96f-164">Поскольку процесс отслеживания извлекает информацию об изменениях из журнала транзакций, имеется естественная задержка между временем, когда изменение фиксируется в исходной таблице, и временем, когда это изменение записывается в связанную таблицу изменений.</span><span class="sxs-lookup"><span data-stu-id="6c96f-164">Because the capture process extracts change data from the transaction log, there is a built in latency between the time that a change is committed to a source table and the time that the change appears within its associated change table.</span></span> <span data-ttu-id="6c96f-165">Хотя эта задержка обычно мала, важно помнить, что информация об изменениях недоступна, пока процесс отслеживания не обработает соответствующие записи журнала.</span><span class="sxs-lookup"><span data-stu-id="6c96f-165">While this latency is typically small, it is nevertheless important to remember that change data is not available until the capture process has processed the related log entries.</span></span>  
  
## <a name="change-data-capture-validity-interval-for-a-capture-instance"></a><span data-ttu-id="6c96f-166">Период действия системы отслеживания измененных данных для экземпляра отслеживания</span><span class="sxs-lookup"><span data-stu-id="6c96f-166">Change Data Capture Validity Interval for a Capture Instance</span></span>  
 <span data-ttu-id="6c96f-167">Хотя обычно периоды действия для базы данных и отдельного экземпляра отслеживания совпадают, иногда это бывает не так.</span><span class="sxs-lookup"><span data-stu-id="6c96f-167">Although it is common for the database validity interval and the validity interval of individual capture instance to coincide, this is not always true.</span></span> <span data-ttu-id="6c96f-168">Период действия экземпляра отслеживания начинается, когда процесс отслеживания распознает экземпляр отслеживания и начинает записывать связанные с ним изменения в таблицу изменений.</span><span class="sxs-lookup"><span data-stu-id="6c96f-168">The validity interval of the capture instance starts when the capture process recognizes the capture instance and starts to log associated changes to its change table.</span></span> <span data-ttu-id="6c96f-169">В результате, если экземпляры отслеживания создаются в разное время, каждый будет иметь свою нижнюю конечную точку.</span><span class="sxs-lookup"><span data-stu-id="6c96f-169">As a result, if capture instances are created at different times, each will initially have a different low endpoint.</span></span> <span data-ttu-id="6c96f-170">Столбец start_lsn результирующего набора, который возвращается функцией [sys.sp_cdc_help_change_data_capture](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-change-data-capture-transact-sql) , показывает текущую нижнюю конечную точку для каждого определенного экземпляра отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-170">The start_lsn column of the result set that is returned by [sys.sp_cdc_help_change_data_capture](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-change-data-capture-transact-sql) shows the current low endpoint for each defined capture instance.</span></span> <span data-ttu-id="6c96f-171">Когда процесс очистки очищает записи таблицы изменений, он корректирует значения start_lsn для всех экземпляров отслеживания, чтобы отразить новую нижнюю конечную точку для каждого доступного набора информации об изменениях.</span><span class="sxs-lookup"><span data-stu-id="6c96f-171">When the cleanup process cleans up change table entries, it adjusts the start_lsn values for all capture instances to reflect the new low water mark for available change data.</span></span> <span data-ttu-id="6c96f-172">Корректируются только те экземпляры отслеживания, текущие значения start_lsn которых меньше, чем новая нижняя конечная точка.</span><span class="sxs-lookup"><span data-stu-id="6c96f-172">Only those capture instances that have start_lsn values that are currently less than the new low water mark are adjusted.</span></span> <span data-ttu-id="6c96f-173">Со временем, если не создаются новые экземпляры отслеживания, периоды действия для всех отдельных экземпляров постепенно совпадают с периодом действия для базы данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-173">Over time, if no new capture instances are created, the validity intervals for all individual instances will tend to coincide with the database validity interval.</span></span>  
  
 <span data-ttu-id="6c96f-174">Период действия важен для потребителей данных об изменениях, поскольку интервал извлечения для запроса должен полностью покрываться периодом действия системы отслеживания измененных данных для экземпляра отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-174">The validity interval is important to consumers of change data because the extraction interval for a request must be fully covered by the current change data capture validity interval for the capture instance.</span></span> <span data-ttu-id="6c96f-175">Если нижняя конечная точка интервала извлечения перекрывает нижнюю конечную точку периода действия, возможна потеря информации об изменениях вследствие слишком агрессивной очистки.</span><span class="sxs-lookup"><span data-stu-id="6c96f-175">If the low endpoint of the extraction interval is to the left of the low endpoint of the validity interval, there could be missing change data due to aggressive cleanup.</span></span> <span data-ttu-id="6c96f-176">Если верхняя конечная точка интервала извлечения перекрывает верхнюю конечную точку периода действия, процесс отслеживания не успеет обработать данные за время, представленное интервалом извлечения, поэтому также возможна потеря информации об изменениях.</span><span class="sxs-lookup"><span data-stu-id="6c96f-176">If the high endpoint of the extraction interval is to the right of the high endpoint of the validity interval, the capture process has not yet processed through the time period that is represented by the extraction interval, and change data could also be missing.</span></span>  
  
 <span data-ttu-id="6c96f-177">Функция [sys.fn_cdc_get_min_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-min-lsn-transact-sql) используется для получения текущего минимального номера LSN для экземпляра отслеживания, а функция [sys.fn_cdc_get_max_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-max-lsn-transact-sql) — для извлечения текущего максимального номера LSN.</span><span class="sxs-lookup"><span data-stu-id="6c96f-177">The function [sys.fn_cdc_get_min_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-min-lsn-transact-sql) is used to retrieve the current minimum LSN for a capture instance, while [sys.fn_cdc_get_max_lsn](/sql/relational-databases/system-functions/sys-fn-cdc-get-max-lsn-transact-sql) is used to retrieve the current maximum LSN value.</span></span> <span data-ttu-id="6c96f-178">Функции запроса системы отслеживания измененных данных завершатся ошибкой при запросе данных об изменениях, если заданный диапазон номеров LSN выйдет за пределы этих двух значений номеров LSN.</span><span class="sxs-lookup"><span data-stu-id="6c96f-178">When querying for change data, if the specified LSN range does not lie within these two LSN values, the change data capture query functions will fail.</span></span>  
  
## <a name="handling-changes-to-source-tables"></a><span data-ttu-id="6c96f-179">Обработка изменений исходных таблиц</span><span class="sxs-lookup"><span data-stu-id="6c96f-179">Handling Changes to Source Tables</span></span>  
 <span data-ttu-id="6c96f-180">Обработка изменений столбцов в отслеживаемых исходных таблицах — достаточно трудный вопрос для потребителей потока данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-180">To accommodate column changes in the source tables that are being tracked is a difficult issue for downstream consumers.</span></span> <span data-ttu-id="6c96f-181">Хотя включение системы отслеживания измененных данных в исходной таблице не препятствует такого рода DDL-изменениям, система отслеживания помогает снизить их влияние на потребителей за счет неизменности результирующих наборов, которые возвращаются через API-интерфейс, даже при изменениях структуры базовой исходной таблицы.</span><span class="sxs-lookup"><span data-stu-id="6c96f-181">Although enabling change data capture on a source table does not prevent such DDL changes from occurring, change data capture helps to mitigate the effect on consumers by allowing the delivered result sets that are returned through the API to remain unchanged even as the column structure of the underlying source table changes.</span></span> <span data-ttu-id="6c96f-182">Структура с фиксированными столбцами также отражается в базовых таблицах изменений, к которым получают доступ функции запроса.</span><span class="sxs-lookup"><span data-stu-id="6c96f-182">This fixed column structure is also reflected in the underlying change table that the defined query functions access.</span></span>  
  
 <span data-ttu-id="6c96f-183">Для поддержки работы с таблицей изменений, имеющей фиксированную структуру столбцов, процесс отслеживания, отвечающий за заполнение таблицы изменений, не учитывает новые, не определенные для отслеживания столбцы, если в исходной таблице активирована система отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-183">To accommodate a fixed column structure change table, the capture process responsible for populating the change table will ignore any new columns that are not identified for capture when the source table was enabled for change data capture.</span></span> <span data-ttu-id="6c96f-184">Если отслеживаемый столбец удаляется, в соответствующих записях изменений указываются значения null.</span><span class="sxs-lookup"><span data-stu-id="6c96f-184">If a tracked column is dropped, null values will be supplied for the column in the subsequent change entries.</span></span> <span data-ttu-id="6c96f-185">Но если у существующего столбца меняется тип данных, это изменение отражается в таблице изменений, чтобы не допустить потерю данных в отслеживаемых столбцах.</span><span class="sxs-lookup"><span data-stu-id="6c96f-185">However, if an existing column undergoes a change in its data type, the change is propagated to the change table to ensure that the capture mechanism does not introduce data loss to tracked columns.</span></span> <span data-ttu-id="6c96f-186">Процесс отслеживания также отправляет все изменения в структуре столбцов отслеживаемой таблицы в таблицу cdc.ddl_history.</span><span class="sxs-lookup"><span data-stu-id="6c96f-186">The capture process also posts any detected changes to the column structure of tracked tables to the cdc.ddl_history table.</span></span> <span data-ttu-id="6c96f-187">Потребители, желающие получить предупреждение о корректировке, которую, возможно, придется внести в нисходящие приложения, используют хранимую процедуру [sys.sp_cdc_get_ddl_history](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-get-ddl-history-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="6c96f-187">Consumers wishing to be alerted of adjustments that might have to be made in downstream applications, use the stored procedure [sys.sp_cdc_get_ddl_history](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-get-ddl-history-transact-sql).</span></span>  
  
 <span data-ttu-id="6c96f-188">Как правило, текущий экземпляр отслеживания продолжает сохранять свой формат, когда DDL-изменения применяются к соответствующей исходной таблице.</span><span class="sxs-lookup"><span data-stu-id="6c96f-188">Typically, the current capture instance will continue to retain its shape when DDL changes are applied to its associated source table.</span></span> <span data-ttu-id="6c96f-189">Однако для таблицы, отражающей новую структуру столбцов, можно создать второй экземпляр отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-189">However, it is possible to create a second capture instance for the table that reflects the new column structure.</span></span> <span data-ttu-id="6c96f-190">Это позволит процессу отслеживания воспроизвести изменения одной исходной таблицы в двух таблицах изменений, имеющих разную структуру столбцов.</span><span class="sxs-lookup"><span data-stu-id="6c96f-190">This allows the capture process to make changes to the same source table into two distinct change tables having two different column structures.</span></span> <span data-ttu-id="6c96f-191">Таким образом, в то время как одна таблица изменений будет поставлять данные в текущие рабочие приложения, вторая будет служить источником данных для среды разработки, принимающей данные нового столбца.</span><span class="sxs-lookup"><span data-stu-id="6c96f-191">Thus, while one change table can continue to feed current operational programs, the second one can drive a development environment that is trying to incorporate the new column data.</span></span> <span data-ttu-id="6c96f-192">Позволив средству отслеживания одновременно заполнять обе таблицы изменений, можно добиться перехода от одного формата к другому без потери информации.</span><span class="sxs-lookup"><span data-stu-id="6c96f-192">Allowing the capture mechanism to populate both change tables in tandem means that a transition from one to the other can be accomplished without loss of change data.</span></span> <span data-ttu-id="6c96f-193">Это может случиться, когда произойдет перекрытие временных шкал двух систем отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-193">This can happen any time the two change data capture timelines overlap.</span></span> <span data-ttu-id="6c96f-194">После завершения перехода устаревший экземпляр отслеживания можно удалить.</span><span class="sxs-lookup"><span data-stu-id="6c96f-194">When the transition is effected, the obsolete capture instance can be removed.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6c96f-195">С одной исходной таблицей одновременно можно связать не более двух экземпляров отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-195">The maximum number of capture instances that can be concurrently associated with a single source table is two.</span></span>  
  
## <a name="relationship-between-the-capture-job-and-the-transactional-replication-logreader"></a><span data-ttu-id="6c96f-196">Связь между заданием отслеживания и агентом чтения журнала репликации транзакций</span><span class="sxs-lookup"><span data-stu-id="6c96f-196">Relationship Between the Capture Job and the Transactional Replication Logreader</span></span>  
 <span data-ttu-id="6c96f-197">Логика процесса отслеживания измененных данных внедрена в расширенную хранимую процедуру [sp_replcmds](/sql/relational-databases/system-stored-procedures/sp-replcmds-transact-sql), во внутреннюю серверную функцию, являющуюся частью программы sqlservr.exe, а также используемую репликацией транзакций, которая считывает изменения из журнала транзакций.</span><span class="sxs-lookup"><span data-stu-id="6c96f-197">The logic for change data capture process is embedded in the stored procedure [sp_replcmds](/sql/relational-databases/system-stored-procedures/sp-replcmds-transact-sql), an internal server function built as part of sqlservr.exe and also used by transactional replication to harvest changes from the transaction log.</span></span> <span data-ttu-id="6c96f-198">Если в базе данных активирована только система отслеживания измененных данных, создается задание отслеживания агента SQL Server как средство вызова хранимой процедуры sp_replcmds.</span><span class="sxs-lookup"><span data-stu-id="6c96f-198">When change data capture alone is enabled for a database, you create the change data capture SQL Server Agent capture job as the vehicle for invoking sp_replcmds.</span></span> <span data-ttu-id="6c96f-199">Если включена также репликация, для поставки информации об изменениях обоим потребителям используется только агент чтения журнала транзакций.</span><span class="sxs-lookup"><span data-stu-id="6c96f-199">When replication is also present, the transactional logreader alone is used to satisfy the change data needs for both of these consumers.</span></span> <span data-ttu-id="6c96f-200">Такой метод значительно снижает возможность состязания, если в одной базе данных активирована как система отслеживания измененных данных, так и репликация.</span><span class="sxs-lookup"><span data-stu-id="6c96f-200">This strategy significantly reduces log contention when both replication and change data capture are enabled for the same database.</span></span>  
  
 <span data-ttu-id="6c96f-201">Переключение между этими рабочими моделями происходит автоматически каждый раз, когда меняется состояние репликации в базе данных с активированной системой отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-201">The switch between these two operational modes for capturing change data occurs automatically whenever there is a change in the replication status of a change data capture enabled database.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6c96f-202">Оба экземпляра логики отслеживания измененных данных требуют запуска агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="6c96f-202">Both instances of the capture logic require [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent to be running for the process to execute.</span></span>  
  
 <span data-ttu-id="6c96f-203">Основная задача процесса отслеживания заключается в просмотре журнала и записи данных столбцов и связанных с ними сведений о транзакциях в таблицы изменений системы отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-203">The principal task of the capture process is to scan the log and write column data and transaction related information to the change data capture change tables.</span></span> <span data-ttu-id="6c96f-204">Чтобы обеспечить транзакционно согласованную границу между всеми таблицами изменений, процесс отслеживания измененных данных открывает и фиксирует собственные транзакции по каждому циклу считывания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-204">To ensure a transactionally consistent boundary across all the change data capture change tables that it populates, the capture process opens and commits its own transaction on each scan cycle.</span></span> <span data-ttu-id="6c96f-205">Он обнаруживает вновь активированные таблицы системы отслеживания измененных данных и автоматически включает их в набор таблиц, в которых отслеживается изменение данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-205">It detects when tables are newly enabled for change data capture, and automatically includes them in the set of tables that are actively monitored for change entries in the log.</span></span> <span data-ttu-id="6c96f-206">Точно так же обнаруживается отключение системы отслеживания измененных данных, что приводит к удалению исходной таблицы из набора таблиц, в которых проводится наблюдение за изменением данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-206">Similarly, disabling change data capture will also be detected, causing the source table to be removed from the set of tables actively monitored for change data.</span></span> <span data-ttu-id="6c96f-207">Когда завершается обработка раздела журнала, процесс отслеживания вызывает серверную логику усечения журнала, которая использует данные процесса для определения записей журнала, подлежащих усечению.</span><span class="sxs-lookup"><span data-stu-id="6c96f-207">When processing for a section of the log is finished, the capture process signals the server log truncation logic, which uses this information to identify log entries eligible for truncation.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6c96f-208">Если в базе данных было включено отслеживание измененных данных, то даже в том случае, если в качестве модели восстановления базы данных было выбрано простое восстановление, то точка усечения журнала не будет передвинута далее, пока все отслеживаемые изменения не будут собраны процессом отслеживания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-208">When a database is enabled for change data capture, even if the recovery mode is set to simple recovery the log truncation point will not advance until all the changes that are marked for capture have been gathered by the capture process.</span></span> <span data-ttu-id="6c96f-209">Если процесс отслеживания не выполняется и присутствуют изменения, которые следует собрать, то при выполнении инструкции CHECKPOINT журнал усечен не будет.</span><span class="sxs-lookup"><span data-stu-id="6c96f-209">If the capture process is not running and there are changes to be gathered, executing CHECKPOINT will not truncate the log.</span></span>  
  
 <span data-ttu-id="6c96f-210">Кроме того, процесс отслеживания используется также для ведения журнала DDL-изменений в отслеживаемых таблицах.</span><span class="sxs-lookup"><span data-stu-id="6c96f-210">The capture process is also used to maintain history on the DDL changes to tracked tables.</span></span> <span data-ttu-id="6c96f-211">Инструкции DDL, связанные с системой отслеживания измененных данных, создают записи в журнале транзакций базы данных каждый раз, когда удаляется база данных или таблица с активированной системой отслеживания измененных данных или добавляются, изменяются или удаляются столбцы такой таблицы.</span><span class="sxs-lookup"><span data-stu-id="6c96f-211">The DDL statements that are associated with change data capture make entries to the database transaction log whenever a change data capture-enabled database or table is dropped or columns of a change data capture-enabled table are added, modified, or dropped.</span></span> <span data-ttu-id="6c96f-212">Эти записи журнала обрабатываются процессом отслеживания, который затем отправляет соответствующие DDL-события в таблицу cdc.ddl_history.</span><span class="sxs-lookup"><span data-stu-id="6c96f-212">These log entries are processed by the capture process, which then posts the associated DDL events to the cdc.ddl_history table.</span></span> <span data-ttu-id="6c96f-213">Сведения о событиях DDL, влияющих на отслеживаемые таблицы, можно получить с помощью хранимой процедуры [sys.sp_cdc_get_ddl_history](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-get-ddl-history-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="6c96f-213">You can obtain information about DDL events that affect tracked tables by using the stored procedure [sys.sp_cdc_get_ddl_history](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-get-ddl-history-transact-sql).</span></span>  
  
## <a name="change-data-capture-agent-jobs"></a><span data-ttu-id="6c96f-214">Задания агента системы отслеживания измененных данных</span><span class="sxs-lookup"><span data-stu-id="6c96f-214">Change Data Capture Agent Jobs</span></span>  
 <span data-ttu-id="6c96f-215">С базой данных, в которой активирована система отслеживания измененных данных, обычно связаны два задания агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] : одно заполняет таблицы изменений, а второе отвечает за их очистку.</span><span class="sxs-lookup"><span data-stu-id="6c96f-215">Two [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent jobs are typically associated with a change data capture enabled database: one that is used to populate the database change tables, and one that is responsible for change table cleanup.</span></span> <span data-ttu-id="6c96f-216">Оба задания состоят из одного шага, который выполняет команду [!INCLUDE[tsql](../../includes/tsql-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="6c96f-216">Both jobs consist of a single step that runs a [!INCLUDE[tsql](../../includes/tsql-md.md)] command.</span></span> <span data-ttu-id="6c96f-217">Вызываемая команда [!INCLUDE[tsql](../../includes/tsql-md.md)] представляет собой хранимую процедуру, определенную системой отслеживания измененных данных, которая реализует логику задания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-217">The [!INCLUDE[tsql](../../includes/tsql-md.md)] command that is invoked is a change data capture defined stored procedure that implements the logic of the job.</span></span> <span data-ttu-id="6c96f-218">Оба задания создаются, когда система отслеживания измененных данных активируется в первой таблице базы данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-218">The jobs are created when the first table of the database is enabled for change data capture.</span></span> <span data-ttu-id="6c96f-219">Задание очистки создается всегда.</span><span class="sxs-lookup"><span data-stu-id="6c96f-219">The Cleanup Job is always created.</span></span> <span data-ttu-id="6c96f-220">Задание отслеживания создается, только если для базы данных не определена публикация транзакций.</span><span class="sxs-lookup"><span data-stu-id="6c96f-220">The capture job will only be created if there are no defined transactional publications for the database.</span></span> <span data-ttu-id="6c96f-221">Задание отслеживания также создается, когда в базе данных активируется как система отслеживания измененных данных, так и репликация транзакций, а задание агента чтения журнала транзакций удаляется, поскольку в базе данных теперь отсутствуют заданные публикации.</span><span class="sxs-lookup"><span data-stu-id="6c96f-221">The capture job is also created when both change data capture and transactional replication are enabled for a database, and the transactional logreader job is removed because the database no longer has defined publications.</span></span>  
  
 <span data-ttu-id="6c96f-222">Как задание отслеживания, так и задание очистки создаются с помощью параметров по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="6c96f-222">Both the capture and cleanup jobs are created by using default parameters.</span></span> <span data-ttu-id="6c96f-223">Задание отслеживания запускается немедленно.</span><span class="sxs-lookup"><span data-stu-id="6c96f-223">The capture job is started immediately.</span></span> <span data-ttu-id="6c96f-224">Оно выполняется постоянно, обрабатывая до 1 000 транзакций за цикл просмотра с 5-секундной задержкой между циклами.</span><span class="sxs-lookup"><span data-stu-id="6c96f-224">It runs continuously, processing a maximum of 1000 transactions per scan cycle with a wait of 5 seconds between cycles.</span></span> <span data-ttu-id="6c96f-225">Задание очистки запускается ежедневно в 02.00.</span><span class="sxs-lookup"><span data-stu-id="6c96f-225">The cleanup job runs daily at 2 A.M.</span></span> <span data-ttu-id="6c96f-226">Оно сохраняет записи таблицы изменений в течение 4320 минут или 3 суток, удаляя до 5000 записей в одной инструкции удаления.</span><span class="sxs-lookup"><span data-stu-id="6c96f-226">It retains change table entries for 4320 minutes or 3 days, removing a maximum of 5000 entries with a single delete statement.</span></span>  
  
 <span data-ttu-id="6c96f-227">Задания агента системы отслеживания измененных данных удаляются, когда система отключается в базе данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-227">The change data capture agent jobs are removed when change data capture is disabled for a database.</span></span> <span data-ttu-id="6c96f-228">Задание отслеживания можно также удалить, когда к базе данных добавляется первая публикация и включаются как система отслеживания измененных данных, так и репликация транзакций.</span><span class="sxs-lookup"><span data-stu-id="6c96f-228">The capture job can also be removed when the first publication is added to a database, and both change data capture and transactional replication are enabled.</span></span>  
  
 <span data-ttu-id="6c96f-229">На внутреннем уровне задания системы отслеживания измененных данных создаются и удаляются хранимыми процедурами [sys.sp_cdc_add_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql) и [sys.sp_cdc_drop_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-drop-job-transact-sql)соответственно.</span><span class="sxs-lookup"><span data-stu-id="6c96f-229">Internally, change data capture agent jobs are created and dropped by using the stored procedures [sys.sp_cdc_add_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql) and [sys.sp_cdc_drop_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-drop-job-transact-sql), respectively.</span></span> <span data-ttu-id="6c96f-230">Эти хранимые процедуры открыты для доступа, чтобы администратор мог управлять созданием и удалением этих заданий.</span><span class="sxs-lookup"><span data-stu-id="6c96f-230">These stored procedures are also exposed so that administrators can control the creation and removal of these jobs.</span></span>  
  
 <span data-ttu-id="6c96f-231">Администратор не может явно управлять применяемой по умолчанию конфигурацией заданий агента для системы отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-231">An administrator has no explicit control over the default configuration of the change data capture agent jobs.</span></span> <span data-ttu-id="6c96f-232">Для изменения параметров конфигурации по умолчанию используется хранимая процедура [sys.sp_cdc_change_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="6c96f-232">The stored procedure [sys.sp_cdc_change_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql) is provided to allow the default configuration parameters to be modified.</span></span> <span data-ttu-id="6c96f-233">Кроме того, хранимая процедура [sys.sp_cdc_help_jobs](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-jobs-transact-sql) позволяет просматривать текущие параметры конфигурации.</span><span class="sxs-lookup"><span data-stu-id="6c96f-233">In addition, the stored procedure [sys.sp_cdc_help_jobs](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-jobs-transact-sql) allows current configuration parameters to be viewed.</span></span> <span data-ttu-id="6c96f-234">Задание отслеживания и задание очистки при запуске извлекают параметры конфигурации из таблицы msdb.dbo.cdc_jobs.</span><span class="sxs-lookup"><span data-stu-id="6c96f-234">Both the capture job and the cleanup job extract configuration parameters from the table msdb.dbo.cdc_jobs on startup.</span></span> <span data-ttu-id="6c96f-235">Изменения значений этих параметров, выполненные с помощью хранимой процедуры [sys.sp_cdc_change_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql) , вступают в силу только после остановки и перезапуска задания.</span><span class="sxs-lookup"><span data-stu-id="6c96f-235">Any changes made to these values by using [sys.sp_cdc_change_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql) will not take effect until the job is stopped and restarted.</span></span>  
  
 <span data-ttu-id="6c96f-236">Для остановки и запуска заданий агента системы отслеживания измененных данных используются две дополнительные хранимые процедуры: [sys.sp_cdc_start_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-start-job-transact-sql) и [sys.sp_cdc_stop_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-stop-job-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="6c96f-236">Two additional stored procedures are provided to allow the change data capture agent jobs to be started and stopped: [sys.sp_cdc_start_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-start-job-transact-sql) and [sys.sp_cdc_stop_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-stop-job-transact-sql).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6c96f-237">Запуск и остановка задания отслеживания не приводят к потере информации об изменениях.</span><span class="sxs-lookup"><span data-stu-id="6c96f-237">Starting and stopping the capture job does not result in a loss of change data.</span></span> <span data-ttu-id="6c96f-238">Это лишь препятствует процессу отслеживания активно просматривать журнал в поисках записей изменения и помещать их в таблицы изменений.</span><span class="sxs-lookup"><span data-stu-id="6c96f-238">It only prevents the capture process from actively scanning the log for change entries to deposit in the change tables.</span></span> <span data-ttu-id="6c96f-239">Чтобы избежать дополнительной рабочей нагрузки в результате просмотра журнала, в период пиковой нагрузки рекомендуется остановить задание отслеживания и вновь запустить его, когда нагрузка уменьшится.</span><span class="sxs-lookup"><span data-stu-id="6c96f-239">A reasonable strategy to prevent log scanning from adding load during periods of peak demand is to stop the capture job and restart it when demand is reduced.</span></span>  
  
 <span data-ttu-id="6c96f-240">Оба задания агента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] достаточно гибкие и настраиваемые, чтобы удовлетворить основные потребности среды системы отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="6c96f-240">Both [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent jobs were designed to be flexible enough and sufficiently configurable to meet the basic needs of change data capture environments.</span></span> <span data-ttu-id="6c96f-241">Однако в обоих случаях базовые хранимые процедуры, обеспечивающие основные функциональные возможности, открыты для доступа, чтобы сделать возможной дополнительную настройку.</span><span class="sxs-lookup"><span data-stu-id="6c96f-241">In both cases, however, the underlying stored procedures that provide the core functionality have been exposed so that further customization is possible.</span></span>  
  
 <span data-ttu-id="6c96f-242">Система отслеживания измененных данных не может работать правильно, когда служба ядра СУБД или служба агента SQL Server работает под учетной записью NETWORK SERVICE.</span><span class="sxs-lookup"><span data-stu-id="6c96f-242">Change data capture cannot function properly when the Database Engine service or the SQL Server Agent service is running under the NETWORK SERVICE account.</span></span> <span data-ttu-id="6c96f-243">В этом случае может возникать ошибка 22832.</span><span class="sxs-lookup"><span data-stu-id="6c96f-243">This can result in error 22832.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="6c96f-244">См. также:</span><span class="sxs-lookup"><span data-stu-id="6c96f-244">See Also</span></span>  
 <span data-ttu-id="6c96f-245">[Отслеживание измененных данных (SQL Server)](../track-changes/track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6c96f-245">[Track Data Changes &#40;SQL Server&#41;](../track-changes/track-data-changes-sql-server.md) </span></span>  
 <span data-ttu-id="6c96f-246">[Включение и отключение отслеживания измененных данных (SQL Server)](../track-changes/enable-and-disable-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6c96f-246">[Enable and Disable Change Data Capture &#40;SQL Server&#41;](../track-changes/enable-and-disable-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="6c96f-247">[Работа с информацией об изменениях (SQL Server)](../track-changes/work-with-change-data-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6c96f-247">[Work with Change Data &#40;SQL Server&#41;](../track-changes/work-with-change-data-sql-server.md) </span></span>  
 [<span data-ttu-id="6c96f-248">Администрирование и наблюдение за отслеживанием измененных данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="6c96f-248">Administer and Monitor Change Data Capture &#40;SQL Server&#41;</span></span>](../track-changes/administer-and-monitor-change-data-capture-sql-server.md)  
  
  
