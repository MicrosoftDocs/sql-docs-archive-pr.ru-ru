---
title: Администрирование и мониторинг отслеживания измененных данных (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- change data capture [SQL Server], monitoring
- change data capture [SQL Server], administering
- change data capture [SQL Server], jobs
ms.assetid: 23bda497-67b2-4e7b-8e4d-f1f9a2236685
author: rothja
ms.author: jroth
ms.openlocfilehash: 8d97929ead145d1b0de1a1f83becb15ade397683
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87665906"
---
# <a name="administer-and-monitor-change-data-capture-sql-server"></a><span data-ttu-id="a211d-102">Администрирование и наблюдение за отслеживанием измененных данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="a211d-102">Administer and Monitor Change Data Capture (SQL Server)</span></span>
  <span data-ttu-id="a211d-103">В этом разделе описано, как администрировать и наблюдать за отслеживанием измененных данных.</span><span class="sxs-lookup"><span data-stu-id="a211d-103">This topic describes how to administer and monitor change data capture.</span></span>  
  
##  <a name="capture-job"></a><a name="Capture"></a> <span data-ttu-id="a211d-104">Задание отслеживания</span><span class="sxs-lookup"><span data-stu-id="a211d-104">Capture Job</span></span>  
 <span data-ttu-id="a211d-105">Задание отслеживания инициируется путем запуска хранимой процедуры без параметров `sp_MScdc_capture_job`.</span><span class="sxs-lookup"><span data-stu-id="a211d-105">The capture job is initiated by running the parameterless stored procedure `sp_MScdc_capture_job`.</span></span> <span data-ttu-id="a211d-106">После запуска данная хранимая процедура получает из таблицы msdb.dbo.cdc_jobs значения, заданные для параметров *maxtrans*, *maxscans*, *continuous*и *pollinginterval* задания отслеживания.</span><span class="sxs-lookup"><span data-stu-id="a211d-106">This stored procedure starts by extracting the configured values for *maxtrans*, *maxscans*, *continuous*, and *pollinginterval* for the capture job from msdb.dbo.cdc_jobs.</span></span> <span data-ttu-id="a211d-107">Затем данные настроенные значения передаются в качестве параметров для хранимой процедуры `sp_cdc_scan`.</span><span class="sxs-lookup"><span data-stu-id="a211d-107">These configured values are then passed as parameters to the stored procedure `sp_cdc_scan`.</span></span> <span data-ttu-id="a211d-108">Используется для вызова процедуры `sp_replcmds` для выполнения просмотра журнала.</span><span class="sxs-lookup"><span data-stu-id="a211d-108">This is used to invoke `sp_replcmds` to perform the log scan.</span></span>  
  
### <a name="capture-job-parameters"></a><span data-ttu-id="a211d-109">Параметры задания отслеживания</span><span class="sxs-lookup"><span data-stu-id="a211d-109">Capture Job Parameters</span></span>  
 <span data-ttu-id="a211d-110">Чтобы понять поведение задания отслеживания, необходимо понять то, как в хранимой процедуре `sp_cdc_scan` используются настраиваемые параметры.</span><span class="sxs-lookup"><span data-stu-id="a211d-110">To understand capture job behavior, you must understand how the configurable parameters are used by `sp_cdc_scan`.</span></span>  
  
#### <a name="maxtrans-parameter"></a><span data-ttu-id="a211d-111">Параметр maxtrans</span><span class="sxs-lookup"><span data-stu-id="a211d-111">maxtrans Parameter</span></span>  
 <span data-ttu-id="a211d-112">Параметр *maxtrans* указывает максимальное количество транзакций, которое может быть обработано в одном цикле просмотра журнала.</span><span class="sxs-lookup"><span data-stu-id="a211d-112">The *maxtrans* parameter specifies the maximum number of transactions that can be processed in a single scan cycle of the log.</span></span> <span data-ttu-id="a211d-113">Если во время просмотра количество обрабатываемых транзакций достигает данного предела, то в текущую операцию просмотра больше не включаются дополнительные транзакции.</span><span class="sxs-lookup"><span data-stu-id="a211d-113">If, during the scan, the number of transactions to be processed reaches this limit, no additional transactions are included in the current scan.</span></span> <span data-ttu-id="a211d-114">После завершения цикла просмотра число обработанных транзакций всегда будет меньше или равным значению параметра *maxtrans*.</span><span class="sxs-lookup"><span data-stu-id="a211d-114">After a scan cycle is complete, the number of transactions that were processed will always be less than or equal to *maxtrans*.</span></span>  
  
#### <a name="maxscans-parameter"></a><span data-ttu-id="a211d-115">Параметр maxscans</span><span class="sxs-lookup"><span data-stu-id="a211d-115">maxscans Parameter</span></span>  
 <span data-ttu-id="a211d-116">Параметр *maxscans* задает максимальное число циклов просмотра, которые предпринимаются для очистки журнала до возвращения (continuous = 0) или выполнения инструкции waitfor (continuous = 1).</span><span class="sxs-lookup"><span data-stu-id="a211d-116">The *maxscans* parameter specifies the maximum number of scan cycles that are attempted to drain the log before either returning (continuous = 0) or executing a waitfor (continuous = 1).</span></span>  
  
#### <a name="continuous-parameter"></a><span data-ttu-id="a211d-117">Параметр continuous</span><span class="sxs-lookup"><span data-stu-id="a211d-117">continuous Parameter</span></span>  
 <span data-ttu-id="a211d-118">*Постоянный* параметр определяет, будет ли `sp_cdc_scan` элемент управления переключаться после очистки журнала или выполнения максимального числа циклов просмотра (один режим однократного создания).</span><span class="sxs-lookup"><span data-stu-id="a211d-118">The *continuous* parameter controls whether `sp_cdc_scan` relinquishes control in after either draining the log or executing the maximum number of scan cycles (one shot mode).</span></span> <span data-ttu-id="a211d-119">Данный параметр также управляет тем, продолжает ли выполняться хранимая процедура `sp_cdc_scan` после того, как она была явно остановлена (непрерывный режим).</span><span class="sxs-lookup"><span data-stu-id="a211d-119">It also controles whether `sp_cdc_scan` continues to run until explicitly stopped (continuous mode).</span></span>  
  
##### <a name="one-shot-mode"></a><span data-ttu-id="a211d-120">Режим однократного выполнения</span><span class="sxs-lookup"><span data-stu-id="a211d-120">One Shot Mode</span></span>  
 <span data-ttu-id="a211d-121">В одном режиме однократное задание отслеживания запрашивает `sp_cdc_scan` выполнение до *maxtrans* просмотров, чтобы попытаться очистить журнал и вернуться.</span><span class="sxs-lookup"><span data-stu-id="a211d-121">In one shot mode, the capture job requests `sp_cdc_scan` to perform up to *maxtrans* scans to try to drain the log and return.</span></span> <span data-ttu-id="a211d-122">Любые присутствующие в журнале транзакции, вышедшие за пределы значения *maxtrans* , будут обработаны в последующих циклах просмотра.</span><span class="sxs-lookup"><span data-stu-id="a211d-122">Any transactions in addition to *maxtrans* that are present in the log will be processed in later scans.</span></span>  
  
 <span data-ttu-id="a211d-123">Режим однократного выполнения используется в управляемых проверках, когда количество обрабатываемых транзакций известно, а преимуществом является тот факт, что задание автоматически закрывается при завершении работы.</span><span class="sxs-lookup"><span data-stu-id="a211d-123">One shot mode is used in controlled tests, where the volume of transactions to be processed is known, and there are advantages to the fact that the job closes automatically on when it is finished.</span></span> <span data-ttu-id="a211d-124">Не рекомендуется использовать режим однократного выполнения в процессе эксплуатации.</span><span class="sxs-lookup"><span data-stu-id="a211d-124">One shot mode is not recommended for production use.</span></span> <span data-ttu-id="a211d-125">Это обусловлено тем, что данный режим полагается на расписание задания для управления частотой выполнения циклов просмотра.</span><span class="sxs-lookup"><span data-stu-id="a211d-125">This is because t relies on the job schedule to manage how frequently the scan cycle is run.</span></span>  
  
 <span data-ttu-id="a211d-126">При работе в режиме однократного выполнения можно вычислить верхнюю границу ожидаемой пропускной способности задания отслеживания, выраженную в транзакциях в секунду, использовав следующее вычисление:</span><span class="sxs-lookup"><span data-stu-id="a211d-126">When running in one shot mode, you can compute an upper bound on expected throughput of the capture job, expressed in transactions per second by using the following computation:</span></span>  
  
 `(maxtrans * maxscans) / number of seconds between scans`  
  
 <span data-ttu-id="a211d-127">Даже если количество времени, необходимое для просмотра журнала и заполнения таблиц изменений, не сильно отличается от нуля, средняя пропускная способность задания не может превысить значение, которое можно получить, разделив произведение максимального числа допустимых транзакций для одного просмотра и максимального числа допустимых просмотров на число секунд, которое проходит между отдельными обработками журнала.</span><span class="sxs-lookup"><span data-stu-id="a211d-127">Even if the time that is required to scan the log and populate the change tables were not significantly different from 0, the average throughput of the job could not exceed the value obtained by dividing the maximum allowed transactions for a single scan multiplied by the maximum allowed scans by the number of seconds separating log processing.</span></span>  
  
 <span data-ttu-id="a211d-128">Если бы для управления просмотрами журнала использовался режим однократного выполнения, то число секунд, проходящее между обработками журнала, должно было бы управляться расписанием задания.</span><span class="sxs-lookup"><span data-stu-id="a211d-128">If one shot mode were to be used to regulate log scanning, the number of seconds between log processing would have to be governed by the job schedule.</span></span> <span data-ttu-id="a211d-129">Если необходимо такое поведение, то для управления графиком просмотра журнала лучше использовать задание отслеживания, выполняющееся в непрерывном режиме.</span><span class="sxs-lookup"><span data-stu-id="a211d-129">When this kind of behavior is desired, running the capture job in continuous mode is a better way to manage rescheduling the log scan.</span></span>  
  
##### <a name="continuous-mode-and-the-polling-interval"></a><span data-ttu-id="a211d-130">Непрерывный режим и интервал опроса</span><span class="sxs-lookup"><span data-stu-id="a211d-130">Continuous Mode and the Polling Interval</span></span>  
 <span data-ttu-id="a211d-131">В непрерывном режиме задание отслеживания запрашивает непрерывное выполнение процедуры `sp_cdc_scan`.</span><span class="sxs-lookup"><span data-stu-id="a211d-131">In continuous mode, the capture job requests that `sp_cdc_scan` run continuously.</span></span> <span data-ttu-id="a211d-132">Это позволяет хранимой процедуре управлять собственным циклом ожидания, предоставляя не только значения параметров maxtrans и maxscans, но также и значение числа секунд, проходящее между обработками журнала (интервал опроса).</span><span class="sxs-lookup"><span data-stu-id="a211d-132">This lets the stored procedure manage its own wait loop by providing not only for maxtrans and maxscans but also a value for the number of seconds between log processing (the polling interval).</span></span> <span data-ttu-id="a211d-133">При выполнении в данном режиме задание отслеживания остается активным; в перерывах между просмотрами журнала выполняется инструкция `WAITFOR`.</span><span class="sxs-lookup"><span data-stu-id="a211d-133">Running in this mode, the capture job remains active, executing a `WAITFOR` between log scanning.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a211d-134">Если значение интервала опроса больше 0, то верхняя граница пропускной способности для повторяющихся заданий в режиме однократного выполнения также будет применяться и к функционированию задания в непрерывном режиме.</span><span class="sxs-lookup"><span data-stu-id="a211d-134">When the value of the polling interval is greater than 0, the same upper limit on throughput for the recurring one shot job also applies to the job operation in continuous mode.</span></span> <span data-ttu-id="a211d-135">То есть значение (*maxtrans* \* *maxscans*), разделенное на ненулевой интервал опроса, будет служить верхней границей для среднего количества транзакций, которое может быть обработано заданием отслеживания.</span><span class="sxs-lookup"><span data-stu-id="a211d-135">That is, (*maxtrans* \* *maxscans*) divided by a nonzero polling interval will put an upper bound on the average number of transactions that can be processed by the capture job.</span></span>  
  
### <a name="capture-job-customization"></a><span data-ttu-id="a211d-136">Настройка задания отслеживания</span><span class="sxs-lookup"><span data-stu-id="a211d-136">Capture Job Customization</span></span>  
 <span data-ttu-id="a211d-137">К заданию отслеживания можно применить дополнительную логику для определения того, будет ли новый просмотр выполняться немедленно или перед запуском нового просмотра будет реализовываться период бездействия, вместо того чтобы полагаться на фиксированный интервал опроса.</span><span class="sxs-lookup"><span data-stu-id="a211d-137">For the capture job, you can apply additional logic to determine whether a new scan begins immediately or whether a sleep is imposed before it starts a new scan instead of rely on a fixed polling interval.</span></span> <span data-ttu-id="a211d-138">Выбор может быть основан на времени суток: например, во время пиковой активности можно установить очень большие периоды бездействия, а в конце дня можно установить значение интервала опроса, близкое к 0, что поможет завершить дневную обработку и подготовиться к еженощным выполнениям.</span><span class="sxs-lookup"><span data-stu-id="a211d-138">The choice could be based merely on time of the day, perhaps enforcing very long sleeps during peak activity times, and even moving to a polling interval of 0 at close of day when it is important to complete the days processing and prepare for nightly runs.</span></span> <span data-ttu-id="a211d-139">Для определения времени просмотра и помещения в таблицы изменений всех транзакций, зафиксированных до полуночи, можно наблюдать за развитием процесса отслеживания.</span><span class="sxs-lookup"><span data-stu-id="a211d-139">Capture process progress could also be monitored to determine when all transactions committed by mid-night had been scanned and deposited in change tables.</span></span> <span data-ttu-id="a211d-140">Это позволит заданию отслеживания завершиться для повторного запуска при запланированном ежедневном перезапуске.</span><span class="sxs-lookup"><span data-stu-id="a211d-140">This lets the capture job end, to be restarted by a scheduled daily restart.</span></span> <span data-ttu-id="a211d-141">Заменив шаг задания вызова хранимой процедуры `sp_cdc_scan` передаваемого задания на вызов написанной пользователем оболочки для хранимой процедуры `sp_cdc_scan`, можно с небольшими усилиями обеспечить специальным образом настроенное поведение.</span><span class="sxs-lookup"><span data-stu-id="a211d-141">By replacing the delivered job step calling `sp_cdc_scan` with a call to a user written wrapper for `sp_cdc_scan`, highly customized behavior can be obtained with little additional effort.</span></span>  
  
##  <a name="cleanup-job"></a><a name="Cleanup"></a> <span data-ttu-id="a211d-142">Задание очистки</span><span class="sxs-lookup"><span data-stu-id="a211d-142">Cleanup Job</span></span>  
 <span data-ttu-id="a211d-143">В данном разделе предоставляются сведения о функционировании задания очистки для отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="a211d-143">This section provides information about how the change data capture cleanup job works.</span></span>  
  
### <a name="structure-of-the-cleanup-job"></a><span data-ttu-id="a211d-144">Структура задания очистки</span><span class="sxs-lookup"><span data-stu-id="a211d-144">Structure of the Cleanup Job</span></span>  
 <span data-ttu-id="a211d-145">В системе отслеживания измененных данных для управления размером таблиц изменений используется стратегия очистки данных по истечении срока хранения.</span><span class="sxs-lookup"><span data-stu-id="a211d-145">Change data capture uses a retention based cleanup strategy to manage change table size.</span></span> <span data-ttu-id="a211d-146">Механизм очистки состоит из задания [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] агента [!INCLUDE[tsql](../../includes/tsql-md.md)] , созданного при активации первой таблицы базы данных.</span><span class="sxs-lookup"><span data-stu-id="a211d-146">The cleanup mechanism consists of a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent [!INCLUDE[tsql](../../includes/tsql-md.md)] job that is created when the first database table is enabled.</span></span> <span data-ttu-id="a211d-147">Одно задание очистки управляет очисткой всех таблиц изменений базы данных; оно применяет одно значение срока хранения ко всем определенным экземплярам системы отслеживания.</span><span class="sxs-lookup"><span data-stu-id="a211d-147">A single cleanup job handles cleanup for all database change tables and applies the same retention value to all defined capture instances.</span></span>  
  
 <span data-ttu-id="a211d-148">Задание очистки инициируется путем запуска хранимой процедуры без параметров `sp_MScdc_cleanup_job`.</span><span class="sxs-lookup"><span data-stu-id="a211d-148">The cleanup job is initiated by running the parameterless stored procedure `sp_MScdc_cleanup_job`.</span></span> <span data-ttu-id="a211d-149">После запуска данная хранимая процедура получает значение срока хранения и пороговое значение, установленные для задания очистки из системной таблицы `msdb.dbo.cdc_jobs`.</span><span class="sxs-lookup"><span data-stu-id="a211d-149">This stored procedure starts by extracting the configured retention and threshold values for the cleanup job from `msdb.dbo.cdc_jobs`.</span></span> <span data-ttu-id="a211d-150">Значение срока хранения используется для вычисления нижнего предела таблиц изменений.</span><span class="sxs-lookup"><span data-stu-id="a211d-150">The retention value is used to compute a new low watermark for the change tables.</span></span> <span data-ttu-id="a211d-151">Указанное число минут вычитается из значения максимального *tran_end_time* из `cdc.lsn_time_mapping` таблицы, чтобы получить новую низкую пометку, выраженную как значение DateTime.</span><span class="sxs-lookup"><span data-stu-id="a211d-151">The specified number of minutes is subtracted from the maximum *tran_end_time* value from the `cdc.lsn_time_mapping` table to obtain the new low water mark expressed as a datetime value.</span></span> <span data-ttu-id="a211d-152">Затем таблица «CDC.lsn_time_mapping» используется для преобразования значения datetime в соответствующее значение `lsn`.</span><span class="sxs-lookup"><span data-stu-id="a211d-152">The CDC.lsn_time_mapping table is then used to convert this datetime value to a corresponding `lsn` value.</span></span> <span data-ttu-id="a211d-153">Если одно и то же время фиксации задано для нескольких значений в таблице, то номер `lsn`, соответствующий записи с наименьшим номером `lsn` выбирается в качестве нового значения нижнего предела.</span><span class="sxs-lookup"><span data-stu-id="a211d-153">If the same commit time is shared by multiple entries in the table, the `lsn` that corresponds to the entry that has the smallest `lsn` is chosen as the new low watermark.</span></span> <span data-ttu-id="a211d-154">Значение номера `lsn` передается в хранимую процедуру `sp_cdc_cleanup_change_tables` для удаления записей из таблиц изменений базы данных.</span><span class="sxs-lookup"><span data-stu-id="a211d-154">This `lsn` value is passed to `sp_cdc_cleanup_change_tables` to remove change table entries from the database change tables.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="a211d-155">Преимуществом использования времени фиксации недавней транзакции в качестве основы для вычисления нового значения нижнего предела является то, что это позволяет хранить сведения об изменениях в таблицах изменений в течение определенного времени.</span><span class="sxs-lookup"><span data-stu-id="a211d-155">The advantage of using the commit time of the recent transaction as the base for computing the new low watermark is that it lets the changes remain in change tables for the specified time.</span></span> <span data-ttu-id="a211d-156">Это происходит, даже если процесс отслеживания запущен позже.</span><span class="sxs-lookup"><span data-stu-id="a211d-156">This happens even when the capture process is running behind.</span></span> <span data-ttu-id="a211d-157">Все изменения, имеющие то же время фиксации, что и значение нижнего предела, и далее представляются в таблицах изменений методом выбора наименьшего номера `lsn`, имеющего то же время фиксации, что и реальное значение нижнего предела.</span><span class="sxs-lookup"><span data-stu-id="a211d-157">All entries that have the same commit time as the current low watermark continue to be represented within the change tables by choosing the smallest `lsn` that has the shared commit time for the actual low watermark.</span></span>  
  
 <span data-ttu-id="a211d-158">Если выполняется очистка, то значение нижнего предела всех экземпляров системы отслеживания изначально обновляется в одной транзакции.</span><span class="sxs-lookup"><span data-stu-id="a211d-158">When a cleanup is performed, the low watermark for all capture instances is initially updated in a single transaction.</span></span> <span data-ttu-id="a211d-159">Затем производится попытка удаления устаревших записей из таблиц изменений и таблицы cdc.lsn_time_mapping.</span><span class="sxs-lookup"><span data-stu-id="a211d-159">It then tries to remove obsolete entries from the change tables and the cdc.lsn_time_mapping table.</span></span> <span data-ttu-id="a211d-160">Настраиваемое пороговое значение ограничивает количество записей, удаляемое в любой одиночной инструкции.</span><span class="sxs-lookup"><span data-stu-id="a211d-160">The configurable threshold value limits how many entries are deleted in any single statement.</span></span> <span data-ttu-id="a211d-161">Неуспешное выполнение удаления в любой отдельной таблице не повлияет на выполнение операции в остальных таблицах.</span><span class="sxs-lookup"><span data-stu-id="a211d-161">Failure to perform the delete on any individual table will not prevent the operation from being attempted on the remaining tables.</span></span>  
  
### <a name="cleanup-job-customization"></a><span data-ttu-id="a211d-162">Настройка задания очистки</span><span class="sxs-lookup"><span data-stu-id="a211d-162">Cleanup Job Customization</span></span>  
 <span data-ttu-id="a211d-163">В задании очистки присутствует возможность настройки стратегии, определяющей, какие из записей таблиц изменений подлежат удалению.</span><span class="sxs-lookup"><span data-stu-id="a211d-163">For the cleanup job, the possibility for customization is in the strategy used to determine which change table entries are to be discarded.</span></span> <span data-ttu-id="a211d-164">В передаваемом задании очистки поддерживается только основанная на времени стратегия.</span><span class="sxs-lookup"><span data-stu-id="a211d-164">The only supported strategy in the delivered cleanup job is a time-based one.</span></span> <span data-ttu-id="a211d-165">В данной ситуации новое значение нижнего предела вычисляется методом вычитания допустимого срока хранения из времени фиксации последней обработанной транзакции.</span><span class="sxs-lookup"><span data-stu-id="a211d-165">In that situation, the new low watermark is computed by subtracting the allowed retention period from the commit time of the last transaction processed.</span></span> <span data-ttu-id="a211d-166">Поскольку лежащие в основе процедуры очистки используют вместо времени номера `lsn`, для определения наименьшего сохраняемого в таблицах изменений номера `lsn` может использоваться любое число стратегий.</span><span class="sxs-lookup"><span data-stu-id="a211d-166">Because the underlying cleanup procedures are based on `lsn` instead of time, any number of strategies can be used to determine the smallest `lsn` to keep in the change tables.</span></span> <span data-ttu-id="a211d-167">Только часть из этих стратегий являются полностью основанными на времени.</span><span class="sxs-lookup"><span data-stu-id="a211d-167">Only some of these are strictly time-based.</span></span> <span data-ttu-id="a211d-168">Сведения о клиентах, например, могут быть использованы для обеспечения предохранительных мер на тот случай, если не удастся запустить последующие процессы, которым необходим доступ к таблицам изменений.</span><span class="sxs-lookup"><span data-stu-id="a211d-168">Knowledge about the clients, for example, could be used to provide a failsafe if downstream processes that require access to the change tables cannot run.</span></span> <span data-ttu-id="a211d-169">Хотя в стратегии по умолчанию для очистки таблиц изменений всех баз данных используется один и тот же номер `lsn`, для выполнения очистки на уровне экземпляра системы отслеживания также можно вызвать процедуру очистки на уровне экземпляра отслеживания.</span><span class="sxs-lookup"><span data-stu-id="a211d-169">Also, although the default strategy applies the same `lsn` to clean up all the databases' change tables, the underlying cleanup procedure, can also be called to clean up at the capture instance level.</span></span>  
  
##  <a name="monitor-the-change-data-capture-process"></a><a name="Monitor"></a> <span data-ttu-id="a211d-170">Наблюдение за процессом отслеживания измененных данных</span><span class="sxs-lookup"><span data-stu-id="a211d-170">Monitor the Change Data Capture Process</span></span>  
 <span data-ttu-id="a211d-171">Наблюдение за процессом отслеживания измененных данных позволяет определить, правильно ли записываются изменения и насколько приемлема задержка при записи в таблицы изменений.</span><span class="sxs-lookup"><span data-stu-id="a211d-171">Monitoring the change data capture process lets you determine if changes are being written correctly and with a reasonable latency to the change tables.</span></span> <span data-ttu-id="a211d-172">Наблюдение также помогает выявить возможные ошибки.</span><span class="sxs-lookup"><span data-stu-id="a211d-172">Monitoring can also help you to identify any errors that might occur.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="a211d-173">включает два динамических представления управления, которые помогают отслеживать фиксацию измененных данных: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) и [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span><span class="sxs-lookup"><span data-stu-id="a211d-173">includes two dynamic management views to help you monitor change data capture: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) and [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span></span>  
  
### <a name="identify-sessions-with-empty-result-sets"></a><span data-ttu-id="a211d-174">Выявление сеансов с пустыми результирующими наборами</span><span class="sxs-lookup"><span data-stu-id="a211d-174">Identify Sessions with Empty Result Sets</span></span>  
 <span data-ttu-id="a211d-175">Каждая строка в административном представлении sys.dm_cdc_log_scan_sessions представляет сеанс просмотра журнала (за исключением строки с идентификатором 1).</span><span class="sxs-lookup"><span data-stu-id="a211d-175">Every row in sys.dm_cdc_log_scan_sessions represents a log scan session (except the row with an ID of 0).</span></span> <span data-ttu-id="a211d-176">Сеанс просмотра журнала является эквивалентом одного выполнения хранимой процедуры [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a211d-176">A log scan session is equivalent to one execution of [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span></span> <span data-ttu-id="a211d-177">Во время сеанса просмотр может возвратить изменения или пустой результат.</span><span class="sxs-lookup"><span data-stu-id="a211d-177">During a session, the scan can either return changes or return an empty result.</span></span> <span data-ttu-id="a211d-178">Если результирующий набор пуст, то для столбца empty_scan_count в представлении sys.dm_cdc_log_scan_sessions устанавливается значение 1.</span><span class="sxs-lookup"><span data-stu-id="a211d-178">If the result set is empty, the empty_scan_count column in sys.dm_cdc_log_scan_sessions is set to 1.</span></span> <span data-ttu-id="a211d-179">Если пустые результирующие наборы встречаются последовательно (например, при непрерывном выполнении задания отслеживания), то счетчик empty_scan_count в последней существующей строке увеличивается.</span><span class="sxs-lookup"><span data-stu-id="a211d-179">If there are consecutive empty result sets, such as if the capture job is running continuously, the empty_scan_count in the last existing row is incremented.</span></span> <span data-ttu-id="a211d-180">Например, если в представлении sys.dm_cdc_log_scan_sessions уже существует 10 строк просмотров, возвративших данные об изменениях, и пять результатов подряд были пусты, то в представлении будет содержаться 11 строк.</span><span class="sxs-lookup"><span data-stu-id="a211d-180">For example, if sys.dm_cdc_log_scan_sessions already contains 10 rows for scans that returned changes and there are five empty results in a row, the view contains 11 rows.</span></span> <span data-ttu-id="a211d-181">В столбце empty_scan_count последней строки содержится значение 5.</span><span class="sxs-lookup"><span data-stu-id="a211d-181">The last row has a value of 5 in the empty_scan_count column.</span></span> <span data-ttu-id="a211d-182">Чтобы определить сеансы, возвратившие пустой результирующий набор, выполните следующий запрос.</span><span class="sxs-lookup"><span data-stu-id="a211d-182">To determine sessions that had an empty scan, run the following query:</span></span>  
  
```sql
SELECT * from sys.dm_cdc_log_scan_sessions where empty_scan_count <> 0
```
  
### <a name="determine-latency"></a><span data-ttu-id="a211d-183">Определение задержки</span><span class="sxs-lookup"><span data-stu-id="a211d-183">Determine Latency</span></span>  
 <span data-ttu-id="a211d-184">В административное представление sys.dm_cdc_log_scan_sessions включен столбец, записывающий задержку для каждого сеанса отслеживания.</span><span class="sxs-lookup"><span data-stu-id="a211d-184">The sys.dm_cdc_log_scan_sessions management view includes a column that records the latency for each capture session.</span></span> <span data-ttu-id="a211d-185">Задержка представляет собой время, прошедшее между фиксацией транзакции в исходной таблице и фиксацией последней отслеженной транзакции в таблицу изменений.</span><span class="sxs-lookup"><span data-stu-id="a211d-185">Latency is defined as the elapsed time between a transaction being committed on a source table and the last captured transaction being committed on the change table.</span></span> <span data-ttu-id="a211d-186">Столбец задержки заполняется только для активных сеансов.</span><span class="sxs-lookup"><span data-stu-id="a211d-186">The latency column is populated only for active sessions.</span></span> <span data-ttu-id="a211d-187">У сеансов, значение в столбце empty_scan_count для которых больше 0, для столбца задержки устанавливается значение 0.</span><span class="sxs-lookup"><span data-stu-id="a211d-187">For sessions with a value greater than 0 in the empty_scan_count column, the latency column is set to 0.</span></span> <span data-ttu-id="a211d-188">Следующий запрос возвращает среднее время задержки для наиболее новых сеансов.</span><span class="sxs-lookup"><span data-stu-id="a211d-188">The following query returns the average latency for the most recent sessions:</span></span>  
  
```sql
SELECT latency FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
 <span data-ttu-id="a211d-189">Данные о задержках можно использовать для определения того, насколько быстро или медленно процесс отслеживания обрабатывает транзакции.</span><span class="sxs-lookup"><span data-stu-id="a211d-189">You can use latency data to determine how fast or slow the capture process is processing transactions.</span></span> <span data-ttu-id="a211d-190">Эти данные наиболее полезны в том случае, если процесс отслеживания выполняется непрерывно.</span><span class="sxs-lookup"><span data-stu-id="a211d-190">This data is most useful when the capture process is running continuously.</span></span> <span data-ttu-id="a211d-191">Если процесс отслеживания выполняется по расписанию, то задержка может быть высокой, ввиду запаздывания между фиксацией транзакций в исходной таблице и выполнением процесса отслеживания по его расписанию.</span><span class="sxs-lookup"><span data-stu-id="a211d-191">If the capture process is running on a schedule, latency can be high because of the lag between transactions being committed on the source table and the capture process running at its scheduled time.</span></span>  
  
 <span data-ttu-id="a211d-192">Еще одним важным показателем эффективности процесса отслеживания является пропускная способность.</span><span class="sxs-lookup"><span data-stu-id="a211d-192">Another important measure of capture process efficiency is throughput.</span></span> <span data-ttu-id="a211d-193">Это среднее число команд в секунду, обрабатываемых в каждом сеансе.</span><span class="sxs-lookup"><span data-stu-id="a211d-193">This is the average number of commands per second that are processed during each session.</span></span> <span data-ttu-id="a211d-194">Для определения пропускной способности сеанса следует разделить значение в столбце command_count column на значение в столбце продолжительности.</span><span class="sxs-lookup"><span data-stu-id="a211d-194">To determine the throughput of a session, divide the value in the command_count column by the value in the duration column.</span></span> <span data-ttu-id="a211d-195">Следующий запрос возвращает среднюю пропускную способность для наиболее новых сеансов.</span><span class="sxs-lookup"><span data-stu-id="a211d-195">The following query returns the average throughput for the most recent sessions:</span></span>  
  
```sql
SELECT command_count/duration AS [Throughput] FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
### <a name="use-data-collector-to-collect-sampling-data"></a><span data-ttu-id="a211d-196">Получение выборки данных с помощью сборщика данных</span><span class="sxs-lookup"><span data-stu-id="a211d-196">Use Data Collector to Collect Sampling Data</span></span>  
 <span data-ttu-id="a211d-197">Сборщик данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] позволяет осуществлять сбор моментальных снимков из любой таблицы или динамического административного представления и создать хранилище данных о производительности.</span><span class="sxs-lookup"><span data-stu-id="a211d-197">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data collector lets you collect snapshots of data from any table or dynamic management view and build a performance data warehouse.</span></span> <span data-ttu-id="a211d-198">Если для базы данных активирована система отслеживания измененных данных, то полезно создавать снимки представлений sys.dm_cdc_log_scan_sessions и sys.dm_cdc_errors с регулярными интервалами для последующего анализа.</span><span class="sxs-lookup"><span data-stu-id="a211d-198">When change data capture is enabled on a database, it is useful to take snapshots of the sys.dm_cdc_log_scan_sessions view and the sys.dm_cdc_errors view at regular intervals for later analysis.</span></span> <span data-ttu-id="a211d-199">Следующая процедура настраивает сборщик данных на сбор образцов данных из административного представления sys.dm_cdc_log_scan_sessions.</span><span class="sxs-lookup"><span data-stu-id="a211d-199">The following procedure sets up a data collector for collecting sample data from the sys.dm_cdc_log_scan_sessions management view.</span></span>  
  
 <span data-ttu-id="a211d-200">**Настройка сбора данных**</span><span class="sxs-lookup"><span data-stu-id="a211d-200">**Configuring Data Collection**</span></span>  
  
1.  <span data-ttu-id="a211d-201">Включите сборщик данных и настройте хранилище данных управления.</span><span class="sxs-lookup"><span data-stu-id="a211d-201">Enable data collector and configure a management data warehouse.</span></span> <span data-ttu-id="a211d-202">Дополнительные сведения см. в разделе [Управление сбором данных](../data-collection/data-collection.md).</span><span class="sxs-lookup"><span data-stu-id="a211d-202">For more information, see [Manage Data Collection](../data-collection/data-collection.md).</span></span>  
  
2.  <span data-ttu-id="a211d-203">Выполните следующий код для создания пользовательского сборщика для отслеживания измененных данных.</span><span class="sxs-lookup"><span data-stu-id="a211d-203">Execute the following code to create a custom collector for change data capture.</span></span>  
  
    ```sql  
    USE msdb;  
  
    DECLARE @schedule_uid uniqueidentifier;  
  
    -- Collect and upload data every 5 minutes  
    SELECT @schedule_uid = (  
    SELECT schedule_uid from sysschedules_localserver_view   
    WHERE name = N'CollectorSchedule_Every_5min')  
  
    DECLARE @collection_set_id int;  
  
    EXEC dbo.sp_syscollector_create_collection_set  
    @name = N' CDC Performance Data Collector',  
    @schedule_uid = @schedule_uid,          
    @collection_mode = 0,                   
    @days_until_expiration = 30,                
    @description = N'This collection set collects CDC metadata',  
    @collection_set_id = @collection_set_id output;  
  
    -- Create a collection item using statistics from   
    -- the change data capture dynamic management view.  
    DECLARE @parameters xml;  
    DECLARE @collection_item_id int;  
  
    SELECT @parameters = CONVERT(xml,   
        N'<TSQLQueryCollector>  
            <Query>  
              <Value>SELECT * FROM sys.dm_cdc_log_scan_sessions</Value>  
              <OutputTable>cdc_log_scan_data</OutputTable>  
            </Query>  
          </TSQLQueryCollector>');  
  
    EXEC dbo.sp_syscollector_create_collection_item  
    @collection_set_id = @collection_set_id,  
    @collector_type_uid = N'302E93D1-3424-4BE7-AA8E-84813ECF2419',  
    @name = ' CDC Performance Data Collector',  
    @frequency = 5,   
    @parameters = @parameters,  
    @collection_item_id = @collection_item_id output;  
  
    GO  
    ```  
  
3.  <span data-ttu-id="a211d-204">В среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]разверните вкладку **Управление**, затем вкладку **Сбор данных**.</span><span class="sxs-lookup"><span data-stu-id="a211d-204">In [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], expand **Management**, and then expand **Data Collection**.</span></span> <span data-ttu-id="a211d-205">Щелкните правой кнопкой мыши пункт **Сборщик данных о производительности CDC**, затем пункт **Запустить набор сбора данных**.</span><span class="sxs-lookup"><span data-stu-id="a211d-205">Right click **CDC Performance Data Collector**, and then click **Start Data Collection Set**.</span></span>  
  
4.  <span data-ttu-id="a211d-206">В хранилище данных, которое было настроено в шаге 1, найдите таблицу custom_snapshots.cdc_log_scan_data.</span><span class="sxs-lookup"><span data-stu-id="a211d-206">In the data warehouse you configured in step 1, locate the table custom_snapshots.cdc_log_scan_data.</span></span> <span data-ttu-id="a211d-207">В данной таблице предоставлен архивный моментальный снимок данных из сеансов просмотра журнала.</span><span class="sxs-lookup"><span data-stu-id="a211d-207">This table provides a historical snapshot of data from log scan sessions.</span></span> <span data-ttu-id="a211d-208">Эти данные могут быть использованы для анализа задержки, пропускной способности и других показателей производительности во времени.</span><span class="sxs-lookup"><span data-stu-id="a211d-208">This data can be used to analyze latency, throughput, and other performance measures over time.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a211d-209">См. также:</span><span class="sxs-lookup"><span data-stu-id="a211d-209">See Also</span></span>  
 <span data-ttu-id="a211d-210">[Отслеживание измененных данных (SQL Server)](track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="a211d-210">[Track Data Changes &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span></span>  
 <span data-ttu-id="a211d-211">[О фиксации измененных данных (SQL Server)](../track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="a211d-211">[About Change Data Capture &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="a211d-212">[Включение и отключение отслеживания измененных данных (SQL Server)](enable-and-disable-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="a211d-212">[Enable and Disable Change Data Capture &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span></span>  
 [<span data-ttu-id="a211d-213">Работа с информацией об изменениях (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="a211d-213">Work with Change Data &#40;SQL Server&#41;</span></span>](work-with-change-data-sql-server.md)  
  
  
