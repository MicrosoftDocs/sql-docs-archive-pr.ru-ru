---
title: Использование зеркального отображения базы данных | Документация Майкрософт
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- database mirroring [SQL Server], interoperability
- SQL Server Native Client, database mirroring
- data access [SQL Server Native Client], database mirroring
- database mirroring [SQL Server], connecting clients to
- SQLNCLI, database mirroring
- SQL Server Native Client ODBC driver, database mirroring
- SQL Server Native Client OLE DB provider, database mirroring
ms.assetid: 71b15712-7972-4465-9274-e0ddc271eedc
author: rothja
ms.author: jroth
ms.openlocfilehash: 389036322137abcc9a40e36c697e8d45e39a7de5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87656370"
---
# <a name="using-database-mirroring"></a><span data-ttu-id="6f0cc-102">Использование зеркального отображения базы данных</span><span class="sxs-lookup"><span data-stu-id="6f0cc-102">Using Database Mirroring</span></span>
    
> [!NOTE]  
>  [!INCLUDE[ssNoteDepFutureAvoid](../../../includes/ssnotedepfutureavoid-md.md)] <span data-ttu-id="6f0cc-103">Вместо этого используйте [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span><span class="sxs-lookup"><span data-stu-id="6f0cc-103">Use [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] instead.</span></span>  
  
 <span data-ttu-id="6f0cc-104">Зеркальное отображение базы данных, впервые представленное в [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], — это решение, предназначенное для повышения доступности баз данных и избыточности данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-104">Database mirroring, introduced in [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], is a solution for increasing database availability and data redundancy.</span></span> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="6f0cc-105">Собственный клиент обеспечивает неявную поддержку зеркального отображения базы данных, поэтому разработчику не нужно писать код или предпринимать другие действия после его настройки для базы данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-105">Native Client provides implicit support for database mirroring, so the developer does not need to write any code or take any other action once it has been configured for the database.</span></span>  
  
 <span data-ttu-id="6f0cc-106">Зеркальное отображение базы данных, реализованное отдельно для каждой базы данных, хранит копию рабочей базы данных [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на резервном сервере.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-106">Database mirroring, which is implemented on a per-database basis, keeps a copy of a [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] production database on a standby server.</span></span> <span data-ttu-id="6f0cc-107">Это или «горячий», или «теплый» резервный сервер, в зависимости от конфигурации и состояния сеанса зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-107">This server is either a hot or warm standby server, depending on the configuration and state of the database mirroring session.</span></span> <span data-ttu-id="6f0cc-108">Сервер горячей замены поддерживает быструю отработку отказа без потери зафиксированных транзакций, а «горячий» резервный сервер поддерживает принудительное обслуживание (с возможной потерей данных).</span><span class="sxs-lookup"><span data-stu-id="6f0cc-108">A hot standby server supports rapid failover with no loss of committed transactions, and a warm standby server supports forcing service (with possible data loss).</span></span>  
  
 <span data-ttu-id="6f0cc-109">Рабочая база данных называется *основной базой*данных, а резервная копия называется *зеркальной базой данных*.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-109">The production database is called the *principal database*, and the standby copy is called the *mirror database*.</span></span> <span data-ttu-id="6f0cc-110">Основная и зеркальная базы данных должны находиться в разных экземплярах [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (экземплярах сервера), а по возможности — и на разных компьютерах.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-110">The principal database and mirror database must reside on separate instances of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (server instances), and they should reside on separate computers if possible.</span></span>  
  
 <span data-ttu-id="6f0cc-111">Рабочий экземпляр сервера называется *основным сервером*. Он соединен с резервным экземпляром сервера, который называется *зеркальным сервером*.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-111">The production server instance, called the *principal server*, communicates with the standby server instance, called the *mirror server*.</span></span> <span data-ttu-id="6f0cc-112">Основной и зеркальный серверы действуют как партнеры в *сеансе*зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-112">The principal and mirror servers act as partners within a database mirroring *session*.</span></span> <span data-ttu-id="6f0cc-113">Если основной сервер дает сбой, зеркальный сервер делает свою базу данных основной с помощью процесса, который называется *отработкой отказа*.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-113">If the principal server fails, the mirror server can make its database into the principal database through a process called *failover*.</span></span> <span data-ttu-id="6f0cc-114">Например, имеется два сервера-участника, Partner_A and Partner_B, при этом основная база данных изначально находится на сервере Partner_A (основной сервер), а зеркальная база данных — на сервере Partner_B (зеркальный сервер).</span><span class="sxs-lookup"><span data-stu-id="6f0cc-114">For example, Partner_A and Partner_B are two partner servers, with the principal database initially on Partner_A as principal server, and the mirror database residing on Partner_B as the mirror server.</span></span> <span data-ttu-id="6f0cc-115">Если сервер Partner_A переходит в режим вне сети, база данных на сервере Partner_B становится текущей основной базой данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-115">If Partner_A goes offline, the database on Partner_B can fail over to become the current principal database.</span></span> <span data-ttu-id="6f0cc-116">Когда сервер Partner_A возвращается в сеанс зеркального отображения, он становится зеркальным сервером, а его база данных — зеркальной базой данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-116">When Partner_A rejoins the mirroring session, it becomes the mirror server and its database becomes the mirror database.</span></span>  
  
 <span data-ttu-id="6f0cc-117">Другие конфигурации зеркального отображения баз данных имеют разные уровни производительности и безопасности данных, а также поддерживают разные формы отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-117">Alternative database mirroring configurations offer different levels of performance and data safety, and support different forms of failover.</span></span> <span data-ttu-id="6f0cc-118">Дополнительные сведения см. в разделе [Зеркальное отображение базы данных (SQL Server)](../../../database-engine/database-mirroring/database-mirroring-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="6f0cc-118">For more information, see [Database Mirroring &#40;SQL Server&#41;](../../../database-engine/database-mirroring/database-mirroring-sql-server.md).</span></span>  
  
 <span data-ttu-id="6f0cc-119">При указании имен зеркальных баз данных можно использовать псевдонимы.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-119">It is possible to use an alias when specifying the mirror database name.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6f0cc-120">Дополнительные сведения о начальных попытках соединения и повторного соединения к зеркальной базе данных см. в статье [Подключение клиентов к сеансу зеркального отображения базы данных (SQL Server)](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="6f0cc-120">For information about initial connection attempts and reconnection attempts to a mirrored database, see [Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md).</span></span>  
  
## <a name="programming-considerations"></a><span data-ttu-id="6f0cc-121">Замечания по программированию</span><span class="sxs-lookup"><span data-stu-id="6f0cc-121">Programming Considerations</span></span>  
 <span data-ttu-id="6f0cc-122">Если сервер, на котором размещается основная база данных, дает сбой, в ответ на вызовы API клиентское приложение получает ошибки, которые указывают на потерю соединения с базой данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-122">When the principal database server fails, the client application receives errors in response to API calls, which indicate that the connection to the database has been lost.</span></span> <span data-ttu-id="6f0cc-123">Если это происходит, все незафиксированные изменения в базе данных теряются и выполняется откат текущей транзакции.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-123">When this happens, any uncommitted changes to the database are lost and the current transaction is rolled back.</span></span> <span data-ttu-id="6f0cc-124">При этом приложение должно закрыть соединение (или освободить объект источника данных) и вновь его открыть.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-124">If this occurs, the application should close the connection (or release the data source object) and re-open it.</span></span> <span data-ttu-id="6f0cc-125">Соединение прозрачно перенаправляется на зеркальную базу данных, которая к этому моменту выступает в роли основного сервера.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-125">The connection is transparently re-directed to the mirror database, which now acts as the principal server.</span></span>  
  
 <span data-ttu-id="6f0cc-126">Когда соединение восстанавливается, основной сервер отправляет клиенту идентификационные данные партнера по обеспечению отработки отказа, который должен использоваться при отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-126">When a connection is established, the principal server sends the identity of its failover partner to the client to be used when failover occurs.</span></span> <span data-ttu-id="6f0cc-127">Когда приложение пытается установить соединение после сбоя основного сервера, клиент не знает идентификационных данных партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-127">Where an application tried to establish a connection after the principal server failed, the client does not know the identity of the failover partner.</span></span> <span data-ttu-id="6f0cc-128">Чтобы дать клиенту возможность справиться с этой ситуацией, свойство инициализации и связанное с ним ключевое слово строки соединения позволяют клиенту самому определить удостоверение партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-128">To allow clients the opportunity to cope with this scenario, an initialization property and an associated connection string keyword allow the client to specify the identity of the failover partner on its own.</span></span> <span data-ttu-id="6f0cc-129">Атрибут клиента используется только в этом сценарии. Если основной сервер доступен, он не применяется.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-129">The client attribute is used only in this scenario; if the principal server is available, it is not used.</span></span> <span data-ttu-id="6f0cc-130">Если сервер-партнер по обеспечению отработки отказа, предоставленный клиентом, не играет роль партнера по обеспечению отработки отказа, в соединении будет отказано.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-130">If the failover partner server supplied by the client does not refer to a server acting as a failover partner, the connection is refused by the server.</span></span> <span data-ttu-id="6f0cc-131">Чтобы дать приложениям возможность адаптироваться к изменениям конфигурации, идентификационные данные фактического партнера по обеспечению отработки отказа определяются по атрибуту после установки соединения.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-131">To allow applications to adapt to configuration changes, the identity of the actual failover partner can be determined by inspecting the attribute after the connection has been established.</span></span> <span data-ttu-id="6f0cc-132">Необходимо предусмотреть кэширование сведений об участнике для обновления строки соединения или разработать способ повторной попытки соединения, если первая попытка завершится неудачей.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-132">You should consider caching the partner information to update the connection string or devise a retry strategy in the event that the first attempt at making a connection fails.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6f0cc-133">Следует явно задать базу данных, которая будет использоваться в соединении, если эту возможность нужно использовать в DSN-именах, строке соединения, свойстве или атрибуте соединения.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-133">You must explicitly specify the database to be used by a connection if you want to use this feature in a DSN, connection string, or connection property/attribute.</span></span> <span data-ttu-id="6f0cc-134">Если этого не сделать, собственный клиент [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] не будет пытаться отработать отказ базы данных-участника. </span><span class="sxs-lookup"><span data-stu-id="6f0cc-134">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client will not attempt to failover to the partner database if this is not done.</span></span>  
>   
>  <span data-ttu-id="6f0cc-135">Зеркальное отображение является функциональностью базы данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-135">Mirroring is a feature of the database.</span></span> <span data-ttu-id="6f0cc-136">Приложения, работающие с несколькими базами данных, возможно, не смогут применить эту функциональность. </span><span class="sxs-lookup"><span data-stu-id="6f0cc-136">Applications that use multiple databases might not be able to exploit this feature.</span></span>  
>   
>  <span data-ttu-id="6f0cc-137">Кроме того, в именах сервера не учитывается регистр клавиатуры, но имена баз данных зависят от регистра клавиатуры.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-137">In addition, server names are case insensitive, but database names are case sensitive.</span></span> <span data-ttu-id="6f0cc-138">Поэтому следует убедиться, что в DSN-именах и строках соединения используются символы с одинаковым регистром.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-138">You should therefore make sure that you use the same casing in DSNs and connection strings.</span></span>  
  
## <a name="sql-server-native-client-ole-db-provider"></a><span data-ttu-id="6f0cc-139">Поставщик OLE DB для собственного клиента SQL Server</span><span class="sxs-lookup"><span data-stu-id="6f0cc-139">SQL Server Native Client OLE DB Provider</span></span>  
 <span data-ttu-id="6f0cc-140">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Поставщик собственного клиента OLE DB поддерживает зеркальное отображение базы данных через атрибуты соединения и строки подключения.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-140">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports database mirroring through connection and connection string attributes.</span></span> <span data-ttu-id="6f0cc-141">К набору свойств DBPROPSET_SQLSERVERDBINIT было добавлено свойство SSPROP_INIT_FAILOVERPARTNER, а ключевое слово `FailoverPartner` является новым атрибутом строки соединения для DBPROP_INIT_PROVIDERSTRING.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-141">The SSPROP_INIT_FAILOVERPARTNER property has been added to the DBPROPSET_SQLSERVERDBINIT property set, and the `FailoverPartner` keyword is a new connection string attribute for DBPROP_INIT_PROVIDERSTRING.</span></span> <span data-ttu-id="6f0cc-142">Дополнительные сведения см. в разделе [Использование ключевых слов строки подключения с SQL Server Native Client](../applications/using-connection-string-keywords-with-sql-server-native-client.md).</span><span class="sxs-lookup"><span data-stu-id="6f0cc-142">For more information, see [Using Connection String Keywords with SQL Server Native Client](../applications/using-connection-string-keywords-with-sql-server-native-client.md).</span></span>  
  
 <span data-ttu-id="6f0cc-143">Кэш отработки отказа поддерживается при условии, что поставщик загружен, то есть до вызова **CoUninitialize** или пока приложение имеет ссылку на некоторый объект, управляемый [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] поставщиком OLE DB собственного клиента, например объект источника данных.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-143">The failover cache is maintained as long as the provider is loaded, which is until **CoUninitialize** is called or as long as the application has a reference to some object managed by the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider such as a data source object.</span></span>  
  
 <span data-ttu-id="6f0cc-144">Дополнительные сведения о [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] поддержке собственного клиента OLE DB поставщика зеркального отображения базы данных см. в разделе [Свойства инициализации и авторизации](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md).</span><span class="sxs-lookup"><span data-stu-id="6f0cc-144">For details about [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider support for database mirroring, see [Initialization and Authorization Properties](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md).</span></span>  
  
## <a name="sql-server-native-client-odbc-driver"></a><span data-ttu-id="6f0cc-145">Драйвер ODBC для собственного клиента SQL Server</span><span class="sxs-lookup"><span data-stu-id="6f0cc-145">SQL Server Native Client ODBC Driver</span></span>  
 <span data-ttu-id="6f0cc-146">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Драйвер ODBC для собственного клиента поддерживает зеркальное отображение базы данных через соединения и атрибуты строки подключения.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-146">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver supports database mirroring through connection and connection string attributes.</span></span> <span data-ttu-id="6f0cc-147">В частности, добавлен атрибут SQL_COPT_SS_FAILOVER_PARTNER для использования с функциями [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md) и [SQLGetConnectAttr](../../native-client-odbc-api/sqlgetconnectattr.md) . и `Failover_Partner` ключевое слово было добавлено в качестве нового атрибута строки подключения.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-147">Specifically, the SQL_COPT_SS_FAILOVER_PARTNER attribute has been added for use with the [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md) and [SQLGetConnectAttr](../../native-client-odbc-api/sqlgetconnectattr.md) functions; and the `Failover_Partner` keyword has been added as a new connection string attribute.</span></span>  
  
 <span data-ttu-id="6f0cc-148">Кэш отработки отказа хранится, пока в приложении имеется хотя бы один дескриптор среды.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-148">The failover cache is maintained as long as the application has at least one environment handle allocated.</span></span> <span data-ttu-id="6f0cc-149">Он теряется при освобождении дескриптора среды.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-149">Conversely, it is lost when the last environment handle is deallocated.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6f0cc-150">Диспетчер драйвера ODBC улучшен для поддержки спецификации имени сервера отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="6f0cc-150">The ODBC Driver Manager has been enhanced to support the specification of the failover server name.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="6f0cc-151">См. также:</span><span class="sxs-lookup"><span data-stu-id="6f0cc-151">See Also</span></span>  
 <span data-ttu-id="6f0cc-152">[Компоненты собственного клиента SQL Server](sql-server-native-client-features.md) </span><span class="sxs-lookup"><span data-stu-id="6f0cc-152">[SQL Server Native Client Features](sql-server-native-client-features.md) </span></span>  
 <span data-ttu-id="6f0cc-153">[Подключение клиентов к сеансу зеркального отображения базы данных (SQL Server)](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6f0cc-153">[Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md) </span></span>  
 [<span data-ttu-id="6f0cc-154">Зеркальное отображение базы данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="6f0cc-154">Database Mirroring &#40;SQL Server&#41;</span></span>](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)  
  
  
