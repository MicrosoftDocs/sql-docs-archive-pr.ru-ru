---
title: Поддержка имени субъекта-службы в клиентских соединениях | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client, SPNs
- ODBC, SPNs
- OLE DB, SPNs
- SPNs [SQL Server]
ms.assetid: 96598c69-ce9a-4090-aacb-d546591e8af7
author: rothja
ms.author: jroth
ms.openlocfilehash: 10a64baa17bd070d9354beaf6ff8c2e460682318
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87656378"
---
# <a name="service-principal-name-spn-support-in-client-connections"></a>Поддержка имени участника-службы в клиентских соединениях
  Начиная с [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] поддержка имен субъектов-служб была расширена для поддержки взаимной проверки подлинности во всех протоколах. В предыдущих версиях [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] имена субъектов-служб поддерживались только для протокола Kerberos через TCP, когда имя по умолчанию для экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] было зарегистрировано в Active Directory.  
  
 Имена субъектов-служб используются протоколом проверки подлинности для определения учетной записи, от которой запускается экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Если учетная запись экземпляра известна, то можно использовать проверку подлинности Kerberos для взаимной проверки подлинности клиентом и сервером. Если учетная запись экземпляра неизвестна, то используется только проверка подлинности NTLM, которая обеспечивает проверку подлинности клиента сервером. В настоящее время собственный клиент [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] выполняет преобразование проверки подлинности, получая имя участника-службы из имени экземпляра и свойств сетевого подключения. Экземпляры [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] попытаются зарегистрировать имена субъектов-служб при запуске, но их можно также зарегистрировать вручную. Однако регистрация завершится ошибкой, если учетная запись, которая пытается зарегистрировать имена участников-служб, не имеет достаточных прав доступа.  
  
 Учетные записи домена и компьютера автоматически регистрируются в Active Directory. Их можно использовать в качестве имен участников-служб, или же администраторы могут определить собственные имена участников-служб. В [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] безопасная проверка подлинности стала более управляемой и надежной благодаря возможности для клиента напрямую указывать используемое имя субъекта-службы.  
  
> [!NOTE]  
>  Указанное клиентским приложением имя участника-службы используется только в том случае, если соединение устанавливается с использованием встроенной безопасности Windows.  
  
> [!TIP]  
>  **[!INCLUDE[msCoName](../../../includes/msconame-md.md)] диспетчер конфигурации Kerberos для [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]** — это диагностическое средство, которое помогает расследовать проблемы Kerberos со связью при использовании [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Дополнительные сведения см. в разделе [Диспетчер конфигурации Microsoft Kerberos для SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).  
  
> [!TIP]  
>  **[!INCLUDE[msCoName](../../../includes/msconame-md.md)] диспетчер конфигурации Kerberos для [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]** — это диагностическое средство, которое помогает расследовать проблемы Kerberos со связью при использовании [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Дополнительные сведения см. в разделе [Диспетчер конфигурации Microsoft Kerberos для SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).  
  
 Дополнительные сведения о протоколе Kerberos см. в следующих статьях.  
  
-   [Kerberos Technical Supplement for Windows](https://go.microsoft.com/fwlink/?LinkId=101449)  
  
-   [Microsoft Kerberos](https://go.microsoft.com/fwlink/?LinkID=100758)  
  
## <a name="usage"></a>Использование  
 В следующей таблице описаны наиболее типичные сценарии, в которых клиентские приложения могут включить безопасную проверку подлинности.  
  
|Сценарий|Описание|  
|--------------|-----------------|  
|Приложение прежней версии не указывает имя участника-службы.|Этот сценарий совместимости гарантирует, что не будет изменений в работе приложений, разработанных для предыдущих версий [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Если имя участника-службы не указано, то приложение использует сформированные имена участников-служб и ничего не знает об используемом методе проверки подлинности.|  
|Клиентское приложение, использующее текущую версию собственного клиента [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , указывает имя участника-службы в строке соединения как учетную запись пользователя домена или компьютера, определяемое экземпляром имя участника-службы или определяемую пользователем строку.|Ключевое слово `ServerSPN` может быть указано в строке поставщика, инициализации или соединения, для следующих целей.<br /><br /> — Укажите учетную запись, используемую [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляром для соединения. Это упрощает доступ к проверке подлинности Kerberos. Если имеется центр распространения ключей Kerberos (KDC) и указана верная учетная запись, то проверка подлинности Kerberos будет предпочтительнее, чем NTLM. KDC обычно размещается на том же компьютере, что и контроллер домена.<br />— Укажите имя субъекта-службы для поиска учетной записи службы для [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляра. Для каждого экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] создаются два имени субъекта-службы по умолчанию, которые могут быть использованы для этой цели. Однако эти ключи не обязательно будут созданы в Active Directory, поэтому в такой ситуации проверка подлинности Kerberos не гарантирована.<br />— Укажите имя субъекта-службы, которое будет использоваться для поиска учетной записи службы для [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляра. Это может быть любая определенная пользователем строка, сопоставляемая с учетной записью службы. В этом случае ключ должен быть вручную зарегистрирован в центре распространения ключей и удовлетворять правилам для определенных пользователем имен участников-служб.<br /><br /> Ключевое слово `FailoverPartnerSPN` указывает имя партнера-службы для сервера-партнера по обеспечению отработки отказа. Ранг учетной записи и ключевые значения Active Directory те же, что и значения, которые можно указать для основного сервера.|  
|Приложение ODBC указывает имя партнера-службы как атрибут соединения для основного сервера или сервера-партнера по обеспечению отработки отказа.|Атрибут соединения `SQL_COPT_SS_SERVER_SPN` может быть использован для указания имени участника-службы для соединения с основным сервером.<br /><br /> Атрибут соединения `SQL_COPT_SS_FAILOVER_PARTNER_SPN` может быть использован для указания имени партнера-службы для сервера-партнера по обеспечению отработки отказа.|  
|Приложение OLE DB указывает имя партнера-службы как свойство инициализации источника данных для основного сервера или сервера-партнера по обеспечению отработки отказа.|Свойство соединения `SSPROP_INIT_SERVER_SPN` в наборе свойств `DBPROPSET_SQLSERVERDBINIT` может быть использовано для указания имени участника-службы для соединения.<br /><br /> Свойство соединения `SSPROP_INIT_FAILOVER_PARTNER_SPN` в `DBPROPSET_SQLSERVERDBINIT` может быть использовано для указания имени партнера-службы для сервера-партнера по обеспечению отработки отказа.|  
|Пользователь указывает имя партнера-службы для сервера или сервера-партнера по обеспечению отработки отказа в имени источника данных (DSN) ODBC.|Имя участника-службы может быть указано в DSN ODBC через диалоговые окна настройки DSN.|  
|Пользователь указывает имя партнера-службы для сервера или сервера-партнера по обеспечению отработки отказа в диалоговом окне **Связь данных** или **Имя входа** OLE DB.|Имя участника-службы может быть указано в диалоговом окне **Связь данных** или **Имя входа** . Диалоговое окно **Имя входа** может использоваться с ODBC или OLE DB.|  
|Приложение ODBC определяет метод проверки подлинности, используемый для установления соединения.|Если соединение было установлено успешно, то приложение может запросить атрибут соединения `SQL_COPT_SS_INTEGRATED_AUTHENTICATION_METHOD`, чтобы определить, какой именно метод проверки подлинности будет использоваться. Эти значения включают `NTLM`, `Kerberos` и другие.|  
|Приложение OLE DB определяет метод проверки подлинности, используемый при установлении соединения.|Если соединение было установлено успешно, то приложение может запросить свойство соединения `SSPROP_AUTHENTICATION_METHOD` в наборе свойств `DBPROPSET_SQLSERVERDATASOURCEINFO` для определения метода проверки подлинности, который будет использоваться. Эти значения включают `NTLM`, `Kerberos` и другие.|  
  
## <a name="failover"></a>Отработка отказа  
 Имена участников-служб не хранятся в кэше отработки отказа и поэтому не могут передаваться между соединениями. Имена участников-служб будут использоваться при всех попытках установления соединения с основным и резервным сервером при указании атрибутов или строки соединения.  
  
## <a name="connection-pooling"></a>Объединение подключений в пул  
 Приложение должно учитывать, что указание имени участника-службы в некоторых, но не всех строках соединения может привести к фрагментации пула.  
  
 Приложение может программным способом указывать имена участников-служб как атрибуты соединения, а не как ключевые слова в строке соединения. Это помогает управлять фрагментацией пула соединений.  
  
 Приложение должно учитывать, что имя участника-службы в строке соединения может быть отменено назначением соответствующих атрибутов соединения, но строки соединения, используемые при организации пула соединений, будут использовать значения строк соединения для объединения в пул.  
  
## <a name="down-level-server-behavior"></a>Работа сервера низкого уровня  
 Поведение нового соединения реализуется клиентом, поэтому оно не зависит от версии [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
## <a name="linked-servers-and-delegation"></a>Связанные серверы и делегирование  
 При создании связанных серверов параметр `@provstr` хранимой процедуры [sp_addlinkedserver](/sql/relational-databases/system-stored-procedures/sp-addlinkedserver-transact-sql) можно использовать для указания имени субъекта-службы сервера и партнера по обеспечению отработки отказа. Такой подход имеет те же преимущества, что и при указании имен субъектов-служб в клиентских строках подключения, — установить подключения на основе аутентификации Kerberos проще и надежнее.  
  
 Делегирование со связанными серверами требует проверки подлинности Kerberos.  
  
## <a name="management-aspects-of-spns-specified-by-applications"></a>Аспекты управления именами участников-служб, указываемыми приложениями  
 При выборе способа задания имени участника-службы: в приложении (через строку соединений) или программно (через свойства соединений вместо имени участника-службы по умолчанию, сформированного поставщиком) следует учитывать следующие факторы.  
  
-   Безопасность. Раскрывает ли указанное имя субъекта-службы конфиденциальные сведения?  
  
-   Надежность. Чтобы обеспечить использование имен субъектов-служб по умолчанию, учетная запись службы, от которой запущен экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], должна иметь достаточные права для обновления Active Directory в центре распространения ключей.  
  
-   Удобство и прозрачность расположения. Каким образом повлияет на имена субъектов-служб приложения перемещение базы данных в другой экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]? Это относится как к основному серверу, так и его партнеру по обеспечению отработки отказа при зеркальном отображении базы данных. Если при смене сервера потребуется замена имен участников-служб, как это повлияет на приложения? Будут ли изменения управляемыми?  
  
## <a name="specifying-the-spn"></a>Указание имени участника-службы  
 Имя участника-службы может быть задано как через код, так и через диалоговые окна. В данном разделе рассматривается задание имени участника-службы.  
  
 Максимальная длина для имени участника-службы — 260 символов.  
  
 В именах участников-служб в атрибутах или строке соединения применяется следующий синтаксис.  
  
|Синтаксис|Описание|  
|------------|-----------------|  
|MSSQLSvc/*полное доменное имя*|Сформированное поставщиком имя участника-службы для экземпляра по умолчанию, когда используется протокол, отличный от TCP.<br /><br /> полное *доменное имя является полным* доменным именем.|  
|MSSQLSvc/*fqdn*:*port*|Сформированное поставщиком имя участника-службы для экземпляра по умолчанию, когда используется протокол TCP.<br /><br /> *port* — номер TCP-порта.|  
|MSSQLSvc/*FQDN*:*instanceName*|Сформированное поставщиком имя участника-службы (по умолчанию) для именованного экземпляра, когда используется протокол, отличный от TCP.<br /><br /> *InstanceName* — имя экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].|  
|HOST/*fqdn*<br /><br /> HOST/*MachineName*|Имя участника-службы, сопоставляемое со встроенной учетной записью компьютера, зарегистрированной в Windows автоматически.|  
|*Имя пользователя* @ *Домен*|Прямое указание учетной записи домена.<br /><br /> *Username* — имя учетной записи пользователя Windows.<br /><br /> *Domain* — имя домена Windows или полное имя домена.|  
|*MachineName* $@ *Домен*|Прямое указание учетной записи компьютера<br /><br /> (Если сервер, к которому вы подключаетесь, работает под учетной записью локальной системы или сетевой службы, для получения проверки подлинности Kerberos `ServerSPN` может использоваться *MachineName* $@ Формат*домена* MachineName.)|  
|*Кдккэй* / *MachineName*|Заданное пользователем имя участника-службы.<br /><br /> *KDCKey* — алфавитно-цифровая строка, соответствующая правилам для ключей KDC.|  
  
## <a name="odbc-and-ole-db-syntax-supporting-spns"></a>Синтаксис ODBC и OLE DB для поддержки имен участников-служб  
 Сведения о синтаксисе см. в следующих разделах.  
  
-   [Имена участника-службы (SPN) в клиентских соединениях (ODBC)](../odbc/service-principal-names-spns-in-client-connections-odbc.md)  
  
-   [Имена участника-службы (SPN) в клиентских соединениях (OLE DB)](../ole-db/service-principal-names-spns-in-client-connections-ole-db.md)  
  
 Дополнительные сведения об образцах приложений, которые демонстрируют эту функцию, см. в разделе [Образцы программирования для данных SQL Server](https://msftdpprodsamples.codeplex.com/).  
  
## <a name="see-also"></a>См. также:  
 [Компоненты собственного клиента SQL Server](sql-server-native-client-features.md)  
  
