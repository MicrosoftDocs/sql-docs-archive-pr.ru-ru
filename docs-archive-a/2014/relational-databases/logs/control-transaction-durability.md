---
title: Управление устойчивостью транзакций | Документация Майкрософт
ms.custom: ''
ms.date: 05/19/2016
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- delayed durability
- Lazy Commit
ms.assetid: 3ac93b28-cac7-483e-a8ab-ac44e1cc1c76
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: f37bcaf8719f4a2f3b1e7fbca1cf332717bd936e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658259"
---
# <a name="control-transaction-durability"></a><span data-ttu-id="19f3c-102">Управление устойчивостью транзакций</span><span class="sxs-lookup"><span data-stu-id="19f3c-102">Control Transaction Durability</span></span>
  <span data-ttu-id="19f3c-103">Фиксации транзакций[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] могут быть либо полностью устойчивыми, служба [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] по умолчанию, либо отложенными устойчивыми (также известные как отложенная запись).</span><span class="sxs-lookup"><span data-stu-id="19f3c-103">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] transaction commits can be either fully durable, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] default, or delayed durable (also known as lazy commit).</span></span>  
  
 <span data-ttu-id="19f3c-104">Полностью устойчивые фиксации транзакций являются синхронными и сообщают об успешной фиксации и возвращают управление клиенту только после записи журналов транзакций на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-104">Fully durable transaction commits are synchronous and report a commit as successful and return control to the client only after the log records for the transaction are written to disk.</span></span> <span data-ttu-id="19f3c-105">Устойчивые фиксации транзакций являются асинхронными и сообщают об успешной фиксации до записи журналов транзакций на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-105">Delayed durable transaction commits are asynchronous and report a commit as successful before the log records for the transaction are written to disk.</span></span> <span data-ttu-id="19f3c-106">Запись журнала транзакций на диск необходима, чтобы транзакция была устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-106">Writing the transaction log entries to disk is required for a transaction to be durable.</span></span> <span data-ttu-id="19f3c-107">Отложенные транзакции становятся устойчивыми после записи журнала транзакций на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-107">Delayed durable transactions become durable when the transaction log entries are flushed to disk.</span></span>  
  
 <span data-ttu-id="19f3c-108">В этом разделе описаны отложенные устойчивые транзакции.</span><span class="sxs-lookup"><span data-stu-id="19f3c-108">This topic details delayed durable transactions.</span></span>  
  
## <a name="full-vs-delayed-transaction-durability"></a><span data-ttu-id="19f3c-109">Сравнение полностью устойчивых и отложенных устойчивых транзакций</span><span class="sxs-lookup"><span data-stu-id="19f3c-109">Full vs. Delayed Transaction Durability</span></span>  
 <span data-ttu-id="19f3c-110">И полностью устойчивые, и отложенные устойчивые транзакции имеют свои преимущества и недостатки.</span><span class="sxs-lookup"><span data-stu-id="19f3c-110">Both full and delayed transaction durability have their advantages and disadvantages.</span></span> <span data-ttu-id="19f3c-111">Приложение может включать в себя и полностью устойчивые, и отложенные устойчивые транзакции.</span><span class="sxs-lookup"><span data-stu-id="19f3c-111">An application can have a mix of fully and delayed durable transactions.</span></span> <span data-ttu-id="19f3c-112">Необходимо тщательно учитывать бизнес-требования и соответствие транзакций этим требованиям.</span><span class="sxs-lookup"><span data-stu-id="19f3c-112">You should carefully consider your business needs and how each fits into those needs.</span></span>  
  
### <a name="full-transaction-durability"></a><span data-ttu-id="19f3c-113">Полная устойчивость транзакций</span><span class="sxs-lookup"><span data-stu-id="19f3c-113">Full transaction durability</span></span>  
 <span data-ttu-id="19f3c-114">Полностью устойчивые транзакции записывают журнал транзакций на диск до возвращения управления клиенту</span><span class="sxs-lookup"><span data-stu-id="19f3c-114">Fully durable transactions write the transaction log to disk before returning control to the client.</span></span> <span data-ttu-id="19f3c-115">Полностью устойчивые транзакции необходимо использовать в следующих случаях.</span><span class="sxs-lookup"><span data-stu-id="19f3c-115">You should use fully durable transactions whenever:</span></span>  
  
-   <span data-ttu-id="19f3c-116">Система не может работать при потере данных.</span><span class="sxs-lookup"><span data-stu-id="19f3c-116">Your system cannot tolerate any data loss.</span></span>   
    <span data-ttu-id="19f3c-117">См. раздел [Когда я могу потерять данные?](#when-can-i-lose-data) , чтобы узнать, когда данные могут быть потеряны.</span><span class="sxs-lookup"><span data-stu-id="19f3c-117">See the section [When can I lose data?](#when-can-i-lose-data) for information on when you can lose some of your data.</span></span>  
  
-   <span data-ttu-id="19f3c-118">Причиной возникновения проблемы не является задержка записи журналов.</span><span class="sxs-lookup"><span data-stu-id="19f3c-118">The bottleneck is not due to transaction log write latency.</span></span>  
  
 <span data-ttu-id="19f3c-119">Отложенная устойчивость транзакций уменьшает задержку операций ввода-вывода журналов за счет хранения журналов транзакций в памяти и записи данных в журналы транзакций в пакетном режиме, что требует меньшего числа операций ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="19f3c-119">Delayed transaction durability reduces the latency due to log I/O by keeping the transaction log records in memory and writing to the transaction log in batches, thus requiring fewer I/O operations.</span></span> <span data-ttu-id="19f3c-120">Отложенная устойчивость транзакций потенциально уменьшает вероятность конфликтов ввода-вывода журналов, тем самым уменьшая время ожидания в системе.</span><span class="sxs-lookup"><span data-stu-id="19f3c-120">Delayed transaction durability potentially reduces log I/O contention, thus reducing waits in the system.</span></span>  
  
 <span data-ttu-id="19f3c-121">**Гарантии полностью устойчивых транзакций**</span><span class="sxs-lookup"><span data-stu-id="19f3c-121">**Full Transaction Durability Guarantees**</span></span>  
  
-   <span data-ttu-id="19f3c-122">После успешного выполнения фиксации транзакции изменений, внесенные транзакцией, становятся видимыми для других транзакций в системе.</span><span class="sxs-lookup"><span data-stu-id="19f3c-122">Once transaction commit succeeds, the changes made by the transaction are visible to the other transactions in the system.</span></span> <span data-ttu-id="19f3c-123">Дополнительные сведения см. в разделе [уровни изоляции транзакций](../../database-engine/transaction-isolation-levels.md) .</span><span class="sxs-lookup"><span data-stu-id="19f3c-123">See the topic [Transaction Isolation Levels](../../database-engine/transaction-isolation-levels.md) for more information.</span></span>  
  
-   <span data-ttu-id="19f3c-124">Устойчивость гарантируется при выполнении фиксации.</span><span class="sxs-lookup"><span data-stu-id="19f3c-124">Durability is guaranteed on commit.</span></span> <span data-ttu-id="19f3c-125">Соответствующие записи журнала сохраняются на диск до выполнения фиксации транзакции и возврата управления клиенту.</span><span class="sxs-lookup"><span data-stu-id="19f3c-125">Corresponding log records are persisted to disk before the transaction commit succeeds and returns control to the client.</span></span>  
  
### <a name="delayed-transaction-durability"></a><span data-ttu-id="19f3c-126">Устойчивость отложенных транзакций</span><span class="sxs-lookup"><span data-stu-id="19f3c-126">Delayed transaction durability</span></span>  
 <span data-ttu-id="19f3c-127">Устойчивость отложенных транзакций реализуется при асинхронной записи журналов на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-127">Delayed transaction durability is accomplished using asynchronous log writes to disk.</span></span> <span data-ttu-id="19f3c-128">Записи журнала транзакций содержатся в буфере и записываются на диск, когда буфер заполняется или при сбросе буфера.</span><span class="sxs-lookup"><span data-stu-id="19f3c-128">Transaction log records are kept in a buffer and written to disk when the buffer fills or a buffer flushing event takes place.</span></span> <span data-ttu-id="19f3c-129">Устойчивость отложенных транзакций уменьшает задержки и число конфликтов в системе по следующим причинам.</span><span class="sxs-lookup"><span data-stu-id="19f3c-129">Delayed transaction durability reduces both latency and contention within the system because:</span></span>  
  
-   <span data-ttu-id="19f3c-130">При обработке фиксации транзакций система не ожидает создания журнала ввода-вывода для завершения операции и возврата управления клиенту.</span><span class="sxs-lookup"><span data-stu-id="19f3c-130">The transaction commit processing does not wait for log IO to finish and return control to the client.</span></span>  
  
-   <span data-ttu-id="19f3c-131">При параллельных транзакциях реже возникают конфликты при ведении журналов ввода-вывода. Вместо этого может быть выполнена очистка буфера на диск большими частями, что позволяет уменьшить число конфликтов и увеличить пропускную способность.</span><span class="sxs-lookup"><span data-stu-id="19f3c-131">Concurrent transactions are less likely to contend for log IO; instead, the log buffer can be flushed to disk in larger chunks, reducing contention, and increasing throughput.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="19f3c-132">При высокой степени параллелизма могут возникать конфликты при ведении журналов ввода-вывода, особенно в случаях, когда буфер журналов заполняется быстрее, чем выполняется его очистка.</span><span class="sxs-lookup"><span data-stu-id="19f3c-132">You may still have log I/O contention if there is a high degree of concurrency, particularly if you fill up the log buffer faster than you flush it.</span></span>  
  
 <span data-ttu-id="19f3c-133">**Использование отложенных устойчивых транзакций**</span><span class="sxs-lookup"><span data-stu-id="19f3c-133">**When to use delayed transaction durability**</span></span>  
  
 <span data-ttu-id="19f3c-134">Некоторые из сценариев, в которых можно использовать преимущества, обеспечиваемые отложенными устойчивыми транзакциями</span><span class="sxs-lookup"><span data-stu-id="19f3c-134">Some of the cases in which you could benefit from using delayed transaction durability are:</span></span>  
  
 <span data-ttu-id="19f3c-135">**Допустимы потери данных.** </span><span class="sxs-lookup"><span data-stu-id="19f3c-135">**You can tolerate some data loss.**</span></span>  
 <span data-ttu-id="19f3c-136">Если допустим определенный уровень потерь данных, например, если отдельные записи не имеют критического значения при условии сохранения основной части данных, рекомендуется использовать отложенные устойчивые транзакции.</span><span class="sxs-lookup"><span data-stu-id="19f3c-136">If you can tolerate some data loss, for example, where individual records are not critical as long as you have most of the data, then delayed durability may be worth considering.</span></span> <span data-ttu-id="19f3c-137">Если потеря данных недопустима, не следует использовать отложенные устойчивые транзакции.</span><span class="sxs-lookup"><span data-stu-id="19f3c-137">If you cannot tolerate any data loss, do not use delayed transaction durability.</span></span>  
  
 <span data-ttu-id="19f3c-138">**При записи журналов транзакций обнаружено узкое место.** </span><span class="sxs-lookup"><span data-stu-id="19f3c-138">**You are experiencing a bottleneck on transaction log writes.**</span></span>  
 <span data-ttu-id="19f3c-139">Если проблемы с производительностью связаны с задержкой записи журналов транзакций, использование отложенных устойчивых транзакций будет полезно при работе с приложением.</span><span class="sxs-lookup"><span data-stu-id="19f3c-139">If your performance issues are due to latency in transaction log writes, your application will likely benefit from using delayed transaction durability.</span></span>  
  
 <span data-ttu-id="19f3c-140">**Рабочая нагрузка отличается высокой частотой конфликтов.** </span><span class="sxs-lookup"><span data-stu-id="19f3c-140">**Your workloads have a high contention rate.**</span></span>  
 <span data-ttu-id="19f3c-141">Если в системе используется рабочая нагрузка с высокой частотой конфликтов, то для разблокировки требуется длительное время.</span><span class="sxs-lookup"><span data-stu-id="19f3c-141">If your system has workloads with a high contention level much time is lost waiting for locks to be released.</span></span> <span data-ttu-id="19f3c-142">Отложенные устойчивые транзакции позволяют уменьшить время фиксации, благодаря чему разблокировка выполняется быстрее, что обеспечивает более высокий уровень пропускной способности.</span><span class="sxs-lookup"><span data-stu-id="19f3c-142">Delayed transaction durability reduces commit time and thus releases locks faster which results in higher throughput.</span></span>  
  
 <span data-ttu-id="19f3c-143">**Гарантии отложенных устойчивых транзакций**</span><span class="sxs-lookup"><span data-stu-id="19f3c-143">**Delayed Transaction Durability Guarantees**</span></span>  
  
-   <span data-ttu-id="19f3c-144">После успешного выполнения фиксации транзакции изменений, внесенные транзакцией, становятся видимыми для других транзакций в системе.</span><span class="sxs-lookup"><span data-stu-id="19f3c-144">Once transaction commit succeeds, the changes made by the transaction are visible to the other transactions in the system.</span></span>  
  
-   <span data-ttu-id="19f3c-145">Устойчивость транзакции гарантируется только после записи журналов транзакций в памяти на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-145">Transaction durability is guaranteed only following a flush of the in-memory transaction log to disk.</span></span> <span data-ttu-id="19f3c-146">Журнал транзакций в памяти записывается на диск в следующих случаях.</span><span class="sxs-lookup"><span data-stu-id="19f3c-146">The in-memory transaction log is flushed to disk when:</span></span>  
  
    -   <span data-ttu-id="19f3c-147">Полностью устойчивая транзакция в той же базе данных вносит изменение в базу данных и фиксация завершается успешно.</span><span class="sxs-lookup"><span data-stu-id="19f3c-147">A fully durable transaction in the same database makes a change in the database and successfully commits.</span></span>  
  
    -   <span data-ttu-id="19f3c-148">Пользователь успешно выполняет системную хранимую процедуру `sp_flush_log` .</span><span class="sxs-lookup"><span data-stu-id="19f3c-148">The user executes the system stored procedure `sp_flush_log` successfully.</span></span>  
  
    -   <span data-ttu-id="19f3c-149">Буфер журнала транзакций в памяти заполняется и автоматически записывается на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-149">The in-memory transaction log buffer fills up and automatically flushes to disk.</span></span>  
  
     <span data-ttu-id="19f3c-150">При успешной фиксации полностью устойчивой транзакции или sp_flush_log все предыдущие отложенные устойчивые транзакции становятся устойчивыми.</span><span class="sxs-lookup"><span data-stu-id="19f3c-150">If a fully durable transaction or sp_flush_log successfully commit, all previously committed delayed durability transactions have been made durable.</span></span>  
  
 <span data-ttu-id="19f3c-151">Журнал может периодически сбрасываться на диск. </span><span class="sxs-lookup"><span data-stu-id="19f3c-151">The log may be flushed to disk periodically.</span></span> <span data-ttu-id="19f3c-152">Однако служба [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не предоставляет каких-либо гарантий устойчивости, кроме как устойчивых транзакций и sp_flush_log.</span><span class="sxs-lookup"><span data-stu-id="19f3c-152">However, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] does not provide any durability guarantees other than durable transactions and sp_flush_log.</span></span>  
  
## <a name="how-to-control-transaction-durability"></a><span data-ttu-id="19f3c-153">Управление устойчивостью транзакций</span><span class="sxs-lookup"><span data-stu-id="19f3c-153">How to control transaction durability</span></span>  
  
### <a name="database-level-control"></a><span data-ttu-id="19f3c-154">Управление на уровне базы данных</span><span class="sxs-lookup"><span data-stu-id="19f3c-154">Database level control</span></span>  
 <span data-ttu-id="19f3c-155">Администратор базы данных управляет тем, могут ли пользователи использовать отложенные устойчивые транзакции в базе данных, с помощью следующей инструкции.</span><span class="sxs-lookup"><span data-stu-id="19f3c-155">You, the DBA, can control whether users can use delayed transaction durability on a database with the following statement.</span></span> <span data-ttu-id="19f3c-156">Необходимо использовать для настройки параметра отложенной устойчивости инструкцию ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="19f3c-156">You must set the delayed durability setting with ALTER DATABASE.</span></span>  
  
```sql  
ALTER DATABASE ... SET DELAYED_DURABILITY = { DISABLED | ALLOWED | FORCED }  
```  
  
 `DISABLED`  
 <span data-ttu-id="19f3c-157">[по умолчанию] При использовании этой настройки все фиксируемые в базе данных транзакции являются полностью устойчивыми независимо от настроек уровня фиксации (DELAYED_DURABILITY= [ON | OFF]).</span><span class="sxs-lookup"><span data-stu-id="19f3c-157">[default] With this setting, all transactions that commit on the database are fully durable, regardless of the commit level setting (DELAYED_DURABILITY=[ON | OFF]).</span></span> <span data-ttu-id="19f3c-158">Изменение и повторная компиляция хранимых процедур не требуются.</span><span class="sxs-lookup"><span data-stu-id="19f3c-158">There is no need for stored procedure change and recompilation.</span></span> <span data-ttu-id="19f3c-159">Это позволяет гарантировать, что данные не будут подвергаться рискам из-за отложенной устойчивости.</span><span class="sxs-lookup"><span data-stu-id="19f3c-159">This allows you to ensure that no data is ever put at risk by delayed durability.</span></span>  
  
 `ALLOWED`  
 <span data-ttu-id="19f3c-160">При использовании этой настройки устойчивость каждой транзакции определяется на уровне транзакций — DELAYED_DURABILITY = { *OFF* | ON }.</span><span class="sxs-lookup"><span data-stu-id="19f3c-160">With this setting, each transaction's durability is determined at the transaction level - DELAYED_DURABILITY = { *OFF* | ON }.</span></span> <span data-ttu-id="19f3c-161">Дополнительные сведения см. в разделе [Управление уровнями блока Atomic — скомпилированные в собственном код хранимые процедуры](#atomic-block-level-control---natively-compiled-stored-procedures) и [Управление уровнями фиксации — Transact-SQL](#commit-level-control---t-sql) .</span><span class="sxs-lookup"><span data-stu-id="19f3c-161">See [Atomic block level control - Natively Compiled Stored Procedures](#atomic-block-level-control---natively-compiled-stored-procedures) and [COMMIT level control - Transact-SQL](#commit-level-control---t-sql) for more information.</span></span>  
  
 `FORCED`  
 <span data-ttu-id="19f3c-162">Если выбран этот параметр, все транзакции, которые фиксируются в базе данных, являются отложенными устойчивыми.</span><span class="sxs-lookup"><span data-stu-id="19f3c-162">With this setting, every transaction that commits on the database is delayed durable.</span></span> <span data-ttu-id="19f3c-163">Независимо от того, указана ли транзакция как полностью устойчивая (DELAYED_DURABILITY = OFF) или данные не указаны, транзакция является отложенной устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-163">Whether the transaction specifies fully durable (DELAYED_DURABILITY = OFF) or makes no specification, the transaction is delayed durable.</span></span> <span data-ttu-id="19f3c-164">Этот параметр полезен, если отложенная устойчивая транзакция используется для баз данных и не следует изменять код приложения.</span><span class="sxs-lookup"><span data-stu-id="19f3c-164">This setting is useful when delayed transaction durability is useful for a database and you do not want to change any application code.</span></span>  
  
### <a name="atomic-block-level-control---natively-compiled-stored-procedures"></a><span data-ttu-id="19f3c-165"> Управление на уровне блока Atomic — скомпилированные в собственном коде хранимые процедуры</span><span class="sxs-lookup"><span data-stu-id="19f3c-165">Atomic block level control - Natively Compiled Stored Procedures</span></span>  
 <span data-ttu-id="19f3c-166">Ниже представлен код блока ATOMIC.</span><span class="sxs-lookup"><span data-stu-id="19f3c-166">The following code goes inside the atomic block.</span></span>  
  
```sql  
DELAYED_DURABILITY = { OFF | ON }  
```  
  
 `OFF`  
 <span data-ttu-id="19f3c-167">[по умолчанию] Транзакция является полностью устойчивой, пока действует параметр базы данных DELAYED_DURABLITY = FORCED, в этом случае фиксация является асинхронной и таким образом, устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-167">[default] The transaction is fully durable, unless the database option DELAYED_DURABLITY = FORCED is in effect, in which case the commit is asynchronous and thus delayed durable.</span></span> <span data-ttu-id="19f3c-168">Подробнее см. в разделе [Database level control](#database-level-control) .</span><span class="sxs-lookup"><span data-stu-id="19f3c-168">See [Database level control](#database-level-control) for more information.</span></span>  
  
 `ON`  
 <span data-ttu-id="19f3c-169">Транзакция является устойчиво отложенной, пока действует параметр базы данных DELAYED_DURABLITY = DISABLED, в этом случае фиксация является синхронной и таким образом, полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-169">The transaction is delayed durable, unless the database option DELAYED_DURABLITY = DISABLED is in effect, in which case the commit is synchronous and thus fully durable.</span></span>  <span data-ttu-id="19f3c-170">Подробнее см. в разделе [Database level control](#database-level-control) .</span><span class="sxs-lookup"><span data-stu-id="19f3c-170">See [Database level control](#database-level-control) for more information.</span></span>  
  
 <span data-ttu-id="19f3c-171">**Пример кода**</span><span class="sxs-lookup"><span data-stu-id="19f3c-171">**Example Code:**</span></span>  
  
```sql  
CREATE PROCEDURE <procedureName> ...  
WITH NATIVE_COMPILATION, SCHEMABINDING, EXECUTE AS OWNER  
AS BEGIN ATOMIC WITH   
(  
    DELAYED_DURABILITY = ON,  
    TRANSACTION ISOLATION LEVEL = SNAPSHOT,  
    LANGUAGE = N'English'  
    ...  
)  
END  
```  
  
### <a name="table-1-durability-in-atomic-blocks"></a><span data-ttu-id="19f3c-172">Таблица 1: Устойчивость в блоках ATOMIC</span><span class="sxs-lookup"><span data-stu-id="19f3c-172">Table 1: Durability in Atomic Blocks</span></span>  
  
|<span data-ttu-id="19f3c-173">Параметр устойчивости блоков ATOMIC</span><span class="sxs-lookup"><span data-stu-id="19f3c-173">Atomic block durability option</span></span>|<span data-ttu-id="19f3c-174">Отсутствие существующих транзакций</span><span class="sxs-lookup"><span data-stu-id="19f3c-174">No existing transaction</span></span>|<span data-ttu-id="19f3c-175">Транзакция обрабатывается (полностью или отложенная устойчивая)</span><span class="sxs-lookup"><span data-stu-id="19f3c-175">Transaction in process (fully or delayed durable)</span></span>|  
|------------------------------------|-----------------------------|---------------------------------------------------------|  
|`DELAYED_DURABILITY = OFF`|<span data-ttu-id="19f3c-176">Блок ATOMIC инициирует новую полностью устойчивую транзакцию.</span><span class="sxs-lookup"><span data-stu-id="19f3c-176">Atomic block starts a new fully durable transaction.</span></span>|<span data-ttu-id="19f3c-177">Блок ATOMIC создает точку сохранения в существующей транзакции, а затем начинает новую транзакцию.</span><span class="sxs-lookup"><span data-stu-id="19f3c-177">Atomic block creates a save point in the existing transaction, then begins the new transaction.</span></span>|  
|`DELAYED_DURABILITY = ON`|<span data-ttu-id="19f3c-178">Блок ATOMIC инициирует новую отложенную устойчивую транзакцию.</span><span class="sxs-lookup"><span data-stu-id="19f3c-178">Atomic block starts a new delayed durable transaction.</span></span>|<span data-ttu-id="19f3c-179">Блок ATOMIC создает точку сохранения в существующей транзакции, а затем начинает новую транзакцию.</span><span class="sxs-lookup"><span data-stu-id="19f3c-179">Atomic block creates a save point in the existing transaction, then begins the new transaction.</span></span>|  
  
### <a name="commit-level-control---t-sql"></a><span data-ttu-id="19f3c-180">Управление уровнями ФИКСАЦИи — (T-SQL)</span><span class="sxs-lookup"><span data-stu-id="19f3c-180">COMMIT level control - (T-SQL)</span></span>
 <span data-ttu-id="19f3c-181">Синтаксис фиксации расширен, что обеспечивает возможность принудительной реализации отложенной устойчивости транзакций.</span><span class="sxs-lookup"><span data-stu-id="19f3c-181">The COMMIT syntax is extended so you can force delayed transaction durability.</span></span> <span data-ttu-id="19f3c-182">Если для DELAYED_DURABILITY задано DISABLED или FORCED на уровне базы данных (см. выше), то этот параметр фиксации не учитывается.</span><span class="sxs-lookup"><span data-stu-id="19f3c-182">If DELAYED_DURABILITY is DISABLED or FORCED at the database level (see above) this COMMIT option is ignored.</span></span>  
  
```sql  
COMMIT [ { TRAN | TRANSACTION } ] [ transaction_name | @tran_name_variable ] ] [ WITH ( DELAYED_DURABILITY = { OFF | ON } ) ]  
  
```  
  
 `OFF`  
 <span data-ttu-id="19f3c-183">[по умолчанию] Фиксация транзакции является полностью устойчивой за исключением случаев, когда применяется параметр базы данных DELAYED_DURABLITY = FORCED, в этом случае фиксация является асинхронной и, следовательно, отложенной устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-183">[default] The transaction COMMIT is fully durable, unless the database option DELAYED_DURABLITY = FORCED is in effect, in which case the COMMIT is asynchronous and thus delayed durable.</span></span> <span data-ttu-id="19f3c-184">Подробнее см. в разделе [Database level control](#database-level-control) .</span><span class="sxs-lookup"><span data-stu-id="19f3c-184">See [Database level control](#database-level-control) for more information.</span></span>  
  
 `ON`  
 <span data-ttu-id="19f3c-185">Фиксация транзакции является отложенной устойчивой за исключением случаев, когда применяется параметр базы данных DELAYED_DURABLITY = DISABLED, в этом случае фиксация является синхронной и, следовательно, полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-185">The transaction COMMIT is delayed durable, unless the database option DELAYED_DURABLITY = DISABLED is in effect, in which case the COMMIT is synchronous and thus fully durable.</span></span> <span data-ttu-id="19f3c-186">Подробнее см. в разделе [Database level control](#database-level-control) .</span><span class="sxs-lookup"><span data-stu-id="19f3c-186">See [Database level control](#database-level-control) for more information.</span></span>  
  
### <a name="summary-of-options-and-their-interactions"></a><span data-ttu-id="19f3c-187">Краткое описание параметров и их взаимодействий</span><span class="sxs-lookup"><span data-stu-id="19f3c-187">Summary of options and their interactions</span></span>  
 <span data-ttu-id="19f3c-188">В следующей таблице перечислены взаимодействия параметров отложенной устойчивости на уровне базы данных и параметров на уровне фиксации.</span><span class="sxs-lookup"><span data-stu-id="19f3c-188">This table summarizes the interactions between database level delayed durability settings and commit level settings.</span></span> <span data-ttu-id="19f3c-189">Параметры уровня базы данных всегда имеют более высокий приоритет, чем параметры уровня фиксации.</span><span class="sxs-lookup"><span data-stu-id="19f3c-189">Database level settings always take precedence over commit level settings.</span></span>  
  
|<span data-ttu-id="19f3c-190">Параметр фиксации/параметр базы данных</span><span class="sxs-lookup"><span data-stu-id="19f3c-190">COMMIT setting/Database setting</span></span>|<span data-ttu-id="19f3c-191">DELAYED_DURABILITY = DISABLED</span><span class="sxs-lookup"><span data-stu-id="19f3c-191">DELAYED_DURABILITY = DISABLED</span></span>|<span data-ttu-id="19f3c-192">DELAYED_DURABILITY = ALLOWED</span><span class="sxs-lookup"><span data-stu-id="19f3c-192">DELAYED_DURABILITY = ALLOWED</span></span>|<span data-ttu-id="19f3c-193">DELAYED_DURABILITY = FORCED</span><span class="sxs-lookup"><span data-stu-id="19f3c-193">DELAYED_DURABILITY = FORCED</span></span>|  
|--------------------------------------|-------------------------------------|------------------------------------|-----------------------------------|  
|<span data-ttu-id="19f3c-194">Транзакции на уровне базы данных `DELAYED_DURABILITY = OFF`.</span><span class="sxs-lookup"><span data-stu-id="19f3c-194">`DELAYED_DURABILITY = OFF` Database level transactions.</span></span>|<span data-ttu-id="19f3c-195">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-195">Transaction is fully durable.</span></span>|<span data-ttu-id="19f3c-196">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-196">Transaction is fully durable.</span></span>|<span data-ttu-id="19f3c-197">Транзакция является отложенной устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-197">Transaction is delayed durable.</span></span>|  
|<span data-ttu-id="19f3c-198">Транзакции на уровне базы данных `DELAYED_DURABILITY = ON`.</span><span class="sxs-lookup"><span data-stu-id="19f3c-198">`DELAYED_DURABILITY = ON` Database level transactions.</span></span>|<span data-ttu-id="19f3c-199">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-199">Transaction is fully durable.</span></span>|<span data-ttu-id="19f3c-200">Транзакция является отложенной устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-200">Transaction is delayed durable.</span></span>|<span data-ttu-id="19f3c-201">Транзакция является отложенной устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-201">Transaction is delayed durable.</span></span>|  
|<span data-ttu-id="19f3c-202">Межбазовая или распределенная транзакция `DELAYED_DURABILITY = OFF`.</span><span class="sxs-lookup"><span data-stu-id="19f3c-202">`DELAYED_DURABILITY = OFF` Cross database or distributed transaction.</span></span>|<span data-ttu-id="19f3c-203">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-203">Transaction is fully durable.</span></span>|<span data-ttu-id="19f3c-204">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-204">Transaction is fully durable.</span></span>|<span data-ttu-id="19f3c-205">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-205">Transaction is fully durable.</span></span>|  
|<span data-ttu-id="19f3c-206">Межбазовая или распределенная транзакция `DELAYED_DURABILITY = ON`.</span><span class="sxs-lookup"><span data-stu-id="19f3c-206">`DELAYED_DURABILITY = ON` Cross database or distributed transaction.</span></span>|<span data-ttu-id="19f3c-207">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-207">Transaction is fully durable.</span></span>|<span data-ttu-id="19f3c-208">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-208">Transaction is fully durable.</span></span>|<span data-ttu-id="19f3c-209">Транзакция является полностью устойчивой.</span><span class="sxs-lookup"><span data-stu-id="19f3c-209">Transaction is fully durable.</span></span>|  
  
## <a name="how-to-force-a-transaction-log-flush"></a><span data-ttu-id="19f3c-210">Принудительная реализация записи журнала транзакций</span><span class="sxs-lookup"><span data-stu-id="19f3c-210">How to force a transaction log flush</span></span>  
 <span data-ttu-id="19f3c-211">Существует два способа записи журнала транзакций на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-211">There are two means to force flush the transaction log to disk.</span></span>  
  
-   <span data-ttu-id="19f3c-212">Выполните любую полностью устойчивую транзакцию, которая изменяет одну и ту же базу данных.</span><span class="sxs-lookup"><span data-stu-id="19f3c-212">Execute any fully durable transaction that alters the same database.</span></span> <span data-ttu-id="19f3c-213">При этом выполняется принудительная запись данных журналов всех ранее зафиксированных отложенных устойчивых транзакций на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-213">This forces a flush of the log records of all preceding committed delayed durability transactions to disk.</span></span>  
  
-   <span data-ttu-id="19f3c-214">Выполните системную хранимую процедуру `sp_flush_log`.</span><span class="sxs-lookup"><span data-stu-id="19f3c-214">Execute the system stored procedure `sp_flush_log`.</span></span> <span data-ttu-id="19f3c-215">При выполнении этой процедуры выполняется принудительная запись данных журналов всех ранее зафиксированных полностью устойчивых транзакций на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-215">This procedure forces a flush of the log records of all preceding committed delayed durable transactions to disk.</span></span> <span data-ttu-id="19f3c-216">Дополнительные сведения см. в разделе [sys.sp_flush_log (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sys-sp-flush-log-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="19f3c-216">For more information see [sys.sp_flush_log &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-flush-log-transact-sql).</span></span>  
  
##  <a name="delayed-durability-and-other-sql-server-features"></a><span data-ttu-id="19f3c-217">Отложенная устойчивость и другие функции SQL Server</span><span class="sxs-lookup"><span data-stu-id="19f3c-217">Delayed durability and other SQL Server features</span></span>  
 <span data-ttu-id="19f3c-218">**Отслеживание изменений и отслеживание измененных данных**</span><span class="sxs-lookup"><span data-stu-id="19f3c-218">**Change tracking and change data capture**</span></span>  
 <span data-ttu-id="19f3c-219">Все транзакции с отслеживанием изменений являются полностью устойчивыми.</span><span class="sxs-lookup"><span data-stu-id="19f3c-219">All transactions with change tracking are fully durable.</span></span> <span data-ttu-id="19f3c-220">Транзакция имеет свойство отслеживания изменений, если она выполняет какую-либо операцию записи в таблицы, для которой включено отслеживание изменений.</span><span class="sxs-lookup"><span data-stu-id="19f3c-220">A transaction has the change tracking property if it does any write operations to tables that are enabled for change tracking.</span></span> <span data-ttu-id="19f3c-221">Использование отложенной устойчивости не поддерживается для баз данных, которые используют систему отслеживания измененных данных (CDC).</span><span class="sxs-lookup"><span data-stu-id="19f3c-221">The use of delayed durability is not supported for databases which use change data capture (CDC).</span></span>   
  
 <span data-ttu-id="19f3c-222">**Восстановление после сбоя**</span><span class="sxs-lookup"><span data-stu-id="19f3c-222">**Crash recovery**</span></span>  
 <span data-ttu-id="19f3c-223">Гарантируется согласованность, но некоторые изменения отложенных фиксированных транзакций могут быть потеряны.</span><span class="sxs-lookup"><span data-stu-id="19f3c-223">Consistency is guaranteed, but some changes from delayed durable transactions that have committed may be lost.</span></span>  
  
 <span data-ttu-id="19f3c-224">**Межбазовые и DTC**</span><span class="sxs-lookup"><span data-stu-id="19f3c-224">**Cross-database and DTC**</span></span>  
 <span data-ttu-id="19f3c-225">Если транзакция является межбазовой или распределенной, она является полностью устойчивой независимо от настроек фиксации транзакций.</span><span class="sxs-lookup"><span data-stu-id="19f3c-225">If a transaction is cross-database or distributed, if is fully durable, regardless of any database or transaction commit setting.</span></span>  
  
 <span data-ttu-id="19f3c-226">**Группы доступности Always On и зеркальное отображение**</span><span class="sxs-lookup"><span data-stu-id="19f3c-226">**Always On Availability Groups and Mirroring**</span></span>  
 <span data-ttu-id="19f3c-227">Отложенные устойчивые транзакции не гарантируют устойчивость на сервере-отправителе или сервере-получателе.</span><span class="sxs-lookup"><span data-stu-id="19f3c-227">Delayed durable transactions do not guarantee any durability on either the primary or any of the secondaries.</span></span> <span data-ttu-id="19f3c-228">Кроме того, они не гарантируют получения сведений о транзакциях на сервере-получателе.</span><span class="sxs-lookup"><span data-stu-id="19f3c-228">In addition, they do not guarantee any knowledge about the transaction at the secondary.</span></span> <span data-ttu-id="19f3c-229">После фиксации, управление возвращается клиенту до того, как любое подтверждение получено от любого синхронного сервера-получателя.</span><span class="sxs-lookup"><span data-stu-id="19f3c-229">After commit, control is returned to the client before any acknowledgement is received from any synchronous secondary.</span></span>  
  
 <span data-ttu-id="19f3c-230">**Отказоустойчивая кластеризация**</span><span class="sxs-lookup"><span data-stu-id="19f3c-230">**Failover clustering**</span></span>  
 <span data-ttu-id="19f3c-231">Некоторые записи отложенных устойчивых транзакций могут быть утеряны.</span><span class="sxs-lookup"><span data-stu-id="19f3c-231">Some delayed durable transaction writes might be lost.</span></span>  
  
 <span data-ttu-id="19f3c-232">**Репликация транзакций**</span><span class="sxs-lookup"><span data-stu-id="19f3c-232">**Transaction Replication**</span></span>  
 <span data-ttu-id="19f3c-233">Отложенно-устойчивые транзакции не поддерживается при репликации транзакций.</span><span class="sxs-lookup"><span data-stu-id="19f3c-233">Delayed durable transactions is not supported with Transactional Replication.</span></span>  
  
 <span data-ttu-id="19f3c-234">**Доставка журналов**</span><span class="sxs-lookup"><span data-stu-id="19f3c-234">**Log shipping**</span></span>  
 <span data-ttu-id="19f3c-235">В доставляемых журналах регистрируются только устойчивые транзакции.</span><span class="sxs-lookup"><span data-stu-id="19f3c-235">Only transactions that have been made durable are included in the log that is shipped.</span></span>  
  
 <span data-ttu-id="19f3c-236">**Резервная копия журналов**</span><span class="sxs-lookup"><span data-stu-id="19f3c-236">**Log Backup**</span></span>  
 <span data-ttu-id="19f3c-237">В резервные копии включаются только устойчивые транзакции.</span><span class="sxs-lookup"><span data-stu-id="19f3c-237">Only transactions that have been made durable are included in the backup.</span></span>  
  
## <a name="when-can-i-lose-data"></a><span data-ttu-id="19f3c-238">Когда я могу потерять данные?</span><span class="sxs-lookup"><span data-stu-id="19f3c-238">When can I lose data?</span></span>  
 <span data-ttu-id="19f3c-239">Если вы применяете отложенную устойчивость на любой вашей таблице, вы должны понимать, что определенные обстоятельства могут привести к потере данных.</span><span class="sxs-lookup"><span data-stu-id="19f3c-239">If you implement delayed durability on any of your tables, you should understand that certain circumstances can lead to data loss.</span></span> <span data-ttu-id="19f3c-240">Если вы не допускаете любую потерю данных, вам не следует использовать отложенную устойчивость на ваших таблицах.</span><span class="sxs-lookup"><span data-stu-id="19f3c-240">If you cannot tolerate any data loss, you should not use delayed durability on your tables.</span></span>  
  
### <a name="catastrophic-events"></a><span data-ttu-id="19f3c-241">Критические события</span><span class="sxs-lookup"><span data-stu-id="19f3c-241">Catastrophic events</span></span>  
 <span data-ttu-id="19f3c-242">В случае критического события, например, выход сервера из строя, вы потеряете данные всех фиксированных транзакций ,которые не были сохранены на диск.</span><span class="sxs-lookup"><span data-stu-id="19f3c-242">In the case of a catastrophic event, like a server crash, you will lose the data for all committed transactions that have not been saved to disk.</span></span> <span data-ttu-id="19f3c-243">Отложенные устойчивые транзакции сохраняются на диск всякий раз, когда полностью устойчивая транзакция выполняется для любой таблицы (устойчивой и оптимизированной для памяти или находящейся на диске) в базе данных, или вызывается `sp_flush_log` .</span><span class="sxs-lookup"><span data-stu-id="19f3c-243">Delayed durable transactions are saved to disk whenever a fully durable transaction is executed against any table (durable memory-optimized or disk-based) in the database, or `sp_flush_log` is called.</span></span> <span data-ttu-id="19f3c-244">Если вы используете устойчивые отложенные транзакции, вы, возможно, хотите создать маленькую таблицу в базе данных, которую вы можете периодически обновлять, или периодически вызывать `sp_flush_log` для сохранения всех невыполненных фиксированных транзакций.</span><span class="sxs-lookup"><span data-stu-id="19f3c-244">If you are using delayed durable transactions, you may want to create a small table in the database that you can periodically update or periodically call `sp_flush_log` to save all outstanding committed transactions.</span></span> <span data-ttu-id="19f3c-245">Журнал транзакции также сбрасывается всякий раз, когда он заполняется, но это сложно предсказать и невозможно контролировать.</span><span class="sxs-lookup"><span data-stu-id="19f3c-245">The transaction log also flushes whenever it becomes full, but that is hard to predict and impossible to control.</span></span>  
  
### <a name="sql-server-shutdown-and-restart"></a><span data-ttu-id="19f3c-246">SQL Server завершение работы и перезагрузка</span><span class="sxs-lookup"><span data-stu-id="19f3c-246">SQL Server shutdown and restart</span></span>  
 <span data-ttu-id="19f3c-247">Для отложенной устойчивости нет разницы между неожиданным выключением или неожиданным выключением/перезагрузкой службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="19f3c-247">For delayed durability, there is no difference between an unexpected shutdown and an expected shutdown/restart of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="19f3c-248">Как и в случае с критическими событиями, вы должны быть готовы к потере данных.</span><span class="sxs-lookup"><span data-stu-id="19f3c-248">Like catastrophic events, you should plan for data loss.</span></span> <span data-ttu-id="19f3c-249">При запланированном выключении/перезагрузке некоторые транзакции, которые не были записаны на диск, могут сначала быть сохранены на диск, но вам не стоит рассчитывать на это.</span><span class="sxs-lookup"><span data-stu-id="19f3c-249">In a planned shutdown/restart some transactions that have not been written to disk may first be saved to disk, but you should not plan on it.</span></span> <span data-ttu-id="19f3c-250">При запланированном или незапланированном выключении/перезагрузке данные теряются так же, как и при критических событиях.</span><span class="sxs-lookup"><span data-stu-id="19f3c-250">Plan as though a shutdown/restart, whether planned or unplanned, loses the data the same as a catastrophic event.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="19f3c-251">См. также:</span><span class="sxs-lookup"><span data-stu-id="19f3c-251">See Also</span></span>  
 <span data-ttu-id="19f3c-252">[Уровни изоляции транзакций](../../database-engine/transaction-isolation-levels.md) </span><span class="sxs-lookup"><span data-stu-id="19f3c-252">[Transaction Isolation Levels](../../database-engine/transaction-isolation-levels.md) </span></span>  
 [<span data-ttu-id="19f3c-253">Рекомендации для уровней изоляции транзакций с таблицами, оптимизированными для памяти</span><span class="sxs-lookup"><span data-stu-id="19f3c-253">Guidelines for Transaction Isolation Levels with Memory-Optimized Tables</span></span>](../in-memory-oltp/memory-optimized-tables.md)  
  
  
