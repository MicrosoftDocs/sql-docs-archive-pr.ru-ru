---
title: Контрольные точки базы данных (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 10/13/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- automatic checkpoints
- transaction logs [SQL Server], checkpoints
- logs [SQL Server], active
- pages [SQL Server], dirty
- MinLSN
- checkpoints [SQL Server]
- pages [SQL Server], flushing
- dirty pages
- transaction logs [SQL Server], active logs
- recovery interval option [SQL Server]
- buffer cache [SQL Server]
- logs [SQL Server], checkpoints
- Minimum Recovery LSN
- flushing pages
- active logs
ms.assetid: 98a80238-7409-4708-8a7d-5defd9957185
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 5776d4a23223637c50ac40098fa44342d5cd94a9
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658256"
---
# <a name="database-checkpoints-sql-server"></a><span data-ttu-id="c20c3-102">Контрольные точки базы данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c20c3-102">Database Checkpoints (SQL Server)</span></span>
  <span data-ttu-id="c20c3-103">В этом разделе содержится обзор [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] контрольных точек базы данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-103">This topic provides an overview of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database checkpoints.</span></span> <span data-ttu-id="c20c3-104">*Контрольная точка* создает известную надежную точку, с которой [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] может начать применение изменений, содержащихся в журнале, во время восстановления после непредвиденного отключения или аварии.</span><span class="sxs-lookup"><span data-stu-id="c20c3-104">A *checkpoint* creates a known good point from which the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] can start applying changes contained in the log during recovery after an unexpected shutdown or crash.</span></span>  
  
  
##  <a name="overview-of-checkpoints"></a><a name="Overview"></a><span data-ttu-id="c20c3-105">Общие сведения о контрольных точках</span><span class="sxs-lookup"><span data-stu-id="c20c3-105">Overview of Checkpoints</span></span>  
 <span data-ttu-id="c20c3-106">Из соображений производительности [!INCLUDE[ssDE](../../includes/ssde-md.md)] выполняет изменения страниц базы данных в памяти (в буферном кэше) и не записывает эти страницы на диск после каждого изменения.</span><span class="sxs-lookup"><span data-stu-id="c20c3-106">For performance reasons, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] performs modifications to database pages in memory-in the buffer cache-and does not write these pages to disk after every change.</span></span> <span data-ttu-id="c20c3-107">Вместо этого [!INCLUDE[ssDE](../../includes/ssde-md.md)] периодически выдает контрольную точку на каждой базе данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-107">Rather, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] periodically issues a checkpoint on each database.</span></span> <span data-ttu-id="c20c3-108">Новая *контрольная точка* записывает текущие страницы, измененные в памяти (известные как *измененные незафиксированные страницы*), вместе со сведениями журнала транзакций из памяти на диск, а также сведения о журнале транзакций.</span><span class="sxs-lookup"><span data-stu-id="c20c3-108">A *checkpoint* writes the current in-memory modified pages (known as *dirty pages*) and transaction log information from memory to disk and, also, records information about the transaction log.</span></span>  
  
 <span data-ttu-id="c20c3-109">[!INCLUDE[ssDE](../../includes/ssde-md.md)] поддерживает несколько типов контрольных точек: автоматические, косвенные, ручные и внутренние.</span><span class="sxs-lookup"><span data-stu-id="c20c3-109">The [!INCLUDE[ssDE](../../includes/ssde-md.md)] supports several types of checkpoints: automatic, indirect, manual, and internal.</span></span> <span data-ttu-id="c20c3-110">Следующая таблица содержит сводку типов контрольных точек.</span><span class="sxs-lookup"><span data-stu-id="c20c3-110">The following table summarizes the types of checkpoints.</span></span>  
  
|<span data-ttu-id="c20c3-111">Имя</span><span class="sxs-lookup"><span data-stu-id="c20c3-111">Name</span></span>|[!INCLUDE[tsql](../../includes/tsql-md.md)] <span data-ttu-id="c20c3-112">Интерфейс</span><span class="sxs-lookup"><span data-stu-id="c20c3-112">Interface</span></span>|<span data-ttu-id="c20c3-113">Описание</span><span class="sxs-lookup"><span data-stu-id="c20c3-113">Description</span></span>|  
|----------|----------------------------------|-----------------|  
|<span data-ttu-id="c20c3-114">Автоматически</span><span class="sxs-lookup"><span data-stu-id="c20c3-114">Automatic</span></span>|<span data-ttu-id="c20c3-115">EXEC sp_configure **" `recovery interval` ", " *`seconds`* "**</span><span class="sxs-lookup"><span data-stu-id="c20c3-115">EXEC sp_configure **'`recovery interval`','*`seconds`*'**</span></span>|<span data-ttu-id="c20c3-116">Автоматически выдается в фоновом режиме для удовлетворения верхнего предела времени, предлагаемого `recovery interval` параметром конфигурации сервера.</span><span class="sxs-lookup"><span data-stu-id="c20c3-116">Issued automatically in the background to meet the upper time limit suggested by the `recovery interval` server configuration option.</span></span> <span data-ttu-id="c20c3-117">Автоматические контрольные точки выполняются до их завершения.</span><span class="sxs-lookup"><span data-stu-id="c20c3-117">Automatic checkpoints run to completion.</span></span>  <span data-ttu-id="c20c3-118">Автоматические контрольные точки регулируются в зависимости от числа необработанных записей и от того, обнаруживает ли [!INCLUDE[ssDE](../../includes/ssde-md.md)] увеличение задержки записи более чем на 20 миллисекунд.</span><span class="sxs-lookup"><span data-stu-id="c20c3-118">Automatic checkpoints are throttled based on the number of outstanding writes and whether the [!INCLUDE[ssDE](../../includes/ssde-md.md)] detects an increase in write latency above 20 milliseconds.</span></span><br /><br /> <span data-ttu-id="c20c3-119">Дополнительные сведения см. в статье [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).</span><span class="sxs-lookup"><span data-stu-id="c20c3-119">For more information, see [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).</span></span>|  
|<span data-ttu-id="c20c3-120">Косвенные</span><span class="sxs-lookup"><span data-stu-id="c20c3-120">Indirect</span></span>|<span data-ttu-id="c20c3-121">ИЗМЕНИТЬ БАЗУ ДАННЫХ... ЗАДАТЬ TARGET_RECOVERY_TIME **=** _TARGET_RECOVERY_TIME_ {Seconds &#124; минут}</span><span class="sxs-lookup"><span data-stu-id="c20c3-121">ALTER DATABASE ... SET TARGET_RECOVERY_TIME **=**_target_recovery_time_ { SECONDS &#124; MINUTES }</span></span>|<span data-ttu-id="c20c3-122">Выдаются в фоновом режиме для обеспечения соответствия пользовательскому целевому времени восстановления для конкретной базы данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-122">Issued in the background to meet a user-specified target recovery time for a given database.</span></span> <span data-ttu-id="c20c3-123">Целевое время восстановления по умолчанию равно 0, что приводит к использованию эвристики автоматических контрольных точек в базе данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-123">The default target recovery time is 0, which causes automatic checkpoint heuristics to be used on the database.</span></span> <span data-ttu-id="c20c3-124">Если была использована инструкция ALTER DATABASE для установки TARGET_RECOVERY_TIME в значение >0, то используется это значение, а не интервал восстановления, указанный для экземпляра сервера.</span><span class="sxs-lookup"><span data-stu-id="c20c3-124">If you have used ALTER DATABASE to set TARGET_RECOVERY_TIME to >0, this value is used, rather than the recovery interval specified for the server instance.</span></span><br /><br /> <span data-ttu-id="c20c3-125">Дополнительные сведения см. в разделе [Изменение целевого времени восстановления базы данных (SQL Server)](change-the-target-recovery-time-of-a-database-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="c20c3-125">For more information, see [Change the Target Recovery Time of a Database &#40;SQL Server&#41;](change-the-target-recovery-time-of-a-database-sql-server.md).</span></span>|  
|<span data-ttu-id="c20c3-126">Вручную</span><span class="sxs-lookup"><span data-stu-id="c20c3-126">Manual</span></span>|<span data-ttu-id="c20c3-127">CHECKPOINT [ *checkpoint_duration* ]</span><span class="sxs-lookup"><span data-stu-id="c20c3-127">CHECKPOINT [ *checkpoint_duration* ]</span></span>|<span data-ttu-id="c20c3-128">Выдаются при выполнении команды [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT.</span><span class="sxs-lookup"><span data-stu-id="c20c3-128">Issued when you execute a [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT command.</span></span> <span data-ttu-id="c20c3-129">Ручная контрольная точка срабатывает в текущей базе данных для конкретного соединения.</span><span class="sxs-lookup"><span data-stu-id="c20c3-129">The manual checkpoint occurs in the current database for your connection.</span></span> <span data-ttu-id="c20c3-130">По умолчанию ручная контрольная точка выполняется до ее завершения.</span><span class="sxs-lookup"><span data-stu-id="c20c3-130">By default, manual checkpoints run to completion.</span></span> <span data-ttu-id="c20c3-131">Регулирование работает так же, как и для автоматической контрольной точки.</span><span class="sxs-lookup"><span data-stu-id="c20c3-131">Throttling works the same way as for automatic checkpoints.</span></span>  <span data-ttu-id="c20c3-132">При необходимости параметр *checkpoint_duration* указывает требуемое время в секундах для завершения контрольной точки.</span><span class="sxs-lookup"><span data-stu-id="c20c3-132">Optionally, the *checkpoint_duration* parameter specifies a requested amount of time, in seconds, for the checkpoint to complete.</span></span><br /><br /> <span data-ttu-id="c20c3-133">Дополнительные сведения см. в статье [CHECKPOINT (Transact-SQL)](/sql/t-sql/language-elements/checkpoint-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="c20c3-133">For more information, see [CHECKPOINT &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/checkpoint-transact-sql).</span></span>|  
|<span data-ttu-id="c20c3-134">Внутренние</span><span class="sxs-lookup"><span data-stu-id="c20c3-134">Internal</span></span>|<span data-ttu-id="c20c3-135">Нет.</span><span class="sxs-lookup"><span data-stu-id="c20c3-135">None.</span></span>|<span data-ttu-id="c20c3-136">Выдаются различными операциями сервера, такими как резервное копирование и создание моментального снимка базы данных, для обеспечения соответствия образа диска текущему состоянию журнала.</span><span class="sxs-lookup"><span data-stu-id="c20c3-136">Issued by various server operations such as backup and database-snapshot creation to guarantee that disk images match the current state of the log.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="c20c3-137">Расширенный параметр настройки `-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] позволяет администратору базы данных регулировать поведение ввода-вывода контрольной точки с учетом пропускной способности подсистемы ввода-вывода для некоторых типов контрольных точек.</span><span class="sxs-lookup"><span data-stu-id="c20c3-137">The `-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] advanced setup option enables a database administrator to throttle checkpoint I/O behavior based on the throughput of the I/O subsystem for some types of checkpoints.</span></span> <span data-ttu-id="c20c3-138">`-k`Параметр установки применяется к автоматическим контрольным точкам и любым иным нерегулируемым ручным и внутренним контрольным точкам.</span><span class="sxs-lookup"><span data-stu-id="c20c3-138">The `-k` setup option applies to automatic checkpoints and any otherwise unthrottled manual and internal checkpoints.</span></span>  
  
 <span data-ttu-id="c20c3-139">Для автоматических, ручных и внутренних контрольных точек в процессе восстановления базы данных следует произвести накат только тех изменений, которые выполнены после последней контрольной точки.</span><span class="sxs-lookup"><span data-stu-id="c20c3-139">For automatic, manual, and internal checkpoints, only modifications made after the latest checkpoint need to be rolled forward during database recovery.</span></span> <span data-ttu-id="c20c3-140">Это способствует сокращению времени, необходимому для восстановления базы данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-140">This reduces the time required to recover a database.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c20c3-141">Длительные незафиксированные транзакции увеличивают время восстановления для всех типов контрольных точек.</span><span class="sxs-lookup"><span data-stu-id="c20c3-141">Long-running uncommitted transactions increase recovery time for all types of checkpoints.</span></span>  
  
  
  
###  <a name="interaction-of-the-target_recovery_time-and-recovery-interval-options"></a><a name="InteractionBwnSettings"></a> <span data-ttu-id="c20c3-142">Взаимодействие параметров TARGET_RECOVERY_TIME и «recovery interval»</span><span class="sxs-lookup"><span data-stu-id="c20c3-142">Interaction of the TARGET_RECOVERY_TIME and 'recovery interval' Options</span></span>  
 <span data-ttu-id="c20c3-143">В следующей таблице обобщены сведения о взаимодействии между параметром \*\*sp_configure `recovery interval` \*\* на уровне сервера и инструкцией ALTER DATABASE, относящейся к конкретной базе данных... Параметр TARGET_RECOVERY_TIME.</span><span class="sxs-lookup"><span data-stu-id="c20c3-143">The following table summarizes the interaction between the server-wide **sp_configure'`recovery interval`'** setting and the database-specific ALTER DATABASE ... TARGET_RECOVERY_TIME setting.</span></span>  
  
|<span data-ttu-id="c20c3-144">target_recovery_time</span><span class="sxs-lookup"><span data-stu-id="c20c3-144">TARGET_RECOVERY_TIME</span></span>|<span data-ttu-id="c20c3-145">«recovery interval»</span><span class="sxs-lookup"><span data-stu-id="c20c3-145">'recovery interval'</span></span>|<span data-ttu-id="c20c3-146">Тип используемой контрольной точки</span><span class="sxs-lookup"><span data-stu-id="c20c3-146">Type of Checkpoint Used</span></span>|  
|----------------------------|-------------------------|-----------------------------|  
|<span data-ttu-id="c20c3-147">0</span><span class="sxs-lookup"><span data-stu-id="c20c3-147">0</span></span>|<span data-ttu-id="c20c3-148">0</span><span class="sxs-lookup"><span data-stu-id="c20c3-148">0</span></span>|<span data-ttu-id="c20c3-149">автоматические контрольные точки, для которых целевой интервал восстановления равен 1 минуте.</span><span class="sxs-lookup"><span data-stu-id="c20c3-149">automatic checkpoints whose target recovery interval is 1 minute.</span></span>|  
|<span data-ttu-id="c20c3-150">0</span><span class="sxs-lookup"><span data-stu-id="c20c3-150">0</span></span>|<span data-ttu-id="c20c3-151">> 0</span><span class="sxs-lookup"><span data-stu-id="c20c3-151">>0</span></span>|<span data-ttu-id="c20c3-152">Автоматические контрольные точки, целевой интервал восстановления которых указан с помощью пользовательского параметра **sp_configurerecovery interval** option.</span><span class="sxs-lookup"><span data-stu-id="c20c3-152">Automatic checkpoints whose target recovery interval is specified by the user defined setting of the **sp_configurerecovery interval** option.</span></span>|  
|<span data-ttu-id="c20c3-153">> 0</span><span class="sxs-lookup"><span data-stu-id="c20c3-153">>0</span></span>|<span data-ttu-id="c20c3-154">Неприменимо.</span><span class="sxs-lookup"><span data-stu-id="c20c3-154">Not applicable.</span></span>|<span data-ttu-id="c20c3-155">Косвенные контрольные точки, для которых целевое время восстановления определяется параметром TARGET_RECOVERY_TIME, выраженным в секундах.</span><span class="sxs-lookup"><span data-stu-id="c20c3-155">Indirect checkpoints whose target recovery time is determined by the TARGET_RECOVERY_TIME setting, expressed in seconds.</span></span>|  
  
###  <a name="automatic-checkpoints"></a><a name="AutomaticChkpt"></a><span data-ttu-id="c20c3-156">Автоматические контрольные точки</span><span class="sxs-lookup"><span data-stu-id="c20c3-156">Automatic Checkpoints</span></span>  
 <span data-ttu-id="c20c3-157">Автоматическая контрольная точка создается каждый раз, когда число записей журнала достигает числа, которое [!INCLUDE[ssDE](../../includes/ssde-md.md)] может обработать Оценка в течение времени, указанного в `recovery interval` параметре конфигурации сервера.</span><span class="sxs-lookup"><span data-stu-id="c20c3-157">An automatic checkpoint occurs each time that  the number of log records reaches the number the [!INCLUDE[ssDE](../../includes/ssde-md.md)] estimates it can process during the time specified in the `recovery interval` server configuration option.</span></span> <span data-ttu-id="c20c3-158">В каждой базе данных без определяемого пользователем целевого времени восстановления [!INCLUDE[ssDE](../../includes/ssde-md.md)] создает автоматические контрольные точки.</span><span class="sxs-lookup"><span data-stu-id="c20c3-158">In every database without a user-defined target recovery time, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] generates automatic checkpoints.</span></span> <span data-ttu-id="c20c3-159">Частота автоматических контрольных точек зависит от `recovery interval` параметра Расширенная конфигурация сервера, который указывает максимальное время, которое данный экземпляр сервера должен использовать для восстановления базы данных во время перезапуска системы.</span><span class="sxs-lookup"><span data-stu-id="c20c3-159">The frequency of automatic checkpoints depends on the `recovery interval` advanced server configuration option, which specifies the maximum time that a given server instance should use to recover a database during a system restart.</span></span> <span data-ttu-id="c20c3-160">[!INCLUDE[ssDE](../../includes/ssde-md.md)] определяет максимальное число записей журнала, которое он может обработать в пределах интервала восстановления.</span><span class="sxs-lookup"><span data-stu-id="c20c3-160">The [!INCLUDE[ssDE](../../includes/ssde-md.md)] estimates the maximum number of log records it can process within the recovery interval.</span></span> <span data-ttu-id="c20c3-161">Когда база данных, использующая автоматические контрольные точки, достигает данного максимального числа записей журнала, [!INCLUDE[ssDE](../../includes/ssde-md.md)] выдает контрольную точку базы данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-161">When a database that is using automatic checkpoints reaches this maximum number of log records, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] issues an checkpoint on the database.</span></span> <span data-ttu-id="c20c3-162">Интервал времени между автоматическими контрольными точками может сильно изменяться.</span><span class="sxs-lookup"><span data-stu-id="c20c3-162">The time interval between automatic checkpoints can be highly variable.</span></span> <span data-ttu-id="c20c3-163">В базе данных со значительной транзакционной рабочей нагрузкой контрольные точки будут устанавливаться более часто, чем в базе данных, используемой преимущественно для операций только чтения.</span><span class="sxs-lookup"><span data-stu-id="c20c3-163">A database with a substantial transaction workload will have more frequent checkpoints than a database that is used primarily for read-only operations.</span></span>  
  
 <span data-ttu-id="c20c3-164">Кроме того, в простой модели восстановления автоматическая контрольная точка становится в очередь, если журнал заполняется на 70 процентов.</span><span class="sxs-lookup"><span data-stu-id="c20c3-164">Also, under the simple recovery model, an automatic checkpoint is also queued if the log becomes 70 percent full.</span></span>  
  
 <span data-ttu-id="c20c3-165">В простой модели восстановления применение автоматической контрольной точки приводит к усечению неиспользуемого раздела журнала транзакций, если усечение журнала не откладывается под действием какого-то фактора.</span><span class="sxs-lookup"><span data-stu-id="c20c3-165">Under the simple recovery model, unless some factor is delaying log truncation, an automatic checkpoint truncates the unused section of the transaction log.</span></span> <span data-ttu-id="c20c3-166">В отличие от этого, в полной модели восстановления и модели восстановления с неполным протоколированием после установления цепочки резервных копий журнала применение автоматических контрольных точек не вызывает усечение журнала.</span><span class="sxs-lookup"><span data-stu-id="c20c3-166">In contrast, under the full and bulk-logged recovery models, once a log backup chain has been established, automatic checkpoints do not cause log truncation.</span></span> <span data-ttu-id="c20c3-167">Дополнительные сведения см. в статье [Журнал транзакций (SQL Server)](the-transaction-log-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="c20c3-167">For more information, see [The Transaction Log &#40;SQL Server&#41;](the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="c20c3-168">После сбоя системы продолжительность времени, требуемого для восстановления данной базы данных, в большой степени зависит от непредсказуемо изменяющегося количества операций ввода-вывода, требуемых для повтора измененных страниц, которые не были зафиксированы ко времени сбоя.</span><span class="sxs-lookup"><span data-stu-id="c20c3-168">After a system crash, the length of time required to recover a given database is largely dependent on the amount of random I/O needed to redo pages that were dirty at the time of the crash.</span></span> <span data-ttu-id="c20c3-169">Это означает, что `recovery interval` параметр является ненадежным.</span><span class="sxs-lookup"><span data-stu-id="c20c3-169">This means that the `recovery interval` setting is unreliable.</span></span> <span data-ttu-id="c20c3-170">Он не позволяет определить точную продолжительность восстановления.</span><span class="sxs-lookup"><span data-stu-id="c20c3-170">It cannot determine an accurate recovery duration.</span></span> <span data-ttu-id="c20c3-171">Более того, при выполнении автоматической контрольной точки общее количество операций ввода-вывода, относящихся к данным, увеличивается значительно и довольно непредсказуемо.</span><span class="sxs-lookup"><span data-stu-id="c20c3-171">Furthermore, when an automatic checkpoint is in progress, the general I/O activity for data increases significantly and quite unpredictably.</span></span>  
  
  
####  <a name="impact-of-recovery-interval-on-recovery-performance"></a><a name="PerformanceImpact"></a><span data-ttu-id="c20c3-172">Влияние интервала восстановления на производительность восстановления</span><span class="sxs-lookup"><span data-stu-id="c20c3-172">Impact of Recovery Interval on Recovery Performance</span></span>  
 <span data-ttu-id="c20c3-173">Для системы оперативной обработки транзакций (OLTP), использующей короткие транзакции, `recovery interval` является основным фактором, определяющим время восстановления.</span><span class="sxs-lookup"><span data-stu-id="c20c3-173">For an online transaction processing (OLTP) system using short transactions, `recovery interval` is the primary factor determining recovery time.</span></span> <span data-ttu-id="c20c3-174">Однако этот `recovery interval` параметр не влияет на время, необходимое для отмены долго выполняющейся транзакции.</span><span class="sxs-lookup"><span data-stu-id="c20c3-174">However, the `recovery interval` option does not affect the time required to undo a long-running transaction.</span></span> <span data-ttu-id="c20c3-175">Восстановление базы данных с длительной транзакцией может занять намного больше времени, чем указано в `recovery interval` параметре.</span><span class="sxs-lookup"><span data-stu-id="c20c3-175">Recovery of a database with a long-running transaction can take much longer than the specified in the `recovery interval` option.</span></span> <span data-ttu-id="c20c3-176">Например, если длительная транзакция заняла два часа для выполнения обновлений до отключения экземпляра сервера, фактическое восстановление занимает значительно больше времени, чем `recovery interval` значение для восстановления длинной транзакции.</span><span class="sxs-lookup"><span data-stu-id="c20c3-176">For example, if a long-running transaction took two hours to perform updates before the server instance became disabled, the actual recovery takes considerably longer than the `recovery interval` value to recover the long transaction.</span></span> <span data-ttu-id="c20c3-177">Дополнительные сведения о влиянии длительных транзакций на время восстановления см. в статье [Журнал транзакций (SQL Server)](the-transaction-log-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="c20c3-177">For more information about the impact of a long running transaction on recovery time, see [The Transaction Log &#40;SQL Server&#41;](the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="c20c3-178">Как правило, значения по умолчанию обеспечивают оптимальную производительность восстановления.</span><span class="sxs-lookup"><span data-stu-id="c20c3-178">Typically, the default values provides optimal recovery performance.</span></span> <span data-ttu-id="c20c3-179">Однако изменение интервала восстановления может способствовать повышению производительности в следующих случаях.</span><span class="sxs-lookup"><span data-stu-id="c20c3-179">However, changing the recovery interval might improve performance in the following circumstances:</span></span>  
  
-   <span data-ttu-id="c20c3-180">Если восстановление обычно занимает намного больше 1 минуты при отсутствии отката длительных транзакций.</span><span class="sxs-lookup"><span data-stu-id="c20c3-180">If recovery routinely takes significantly longer than 1 minute when long-running transactions are not being rolled back.</span></span>  
  
-   <span data-ttu-id="c20c3-181">Если обнаружено, что из-за более частого выполнения контрольных точек производительность базы данных снижается.</span><span class="sxs-lookup"><span data-stu-id="c20c3-181">If you notice that frequent checkpoints are impairing performance on a database.</span></span>  
  
 <span data-ttu-id="c20c3-182">Если принято решение увеличить параметр `recovery interval`, то рекомендуется увеличивать его постепенно с небольшими приращениями и оценивать влияние каждого приращения на производительность восстановления.</span><span class="sxs-lookup"><span data-stu-id="c20c3-182">If you decide to increase the `recovery interval` setting, we recommend increasing it gradually by small increments and evaluating the effect of each incremental increase on recovery performance.</span></span> <span data-ttu-id="c20c3-183">Этот подход важен, так как при `recovery interval` увеличении параметра Восстановление базы данных занимает больше времени.</span><span class="sxs-lookup"><span data-stu-id="c20c3-183">This approach is important because as the `recovery interval` setting increases, database recovery takes that many times longer to complete.</span></span> <span data-ttu-id="c20c3-184">Например, если изменить `recovery interval` 10, восстановление будет выполнено примерно в 10 раз дольше, чем при `recovery interval` установке значения 0.</span><span class="sxs-lookup"><span data-stu-id="c20c3-184">For example, if you change `recovery interval` 10, recovery takes approximately 10 times longer to complete than when `recovery interval` is set to zero.</span></span>  
  
  
###  <a name="indirect-checkpoints"></a><a name="IndirectChkpt"></a><span data-ttu-id="c20c3-185">Косвенные контрольные точки</span><span class="sxs-lookup"><span data-stu-id="c20c3-185">Indirect Checkpoints</span></span>  
 <span data-ttu-id="c20c3-186">Косвенные контрольные точки, которые были впервые введены в [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], предоставляют настраиваемый на уровне базы данных вариант, альтернативный по отношению к автоматическим контрольным точкам.</span><span class="sxs-lookup"><span data-stu-id="c20c3-186">Indirect checkpoints, new in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], provide a configurable database-level alternative to automatic checkpoints.</span></span> <span data-ttu-id="c20c3-187">В случае сбоя системы косвенные контрольные точки обеспечивают восстановление за потенциально меньшее и более предсказуемое время, чем автоматические контрольные точки.</span><span class="sxs-lookup"><span data-stu-id="c20c3-187">In the event of a system crash, indirect checkpoints provide potentially faster, more predictable recovery time than automatic checkpoints.</span></span> <span data-ttu-id="c20c3-188">Косвенные контрольные точки имеют следующие преимущества.</span><span class="sxs-lookup"><span data-stu-id="c20c3-188">Indirect checkpoints offer the following advantages:</span></span>  
  
-   <span data-ttu-id="c20c3-189">В базе данных, которая настроена на использование косвенных контрольных точек, может снизиться производительность обработки транзакционной нагрузки в режиме «в сети».</span><span class="sxs-lookup"><span data-stu-id="c20c3-189">An online transactional workload on a database that is configured for indirect checkpoints could experience performance degradation.</span></span> <span data-ttu-id="c20c3-190">Косвенные конечные точки сохраняют количество «грязных» страниц ниже определенного порогового значения, чтобы восстановление базы данных выполнялось в течение заданного времени восстановления.</span><span class="sxs-lookup"><span data-stu-id="c20c3-190">Indirect checkpoints make sure that the number of dirty pages are below a certain threshold so that the database recovery completes within the target recovery time.</span></span> <span data-ttu-id="c20c3-191">Параметр конфигурации интервала восстановления использует количество транзакций для определения времени восстановления вместо косвенных конечных точек, которые основываются на количестве «грязных» страниц.</span><span class="sxs-lookup"><span data-stu-id="c20c3-191">The recovery interval configuration option uses the number of transactions to determine the recovery time as opposed to indirect checkpoints which makes use of number of dirty pages.</span></span> <span data-ttu-id="c20c3-192">Если косвенные конечные точки включены в базе данных, получающей большое число операций DML, средство фоновой записи может начать агрессивно сбрасывать «грязные» буферы обмена на диск, чтобы гарантировать, что время, необходимое для выполнения восстановления, находится в пределах целевого периода восстановления базы данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-192">When indirect checkpoints are enabled on a database receiving a large number of DML operations, the background writer can start aggressively flushing dirty buffers to disk to ensure that the time required to perform recovery is within the target recovery time set of the database.</span></span> <span data-ttu-id="c20c3-193">Это может вызвать дополнительную активность операций ввода-вывода в определенных системах, что способно привести к созданию узких мест с точки зрения производительности, если подсистема диска превысила пороговое значение операций ввода-вывода или приближается к нему.</span><span class="sxs-lookup"><span data-stu-id="c20c3-193">This can cause additional I/O activity on certain systems which can contribute to a performance bottleneck if the disk subsystem is operating above or nearing the I/O threshold.</span></span>  
  
-   <span data-ttu-id="c20c3-194">Косвенные контрольные точки позволяют надежно управлять временем восстановления базы данных, поскольку устраняются затраты времени на ввод-вывод с непредсказуемым объемом при выполнении операций REDO.</span><span class="sxs-lookup"><span data-stu-id="c20c3-194">Indirect checkpoints enable you to reliably control database recovery time by factoring in the cost of random I/O during REDO.</span></span> <span data-ttu-id="c20c3-195">Это позволяет экземпляру сервера оставаться в пределах верхних границ времени восстановления для каждой конкретной базы данных (кроме тех случаев, когда из-за длительной транзакции чрезмерно возрастает время выполнения операций UNDO).</span><span class="sxs-lookup"><span data-stu-id="c20c3-195">This enables a server instance to stay within an upper-bound on recovery times for a given database (except when a long-running transaction causes excessive UNDO times).</span></span>  
  
-   <span data-ttu-id="c20c3-196">При использовании косвенных контрольных точек снижаются пиковые объемы ввода-вывода, вызванные выполнением контрольных точек, поскольку измененные незафиксированные страницы постоянно записываются на диск в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="c20c3-196">Indirect checkpoints reduce checkpoint-related I/O spiking by continually writing dirty pages to disk in the background.</span></span>  
  
 <span data-ttu-id="c20c3-197">Тем не менее в базе данных, которая настроена на использование косвенных контрольных точек, может снизиться производительность обработки оперативной транзакционной нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c20c3-197">However, an online transactional workload on a database that is configured for indirect checkpoints could experience performance degradation.</span></span> <span data-ttu-id="c20c3-198">Это происходит из-за того, что фоновый модуль записи, используемый косвенной контрольной точкой, иногда увеличивает общую, связанную с записью нагрузку для экземпляра сервера.</span><span class="sxs-lookup"><span data-stu-id="c20c3-198">This is because the background writer used by indirect checkpoint sometimes increases the total write load for a server instance.</span></span>  
  
  
###  <a name="internal-checkpoints"></a><a name="EventsCausingChkpt"></a><span data-ttu-id="c20c3-199">Внутренние контрольные точки</span><span class="sxs-lookup"><span data-stu-id="c20c3-199">Internal Checkpoints</span></span>  
 <span data-ttu-id="c20c3-200">Внутренние контрольные точки создаются различными компонентами сервера для обеспечения того, чтобы образ диска соответствовал текущему состоянию журнала.</span><span class="sxs-lookup"><span data-stu-id="c20c3-200">Internal Checkpoints are generated by various server components to guarantee that disk images match the current state of the log.</span></span> <span data-ttu-id="c20c3-201">Внутренние контрольные точки создаются в ответ на следующие события.</span><span class="sxs-lookup"><span data-stu-id="c20c3-201">Internal checkpoint are generated in response to the following events:</span></span>  
  
-   <span data-ttu-id="c20c3-202">При добавлении или удалении файлов баз данных с использованием инструкции ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="c20c3-202">Database files have been added or removed by using ALTER DATABASE.</span></span>  
  
-   <span data-ttu-id="c20c3-203">При создании резервной копии базы данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-203">A database backup is taken.</span></span>  
  
-   <span data-ttu-id="c20c3-204">Явное или внутреннее создание моментального снимка базы данных для команды DBCC CHECK.</span><span class="sxs-lookup"><span data-stu-id="c20c3-204">A database snapshot is created, whether explicitly or internally for DBCC CHECK.</span></span>  
  
-   <span data-ttu-id="c20c3-205">При выполнении действия, требующего отключения базы данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-205">An activity requiring a database shutdown is performed.</span></span> <span data-ttu-id="c20c3-206">Примерами могут служить присвоение параметру AUTO_CLOSE значения ON и закрытие последнего соединения пользователя с базой данных или изменение параметра базы данных, требующее перезапуска базы данных.</span><span class="sxs-lookup"><span data-stu-id="c20c3-206">For example, AUTO_CLOSE is ON and the last user connection to the database is closed, or a database option change is made that requires a restart of the database.</span></span>  
  
-   <span data-ttu-id="c20c3-207">Экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] останавливается путем остановки службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER).</span><span class="sxs-lookup"><span data-stu-id="c20c3-207">An instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is stopped by stopping the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER) service .</span></span> <span data-ttu-id="c20c3-208">И в том и в другом случае будет создана контрольная точка для каждой базы данных в экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c20c3-208">Either action  causes a checkpoint in each database in the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="c20c3-209">Перевод экземпляра отказоустойчивого кластера [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (FCI) в режим «вне сети».</span><span class="sxs-lookup"><span data-stu-id="c20c3-209">Bringing a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] failover cluster instance (FCI) offline.</span></span>  
  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="c20c3-210">Связанные задачи</span><span class="sxs-lookup"><span data-stu-id="c20c3-210">Related Tasks</span></span>  
 <span data-ttu-id="c20c3-211">**Изменение интервала восстановления на экземпляре сервера**</span><span class="sxs-lookup"><span data-stu-id="c20c3-211">**To change the recovery interval on a server instance**</span></span>  
  
-   [<span data-ttu-id="c20c3-212">Configure the recovery interval Server Configuration Option</span><span class="sxs-lookup"><span data-stu-id="c20c3-212">Configure the recovery interval Server Configuration Option</span></span>](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)  
  
 <span data-ttu-id="c20c3-213">**Настройка косвенных контрольных точек в базе данных**</span><span class="sxs-lookup"><span data-stu-id="c20c3-213">**To configure indirect checkpoints on a database**</span></span>  
  
-   [<span data-ttu-id="c20c3-214">Изменение целевого времени восстановления базы данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c20c3-214">Change the Target Recovery Time of a Database &#40;SQL Server&#41;</span></span>](change-the-target-recovery-time-of-a-database-sql-server.md)  
  
 <span data-ttu-id="c20c3-215">**Выдача команды на создание контрольной точки в базе данных вручную**</span><span class="sxs-lookup"><span data-stu-id="c20c3-215">**To issue a manual checkpoint on a database**</span></span>  
  
-   [<span data-ttu-id="c20c3-216">CHECKPOINT (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="c20c3-216">CHECKPOINT &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/language-elements/checkpoint-transact-sql)  
  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="c20c3-217">См. также</span><span class="sxs-lookup"><span data-stu-id="c20c3-217">Related Content</span></span>  
  
-   <span data-ttu-id="c20c3-218">[Физическая архитектура журнала транзакций](https://technet.microsoft.com/library/ms179355.aspx) (электронная документация по [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] )</span><span class="sxs-lookup"><span data-stu-id="c20c3-218">[Transaction Log Physical Architecture](https://technet.microsoft.com/library/ms179355.aspx) (in [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] Books Oline)</span></span>  
  
  
## <a name="see-also"></a><span data-ttu-id="c20c3-219">См. также:</span><span class="sxs-lookup"><span data-stu-id="c20c3-219">See Also</span></span>  
 [<span data-ttu-id="c20c3-220">Журнал транзакций (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c20c3-220">The Transaction Log &#40;SQL Server&#41;</span></span>](the-transaction-log-sql-server.md)  
  
  
