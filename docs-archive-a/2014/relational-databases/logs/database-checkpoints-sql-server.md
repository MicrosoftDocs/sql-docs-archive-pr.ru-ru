---
title: Контрольные точки базы данных (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 10/13/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- automatic checkpoints
- transaction logs [SQL Server], checkpoints
- logs [SQL Server], active
- pages [SQL Server], dirty
- MinLSN
- checkpoints [SQL Server]
- pages [SQL Server], flushing
- dirty pages
- transaction logs [SQL Server], active logs
- recovery interval option [SQL Server]
- buffer cache [SQL Server]
- logs [SQL Server], checkpoints
- Minimum Recovery LSN
- flushing pages
- active logs
ms.assetid: 98a80238-7409-4708-8a7d-5defd9957185
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 5776d4a23223637c50ac40098fa44342d5cd94a9
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658256"
---
# <a name="database-checkpoints-sql-server"></a>Контрольные точки базы данных (SQL Server)
  В этом разделе содержится обзор [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] контрольных точек базы данных. *Контрольная точка* создает известную надежную точку, с которой [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] может начать применение изменений, содержащихся в журнале, во время восстановления после непредвиденного отключения или аварии.  
  
  
##  <a name="overview-of-checkpoints"></a><a name="Overview"></a>Общие сведения о контрольных точках  
 Из соображений производительности [!INCLUDE[ssDE](../../includes/ssde-md.md)] выполняет изменения страниц базы данных в памяти (в буферном кэше) и не записывает эти страницы на диск после каждого изменения. Вместо этого [!INCLUDE[ssDE](../../includes/ssde-md.md)] периодически выдает контрольную точку на каждой базе данных. Новая *контрольная точка* записывает текущие страницы, измененные в памяти (известные как *измененные незафиксированные страницы*), вместе со сведениями журнала транзакций из памяти на диск, а также сведения о журнале транзакций.  
  
 [!INCLUDE[ssDE](../../includes/ssde-md.md)] поддерживает несколько типов контрольных точек: автоматические, косвенные, ручные и внутренние. Следующая таблица содержит сводку типов контрольных точек.  
  
|Имя|[!INCLUDE[tsql](../../includes/tsql-md.md)] Интерфейс|Описание|  
|----------|----------------------------------|-----------------|  
|Автоматически|EXEC sp_configure **" `recovery interval` ", " *`seconds`* "**|Автоматически выдается в фоновом режиме для удовлетворения верхнего предела времени, предлагаемого `recovery interval` параметром конфигурации сервера. Автоматические контрольные точки выполняются до их завершения.  Автоматические контрольные точки регулируются в зависимости от числа необработанных записей и от того, обнаруживает ли [!INCLUDE[ssDE](../../includes/ssde-md.md)] увеличение задержки записи более чем на 20 миллисекунд.<br /><br /> Дополнительные сведения см. в статье [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).|  
|Косвенные|ИЗМЕНИТЬ БАЗУ ДАННЫХ... ЗАДАТЬ TARGET_RECOVERY_TIME **=** _TARGET_RECOVERY_TIME_ {Seconds &#124; минут}|Выдаются в фоновом режиме для обеспечения соответствия пользовательскому целевому времени восстановления для конкретной базы данных. Целевое время восстановления по умолчанию равно 0, что приводит к использованию эвристики автоматических контрольных точек в базе данных. Если была использована инструкция ALTER DATABASE для установки TARGET_RECOVERY_TIME в значение >0, то используется это значение, а не интервал восстановления, указанный для экземпляра сервера.<br /><br /> Дополнительные сведения см. в разделе [Изменение целевого времени восстановления базы данных (SQL Server)](change-the-target-recovery-time-of-a-database-sql-server.md).|  
|Вручную|CHECKPOINT [ *checkpoint_duration* ]|Выдаются при выполнении команды [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT. Ручная контрольная точка срабатывает в текущей базе данных для конкретного соединения. По умолчанию ручная контрольная точка выполняется до ее завершения. Регулирование работает так же, как и для автоматической контрольной точки.  При необходимости параметр *checkpoint_duration* указывает требуемое время в секундах для завершения контрольной точки.<br /><br /> Дополнительные сведения см. в статье [CHECKPOINT (Transact-SQL)](/sql/t-sql/language-elements/checkpoint-transact-sql).|  
|Внутренние|Нет.|Выдаются различными операциями сервера, такими как резервное копирование и создание моментального снимка базы данных, для обеспечения соответствия образа диска текущему состоянию журнала.|  
  
> [!NOTE]  
>  Расширенный параметр настройки `-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] позволяет администратору базы данных регулировать поведение ввода-вывода контрольной точки с учетом пропускной способности подсистемы ввода-вывода для некоторых типов контрольных точек. `-k`Параметр установки применяется к автоматическим контрольным точкам и любым иным нерегулируемым ручным и внутренним контрольным точкам.  
  
 Для автоматических, ручных и внутренних контрольных точек в процессе восстановления базы данных следует произвести накат только тех изменений, которые выполнены после последней контрольной точки. Это способствует сокращению времени, необходимому для восстановления базы данных.  
  
> [!IMPORTANT]  
>  Длительные незафиксированные транзакции увеличивают время восстановления для всех типов контрольных точек.  
  
  
  
###  <a name="interaction-of-the-target_recovery_time-and-recovery-interval-options"></a><a name="InteractionBwnSettings"></a> Взаимодействие параметров TARGET_RECOVERY_TIME и «recovery interval»  
 В следующей таблице обобщены сведения о взаимодействии между параметром **sp_configure `recovery interval` ** на уровне сервера и инструкцией ALTER DATABASE, относящейся к конкретной базе данных... Параметр TARGET_RECOVERY_TIME.  
  
|target_recovery_time|«recovery interval»|Тип используемой контрольной точки|  
|----------------------------|-------------------------|-----------------------------|  
|0|0|автоматические контрольные точки, для которых целевой интервал восстановления равен 1 минуте.|  
|0|> 0|Автоматические контрольные точки, целевой интервал восстановления которых указан с помощью пользовательского параметра **sp_configurerecovery interval** option.|  
|> 0|Неприменимо.|Косвенные контрольные точки, для которых целевое время восстановления определяется параметром TARGET_RECOVERY_TIME, выраженным в секундах.|  
  
###  <a name="automatic-checkpoints"></a><a name="AutomaticChkpt"></a>Автоматические контрольные точки  
 Автоматическая контрольная точка создается каждый раз, когда число записей журнала достигает числа, которое [!INCLUDE[ssDE](../../includes/ssde-md.md)] может обработать Оценка в течение времени, указанного в `recovery interval` параметре конфигурации сервера. В каждой базе данных без определяемого пользователем целевого времени восстановления [!INCLUDE[ssDE](../../includes/ssde-md.md)] создает автоматические контрольные точки. Частота автоматических контрольных точек зависит от `recovery interval` параметра Расширенная конфигурация сервера, который указывает максимальное время, которое данный экземпляр сервера должен использовать для восстановления базы данных во время перезапуска системы. [!INCLUDE[ssDE](../../includes/ssde-md.md)] определяет максимальное число записей журнала, которое он может обработать в пределах интервала восстановления. Когда база данных, использующая автоматические контрольные точки, достигает данного максимального числа записей журнала, [!INCLUDE[ssDE](../../includes/ssde-md.md)] выдает контрольную точку базы данных. Интервал времени между автоматическими контрольными точками может сильно изменяться. В базе данных со значительной транзакционной рабочей нагрузкой контрольные точки будут устанавливаться более часто, чем в базе данных, используемой преимущественно для операций только чтения.  
  
 Кроме того, в простой модели восстановления автоматическая контрольная точка становится в очередь, если журнал заполняется на 70 процентов.  
  
 В простой модели восстановления применение автоматической контрольной точки приводит к усечению неиспользуемого раздела журнала транзакций, если усечение журнала не откладывается под действием какого-то фактора. В отличие от этого, в полной модели восстановления и модели восстановления с неполным протоколированием после установления цепочки резервных копий журнала применение автоматических контрольных точек не вызывает усечение журнала. Дополнительные сведения см. в статье [Журнал транзакций (SQL Server)](the-transaction-log-sql-server.md).  
  
 После сбоя системы продолжительность времени, требуемого для восстановления данной базы данных, в большой степени зависит от непредсказуемо изменяющегося количества операций ввода-вывода, требуемых для повтора измененных страниц, которые не были зафиксированы ко времени сбоя. Это означает, что `recovery interval` параметр является ненадежным. Он не позволяет определить точную продолжительность восстановления. Более того, при выполнении автоматической контрольной точки общее количество операций ввода-вывода, относящихся к данным, увеличивается значительно и довольно непредсказуемо.  
  
  
####  <a name="impact-of-recovery-interval-on-recovery-performance"></a><a name="PerformanceImpact"></a>Влияние интервала восстановления на производительность восстановления  
 Для системы оперативной обработки транзакций (OLTP), использующей короткие транзакции, `recovery interval` является основным фактором, определяющим время восстановления. Однако этот `recovery interval` параметр не влияет на время, необходимое для отмены долго выполняющейся транзакции. Восстановление базы данных с длительной транзакцией может занять намного больше времени, чем указано в `recovery interval` параметре. Например, если длительная транзакция заняла два часа для выполнения обновлений до отключения экземпляра сервера, фактическое восстановление занимает значительно больше времени, чем `recovery interval` значение для восстановления длинной транзакции. Дополнительные сведения о влиянии длительных транзакций на время восстановления см. в статье [Журнал транзакций (SQL Server)](the-transaction-log-sql-server.md).  
  
 Как правило, значения по умолчанию обеспечивают оптимальную производительность восстановления. Однако изменение интервала восстановления может способствовать повышению производительности в следующих случаях.  
  
-   Если восстановление обычно занимает намного больше 1 минуты при отсутствии отката длительных транзакций.  
  
-   Если обнаружено, что из-за более частого выполнения контрольных точек производительность базы данных снижается.  
  
 Если принято решение увеличить параметр `recovery interval`, то рекомендуется увеличивать его постепенно с небольшими приращениями и оценивать влияние каждого приращения на производительность восстановления. Этот подход важен, так как при `recovery interval` увеличении параметра Восстановление базы данных занимает больше времени. Например, если изменить `recovery interval` 10, восстановление будет выполнено примерно в 10 раз дольше, чем при `recovery interval` установке значения 0.  
  
  
###  <a name="indirect-checkpoints"></a><a name="IndirectChkpt"></a>Косвенные контрольные точки  
 Косвенные контрольные точки, которые были впервые введены в [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], предоставляют настраиваемый на уровне базы данных вариант, альтернативный по отношению к автоматическим контрольным точкам. В случае сбоя системы косвенные контрольные точки обеспечивают восстановление за потенциально меньшее и более предсказуемое время, чем автоматические контрольные точки. Косвенные контрольные точки имеют следующие преимущества.  
  
-   В базе данных, которая настроена на использование косвенных контрольных точек, может снизиться производительность обработки транзакционной нагрузки в режиме «в сети». Косвенные конечные точки сохраняют количество «грязных» страниц ниже определенного порогового значения, чтобы восстановление базы данных выполнялось в течение заданного времени восстановления. Параметр конфигурации интервала восстановления использует количество транзакций для определения времени восстановления вместо косвенных конечных точек, которые основываются на количестве «грязных» страниц. Если косвенные конечные точки включены в базе данных, получающей большое число операций DML, средство фоновой записи может начать агрессивно сбрасывать «грязные» буферы обмена на диск, чтобы гарантировать, что время, необходимое для выполнения восстановления, находится в пределах целевого периода восстановления базы данных. Это может вызвать дополнительную активность операций ввода-вывода в определенных системах, что способно привести к созданию узких мест с точки зрения производительности, если подсистема диска превысила пороговое значение операций ввода-вывода или приближается к нему.  
  
-   Косвенные контрольные точки позволяют надежно управлять временем восстановления базы данных, поскольку устраняются затраты времени на ввод-вывод с непредсказуемым объемом при выполнении операций REDO. Это позволяет экземпляру сервера оставаться в пределах верхних границ времени восстановления для каждой конкретной базы данных (кроме тех случаев, когда из-за длительной транзакции чрезмерно возрастает время выполнения операций UNDO).  
  
-   При использовании косвенных контрольных точек снижаются пиковые объемы ввода-вывода, вызванные выполнением контрольных точек, поскольку измененные незафиксированные страницы постоянно записываются на диск в фоновом режиме.  
  
 Тем не менее в базе данных, которая настроена на использование косвенных контрольных точек, может снизиться производительность обработки оперативной транзакционной нагрузки. Это происходит из-за того, что фоновый модуль записи, используемый косвенной контрольной точкой, иногда увеличивает общую, связанную с записью нагрузку для экземпляра сервера.  
  
  
###  <a name="internal-checkpoints"></a><a name="EventsCausingChkpt"></a>Внутренние контрольные точки  
 Внутренние контрольные точки создаются различными компонентами сервера для обеспечения того, чтобы образ диска соответствовал текущему состоянию журнала. Внутренние контрольные точки создаются в ответ на следующие события.  
  
-   При добавлении или удалении файлов баз данных с использованием инструкции ALTER DATABASE.  
  
-   При создании резервной копии базы данных.  
  
-   Явное или внутреннее создание моментального снимка базы данных для команды DBCC CHECK.  
  
-   При выполнении действия, требующего отключения базы данных. Примерами могут служить присвоение параметру AUTO_CLOSE значения ON и закрытие последнего соединения пользователя с базой данных или изменение параметра базы данных, требующее перезапуска базы данных.  
  
-   Экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] останавливается путем остановки службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER). И в том и в другом случае будет создана контрольная точка для каждой базы данных в экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  
  
-   Перевод экземпляра отказоустойчивого кластера [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (FCI) в режим «вне сети».  
  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
 **Изменение интервала восстановления на экземпляре сервера**  
  
-   [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)  
  
 **Настройка косвенных контрольных точек в базе данных**  
  
-   [Изменение целевого времени восстановления базы данных (SQL Server)](change-the-target-recovery-time-of-a-database-sql-server.md)  
  
 **Выдача команды на создание контрольной точки в базе данных вручную**  
  
-   [CHECKPOINT (Transact-SQL)](/sql/t-sql/language-elements/checkpoint-transact-sql)  
  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> См. также  
  
-   [Физическая архитектура журнала транзакций](https://technet.microsoft.com/library/ms179355.aspx) (электронная документация по [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] )  
  
  
## <a name="see-also"></a>См. также:  
 [Журнал транзакций (SQL Server)](the-transaction-log-sql-server.md)  
  
  
