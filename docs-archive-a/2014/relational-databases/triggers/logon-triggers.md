---
title: Триггеры входа | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
f1_keywords:
- logon triggers
- login triggers
helpviewer_keywords:
- triggers [SQL Server], logon
ms.assetid: 2f0ebb2f-de10-482d-9806-1a5de5b312b8
author: rothja
ms.author: jroth
ms.openlocfilehash: cda0be25f07ed2ee283b9707884041e7c6e4692f
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87668137"
---
# <a name="logon-triggers"></a><span data-ttu-id="61a2d-102">Триггеры входа</span><span class="sxs-lookup"><span data-stu-id="61a2d-102">Logon Triggers</span></span>
  <span data-ttu-id="61a2d-103">Триггеры входа вызывают срабатывание хранимых процедур в ответ на событие LOGON.</span><span class="sxs-lookup"><span data-stu-id="61a2d-103">Logon triggers fire stored procedures in response to a LOGON event.</span></span> <span data-ttu-id="61a2d-104">Это событие вызывается при установке пользовательского сеанса с экземпляром [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="61a2d-104">This event is raised when a user session is established with an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="61a2d-105">Триггеры входа срабатывают после завершения этапа проверки подлинности при входе, но перед тем, как пользовательский сеанс реально устанавливается.</span><span class="sxs-lookup"><span data-stu-id="61a2d-105">Logon triggers fire after the authentication phase of logging in finishes, but before the user session is actually established.</span></span> <span data-ttu-id="61a2d-106">Следовательно, все сообщения, которые возникают внутри триггера и обычно достигают пользователя, такие как сообщения об ошибках и сообщения от инструкции PRINT, перенаправляются в журнал ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="61a2d-106">Therefore, all messages originating inside the trigger that would typically reach the user, such as error messages and messages from the PRINT statement, are diverted to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="61a2d-107">Если проверка подлинности завершается сбоем, триггеры входа не срабатывают.</span><span class="sxs-lookup"><span data-stu-id="61a2d-107">Logon triggers do not fire if authentication fails.</span></span>  
  
 <span data-ttu-id="61a2d-108">Можно использовать триггеры входа для проверки и управления сеансами сервера, например для отслеживания входов в систему, ограничения входов в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]или ограничения числа сеансов для конкретного имени входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-108">You can use logon triggers to audit and control server sessions, such as by tracking login activity, restricting logins to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], or limiting the number of sessions for a specific login.</span></span> <span data-ttu-id="61a2d-109">Например, в следующем коде триггер входа запрещает попытки входа на [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , инициированные под именем входа *login_test* , если уже созданы три пользовательских сеанса под этим именем входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-109">For example, in the following code, the logon trigger denies log in attempts to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] initiated by login *login_test* if there are already three user sessions created by that login.</span></span>  
  
 [!code-sql[TriggerDDL#LogonTrigger1](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#logontrigger1)]  
  
 <span data-ttu-id="61a2d-110">Обратите внимание, что событие LOGON соответствует событию AUDIT_LOGIN трассировки SQL, которое можно использовать в [уведомлениях о событии](../service-broker/event-notifications.md).</span><span class="sxs-lookup"><span data-stu-id="61a2d-110">Note that the LOGON event corresponds to the AUDIT_LOGIN SQL Trace event, which can be used in [Event Notifications](../service-broker/event-notifications.md).</span></span> <span data-ttu-id="61a2d-111">Основное отличие между триггерами и уведомлениями о событиях состоит в том, что триггеры вызываются синхронно с событиями, тогда как уведомления о событиях асинхронны.</span><span class="sxs-lookup"><span data-stu-id="61a2d-111">The primary difference between triggers and event notifications is that triggers are raised synchronously with events, whereas event notifications are asynchronous.</span></span> <span data-ttu-id="61a2d-112">Это означает, например, что если необходимо остановить установление сеанса, необходимо использовать триггер входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-112">This means, for example, that if you want to stop a session from being established, you must use a logon trigger.</span></span> <span data-ttu-id="61a2d-113">Для этой цели нельзя использовать уведомление о событии AUDIT_LOGIN.</span><span class="sxs-lookup"><span data-stu-id="61a2d-113">An event notification on an AUDIT_LOGIN event cannot be used for this purpose.</span></span>  
  
## <a name="specifying-first-and-last-trigger"></a><span data-ttu-id="61a2d-114">Указание первого и последнего триггера</span><span class="sxs-lookup"><span data-stu-id="61a2d-114">Specifying First and Last Trigger</span></span>  
 <span data-ttu-id="61a2d-115">В событии LOGON может быть определено несколько триггеров.</span><span class="sxs-lookup"><span data-stu-id="61a2d-115">Multiple triggers can be defined on the LOGON event.</span></span> <span data-ttu-id="61a2d-116">Любой из этих триггеров может быть назначен как первый или последний триггер, активируемый при возникновении некоторого события с использованием системной хранимой процедуры [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="61a2d-116">Any one of these triggers can be designated the first or last trigger to be fired on an event by using the [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) system stored procedure.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="61a2d-117">не гарантирует порядок выполнения остальных триггеров.</span><span class="sxs-lookup"><span data-stu-id="61a2d-117">does not guarantee the execution order of the remaining triggers.</span></span>  
  
## <a name="managing-transactions"></a><span data-ttu-id="61a2d-118">Управление транзакциями</span><span class="sxs-lookup"><span data-stu-id="61a2d-118">Managing Transactions</span></span>  
 <span data-ttu-id="61a2d-119">Перед тем как [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] активирует триггер входа, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] создает неявную транзакцию, которая не зависит ни от какой пользовательской транзакции.</span><span class="sxs-lookup"><span data-stu-id="61a2d-119">Before [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fires a logon trigger, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an implicit transaction that is independent from any user transaction.</span></span> <span data-ttu-id="61a2d-120">Таким образом, при срабатывании первого триггера входа счетчик транзакций имеет значение 1.</span><span class="sxs-lookup"><span data-stu-id="61a2d-120">Therefore, when the first logon trigger starts firing, the transaction count is 1.</span></span> <span data-ttu-id="61a2d-121">После завершения выполнения всех триггеров входа происходит фиксация транзакции.</span><span class="sxs-lookup"><span data-stu-id="61a2d-121">After all the logon triggers finish executing, the transaction commits.</span></span> <span data-ttu-id="61a2d-122">Как и для триггеров других типов, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] возвращает ошибку, если триггер входа завершает выполнение со значением счетчика транзакций, равным 0.</span><span class="sxs-lookup"><span data-stu-id="61a2d-122">As with other types of triggers, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] returns an error if a logon trigger finishes execution with a transaction count of 0.</span></span> <span data-ttu-id="61a2d-123">Инструкция ROLLBACK TRANSACTION сбрасывает счетчик транзакций в 0, даже если инструкция выдана внутри вложенной транзакции.</span><span class="sxs-lookup"><span data-stu-id="61a2d-123">The ROLLBACK TRANSACTION statement resets the transaction count to 0, even if the statement is issued inside a nested transaction.</span></span> <span data-ttu-id="61a2d-124">Инструкция COMMIT TRANSACTION может уменьшить значение счетчика транзакций до 0.</span><span class="sxs-lookup"><span data-stu-id="61a2d-124">COMMIT TRANSACTION might decrement the transaction count to 0.</span></span> <span data-ttu-id="61a2d-125">В связи с этим не рекомендуется использовать инструкции COMMIT TRANSACTION внутри триггеров входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-125">Therefore, we advise against issuing COMMIT TRANSACTION statements inside logon triggers.</span></span>  
  
 <span data-ttu-id="61a2d-126">Учитывайте следующее при использовании инструкции ROLLBACK TRANSACTION в триггерах входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-126">Consider the following when you are using a ROLLBACK TRANSACTION statement inside logon triggers:</span></span>  
  
-   <span data-ttu-id="61a2d-127">Происходит откат любых изменений данных, сделанных до точки отката ROLLBACK TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="61a2d-127">Any data modifications made up to the point of ROLLBACK TRANSACTION are rolled back.</span></span> <span data-ttu-id="61a2d-128">В эти изменения входят как изменения, сделанные текущим триггером, так и те изменения, которые были сделаны предыдущими триггерами, выполнявшимися в том же событии.</span><span class="sxs-lookup"><span data-stu-id="61a2d-128">These modifications include those made by the current trigger and those made by previous triggers that executed on the same event.</span></span> <span data-ttu-id="61a2d-129">Оставшиеся триггеры указанного события выполняться не будут.</span><span class="sxs-lookup"><span data-stu-id="61a2d-129">Any remaining triggers for the specific event are not executed.</span></span>  
  
-   <span data-ttu-id="61a2d-130">Текущий триггер продолжает выполнять все оставшиеся инструкции после инструкции ROLLBACK.</span><span class="sxs-lookup"><span data-stu-id="61a2d-130">The current trigger continues to execute any remaining statements that appear after the ROLLBACK statement.</span></span> <span data-ttu-id="61a2d-131">Если какая-нибудь из инструкций изменит данные, откат этих изменений выполнен не будет.</span><span class="sxs-lookup"><span data-stu-id="61a2d-131">If any of these statements modify data, the modifications are not rolled back.</span></span>  
  
 <span data-ttu-id="61a2d-132">Сеанс пользователя не будет установлен, если произойдет одно из следующих событий при выполнении триггера на событии LOGON.</span><span class="sxs-lookup"><span data-stu-id="61a2d-132">A user session is not established if any one of the following conditions occur during execution of a trigger on a LOGON event:</span></span>  
  
-   <span data-ttu-id="61a2d-133">Произойдет либо откат, либо сбой исходной неявной транзакции.</span><span class="sxs-lookup"><span data-stu-id="61a2d-133">The original implicit transaction is rolled back or fails.</span></span>  
  
-   <span data-ttu-id="61a2d-134">В тексте триггера появится ошибка с уровнем серьезности свыше 20.</span><span class="sxs-lookup"><span data-stu-id="61a2d-134">An error that has severity greater than 20 is raised inside the trigger body.</span></span>  
  
## <a name="disabling-a-logon-trigger"></a><span data-ttu-id="61a2d-135">Отключение триггера входа</span><span class="sxs-lookup"><span data-stu-id="61a2d-135">Disabling a Logon Trigger</span></span>  
 <span data-ttu-id="61a2d-136">Триггер входа может эффективно запрещать подключения к службам [!INCLUDE[ssDE](../../../includes/ssde-md.md)] для всех пользователей, в том числе членов предопределенной роли сервера `sysadmin`.</span><span class="sxs-lookup"><span data-stu-id="61a2d-136">A logon trigger can effectively prevent successful connections to the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] for all users, including members of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="61a2d-137">Если триггер входа запрещает соединения, члены предопределенной роли сервера `sysadmin` могут подключаться с помощью выделенного административного соединения или путем вызова [!INCLUDE[ssDE](../../../includes/ssde-md.md)] в режиме минимальной конфигурации (-f).</span><span class="sxs-lookup"><span data-stu-id="61a2d-137">When a logon trigger is preventing connections, members of the `sysadmin` fixed server role can connect by using the dedicated administrator connection, or by starting the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] in minimal configuration mode (-f).</span></span> <span data-ttu-id="61a2d-138">Дополнительные сведения см. в разделе [Параметры запуска службы Database Engine](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span><span class="sxs-lookup"><span data-stu-id="61a2d-138">For more information, see [Database Engine Service Startup Options](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="61a2d-139">Связанные задачи</span><span class="sxs-lookup"><span data-stu-id="61a2d-139">Related Tasks</span></span>  
  
|<span data-ttu-id="61a2d-140">Задача</span><span class="sxs-lookup"><span data-stu-id="61a2d-140">Task</span></span>|<span data-ttu-id="61a2d-141">Раздел</span><span class="sxs-lookup"><span data-stu-id="61a2d-141">Topic</span></span>|  
|----------|-----------|  
|<span data-ttu-id="61a2d-142">Описывает, как создать триггеры входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-142">Describes how to create logon triggers.</span></span> <span data-ttu-id="61a2d-143">Триггеры входа могут создаваться из любой базы данных, но регистрируются на уровне сервера и принадлежат базе данных **master** .</span><span class="sxs-lookup"><span data-stu-id="61a2d-143">Logon triggers can be created from any database, but are registered at the server level and reside in the **master** database.</span></span>|[<span data-ttu-id="61a2d-144">CREATE TRIGGER (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="61a2d-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/create-trigger-transact-sql)|  
|<span data-ttu-id="61a2d-145">Описывает, как изменить триггеры входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-145">Describes how to modify logon triggers.</span></span>|[<span data-ttu-id="61a2d-146">ALTER TRIGGER (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="61a2d-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-trigger-transact-sql)|  
|<span data-ttu-id="61a2d-147">Описывает, как удалить триггеры входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-147">Describes how to delete logon triggers.</span></span>|[<span data-ttu-id="61a2d-148">DROP TRIGGER (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="61a2d-148">DROP TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/drop-trigger-transact-sql)|  
|<span data-ttu-id="61a2d-149">Описывает, как возвратить сведения о триггерах входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-149">Describes how to return information about logon triggers.</span></span>|[<span data-ttu-id="61a2d-150">sys.server_triggers (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="61a2d-150">sys.server_triggers &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-triggers-transact-sql)<br /><br /> [<span data-ttu-id="61a2d-151">sys.server_trigger_events (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="61a2d-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-trigger-events-transact-sql)|  
|<span data-ttu-id="61a2d-152">Описывает, как перехватить данные события триггером входа.</span><span class="sxs-lookup"><span data-stu-id="61a2d-152">Describes how to capture logon trigger event data.</span></span>||  
  
## <a name="see-also"></a><span data-ttu-id="61a2d-153">См. также:</span><span class="sxs-lookup"><span data-stu-id="61a2d-153">See Also</span></span>  
 [<span data-ttu-id="61a2d-154">Триггеры DDL</span><span class="sxs-lookup"><span data-stu-id="61a2d-154">DDL Triggers</span></span>](../triggers/ddl-triggers.md)  
  
  
