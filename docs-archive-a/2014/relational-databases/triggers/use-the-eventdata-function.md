---
title: Использование функции EVENTDATA | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- EVENTDATA function
- DDL triggers, EVENTDATA function
ms.assetid: 675b8320-9c73-4526-bd2f-91ba42c1b604
author: rothja
ms.author: jroth
ms.openlocfilehash: 57fb59a3954fb00ab943944c58cccd352c7270d2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87668134"
---
# <a name="use-the-eventdata-function"></a><span data-ttu-id="eab14-102">Использование функции EVENTDATA</span><span class="sxs-lookup"><span data-stu-id="eab14-102">Use the EVENTDATA Function</span></span>
  <span data-ttu-id="eab14-103">Функция EVENTDATA позволяет получить сведения о событии, которое привело к срабатыванию триггера DDL.</span><span class="sxs-lookup"><span data-stu-id="eab14-103">Information about an event that fires a DDL trigger is captured by using the EVENTDATA function.</span></span> <span data-ttu-id="eab14-104">Эта функция возвращает значение типа `xml`.</span><span class="sxs-lookup"><span data-stu-id="eab14-104">This function returns an `xml` value.</span></span> <span data-ttu-id="eab14-105">XML-схема содержит следующие сведения:</span><span class="sxs-lookup"><span data-stu-id="eab14-105">The XML schema includes information about the following:</span></span>  
  
-   <span data-ttu-id="eab14-106">время формирования события;</span><span class="sxs-lookup"><span data-stu-id="eab14-106">The time of the event.</span></span>  
  
-   <span data-ttu-id="eab14-107">идентификатор системного процесса (SPID), соответствующий соединению, во время которого был выполнен триггер;</span><span class="sxs-lookup"><span data-stu-id="eab14-107">The System Process ID (SPID) of the connection when the trigger executed.</span></span>  
  
-   <span data-ttu-id="eab14-108">тип события, которое привело к срабатыванию триггера.</span><span class="sxs-lookup"><span data-stu-id="eab14-108">The type of event that fired the trigger.</span></span>  
  
 <span data-ttu-id="eab14-109">В зависимости от типа события эта схема включает также дополнительные сведения о базе данных, в которой было сформировано событие, об объекте, в контексте которого оно было сформировано, и об инструкции [!INCLUDE[tsql](../../includes/tsql-md.md)] , вызвавшей это событие.</span><span class="sxs-lookup"><span data-stu-id="eab14-109">Depending on the event type, the schema then includes additional information such as the database in which the event occurred, the object against which the event occurred, and the [!INCLUDE[tsql](../../includes/tsql-md.md)] statement of the event.</span></span> <span data-ttu-id="eab14-110">Дополнительные сведения см. в разделе [DDL Triggers](ddl-triggers.md).</span><span class="sxs-lookup"><span data-stu-id="eab14-110">For more information, see [DDL Triggers](ddl-triggers.md).</span></span>  
  
 <span data-ttu-id="eab14-111">Предположим, что в базе данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] создан следующий триггер DDL:</span><span class="sxs-lookup"><span data-stu-id="eab14-111">For example, the following DDL trigger is created in the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database:</span></span>  
  
```  
CREATE TRIGGER safety   
ON DATABASE   
FOR CREATE_TABLE   
AS   
    PRINT 'CREATE TABLE Issued.'  
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','nvarchar(max)')  
   RAISERROR ('New tables cannot be created in this database.', 16, 1)   
   ROLLBACK  
;  
```  
  
 <span data-ttu-id="eab14-112">После этого выполняется следующая инструкция `CREATE TABLE` :</span><span class="sxs-lookup"><span data-stu-id="eab14-112">The following `CREATE TABLE` statement is then run:</span></span>  
  
 `CREATE TABLE NewTable (Column1 int);`  
  
 <span data-ttu-id="eab14-113">Инструкция `EVENTDATA()` в триггере DDL захватывает текст инструкции `CREATE TABLE` , что является недопустимым.</span><span class="sxs-lookup"><span data-stu-id="eab14-113">The `EVENTDATA()` statement in the DDL trigger captures the text of the `CREATE TABLE` statement that is not allowed.</span></span> <span data-ttu-id="eab14-114">Это достигается с помощью инструкции XQuery для `xml` данных, формируемых функцией EVENTDATA, и извлечения \<CommandText> элемента.</span><span class="sxs-lookup"><span data-stu-id="eab14-114">This is achieved by using an XQuery statement against the `xml` data that is generated by EVENTDATA and retrieving the \<CommandText> element.</span></span> <span data-ttu-id="eab14-115">Дополнительные сведения см. в статье [Справочник по языку XQuery (SQL Server)](/sql/xquery/xquery-language-reference-sql-server).</span><span class="sxs-lookup"><span data-stu-id="eab14-115">For more information, see [XQuery Language Reference &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span></span>  
  
> [!CAUTION]  
>  <span data-ttu-id="eab14-116">Функция EVENTDATA захватывает данные событий CREATE_SCHEMA, а также элемента <schema_element> соответствующего определения CREATE SCHEMA, если таковые существуют.</span><span class="sxs-lookup"><span data-stu-id="eab14-116">EVENTDATA captures the data of CREATE_SCHEMA events as well as the <schema_element> of the corresponding CREATE SCHEMA definition, if any exists.</span></span> <span data-ttu-id="eab14-117">Кроме этого, функция EVENTDATA распознает определение <schema_element> как отдельное событие.</span><span class="sxs-lookup"><span data-stu-id="eab14-117">Additionally, EVENTDATA recognizes the <schema_element> definition as a separate event.</span></span> <span data-ttu-id="eab14-118">Таким образом, триггер DDL, созданный для события CREATE_SCHEMA и для события, представленного данными <schema_element> определения CREATE SCHEMA, может дважды вернуть одни и те же сведения о событии (например, данные `TSQLCommand`).</span><span class="sxs-lookup"><span data-stu-id="eab14-118">Therefore, a DDL trigger created on both a CREATE_SCHEMA event, and an event represented by the <schema_element> of the CREATE SCHEMA definition, may return the same event data twice, such as the `TSQLCommand` data.</span></span> <span data-ttu-id="eab14-119">Допустим, для событий CREATE_SCHEMA и CREATE_TABLE создан триггер DDL и выполняется следующий пакет:</span><span class="sxs-lookup"><span data-stu-id="eab14-119">For example, consider a DDL trigger that is created on both the CREATE_SCHEMA and CREATE_TABLE events and the following batch is run:</span></span>  
>   
>  `CREATE SCHEMA s`  
>   
>  `CREATE TABLE t1 (col1 int)`  
>   
>  <span data-ttu-id="eab14-120">Если приложение использует данные `TSQLCommand` о событии CREATE_TABLE, следует учитывать, что эти данные могут появиться дважды: при возникновении события CREATE_SCHEMA и при возникновении события CREATE_TABLE.</span><span class="sxs-lookup"><span data-stu-id="eab14-120">If the application retrieves the `TSQLCommand` data of the CREATE_TABLE event, be aware that this data may appear two times: once when the CREATE_SCHEMA event occurs, and again when the CREATE_TABLE event occurs.</span></span> <span data-ttu-id="eab14-121">Следует избегать создания триггеров DDL одновременно для событий CREATE_SCHEMA и текста <schema_element> для любых соответствующих определений CREATE SCHEMA, или же в приложение необходимо добавить элемент логики, чтобы одно и тоже событие не обрабатывалось дважды.</span><span class="sxs-lookup"><span data-stu-id="eab14-121">Avoid creating DDL triggers on both the CREATE_SCHEMA events and the <schema_element> texts of any corresponding CREATE SCHEMA definitions, or build logic into your application so that the same event is not processed twice.</span></span>  
  
## <a name="alter-table-and-alter-database-events"></a><span data-ttu-id="eab14-122">События ALTER TABLE и ALTER DATABASE</span><span class="sxs-lookup"><span data-stu-id="eab14-122">ALTER TABLE and ALTER DATABASE Events</span></span>  
 <span data-ttu-id="eab14-123">Данные о событиях  для событий ALTER_TABLE и ALTER_DATABASE также включают имена и типы других объектов, затронутых DDL-инструкцией и действием, выполняемым над этими объектами.</span><span class="sxs-lookup"><span data-stu-id="eab14-123">The event data for the ALTER_TABLE and ALTER_DATABASE events also includes the names and types of other objects affected by the DDL statement and the action performed on these objects.</span></span> <span data-ttu-id="eab14-124">Данные события ALTER_TABLE включают имена столбцов, ограничений или триггеров, затронутых инструкцией ALTER TABLE и действием (создание, изменение, удаление, включение или отключение), выполняемым над затронутыми объектами.</span><span class="sxs-lookup"><span data-stu-id="eab14-124">The ALTER_TABLE event data includes the names of the columns, constraints, or triggers affected by the ALTER TABLE statement and the action (create, alter, drop, enable, or disable) performed on the affected objects.</span></span> <span data-ttu-id="eab14-125">Данные события ALTER_DATABASE включают имена любых файлов или файловых групп, затронутых инструкцией ALTER DATABASE и действием (создание, изменение, удаление), выполняемым над затронутыми объектами.</span><span class="sxs-lookup"><span data-stu-id="eab14-125">The ALTER_DATABASE event data includes the names of any files or filegroups affected by the ALTER DATABASE statement and the action (create, alter, or drop) performed on the affected objects.</span></span>  
  
 <span data-ttu-id="eab14-126">Предположим, что в образце базы данных AdventureWorks создан следующий триггер DDL:</span><span class="sxs-lookup"><span data-stu-id="eab14-126">For example, create the following DDL trigger in the AdventureWorks sample database:</span></span>  
  
```  
CREATE TRIGGER ColumnChanges  
ON DATABASE   
FOR ALTER_TABLE  
AS  
-- Detect whether a column was created/altered/dropped.  
SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]', 'nvarchar(max)')  
RAISERROR ('Table schema cannot be modified in this database.', 16, 1);  
ROLLBACK;  
```  
  
 <span data-ttu-id="eab14-127">Затем выполняется следующая инструкция ALTER TABLE, нарушающая ограничение:</span><span class="sxs-lookup"><span data-stu-id="eab14-127">Then execute the following ALTER TABLE statement that violates a constraint:</span></span>  
  
```  
ALTER TABLE Person.Address ALTER COLUMN ModifiedDate date;   
```  
  
 <span data-ttu-id="eab14-128">Инструкция EVENTDATA() в триггере DDL захватывает текст инструкции `ALTER TABLE` , что является недопустимым.</span><span class="sxs-lookup"><span data-stu-id="eab14-128">The EVENTDATA() statement in the DDL trigger captures the text of the `ALTER TABLE` statement that is not permitted.</span></span>  
  
## <a name="example"></a><span data-ttu-id="eab14-129">Пример</span><span class="sxs-lookup"><span data-stu-id="eab14-129">Example</span></span>  
 <span data-ttu-id="eab14-130">Функция EVENTDATA может применяться для создания журнала событий.</span><span class="sxs-lookup"><span data-stu-id="eab14-130">You can use the EVENTDATA function to create a log of events.</span></span> <span data-ttu-id="eab14-131">В следующем примере создается таблица для хранения информации о событиях.</span><span class="sxs-lookup"><span data-stu-id="eab14-131">In the following example, a table is created to store event information.</span></span> <span data-ttu-id="eab14-132">После этого для текущей базы данных создается триггер DDL, который при любом событии DDL уровня базы данных заполняет эту таблицу следующими данными:</span><span class="sxs-lookup"><span data-stu-id="eab14-132">A DDL trigger is then created on the current database that populates the table with the following information whenever any database-level DDL event occurs:</span></span>  
  
-   <span data-ttu-id="eab14-133">время формирования события (функция GETDATE);</span><span class="sxs-lookup"><span data-stu-id="eab14-133">The time of the event (using the GETDATE function).</span></span>  
  
-   <span data-ttu-id="eab14-134">пользователь базы данных, инициировавший сеанс, во время которого произошло событие (функция CURRENT_USER);</span><span class="sxs-lookup"><span data-stu-id="eab14-134">The database user against whose session the event occurred (using the CURRENT_USER function).</span></span>  
  
-   <span data-ttu-id="eab14-135">тип события;</span><span class="sxs-lookup"><span data-stu-id="eab14-135">The type of the event.</span></span>  
  
-   <span data-ttu-id="eab14-136">инструкция [!INCLUDE[tsql](../../includes/tsql-md.md)] , вызвавшая данное событие.</span><span class="sxs-lookup"><span data-stu-id="eab14-136">The [!INCLUDE[tsql](../../includes/tsql-md.md)] statement that comprised the event.</span></span>  
  
 <span data-ttu-id="eab14-137">Сведения о двух последних элементах регистрируются путем выполнения запроса XQuery для `xml`-данных, сформированных функцией EVENTDATA.</span><span class="sxs-lookup"><span data-stu-id="eab14-137">Again, the last two items are captured by using XQuery against the `xml` data that is generated by EVENTDATA.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE TABLE ddl_log (PostTime datetime, DB_User nvarchar(100), Event nvarchar(100), TSQL nvarchar(2000));  
GO  
CREATE TRIGGER log   
ON DATABASE   
FOR DDL_DATABASE_LEVEL_EVENTS   
AS  
DECLARE @data XML  
SET @data = EVENTDATA()  
INSERT ddl_log   
   (PostTime, DB_User, Event, TSQL)   
   VALUES   
   (GETDATE(),   
   CONVERT(nvarchar(100), CURRENT_USER),   
   @data.value('(/EVENT_INSTANCE/EventType)[1]', 'nvarchar(100)'),   
   @data.value('(/EVENT_INSTANCE/TSQLCommand)[1]', 'nvarchar(2000)') ) ;  
GO  
--Test the trigger  
CREATE TABLE TestTable (a int)  
DROP TABLE TestTable ;  
GO  
SELECT * FROM ddl_log ;  
GO  
```  
  
> [!NOTE]  
>  <span data-ttu-id="eab14-138">Для получения сведения о событиях в запросе XQuery вместо метода `value()` рекомендуется использовать метод `query()`.</span><span class="sxs-lookup"><span data-stu-id="eab14-138">To return event data, we recommend that you use the XQuery `value()` method instead of the `query()` method.</span></span> <span data-ttu-id="eab14-139">Метод `query()` возвращает XML-данные и символы возврата каретки и переноса строки, заэкранированные амперсандом, тогда как в выводе метода `value()` эти символы не экранируются.</span><span class="sxs-lookup"><span data-stu-id="eab14-139">The `query()` method returns XML and ampersand-escaped carriage return and line-feed (CRLF) instances in the output, while the `value()` method renders CRLF instances invisible in the output.</span></span>  
  
 <span data-ttu-id="eab14-140">Аналогичный пример триггера DDL предоставляется вместе с образцом базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="eab14-140">A similar DDL trigger example is provided with the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database.</span></span> <span data-ttu-id="eab14-141">Для его получения перейдите в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]в папку с триггерами базы данных,</span><span class="sxs-lookup"><span data-stu-id="eab14-141">To obtain the example, locate the Database Triggers folder by using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="eab14-142">Эта папка находится в папке **Programmability** базы данных [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="eab14-142">This folder is located under the **Programmability** folder of the [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] database.</span></span> <span data-ttu-id="eab14-143">Щелкните правой кнопкой мыши **ddlDatabaseTriggerLog** и выберите команду **Создать скрипт для триггера базы данных**.</span><span class="sxs-lookup"><span data-stu-id="eab14-143">Right-click **ddlDatabaseTriggerLog** and select **Script Database Trigger as**.</span></span> <span data-ttu-id="eab14-144">По умолчанию триггер DDL **ddlDatabaseTriggerLog** отключен.</span><span class="sxs-lookup"><span data-stu-id="eab14-144">By default, DDL trigger **ddlDatabaseTriggerLog** is disabled.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="eab14-145">См. также:</span><span class="sxs-lookup"><span data-stu-id="eab14-145">See Also</span></span>  
 <span data-ttu-id="eab14-146">[DDL-события](../triggers/ddl-events.md) </span><span class="sxs-lookup"><span data-stu-id="eab14-146">[DDL Events](../triggers/ddl-events.md) </span></span>  
 [<span data-ttu-id="eab14-147">Группы DDL-событий</span><span class="sxs-lookup"><span data-stu-id="eab14-147">DDL Event Groups</span></span>](../triggers/ddl-event-groups.md)  
  
  
