---
title: Использование таблиц inserted и deleted | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- inserted tables
- UPDATE statement [SQL Server], DML triggers
- DELETE statement [SQL Server], DML triggers
- INSTEAD OF triggers
- deleted tables
- INSERT statement [SQL Server], DML triggers
- DML triggers, deleted or inserted tables
ms.assetid: ed84567f-7b91-4b44-b5b2-c400bda4590d
author: rothja
ms.author: jroth
ms.openlocfilehash: facc534177113bd93e56e50fca3ae14c3e6b2cfc
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87668131"
---
# <a name="use-the-inserted-and-deleted-tables"></a><span data-ttu-id="39bec-102">Использование таблиц inserted и deleted</span><span class="sxs-lookup"><span data-stu-id="39bec-102">Use the inserted and deleted Tables</span></span>
  <span data-ttu-id="39bec-103">Инструкции триггеров DML используют две особые таблицы: deleted и inserted.</span><span class="sxs-lookup"><span data-stu-id="39bec-103">DML trigger statements use two special tables: the deleted table and the inserted tables.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="39bec-104">автоматически создает эти таблицы и управляет ими.</span><span class="sxs-lookup"><span data-stu-id="39bec-104">automatically creates and manages these tables.</span></span> <span data-ttu-id="39bec-105">Эти временные таблицы, находящиеся в оперативной памяти, используются для проверки результатов изменений данных и для установки условий срабатывания триггеров DML.</span><span class="sxs-lookup"><span data-stu-id="39bec-105">You can use these temporary, memory-resident tables to test the effects of certain data modifications and to set conditions for DML trigger actions.</span></span> <span data-ttu-id="39bec-106">Нельзя в этих таблицах изменять данные напрямую или выполнять над ними операции языка описания данных DDL, например инструкцию CREATE INDEX.</span><span class="sxs-lookup"><span data-stu-id="39bec-106">You cannot directly modify the data in the tables or perform data definition language (DDL) operations on the tables, such as CREATE INDEX.</span></span>  
  
 <span data-ttu-id="39bec-107">В триггерах DML таблицы inserted и deleted в основном используются для выполнения следующих операций.</span><span class="sxs-lookup"><span data-stu-id="39bec-107">In DML triggers, the inserted and deleted tables are primarily used to perform the following:</span></span>  
  
-   <span data-ttu-id="39bec-108">Расширение ссылочной целостности между таблицами.</span><span class="sxs-lookup"><span data-stu-id="39bec-108">Extend referential integrity between tables.</span></span>  
  
-   <span data-ttu-id="39bec-109">Вставка или обновление данных в базовых таблицах соответствующего представления.</span><span class="sxs-lookup"><span data-stu-id="39bec-109">Insert or update data in base tables underlying a view.</span></span>  
  
-   <span data-ttu-id="39bec-110">Проверка на ошибки и принятие соответствующих мер в связи с появлением ошибок.</span><span class="sxs-lookup"><span data-stu-id="39bec-110">Test for errors and take action based on the error.</span></span>  
  
-   <span data-ttu-id="39bec-111">Поиск различий между состояниями таблицы до и после изменения данных и принятие соответствующих мер в зависимости от наличия или отсутствия различий.</span><span class="sxs-lookup"><span data-stu-id="39bec-111">Find the difference between the state of a table before and after a data modification and take actions based on that difference.</span></span>  
  
 <span data-ttu-id="39bec-112">В таблице deleted находятся копии строк, с которыми работали инструкции DELETE или UPDATE.</span><span class="sxs-lookup"><span data-stu-id="39bec-112">The deleted table stores copies of the affected rows during DELETE and UPDATE statements.</span></span> <span data-ttu-id="39bec-113">При выполнении инструкции DELETE или UPDATE происходит удаление строк из таблицы триггера и их перенос в таблицу deleted.</span><span class="sxs-lookup"><span data-stu-id="39bec-113">During the execution of a DELETE or UPDATE statement, rows are deleted from the trigger table and transferred to the deleted table.</span></span> <span data-ttu-id="39bec-114">У таблицы deleted обычно нет общих строк с таблицей триггера.</span><span class="sxs-lookup"><span data-stu-id="39bec-114">The deleted table and the trigger table ordinarily have no rows in common.</span></span>  
  
 <span data-ttu-id="39bec-115">В таблице inserted находятся копии строк, с которыми работали инструкции INSERT или UPDATE.</span><span class="sxs-lookup"><span data-stu-id="39bec-115">The inserted table stores copies of the affected rows during INSERT and UPDATE statements.</span></span> <span data-ttu-id="39bec-116">При выполнении транзакции вставки или обновления происходит одновременное добавление строк в таблицу триггера и в таблицу inserted.</span><span class="sxs-lookup"><span data-stu-id="39bec-116">During an insert or update transaction, new rows are added to both the inserted table and the trigger table.</span></span> <span data-ttu-id="39bec-117">Строки таблицы inserted являются копиями новых строк таблицы триггера.</span><span class="sxs-lookup"><span data-stu-id="39bec-117">The rows in the inserted table are copies of the new rows in the trigger table.</span></span>  
  
 <span data-ttu-id="39bec-118">Транзакция обновления аналогична выполнению операции удаления с последующим выполнением операции вставки; сначала старые строки копируются в таблицу deleted, а затем новые строки копируются в таблицу триггера и в таблицу inserted.</span><span class="sxs-lookup"><span data-stu-id="39bec-118">An update transaction is similar to a delete operation followed by an insert operation; the old rows are copied to the deleted table first, and then the new rows are copied to the trigger table and to the inserted table.</span></span>  
  
 <span data-ttu-id="39bec-119">При задании условий триггера используйте таблицы inserted и deleted соответственно действию, заставившему триггер сработать.</span><span class="sxs-lookup"><span data-stu-id="39bec-119">When you set trigger conditions, use the inserted and deleted tables appropriately for the action that fired the trigger.</span></span> <span data-ttu-id="39bec-120">Хотя ссылка на таблицу deleted при проверке инструкции INSERT или ссылка на таблицу inserted при проверке инструкции DELETE не приводит к появлению ошибок, но данные тестовые таблицы триггера все равно не содержат в таких случаях никаких строк.</span><span class="sxs-lookup"><span data-stu-id="39bec-120">Although referencing the deleted table when testing an INSERT or the inserted table when testing a DELETE does not cause any errors, these trigger test tables do not contain any rows in these cases.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="39bec-121">Если действия триггера зависят от числа строк, данные в которых были изменены, воспользуйтесь проверками (например, проверкой параметра @@ROWCOUNT) при изменении данных в нескольких строках (инструкции INSERT, DELETE или UPDATE с инструкцией SELECT), а затем предпринимайте соответствующие действия.</span><span class="sxs-lookup"><span data-stu-id="39bec-121">If trigger actions depend on the number of rows a data modification effects, use tests (such as an examination of @@ROWCOUNT) for multirow data modifications (an INSERT, DELETE, or UPDATE based on a SELECT statement), and take appropriate actions.</span></span>  
  
 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] <span data-ttu-id="39bec-122">не позволяет ссылаться на столбцы типов `text`, `ntext` и `image` в таблицах inserted и deleted триггеров AFTER.</span><span class="sxs-lookup"><span data-stu-id="39bec-122">does not allow for `text`, `ntext`, or `image` column references in the inserted and deleted tables for AFTER triggers.</span></span> <span data-ttu-id="39bec-123">Однако эти типы данных включены в целях обратной совместимости.</span><span class="sxs-lookup"><span data-stu-id="39bec-123">However, these data types are included for backward compatibility purposes only.</span></span> <span data-ttu-id="39bec-124">Предпочтительным способом хранения для данных большого объема является использование типов данных `varchar(max)`, `nvarchar(max)` и `varbinary(max)`.</span><span class="sxs-lookup"><span data-stu-id="39bec-124">The preferred storage for large data is to use the `varchar(max)`, `nvarchar(max)`, and `varbinary(max)` data types.</span></span> <span data-ttu-id="39bec-125">Как триггеры AFTER, так и триггеры INSTEAD OF поддерживают данные типов `varchar(max)`, `nvarchar(max)` и `varbinary(max)` в таблицах inserted и deleted.</span><span class="sxs-lookup"><span data-stu-id="39bec-125">Both AFTER and INSTEAD OF triggers support `varchar(max)`, `nvarchar(max)`, and `varbinary(max)` data in the inserted and deleted tables.</span></span> <span data-ttu-id="39bec-126">Дополнительные сведения см. в разделе [CREATE TRIGGER (Transact-SQL)](/sql/t-sql/statements/create-trigger-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="39bec-126">For more information, see [CREATE TRIGGER &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-trigger-transact-sql).</span></span>  
  
 <span data-ttu-id="39bec-127">**Примеры использования таблицы inserted в триггере для выполнения бизнес-правил**</span><span class="sxs-lookup"><span data-stu-id="39bec-127">**An Example of Using the inserted Table in a Trigger to Enforce Business Rules**</span></span>  
  
 <span data-ttu-id="39bec-128">Поскольку ограничение CHECK может содержать ссылки только на столбцы, для которых определены ограничения на уровне столбцов или таблицы, любые межтабличные ограничения (в данном случае бизнес-правила) должны быть заданы в виде триггеров.</span><span class="sxs-lookup"><span data-stu-id="39bec-128">Because CHECK constraints can reference only the columns on which the column-level or table-level constraint is defined, any cross-table constraints (in this case, business rules) must be defined as triggers.</span></span>  
  
 <span data-ttu-id="39bec-129">В следующем примере создается триггер DML.</span><span class="sxs-lookup"><span data-stu-id="39bec-129">The following example creates a DML trigger.</span></span> <span data-ttu-id="39bec-130">Этот триггер проверяет уровень кредитоспособности поставщика при попытке добавить новый заказ на покупку в таблицу `PurchaseOrderHeader` .</span><span class="sxs-lookup"><span data-stu-id="39bec-130">This trigger checks to make sure the credit rating for the vendor is good when an attempt is made to insert a new purchase order into the `PurchaseOrderHeader` table.</span></span> <span data-ttu-id="39bec-131">Чтобы получить оценку кредитоспособности поставщика, связанного с только что добавленным заказом на покупку, таблица inserted должна ссылаться на таблицу `Vendor` и быть связана с ней.</span><span class="sxs-lookup"><span data-stu-id="39bec-131">To obtain the credit rating of the vendor corresponding to the purchase order that was just inserted, the `Vendor` table must be referenced and joined with the inserted table.</span></span> <span data-ttu-id="39bec-132">В случае слишком низкой кредитоспособности выводится соответствующее сообщение и вставка не выполняется.</span><span class="sxs-lookup"><span data-stu-id="39bec-132">If the credit rating is too low, a message is displayed and the insertion does not execute.</span></span> <span data-ttu-id="39bec-133">Обратите внимание, что в этом примере не допускается изменение многострочных данных.</span><span class="sxs-lookup"><span data-stu-id="39bec-133">Note that this example does not allow for multirow data modifications.</span></span> <span data-ttu-id="39bec-134">Дополнительные сведения см. в статье [Создание триггеров DML для обработки нескольких строк данных](../triggers/create-dml-triggers-to-handle-multiple-rows-of-data.md).</span><span class="sxs-lookup"><span data-stu-id="39bec-134">For more information, see [Create DML Triggers to Handle Multiple Rows of Data](../triggers/create-dml-triggers-to-handle-multiple-rows-of-data.md).</span></span>  
  
 [!code-sql[TriggerDDL#CreateTrigger3](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#createtrigger3)]  
  
## <a name="using-the-inserted-and-deleted-tables-in-instead-of-triggers"></a><span data-ttu-id="39bec-135">Использование таблиц inserted и deleted в триггерах INSTEAD OF</span><span class="sxs-lookup"><span data-stu-id="39bec-135">Using the inserted and deleted Tables in INSTEAD OF Triggers</span></span>  
 <span data-ttu-id="39bec-136">Таблицы inserted и deleted в триггерах INSTEAD OF подчиняются тем же правилам, что и таблицы inserted и deleted в триггерах AFTER.</span><span class="sxs-lookup"><span data-stu-id="39bec-136">The inserted and deleted tables passed to INSTEAD OF triggers defined on tables follow the same rules as the inserted and deleted tables passed to AFTER triggers.</span></span> <span data-ttu-id="39bec-137">Формат таблиц inserted и deleted совпадает с форматом таблицы, для которой задан триггер INSTEAD OF.</span><span class="sxs-lookup"><span data-stu-id="39bec-137">The format of the inserted and deleted tables is the same as the format of the table on which the INSTEAD OF trigger is defined.</span></span> <span data-ttu-id="39bec-138">Каждый столбец таблиц inserted и deleted прямо сопоставляется с определенным столбцом базовой таблицы.</span><span class="sxs-lookup"><span data-stu-id="39bec-138">Each column in the inserted and deleted tables maps directly to a column in the base table.</span></span>  
  
 <span data-ttu-id="39bec-139">Следующие правила относятся к инструкциям INSERT или UPDATE, ссылающимся на таблицу с триггером INSTEAD OF, которые должны предоставлять такие значения для столбцов, как если бы в таблице не было триггера INSTEAD OF.</span><span class="sxs-lookup"><span data-stu-id="39bec-139">The following rules regarding when an INSERT or UPDATE statement referencing a table with an INSTEAD OF trigger must supply values for columns are the same as if the table did not have an INSTEAD OF trigger:</span></span>  
  
-   <span data-ttu-id="39bec-140">Не могут быть заданы значения для вычисляемых столбцов и для столбцов с типом данных `timestamp`.</span><span class="sxs-lookup"><span data-stu-id="39bec-140">Values cannot be specified for computed columns or columns with a `timestamp` data type.</span></span>  
  
-   <span data-ttu-id="39bec-141">Если параметр IDENTITY_INSERT для этой таблицы не равен ON, то значения для столбцов со свойством IDENTITY не могут быть заданы.</span><span class="sxs-lookup"><span data-stu-id="39bec-141">Values cannot be specified for columns with an IDENTITY property, unless IDENTITY_INSERT is ON for that table.</span></span> <span data-ttu-id="39bec-142">Когда значение параметра IDENTITY_INSERT равно ON, инструкции INSERT должны сами задавать это значение.</span><span class="sxs-lookup"><span data-stu-id="39bec-142">When IDENTITY_INSERT is ON, INSERT statements must supply a value.</span></span>  
  
-   <span data-ttu-id="39bec-143">Инструкции INSERT должны определять значения для всех столбцов со свойством NOT NULL, не имеющих ограничений DEFAULT.</span><span class="sxs-lookup"><span data-stu-id="39bec-143">INSERT statements must supply values for all NOT NULL columns that do not have DEFAULT constraints.</span></span>  
  
-   <span data-ttu-id="39bec-144">Для любого столбца, кроме вычисляемых столбцов, столбцов определителя и столбцов типа `timestamp`, определение значений является необязательным, если разрешены NULL значения или если какой-либо столбец со свойством NOT NULL обладает определением DEFAULT.</span><span class="sxs-lookup"><span data-stu-id="39bec-144">For any columns except computed, identity, or `timestamp` columns, values are optional for any column that allows nulls, or any NOT NULL column that has a DEFAULT definition.</span></span>  
  
 <span data-ttu-id="39bec-145">Если инструкция INSERT, UPDATE или DELETE ссылается на представление, для которого определен триггер INSTEAD OF, компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] вызывает триггер вместо того, чтобы предпринять какое-либо прямое действие по отношению к таблице.</span><span class="sxs-lookup"><span data-stu-id="39bec-145">When an INSERT, UPDATE, or DELETE statement references a view that has an INSTEAD OF trigger, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] calls the trigger instead of taking any direct action against any table.</span></span> <span data-ttu-id="39bec-146">Триггер использует сведения, представленные в таблицах inserted и deleted, для создания инструкций, необходимых для выполнения требуемых действий в базовых таблицах, даже в том случае, если формат данных в таблицах inserted и deleted, созданных для представления, отличается от формата данных базовой таблицы.</span><span class="sxs-lookup"><span data-stu-id="39bec-146">The trigger must use the information presented in the inserted and deleted tables to build any statements required to implement the requested action in the base tables, even when the format of the information in the inserted and deleted tables built for the view is different from the format of the data in the base tables.</span></span>  
  
 <span data-ttu-id="39bec-147">Формат таблиц inserted и deleted триггера INSTEAD OF, заданного для представления, совпадает со списком выборки инструкции SELECT, заданной для представления.</span><span class="sxs-lookup"><span data-stu-id="39bec-147">The format of the inserted and deleted tables passed to an INSTEAD OF trigger defined on a view matches the select list of the SELECT statement defined for the view.</span></span> <span data-ttu-id="39bec-148">Пример:</span><span class="sxs-lookup"><span data-stu-id="39bec-148">For example:</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE VIEW dbo.EmployeeNames (BusinessEntityID, LName, FName)  
AS  
SELECT e.BusinessEntityID, p.LastName, p.FirstName  
FROM HumanResources.Employee AS e   
JOIN Person.Person AS p  
ON e.BusinessEntityID = p.BusinessEntityID;  
```  
  
 <span data-ttu-id="39bec-149">Результирующий набор для этого представления содержит три столбца: один `int` и два `nvarchar`.</span><span class="sxs-lookup"><span data-stu-id="39bec-149">The result set for this view has three columns: an `int` column and two `nvarchar` columns.</span></span> <span data-ttu-id="39bec-150">Таблицы inserted и deleted триггера INSTEAD OF, заданного для представления, также содержат столбец типа `int` с именем `BusinessEntityID`, столбец типа `nvarchar` с именем `LName` и столбец типа `nvarchar` с именем `FName`.</span><span class="sxs-lookup"><span data-stu-id="39bec-150">The inserted and deleted tables passed to an INSTEAD OF trigger defined on the view also have an `int` column named `BusinessEntityID`, an `nvarchar` column named `LName`, and an `nvarchar` column named `FName`.</span></span>  
  
 <span data-ttu-id="39bec-151">Список выборки представления также может содержать выражения, которые не сопоставлены напрямую с каким-либо одним столбцом базовой таблицы.</span><span class="sxs-lookup"><span data-stu-id="39bec-151">The select list of a view can also contain expressions that do not directly map to a single base-table column.</span></span> <span data-ttu-id="39bec-152">Некоторые выражения представления, такие как вызов функции или константы, могут не ссылаться на столбцы и просто пропускаться.</span><span class="sxs-lookup"><span data-stu-id="39bec-152">Some view expressions, such as a constant or function invocation, may not reference any columns and can be ignored.</span></span> <span data-ttu-id="39bec-153">Сложные выражения могут ссылаться на несколько столбцов, однако таблицы inserted и deleted содержат только по одному значению для каждой вставляемой строки.</span><span class="sxs-lookup"><span data-stu-id="39bec-153">Complex expressions can reference multiple columns, yet the inserted and deleted tables have only one value for each inserted row.</span></span> <span data-ttu-id="39bec-154">Такие же проблемы появляются и в простых выражениях представления, если они ссылаются на вычисляемый столбец со сложным выражением.</span><span class="sxs-lookup"><span data-stu-id="39bec-154">The same issues apply to simple expressions in a view if they reference a computed column that has a complex expression.</span></span> <span data-ttu-id="39bec-155">Триггер INSTEAD OF в представлении должен обрабатывать такие типы выражений.</span><span class="sxs-lookup"><span data-stu-id="39bec-155">An INSTEAD OF trigger on the view must handle these types of expressions.</span></span>  
  
  
