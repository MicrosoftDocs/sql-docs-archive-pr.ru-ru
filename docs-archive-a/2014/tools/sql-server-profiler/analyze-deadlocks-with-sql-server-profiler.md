---
title: Анализ взаимоблокировок с помощью SQL Server Profiler | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: profiler
ms.topic: conceptual
helpviewer_keywords:
- process nodes [SQL Server Profiler]
- Profiler [SQL Server Profiler], deadlocks
- deadlocks [SQL Server], identifying cause
- resource nodes [SQL Server Profiler]
- graphs [SQL Server Profiler]
- SQL Server Profiler, deadlocks
- events [SQL Server], deadlocks
- edges [SQL Server Profiler]
ms.assetid: 72d6718f-501b-4ea6-b344-c0e653f19561
author: stevestein
ms.author: sstein
ms.openlocfilehash: 3414cda74d75dbacf10ed98b6fc6d50da2feaa18
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87727614"
---
# <a name="analyze-deadlocks-with-sql-server-profiler"></a><span data-ttu-id="d61b7-102">Анализ взаимоблокировок в приложении SQL Server Profiler</span><span class="sxs-lookup"><span data-stu-id="d61b7-102">Analyze Deadlocks with SQL Server Profiler</span></span>
  <span data-ttu-id="d61b7-103">Приложение [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] используется для определения причины взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="d61b7-103">Use [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] to identify the cause of a deadlock.</span></span> <span data-ttu-id="d61b7-104">Взаимоблокировка возникает, когда имеется циклическая зависимость между несколькими потоками или процессами для некоторого набора ресурсов в сервере SQL Server.</span><span class="sxs-lookup"><span data-stu-id="d61b7-104">A deadlock occurs when there is a cyclic dependency between two or more threads, or processes, for some set of resources within SQL Server.</span></span> <span data-ttu-id="d61b7-105">При помощи приложения [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)]можно создавать трассировку, которая записывает, воспроизводит и отображает для анализа события взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="d61b7-105">Using [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)], you can create a trace that records, replays, and displays deadlock events for analysis.</span></span>  
  
 <span data-ttu-id="d61b7-106">Для трассировки событий взаимоблокировки добавьте в трассировку класс событий **Deadlock graph** .</span><span class="sxs-lookup"><span data-stu-id="d61b7-106">To trace deadlock events, add the **Deadlock graph** event class to a trace.</span></span> <span data-ttu-id="d61b7-107">Этот класс событий заполняет столбец данных **TextData** в трассировке с данными XML о процессе и объектах, которые участвуют во взаимоблокировке.</span><span class="sxs-lookup"><span data-stu-id="d61b7-107">This event class populates the **TextData** data column in the trace with XML data about the process and objects that are involved in the deadlock.</span></span> [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] <span data-ttu-id="d61b7-108">может извлечь XML-документ в XML-файл взаимоблокировки (с расширением XDL), который в дальнейшем становится доступным для просмотра в среде SQL Server Management Studio.</span><span class="sxs-lookup"><span data-stu-id="d61b7-108">can extract the XML document to a deadlock XML (.xdl) file which you can view later in SQL Server Management Studio.</span></span> <span data-ttu-id="d61b7-109">Приложение [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] можно настроить на извлечение событий **Deadlock graph** в единый файл, содержащий все события класса **Deadlock graph** , или в отдельные файлы.</span><span class="sxs-lookup"><span data-stu-id="d61b7-109">You can configure [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] to extract **Deadlock graph** events to a single file that contains all **Deadlock graph** events, or to separate files.</span></span> <span data-ttu-id="d61b7-110">Это извлечение можно выполнить одним из следующих способов.</span><span class="sxs-lookup"><span data-stu-id="d61b7-110">This extraction can be done in any of the following ways:</span></span>  
  
-   <span data-ttu-id="d61b7-111">При настройке трассировки на вкладке **Настройки извлечения событий** . Обратите внимание на то, что эта вкладка не отображается до тех пор, пока не будет выбрано событие **Deadlock graph** на вкладке **Выбор событий** .</span><span class="sxs-lookup"><span data-stu-id="d61b7-111">At trace configuration time, using the **Events Extraction Settings** tab. Note that this tab does not appear until you select the **Deadlock graph** event on the **Events Selection** tab.</span></span>  
  
-   <span data-ttu-id="d61b7-112">С помощью параметра **Извлечь события SQL Server** в меню **Файл** .</span><span class="sxs-lookup"><span data-stu-id="d61b7-112">Using the **Extract SQL Server Events** option on the **File** menu.</span></span>  
  
-   <span data-ttu-id="d61b7-113">Отдельные события можно также извлекать и сохранять, щелкнув правой кнопкой конкретное событие и выбрав **Извлечь данные события**.</span><span class="sxs-lookup"><span data-stu-id="d61b7-113">Individual events can also be extracted and saved by right-clicking a specific event and choosing **Extract Event Data**.</span></span>  
  
## <a name="deadlock-graphs"></a><span data-ttu-id="d61b7-114">Графы взаимоблокировок</span><span class="sxs-lookup"><span data-stu-id="d61b7-114">Deadlock Graphs</span></span>  
 [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] <span data-ttu-id="d61b7-115">и среда [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] для описания взаимоблокировки используют граф ожидания взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="d61b7-115">and [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] use a deadlock wait-for graph to describe a deadlock.</span></span> <span data-ttu-id="d61b7-116">Граф ожидания взаимоблокировки содержит узлы процессов, узлы ресурсов и ребра, представляющие связи между процессами и ресурсами.</span><span class="sxs-lookup"><span data-stu-id="d61b7-116">The deadlock wait-for graph contains process nodes, resource nodes, and edges representing the relationships between the processes and the resources.</span></span> <span data-ttu-id="d61b7-117">Компоненты графов ожидания взаимоблокировки определяются в следующей таблице:</span><span class="sxs-lookup"><span data-stu-id="d61b7-117">The components of wait-for graphs are defined in the following table:</span></span>  
  
 <span data-ttu-id="d61b7-118">Узел процесса</span><span class="sxs-lookup"><span data-stu-id="d61b7-118">Process node</span></span>  
 <span data-ttu-id="d61b7-119">Поток, выполняющий задачу, например INSERT, UPDATE или DELETE.</span><span class="sxs-lookup"><span data-stu-id="d61b7-119">A thread that performs a task; for example, INSERT, UPDATE, or DELETE.</span></span>  
  
 <span data-ttu-id="d61b7-120">Узел ресурса</span><span class="sxs-lookup"><span data-stu-id="d61b7-120">Resource node</span></span>  
 <span data-ttu-id="d61b7-121">Объект базы данных, например таблица, индекс или строка.</span><span class="sxs-lookup"><span data-stu-id="d61b7-121">A database object; for example, a table, index, or row.</span></span>  
  
 <span data-ttu-id="d61b7-122">Edge</span><span class="sxs-lookup"><span data-stu-id="d61b7-122">Edge</span></span>  
 <span data-ttu-id="d61b7-123">Связь между процессом и ресурсом.</span><span class="sxs-lookup"><span data-stu-id="d61b7-123">A relationship between a process and a resource.</span></span> <span data-ttu-id="d61b7-124">Связь `request` возникает, когда процесс ожидает ресурса.</span><span class="sxs-lookup"><span data-stu-id="d61b7-124">A `request` edge occurs when a process waits for a resource.</span></span> <span data-ttu-id="d61b7-125">Связь `owner` возникает, когда ресурс ожидает процесс.</span><span class="sxs-lookup"><span data-stu-id="d61b7-125">An `owner` edge occurs when a resource waits for a process.</span></span> <span data-ttu-id="d61b7-126">В описание ребра включен режим блокировки.</span><span class="sxs-lookup"><span data-stu-id="d61b7-126">The lock mode is included in the edge description.</span></span> <span data-ttu-id="d61b7-127">Например, **Режим: X**.</span><span class="sxs-lookup"><span data-stu-id="d61b7-127">For example, **Mode: X**.</span></span>  
  
## <a name="deadlock-process-node"></a><span data-ttu-id="d61b7-128">Взаимоблокировка узла процесса</span><span class="sxs-lookup"><span data-stu-id="d61b7-128">Deadlock Process Node</span></span>  
 <span data-ttu-id="d61b7-129">В графе ожидания узел ожидания содержит информацию о процессе.</span><span class="sxs-lookup"><span data-stu-id="d61b7-129">In a wait-for graph, the process node contains information about the process.</span></span> <span data-ttu-id="d61b7-130">В следующей таблице поясняются компоненты процесса.</span><span class="sxs-lookup"><span data-stu-id="d61b7-130">The following table explains the components of a process.</span></span>  
  
|<span data-ttu-id="d61b7-131">Компонент</span><span class="sxs-lookup"><span data-stu-id="d61b7-131">Component</span></span>|<span data-ttu-id="d61b7-132">Определение</span><span class="sxs-lookup"><span data-stu-id="d61b7-132">Definition</span></span>|  
|---------------|----------------|  
|<span data-ttu-id="d61b7-133">Идентификатор процесса сервера</span><span class="sxs-lookup"><span data-stu-id="d61b7-133">Server process Id</span></span>|<span data-ttu-id="d61b7-134">Идентификатор процесса сервера (SPID), назначенный сервером процессу, владеющему блокировкой.</span><span class="sxs-lookup"><span data-stu-id="d61b7-134">Server process identifier (SPID), a server assigned identifier for the process owning the lock.</span></span>|  
|<span data-ttu-id="d61b7-135">Идентификатор пакета сервера</span><span class="sxs-lookup"><span data-stu-id="d61b7-135">Server batch Id</span></span>|<span data-ttu-id="d61b7-136">Идентификатор пакета сервера (SBID).</span><span class="sxs-lookup"><span data-stu-id="d61b7-136">Server batch identifier (SBID).</span></span>|  
|<span data-ttu-id="d61b7-137">Идентификатор контекста выполнения</span><span class="sxs-lookup"><span data-stu-id="d61b7-137">Execution context Id</span></span>|<span data-ttu-id="d61b7-138">Идентификатор контекста выполнения (ECID).</span><span class="sxs-lookup"><span data-stu-id="d61b7-138">Execution context identifier (ECID).</span></span> <span data-ttu-id="d61b7-139">Идентификатор контекста выполнения данного потока, связанного с определенным идентификатором SPID.</span><span class="sxs-lookup"><span data-stu-id="d61b7-139">The execution context ID of a given thread associated with a specific SPID.</span></span><br /><br /> <span data-ttu-id="d61b7-140">ECID = {0,1,2,3, *...n*}, где 0 всегда представляет основной или родительский поток, а {1,2,3, *...n*} представляет подпроцессы.</span><span class="sxs-lookup"><span data-stu-id="d61b7-140">ECID = {0,1,2,3, *...n*}, where 0 always represents the main or parent thread, and {1,2,3, *...n*} represent the subthreads.</span></span>|  
|<span data-ttu-id="d61b7-141">Приоритет взаимоблокировки</span><span class="sxs-lookup"><span data-stu-id="d61b7-141">Deadlock priority</span></span>|<span data-ttu-id="d61b7-142">Приоритет взаимоблокировки для процесса.</span><span class="sxs-lookup"><span data-stu-id="d61b7-142">Deadlock priority for the process.</span></span> <span data-ttu-id="d61b7-143">Дополнительные сведения о возможных значениях см. в статье [SET DEADLOCK_PRIORITY (Transact-SQL)](/sql/t-sql/statements/set-deadlock-priority-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="d61b7-143">For more information about possible values, see [SET DEADLOCK_PRIORITY &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-deadlock-priority-transact-sql).</span></span>|  
|<span data-ttu-id="d61b7-144">Используемый журнал</span><span class="sxs-lookup"><span data-stu-id="d61b7-144">Log Used</span></span>|<span data-ttu-id="d61b7-145">Объем пространства журнала, используемого для процесса.</span><span class="sxs-lookup"><span data-stu-id="d61b7-145">Amount of log space used by the process.</span></span>|  
|<span data-ttu-id="d61b7-146">Идентификатор владельца</span><span class="sxs-lookup"><span data-stu-id="d61b7-146">Owner Id</span></span>|<span data-ttu-id="d61b7-147">Идентификатор транзакции для процессов, которые используют транзакции и в настоящее время ожидают окончания блокировки.</span><span class="sxs-lookup"><span data-stu-id="d61b7-147">Transaction ID for the processes which are using transactions and currently waiting on a lock.</span></span>|  
|<span data-ttu-id="d61b7-148">Дескриптор транзакции</span><span class="sxs-lookup"><span data-stu-id="d61b7-148">Transaction descriptor</span></span>|<span data-ttu-id="d61b7-149">Указатель на дескриптор транзакции, описывающий состояние транзакции.</span><span class="sxs-lookup"><span data-stu-id="d61b7-149">Pointer to the transaction descriptor that describes the state of the transaction.</span></span>|  
|<span data-ttu-id="d61b7-150">Входной буфер</span><span class="sxs-lookup"><span data-stu-id="d61b7-150">Input buffer</span></span>|<span data-ttu-id="d61b7-151">Входной буфер текущего процесса определяет тип события и выполняемую инструкцию.</span><span class="sxs-lookup"><span data-stu-id="d61b7-151">Input buffer of the current process, defines the type of event and the statement being executed.</span></span> <span data-ttu-id="d61b7-152">Ниже перечислены возможные значения.</span><span class="sxs-lookup"><span data-stu-id="d61b7-152">Possible values include:</span></span><br /><br /> <span data-ttu-id="d61b7-153">**Язык**</span><span class="sxs-lookup"><span data-stu-id="d61b7-153">**Language**</span></span><br /><br /> <span data-ttu-id="d61b7-154">**RPC**</span><span class="sxs-lookup"><span data-stu-id="d61b7-154">**RPC**</span></span><br /><br /> <span data-ttu-id="d61b7-155">**None**</span><span class="sxs-lookup"><span data-stu-id="d61b7-155">**None**</span></span>|  
|<span data-ttu-id="d61b7-156">.</span><span class="sxs-lookup"><span data-stu-id="d61b7-156">Statement</span></span>|<span data-ttu-id="d61b7-157">Тип инструкции.</span><span class="sxs-lookup"><span data-stu-id="d61b7-157">Type of statement.</span></span> <span data-ttu-id="d61b7-158">Возможны следующие значения:</span><span class="sxs-lookup"><span data-stu-id="d61b7-158">Possible values are:</span></span><br /><br /> <span data-ttu-id="d61b7-159">**NOP**</span><span class="sxs-lookup"><span data-stu-id="d61b7-159">**NOP**</span></span><br /><br /> <span data-ttu-id="d61b7-160">**SELECT**</span><span class="sxs-lookup"><span data-stu-id="d61b7-160">**SELECT**</span></span><br /><br /> <span data-ttu-id="d61b7-161">**UPDATE**</span><span class="sxs-lookup"><span data-stu-id="d61b7-161">**UPDATE**</span></span><br /><br /> <span data-ttu-id="d61b7-162">**INSERT**</span><span class="sxs-lookup"><span data-stu-id="d61b7-162">**INSERT**</span></span><br /><br /> <span data-ttu-id="d61b7-163">**DELETE**</span><span class="sxs-lookup"><span data-stu-id="d61b7-163">**DELETE**</span></span><br /><br /> <span data-ttu-id="d61b7-164">**Unknown**</span><span class="sxs-lookup"><span data-stu-id="d61b7-164">**Unknown**</span></span>|  
  
## <a name="deadlock-resource-node"></a><span data-ttu-id="d61b7-165">Взаимоблокировка узла ресурса</span><span class="sxs-lookup"><span data-stu-id="d61b7-165">Deadlock Resource Node</span></span>  
 <span data-ttu-id="d61b7-166">Во взаимоблокировке участвуют два процесса, каждый их которых ожидает освобождения ресурса, удерживаемого другим процессом.</span><span class="sxs-lookup"><span data-stu-id="d61b7-166">In a deadlock, two processes are each waiting for a resource held by the other process.</span></span> <span data-ttu-id="d61b7-167">В графе взаимоблокировки ресурсы отображаются как узлы ресурсов.</span><span class="sxs-lookup"><span data-stu-id="d61b7-167">In a deadlock graph, the resources are displayed as resource nodes.</span></span>  
  
  
