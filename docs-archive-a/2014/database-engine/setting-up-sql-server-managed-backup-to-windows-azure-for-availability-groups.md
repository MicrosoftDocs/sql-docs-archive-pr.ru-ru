---
title: Настройка управляемого резервного копирования SQL Server в Azure для групп доступности | Документация Майкрософт
description: В этом руководстве показано, как настроить управляемое резервное копирование SQL Server в Microsoft Azure для баз данных, участвующих в группах доступности Always On.
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 0c4553cd-d8e4-4691-963a-4e414cc0f1ba
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: ebae9f75ac25698582b7f3e4c78c2fb773bd803e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87654480"
---
# <a name="setting-up-sql-server-managed-backup-to-azure-for-availability-groups"></a><span data-ttu-id="348c1-103">Настройка управляемого резервного копирования SQL Server в Azure для групп доступности</span><span class="sxs-lookup"><span data-stu-id="348c1-103">Setting up SQL Server Managed Backup to Azure for Availability Groups</span></span>
  <span data-ttu-id="348c1-104">В этом разделе представлено руководство по настройке [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для баз данных, участвующих в группах доступности AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="348c1-104">This topic is a tutorial on configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Groups.</span></span>  
  
## <a name="availability-group-configurations"></a><span data-ttu-id="348c1-105">Конфигурации групп доступности</span><span class="sxs-lookup"><span data-stu-id="348c1-105">Availability Group Configurations</span></span>  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="348c1-106">поддерживается для баз данных групп доступности, независимо от того, настроены ли реплики в локальной среде или полностью в Azure или является гибридной реализацией между локальной средой и одной или несколькими виртуальными машинами Azure.</span><span class="sxs-lookup"><span data-stu-id="348c1-106">is supported for Availability Group databases, whether the replicas are all configured on-premises, or entirely on Azure, or a Hybrid implementation between on-premises and on one or more Azure virtual machines.</span></span> <span data-ttu-id="348c1-107">Однако для одной или нескольких реализаций можно рассмотреть следующие аспекты.</span><span class="sxs-lookup"><span data-stu-id="348c1-107">However you might need to consider the following for one or more implementations:</span></span>  
  
-   <span data-ttu-id="348c1-108">Периодичность резервного копирования журналов. Периодичность резервного копирования журналов — это время и рост журнала.</span><span class="sxs-lookup"><span data-stu-id="348c1-108">Log Backup Frequency: The frequency of log backup is both time and log growth.</span></span> <span data-ttu-id="348c1-109">Например, резервная копия журнала создается каждые 2 часа, если только объем журнала не превысил в течение этих двух часов 5 МБ.</span><span class="sxs-lookup"><span data-stu-id="348c1-109">For example, the log backup is taken once every 2 hours unless the log space used within the two hour period is 5 MB or more.</span></span> <span data-ttu-id="348c1-110">Это относится ко всем реализациям: локальным, облачным или гибридным.</span><span class="sxs-lookup"><span data-stu-id="348c1-110">This applies to all implementations, on-premises, cloud, or a Hybrid.</span></span>  
  
-   <span data-ttu-id="348c1-111">Пропускная способность сети. Это относится к реализациям, где реплики находятся в разных физических расположениях, например в гибридном облаке, или в разных регионах Azure в конфигурации только в облаке.</span><span class="sxs-lookup"><span data-stu-id="348c1-111">Network Bandwidth: This applies to implementations where the replicas are located in different physical locations, like in a hybrid cloud, or across different Azure regions in a cloud only configuration.</span></span> <span data-ttu-id="348c1-112">Пропускная способность сети может повлиять на задержку баз данных-получателей, а также в случае, если в базах данных-получателях настроена синхронная репликация, что может привести к увеличению объема журнала в базе данных-источнике.</span><span class="sxs-lookup"><span data-stu-id="348c1-112">The network bandwidth can affect the latency of the secondaries and if the secondaries are set to synchronous replication, then this can cause log growth on the primary.</span></span> <span data-ttu-id="348c1-113">Если в базах данных-получателях настроена синхронная репликация, то из-за задержки в сети они могут не успевать, что может привести к потере данных в случае переключения на вторичную реплику.</span><span class="sxs-lookup"><span data-stu-id="348c1-113">If the secondaries are set to synchronous replication, the secondaries may not be able to keep up due to network latency, which can result in data loss in the event of a failover to the secondary replica.</span></span>  
  
### <a name="configuring-ss_smartbackup-for-availability-databases"></a><span data-ttu-id="348c1-114">Настройка [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для баз данных доступности.</span><span class="sxs-lookup"><span data-stu-id="348c1-114">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for Availability Databases.</span></span>  
 <span data-ttu-id="348c1-115">**Разрешения**.</span><span class="sxs-lookup"><span data-stu-id="348c1-115">**Permissions:**</span></span>  
  
-   <span data-ttu-id="348c1-116">Требуется членство в **db_backupoperator** роли базы данных с разрешениями **ALTER ANY CREDENTIAL** и `EXECUTE` разрешения на хранимую процедуру **sp_delete_backuphistory**.</span><span class="sxs-lookup"><span data-stu-id="348c1-116">Requires membership in **db_backupoperator** database role, with **ALTER ANY CREDENTIAL** permissions, and `EXECUTE` permissions on **sp_delete_backuphistory**stored procedure.</span></span>  
  
-   <span data-ttu-id="348c1-117">Требуются разрешения **SELECT** на функцию **smart_admin. fn_get_current_xevent_settings**.</span><span class="sxs-lookup"><span data-stu-id="348c1-117">Requires **SELECT** permissions on the **smart_admin.fn_get_current_xevent_settings**function.</span></span>  
  
-   <span data-ttu-id="348c1-118">Требуются `EXECUTE` разрешения на хранимую процедуру **smart_admin. sp_get_backup_diagnostics** .</span><span class="sxs-lookup"><span data-stu-id="348c1-118">Requires `EXECUTE` permissions on the **smart_admin.sp_get_backup_diagnostics** stored procedure.</span></span> <span data-ttu-id="348c1-119">Кроме того, необходимы разрешения `VIEW SERVER STATE`, так как процедура автоматически вызывает другие системные объекты, которым требуется это разрешение.</span><span class="sxs-lookup"><span data-stu-id="348c1-119">In addition, it requires `VIEW SERVER STATE` permissions as it internally calls other system objects that require this permission.</span></span>  
  
-   <span data-ttu-id="348c1-120">Требуются `EXECUTE` разрешения для `smart_admin.sp_set_instance_backup` `smart_admin.sp_backup_master_switch` хранимых процедур и.</span><span class="sxs-lookup"><span data-stu-id="348c1-120">Requires `EXECUTE` permissions on the `smart_admin.sp_set_instance_backup` and `smart_admin.sp_backup_master_switch` stored procedures.</span></span>  
  
 <span data-ttu-id="348c1-121">Ниже приведены основные шаги по настройке группы доступности AlwaysOn с [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="348c1-121">The following are the basic steps to setting up an AlwaysOn Availability Group with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="348c1-122">Подробное пошаговое руководство описано далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="348c1-122">A detailed step-by step tutorial is described later in this topic.</span></span>  
  
1.  <span data-ttu-id="348c1-123">После того как создана группа доступности, следует настроить предпочтительную реплику резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-123">Once you have created Availability Group, configure the preferred backup replica.</span></span> <span data-ttu-id="348c1-124">Этот параметр для группы доступности также используется [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для определения реплики, используемой для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-124">This setting for the Availability Group is also used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which replica to use for backup.</span></span> <span data-ttu-id="348c1-125">Пошаговые инструкции о настройке параметров резервного копирования см. в статье [Настройка резервного копирования на репликах доступности &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-125">For step by step instructions about how to set up the backup preference, see [Configure Backup on Availability Replicas &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span></span>  <span data-ttu-id="348c1-126">Если вы создаете новую группу доступности AlwaysOn, см. раздел [Начало работы with группы доступности AlwaysOn &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-126">If you are creating a new AlwaysOn Availability Group, see [Getting Started with AlwaysOn Availability Groups &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="348c1-127">Настройте доступ через соединение только для чтения к вторичным репликам.</span><span class="sxs-lookup"><span data-stu-id="348c1-127">Configure read only connection access to the secondary replicas.</span></span> <span data-ttu-id="348c1-128">Пошаговые инструкции о настройке доступа только для чтения см. в статье [Настройка доступа только для чтения в реплике доступности &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="348c1-128">For step by step instructions about how to configure read only access, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span></span>  
  
3.  <span data-ttu-id="348c1-129">Укажите реплику резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-129">Specify Backup replica.</span></span> <span data-ttu-id="348c1-130">С помощью параметра, указывающего предпочтительную реплику резервного копирования, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] определяет, какую базу данных выбрать для планирования резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-130">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which database to use for scheduling backups from..</span></span>  <span data-ttu-id="348c1-131">Чтобы определить, является ли текущая реплика предпочтительной репликой резервного копирования, воспользуйтесь функцией [sys. fn_hadr_backup_is_preferred_replica &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="348c1-131">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
4.  <span data-ttu-id="348c1-132">На каждой реплике выполните [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] конфигурацию базы данных с помощью хранимой процедуры **Smart-admin. sp_set_db_backup** .</span><span class="sxs-lookup"><span data-stu-id="348c1-132">On each replica run [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration for the database using the **smart-admin.sp_set_db_backup** stored procedure.</span></span>  
  
     <span data-ttu-id="348c1-133">\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] поведение после отработки отказа.\*\* продолжит [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] работу и сохранит резервные копии и возможность восстановления после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="348c1-133">**[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] behavior after a failover:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will continue to work and maintain backup copies and recoverability after a failover event.</span></span> <span data-ttu-id="348c1-134">После отработки отказа никакие особые действия не требуются.</span><span class="sxs-lookup"><span data-stu-id="348c1-134">No specific action is required after a failover.</span></span>  
  
#### <a name="considerations-and-requirements"></a><span data-ttu-id="348c1-135">Рекомендации и требования</span><span class="sxs-lookup"><span data-stu-id="348c1-135">Considerations and Requirements:</span></span>  
 <span data-ttu-id="348c1-136">Настройка [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для баз данных, участвующих в группах доступности AlwaysOn, требует соблюдения определенных требований.</span><span class="sxs-lookup"><span data-stu-id="348c1-136">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Group requires specific considerations and requirements.</span></span> <span data-ttu-id="348c1-137">Ниже приведен список соображений и требований.</span><span class="sxs-lookup"><span data-stu-id="348c1-137">Following is a list of considerations and requirements:</span></span>  
  
-   <span data-ttu-id="348c1-138">Параметры конфигурации [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] должны быть одинаковыми для всех баз данных на всех узлах [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], участвующих в одной группе доступности.</span><span class="sxs-lookup"><span data-stu-id="348c1-138">The [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration settings should be the same for all the databases on all the nodes of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] participating in the same Availability Group.</span></span> <span data-ttu-id="348c1-139">Этого можно добиться, задавая одинаковые конфигурации [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для основной базы данных и всех реплик на уровне базы данных или задавая одинаковые параметры [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] по умолчанию на всех узлах, участвующих в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="348c1-139">You can achieve this either by setting  the same [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configurations for the primary and all the replicas at the database level, or by setting the same default [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] settings on all the nodes participating in the Availability Groups.</span></span> <span data-ttu-id="348c1-140">Рекомендуется настраивать [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для базы данных, поскольку настройка [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] на уровне базы данных позволяет изолировать параметры в базах данных, а изменения параметров по умолчанию влияют на все другие базы данных в экземпляре.</span><span class="sxs-lookup"><span data-stu-id="348c1-140">We recommend setting [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database because configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database level lets you isolate the settings to the databases and changes to default settings affect all other databases on the instance.</span></span>  
  
-   <span data-ttu-id="348c1-141">Укажите реплику резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-141">Specify Backup replica.</span></span> <span data-ttu-id="348c1-142">Предпочитаемая реплика резервного копирования используется [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для планирования резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-142">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to schedule the backups.</span></span> <span data-ttu-id="348c1-143">Чтобы определить, является ли текущая реплика предпочтительной репликой резервного копирования, воспользуйтесь функцией [sys. fn_hadr_backup_is_preferred_replica &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="348c1-143">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
-   <span data-ttu-id="348c1-144">Если в качестве предпочтительной реплики настраивается вторичная реплика, ей должен быть назначен хотя бы доступ через соединение только для чтения.</span><span class="sxs-lookup"><span data-stu-id="348c1-144">If the secondary replica is configured as the preferred replica, it should be configured to have at least read only connection access.</span></span> <span data-ttu-id="348c1-145">Группы доступности, у которых нет доступа к соединению с базами данных-получателями, не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="348c1-145">Availability groups that have no connection access to secondary databases are not supported.</span></span>  <span data-ttu-id="348c1-146">Дополнительные сведения см. в разделе [Настройка доступа только для чтения в реплике доступности (SQL Server)](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-146">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
-   <span data-ttu-id="348c1-147">Если вы настраиваете [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] после того, как была настроена группа доступности, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] пытается скопировать любые имеющиеся резервные копии в контейнер хранилища.</span><span class="sxs-lookup"><span data-stu-id="348c1-147">If you are configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] after you configure the Availability Group, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will attempt to copy any existing backups based and copy them over to the storage container.</span></span>  <span data-ttu-id="348c1-148">Если [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не удается найти либо нет доступа к имеющимся резервным копиям, будет запланировано полное резервное копирование базы данных.</span><span class="sxs-lookup"><span data-stu-id="348c1-148">If [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is unable to find or access existing backups, it will schedule a full database backup.</span></span> <span data-ttu-id="348c1-149">Это сделано специально для оптимизации операций резервного копирования для баз данных группы доступности.</span><span class="sxs-lookup"><span data-stu-id="348c1-149">This is done specifically to optimize the backup operations for Availability Group databases.</span></span>  
  
-   <span data-ttu-id="348c1-150">Если вы создаете новую базу данных доступности и не планируете применять параметры уровня экземпляра к базе данных, рекомендуется отключить параметры уровня экземпляра.</span><span class="sxs-lookup"><span data-stu-id="348c1-150">You may want to consider disabling the instance level settings if you are creating a new availability database, and you don't intend to apply the instance level settings to the database</span></span>  
  
-   <span data-ttu-id="348c1-151">При использовании шифрования применяйте один и тот же сертификат на всех репликах.</span><span class="sxs-lookup"><span data-stu-id="348c1-151">When using encryption, use the same certificate on all the replicas.</span></span> <span data-ttu-id="348c1-152">Это облегчает непрерывное выполнение резервного копирования при отработке отказа или восстановления на другую реплику.</span><span class="sxs-lookup"><span data-stu-id="348c1-152">This facilitates continued and uninterrupted backup operations in the event of a failover or restores to a different replica.</span></span>  
  
#### <a name="enable-and-configure-ss_smartbackup-for-an-availability-database"></a><span data-ttu-id="348c1-153">Включение и настройка [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для базы данных доступности</span><span class="sxs-lookup"><span data-stu-id="348c1-153">Enable and Configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for an Availability Database</span></span>  
 <span data-ttu-id="348c1-154">В этом учебнике приведены шаги по включению и настройке [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для базы данных (AGTestDB) на компьютерах «Node1» и «Node2», затем приведены шаги по включению наблюдения за состоянием работоспособности [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="348c1-154">This tutorial describes the steps to enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for a database (AGTestDB) on computers Node1 and Node2, followed by steps to enable monitoring the [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] health status.</span></span>  
  
1.  <span data-ttu-id="348c1-155">**Создайте учетную запись хранения Azure.** Резервные копии хранятся в службе хранилища BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="348c1-155">**Create an Azure storage account:** The backups are stored in the Azure Blob storage service.</span></span> <span data-ttu-id="348c1-156">Необходимо сначала создать учетную запись хранения Azure, если она еще не создана.</span><span class="sxs-lookup"><span data-stu-id="348c1-156">You must first create an Azure storage account, if you do not already have one.</span></span> <span data-ttu-id="348c1-157">Дополнительные сведения см. в статье [Создание учетной записи хранения Azure](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span><span class="sxs-lookup"><span data-stu-id="348c1-157">For more information, see [Creating an Azure Storage Account](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span></span> <span data-ttu-id="348c1-158">Запишите имя учетной записи хранения, ключи доступа и URL-адрес учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="348c1-158">Make a note of the storage account name, access keys, and URL of the storage account.</span></span> <span data-ttu-id="348c1-159">Имя учетной записи хранения и сведения о ключе доступа используются для создания учетных данных SQL.</span><span class="sxs-lookup"><span data-stu-id="348c1-159">The storage account name and access key information is used to create a SQL Credential.</span></span> <span data-ttu-id="348c1-160">Учетные данные SQL используются в [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] во время операций с резервными копиями для проверки подлинности учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="348c1-160">The SQL Credential is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] during backup operations to authenticate to the storage account.</span></span>  
  
2.  <span data-ttu-id="348c1-161">**Создайте учетные данные SQL:** Создайте учетные данные SQL, используя имя учетной записи хранения в качестве удостоверения и ключ доступа к хранилищу в качестве пароля.</span><span class="sxs-lookup"><span data-stu-id="348c1-161">**Create a SQL Credential:** Create a SQL Credential using the name of the storage account as the Identity and the storage access key as the password.</span></span>  
  
3.  <span data-ttu-id="348c1-162">**Убедитесь в том, что служба агента SQL Server запущена и работает.** Запустите агент SQL Server, если он не запущен.</span><span class="sxs-lookup"><span data-stu-id="348c1-162">**Ensure SQL Server Agent service is Started and Running:** Start SQL Server Agent if it is not currently running.</span></span> [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="348c1-163">требует, чтобы агент SQL Server был запущен на экземпляре.</span><span class="sxs-lookup"><span data-stu-id="348c1-163">requires SQL Server Agent to be running on the instance to perform backup operations.</span></span>  <span data-ttu-id="348c1-164">Можно установить автоматический запуск агента SQL Server, чтобы обеспечить регулярное выполнение операций резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-164">You may want to set SQL Agent to run automatically to make sure that backup operations can occur regularly.</span></span>  
  
4.  <span data-ttu-id="348c1-165">**Определите срок хранения:** Определите срок хранения файлов резервной копии.</span><span class="sxs-lookup"><span data-stu-id="348c1-165">**Determine the retention period:** Determine the retention period that you want for the backup files.</span></span> <span data-ttu-id="348c1-166">Срок хранения указывается в днях и может принимать значение от 1 до 30.</span><span class="sxs-lookup"><span data-stu-id="348c1-166">The retention period is specified in days and can range from 1 to 30.</span></span> <span data-ttu-id="348c1-167">Срок хранения определяет интервал времени восстановления для базы данных.</span><span class="sxs-lookup"><span data-stu-id="348c1-167">The retention period determines the recoverability time frame for the database.</span></span>  
  
5.  <span data-ttu-id="348c1-168">**Создайте сертификат или асимметричный ключ, который будет использоваться для шифрования во время резервного копирования:** Создайте сертификат на первом узле NODE1, а затем экспортируйте его в файл с помощью [сертификата резервного копирования &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql)..</span><span class="sxs-lookup"><span data-stu-id="348c1-168">**Create a Certificate or Asymmetric key to use for encryption during back up:** Create the certificate on the first node Node1, and then export it to a file using [BACKUP CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql)..</span></span> <span data-ttu-id="348c1-169">На узле Node 2 создайте сертификат с помощью файла, экспортированного с Node 1.</span><span class="sxs-lookup"><span data-stu-id="348c1-169">On Node 2, create a certificate using the file exported from Node 1 .</span></span> <span data-ttu-id="348c1-170">Дополнительные сведения о создании сертификата из файла см. в примере в статье [Создание сертификата &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="348c1-170">For more information on creating a certificate from a file, see the example in [CREATE CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span></span>  
  
6.  <span data-ttu-id="348c1-171">**Включите и настройте [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для AGTestDB на NODE1:** Start SQL Server Management Studio и подключитесь к экземпляру на NODE1, где установлена база данных доступности.</span><span class="sxs-lookup"><span data-stu-id="348c1-171">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node1:** Start SQL Server Management Studio  and connect to the instance on Node1 where the availability database  is installed.</span></span> <span data-ttu-id="348c1-172">В окне запроса выполните приведенную ниже инструкцию, предварительно задав значения имени базы данных, URL-адреса хранилища, учетных данных SQL и срока хранения.</span><span class="sxs-lookup"><span data-stu-id="348c1-172">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     <span data-ttu-id="348c1-173">Дополнительные сведения о создании сертификата для шифрования см. в разделе Создание **резервной копии сертификата** статьи [Создание зашифрованного резервного копирования](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-173">For more information on creating a certificate for encryption, see the **Create a Backup Certificate** step in [Create an Encrypted Backup](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span></span>  
  
7.  <span data-ttu-id="348c1-174">**Включите и настройте [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для AGTestDB на NODE2:** Start SQL Server Management Studio и подключитесь к экземпляру на NODE2, где установлена база данных доступности.</span><span class="sxs-lookup"><span data-stu-id="348c1-174">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node2:** Start SQL Server Management Studio and connect to the instance on Node2 where the availability database  is installed.</span></span> <span data-ttu-id="348c1-175">В окне запроса выполните приведенную ниже инструкцию, предварительно задав значения имени базы данных, URL-адреса хранилища, учетных данных SQL и срока хранения.</span><span class="sxs-lookup"><span data-stu-id="348c1-175">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="348c1-176">включено на указанной базе данных.</span><span class="sxs-lookup"><span data-stu-id="348c1-176">is now enabled on the database you specified.</span></span> <span data-ttu-id="348c1-177">Может потребоваться до 15 минут, прежде чем начнут выполняться операции резервного копирования для базы данных.</span><span class="sxs-lookup"><span data-stu-id="348c1-177">It may take up to 15 minutes for the backup operations on the database to start to run.</span></span> <span data-ttu-id="348c1-178">Резервные копии будут появляться на предпочтительной реплике резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-178">The backup will occur on the preferred backup replica.</span></span>  
  
8.  <span data-ttu-id="348c1-179">**Проверьте конфигурацию расширенных событий по умолчанию:**  Проверьте конфигурацию расширенных событий, выполнив следующую инструкцию Transact-SQL в реплике, которая [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] использует для планирования резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="348c1-179">**Review Extended Event Default Configuration:**  Review the Extended Event configuration by running the following transact-SQL statement on the replica that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is using to schedule the backups from.</span></span> <span data-ttu-id="348c1-180">Обычно это параметр предпочтительной реплики для группы доступности, к которой принадлежит база данных.</span><span class="sxs-lookup"><span data-stu-id="348c1-180">This is usually the preferred backup replica setting for the Availability Group that the database belongs to.</span></span>  
  
    ```sql  
    SELECT * FROM smart_admin.fn_get_current_xevent_settings(); 
    ```  
  
     <span data-ttu-id="348c1-181">Обратите внимание, что события каналов Admin, Operational и Analytical включены по умолчанию и их нельзя отключить.</span><span class="sxs-lookup"><span data-stu-id="348c1-181">You should see that Admin, Operational  and Analytical channel events are enabled by default and cannot be disabled.</span></span> <span data-ttu-id="348c1-182">Этого должно быть достаточно для наблюдения за событиями, требующими ручного вмешательства.</span><span class="sxs-lookup"><span data-stu-id="348c1-182">This should be sufficient to monitor the events that require manual intervention.</span></span>  <span data-ttu-id="348c1-183">Можно включить события отладки, но эти каналы содержат информационные и отладочные события, которые [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] использует для обнаружения и устранения проблем.</span><span class="sxs-lookup"><span data-stu-id="348c1-183">You can enable the debug events, but these channels include informational and debug events that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] uses to detect issues and solve them.</span></span> <span data-ttu-id="348c1-184">Дополнительные сведения см. [в статье мониторинг SQL Server управляемого резервного копирования в Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-184">For more information, see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
9. <span data-ttu-id="348c1-185">**Включите и настройте уведомление о состоянии работоспособности.** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] имеет хранимую процедуру, создающую задание агента для отправки по электронной почте уведомлений об ошибках или предупреждений, которые могут требовать внимания пользователя.</span><span class="sxs-lookup"><span data-stu-id="348c1-185">**Enable and Configure Notification for Health Status:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] has a stored procedure that creates an agent job to send out e-mail notifications of errors or warnings that may require attention.</span></span>  <span data-ttu-id="348c1-186">Чтобы получать такие уведомления, необходимо включить запуск хранимой процедуры, которая создает задание агента SQL Server.</span><span class="sxs-lookup"><span data-stu-id="348c1-186">To receive such notifications, you must enable run the stored procedure which creates a SQL Server Agent Job.</span></span> <span data-ttu-id="348c1-187">Приведенные ниже шаги описывают процесс включения и настройки уведомлений по электронной почте.</span><span class="sxs-lookup"><span data-stu-id="348c1-187">The following steps describe the process to enable and configure e-mail notifications:</span></span>  
  
    1.  <span data-ttu-id="348c1-188">Настройте компонент Database Mail, если он еще не включен на экземпляре.</span><span class="sxs-lookup"><span data-stu-id="348c1-188">Setup Database Mail if it is not already enabled on the instance.</span></span> <span data-ttu-id="348c1-189">Дополнительные сведения см. в разделе [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-189">For more information, see [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span></span>  
  
    2.  <span data-ttu-id="348c1-190">Настройте уведомления агента SQL Server для использования компонента Database Mail.</span><span class="sxs-lookup"><span data-stu-id="348c1-190">Configure SQL Server Agent Notification to use Database Mail.</span></span> <span data-ttu-id="348c1-191">Дополнительные сведения см. в статье [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-191">For more information, see [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span></span>  
  
    3.  <span data-ttu-id="348c1-192">**Включите уведомления по электронной почте для получения ошибок и предупреждений, связанных с резервными копиями**. В окне запроса выполните следующие инструкции Transact-SQL:</span><span class="sxs-lookup"><span data-stu-id="348c1-192">**Enable e-mail notifications to receive backup errors and warnings:** From the query window, run the following Transact-SQL statements:</span></span>  
  
        ```sql  
        EXEC msdb.smart_admin.sp_set_parameter  
        @parameter_name = 'SSMBackup2WANotificationEmailIds',  
        @parameter_value = '<email>'  
        ```  
  
         <span data-ttu-id="348c1-193">Дополнительные сведения и полный пример скрипта см. в статье [мониторинг SQL Server управляемого резервного копирования в Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-193">For more information and a full sample script see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
10. <span data-ttu-id="348c1-194">**Просмотр файлов резервных копий в учетной записи хранения Azure:** Подключитесь к учетной записи хранения из SQL Server Management Studio или портал управления Azure.</span><span class="sxs-lookup"><span data-stu-id="348c1-194">**View backup files in the Azure Storage Account:** Connect to the storage account from SQL Server Management Studio or the Azure Management Portal.</span></span> <span data-ttu-id="348c1-195">Вы увидите контейнер экземпляра SQL Server, в котором размещается база данных, настроенная на использование [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="348c1-195">You will see a container for the instance of SQL Server that hosts the database you configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="348c1-196">Кроме того, можно настроить базу данных и резервное копирование журналов за 15 минут либо включить [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для базы данных.</span><span class="sxs-lookup"><span data-stu-id="348c1-196">You may also see a database and a log backup within 15 minutes of enabling [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the database.</span></span>  
  
11. <span data-ttu-id="348c1-197">**Мониторинг состояния работоспособности**.  Можно вести мониторинг с помощью настроенных ранее уведомлений по электронной почте либо активно просматривать события в журнале.</span><span class="sxs-lookup"><span data-stu-id="348c1-197">**Monitor the Health Status:**  You can monitor through e-mail notifications you configured previously, or actively monitor the events logged.</span></span> <span data-ttu-id="348c1-198">Ниже приведены примеры инструкций Transact-SQL, которые используются для просмотра событий.</span><span class="sxs-lookup"><span data-stu-id="348c1-198">The following are some example Transact-SQL Statements used to view the events:</span></span>  
  
    ```sql  
    --  view all admin events  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    DECLARE @eventresult TABLE  
    (event_type nvarchar(512),  
    event varchar (512),  
    timestamp datetime  
    )  
  
    INSERT INTO @eventresult  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek  
  
    SELECT * from @eventresult  
    WHERE event_type LIKE '%admin%'  
    ```  
  
    ```sql  
    -- to enable debug events  
    Use msdb;  
    Go  
    EXEC smart_admin.sp_set_parameter 'FileRetentionDebugXevent', 'True'  
    ```  
  
    ```sql  
    --  View all events in the current week  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek;  
    ```  
  
 <span data-ttu-id="348c1-199">Шаги, описанные в этом разделе, специально предназначены для первой настройки [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] в базе данных.</span><span class="sxs-lookup"><span data-stu-id="348c1-199">The steps described in this section are specifically for configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the first time on the database.</span></span> <span data-ttu-id="348c1-200">Существующие конфигурации можно изменить с помощью той же системной хранимой процедуры **smart_admin. sp_set_db_backup** и укажите новые значения.</span><span class="sxs-lookup"><span data-stu-id="348c1-200">You can modify the existing configurations using the same system stored procedure **smart_admin.sp_set_db_backup** and provide the new values.</span></span> <span data-ttu-id="348c1-201">Дополнительные сведения см. [в разделе SQL Server управляемое резервное копирование в Azure — параметры хранения и хранилища](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span><span class="sxs-lookup"><span data-stu-id="348c1-201">For more information, see [SQL Server Managed Backup to Azure - Retention and Storage Settings](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span></span>  
  
### <a name="considerations-when-removing-a-database-from-alwayson-availability-group-configuration"></a><span data-ttu-id="348c1-202">Соображения по удалению базы данных из конфигурации группы доступности AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="348c1-202">Considerations when Removing a Database from AlwaysOn Availability Group Configuration</span></span>  
 <span data-ttu-id="348c1-203">Если база данных удаляется из конфигурации группы доступности AlwaysOn и теперь является изолированной базой данных, рекомендуется выполнить резервное копирование с помощью [smart_admin. sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="348c1-203">If a database is removed from the AlwaysOn Availability Group configuration and is now a stand-alone database, we recommend doing backup using [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span></span> <span data-ttu-id="348c1-204">При создании резервной копии базы данных таким образом формируется новая цепочка резервного копирования, а файл помещается в контейнер конкретного экземпляра в отличие от контейнера доступности, в котором хранятся резервные копии, если база данных является частью группы доступности.</span><span class="sxs-lookup"><span data-stu-id="348c1-204">When you create a database backup  this way, it establishes  a new backup chain and the file will be placed in the instance specific container as opposed to Availability container where the backups were stored when the database was part of Availability Group.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="348c1-205">В этом сценарии возможность восстановления базы данных из резервных копий, созданных до изменения состояния группы доступности, не гарантируется.</span><span class="sxs-lookup"><span data-stu-id="348c1-205">The recoverability of the database in this scenario from backups previous to the change in the Availability Group status is not guaranteed.</span></span>  
  
