---
title: Репликация и доставка журналов (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- replication [SQL Server], log shipping and
- log shipping [SQL Server], replication and
ms.assetid: 132bebfd-0206-4d23-829a-b38e5ed17bc9
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e3b1a0e08c5850b9e31202965909dfcfe1273e47
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87665550"
---
# <a name="log-shipping-and-replication-sql-server"></a><span data-ttu-id="f5ba3-102">Репликация и доставка журналов (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f5ba3-102">Log Shipping and Replication (SQL Server)</span></span>
  <span data-ttu-id="f5ba3-103">Доставка журналов использует две копии одной базы данных, которые обычно хранится на разных компьютерах.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-103">Log shipping involves two copies of a single database that typically reside on different computers.</span></span> <span data-ttu-id="f5ba3-104">В любой момент только одна копия базы данных доступна клиентам.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-104">At any given time, only one copy of the database is currently available to clients.</span></span> <span data-ttu-id="f5ba3-105">Эта копия известна как база данных-источник.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-105">This copy is known as the primary database.</span></span> <span data-ttu-id="f5ba3-106">Обновления, вносимые клиентами в базу данных-источник, распространяются при помощи доставки журналов в другую копию базы данных, которая называется база данных-получатель.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-106">Updates made by clients to the primary database are propagated by means of log shipping to the other copy of the database, known as the secondary database.</span></span> <span data-ttu-id="f5ba3-107">Доставка журналов включает применение каждой вставки, обновления или удаления, сделанных в базе данных-источнике, к базе данных-получателю с помощью журнала транзакций.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-107">Log shipping involves applying the transaction log from every insertion, update, or deletion made on the primary database onto the secondary database.</span></span>  
  
 <span data-ttu-id="f5ba3-108">Доставка журналов может использоваться совместно с репликацией со следующими особенностями.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-108">Log shipping can be used in conjunction with replication, with the following behavior:</span></span>  
  
-   <span data-ttu-id="f5ba3-109">Репликация не продолжается после отработки отказа доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-109">Replication does not continue after a log shipping failover.</span></span> <span data-ttu-id="f5ba3-110">В случае отработки отказа агенты репликации не подключаются к базе данных-получателю, поэтому транзакции не реплицируются подписчикам.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-110">If a failover occurs, replication agents do not connect to the secondary, so transactions are not replicated to Subscribers.</span></span> <span data-ttu-id="f5ba3-111">Если происходит автоматический возврат на базу данных-источник, репликация возобновляется.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-111">If a failback to the primary occurs, replication resumes.</span></span> <span data-ttu-id="f5ba3-112">Все транзакции, которые при доставке журналов копируются из базы данных-получателя в базу данных-источник, реплицируются подписчикам.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-112">All transactions that log shipping copies from the secondary back to the primary are replicated to Subscribers.</span></span>  
  
-   <span data-ttu-id="f5ba3-113">Если база данных-источник потеряна безвозвратно, базу данных-получатель можно переименовать, чтобы продолжить репликацию.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-113">If the primary is permanently lost, the secondary can be renamed so that replication can continue.</span></span> <span data-ttu-id="f5ba3-114">Далее описываются требования и процедуры, которым необходимо следовать при обработке данного случая.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-114">The remainder of this topic describes the requirements and procedures for handling this case.</span></span> <span data-ttu-id="f5ba3-115">В качестве примера описывается база данных публикации, которая чаще всего используется для доставки журналов, но такой же процесс может быть применен и к базе данных подписки, и к базе данных распространителя.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-115">The example given is the publication database, which is the most common database to log ship, but a similar process can also be applied to subscription and distribution databases.</span></span>  
  
 <span data-ttu-id="f5ba3-116">Сведения о восстановлении баз данных, задействованных в процессе репликации, без изменения настроек репликации см. в статье [Создание резервной копии и восстановление из копий реплицируемых баз данных](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-116">For information about recovering databases involved in replication without any need to reconfigure replication, see [Back Up and Restore Replicated Databases](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f5ba3-117">В целях обеспечения доступности базы данных публикации рекомендуется использовать зеркальное отображение базы данных, а не доставку журналов.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-117">We recommend using database mirroring, rather than log shipping, to provide availability for the publication database.</span></span> <span data-ttu-id="f5ba3-118">Дополнительные сведения см. в статье [Зеркальное отображение и репликация баз данных (SQL Server)](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-118">For more information, see [Database Mirroring and Replication &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span></span>  
  
## <a name="requirements-and-procedures-for-replicating-from-the-secondary-if-the-primary-is-lost"></a><span data-ttu-id="f5ba3-119">Требования и процедуры для репликации из базы данных-получателя в случае утери базы данных-источника</span><span class="sxs-lookup"><span data-stu-id="f5ba3-119">Requirements and Procedures for Replicating from the Secondary If the Primary Is Lost</span></span>  
 <span data-ttu-id="f5ba3-120">Учитывайте следующие требования и замечания.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-120">Be aware of the following requirements and considerations:</span></span>  
  
-   <span data-ttu-id="f5ba3-121">Если на сервере-источнике содержится несколько баз данных публикации, доставьте журналы всех баз данных публикации на один сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-121">If a primary contains more than one publication database, log ship all of the publication databases to the same secondary.</span></span>  
  
-   <span data-ttu-id="f5ba3-122">Путь установки экземпляра сервера-получателя должен совпадать с путем установки сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-122">The installation path for the secondary server instance must be the same as the primary.</span></span> <span data-ttu-id="f5ba3-123">Места нахождения баз данных пользователя на сервере-получателе должны совпадать с местами нахождения на сервере-источнике.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-123">User database locations on the secondary server must be the same as on the primary.</span></span>  
  
-   <span data-ttu-id="f5ba3-124">Создайте резервную копию главного ключа службы на сервере-источнике.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-124">Back up the service master key at the primary.</span></span> <span data-ttu-id="f5ba3-125">Данный ключ будет восстановлен на сервере-получателе.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-125">This key will be restored at the secondary.</span></span> <span data-ttu-id="f5ba3-126">Дополнительные сведения см. в статье [BACKUP SERVICE MASTER KEY (Transact-SQL)](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-126">For more information, see [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span></span>  
  
-   <span data-ttu-id="f5ba3-127">Доставка журналов не гарантирует сохранности данных.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-127">Log shipping does not guarantee against data loss.</span></span> <span data-ttu-id="f5ba3-128">Сбой базы данных-источника может вызвать потерю тех данных, для которых не была создана резервная копия, а также данных, резервные копии которых были утеряны из-за сбоя.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-128">A failure on the primary database can result in the loss of data that has not yet been backed up or for backups that are lost during the failure.</span></span>  
  
### <a name="log-shipping-with-transactional-replication"></a><span data-ttu-id="f5ba3-129">Доставка журналов при репликации транзакций</span><span class="sxs-lookup"><span data-stu-id="f5ba3-129">Log Shipping with Transactional Replication</span></span>  
 <span data-ttu-id="f5ba3-130">Для репликации транзакций способ доставки журналов зависит от параметра **sync with backup** .</span><span class="sxs-lookup"><span data-stu-id="f5ba3-130">For transactional replication, the behavior of log shipping depends on the **sync with backup** option.</span></span> <span data-ttu-id="f5ba3-131">Данный параметр устанавливается в базе данных публикации и базе данных распространителя. При доставке журналов издателю учитывается только параметр в базе данных публикации.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-131">This option can be set on the publication database and distribution database; in log shipping for the Publisher, only the setting on the publication database is relevant.</span></span>  
  
 <span data-ttu-id="f5ba3-132">Установка этого параметра для базы данных публикации гарантирует, что транзакции не будут доставлены в базу данных распространителя до тех пор, пока не будет создана их резервная копия в базе данных публикации.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-132">Setting this option on the publication database ensures that transactions are not delivered to the distribution database until they are backed up at the publication database.</span></span> <span data-ttu-id="f5ba3-133">Затем последняя резервная копия базы данных публикации может быть восстановлена на сервере-получателе, при этом в базе данных распространителя не будет транзакций, отсутствующих в восстановленной базе данных публикации.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-133">The last publication database backup can then be restored at the secondary server without any possibility of the distribution database having transactions that the restored publication database does not have.</span></span> <span data-ttu-id="f5ba3-134">Данный параметр гарантирует, что в случае перехода издателя на сервер-получатель обеспечивается согласованность между издателем, распространителем и подписчиком.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-134">This option guarantees that if the Publisher fails over to a secondary server, consistency is maintained between the Publisher, Distributor, and Subscribers.</span></span> <span data-ttu-id="f5ba3-135">Затрагиваются задержка и пропускная способность, так как транзакции нельзя доставить в базу данных распространителя до тех пор, пока для них не созданы резервные копии на издателе. Если ваше приложение может работать с такой задержкой, рекомендуется установить этот параметр в базе данных публикации.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-135">Latency and throughput are affected because transactions cannot be delivered to the distribution database until they have been backed up at the Publisher; if your application can tolerate this latency, we recommend that you set this option on the publication database.</span></span> <span data-ttu-id="f5ba3-136">Если параметр **sync with backup** не установлен, подписчики могут получать изменения, которые более не включены в восстановленную базу данных на сервере-получателе.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-136">If the **sync with backup** option is not set, Subscribers might receive changes that are no longer included in the recovered database at the secondary server.</span></span> <span data-ttu-id="f5ba3-137">Дополнительные сведения см. в статье [Стратегии резервного копирования и восстановления из копии репликации моментальных снимков и репликации транзакций](../../relational-databases/replication/transactional/transactional-replication.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-137">For more information, see [Strategies for Backing Up and Restoring Snapshot and Transactional Replication](../../relational-databases/replication/transactional/transactional-replication.md).</span></span>  
  
 <span data-ttu-id="f5ba3-138">**Настройка репликации транзакций и доставки журналов с параметром «sync with backup»**</span><span class="sxs-lookup"><span data-stu-id="f5ba3-138">**To configure transactional replication and log shipping with the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="f5ba3-139">Если параметр «sync with backup» не установлен в базе данных публикации, выполните `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-139">If the sync with backup option is not set on the publication database, execute `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span></span> <span data-ttu-id="f5ba3-140">Дополнительные сведения см. в статье [sp_replicationdboption (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-140">For more information, see [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span></span>  
  
2.  <span data-ttu-id="f5ba3-141">Настройте доставку журналов для базы данных публикации.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-141">Configure log shipping for the publication database.</span></span> <span data-ttu-id="f5ba3-142">Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-142">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="f5ba3-143">Если издатель поврежден, восстановите последний журнал базы данных на сервере-получателе, используя параметр KEEP_REPLICATION инструкции RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-143">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="f5ba3-144">Это действие сохранит все настройки репликации для базы данных.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-144">This retains all replication settings for the database.</span></span> <span data-ttu-id="f5ba3-145">Дополнительные сведения см. в статьях [Переход на вторичный сервер доставки журналов (SQL Server)](fail-over-to-a-log-shipping-secondary-sql-server.md) и [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-145">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="f5ba3-146">Восстановите и перенесите базы данных **msdb** и **master** с сервера-источника на сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-146">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="f5ba3-147">Дополнительные сведения см. в статье [Резервное копирование и восстановление системных баз данных (SQL Server)](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-147">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="f5ba3-148">Если сервер-источник был также и распространителем, необходимо восстановить и перенести базу данных распространителя с сервера-источника на сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-148">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="f5ba3-149">Эти базы данных должны быть согласованы по конфигурации и настройкам репликации с базой данных публикации сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-149">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="f5ba3-150">Переименуйте компьютер сервера-получателя, а затем переименуйте экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , чтобы имя совпадало с именем сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-150">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="f5ba3-151">Сведения о переименовании компьютера см. в документации по операционной системе Windows.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-151">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="f5ba3-152">Сведения о переименовании сервера см. в разделах [Переименование компьютера, на который установлен изолированный экземпляр SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) и [Переименование экземпляра отказоустойчивого кластера SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-152">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
6.  <span data-ttu-id="f5ba3-153">На сервере-получателе восстановите главный ключ службы, резервная копия которого была получена с сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-153">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="f5ba3-154">Дополнительные сведения см. в статье [RESTORE SERVICE MASTER KEY (Transact-SQL)](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-154">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
 <span data-ttu-id="f5ba3-155">**Настройка репликации транзакций и доставки журналов без параметра «sync with backup»**</span><span class="sxs-lookup"><span data-stu-id="f5ba3-155">**To configure transactional replication and log shipping without the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="f5ba3-156">Настройте доставку журналов для базы данных публикации.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-156">Configure log shipping for the publication database.</span></span> <span data-ttu-id="f5ba3-157">Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-157">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="f5ba3-158">Если издатель поврежден, восстановите последний журнал базы данных на сервере-получателе, используя параметр KEEP_REPLICATION инструкции RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-158">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="f5ba3-159">Это действие сохранит все настройки репликации для базы данных.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-159">This retains all replication settings for the database.</span></span> <span data-ttu-id="f5ba3-160">Дополнительные сведения см. в статьях [Переход на вторичный сервер доставки журналов (SQL Server)](fail-over-to-a-log-shipping-secondary-sql-server.md) и [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-160">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
3.  <span data-ttu-id="f5ba3-161">Восстановите и перенесите базы данных **msdb** и **master** с сервера-источника на сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-161">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="f5ba3-162">Дополнительные сведения см. в статье [Резервное копирование и восстановление системных баз данных (SQL Server)](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-162">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="f5ba3-163">Если сервер-источник был также и распространителем, необходимо восстановить и перенести базу данных распространителя с сервера-источника на сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-163">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="f5ba3-164">Эти базы данных должны быть согласованы по конфигурации и настройкам репликации с базой данных публикации сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-164">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
4.  <span data-ttu-id="f5ba3-165">Переименуйте компьютер сервера-получателя, а затем переименуйте экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , чтобы имя совпадало с именем сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-165">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="f5ba3-166">Сведения о переименовании компьютера см. в документации по операционной системе Windows.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-166">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="f5ba3-167">Сведения о переименовании сервера см. в разделах [Переименование компьютера, на который установлен изолированный экземпляр SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) и [Переименование экземпляра отказоустойчивого кластера SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-167">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
     <span data-ttu-id="f5ba3-168">Возможно, будет получено сообщение об ошибке от агента чтения журнала, в котором указывается на отсутствие синхронизации базы данных публикации с базой данных распространителя.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-168">You might receive an error message from the Log Reader Agent that the publication database and the distribution database are not synchronized.</span></span>  
  
5.  <span data-ttu-id="f5ba3-169">На сервере-получателе восстановите главный ключ службы, резервная копия которого была получена с сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-169">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="f5ba3-170">Дополнительные сведения см. в статье [RESTORE SERVICE MASTER KEY (Transact-SQL)](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-170">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="f5ba3-171">Выполните **sp_replrestart**.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-171">Execute **sp_replrestart**.</span></span> <span data-ttu-id="f5ba3-172">Данную хранимую процедуру можно использовать для принудительного пропуска агентом чтения журнала всех предыдущих реплицированных транзакций в журнале базы данных публикации.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-172">This stored procedure can be used to force the Log Reader Agent to ignore all the previous replicated transactions in the publication database log.</span></span> <span data-ttu-id="f5ba3-173">Транзакции, примененные после завершения хранимой процедуры, обрабатываются агентом чтения журнала.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-173">Transactions applied after the completion of the stored procedure are processed by the Log Reader Agent.</span></span> <span data-ttu-id="f5ba3-174">Дополнительные сведения см. в статье [sp_replrestart (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-174">For more information, see [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span></span>  
  
7.  <span data-ttu-id="f5ba3-175">Перезапустите агент чтения журнала после того, как хранимая процедура будет успешно выполнена.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-175">Restart the Log Reader Agent after the stored procedure executes successfully.</span></span> <span data-ttu-id="f5ba3-176">Дополнительные сведения см. в статье [Запуск и остановка агента репликации (среда SQL Server Management Studio)](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-176">For more information, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span></span>  
  
8.  <span data-ttu-id="f5ba3-177">Транзакции, которые уже распространены на подписчике, могут применяться на издателе.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-177">Transactions that have already been distributed to Subscriber might be applied at the Publisher.</span></span> <span data-ttu-id="f5ba3-178">Чтобы агент распространителя при повреждении не выдал сообщения об ошибке при попытке повторного применения этих транзакций на подписчике, укажите профиль агента **Продолжать при возникновении ошибок согласованности данных**.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-178">To ensure that the Distribution Agent does not fail with an error when attempting to reapply these transactions at a Subscriber, specify the agent profile titled **Continue On Data Consistency Errors**.</span></span>  
  
### <a name="log-shipping-with-merge-replication"></a><span data-ttu-id="f5ba3-179">Доставка журналов при репликации слиянием</span><span class="sxs-lookup"><span data-stu-id="f5ba3-179">Log Shipping with Merge Replication</span></span>  
 <span data-ttu-id="f5ba3-180">Выполните указанную ниже последовательность действий, чтобы настроить репликацию слиянием и доставку журналов.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-180">Follow the steps in the procedure below to configure merge replication and log shipping.</span></span>  
  
 <span data-ttu-id="f5ba3-181">**Настройка репликации слиянием и доставки журналов**</span><span class="sxs-lookup"><span data-stu-id="f5ba3-181">**To configure merge replication and log shipping**</span></span>  
  
1.  <span data-ttu-id="f5ba3-182">Настройте доставку журналов для базы данных публикации.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-182">Configure log shipping for the publication database.</span></span> <span data-ttu-id="f5ba3-183">Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-183">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="f5ba3-184">Если издатель завершает работу по ошибке, переименуйте компьютер сервера-получателя, а затем переименуйте экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], чтобы имя совпадало с именем сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-184">If the Publisher fails, at the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="f5ba3-185">Сведения о переименовании компьютера см. в документации по операционной системе Windows.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-185">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="f5ba3-186">Сведения о переименовании сервера см. в разделах [Переименование компьютера, на который установлен изолированный экземпляр SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) и [Переименование экземпляра отказоустойчивого кластера SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-186">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
3.  <span data-ttu-id="f5ba3-187">Восстановите последний журнал базы данных на сервере-получателе, используя параметр KEEP_REPLICATION инструкции RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-187">Restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="f5ba3-188">Это действие сохранит все настройки репликации для базы данных.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-188">This retains all replication settings for the database.</span></span> <span data-ttu-id="f5ba3-189">Дополнительные сведения см. в статьях [Переход на вторичный сервер доставки журналов (SQL Server)](fail-over-to-a-log-shipping-secondary-sql-server.md) и [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-189">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="f5ba3-190">Восстановите и перенесите базы данных **msdb** и **master** с сервера-источника на сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-190">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="f5ba3-191">Дополнительные сведения см. в статье [Резервное копирование и восстановление системных баз данных (SQL Server)](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-191">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="f5ba3-192">Если сервер-источник был также и распространителем, необходимо восстановить и перенести базу данных распространителя с сервера-источника на сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-192">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="f5ba3-193">Эти базы данных должны быть согласованы по конфигурации и настройкам репликации с базой данных публикации сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-193">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="f5ba3-194">На сервере-получателе восстановите главный ключ службы, резервная копия которого была получена с сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-194">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="f5ba3-195">Дополнительные сведения см. в статье [RESTORE SERVICE MASTER KEY (Transact-SQL)](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-195">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="f5ba3-196">Синхронизируйте базу данных публикации с одной или несколькими базами данных подписки.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-196">Synchronize the publication database with one or more subscription databases.</span></span> <span data-ttu-id="f5ba3-197">Это позволит провести передачу изменений, сделанных в базе данных публикации, но не представленных в восстановленной резервной копии.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-197">This allows you to upload those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="f5ba3-198">Передаваемые данные зависят от того, как отфильтрованы публикации:</span><span class="sxs-lookup"><span data-stu-id="f5ba3-198">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
    -   <span data-ttu-id="f5ba3-199">Если публикации не отфильтрованы, должна существовать возможность обновления базы данных публикаций посредством синхронизации с самым обновленным подписчиком.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-199">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
    -   <span data-ttu-id="f5ba3-200">Если же публикация отфильтрована, то базу данных публикации, возможно, не удастся обновить.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-200">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="f5ba3-201">Рассмотрим таблицу, которая разделена так, что каждая подписка получает данные клиентов только из одного региона: север, восток, юг и запад.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-201">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="f5ba3-202">Если существует по крайней мере один подписчик из каждой секции данных, синхронизация с подписчиком из каждой секции должна обновить базу данных публикаций.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-202">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="f5ba3-203">Однако если данные в западной секции, например не были реплицированы на какие-либо подписчики, эти данные на издателе невозможно будет обновить.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-203">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span> <span data-ttu-id="f5ba3-204">В таком случае рекомендуется провести повторную инициализацию всех подписок, чтобы добиться конвергенции данных на издателе и подписчиках.</span><span class="sxs-lookup"><span data-stu-id="f5ba3-204">In this case, we recommend reinitializing all subscriptions so that the data at the Publisher and Subscribers converges.</span></span> <span data-ttu-id="f5ba3-205">Дополнительные сведения см. в статье [Повторная инициализация подписок](../../relational-databases/replication/reinitialize-subscriptions.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-205">For more information, see [Reinitialize Subscriptions](../../relational-databases/replication/reinitialize-subscriptions.md).</span></span>  
  
     <span data-ttu-id="f5ba3-206">При синхронизации с подписчиком, на котором запущена версия [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , предшествующая [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], подписка не может быть анонимной. Это должна быть клиентская или серверная подписка (в предыдущих версиях такие подписки называются локальными или глобальными).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-206">If you synchronize with a Subscriber that is running a version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] prior to [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span> <span data-ttu-id="f5ba3-207">Дополнительные сведения см. в разделе [Синхронизация данных](../../relational-databases/replication/synchronize-data.md).</span><span class="sxs-lookup"><span data-stu-id="f5ba3-207">For more information, see [Synchronize Data](../../relational-databases/replication/synchronize-data.md).</span></span>   
  
## <a name="see-also"></a><span data-ttu-id="f5ba3-208">См. также:</span><span class="sxs-lookup"><span data-stu-id="f5ba3-208">See Also</span></span>  
 <span data-ttu-id="f5ba3-209">[Репликация SQL Server](../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="f5ba3-209">[SQL Server Replication](../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="f5ba3-210">[Сведения о доставке журналов (SQL Server)](about-log-shipping-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="f5ba3-210">[About Log Shipping &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span></span>  
 [<span data-ttu-id="f5ba3-211">Зеркальное отображение и репликация баз данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f5ba3-211">Database Mirroring and Replication &#40;SQL Server&#41;</span></span>](../database-mirroring/database-mirroring-and-replication-sql-server.md)  
  
  
