---
title: Наблюдение за доставкой журналов (Transact-SQL) | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], status
- history tables [SQL Server]
- historical information [SQL Server], log shipping
- log shipping [SQL Server], monitoring
- alerts [SQL Server], log shipping
- status information [SQL Server], log shipping
- monitoring log shipping [SQL Server]
ms.assetid: acf3cd99-55f7-4287-8414-0892f830f423
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0ab87d5d8aa08b7b2860fe52fd097f33af327a94
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87657248"
---
# <a name="monitor-log-shipping-transact-sql"></a><span data-ttu-id="cc97a-102">Наблюдение за доставкой журналов (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="cc97a-102">Monitor Log Shipping (Transact-SQL)</span></span>
  <span data-ttu-id="cc97a-103">После того, как была настроена доставка журналов, можно отслеживать данные о состоянии всех серверов доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-103">After you have configured log shipping, you can monitor information about the status of all the log shipping servers.</span></span> <span data-ttu-id="cc97a-104">Журнал и состояние операций доставки журналов всегда сохраняются локально заданиями доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-104">The history and status of log shipping operations are always saved locally by the log shipping jobs.</span></span> <span data-ttu-id="cc97a-105">Журнал и состояние операций резервного копирования сохраняются на сервере-источнике, а журнал и состояние операций копирования и восстановления сохраняются на сервере-получателе.</span><span class="sxs-lookup"><span data-stu-id="cc97a-105">The history and status of the backup operation are stored at the primary server, and the history and status of the copy and restore operations are stored at the secondary server.</span></span> <span data-ttu-id="cc97a-106">Если был реализован удаленный сервер мониторинга, эти данные также сохраняются и на нем.</span><span class="sxs-lookup"><span data-stu-id="cc97a-106">If you have implemented a remote monitor server, this information is also stored on the monitor server.</span></span>  
  
 <span data-ttu-id="cc97a-107">Можно настраивать предупреждения, которые работают в случае сбоев при выполнении операций доставки журналов по расписанию.</span><span class="sxs-lookup"><span data-stu-id="cc97a-107">You can configure alerts that will fire if log shipping operations fail to occur as scheduled.</span></span> <span data-ttu-id="cc97a-108">Сообщения об ошибке создаются заданием предупреждения, отслеживающим состояние операций резервного копирования и восстановления.</span><span class="sxs-lookup"><span data-stu-id="cc97a-108">Errors are raised by an alert job that watches the status of the backup and restore operations.</span></span> <span data-ttu-id="cc97a-109">Можно определить предупреждения, которые отправят сообщение оператору при возникновении таких ошибок.</span><span class="sxs-lookup"><span data-stu-id="cc97a-109">You can define alerts that notify an operator when these errors are raised.</span></span> <span data-ttu-id="cc97a-110">Если сервер мониторинга настроен, то одно задание предупреждения выполняется на нем и отвечает за сообщения об ошибках для всех операций данной конфигурации доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-110">If a monitor server is configured, one alert job runs on the monitor server that raises errors for all operations in the log shipping configuration.</span></span> <span data-ttu-id="cc97a-111">Если сервер мониторинга не указан, задание предупреждения выполняется на экземпляре сервера-источника, который отслеживает операции резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="cc97a-111">If a monitor server is not specified, an alert job runs on the primary server instance, which monitors the backup operation.</span></span> <span data-ttu-id="cc97a-112">Если сервер мониторинга не указан, задание предупреждения также выполняется на каждом экземпляре сервера-получателя, где отслеживает локальные операции копирования и восстановления.</span><span class="sxs-lookup"><span data-stu-id="cc97a-112">If a monitor server is not specified, an alert job also runs on each secondary server instance to monitor the local copy and restore operations.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="cc97a-113">Чтобы отслеживать конфигурацию доставки журналов, во время включения доставки журналов необходимо добавить сервер мониторинга.</span><span class="sxs-lookup"><span data-stu-id="cc97a-113">To monitor a log shipping configuration, you must add the monitor server when you enable log shipping.</span></span> <span data-ttu-id="cc97a-114">Если добавлять сервер мониторинга позже, то придется удалить существующую конфигурацию доставки журналов и заменить ее новой с сервером мониторинга.</span><span class="sxs-lookup"><span data-stu-id="cc97a-114">If you add a monitor server later, you must remove the log shipping configuration and then replace it with a new configuration that includes a monitor server.</span></span> <span data-ttu-id="cc97a-115">Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="cc97a-115">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span> <span data-ttu-id="cc97a-116">Кроме того, заданную конфигурацию сервера мониторинга невозможно изменить, не удалив прежде конфигурацию доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-116">Furthermore, after the monitor server has been configured, it cannot be changed without removing log shipping first.</span></span>  
  
## <a name="history-tables-containing-monitoring-information"></a><span data-ttu-id="cc97a-117">Таблицы журналов, содержащие данные мониторинга</span><span class="sxs-lookup"><span data-stu-id="cc97a-117">History Tables Containing Monitoring Information</span></span>  
 <span data-ttu-id="cc97a-118">Таблицы журналов мониторинга содержат метаданные, хранящиеся на сервере мониторинга.</span><span class="sxs-lookup"><span data-stu-id="cc97a-118">The monitoring history tables contain metadata that is stored on the monitor server.</span></span> <span data-ttu-id="cc97a-119">Копия данных, относящихся именно к данному серверу-источнику или серверу-получателю, также хранится локально.</span><span class="sxs-lookup"><span data-stu-id="cc97a-119">A copy of information specific to a given primary or secondary server is also stored locally.</span></span>  
  
 <span data-ttu-id="cc97a-120">Эти таблицы можно опрашивать, чтобы следить за состоянием сеанса доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-120">You can query these tables to monitor the status of a log shipping session.</span></span> <span data-ttu-id="cc97a-121">Например, чтобы узнать состояние доставки журналов, можно проверить состояние и историю заданий резервного копирования, копирования и восстановления.</span><span class="sxs-lookup"><span data-stu-id="cc97a-121">For example, to learn status of log shipping, check the status and history of the backup job, copy job, and restore job.</span></span> <span data-ttu-id="cc97a-122">Можно просматривать отдельные журналы доставки и подробные сведения об ошибках, выполняя запросы к описанным ниже таблицам мониторинга.</span><span class="sxs-lookup"><span data-stu-id="cc97a-122">You can view specific log shipping history and error details by querying the following monitoring tables.</span></span>  
  
|<span data-ttu-id="cc97a-123">Таблица</span><span class="sxs-lookup"><span data-stu-id="cc97a-123">Table</span></span>|<span data-ttu-id="cc97a-124">Описание</span><span class="sxs-lookup"><span data-stu-id="cc97a-124">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="cc97a-125">log_shipping_monitor_alert</span><span class="sxs-lookup"><span data-stu-id="cc97a-125">log_shipping_monitor_alert</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-alert-transact-sql)|<span data-ttu-id="cc97a-126">Содержит идентификатор задания предупреждения.</span><span class="sxs-lookup"><span data-stu-id="cc97a-126">Stores alert job ID.</span></span>|  
|[<span data-ttu-id="cc97a-127">log_shipping_monitor_error_detail</span><span class="sxs-lookup"><span data-stu-id="cc97a-127">log_shipping_monitor_error_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-error-detail-transact-sql)|<span data-ttu-id="cc97a-128">Содержит подробное описание ошибок заданий доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-128">Stores error details for log shipping jobs.</span></span> <span data-ttu-id="cc97a-129">Выполняя запросы к этой таблице, можно получать сведения об ошибках в сеансах агентов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-129">You can query this table see the errors for an agent session.</span></span> <span data-ttu-id="cc97a-130">При необходимости можно выполнить сортировку ошибок по дате и времени их внесения в журнал.</span><span class="sxs-lookup"><span data-stu-id="cc97a-130">Optionally, you can sort the errors by the date and time at which each was logged.</span></span> <span data-ttu-id="cc97a-131">Каждая ошибка записывается в журнал как последовательность исключений, и на один сеанс агента может приходиться несколько ошибок (последовательностей).</span><span class="sxs-lookup"><span data-stu-id="cc97a-131">Each error is logged as a sequence of exceptions, and multiple errors (sequences) can per agent session.</span></span>|  
|[<span data-ttu-id="cc97a-132">log_shipping_monitor_history_detail</span><span class="sxs-lookup"><span data-stu-id="cc97a-132">log_shipping_monitor_history_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-history-detail-transact-sql)|<span data-ttu-id="cc97a-133">Содержит подробные журналы агентов доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-133">Contains history details for log shipping agents.</span></span> <span data-ttu-id="cc97a-134">Выполнив запросы к этой таблице, можно получить подробные сведения о предыдущих сеансах агентов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-134">You can query this table to see the history detail for an agent session.</span></span>|  
|[<span data-ttu-id="cc97a-135">log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="cc97a-135">log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="cc97a-136">Содержит одну запись монитора для базы данных-источника в каждой из конфигураций доставки журналов, включая данные о последнем файле резервной копии и о последнем восстановленном файле, которые полезны для мониторинга.</span><span class="sxs-lookup"><span data-stu-id="cc97a-136">Stores one monitor record for the primary database in each log shipping configuration, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
|[<span data-ttu-id="cc97a-137">log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="cc97a-137">log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="cc97a-138">Содержит одну запись монитора для каждой базы данных-получателя, включающую данные о последнем файле резервной копии и последнем восстановленном файле, которые полезны для мониторинга.</span><span class="sxs-lookup"><span data-stu-id="cc97a-138">Stores one monitor record for each secondary database, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
  
## <a name="stored-procedures-for-monitoring-log-shipping"></a><span data-ttu-id="cc97a-139">Хранимые процедуры для мониторинга доставки журналов</span><span class="sxs-lookup"><span data-stu-id="cc97a-139">Stored Procedures for Monitoring Log Shipping</span></span>  
 <span data-ttu-id="cc97a-140">Сведения мониторинга и данные журналов хранятся в таблицах в базе данных **msdb**, к которым можно получить доступ посредством использования хранимых процедур доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="cc97a-140">Monitoring and history information is stored in tables in **msdb**, which can be accessed using log shipping stored procedures.</span></span> <span data-ttu-id="cc97a-141">Выполняйте эти хранимые процедуры на указанных в следующей таблице серверах.</span><span class="sxs-lookup"><span data-stu-id="cc97a-141">Run these stored procedures on the servers indicated in the following table.</span></span>  
  
|<span data-ttu-id="cc97a-142">Хранимая процедура</span><span class="sxs-lookup"><span data-stu-id="cc97a-142">Stored procedure</span></span>|<span data-ttu-id="cc97a-143">Описание</span><span class="sxs-lookup"><span data-stu-id="cc97a-143">Description</span></span>|<span data-ttu-id="cc97a-144">Место выполнения процедуры</span><span class="sxs-lookup"><span data-stu-id="cc97a-144">Run this procedure on</span></span>|  
|----------------------|-----------------|---------------------------|  
|[<span data-ttu-id="cc97a-145">sp_help_log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="cc97a-145">sp_help_log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="cc97a-146">Возвращает записи монитора для указанной базы данных-источника из таблицы **log_shipping_monitor_primary** .</span><span class="sxs-lookup"><span data-stu-id="cc97a-146">Returns monitor records for the specified primary database from the **log_shipping_monitor_primary** table.</span></span>|<span data-ttu-id="cc97a-147">Сервер мониторинга или сервер-источник</span><span class="sxs-lookup"><span data-stu-id="cc97a-147">Monitor server or primary server</span></span>|  
|[<span data-ttu-id="cc97a-148">sp_help_log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="cc97a-148">sp_help_log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="cc97a-149">Возвращает записи монитора для указанной базы данных-получателя из таблицы **log_shipping_monitor_secondary** .</span><span class="sxs-lookup"><span data-stu-id="cc97a-149">Returns monitor records for the specified secondary database from the **log_shipping_monitor_secondary** table.</span></span>|<span data-ttu-id="cc97a-150">Сервер мониторинга или сервер-получатель</span><span class="sxs-lookup"><span data-stu-id="cc97a-150">Monitor server or secondary server</span></span>|  
|[<span data-ttu-id="cc97a-151">sp_help_log_shipping_alert_job</span><span class="sxs-lookup"><span data-stu-id="cc97a-151">sp_help_log_shipping_alert_job</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-alert-job-transact-sql)|<span data-ttu-id="cc97a-152">Возвращает идентификатор задания предупреждения.</span><span class="sxs-lookup"><span data-stu-id="cc97a-152">Returns the job ID of the alert job.</span></span>|<span data-ttu-id="cc97a-153">Сервер мониторинга, сервер-источник или сервер-получатель, если сервер мониторинга не определен.</span><span class="sxs-lookup"><span data-stu-id="cc97a-153">Monitor server, or primary or secondary server if no monitor is defined</span></span>|  
|[<span data-ttu-id="cc97a-154">sp_help_log_shipping_primary_database, хранимая процедура</span><span class="sxs-lookup"><span data-stu-id="cc97a-154">sp_help_log_shipping_primary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-database-transact-sql)|<span data-ttu-id="cc97a-155">Получает настройки базы данных-источника и отображает значения из таблиц **log_shipping_primary_databases** и **log_shipping_monitor_primary** .</span><span class="sxs-lookup"><span data-stu-id="cc97a-155">Retrieves primary database settings and displays the values from the **log_shipping_primary_databases** and **log_shipping_monitor_primary** tables.</span></span>|<span data-ttu-id="cc97a-156">Сервер-источник</span><span class="sxs-lookup"><span data-stu-id="cc97a-156">Primary server</span></span>|  
|[<span data-ttu-id="cc97a-157">sp_help_log_shipping_primary_secondary</span><span class="sxs-lookup"><span data-stu-id="cc97a-157">sp_help_log_shipping_primary_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-secondary-transact-sql)|<span data-ttu-id="cc97a-158">Получает имена баз данных-получателей для базы данных-источника.</span><span class="sxs-lookup"><span data-stu-id="cc97a-158">Retrieves secondary database names for a primary database.</span></span>|<span data-ttu-id="cc97a-159">Сервер-источник</span><span class="sxs-lookup"><span data-stu-id="cc97a-159">Primary server</span></span>|  
|[<span data-ttu-id="cc97a-160">sp_help_log_shipping_secondary_database, хранимая процедура</span><span class="sxs-lookup"><span data-stu-id="cc97a-160">sp_help_log_shipping_secondary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-database-transact-sql)|<span data-ttu-id="cc97a-161">Получает настройки базы данных-получателя из таблиц **log_shipping_secondary**, **log_shipping_secondary_databases** и **log_shipping_monitor_secondary** .</span><span class="sxs-lookup"><span data-stu-id="cc97a-161">Retrieves secondary-database settings from the **log_shipping_secondary**, **log_shipping_secondary_databases** and **log_shipping_monitor_secondary** tables.</span></span>|<span data-ttu-id="cc97a-162">Сервер-получатель</span><span class="sxs-lookup"><span data-stu-id="cc97a-162">Secondary server</span></span>|  
|[<span data-ttu-id="cc97a-163">sp_help_log_shipping_secondary_primary (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="cc97a-163">sp_help_log_shipping_secondary_primary &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-primary-transact-sql)|<span data-ttu-id="cc97a-164">Эта хранимая процедура получает настройки для данной базы данных-источника с сервера-получателя.</span><span class="sxs-lookup"><span data-stu-id="cc97a-164">This stored procedure retrieves the settings for a given primary database on the secondary server.</span></span>|<span data-ttu-id="cc97a-165">Сервер-получатель</span><span class="sxs-lookup"><span data-stu-id="cc97a-165">Secondary server</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="cc97a-166">См. также:</span><span class="sxs-lookup"><span data-stu-id="cc97a-166">See Also</span></span>  
 <span data-ttu-id="cc97a-167">[Просмотр отчета о доставке журналов (среда SQL Server Management Studio)](view-the-log-shipping-report-sql-server-management-studio.md) </span><span class="sxs-lookup"><span data-stu-id="cc97a-167">[View the Log Shipping Report &#40;SQL Server Management Studio&#41;](view-the-log-shipping-report-sql-server-management-studio.md) </span></span>  
 [<span data-ttu-id="cc97a-168">Хранимые процедуры и таблицы доставки журналов</span><span class="sxs-lookup"><span data-stu-id="cc97a-168">Log Shipping Stored Procedures and Tables</span></span>](log-shipping-tables-and-stored-procedures.md)  
  
  
