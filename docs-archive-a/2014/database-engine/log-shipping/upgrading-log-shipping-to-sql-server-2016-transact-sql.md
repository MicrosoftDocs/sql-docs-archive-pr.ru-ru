---
title: Обновление доставки журналов до SQL Server 2014 (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], upgrading
ms.assetid: b1289cc3-f5be-40bb-8801-0e3eed40336e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 80330d03853c984cfd26100b02918eb218705085
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87669046"
---
# <a name="upgrade-log-shipping-to-sql-server-2014-transact-sql"></a>Обновление доставки журналов до SQL Server 2014 (Transact-SQL)
  При обновлении с [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)]или [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] до [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]конфигурацию доставки журналов можно сохранить. В этом разделе описаны альтернативные сценарии и рекомендации по обновлению конфигурации доставки журналов.

> [!NOTE]
>  [Сжатие резервной копии](../../relational-databases/backup-restore/backup-compression-sql-server.md) было введено в выпуске [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)]. В обновленной конфигурации доставки журналов используется параметр **стандартного сжатия резервных копий** уровня сервера, который управляет применением сжатия резервной копии к файлам резервной копии журнала транзакций. Режим сжатия резервной копии журналов можно указать отдельно для каждой конфигурации доставки журналов. Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](configure-log-shipping-sql-server.md).


##  <a name="protect-your-data-before-the-upgrade"></a><a name="ProtectData"></a>Защита данных перед обновлением
 Рекомендуется защищать данные перед обновлением доставки журналов.

 **Защита данных**

1.  Создайте полную резервную копию каждой базы данных-источника.

     Дополнительные сведения см. в разделе [Создание полной резервной копии базы данных (SQL Server)](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).

2.  Выполните команду [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) в каждой базе данных-источнике.

##  <a name="upgrading-the-monitor-server-instance"></a><a name="UpgradeMonitor"></a>Обновление экземпляра сервера мониторинга
 Существующий экземпляр сервера мониторинга можно обновить в любой момент.

 При обновлении сервера мониторинга конфигурация доставки журналов продолжает работать, но ее состояние не записывается в таблицы мониторинга. В процессе обновления сервера мониторинга не будут срабатывать никакие настроенные предупреждения. После обновления можно обновить сведения в таблицах наблюдения. Для этого следует выполнить системную хранимую процедуру [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql).

##  <a name="upgrading-log-shipping-configurations-with-a-single-secondary-server"></a><a name="UpgradeSingleSecondary"></a>Обновление конфигураций доставки журналов с одним сервером-получателем
 Процесс обновления, описанный в этом разделе, предполагает работу с конфигурацией, которая состоит из сервера-источника и единственного сервера-получателя. Эта конфигурация показана на следующей иллюстрации, на которой изображен экземпляр сервера-источника (A) и экземпляр единственного сервера-получателя (Б).

 ![Один сервер-получатель, нет сервера мониторинга](../media/ls-2-wayconfig-nomonitor.gif "Один сервер-получатель, нет сервера мониторинга")

 Сведения об обновлении нескольких серверов-получателей см. в подразделе [Обновление нескольких экземпляров серверов-получателей](#MultipleSecondaries)далее в этом разделе.
 

###  <a name="upgrading-the-secondary-server-instance"></a><a name="UpgradeSecondary"></a>Обновление экземпляра сервера-получателя
 Перед обновлением экземпляра сервера-источника обновляется конфигурация доставки журналов экземпляров серверов-получателей с [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] более поздней версии до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] . Экземпляр сервера-получателя всегда следует обновлять первым. Если бы сервер-источник обновлялся до сервера-получателя, то доставка журналов стала бы невозможна, поскольку более старую версию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] нельзя восстановить из резервной копии, созданной в новой версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].

 Доставка журналов продолжается и во время обновления, поскольку обновленные серверы-получатели продолжают восстанавливать журналы из резервных копий с сервера-источника [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] или более поздней версии. Процесс обновления экземпляров сервера-получателя частично зависит от того, предусмотрено ли в конфигурации доставки журналов несколько серверов-получателей. Дополнительные сведения см. в подразделе [Обновление нескольких экземпляров серверов-получателей](#MultipleSecondaries)далее в этом разделе.

 Пока идет обновление экземпляра сервера-получателя, копия доставки журналов и задания восстановления не выполняются, вследствие чего накапливаются невосстановленные резервные копии журналов транзакций. Количество этих копий зависит от частоты запланированного резервного копирования на сервере-источнике. Кроме того, если настроен отдельный сервер мониторинга, то могут возникать предупреждения о том, что восстановление не выполнялось дольше установленного интервала.

 После завершения обновления сервера-получателя выполнение заданий агента доставки журналов возобновляется и производится копирование и восстановление резервных копий журналов из экземпляра сервера-источника, сервера А. Количество времени, которое необходимо серверу-получателю для обновления базы данных получателя, зависит от того, сколько времени уходит на обновление сервера-источника и частоты создания резервных копий на сервере-источнике.

> [!NOTE]
>  В процессе обновления сервера база данных-получатель не обновляется до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] . Ее обновление происходит только при переключении в режим «в сети».

> [!IMPORTANT]
>  Параметр RESTORE WITH STANDBY не поддерживается для базы данных, требующей обновления. Если обновленная база данных-получатель была настроена при помощи RESTORE WITH STANDBY, то журналы транзакций нельзя восстановить после обновления. Чтобы возобновить доставку журналов на базу данных-получатель, необходимо заново настроить доставку журналов на резервном сервере. Дополнительные сведения о параметре STANDBY см. в разделе [аргументы восстановления &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).

###  <a name="upgrading-the-primary-server-instance"></a><a name="UpgradePrimary"></a> Обновление экземпляра сервера-источника
 При планировании обновления большое значение имеет время, в течение которого база данных будет недоступна. В простейшем сценарии обновления база данных недоступна, пока обновляется сервер-источник (приведенный ниже сценарий 1).

 Добиться максимальной доступности базы данных можно за счет усложнения процесса обновления. Для этого перед обновлением исходного сервера-источника нужно выполнить переход с сервера-источника [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] или более поздней версии на сервер-получатель [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] (приведенный ниже сценарий 2). Существует два возможных сценария отработки отказа. Можно переключиться назад на исходный сервер-источник и сохранить первоначальную конфигурацию доставки журналов. В качестве альтернативного варианта можно удалить исходную конфигурацию доставки журналов до обновления исходного сервера-источника и позднее создать новую конфигурацию с помощью нового сервера-источника. В этом разделе описываются оба сценария.

> [!IMPORTANT]
>  Экземпляр сервера-получателя следует обновлять обязательно до экземпляра сервера-источника. Дополнительные сведения см. в подразделе [Обновление экземпляра сервера-получателя](#UpgradeSecondary)ранее в этом разделе.


####  <a name="scenario-1-upgrade-primary-server-instance-without-failover"></a><a name="Scenario1"></a>Сценарий 1. Обновление экземпляра сервера источника без отработки отказа
 Этот сценарий проще, но он приводит к большему времени простоя, чем при использовании отработки отказа. Экземпляр сервера-источника просто обновляется, и в течение этого времени база данных недоступна.

 Как только обновление сервера завершается, база данных автоматически переводится обратно в режим «в сети», в результате чего обновляется сама. После обновления базы данных возобновляют работу задания доставки журналов.

#### <a name="scenario-2-upgrade-primary-server-instance-with-failover"></a>Сценарий 2. Обновление экземпляра сервера-источника с отработкой отказа
 Этот сценарий сокращает до минимума время простоя и обеспечивает максимальную доступность базы данных. В данном сценарии выполняется управляемая отработка отказа на экземпляр сервера-получателя, в результате чего база данных остается доступной, пока обновляется исходный экземпляр сервера-источника. Период простоя ограничивается временем, которое требуется для перехода на другой ресурс, оно относительно невелико по сравнению с временем обновления экземпляра сервера-источника.

 При обновлении экземпляра сервера-источника с отработкой отказа выполняются три основные процедуры: управляемая отработка отказа на сервер-получатель, обновление исходного экземпляра сервера-источника до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]и настройка доставки журналов на экземпляре сервера-источника [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] . Данные процедуры описаны в этом разделе.

> [!IMPORTANT]
>  Если в качестве нового экземпляра сервера-источника планируется использовать экземпляр сервера-получателя, то конфигурацию доставки журналов придется удалить. Доставку журналов нужно будет настроить повторно на новом сервере-источнике и новом сервере-получателе после того, как будет обновлен исходный экземпляр сервера-источника. Дополнительные сведения см. в разделе [Удаление доставки журналов &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).


#####  <a name="procedure-1-perform-a-controlled-failover-to-the-secondary-server"></a><a name="Procedure1"></a>Процедура 1. управляемая отработка отказа на сервер-получатель
 Управляемая отработка отказа на сервер-получатель.

1.  Вручную выполните [резервное копирование заключительного фрагмента](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) журнала транзакций в базе данных-источнике, УКАЗАВ параметр WITH NORECOVERY. В эту резервную копию журналов попадут все записи, резервная копия которых еще не была создана, и база данных будет отключена. Обратите внимание, что пока база данных находится в режиме «вне сети», задание резервного копирования в доставке журналов будет завершаться с ошибкой.

     В приведенном ниже примере создается резервная копия заключительного фрагмента журнала базы данных `AdventureWorks` на сервере-источнике. Файлу резервной копии присваивается имя `Failover_AW_20080315.trn`:

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Failover_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

     Рекомендуется использовать различные соглашения об именах файлов, чтобы можно было отличить файлы резервных копий, созданные вручную, от файлов резервных копий, созданных заданием резервного копирования в доставке журналов.

2.  На сервере-получателе сделайте следующее.

    1.  Убедитесь, что применены все резервные копии, созданные автоматически заданиями резервного копирования в доставке журналов. Чтобы проверить, какие задания резервного копирования были применены, используйте системную хранимую процедуру [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) на сервере мониторинга или на основном и на вторичном серверах. Один и тот же файл должен быть указан в столбцах **last_backup_file**, **last_copied_file**и **last_restored_file** . Если какой-то из файлов резервной копии не был скопирован или из него не было выполнено восстановление, вручную вызовите задания копирования и восстановления агента для конфигурации доставки журналов.

         Дополнительные сведения о запуске задания см. в разделе [Start a Job](../../ssms/agent/start-a-job.md).

    2.  Скопируйте заключительный файл резервной копии журнала, созданный в шаге 1, из общей папки в локальное расположение, которое используется для доставки журналов на сервере-получателе.

    3.  Восстановите заключительную резервную копию журнала, указав предложение WITH RECOVERY, чтобы перевести базу данных в режим «в сети». При переходе в режим «в сети» база данных будет обновлена до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].

         В приведенном ниже примере выполняется восстановление из резервной копии заключительного фрагмента журнала базы данных `AdventureWorks` в базе данных-получателе. В примере используется параметр WITH RECOVERY, который переводит базу данных в режим «в сети»:

        ```
        RESTORE LOG AdventureWorks 
          FROM DISK = N'c:\logshipping\Failover_AW_20080315.trn' 
           WITH RECOVERY;
        GO
        ```

        > [!NOTE]
        >  Для конфигурации, в которой несколько серверов-получателей, предусмотрены дополнительные действия. Дополнительные сведения см. в подразделе [Обновление нескольких экземпляров серверов-получателей](#MultipleSecondaries)далее в этом разделе.

    4.  Перевод базы данных на другой ресурс путем перенаправления клиентов с исходного сервера-источника (сервера A) на подключенный сервер-получатель (сервер B).

    5.  Убедитесь, чтобы журнал транзакций базы данных-получателя не заполнялся, когда база данных находится в режиме «в сети». Чтобы предотвратить заполнение журнала транзакций, можно создать его резервную копию. То есть рекомендуется сохранить его резервную копию в общем расположении, *общей папке резервных копий*, чтобы резервные копии были доступны для восстановления из копии на другом экземпляре сервера.

#####  <a name="procedure-2-upgrade-the-original-primary-server-instance-to-sscurrent"></a><a name="Procedure2"></a>Процедура 2. обновление исходного экземпляра сервера источника до[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]
 После обновления экземпляра исходного экземпляра сервера-источника до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]база данных по-прежнему будет в режиме «вне сети» и в формате предыдущей версии.

#####  <a name="procedure-3-set-up-log-shipping-on-sscurrent"></a><a name="Procedure3"></a>Процедура 3. Настройка доставки журналов в[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]
 Оставшаяся часть процедуры обновления зависит от того, настроена ли доставка журналов.

-   Если конфигурация доставки журналов [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]или более поздней версии была сохранена, переключитесь обратно на экземпляр исходного сервера-источника. Дополнительные сведения см. в подразделе [Переключение обратно на экземпляр исходного сервера-источника](#SwitchToOrigPrimary)далее в этом разделе.

-   Если конфигурация доставки журналов была удалена до перехода на другой ресурс, создайте новую конфигурацию, в которой экземпляр исходного сервера-получателя будет новым экземпляром нового сервера-источника. Дополнительные сведения см. в подразделе [Сохранение экземпляра прежнего сервера-получателя в качестве экземпляра нового сервера-источника](#KeepOldSecondaryAsNewPrimary)далее в этом разделе.

######  <a name="to-switch-back-to-the-original-primary-server-instance"></a><a name="SwitchToOrigPrimary"></a>Переключение обратно на исходный экземпляр сервера источника

1.  На промежуточном сервере-источнике (сервер B) создайте резервную копию заключительного фрагмента журнала с помощью параметра WITH NORECOVERY — будет создана резервная копия заключительного фрагмента журнала, а база данных перейдет в режим «вне сети». Резервная копия заключительного фрагмента журнала имеет имя `Switchback_AW_20080315.trn`. Например:

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Switchback_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

2.  Если в промежуточной базе данных-источнике создавались резервные копии журналов транзакций, отличные от резервной копии заключительного фрагмента журнала, созданной в шаге 1, выполните восстановление из этих копий с помощью параметра WITH NORECOVERY для базы данных в режиме «вне сети» на исходном сервере-источнике (сервер A). База данных будет обновлена до формата [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] при восстановлении из первой же резервной копии журналов.

3.  Выполните восстановление из резервной копии заключительного фрагмента журнала (`Switchback_AW_20080315.trn`) в исходной базе данных-источнике (на сервере A) с помощью параметра WITH RECOVERY, чтобы перевести базу данных в режим в сети.

4.  Перейдите обратно к исходной базе данных-источнику (на сервере A) путем перенаправления клиентов с исходного сервера-источника на работающий в режиме «в сети» сервер-получатель.

 После переключения базы данных в режим «в сети» снова будет использоваться исходная конфигурация доставки журналов.

######  <a name="to-keep-the-old-secondary-server-instance-as-the-new-primary-server-instance"></a><a name="KeepOldSecondaryAsNewPrimary"></a>Обеспечение сохранения старого экземпляра сервера-получателя в качестве нового экземпляра сервера-источника
 Создайте новую конфигурацию доставки журналов, используя экземпляр прежнего сервера-получателя, сервера B, в качестве нового сервера-источника и прежнего экземпляра сервера-источника, сервера A, в качестве нового сервера-получателя.

> [!IMPORTANT]
>  Прежняя конфигурация доставки журналов должна быть уже удалена с исходного сервера-источника в начале процедуры перед ручным созданием резервной копии журнала транзакций, в результате чего база данных была переведена в режим «вне сети».

1.  Чтобы не выполнять полное резервное копирование и восстановление базы данных на новом сервере-получателе (сервере A), примените резервные копии журналов из новой базы данных-источника к новой базе данных-получателю. В примере конфигурации выполняется восстановление из резервных копий журналов, созданных на сервере B, в базе данных на сервере A.

2.  Создание резервной копии журналов в новой базе данных-источнике (на сервере B).

3.  Восстановление из резервных копий журналов на экземпляре нового сервера-получателя (сервере A) с помощью параметра WITH NORECOVERY. В процессе первой же операции восстановления база данных обновляется до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].

4.  Настройте доставку журналов с прежним сервером-получателем (сервером B) в качестве экземпляра сервера-источника.

    > [!IMPORTANT]
    >  При работе в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] следует указать, что база данных-получатель уже инициализирована.

     Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](configure-log-shipping-sql-server.md).

5.  Перевод базы данных на другой ресурс путем перенаправления клиентов с исходного сервера-источника (сервера A) на подключенный сервер-получатель (сервер B).

    > [!IMPORTANT]
    >  При отработке отказа с переходом на новую базу данных-источник следует убедиться, что ее метаданные согласованы с метаданными исходной базы данных-источника. Дополнительные сведения см. в статье [Управление метаданными при обеспечении доступности базы данных на другом экземпляре сервера (SQL Server)](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).

##  <a name="upgrading-multiple-secondary-server-instances"></a><a name="MultipleSecondaries"></a>Обновление нескольких экземпляров сервера-получателя
 Эта конфигурация показана на следующей иллюстрации, на которой изображен экземпляр сервера-источника (A) и два экземпляра сервера-получателя (B и C).

 ![Два сервера-получателя, нет сервера мониторинга](../media/ls-3-wayconfig-nomonitor.gif "Два сервера-получателя, нет сервера мониторинга")

 В этом разделе описывается выполнения обновления с помощью отработки отказа на сервер-получатель и обратного переключения на исходный сервер-источник. Обновление экземпляра сервера-источника с отработкой отказа усложняется, если существует несколько экземпляров сервера-получателя. В следующей процедуре после обновления всех серверов-получателей сервер-источник переводится на другой ресурс — одну из обновленных баз данных-получателей. Исходный сервер-источник обновляется, и доставка журналов переключается обратно на него.

> [!IMPORTANT]
>  Экземпляры сервера-получателя всегда следует обновлять раньше, чем сервер-источник.

 **Обновление с помощью отработки отказа на сервер-получатель и обратного переключения на исходный сервер-источник**

1.  Обновите все экземпляры сервера-получателя (сервер B и сервер C).

2.  Получите заключительный фрагмент журнала транзакций базы данных-источника (на сервере A) и переведите базу данных в режим «вне сети» путем создания резервной копии журнала транзакций с помощью параметра WITH NORECOVERY.

3.  На сервере-получателе, на который планируется выполнять переход (сервер B), переведите базу данных-получатель в режим «в сети» путем восстановления из резервной копии журналов с помощью инструкции WITH RECOVERY.

4.  На каждом сервере-получателе (сервер C) следует перевести базу данных-получатель в режим «вне сети» путем восстановления из резервной копии журналов с помощью предложения WITH NORECOVERY.

    > [!NOTE]
    >  Задания копирования и восстановления доставки журналов будут запускаться на серверах-получателях, но они не будут выполнять никаких действий, поскольку новые файлы резервной копии журналов не будут помещены в общую папку резервных копий.

5.  Перевод базы данных на другой ресурс путем перенаправления клиентов с исходного сервера-источника (сервера A) на подключенный сервер-получатель (сервер B). База данных в режиме «в сети» становится промежуточным сервером-источником, благодаря которому база остается доступной, пока исходный сервер-источник (сервер A) находится в режиме «вне сети».

6.  Обновите исходный сервер-источник (сервер A).

7.  В базе данных, для которой выполнена отработка отказа — промежуточная база данных-источник (на сервере B), вручную создайте резервную копию журнала транзакций с параметром WITH NORECOVERY. При этом база данных перейдет в режим «вне сети».

8.  Выполните восстановление из всех резервных копий журналов транзакций, созданных в промежуточной базе данных-источнике (на сервере B) для всех прочих баз данных-получателей (на сервере C) с помощью параметра WITH NORECOVERY. Это позволяет продолжить доставку журналов из исходной базы данных-источника после ее обновления без необходимости выполнять полное восстановление в каждой базе данных-получателе.

9. Восстановите журнал транзакций с промежуточного сервера-источника (сервера B) на исходной базе данных-источнике (на сервере A) с помощью параметра WITH RECOVERY.

##  <a name="redeploying-log-shipping"></a><a name="Redeploying"></a>Повторное развертывание доставки журналов
 Если не нужно выполнять миграцию конфигурации доставки журналов с помощью одной из вышеуказанных процедур, можно повторно развернуть доставку журналов с нуля, выполнив повторную инициализацию базы данных-получателя с полной резервной копией, и восстановить базу данных-источник. Это может быть наиболее предпочтительным режимом, если имеется небольшая база данных или если высокий уровень доступности не является требованием к процедуре обновления.

 Сведения о включении доставки журналов см. в разделе [Настройка доставки журналов &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).

## <a name="see-also"></a>См. также:
 [Резервные копии журналов транзакций &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [применение резервных копий журналов транзакций &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [таблиц доставки журналов и хранимых процедур](log-shipping-tables-and-stored-procedures.md)
