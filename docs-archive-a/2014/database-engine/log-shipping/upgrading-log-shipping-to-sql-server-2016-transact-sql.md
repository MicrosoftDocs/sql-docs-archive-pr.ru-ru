---
title: Обновление доставки журналов до SQL Server 2014 (Transact-SQL) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], upgrading
ms.assetid: b1289cc3-f5be-40bb-8801-0e3eed40336e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 80330d03853c984cfd26100b02918eb218705085
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87669046"
---
# <a name="upgrade-log-shipping-to-sql-server-2014-transact-sql"></a><span data-ttu-id="936cf-102">Обновление доставки журналов до SQL Server 2014 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="936cf-102">Upgrade Log Shipping to SQL Server 2014 (Transact-SQL)</span></span>
  <span data-ttu-id="936cf-103">При обновлении с [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)]или [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] до [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]конфигурацию доставки журналов можно сохранить.</span><span class="sxs-lookup"><span data-stu-id="936cf-103">It is possible to preserve log shipping configurations when upgrading from [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)], or [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="936cf-104">В этом разделе описаны альтернативные сценарии и рекомендации по обновлению конфигурации доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-104">This topic describes alternative scenarios and best practices for upgrading a log shipping configuration.</span></span>

> [!NOTE]
>  <span data-ttu-id="936cf-105">[Сжатие резервной копии](../../relational-databases/backup-restore/backup-compression-sql-server.md) было введено в выпуске [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span><span class="sxs-lookup"><span data-stu-id="936cf-105">[Backup compression](../../relational-databases/backup-restore/backup-compression-sql-server.md) was introduced in [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span></span> <span data-ttu-id="936cf-106">В обновленной конфигурации доставки журналов используется параметр **стандартного сжатия резервных копий** уровня сервера, который управляет применением сжатия резервной копии к файлам резервной копии журнала транзакций.</span><span class="sxs-lookup"><span data-stu-id="936cf-106">An upgraded log shipping configuration uses the **backup compression default** server-level configuration option to control whether backup compression is used for the transaction log backup files.</span></span> <span data-ttu-id="936cf-107">Режим сжатия резервной копии журналов можно указать отдельно для каждой конфигурации доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-107">The backup compression behavior of log backups can be specified for each log shipping configuration.</span></span> <span data-ttu-id="936cf-108">Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="936cf-108">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>


##  <a name="protect-your-data-before-the-upgrade"></a><a name="ProtectData"></a><span data-ttu-id="936cf-109">Защита данных перед обновлением</span><span class="sxs-lookup"><span data-stu-id="936cf-109">Protect Your Data Before the Upgrade</span></span>
 <span data-ttu-id="936cf-110">Рекомендуется защищать данные перед обновлением доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-110">As a best practice, we recommend that you protect your data before a log shipping upgrade.</span></span>

 <span data-ttu-id="936cf-111">**Защита данных**</span><span class="sxs-lookup"><span data-stu-id="936cf-111">**To protect your data**</span></span>

1.  <span data-ttu-id="936cf-112">Создайте полную резервную копию каждой базы данных-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-112">Perform a full database backup on every primary database.</span></span>

     <span data-ttu-id="936cf-113">Дополнительные сведения см. в разделе [Создание полной резервной копии базы данных (SQL Server)](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="936cf-113">For more information, see [Create a Full Database Backup &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span></span>

2.  <span data-ttu-id="936cf-114">Выполните команду [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) в каждой базе данных-источнике.</span><span class="sxs-lookup"><span data-stu-id="936cf-114">Run the [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) command on every primary database.</span></span>

##  <a name="upgrading-the-monitor-server-instance"></a><a name="UpgradeMonitor"></a><span data-ttu-id="936cf-115">Обновление экземпляра сервера мониторинга</span><span class="sxs-lookup"><span data-stu-id="936cf-115">Upgrading the Monitor Server Instance</span></span>
 <span data-ttu-id="936cf-116">Существующий экземпляр сервера мониторинга можно обновить в любой момент.</span><span class="sxs-lookup"><span data-stu-id="936cf-116">The monitor server instance, if any, can be upgraded at any time.</span></span>

 <span data-ttu-id="936cf-117">При обновлении сервера мониторинга конфигурация доставки журналов продолжает работать, но ее состояние не записывается в таблицы мониторинга.</span><span class="sxs-lookup"><span data-stu-id="936cf-117">While the monitor server is being upgraded, the log shipping configuration continues to work, but its status is not recorded in the tables on the monitor.</span></span> <span data-ttu-id="936cf-118">В процессе обновления сервера мониторинга не будут срабатывать никакие настроенные предупреждения.</span><span class="sxs-lookup"><span data-stu-id="936cf-118">Any alerts that have been configured will not be triggered while the monitor server is being upgraded.</span></span> <span data-ttu-id="936cf-119">После обновления можно обновить сведения в таблицах наблюдения. Для этого следует выполнить системную хранимую процедуру [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="936cf-119">After the upgrade, you can update the information in the monitor tables by executing the [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) system stored procedure.</span></span>

##  <a name="upgrading-log-shipping-configurations-with-a-single-secondary-server"></a><a name="UpgradeSingleSecondary"></a><span data-ttu-id="936cf-120">Обновление конфигураций доставки журналов с одним сервером-получателем</span><span class="sxs-lookup"><span data-stu-id="936cf-120">Upgrading Log Shipping Configurations with a Single Secondary Server</span></span>
 <span data-ttu-id="936cf-121">Процесс обновления, описанный в этом разделе, предполагает работу с конфигурацией, которая состоит из сервера-источника и единственного сервера-получателя.</span><span class="sxs-lookup"><span data-stu-id="936cf-121">The upgrade process described in this section assumes a configuration consisting of the primary server and only one secondary server.</span></span> <span data-ttu-id="936cf-122">Эта конфигурация показана на следующей иллюстрации, на которой изображен экземпляр сервера-источника (A) и экземпляр единственного сервера-получателя (Б).</span><span class="sxs-lookup"><span data-stu-id="936cf-122">This configuration is represented in the following illustration, which shows a primary server instance, A, and a single secondary server instance, B.</span></span>

 <span data-ttu-id="936cf-123">![Один сервер-получатель, нет сервера мониторинга](../media/ls-2-wayconfig-nomonitor.gif "Один сервер-получатель, нет сервера мониторинга")</span><span class="sxs-lookup"><span data-stu-id="936cf-123">![One secondary server and no monitor server](../media/ls-2-wayconfig-nomonitor.gif "One secondary server and no monitor server")</span></span>

 <span data-ttu-id="936cf-124">Сведения об обновлении нескольких серверов-получателей см. в подразделе [Обновление нескольких экземпляров серверов-получателей](#MultipleSecondaries)далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="936cf-124">For information about upgrading multiple secondary servers, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>
 

###  <a name="upgrading-the-secondary-server-instance"></a><a name="UpgradeSecondary"></a><span data-ttu-id="936cf-125">Обновление экземпляра сервера-получателя</span><span class="sxs-lookup"><span data-stu-id="936cf-125">Upgrading the Secondary Server Instance</span></span>
 <span data-ttu-id="936cf-126">Перед обновлением экземпляра сервера-источника обновляется конфигурация доставки журналов экземпляров серверов-получателей с [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] более поздней версии до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="936cf-126">The upgrade process involves upgrading the secondary server instances of a [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher log shipping configuration to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] before upgrading the primary server instance.</span></span> <span data-ttu-id="936cf-127">Экземпляр сервера-получателя всегда следует обновлять первым.</span><span class="sxs-lookup"><span data-stu-id="936cf-127">Always upgrade the secondary server instance first.</span></span> <span data-ttu-id="936cf-128">Если бы сервер-источник обновлялся до сервера-получателя, то доставка журналов стала бы невозможна, поскольку более старую версию [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] нельзя восстановить из резервной копии, созданной в новой версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="936cf-128">If the primary server were upgraded before a secondary server, log shipping would fail because a backup created on a newer version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] cannot be restored on an older version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>

 <span data-ttu-id="936cf-129">Доставка журналов продолжается и во время обновления, поскольку обновленные серверы-получатели продолжают восстанавливать журналы из резервных копий с сервера-источника [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="936cf-129">Log shipping continues throughout the upgrade process because the upgraded secondary servers continue to restore the log backups from the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server.</span></span> <span data-ttu-id="936cf-130">Процесс обновления экземпляров сервера-получателя частично зависит от того, предусмотрено ли в конфигурации доставки журналов несколько серверов-получателей.</span><span class="sxs-lookup"><span data-stu-id="936cf-130">The process for upgrading the secondary server instances depends partly on whether the log shipping configuration possesses multiple secondary servers.</span></span> <span data-ttu-id="936cf-131">Дополнительные сведения см. в подразделе [Обновление нескольких экземпляров серверов-получателей](#MultipleSecondaries)далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="936cf-131">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

 <span data-ttu-id="936cf-132">Пока идет обновление экземпляра сервера-получателя, копия доставки журналов и задания восстановления не выполняются, вследствие чего накапливаются невосстановленные резервные копии журналов транзакций.</span><span class="sxs-lookup"><span data-stu-id="936cf-132">While the secondary server instance is being upgraded, the log shipping copy and restore jobs do not run, so unrestored transaction log backups will accumulate.</span></span> <span data-ttu-id="936cf-133">Количество этих копий зависит от частоты запланированного резервного копирования на сервере-источнике.</span><span class="sxs-lookup"><span data-stu-id="936cf-133">The amount of accumulation depends on the frequency of scheduled backup on the primary server.</span></span> <span data-ttu-id="936cf-134">Кроме того, если настроен отдельный сервер мониторинга, то могут возникать предупреждения о том, что восстановление не выполнялось дольше установленного интервала.</span><span class="sxs-lookup"><span data-stu-id="936cf-134">Also, if a separate monitor server has been configured, alerts might be raised indicating restores have not been performed for longer than the configured interval.</span></span>

 <span data-ttu-id="936cf-135">После завершения обновления сервера-получателя выполнение заданий агента доставки журналов возобновляется и производится копирование и восстановление резервных копий журналов из экземпляра сервера-источника, сервера А. Количество времени, которое необходимо серверу-получателю для обновления базы данных получателя, зависит от того, сколько времени уходит на обновление сервера-источника и частоты создания резервных копий на сервере-источнике.</span><span class="sxs-lookup"><span data-stu-id="936cf-135">Once the secondary server has been upgraded, the log shipping agents jobs resume and continue to copy and restore log backups from the primary server instance, server A. The amount of time required for the secondary server to bring the secondary database up to date varies, depending on the time taken to upgrade the secondary server and the frequency of the backups on the primary server.</span></span>

> [!NOTE]
>  <span data-ttu-id="936cf-136">В процессе обновления сервера база данных-получатель не обновляется до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="936cf-136">During the server upgrade, the secondary database is not upgraded to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database.</span></span> <span data-ttu-id="936cf-137">Ее обновление происходит только при переключении в режим «в сети».</span><span class="sxs-lookup"><span data-stu-id="936cf-137">It will get upgraded only if it is brought online.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="936cf-138">Параметр RESTORE WITH STANDBY не поддерживается для базы данных, требующей обновления.</span><span class="sxs-lookup"><span data-stu-id="936cf-138">The RESTORE WITH STANDBY option is not supported for a database that requires upgrading.</span></span> <span data-ttu-id="936cf-139">Если обновленная база данных-получатель была настроена при помощи RESTORE WITH STANDBY, то журналы транзакций нельзя восстановить после обновления.</span><span class="sxs-lookup"><span data-stu-id="936cf-139">If an upgraded secondary database has been configured by using RESTORE WITH STANDBY, transaction logs can no longer be restored after upgrade.</span></span> <span data-ttu-id="936cf-140">Чтобы возобновить доставку журналов на базу данных-получатель, необходимо заново настроить доставку журналов на резервном сервере.</span><span class="sxs-lookup"><span data-stu-id="936cf-140">To resume log shipping on that secondary database, you will need to set up log shipping again on that standby server.</span></span> <span data-ttu-id="936cf-141">Дополнительные сведения о параметре STANDBY см. в разделе [аргументы восстановления &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="936cf-141">For more information about the STANDBY option, see [RESTORE Arguments &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span></span>

###  <a name="upgrading-the-primary-server-instance"></a><a name="UpgradePrimary"></a> <span data-ttu-id="936cf-142">Обновление экземпляра сервера-источника</span><span class="sxs-lookup"><span data-stu-id="936cf-142">Upgrading the Primary Server Instance</span></span>
 <span data-ttu-id="936cf-143">При планировании обновления большое значение имеет время, в течение которого база данных будет недоступна.</span><span class="sxs-lookup"><span data-stu-id="936cf-143">When planning an upgrade, a significant consideration is the amount of time that your database will be unavailable.</span></span> <span data-ttu-id="936cf-144">В простейшем сценарии обновления база данных недоступна, пока обновляется сервер-источник (приведенный ниже сценарий 1).</span><span class="sxs-lookup"><span data-stu-id="936cf-144">The simplest upgrade scenario involves the database being unavailable while you upgrade the primary server (scenario 1, below).</span></span>

 <span data-ttu-id="936cf-145">Добиться максимальной доступности базы данных можно за счет усложнения процесса обновления. Для этого перед обновлением исходного сервера-источника нужно выполнить переход с сервера-источника [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] или более поздней версии на сервер-получатель [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] (приведенный ниже сценарий 2).</span><span class="sxs-lookup"><span data-stu-id="936cf-145">At the cost of a more complicated upgrade process, you can maximize your database availability by failing over the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] secondary server before upgrading the original primary server (scenario 2, below).</span></span> <span data-ttu-id="936cf-146">Существует два возможных сценария отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="936cf-146">There are two variants of the failover scenario.</span></span> <span data-ttu-id="936cf-147">Можно переключиться назад на исходный сервер-источник и сохранить первоначальную конфигурацию доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-147">You can switch back to the original primary server and keep the original log shipping configuration.</span></span> <span data-ttu-id="936cf-148">В качестве альтернативного варианта можно удалить исходную конфигурацию доставки журналов до обновления исходного сервера-источника и позднее создать новую конфигурацию с помощью нового сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-148">Alternatively, you can remove the original log shipping configuration before upgrading the original primary server and later create a new configuration using the new primary server.</span></span> <span data-ttu-id="936cf-149">В этом разделе описываются оба сценария.</span><span class="sxs-lookup"><span data-stu-id="936cf-149">This section describes both these scenarios.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="936cf-150">Экземпляр сервера-получателя следует обновлять обязательно до экземпляра сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-150">Be sure to upgrade the secondary server instance before upgrading the primary server instance.</span></span> <span data-ttu-id="936cf-151">Дополнительные сведения см. в подразделе [Обновление экземпляра сервера-получателя](#UpgradeSecondary)ранее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="936cf-151">For more information, see [Upgrading the Secondary Server Instance](#UpgradeSecondary), earlier in this topic.</span></span>


####  <a name="scenario-1-upgrade-primary-server-instance-without-failover"></a><a name="Scenario1"></a><span data-ttu-id="936cf-152">Сценарий 1. Обновление экземпляра сервера источника без отработки отказа</span><span class="sxs-lookup"><span data-stu-id="936cf-152">Scenario 1: Upgrade Primary Server Instance Without Failover</span></span>
 <span data-ttu-id="936cf-153">Этот сценарий проще, но он приводит к большему времени простоя, чем при использовании отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="936cf-153">This is the simpler scenario, but it causes more downtime than using failover.</span></span> <span data-ttu-id="936cf-154">Экземпляр сервера-источника просто обновляется, и в течение этого времени база данных недоступна.</span><span class="sxs-lookup"><span data-stu-id="936cf-154">The primary server instance is simply upgraded and the database is unavailable during this upgrade.</span></span>

 <span data-ttu-id="936cf-155">Как только обновление сервера завершается, база данных автоматически переводится обратно в режим «в сети», в результате чего обновляется сама.</span><span class="sxs-lookup"><span data-stu-id="936cf-155">Once the server is upgraded, the database is automatically brought back online, which causes it to be upgraded.</span></span> <span data-ttu-id="936cf-156">После обновления базы данных возобновляют работу задания доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-156">After the database is upgraded, the log shipping jobs resume.</span></span>

#### <a name="scenario-2-upgrade-primary-server-instance-with-failover"></a><span data-ttu-id="936cf-157">Сценарий 2. Обновление экземпляра сервера-источника с отработкой отказа</span><span class="sxs-lookup"><span data-stu-id="936cf-157">Scenario 2: Upgrade Primary Server Instance with Failover</span></span>
 <span data-ttu-id="936cf-158">Этот сценарий сокращает до минимума время простоя и обеспечивает максимальную доступность базы данных.</span><span class="sxs-lookup"><span data-stu-id="936cf-158">This scenario maximizes availability and minimizes downtime.</span></span> <span data-ttu-id="936cf-159">В данном сценарии выполняется управляемая отработка отказа на экземпляр сервера-получателя, в результате чего база данных остается доступной, пока обновляется исходный экземпляр сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-159">It utilizes a controlled failover to the secondary server instance, which keeps the database available while the original primary server instance is upgraded.</span></span> <span data-ttu-id="936cf-160">Период простоя ограничивается временем, которое требуется для перехода на другой ресурс, оно относительно невелико по сравнению с временем обновления экземпляра сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-160">Downtime is limited to the relatively short time required to fail over, rather than the time required to upgrade the primary server instance.</span></span>

 <span data-ttu-id="936cf-161">При обновлении экземпляра сервера-источника с отработкой отказа выполняются три основные процедуры: управляемая отработка отказа на сервер-получатель, обновление исходного экземпляра сервера-источника до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]и настройка доставки журналов на экземпляре сервера-источника [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="936cf-161">Upgrading the primary server instance with failover involves three general procedures: performing a controlled failover to the secondary server, upgrading the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], and setting up log shipping on a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] primary server instance.</span></span> <span data-ttu-id="936cf-162">Данные процедуры описаны в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="936cf-162">These procedures are described in this section.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="936cf-163">Если в качестве нового экземпляра сервера-источника планируется использовать экземпляр сервера-получателя, то конфигурацию доставки журналов придется удалить.</span><span class="sxs-lookup"><span data-stu-id="936cf-163">If you plan to have the secondary server instance as the new primary server instance, you need to remove the log shipping configuration.</span></span> <span data-ttu-id="936cf-164">Доставку журналов нужно будет настроить повторно на новом сервере-источнике и новом сервере-получателе после того, как будет обновлен исходный экземпляр сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-164">Log shipping will need to be reconfigured from the new primary to the new secondary, after the original primary server instance has been upgraded.</span></span> <span data-ttu-id="936cf-165">Дополнительные сведения см. в разделе [Удаление доставки журналов &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="936cf-165">For more information, see [Remove Log Shipping &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span></span>


#####  <a name="procedure-1-perform-a-controlled-failover-to-the-secondary-server"></a><a name="Procedure1"></a><span data-ttu-id="936cf-166">Процедура 1. управляемая отработка отказа на сервер-получатель</span><span class="sxs-lookup"><span data-stu-id="936cf-166">Procedure 1: Perform a Controlled Failover to the Secondary Server</span></span>
 <span data-ttu-id="936cf-167">Управляемая отработка отказа на сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="936cf-167">Controlled failover to the secondary server:</span></span>

1.  <span data-ttu-id="936cf-168">Вручную выполните [резервное копирование заключительного фрагмента](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) журнала транзакций в базе данных-источнике, УКАЗАВ параметр WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="936cf-168">Manually perform a [tail-log backup](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) of the transaction log on the primary database specifying WITH NORECOVERY.</span></span> <span data-ttu-id="936cf-169">В эту резервную копию журналов попадут все записи, резервная копия которых еще не была создана, и база данных будет отключена.</span><span class="sxs-lookup"><span data-stu-id="936cf-169">This log backup captures any log records that have not been backed up yet and takes the database offline.</span></span> <span data-ttu-id="936cf-170">Обратите внимание, что пока база данных находится в режиме «вне сети», задание резервного копирования в доставке журналов будет завершаться с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="936cf-170">Note that while the database is offline, the log shipping backup job will fail.</span></span>

     <span data-ttu-id="936cf-171">В приведенном ниже примере создается резервная копия заключительного фрагмента журнала базы данных `AdventureWorks` на сервере-источнике.</span><span class="sxs-lookup"><span data-stu-id="936cf-171">The following example creates a tail log backup of the `AdventureWorks` database on the primary server.</span></span> <span data-ttu-id="936cf-172">Файлу резервной копии присваивается имя `Failover_AW_20080315.trn`:</span><span class="sxs-lookup"><span data-stu-id="936cf-172">The backup file is named `Failover_AW_20080315.trn`:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Failover_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

     <span data-ttu-id="936cf-173">Рекомендуется использовать различные соглашения об именах файлов, чтобы можно было отличить файлы резервных копий, созданные вручную, от файлов резервных копий, созданных заданием резервного копирования в доставке журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-173">We recommend that you use a distinct file naming convention to differentiate the manually-created backup file from the backup files created by the log shipping backup job.</span></span>

2.  <span data-ttu-id="936cf-174">На сервере-получателе сделайте следующее.</span><span class="sxs-lookup"><span data-stu-id="936cf-174">On the secondary server:</span></span>

    1.  <span data-ttu-id="936cf-175">Убедитесь, что применены все резервные копии, созданные автоматически заданиями резервного копирования в доставке журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-175">Ensure that all backups taken automatically by the log shipping backup jobs have been applied.</span></span> <span data-ttu-id="936cf-176">Чтобы проверить, какие задания резервного копирования были применены, используйте системную хранимую процедуру [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) на сервере мониторинга или на основном и на вторичном серверах.</span><span class="sxs-lookup"><span data-stu-id="936cf-176">To check which backup jobs have been applied, use the [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) system stored procedure on the monitor server or on the primary and secondary servers.</span></span> <span data-ttu-id="936cf-177">Один и тот же файл должен быть указан в столбцах **last_backup_file**, **last_copied_file**и **last_restored_file** .</span><span class="sxs-lookup"><span data-stu-id="936cf-177">The same file should be listed in the **last_backup_file**, **last_copied_file**, and **last_restored_file** columns.</span></span> <span data-ttu-id="936cf-178">Если какой-то из файлов резервной копии не был скопирован или из него не было выполнено восстановление, вручную вызовите задания копирования и восстановления агента для конфигурации доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-178">If any of the backup files have not been copied and restored, manually invoke the agent copy and restore jobs for the log shipping configuration.</span></span>

         <span data-ttu-id="936cf-179">Дополнительные сведения о запуске задания см. в разделе [Start a Job](../../ssms/agent/start-a-job.md).</span><span class="sxs-lookup"><span data-stu-id="936cf-179">For information about starting a job, see [Start a Job](../../ssms/agent/start-a-job.md).</span></span>

    2.  <span data-ttu-id="936cf-180">Скопируйте заключительный файл резервной копии журнала, созданный в шаге 1, из общей папки в локальное расположение, которое используется для доставки журналов на сервере-получателе.</span><span class="sxs-lookup"><span data-stu-id="936cf-180">Copy your the final log backup file that you created in step 1 from the file share to the local location that is used by log shipping on the secondary server.</span></span>

    3.  <span data-ttu-id="936cf-181">Восстановите заключительную резервную копию журнала, указав предложение WITH RECOVERY, чтобы перевести базу данных в режим «в сети».</span><span class="sxs-lookup"><span data-stu-id="936cf-181">Restore the final log backup specifying WITH RECOVERY to bring the database online.</span></span> <span data-ttu-id="936cf-182">При переходе в режим «в сети» база данных будет обновлена до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="936cf-182">As part of being brought online, the database will upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

         <span data-ttu-id="936cf-183">В приведенном ниже примере выполняется восстановление из резервной копии заключительного фрагмента журнала базы данных `AdventureWorks` в базе данных-получателе.</span><span class="sxs-lookup"><span data-stu-id="936cf-183">The following example restores the tail log backup of the `AdventureWorks` database on the secondary database.</span></span> <span data-ttu-id="936cf-184">В примере используется параметр WITH RECOVERY, который переводит базу данных в режим «в сети»:</span><span class="sxs-lookup"><span data-stu-id="936cf-184">The example uses the WITH RECOVERY option, which brings the database online:</span></span>

        ```
        RESTORE LOG AdventureWorks 
          FROM DISK = N'c:\logshipping\Failover_AW_20080315.trn' 
           WITH RECOVERY;
        GO
        ```

        > [!NOTE]
        >  <span data-ttu-id="936cf-185">Для конфигурации, в которой несколько серверов-получателей, предусмотрены дополнительные действия.</span><span class="sxs-lookup"><span data-stu-id="936cf-185">For a configuration that contains more than one secondary server, there are additional considerations.</span></span> <span data-ttu-id="936cf-186">Дополнительные сведения см. в подразделе [Обновление нескольких экземпляров серверов-получателей](#MultipleSecondaries)далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="936cf-186">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

    4.  <span data-ttu-id="936cf-187">Перевод базы данных на другой ресурс путем перенаправления клиентов с исходного сервера-источника (сервера A) на подключенный сервер-получатель (сервер B).</span><span class="sxs-lookup"><span data-stu-id="936cf-187">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    5.  <span data-ttu-id="936cf-188">Убедитесь, чтобы журнал транзакций базы данных-получателя не заполнялся, когда база данных находится в режиме «в сети».</span><span class="sxs-lookup"><span data-stu-id="936cf-188">Take care that the transaction log of the secondary database does not fill while the database is online.</span></span> <span data-ttu-id="936cf-189">Чтобы предотвратить заполнение журнала транзакций, можно создать его резервную копию.</span><span class="sxs-lookup"><span data-stu-id="936cf-189">To prevent the transaction log from filling, you might need to back it up.</span></span> <span data-ttu-id="936cf-190">То есть рекомендуется сохранить его резервную копию в общем расположении, *общей папке резервных копий*, чтобы резервные копии были доступны для восстановления из копии на другом экземпляре сервера.</span><span class="sxs-lookup"><span data-stu-id="936cf-190">If so, we recommend that you back it up to a shared location, a *backup share*, to make the backups available for restoring on the other server instance.</span></span>

#####  <a name="procedure-2-upgrade-the-original-primary-server-instance-to-sscurrent"></a><a name="Procedure2"></a><span data-ttu-id="936cf-191">Процедура 2. обновление исходного экземпляра сервера источника до[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="936cf-191">Procedure 2: Upgrade the Original Primary Server Instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="936cf-192">После обновления экземпляра исходного экземпляра сервера-источника до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]база данных по-прежнему будет в режиме «вне сети» и в формате предыдущей версии.</span><span class="sxs-lookup"><span data-stu-id="936cf-192">After you upgrade the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], the database will still be offline and in the format.</span></span>

#####  <a name="procedure-3-set-up-log-shipping-on-sscurrent"></a><a name="Procedure3"></a><span data-ttu-id="936cf-193">Процедура 3. Настройка доставки журналов в[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="936cf-193">Procedure 3: Set Up Log Shipping on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="936cf-194">Оставшаяся часть процедуры обновления зависит от того, настроена ли доставка журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-194">The rest of the upgrade process depends on whether log shipping is still configured, as follows:</span></span>

-   <span data-ttu-id="936cf-195">Если конфигурация доставки журналов [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]или более поздней версии была сохранена, переключитесь обратно на экземпляр исходного сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-195">If you have kept the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]or higher log shipping configuration, switch back to the original primary server instance.</span></span> <span data-ttu-id="936cf-196">Дополнительные сведения см. в подразделе [Переключение обратно на экземпляр исходного сервера-источника](#SwitchToOrigPrimary)далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="936cf-196">For more information, see [To Switch Back to the Original Primary Server Instance](#SwitchToOrigPrimary), later in this section.</span></span>

-   <span data-ttu-id="936cf-197">Если конфигурация доставки журналов была удалена до перехода на другой ресурс, создайте новую конфигурацию, в которой экземпляр исходного сервера-получателя будет новым экземпляром нового сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-197">If you removed the log shipping configuration before failing over, create a new log shipping configuration in which the original secondary server instance is the new primary server instance.</span></span> <span data-ttu-id="936cf-198">Дополнительные сведения см. в подразделе [Сохранение экземпляра прежнего сервера-получателя в качестве экземпляра нового сервера-источника](#KeepOldSecondaryAsNewPrimary)далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="936cf-198">For more information, see [To Keep the Old Secondary Server Instance As the New Primary Server Instance](#KeepOldSecondaryAsNewPrimary), later in this section.</span></span>

######  <a name="to-switch-back-to-the-original-primary-server-instance"></a><a name="SwitchToOrigPrimary"></a><span data-ttu-id="936cf-199">Переключение обратно на исходный экземпляр сервера источника</span><span class="sxs-lookup"><span data-stu-id="936cf-199">To Switch Back to the Original Primary Server Instance</span></span>

1.  <span data-ttu-id="936cf-200">На промежуточном сервере-источнике (сервер B) создайте резервную копию заключительного фрагмента журнала с помощью параметра WITH NORECOVERY — будет создана резервная копия заключительного фрагмента журнала, а база данных перейдет в режим «вне сети».</span><span class="sxs-lookup"><span data-stu-id="936cf-200">On the interim primary server (server B), back up the tail of the log using WITH NORECOVERY to create a tail-log backup and take the database offline.</span></span> <span data-ttu-id="936cf-201">Резервная копия заключительного фрагмента журнала имеет имя `Switchback_AW_20080315.trn`. Например:</span><span class="sxs-lookup"><span data-stu-id="936cf-201">The tail log backup is named `Switchback_AW_20080315.trn`.For example:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Switchback_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

2.  <span data-ttu-id="936cf-202">Если в промежуточной базе данных-источнике создавались резервные копии журналов транзакций, отличные от резервной копии заключительного фрагмента журнала, созданной в шаге 1, выполните восстановление из этих копий с помощью параметра WITH NORECOVERY для базы данных в режиме «вне сети» на исходном сервере-источнике (сервер A).</span><span class="sxs-lookup"><span data-stu-id="936cf-202">If any transaction log backups were taken on the interim primary database, other than the tail backup that you created in step 1, restore those log backups using WITH NORECOVERY to the offline database on the original primary server (server A).</span></span> <span data-ttu-id="936cf-203">База данных будет обновлена до формата [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] при восстановлении из первой же резервной копии журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-203">The database is upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] format when the first log backup is restored.</span></span>

3.  <span data-ttu-id="936cf-204">Выполните восстановление из резервной копии заключительного фрагмента журнала (`Switchback_AW_20080315.trn`) в исходной базе данных-источнике (на сервере A) с помощью параметра WITH RECOVERY, чтобы перевести базу данных в режим в сети.</span><span class="sxs-lookup"><span data-stu-id="936cf-204">Restore the tail-log backup, `Switchback_AW_20080315.trn`, on the original primary database (on server A) using WITH RECOVERY to bring the database online.</span></span>

4.  <span data-ttu-id="936cf-205">Перейдите обратно к исходной базе данных-источнику (на сервере A) путем перенаправления клиентов с исходного сервера-источника на работающий в режиме «в сети» сервер-получатель.</span><span class="sxs-lookup"><span data-stu-id="936cf-205">Fail over back to the original primary database (on server A) by redirecting clients to the online secondary server from the original primary server.</span></span>

 <span data-ttu-id="936cf-206">После переключения базы данных в режим «в сети» снова будет использоваться исходная конфигурация доставки журналов.</span><span class="sxs-lookup"><span data-stu-id="936cf-206">After the database comes online, the original log shipping configuration will resume.</span></span>

######  <a name="to-keep-the-old-secondary-server-instance-as-the-new-primary-server-instance"></a><a name="KeepOldSecondaryAsNewPrimary"></a><span data-ttu-id="936cf-207">Обеспечение сохранения старого экземпляра сервера-получателя в качестве нового экземпляра сервера-источника</span><span class="sxs-lookup"><span data-stu-id="936cf-207">To Keep the Old Secondary Server Instance As the New Primary Server Instance</span></span>
 <span data-ttu-id="936cf-208">Создайте новую конфигурацию доставки журналов, используя экземпляр прежнего сервера-получателя, сервера B, в качестве нового сервера-источника и прежнего экземпляра сервера-источника, сервера A, в качестве нового сервера-получателя.</span><span class="sxs-lookup"><span data-stu-id="936cf-208">Establish a new log shipping configuration using the old secondary server instance, B, as the primary server and the old primary server instance, A, as the new secondary server, as follows:</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="936cf-209">Прежняя конфигурация доставки журналов должна быть уже удалена с исходного сервера-источника в начале процедуры перед ручным созданием резервной копии журнала транзакций, в результате чего база данных была переведена в режим «вне сети».</span><span class="sxs-lookup"><span data-stu-id="936cf-209">The old log shipping configuration should have been removed from the original primary server at the start of the process before taking the manual transaction log backup that took the database offline.</span></span>

1.  <span data-ttu-id="936cf-210">Чтобы не выполнять полное резервное копирование и восстановление базы данных на новом сервере-получателе (сервере A), примените резервные копии журналов из новой базы данных-источника к новой базе данных-получателю.</span><span class="sxs-lookup"><span data-stu-id="936cf-210">To avoid performing a complete backup and restore of the database on the new secondary server (server A), apply the log backups from the new primary database to the new secondary database.</span></span> <span data-ttu-id="936cf-211">В примере конфигурации выполняется восстановление из резервных копий журналов, созданных на сервере B, в базе данных на сервере A.</span><span class="sxs-lookup"><span data-stu-id="936cf-211">In the example configuration, this involves restoring the log backups taken on server B to the database on server A.</span></span>

2.  <span data-ttu-id="936cf-212">Создание резервной копии журналов в новой базе данных-источнике (на сервере B).</span><span class="sxs-lookup"><span data-stu-id="936cf-212">Back up the log from the new primary database (on server B).</span></span>

3.  <span data-ttu-id="936cf-213">Восстановление из резервных копий журналов на экземпляре нового сервера-получателя (сервере A) с помощью параметра WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="936cf-213">Restore the log backups to the new secondary server instance (server A) using WITH NORECOVERY.</span></span> <span data-ttu-id="936cf-214">В процессе первой же операции восстановления база данных обновляется до версии [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="936cf-214">The first restore operation updates the database to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

4.  <span data-ttu-id="936cf-215">Настройте доставку журналов с прежним сервером-получателем (сервером B) в качестве экземпляра сервера-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-215">Configure log shipping with the former secondary server (server B) as the primary server instance.</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="936cf-216">При работе в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] следует указать, что база данных-получатель уже инициализирована.</span><span class="sxs-lookup"><span data-stu-id="936cf-216">If you use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], specify that the secondary database is already initialized.</span></span>

     <span data-ttu-id="936cf-217">Дополнительные сведения см. в разделе [Настройка доставки журналов (SQL Server)](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="936cf-217">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

5.  <span data-ttu-id="936cf-218">Перевод базы данных на другой ресурс путем перенаправления клиентов с исходного сервера-источника (сервера A) на подключенный сервер-получатель (сервер B).</span><span class="sxs-lookup"><span data-stu-id="936cf-218">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="936cf-219">При отработке отказа с переходом на новую базу данных-источник следует убедиться, что ее метаданные согласованы с метаданными исходной базы данных-источника.</span><span class="sxs-lookup"><span data-stu-id="936cf-219">When you failover to a new primary database, you should ensure that its metadata is consistent with the metadata of the original primary database.</span></span> <span data-ttu-id="936cf-220">Дополнительные сведения см. в статье [Управление метаданными при обеспечении доступности базы данных на другом экземпляре сервера (SQL Server)](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span><span class="sxs-lookup"><span data-stu-id="936cf-220">For more information, see [Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span></span>

##  <a name="upgrading-multiple-secondary-server-instances"></a><a name="MultipleSecondaries"></a><span data-ttu-id="936cf-221">Обновление нескольких экземпляров сервера-получателя</span><span class="sxs-lookup"><span data-stu-id="936cf-221">Upgrading Multiple Secondary Server Instances</span></span>
 <span data-ttu-id="936cf-222">Эта конфигурация показана на следующей иллюстрации, на которой изображен экземпляр сервера-источника (A) и два экземпляра сервера-получателя (B и C).</span><span class="sxs-lookup"><span data-stu-id="936cf-222">This configuration is represented in the following illustration, which shows a primary server instance, A, and two secondary server instances, B and C.</span></span>

 <span data-ttu-id="936cf-223">![Два сервера-получателя, нет сервера мониторинга](../media/ls-3-wayconfig-nomonitor.gif "Два сервера-получателя, нет сервера мониторинга")</span><span class="sxs-lookup"><span data-stu-id="936cf-223">![Two secondary servers and no monitor server](../media/ls-3-wayconfig-nomonitor.gif "Two secondary servers and no monitor server")</span></span>

 <span data-ttu-id="936cf-224">В этом разделе описывается выполнения обновления с помощью отработки отказа на сервер-получатель и обратного переключения на исходный сервер-источник.</span><span class="sxs-lookup"><span data-stu-id="936cf-224">This section discusses how to upgrade using a failover and then switching back to the original primary server.</span></span> <span data-ttu-id="936cf-225">Обновление экземпляра сервера-источника с отработкой отказа усложняется, если существует несколько экземпляров сервера-получателя.</span><span class="sxs-lookup"><span data-stu-id="936cf-225">When upgrading the primary instance with failover the process is more complex when there are multiple secondary server instances.</span></span> <span data-ttu-id="936cf-226">В следующей процедуре после обновления всех серверов-получателей сервер-источник переводится на другой ресурс — одну из обновленных баз данных-получателей.</span><span class="sxs-lookup"><span data-stu-id="936cf-226">In the following procedure, after all the secondary servers are upgraded, the primary server is failed over to one of the upgraded secondary databases.</span></span> <span data-ttu-id="936cf-227">Исходный сервер-источник обновляется, и доставка журналов переключается обратно на него.</span><span class="sxs-lookup"><span data-stu-id="936cf-227">The original primary server is upgraded, and log shipping is failed over back to it.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="936cf-228">Экземпляры сервера-получателя всегда следует обновлять раньше, чем сервер-источник.</span><span class="sxs-lookup"><span data-stu-id="936cf-228">Always upgrade all the secondary server instances before you upgrade the primary server.</span></span>

 <span data-ttu-id="936cf-229">**Обновление с помощью отработки отказа на сервер-получатель и обратного переключения на исходный сервер-источник**</span><span class="sxs-lookup"><span data-stu-id="936cf-229">**To upgrade using a failover and then switching back to original primary server**</span></span>

1.  <span data-ttu-id="936cf-230">Обновите все экземпляры сервера-получателя (сервер B и сервер C).</span><span class="sxs-lookup"><span data-stu-id="936cf-230">Upgrade all the secondary server instances (server B and server C).</span></span>

2.  <span data-ttu-id="936cf-231">Получите заключительный фрагмент журнала транзакций базы данных-источника (на сервере A) и переведите базу данных в режим «вне сети» путем создания резервной копии журнала транзакций с помощью параметра WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="936cf-231">Obtain the tail of the transaction log of the primary database (on server A), and take the database offline, by backing up the transaction log using WITH NORECOVERY.</span></span>

3.  <span data-ttu-id="936cf-232">На сервере-получателе, на который планируется выполнять переход (сервер B), переведите базу данных-получатель в режим «в сети» путем восстановления из резервной копии журналов с помощью инструкции WITH RECOVERY.</span><span class="sxs-lookup"><span data-stu-id="936cf-232">On the secondary server to which you plan to fail over (server B), bring the secondary database online, by restoring the log backup using WITH RECOVERY.</span></span>

4.  <span data-ttu-id="936cf-233">На каждом сервере-получателе (сервер C) следует перевести базу данных-получатель в режим «вне сети» путем восстановления из резервной копии журналов с помощью предложения WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="936cf-233">On every other secondary server (server C), leave the secondary database offline by restoring the log backup using WITH NORECOVERY.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="936cf-234">Задания копирования и восстановления доставки журналов будут запускаться на серверах-получателях, но они не будут выполнять никаких действий, поскольку новые файлы резервной копии журналов не будут помещены в общую папку резервных копий.</span><span class="sxs-lookup"><span data-stu-id="936cf-234">The log shipping copy and restore jobs will run on the secondary servers, but the jobs will do nothing because new log-backup files will not be placed on the backup share.</span></span>

5.  <span data-ttu-id="936cf-235">Перевод базы данных на другой ресурс путем перенаправления клиентов с исходного сервера-источника (сервера A) на подключенный сервер-получатель (сервер B).</span><span class="sxs-lookup"><span data-stu-id="936cf-235">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span> <span data-ttu-id="936cf-236">База данных в режиме «в сети» становится промежуточным сервером-источником, благодаря которому база остается доступной, пока исходный сервер-источник (сервер A) находится в режиме «вне сети».</span><span class="sxs-lookup"><span data-stu-id="936cf-236">The online database becomes an interim primary server, keeping the database available while the original primary server is offline (server A).</span></span>

6.  <span data-ttu-id="936cf-237">Обновите исходный сервер-источник (сервер A).</span><span class="sxs-lookup"><span data-stu-id="936cf-237">Upgrade the original primary server (server A).</span></span>

7.  <span data-ttu-id="936cf-238">В базе данных, для которой выполнена отработка отказа — промежуточная база данных-источник (на сервере B), вручную создайте резервную копию журнала транзакций с параметром WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="936cf-238">On the database to which you failed over-the interim primary database (on server B), manually back up the transaction log using WITH NORECOVERY.</span></span> <span data-ttu-id="936cf-239">При этом база данных перейдет в режим «вне сети».</span><span class="sxs-lookup"><span data-stu-id="936cf-239">This takes the database offline.</span></span>

8.  <span data-ttu-id="936cf-240">Выполните восстановление из всех резервных копий журналов транзакций, созданных в промежуточной базе данных-источнике (на сервере B) для всех прочих баз данных-получателей (на сервере C) с помощью параметра WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="936cf-240">Restore all transaction log backups that you created on the interim primary database (on server B) to every other secondary database (on server C) using WITH NORECOVERY.</span></span> <span data-ttu-id="936cf-241">Это позволяет продолжить доставку журналов из исходной базы данных-источника после ее обновления без необходимости выполнять полное восстановление в каждой базе данных-получателе.</span><span class="sxs-lookup"><span data-stu-id="936cf-241">This allows log shipping to continue from the original primary database after its upgrade, without requiring a full database restore on each secondary database.</span></span>

9. <span data-ttu-id="936cf-242">Восстановите журнал транзакций с промежуточного сервера-источника (сервера B) на исходной базе данных-источнике (на сервере A) с помощью параметра WITH RECOVERY.</span><span class="sxs-lookup"><span data-stu-id="936cf-242">Restore the transaction log from the interim primary server (server B) to the original primary database (on server A) using WITH RECOVERY.</span></span>

##  <a name="redeploying-log-shipping"></a><a name="Redeploying"></a><span data-ttu-id="936cf-243">Повторное развертывание доставки журналов</span><span class="sxs-lookup"><span data-stu-id="936cf-243">Redeploying Log Shipping</span></span>
 <span data-ttu-id="936cf-244">Если не нужно выполнять миграцию конфигурации доставки журналов с помощью одной из вышеуказанных процедур, можно повторно развернуть доставку журналов с нуля, выполнив повторную инициализацию базы данных-получателя с полной резервной копией, и восстановить базу данных-источник.</span><span class="sxs-lookup"><span data-stu-id="936cf-244">If you do not want to migrate your log shipping configuration using one of the procedures shown above, you can redeploy log shipping from scratch by reinitializing your secondary database with a full backup and restore of the primary database.</span></span> <span data-ttu-id="936cf-245">Это может быть наиболее предпочтительным режимом, если имеется небольшая база данных или если высокий уровень доступности не является требованием к процедуре обновления.</span><span class="sxs-lookup"><span data-stu-id="936cf-245">This may be a desirable option if you have a small database or if high availability is not crucial during the upgrade procedure.</span></span>

 <span data-ttu-id="936cf-246">Сведения о включении доставки журналов см. в разделе [Настройка доставки журналов &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="936cf-246">For information about enabling log shipping, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="936cf-247">См. также:</span><span class="sxs-lookup"><span data-stu-id="936cf-247">See Also</span></span>
 <span data-ttu-id="936cf-248">[Резервные копии журналов транзакций &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [применение резервных копий журналов транзакций &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [таблиц доставки журналов и хранимых процедур](log-shipping-tables-and-stored-procedures.md)</span><span class="sxs-lookup"><span data-stu-id="936cf-248">[Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [Apply Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [Log Shipping Tables and Stored Procedures](log-shipping-tables-and-stored-procedures.md)</span></span>
