---
title: Транзакции в таблицах, оптимизированных для памяти | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 2cd07d26-a1f1-4034-8d6f-f196eed1b763
author: stevestein
ms.author: sstein
ms.openlocfilehash: bc9109c7243e609e5ddd820b61386183761167bf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87751371"
---
# <a name="transactions-in-memory-optimized-tables"></a><span data-ttu-id="862fb-102">Транзакции в таблицах, оптимизированных для памяти</span><span class="sxs-lookup"><span data-stu-id="862fb-102">Transactions in Memory-Optimized Tables</span></span>
  <span data-ttu-id="862fb-103">Управление версиями строк в дисковых таблицах (с использованием уровня изоляции моментальных снимков или параметра READ_COMMITTED_SNAPSHOT) предоставляет форму управления оптимистичным параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="862fb-103">Row versioning on disk-based tables (using SNAPSHOT isolation or READ_COMMITTED_SNAPSHOT) provides a form of optimistic concurrency control.</span></span> <span data-ttu-id="862fb-104">Модули чтения и записи не блокируют друг друга.</span><span class="sxs-lookup"><span data-stu-id="862fb-104">Readers and writers do not block each other.</span></span> <span data-ttu-id="862fb-105">При использовании оптимизированных для памяти таблиц модули записи не блокируют модули записи.</span><span class="sxs-lookup"><span data-stu-id="862fb-105">With memory-optimized tables, writers do not block writers.</span></span> <span data-ttu-id="862fb-106">При управлении версиями строк в дисковых таблицах одна транзакция блокирует строку и попытки обновления строки параллельными транзакциями блокируются.</span><span class="sxs-lookup"><span data-stu-id="862fb-106">With row versioning on disk-based tables, one transaction locks the row and concurrent transactions attempting to update the row are blocked.</span></span> <span data-ttu-id="862fb-107">При использовании оптимизированных для памяти таблиц блокировки не применяются.</span><span class="sxs-lookup"><span data-stu-id="862fb-107">There is no locking with memory-optimized tables.</span></span> <span data-ttu-id="862fb-108">Вместо этого, если две транзакции пытаются обновить одну строку, возникает конфликт «запись-запись» (ошибка 41302).</span><span class="sxs-lookup"><span data-stu-id="862fb-108">Instead, if two transactions attempt to update the same row, a write/write conflict (error 41302) will occur.</span></span>

 <span data-ttu-id="862fb-109">В отличие от дисковых таблиц оптимизированные для памяти таблицы обеспечивают управление оптимистичным параллелизмом с более высоким уровнем изоляции — REPEATABLE READ и SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="862fb-109">Unlike disk-based tables, memory-optimized tables allow optimistic concurrency control with the higher isolation levels, REPEATABLE READ and SERIALIZABLE.</span></span> <span data-ttu-id="862fb-110">Для обеспечения уровней изоляции блокировки не применяются.</span><span class="sxs-lookup"><span data-stu-id="862fb-110">Locks are not taken to enforce the isolation levels.</span></span> <span data-ttu-id="862fb-111">Вместо этого в конце транзакции выполняется проверка, чтобы убедиться, что не нарушены допущения операций чтения с возможностью повторения или сериализации.</span><span class="sxs-lookup"><span data-stu-id="862fb-111">Instead, at the end of the transaction validation ensures the repeatable read or serializability assumptions.</span></span> <span data-ttu-id="862fb-112">Если допущения нарушены, транзакция прерывается.</span><span class="sxs-lookup"><span data-stu-id="862fb-112">If the assumptions are violated, the transaction is terminated.</span></span> <span data-ttu-id="862fb-113">Дополнительные сведения см. в разделе [Transaction Isolation Levels](../../2014/database-engine/transaction-isolation-levels.md).</span><span class="sxs-lookup"><span data-stu-id="862fb-113">For more information, see [Transaction Isolation Levels](../../2014/database-engine/transaction-isolation-levels.md).</span></span>

 <span data-ttu-id="862fb-114">Важная семантика транзакций для оптимизированных для памяти таблиц:</span><span class="sxs-lookup"><span data-stu-id="862fb-114">The important transaction semantics for memory-optimized tables are:</span></span>

-   <span data-ttu-id="862fb-115">Управление версиями</span><span class="sxs-lookup"><span data-stu-id="862fb-115">Multi-versioning</span></span>

-   <span data-ttu-id="862fb-116">Изоляции транзакции на основе моментального снимка</span><span class="sxs-lookup"><span data-stu-id="862fb-116">Snapshot-based transaction isolation</span></span>

-   <span data-ttu-id="862fb-117">Optimistic</span><span class="sxs-lookup"><span data-stu-id="862fb-117">Optimistic</span></span>

-   <span data-ttu-id="862fb-118">Обнаружение конфликтов</span><span class="sxs-lookup"><span data-stu-id="862fb-118">Conflict detection</span></span>

 <span data-ttu-id="862fb-119">Каждая из этих семантик описана в следующих разделах.</span><span class="sxs-lookup"><span data-stu-id="862fb-119">Each of these semantics is explained in the following sections.</span></span>

## <a name="multi-versioning-in-memory-optimized-tables"></a><span data-ttu-id="862fb-120">Управление версиями в оптимизированных для памяти таблицах</span><span class="sxs-lookup"><span data-stu-id="862fb-120">Multi-Versioning in Memory-Optimized Tables</span></span>
 <span data-ttu-id="862fb-121">Строки оптимизированных для памяти таблиц могут иметь различные версии.</span><span class="sxs-lookup"><span data-stu-id="862fb-121">Rows in memory-optimized tables can have different versions.</span></span> <span data-ttu-id="862fb-122">Потенциально параллельные транзакции могут получать разные версии одной и той же строки.</span><span class="sxs-lookup"><span data-stu-id="862fb-122">Concurrent transactions access potentially different versions of the same row.</span></span>

 <span data-ttu-id="862fb-123">Данные в оптимизированных для памяти таблицах основаны на использовании версий.</span><span class="sxs-lookup"><span data-stu-id="862fb-123">Memory-optimized table data is version-based.</span></span> <span data-ttu-id="862fb-124">Для любой строки могут существовать различные версии строк, действительные в разные моменты времени.</span><span class="sxs-lookup"><span data-stu-id="862fb-124">For any row there may be different row versions that are valid at different points in time.</span></span> <span data-ttu-id="862fb-125">Дисковые таблицы поддерживают различные версии строк, если параметры READ_COMMITTED_SNAPSHOT или ALLOW_SNAPSHOT_ISOLATION установлены в значение ON.</span><span class="sxs-lookup"><span data-stu-id="862fb-125">Disk-based tables maintain different row versions when READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION is ON.</span></span> <span data-ttu-id="862fb-126">В оптимизированных для памяти таблицах всегда поддерживаются различные версии строк, даже если параметры READ_COMMITTED_SNAPSHOT и ALLOW_SNAPSHOT_ISOLATION имеют значение OFF.</span><span class="sxs-lookup"><span data-stu-id="862fb-126">Memory-optimized tables maintain different row versions, even if READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION are OFF.</span></span> <span data-ttu-id="862fb-127">Версии строк оптимизированных для памяти таблиц не содержатся в базе данных tempdb.</span><span class="sxs-lookup"><span data-stu-id="862fb-127">The row versions of memory-optimized tables are not maintained in tempdb.</span></span> <span data-ttu-id="862fb-128">Вместо этого, версии строк хранятся встроенными в составе оптимизированных для памяти структур данных для хранения строк в памяти.</span><span class="sxs-lookup"><span data-stu-id="862fb-128">Instead, the row versions are maintained in-line, as part of the memory-optimized data structures storing the rows in memory.</span></span>

## <a name="snapshot-based-transaction-isolation-for-memory-optimized-tables"></a><span data-ttu-id="862fb-129">Изоляция транзакций на основе моментального снимка у оптимизированных для памяти таблиц</span><span class="sxs-lookup"><span data-stu-id="862fb-129">Snapshot-Based Transaction Isolation for Memory-Optimized Tables</span></span>
 <span data-ttu-id="862fb-130">Все операции в одной транзакции используют один и тот же транзакционно согласованный моментальный снимок оптимизированных для памяти таблиц.</span><span class="sxs-lookup"><span data-stu-id="862fb-130">All operations in a single transaction use the same transactionally-consistent snapshot of the memory-optimized tables.</span></span> <span data-ttu-id="862fb-131">Изоляция всех транзакций у оптимизированных для памяти таблиц выполняется на основе моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="862fb-131">All transaction isolation for memory-optimized tables is snapshot-based.</span></span> <span data-ttu-id="862fb-132">Например, транзакция, использующая уровень изоляции SERIALIZABLE для доступа к оптимизированным для памяти таблицам, выполняет все операции на том же транзакционно согласованном моментальном снимке.</span><span class="sxs-lookup"><span data-stu-id="862fb-132">For example, a transaction using the serializable isolation level to access memory-optimized tables will perform all operations on the same transactionally consistent snapshot.</span></span>

 <span data-ttu-id="862fb-133">Транзакции, которые обращаются к оптимизированным для памяти таблицам, используют управление версиями строк для получения транзакционно согласованного моментального снимка строк в таблицах.</span><span class="sxs-lookup"><span data-stu-id="862fb-133">Transactions that access memory-optimized tables use this row versioning to obtain a transactionally consistent snapshot of the rows in the tables.</span></span> <span data-ttu-id="862fb-134">Данные, считанные любой инструкцией транзакции, будут согласованы на уровне транзакции с версией данных, существовавших во время запуска транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-134">The data read by any statement in the transaction will be the transactionally consistent version of the data that existed at the time the transaction started.</span></span> <span data-ttu-id="862fb-135">Поэтому все изменения, сделанные параллельно выполняемыми транзакциями, невидимы для инструкций в текущей транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-135">Therefore, any modifications made by concurrently running transactions are not visible to statements in the current transaction.</span></span>

## <a name="optimistic-concurrency-control-for-memory-optimized-tables"></a><span data-ttu-id="862fb-136">Управление оптимистичным параллелизмом у оптимизированных для памяти таблиц</span><span class="sxs-lookup"><span data-stu-id="862fb-136">Optimistic Concurrency Control for Memory-Optimized Tables</span></span>
 <span data-ttu-id="862fb-137">Конфликты и ошибки происходят редко и транзакции для оптимизированных для памяти таблиц предполагают, что конфликты с параллельными транзакциями отсутствуют и операции выполняются успешно.</span><span class="sxs-lookup"><span data-stu-id="862fb-137">Conflicts and failures are rare and transactions on memory-optimized tables assume there are no conflicts with concurrent transactions and operations succeed.</span></span> <span data-ttu-id="862fb-138">Транзакции не принимают блокировки или кратковременные блокировки для оптимизированных для памяти таблиц, чтобы гарантировать уровень изоляции транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-138">Transactions do not take locks or latches on memory-optimized table to guarantee transaction isolation.</span></span> <span data-ttu-id="862fb-139">Модули записи не блокируют модули чтения.</span><span class="sxs-lookup"><span data-stu-id="862fb-139">Writers do not block readers.</span></span> <span data-ttu-id="862fb-140">Модули записи не блокируют модули записи.</span><span class="sxs-lookup"><span data-stu-id="862fb-140">Writers do not block writers.</span></span> <span data-ttu-id="862fb-141">Вместо этого транзакции продолжается с допущением (оптимистическим), что конфликтов с другими транзакциями не существует.</span><span class="sxs-lookup"><span data-stu-id="862fb-141">Instead, transactions proceed under the (optimistic) assumption that there will be no conflicts with other transactions.</span></span> <span data-ttu-id="862fb-142">Отказ от использования блокировок и кратковременных блокировок и от ожидания завершения обработки тех же строк другими транзакциями улучшает производительность.</span><span class="sxs-lookup"><span data-stu-id="862fb-142">Not using locks and latches and not waiting for other transactions to finish processing the same rows improves performance.</span></span>

 <span data-ttu-id="862fb-143">Кроме того, если транзакция (TxA) считывает строки, которые были вставлены или изменены другой транзакцией (TxB), которая находится в процессе фиксации, первая транзакция будет предполагать, что другая транзакция будет зафиксирована вместо ожидания завершения этой операции.</span><span class="sxs-lookup"><span data-stu-id="862fb-143">In addition, if a transaction (TxA) reads rows that have been inserted or modified by another transaction (TxB) that is in the process of committing, it will optimistically assume the other transaction will commit rather than wait for the commit to occur.</span></span> <span data-ttu-id="862fb-144">В этом случае транзакция TxA примет зависимость от фиксации транзакции TxB.</span><span class="sxs-lookup"><span data-stu-id="862fb-144">In this case, transaction TxA will take a commit dependency on transaction TxB.</span></span>

## <a name="conflict-detection-validation-and-commit-dependency-checks"></a><span data-ttu-id="862fb-145">Обнаружение и проверка конфликтов и проверки зависимости фиксации</span><span class="sxs-lookup"><span data-stu-id="862fb-145">Conflict Detection, Validation, and Commit Dependency Checks</span></span>
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="862fb-146">обнаруживает конфликты между параллельными транзакциями, а также нарушения уровня изоляции и отменяет одну из конфликтующих транзакций.</span><span class="sxs-lookup"><span data-stu-id="862fb-146">detects conflicts between concurrent transactions, as well as isolation level violations, and will doom one of the conflicting transactions.</span></span> <span data-ttu-id="862fb-147">Эту транзакцию необходимо будет повторить.</span><span class="sxs-lookup"><span data-stu-id="862fb-147">This transaction will need to be retried.</span></span> <span data-ttu-id="862fb-148">(Дополнительные сведения см. [в разделе рекомендации по логике повторных попыток для транзакций в таблицах, оптимизированных для памяти](../relational-databases/in-memory-oltp/memory-optimized-tables.md).)</span><span class="sxs-lookup"><span data-stu-id="862fb-148">(For more information, see [Guidelines for Retry Logic for Transactions on Memory-Optimized Tables](../relational-databases/in-memory-oltp/memory-optimized-tables.md).)</span></span>

 <span data-ttu-id="862fb-149">Система оптимистически предполагает отсутствие конфликтов и нарушений изоляции транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-149">The system optimistically assumes there are no conflicts and no violations of transaction isolation.</span></span> <span data-ttu-id="862fb-150">При возникновении любых конфликтов, которые могут стать причиной несоответствия в базе данных или нарушить изоляцию транзакции, они обнаруживаются, а транзакция прерывается.</span><span class="sxs-lookup"><span data-stu-id="862fb-150">If any conflicts occur that may cause inconsistencies in the database or that may violate transaction isolation, these conflicts are detected, and the transaction is terminated.</span></span>

 <span data-ttu-id="862fb-151">При обнаружении конфликта транзакция завершается и клиенту необходимо повторить попытку.</span><span class="sxs-lookup"><span data-stu-id="862fb-151">If a conflict is detected, the transaction is terminated and the client needs to retry.</span></span>

 <span data-ttu-id="862fb-152">В следующей таблице перечислены условия ошибки, относящиеся к транзакциям, которые обращаются к оптимизированным для памяти таблицам.</span><span class="sxs-lookup"><span data-stu-id="862fb-152">The following table summarizes the error conditions for transactions that accesses memory-optimized tables.</span></span>

### <a name="error-conditions-for-transactions-accessing-memory-optimized-tables"></a><span data-ttu-id="862fb-153">Условия возникновения ошибок для транзакций при доступе к оптимизированным для памяти таблицам.</span><span class="sxs-lookup"><span data-stu-id="862fb-153">Error conditions for transactions accessing memory-optimized tables.</span></span>

|<span data-ttu-id="862fb-154">Ошибка</span><span class="sxs-lookup"><span data-stu-id="862fb-154">Error</span></span>|<span data-ttu-id="862fb-155">Сценарий</span><span class="sxs-lookup"><span data-stu-id="862fb-155">Scenario</span></span>|
|-----------|--------------|
|<span data-ttu-id="862fb-156">Конфликт записи.</span><span class="sxs-lookup"><span data-stu-id="862fb-156">Write conflict.</span></span> <span data-ttu-id="862fb-157">Попытка обновить запись, которая была обновлена со времени запуска транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-157">Attempting to update a record that has been updated since the transaction started.</span></span>|<span data-ttu-id="862fb-158">UPDATE или DELETE строку, которая была обновлена или удалена параллельной транзакцией.</span><span class="sxs-lookup"><span data-stu-id="862fb-158">UPDATE or DELETE a row that has been updated or deleted by a concurrent transaction.</span></span>|
|<span data-ttu-id="862fb-159">Ошибка проверки операций чтения с возможностью повторения.</span><span class="sxs-lookup"><span data-stu-id="862fb-159">Repeatable read validation failure.</span></span>|<span data-ttu-id="862fb-160">Строка, которая была прочтена транзакцией, изменилась (обновлена или удалена) с момента запуска транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-160">A row that was read by the transaction has changed (updated or deleted) since the transaction started.</span></span> <span data-ttu-id="862fb-161">Проверка повторяющихся операций чтения обычно производится при работе с уровнями изоляции транзакции REPEATABLE READ и SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="862fb-161">Repeatable read validation is typically occurs when using REPEATABLE READ and SERIALIZABLE transaction isolation levels.</span></span>|
|<span data-ttu-id="862fb-162">Ошибка сериализуемой проверки.</span><span class="sxs-lookup"><span data-stu-id="862fb-162">Serializable validation failure.</span></span>|<span data-ttu-id="862fb-163">Новая строка (фантом) была вставлена в один из диапазонов просмотра в транзакции со времени начала транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-163">A new (phantom) row has been inserted in one of the scan ranges in the transaction, since the transaction started.</span></span> <span data-ttu-id="862fb-164">Строка была бы видимой для транзакции, если бы она была зафиксирована в базе данных до запуска транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-164">The row would have been visible to the transaction if the row had been committed to the database before the transaction started.</span></span> <span data-ttu-id="862fb-165">Проверка SERIALIZABLE обычно используется при работе с изоляцией SERIALIZABLE и при проверке ограничений PRIMARY KEY.</span><span class="sxs-lookup"><span data-stu-id="862fb-165">SERIALIZABLE validation typically occurs when using SERIALIZABLE isolation and validating PRIMARY KEY constraints.</span></span>|
|<span data-ttu-id="862fb-166">Ошибка зависимости фиксации.</span><span class="sxs-lookup"><span data-stu-id="862fb-166">Commit dependency failure.</span></span>|<span data-ttu-id="862fb-167">Транзакция приняла зависимость от другой транзакции, которой не удалось выполнить фиксацию, по причине одной из ошибок, перечисленных в этой таблице, состояния нехватки памяти или из-за ошибки фиксации в журнале транзакций.</span><span class="sxs-lookup"><span data-stu-id="862fb-167">The transaction took a dependency on another transaction that failed to commit, either due to one of the failures in this table, an out-of-memory condition, or due to failure to commit to the transaction log.</span></span> <span data-ttu-id="862fb-168">Эта ошибка может произойти как с транзакциями для чтения и записи, так и только для чтения.</span><span class="sxs-lookup"><span data-stu-id="862fb-168">This failure can occur with both read/write and read-only transactions.</span></span>|

### <a name="transaction-lifetime"></a><span data-ttu-id="862fb-169">Время существования транзакций</span><span class="sxs-lookup"><span data-stu-id="862fb-169">Transaction Lifetime</span></span>
 <span data-ttu-id="862fb-170">Ошибки, упомянутые в предыдущей таблице, могут возникнуть в различные моменты существования транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-170">The failures mentioned in the previous table can occur at different points during a transaction.</span></span> <span data-ttu-id="862fb-171">На следующем рисунке показаны этапы транзакции, которая обращается к оптимизированным для памяти таблицам.</span><span class="sxs-lookup"><span data-stu-id="862fb-171">The following figure illustrates the phases of a transaction that accesses memory-optimized tables.</span></span>

 <span data-ttu-id="862fb-172">![Время существования транзакции.](../../2014/database-engine/media/hekaton-transactions.gif "Время существования транзакции.")</span><span class="sxs-lookup"><span data-stu-id="862fb-172">![Lifetime of a transaction.](../../2014/database-engine/media/hekaton-transactions.gif "Lifetime of a transaction.")</span></span>
<span data-ttu-id="862fb-173">Время существования транзакций, которые обращаются к оптимизированным для памяти таблицам.</span><span class="sxs-lookup"><span data-stu-id="862fb-173">Lifetime of a transaction that accesses memory-optimized tables.</span></span>

#### <a name="regular-processing"></a><span data-ttu-id="862fb-174">Обычная обработка</span><span class="sxs-lookup"><span data-stu-id="862fb-174">Regular Processing</span></span>
 <span data-ttu-id="862fb-175">Во время этого этапа выполняются инструкции [!INCLUDE[tsql](../includes/tsql-md.md)], выданные пользователем.</span><span class="sxs-lookup"><span data-stu-id="862fb-175">During this phase, the user-issued [!INCLUDE[tsql](../includes/tsql-md.md)] statements are executed.</span></span> <span data-ttu-id="862fb-176">Строки считываются из таблиц, а новые версии строк записываются в базу данных.</span><span class="sxs-lookup"><span data-stu-id="862fb-176">Rows are read from the tables, and new row versions are written to the database.</span></span> <span data-ttu-id="862fb-177">Транзакция изолирована от всех других параллельных транзакций.</span><span class="sxs-lookup"><span data-stu-id="862fb-177">The transaction is isolated from all other concurrent transactions.</span></span> <span data-ttu-id="862fb-178">Транзакция использует моментальный снимок оптимизированных для памяти таблиц, существующий на момент начала транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-178">The transaction uses the snapshot of the memory-optimized tables that exists at the start of the transaction.</span></span>

 <span data-ttu-id="862fb-179">Операции записи в таблицы на этом этапе транзакции пока не видны другим транзакциям, за одним исключением: обновления строк и удаления видимы для операций обновления и удаления в других транзакциях, чтобы обнаружить конфликты записи.</span><span class="sxs-lookup"><span data-stu-id="862fb-179">Writes to the tables in this phase of the transaction are not yet visible to other transactions, with one exception: row updates and deletes are visible to update and delete operations in other transactions, in order to detect write conflicts.</span></span>

 <span data-ttu-id="862fb-180">Если операция обновления или удаления обнаруживает, что была обновлена или удалена строка с момента логического начала транзакции, операция завершается с ошибкой 41302.</span><span class="sxs-lookup"><span data-stu-id="862fb-180">If an update or delete operation sees that a row has been updated or deleted since the logical start of the transaction, the operation will fail with error 41302.</span></span> <span data-ttu-id="862fb-181">Сообщение для ошибки 41302: «Текущая транзакция пыталась обновить запись в таблице X, которая была обновлена с момента начала этой транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-181">The message for error 41302 is "The current transaction attempted to update a record in table X that has been updated since this transaction started.</span></span> <span data-ttu-id="862fb-182">Транзакция была прервана».</span><span class="sxs-lookup"><span data-stu-id="862fb-182">The transaction was aborted."</span></span>

 <span data-ttu-id="862fb-183">Данная ошибка приводит к прерыванию транзакции (даже если XACT_ABORT имеет значение OFF). Это значит, что должен быть выполнен откат транзакции при завершении сеанса пользователя.</span><span class="sxs-lookup"><span data-stu-id="862fb-183">This error dooms the transaction (even if XACT_ABORT is OFF), meaning that the transaction will be rolled back when the user session ends.</span></span> <span data-ttu-id="862fb-184">Поврежденные транзакции нельзя зафиксировать, они поддерживают только операции чтения, которые не записываются в журнал и не обращаются к таблицам, оптимизированным для памяти.</span><span class="sxs-lookup"><span data-stu-id="862fb-184">Doomed transactions cannot be committed and only support read operations that do not write to the log and do not access memory-optimized tables.</span></span>

#####  <a name="commit-dependencies"></a><a name="cd"></a><span data-ttu-id="862fb-185">Фиксация зависимостей</span><span class="sxs-lookup"><span data-stu-id="862fb-185">Commit Dependencies</span></span>
 <span data-ttu-id="862fb-186">Во время обычной обработки транзакция может считывать строки, созданные другими транзакциями, которые находятся на этапе проверки или фиксации, но еще не зафиксированы.</span><span class="sxs-lookup"><span data-stu-id="862fb-186">During regular processing, a transaction can read rows written by other transactions that are in the validation or commit phase, but have not yet committed.</span></span> <span data-ttu-id="862fb-187">Строки являются видимыми, потому что время логического завершения транзакций назначено в начале этапа проверки.</span><span class="sxs-lookup"><span data-stu-id="862fb-187">The rows are visible because the logical end time of the transactions has been assigned at the start of the validation phase.</span></span>

 <span data-ttu-id="862fb-188">Если транзакция считывает такие незафиксированные строки, то она принимает зависимость фиксации от этой транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-188">If a transaction reads such uncommitted rows, it will take a commit dependency on that transaction.</span></span> <span data-ttu-id="862fb-189">Это имеет два основных следствия.</span><span class="sxs-lookup"><span data-stu-id="862fb-189">This has two main implications:</span></span>

-   <span data-ttu-id="862fb-190">Транзакция не может быть зафиксирована до того, как будет зафиксирована транзакция, от которой она зависит.</span><span class="sxs-lookup"><span data-stu-id="862fb-190">A transaction cannot commit until the transactions it depends on have committed.</span></span> <span data-ttu-id="862fb-191">Другими словами, она не может перейти на этап фиксации до тех пор, пока все зависимости не будут устранены.</span><span class="sxs-lookup"><span data-stu-id="862fb-191">In other words, it cannot enter the commit phase, until all dependencies have cleared.</span></span>

-   <span data-ttu-id="862fb-192">Кроме того, результирующие наборы не возвращаются клиенту, пока все зависимости не будут устранены.</span><span class="sxs-lookup"><span data-stu-id="862fb-192">In addition, result sets are not returned to the client until all dependencies have cleared.</span></span> <span data-ttu-id="862fb-193">Это не позволяет клиенту наблюдать незафиксированные данные.</span><span class="sxs-lookup"><span data-stu-id="862fb-193">This prevents the client from observing uncommitted data.</span></span>

 <span data-ttu-id="862fb-194">Если любые зависимые транзакции не удается зафиксировать, то возникает ошибка зависимости фиксации.</span><span class="sxs-lookup"><span data-stu-id="862fb-194">If any of the dependent transactions fails to commit, there is a commit dependency failure.</span></span> <span data-ttu-id="862fb-195">Это означает, что транзакция не будет зафиксирована с ошибкой 41301 («Предыдущая транзакция, от которой зависит текущая транзакция, прервана, и текущая транзакция не может быть зафиксирована»).</span><span class="sxs-lookup"><span data-stu-id="862fb-195">This means the transaction will fail to commit with error 41301 ("A previous transaction that the current transaction took a dependency on has aborted, and the current transaction can no longer commit.").</span></span>

#### <a name="validation-phase"></a><span data-ttu-id="862fb-196">Стадия проверки</span><span class="sxs-lookup"><span data-stu-id="862fb-196">Validation Phase</span></span>
 <span data-ttu-id="862fb-197">На этапе проверки система проверяет, что допущения, необходимые для запрошенного уровня изоляции транзакций, были истинны в период от логического начала до логического завершения транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-197">During the validation phase, the system validates that the assumptions necessary for the requested transaction isolation level were true between the logical start and logical end of the transaction.</span></span>

 <span data-ttu-id="862fb-198">В начале этапа проверки транзакции назначается время логического завершения.</span><span class="sxs-lookup"><span data-stu-id="862fb-198">At the start of the validation phase, the transaction is assigned a logical end time.</span></span> <span data-ttu-id="862fb-199">Версии строк, созданные в базе данных, становятся видимыми другим транзакциям во время логического завершения.</span><span class="sxs-lookup"><span data-stu-id="862fb-199">The row versions written in the database become visible to other transactions at the logical end time.</span></span> <span data-ttu-id="862fb-200">Дополнительные сведения см. в разделе [фиксация зависимостей](#cd).</span><span class="sxs-lookup"><span data-stu-id="862fb-200">For more information, see [Commit Dependencies](#cd).</span></span>

##### <a name="repeatable-read-validation"></a><span data-ttu-id="862fb-201">Проверка операций чтения с возможностью повторения</span><span class="sxs-lookup"><span data-stu-id="862fb-201">Repeatable Read Validation</span></span>
 <span data-ttu-id="862fb-202">Если уровень изоляции транзакции приемлем для чтения или СЕРИАЛИЗАЦИИ или если доступ к таблицам осуществляется в режиме изоляции REPEATABLE READ или SERIALIZABLE (Дополнительные сведения см. в разделе изоляция отдельных операций в [уровнях изоляции транзакций](../../2014/database-engine/transaction-isolation-levels.md)), система проверяет, что операции чтения являются повторяющимися.</span><span class="sxs-lookup"><span data-stu-id="862fb-202">If the isolation level of the transaction is REPEATABLE READ or SERIALIZABLE, or if tables are accessed under REPEATABLE READ or SERIALIZABLE isolation (for more information, see the section on Isolation of Individual Operations in [Transaction Isolation Levels](../../2014/database-engine/transaction-isolation-levels.md)), the system validates that the reads are repeatable.</span></span> <span data-ttu-id="862fb-203">Это означает проверку, что версии строк, считываемых транзакцией, по-прежнему представляют собой действительные версии строк во время логического конца транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-203">This means it validates that the versions of the rows read by the transaction are still valid row versions at the logical end time of the transaction.</span></span>

 <span data-ttu-id="862fb-204">Если были обновлены или изменены какие-либо строки, транзакции не удается выполнить фиксацию с ошибкой 41305 («Текущей транзакции не удалось выполнить фиксацию из-за ошибки проверки уровня изоляции REPEATABLE READ»).</span><span class="sxs-lookup"><span data-stu-id="862fb-204">If any of the rows have been updated or changed, the transaction fails to commit with error 41305 ("The current transaction failed to commit due to a repeatable read validation failure.").</span></span>

 <span data-ttu-id="862fb-205">Это ошибка может также возникать при удалении таблицы после операции вставки, обновления или удаления и перед фиксацией транзакций.</span><span class="sxs-lookup"><span data-stu-id="862fb-205">This error can also occur if a table is dropped after an insert, update, or delete operation and before the transaction commits.</span></span> <span data-ttu-id="862fb-206">Это применимо только для операций вставки, обновления или удаления в хранимых процедурах, скомпилированных в собственном коде.</span><span class="sxs-lookup"><span data-stu-id="862fb-206">This applies only to insert, update, or delete operations in natively compiled stored procedures.</span></span> <span data-ttu-id="862fb-207">Такие операции записи выполняются, когда интерпретация [!INCLUDE[tsql](../includes/tsql-md.md)] заставляет инструкцию DROP TABLE выполнить блокировку и ждать фиксации транзакции.</span><span class="sxs-lookup"><span data-stu-id="862fb-207">Such write operations performed through interpreted [!INCLUDE[tsql](../includes/tsql-md.md)] cause the DROP TABLE statement to block and wait until the transaction commits.</span></span>

##### <a name="serializable-validation"></a><span data-ttu-id="862fb-208">Сериализуемая проверка</span><span class="sxs-lookup"><span data-stu-id="862fb-208">Serializable Validation</span></span>
 <span data-ttu-id="862fb-209">Сериализуемая проверка выполняется в двух случаях.</span><span class="sxs-lookup"><span data-stu-id="862fb-209">Serializable validation is performed in two cases:</span></span>

-   <span data-ttu-id="862fb-210">Если уровень изоляции транзакции — SERIALIZABLE или доступ к таблицам выполняется в режиме изоляции SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="862fb-210">If the isolation level of the transaction is SERIALIZABLE or tables are accessed under SERIALIZABLE isolation.</span></span>

-   <span data-ttu-id="862fb-211">Если строки вставлены в уникальный индекс, например индекс, созданный для ограничения PRIMARY KEY.</span><span class="sxs-lookup"><span data-stu-id="862fb-211">If rows are inserted in a unique index, such as the index created for a PRIMARY KEY constraint.</span></span> <span data-ttu-id="862fb-212">Система проверяет, что не были одновременно вставлены строки с одинаковым значением ключа.</span><span class="sxs-lookup"><span data-stu-id="862fb-212">The system validates that no rows with the same key have been concurrently inserted.</span></span>

 <span data-ttu-id="862fb-213">Система проверяет, что фантомные строки не были записаны в базу данных.</span><span class="sxs-lookup"><span data-stu-id="862fb-213">The system validates that no phantom rows have been written to the database.</span></span> <span data-ttu-id="862fb-214">Операции считывания, выполняемые транзакцией, оцениваются, чтобы определить, что новые строки не были вставлены в диапазоны просмотра этих операций чтения.</span><span class="sxs-lookup"><span data-stu-id="862fb-214">The read operations performed by the transaction are evaluated to determine that no new rows were inserted in the scan ranges of these read operations.</span></span>

 <span data-ttu-id="862fb-215">Вставка ключа в уникальный индекс включает неявную операцию считывания, чтобы проверить, что ключ не является дубликатом.</span><span class="sxs-lookup"><span data-stu-id="862fb-215">Insertion of a key in a unique index includes an implicit read operation, to determine that the key is not a duplicate.</span></span> <span data-ttu-id="862fb-216">Сериализуемая проверка для уникальных индексов гарантирует, что эти индексы не могут иметь дубликаты в случае, если две транзакции одновременно вставляют один и тот же ключ.</span><span class="sxs-lookup"><span data-stu-id="862fb-216">Serializable validation for unique indexes ensures these indexes cannot have duplicates in case two transactions concurrently insert the same key.</span></span>

 <span data-ttu-id="862fb-217">Если обнаружены фантомные строки, то не удалось выполнить фиксацию транзакции с ошибкой 41325 («Текущей транзакции не удалось выполнить фиксацию из-за ошибки сериализуемой проверки»).</span><span class="sxs-lookup"><span data-stu-id="862fb-217">If phantom rows are detected, the transaction fails to commit with error 41325 ("The current transaction failed to commit due to a serializable validation failure.").</span></span>

#### <a name="commit-processing"></a><span data-ttu-id="862fb-218">Обработка фиксации</span><span class="sxs-lookup"><span data-stu-id="862fb-218">Commit Processing</span></span>
 <span data-ttu-id="862fb-219">Если проверка завершается успешно и все зависимости транзакций разрешены, то транзакция переходит на этап обработки фиксации.</span><span class="sxs-lookup"><span data-stu-id="862fb-219">If validation succeeds and all transaction dependencies clear, the transaction enters the commit processing phase.</span></span> <span data-ttu-id="862fb-220">Во время этого этапа записываются изменения в надежных таблицах в журнал, а журнал сохраняется на диске, чтобы обеспечить надежность.</span><span class="sxs-lookup"><span data-stu-id="862fb-220">During this phase the changes to durable tables are written to the log, and the log is written to disk, to ensure durability.</span></span> <span data-ttu-id="862fb-221">После того как запись журнала для транзакции записана на диск, управление возвращается клиенту.</span><span class="sxs-lookup"><span data-stu-id="862fb-221">Once the log record for the transaction has been written to disk, control is returned to the client.</span></span>

 <span data-ttu-id="862fb-222">Все зависимости фиксации для этой транзакции удаляются, и все транзакции, ожидавшие фиксации этой транзакции, могут быть продолжены.</span><span class="sxs-lookup"><span data-stu-id="862fb-222">All commit dependencies on this transaction are cleared, and all transactions that had been waiting for this transaction to commit can proceed.</span></span>

## <a name="limitations"></a><span data-ttu-id="862fb-223">Ограничения</span><span class="sxs-lookup"><span data-stu-id="862fb-223">Limitations</span></span>

-   <span data-ttu-id="862fb-224">Транзакции между базами данных не поддерживаются с таблицами, оптимизированными для памяти.</span><span class="sxs-lookup"><span data-stu-id="862fb-224">Cross-database transactions are not supported with memory-optimized tables.</span></span> <span data-ttu-id="862fb-225">Каждая транзакция, которая выполняет доступ к оптимизированным для памяти таблицам, не может обращаться более чем к одной базе данных, за исключением доступа на чтение и запись базы данных tempdb и доступа только для чтения к системной базе данных master.</span><span class="sxs-lookup"><span data-stu-id="862fb-225">Every transaction that accesses memory-optimized tables cannot access more than one database, with the exception of read-write access to tempdb and read-only access to the system database master.</span></span>

-   <span data-ttu-id="862fb-226">Распределенные транзакции не поддерживаются с таблицам, оптимизированными для памяти.</span><span class="sxs-lookup"><span data-stu-id="862fb-226">Distributed transactions are not supported with memory-optimized tables.</span></span> <span data-ttu-id="862fb-227">Распределенные транзакции, запускаемые с помощью инструкции BEGIN DISTRIBUTED TRANSACTION, не могут получить доступ к оптимизированным для памяти таблицам.</span><span class="sxs-lookup"><span data-stu-id="862fb-227">Distributed transactions started with BEGIN DISTRIBUTED TRANSACTION cannot access memory-optimized tables.</span></span>

-   <span data-ttu-id="862fb-228">Оптимизированные для памяти таблицы не поддерживают ни один из видов блокировки.</span><span class="sxs-lookup"><span data-stu-id="862fb-228">Memory-optimized tables do not support locking.</span></span> <span data-ttu-id="862fb-229">Явные блокировки через подсказки блокировки (например, TABLOCK, XLOCK, ROWLOCK) не поддерживаются с таблицами, оптимизированными для памяти.</span><span class="sxs-lookup"><span data-stu-id="862fb-229">Explicit locks through locking hints (such as TABLOCK, XLOCK, ROWLOCK) are not supported with memory-optimized tables.</span></span>

## <a name="see-also"></a><span data-ttu-id="862fb-230">См. также:</span><span class="sxs-lookup"><span data-stu-id="862fb-230">See Also</span></span>
 [<span data-ttu-id="862fb-231">Основные сведения о транзакциях с таблицами, оптимизированными для памяти</span><span class="sxs-lookup"><span data-stu-id="862fb-231">Understanding Transactions on Memory-Optimized Tables</span></span>](../../2014/database-engine/understanding-transactions-on-memory-optimized-tables.md)


