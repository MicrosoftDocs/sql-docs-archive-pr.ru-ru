---
title: Оценка прерывания обслуживания во время переключения ролей (зеркальное отображение базы данных) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- parallel redo [SQL Server]
- role switching [SQL Server]
- database mirroring [SQL Server], queues
- failover [SQL Server], database mirroring
- redo [database mirroring]
- database mirroring [SQL Server], failover
ms.assetid: 586a6f25-672b-491b-bc2f-deab2ccda6e2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 283c0dfad8d9f91693ab92ed415b4368dd3f0396
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87655917"
---
# <a name="estimate-the-interruption-of-service-during-role-switching-database-mirroring"></a><span data-ttu-id="1d035-102">Оценка прерывания обслуживания во время переключения ролей (зеркальное отображение базы данных)</span><span class="sxs-lookup"><span data-stu-id="1d035-102">Estimate the Interruption of Service During Role Switching (Database Mirroring)</span></span>
  <span data-ttu-id="1d035-103">Во время переключения ролей интервал времени, в течение которого зеркальное отображение базы данных не будет обслуживаться, зависит от типа переключения ролей и его причины.</span><span class="sxs-lookup"><span data-stu-id="1d035-103">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and the cause of the role switch.</span></span>

-   <span data-ttu-id="1d035-104">Во время автоматической отработки отказа два фактора влияют на время прерывания обслуживания: требуется время, чтобы зеркальный сервер смог определить, что основной экземпляр сервера потерпел неудачу (время обнаружения ошибки), а также требуется время для переключения базы данных (время отработки отказа).</span><span class="sxs-lookup"><span data-stu-id="1d035-104">For automatic failover, two factors contribute to the time service is interrupted: the time required for the mirror server to recognize that the principal server instance has failed, that is error detection, plus the time required to fail over the database, that is failover time.</span></span>

-   <span data-ttu-id="1d035-105">Для операции принудительного обслуживания, хотя выполнение завершилось неудачно, обнаружение и ответ на неудачное выполнение, зависит от реакции пользователя.</span><span class="sxs-lookup"><span data-stu-id="1d035-105">For a forced-service operation, though a failure has occurred, detecting and responding to the failure depends on human responsiveness.</span></span> <span data-ttu-id="1d035-106">Однако оценка потенциального прерывания обслуживания ограничена оценкой времени зеркального сервера для переключения ролей после того, как команда принудительного обслуживания выполнена.</span><span class="sxs-lookup"><span data-stu-id="1d035-106">However, estimating the potential interruption of service is limited to estimating the time for the mirror server to switch roles after the forced service command is issued.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="1d035-107">Чтобы сократить время, требуемое для обнаружения специальных условий, например некоторых типов ошибок, необходимо определить предупреждения для этих условий.</span><span class="sxs-lookup"><span data-stu-id="1d035-107">To reduce the time required to detect specific conditions such as some types of errors, you can define alerts for those conditions.</span></span>

-   <span data-ttu-id="1d035-108">При отработке отказа вручную имеет значение только время перехода на базу данных после выполнения команды отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="1d035-108">For a manual failover, only the time required to fail over the database after the failover command is issued.</span></span>

## <a name="error-detection"></a><span data-ttu-id="1d035-109">Определение ошибки</span><span class="sxs-lookup"><span data-stu-id="1d035-109">Error detection</span></span>
 <span data-ttu-id="1d035-110">Время, за которое система заметит ошибку, зависит от типа ошибки. Например, сетевая ошибка будет замечена практически сразу, а определение того, что сервер не отвечает на запросы, занимает 10 секунд (время ожидания по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="1d035-110">The time for the system to notice an error depends on the type of error; for example, a network error is noticed almost instantly, while noticing a server that is not responding takes 10 seconds (with the default timeout).</span></span>

 <span data-ttu-id="1d035-111">Сведения об ошибках, которые могут вызвать сбой во время сеанса зеркального отображения базы данных, и о времени ожидания обнаружения в режиме высокой безопасности с автоматической отработкой отказа см. в статье [Возможные неполадки при зеркальном отображении базы данных](possible-failures-during-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="1d035-111">For information on errors that can cause a failure during a database mirroring session and timeout detection in high-safety mode with automatic failover, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)).</span></span>

## <a name="failover-time"></a><span data-ttu-id="1d035-112">Время отработки отказа</span><span class="sxs-lookup"><span data-stu-id="1d035-112">Failover time</span></span>
 <span data-ttu-id="1d035-113">Время отработки отказа делится на время, которое необходимо бывшему зеркальному серверу для выполнения наката журналов, оставшихся в его очереди повторов, и на короткое дополнительное время (дополнительные сведения о том, как зеркальный сервер обрабатывает записи журнала, см. в статье [Зеркальное отображение базы данных (SQL Server)](database-mirroring-sql-server.md)).</span><span class="sxs-lookup"><span data-stu-id="1d035-113">Failover time consists mainly of the time that the former mirror server requires to roll forward any log remaining in its redo queue, plus a short additional time (for more information about how the mirror server processes log records, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span> <span data-ttu-id="1d035-114">Сведения об оценке времени отработки отказа см. в статье «Оценка частоты повторов при отработке отказа» далее в этом подразделе.</span><span class="sxs-lookup"><span data-stu-id="1d035-114">For information on estimating failover time, see Estimating Your Failover Redo Rate, later in this topic.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="1d035-115">Если отработка отказа происходит во время транзакции, в которой индекс или таблица созданы и затем изменены, переход может занять больше времени, чем обычно.</span><span class="sxs-lookup"><span data-stu-id="1d035-115">If failover occurs during a transaction in which an index or table is created and then changed, failover might take longer than usual.</span></span>  <span data-ttu-id="1d035-116">Например, время отработки отказа может увеличить следующий ряд операций: BEGIN TRANSACTION, CREATE INDEX для таблицы и SELECT INTO из таблицы.</span><span class="sxs-lookup"><span data-stu-id="1d035-116">For example, failing over during the following series of operations might increase failover time:  BEGIN TRANSACTION, CREATE INDEX on a table, and SELECT INTO the table.</span></span> <span data-ttu-id="1d035-117">Вероятность увеличения времени отработки отказа во время такой транзакции сохраняется, пока она не завершается инструкцией COMMIT TRANSACTION или ROLLBACK TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="1d035-117">The possibility of increased failover time during such a transaction remains until it is completed with either a COMMIT TRANSACTION or ROLLBACK TRANSACTION statement.</span></span>

### <a name="the-redo-queue"></a><span data-ttu-id="1d035-118">Очередь повторов</span><span class="sxs-lookup"><span data-stu-id="1d035-118">The Redo Queue</span></span>
 <span data-ttu-id="1d035-119">Накат базы данных подразумевает применение всех записей журнала, находящихся в очереди повторов зеркального сервера.</span><span class="sxs-lookup"><span data-stu-id="1d035-119">Rolling forward the database involves applying whatever log records are currently in the redo queue on the mirror server.</span></span> <span data-ttu-id="1d035-120">*Очередь повторов* состоит из записей журнала, сохраненных на жестком диске зеркального сервера, накат которых в зеркальной базе данных еще не был выполнен.</span><span class="sxs-lookup"><span data-stu-id="1d035-120">The *redo queue* consists of the log records that have been written to disk on the mirror server but not yet rolled forward on the mirror database.</span></span>

 <span data-ttu-id="1d035-121">Время отработки отказа зависит от того, как быстро зеркальный сервер может выполнить накат журнала в очереди повторов, а это, в свою очередь, зависит, прежде всего, от оборудования системы и текущей рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="1d035-121">Failover time for the database depends on how fast the mirror server can roll forward the log in the redo queue, which, in turn, is determined primarily by the system hardware and the current work load.</span></span> <span data-ttu-id="1d035-122">Теоретически, основная база данных может стать настолько загруженной, что основный сервер будет доставлять журналы на зеркальный сервер быстрее, чем тот сможет выполнять накат.</span><span class="sxs-lookup"><span data-stu-id="1d035-122">Potentially, a principal database can become so busy that the principal server ships log to the mirror server much faster than it can roll the log forward.</span></span> <span data-ttu-id="1d035-123">В этой ситуации отработка отказа может занять значительное время, пока зеркальный сервер не выполнит накат всех журналов в очереди повтора.</span><span class="sxs-lookup"><span data-stu-id="1d035-123">In this situation, failover might take significant time while the mirror server rolls forward the log in the redo queue.</span></span> <span data-ttu-id="1d035-124">Узнать текущий размер очереди повтора можно с помощью счетчика **Очередь повторов** в объекте производительности зеркального отображения.</span><span class="sxs-lookup"><span data-stu-id="1d035-124">To learn the current size of the redo queue, use the **Redo Queue** counter in the database mirroring performance object.</span></span> <span data-ttu-id="1d035-125">Дополнительные сведения см. в статье [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="1d035-125">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

### <a name="estimating-the-failover-redo-rate"></a><span data-ttu-id="1d035-126">Оценка частоты повторов при отработке отказа</span><span class="sxs-lookup"><span data-stu-id="1d035-126">Estimating the Failover Redo Rate</span></span>
 <span data-ttu-id="1d035-127">Количество времени, необходимое для наката записей журнала (*частота повторов*), можно оценить с помощью тестовой копии рабочей базы данных.</span><span class="sxs-lookup"><span data-stu-id="1d035-127">You can measure the amount of time required to roll forward log records-the *redo rate*-by using a test copy of the production database.</span></span>

 <span data-ttu-id="1d035-128">Метод оценки времени наката во время отработки отказа зависит от числа потоков, задействованных на стадии повтора зеркальным сервером.</span><span class="sxs-lookup"><span data-stu-id="1d035-128">The method for estimating roll forward time during failover depends on the number of threads the mirror server uses during the redo phase.</span></span> <span data-ttu-id="1d035-129">Число потоков зависит от следующего:</span><span class="sxs-lookup"><span data-stu-id="1d035-129">The number of threads depends on the following:</span></span>

-   <span data-ttu-id="1d035-130">В выпуске [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)]для наката базы данных зеркальный сервер всегда использует один поток.</span><span class="sxs-lookup"><span data-stu-id="1d035-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], the mirror server always uses a single thread to roll forward the database.</span></span>

-   <span data-ttu-id="1d035-131">в [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)]зеркальные серверы на компьютерах с числом процессоров менее пяти также используют один поток.</span><span class="sxs-lookup"><span data-stu-id="1d035-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], mirror servers on computers with fewer than five CPUs also use only a single thread.</span></span> <span data-ttu-id="1d035-132">Если процессоров пять или более, зеркальный сервер распределяет операции наката во время отработки отказа между несколькими потоками ( *параллельные повторы*).</span><span class="sxs-lookup"><span data-stu-id="1d035-132">With five or more CPUs, a mirror server distributes its roll forward operations among multiple threads during a failover (this is known as *parallel redo*).</span></span> <span data-ttu-id="1d035-133">Параллельные повторы оптимизированы для использования одного потока на каждые четыре процессора.</span><span class="sxs-lookup"><span data-stu-id="1d035-133">Parallel redo is optimized to use one thread for every four CPUs.</span></span>

#### <a name="estimating-the-single-threaded-redo-rate"></a><span data-ttu-id="1d035-134">Оценка частоты однопоточных повторов</span><span class="sxs-lookup"><span data-stu-id="1d035-134">Estimating the Single-Threaded Redo Rate</span></span>
 <span data-ttu-id="1d035-135">При использовании однопоточных повторов накат зеркальной базы данных во время отработки отказа занимает примерно столько же времени, как при восстановлении резервной копии журнала для наката такого же объема записей.</span><span class="sxs-lookup"><span data-stu-id="1d035-135">For single-threaded redo, roll forward of the mirror database during failover takes approximately the same amount of time as a restore of a log backup takes to roll forward the same amount of log.</span></span> <span data-ttu-id="1d035-136">Чтобы оценить время отработки отказа, создайте тестовую базу данных в среде, которая будет использоваться при зеркальном отображении.</span><span class="sxs-lookup"><span data-stu-id="1d035-136">To estimate failover time, create a test database in the environment under which you intend to run mirroring.</span></span> <span data-ttu-id="1d035-137">Затем возьмите резервные копии журналов из рабочей базы данных.</span><span class="sxs-lookup"><span data-stu-id="1d035-137">Then take a log backup from the production database.</span></span> <span data-ttu-id="1d035-138">Чтобы измерить частоту повторов для этих журналов, засеките, сколько времени понадобится для восстановления тестовой базы данных из журналов с параметром WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="1d035-138">To measure the redo rate for that log backup, time how long it takes you to restore the log backup WITH NORECOVERY onto the test database.</span></span>

 <span data-ttu-id="1d035-139">Зная частоту повторов зеркального сервера, можно оценить время, которое понадобится для перехода на другую базу данных в заданный момент времени, разделив объем текущих журналов на зеркальном сервере (этот объем можно измерить с помощью счетчика производительности **Очередь повтора** ) на частоту повторов.</span><span class="sxs-lookup"><span data-stu-id="1d035-139">Once you know the redo rate of your mirror server, you can estimate the time to fail over the database at a given point in time by dividing the amount of current log to be redone on the mirror (as measured by the **Redo Queue** performance counter) by the redo rate.</span></span> <span data-ttu-id="1d035-140">В нормальных условиях, если зеркальный сервер справляется с нагрузкой с основного сервера, значение счетчика **Очередь повтора** очень мало или близко к нулю, а отработка отказа занимает несколько секунд.</span><span class="sxs-lookup"><span data-stu-id="1d035-140">Under normal conditions, if the mirror server can keep up with the load from the principal, the **Redo Queue** is small or close to zero, and a failover only takes a few seconds.</span></span>

#### <a name="estimating-the-parallel-redo-rate"></a><span data-ttu-id="1d035-141">Оценка частоты параллельных повторов</span><span class="sxs-lookup"><span data-stu-id="1d035-141">Estimating the Parallel Redo Rate</span></span>
 <span data-ttu-id="1d035-142">В [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)]параллельные повторы оптимизированы для использования одного потока на каждые четыре процессора.</span><span class="sxs-lookup"><span data-stu-id="1d035-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], parallel redo is optimized to use one thread for every four CPUs.</span></span> <span data-ttu-id="1d035-143">Чтобы оценить время наката параллельных повторов, лучше использовать работающую тестовую систему, а не тестовую базу данных.</span><span class="sxs-lookup"><span data-stu-id="1d035-143">To estimate roll forward time for parallel redo, it is more accurate to access a running test system than a test database.</span></span> <span data-ttu-id="1d035-144">Наблюдая за очередью повтора на зеркальном сервере, увеличьте нагрузку на основной сервер.</span><span class="sxs-lookup"><span data-stu-id="1d035-144">While monitoring the redo queue on the mirror server, increase the load on the principal server.</span></span> <span data-ttu-id="1d035-145">В нормальных условиях очередь повтора будет близка к нулю.</span><span class="sxs-lookup"><span data-stu-id="1d035-145">In normal operation, the redo queue is close to zero.</span></span> <span data-ttu-id="1d035-146">Увеличьте нагрузку на основной сервер, пока очередь повтора не начнет постоянно расти; система будет находиться на пике частоты повторов, а счетчик производительности **Повтор байты/с** в этот момент будет показывать максимальное значение частоты повторов.</span><span class="sxs-lookup"><span data-stu-id="1d035-146">Increase the load on the principal server until the Redo Queue starts to grow continuously; the system is then at its maximum redo rate, and the **Redo Bytes/sec** performance counter at this point represents the maximum redo rate.</span></span> <span data-ttu-id="1d035-147">Дополнительные сведения см. в статье [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="1d035-147">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

## <a name="estimating-interruption-of-service-during-automatic-failover"></a><span data-ttu-id="1d035-148">Оценка прерывания обслуживания во время автоматической отработки отказа</span><span class="sxs-lookup"><span data-stu-id="1d035-148">Estimating Interruption of Service During Automatic Failover</span></span>
 <span data-ttu-id="1d035-149">На следующем рисунке показан вклад времени определения ошибки и времени отработки отказа в общее время, требуемое для завершения автоматического перехода на сервер **Partner_B**.</span><span class="sxs-lookup"><span data-stu-id="1d035-149">The following figure illustrates how error detection and failover time contribute to the overall time required for an automatic failover to complete on **Partner_B**.</span></span> <span data-ttu-id="1d035-150">При отработке отказа требуется время для наката базы данных (стадия повтора) плюс короткое время для перевода базы данных в режим в сети.</span><span class="sxs-lookup"><span data-stu-id="1d035-150">Failover requires time to roll forward the database (the redo phase) plus a small amount of time to bring the database online.</span></span> <span data-ttu-id="1d035-151">Стадия отката, когда выполняются откаты всех незафиксированных транзакций, происходит после того, как новая основная база данных переходит в режим в сети и продолжает работу после перехода.</span><span class="sxs-lookup"><span data-stu-id="1d035-151">The undo phase, which involves rolling back any uncommitted transactions, occurs after the new principal database goes online and continues after fail over.</span></span> <span data-ttu-id="1d035-152">Во время стадии отката база данных доступна.</span><span class="sxs-lookup"><span data-stu-id="1d035-152">The database is available during the undo phase.</span></span>

 <span data-ttu-id="1d035-153">![Время определения ошибки и отработки отказа](../media/dbm-failovauto-time.gif "Время определения ошибки и отработки отказа")</span><span class="sxs-lookup"><span data-stu-id="1d035-153">![Error detection and failover time](../media/dbm-failovauto-time.gif "Error detection and failover time")</span></span>

## <a name="see-also"></a><span data-ttu-id="1d035-154">См. также:</span><span class="sxs-lookup"><span data-stu-id="1d035-154">See Also</span></span>
 <span data-ttu-id="1d035-155">Переключение ролей [режима работы зеркального отображения базы](database-mirroring-operating-modes.md) данных [во время сеанса зеркального отображения базы данных &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [мониторинг зеркального отображения базы данных &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="1d035-155">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span></span>


