---
title: Возможные неполадки при зеркальном отображении базы данных | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- time-out period [SQL Server database mirroring]
- soft errors [SQL Server]
- database mirroring [SQL Server], troubleshooting
- timeout errors [SQL Server]
- troubleshooting [SQL Server], database mirroring
- hard errors
- failed database mirroring sessions [SQL Server]
ms.assetid: d7031f58-5f49-4e6d-9a62-9b420f2bb17e
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 25ba1ccc87c024fa3da370f2ff19251a1bee9f30
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87733106"
---
# <a name="possible-failures-during-database-mirroring"></a><span data-ttu-id="b8452-102">Possible Failures During Database Mirroring</span><span class="sxs-lookup"><span data-stu-id="b8452-102">Possible Failures During Database Mirroring</span></span>
  <span data-ttu-id="b8452-103">К сбою во время сеанса зеркального отображения базы данных могут привести различные физические неисправности, ошибки операционной системы или ошибки [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="b8452-103">Physical, operating system, or [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] problems can cause a failure in a database mirroring session.</span></span> <span data-ttu-id="b8452-104">Сеанс зеркального отображения базы данных не выполняет активных проверок компонентов, на которые опирается процесс Sqlservr.exe, и не контролирует правильность их работы.</span><span class="sxs-lookup"><span data-stu-id="b8452-104">Database mirroring does not regularly check the components on which Sqlservr.exe relies to verify whether they are functioning correctly or have failed.</span></span> <span data-ttu-id="b8452-105">Однако при сбоях некоторых типов затронутый компонент сообщает приложению Sqlservr.exe об ошибке.</span><span class="sxs-lookup"><span data-stu-id="b8452-105">However, for some types of failures, the affected component reports an error to Sqlservr.exe.</span></span> <span data-ttu-id="b8452-106">Ошибка, о которой сообщил другой компонент, называется *постоянной ошибкой*.</span><span class="sxs-lookup"><span data-stu-id="b8452-106">An error reported by another component is called a *hard error*.</span></span> <span data-ttu-id="b8452-107">Чтобы обнаружить другие сбои, которые в противном случае могли быть не замечены, для зеркального отображения базы данных реализован собственный механизм ожидания.</span><span class="sxs-lookup"><span data-stu-id="b8452-107">To detect other failures that would otherwise go unnoticed, database mirroring implements its own time-out mechanism.</span></span> <span data-ttu-id="b8452-108">По истечении времени ожидания для зеркального отображения базы данных предполагается, что произошел сбой и объявляется *кратковременная ошибка*.</span><span class="sxs-lookup"><span data-stu-id="b8452-108">When a mirroring time-out occurs, database mirroring assumes that a failure has occurred and declares a *soft error*.</span></span> <span data-ttu-id="b8452-109">Однако некоторые ошибки, которые возникают на уровне экземпляра SQL Server, не превышают времени ожидания зеркального отображения и поэтому не обнаруживаются.</span><span class="sxs-lookup"><span data-stu-id="b8452-109">However, some failures that happen at the SQL Server instance level do not cause mirroring to time-out and can go undetected.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="b8452-110">Ошибки баз данных, кроме ошибок в зеркальной базе данных, невозможно выявить в сеансе зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="b8452-110">Failures in databases other than the mirrored database are not detectable in a database mirroring session.</span></span> <span data-ttu-id="b8452-111">Более того, весьма проблематично будет обнаружить сбой диска данных, если только база данных не перезапускается вследствие такого сбоя.</span><span class="sxs-lookup"><span data-stu-id="b8452-111">Moreover, a data disk failure is unlikely to be detected, unless the database is restarted because of a data disk failure.</span></span>  
  
 <span data-ttu-id="b8452-112">Время обнаружения и, следовательно, время реакции на ошибку в сеансе зеркального отображения зависят от типа ошибки: постоянная или кратковременная.</span><span class="sxs-lookup"><span data-stu-id="b8452-112">The speed of error detection and, therefore, the reaction time of the mirroring session to a failure, depends on whether the error is hard or soft.</span></span> <span data-ttu-id="b8452-113">Отчеты о некоторых постоянных ошибках, таких как сбои в сети, отправляются немедленно.</span><span class="sxs-lookup"><span data-stu-id="b8452-113">Some hard errors, such as network failures are reported immediately.</span></span> <span data-ttu-id="b8452-114">Однако в некоторых случаях зависящие от компонента периоды ожидания могут отложить отправку отчета о некоторых постоянных ошибках.</span><span class="sxs-lookup"><span data-stu-id="b8452-114">However, in some cases, component-specific time-out periods can delay the reporting of some hard errors.</span></span> <span data-ttu-id="b8452-115">В случае краткосрочных ошибок, длина времени ожидания зеркала определяется скоростью определения ошибок.</span><span class="sxs-lookup"><span data-stu-id="b8452-115">For soft errors, the length of the mirroring time-out period determines the speed of error detection.</span></span> <span data-ttu-id="b8452-116">По умолчанию, это период равен 10 секундам.</span><span class="sxs-lookup"><span data-stu-id="b8452-116">By default, this period is 10 seconds.</span></span> <span data-ttu-id="b8452-117">Это минимальное рекомендуемое значение.</span><span class="sxs-lookup"><span data-stu-id="b8452-117">This is the minimum recommended value.</span></span>  
  
## <a name="failures-due-to-hard-errors"></a><span data-ttu-id="b8452-118">Сбои из-за постоянных ошибок</span><span class="sxs-lookup"><span data-stu-id="b8452-118">Failures Due to Hard Errors</span></span>  
 <span data-ttu-id="b8452-119">Постоянные ошибки могут быть вызваны следующими причинами (но не ограничиваются ими):</span><span class="sxs-lookup"><span data-stu-id="b8452-119">Possible causes of hard errors include (but are not limited to) the following conditions:</span></span>  
  
-   <span data-ttu-id="b8452-120">физический разрыв соединения или кабеля;</span><span class="sxs-lookup"><span data-stu-id="b8452-120">A broken connection or wire</span></span>  
  
-   <span data-ttu-id="b8452-121">неисправная сетевая плата;</span><span class="sxs-lookup"><span data-stu-id="b8452-121">A bad network card</span></span>  
  
-   <span data-ttu-id="b8452-122">изменение настроек маршрутизатора;</span><span class="sxs-lookup"><span data-stu-id="b8452-122">A router change</span></span>  
  
-   <span data-ttu-id="b8452-123">изменения в конфигурации брандмауэра;</span><span class="sxs-lookup"><span data-stu-id="b8452-123">Changes in the firewall</span></span>  
  
-   <span data-ttu-id="b8452-124">изменения в конфигурации конечной точки;</span><span class="sxs-lookup"><span data-stu-id="b8452-124">Endpoint reconfiguration</span></span>  
  
-   <span data-ttu-id="b8452-125">выход из строя накопителя, на котором находятся журналы транзакций;</span><span class="sxs-lookup"><span data-stu-id="b8452-125">Loss of the drive where the transaction log resides</span></span>  
  
-   <span data-ttu-id="b8452-126">сбой операционной системы или процесса.</span><span class="sxs-lookup"><span data-stu-id="b8452-126">Operating system or process failure</span></span>  
  
 <span data-ttu-id="b8452-127">Например: если устройство, на котором ведется журнал основной базы данных, не отвечает и отказывает, операционная система сообщает процессу Sqlservr.exe о возникновении серьезной ошибки.</span><span class="sxs-lookup"><span data-stu-id="b8452-127">For example, when the log drive on the principal database becomes unresponsive and fails, the operating system informs Sqlservr.exe that a serious error has occurred.</span></span>  
  
 <span data-ttu-id="b8452-128">Некоторые компоненты, например сетевые компоненты и ряд подсистем ввода-вывода, имеют собственные интервалы ожидания, предназначенные для выявления отказов.</span><span class="sxs-lookup"><span data-stu-id="b8452-128">Some components, such as network components and some IO subsystems, have their own time-outs to determine failures.</span></span> <span data-ttu-id="b8452-129">Некоторые интервалы ожидания не зависят от зеркального отображения базы данных, у которой совершенно нет сведений ни о них, ни об их поведении.</span><span class="sxs-lookup"><span data-stu-id="b8452-129">Such time-outs are independent of database mirroring, which has no knowledge of them and is completely unaware of their behavior.</span></span> <span data-ttu-id="b8452-130">В этих случаях интервал ожидания увеличивает время между возникновением сбоя и получением зеркалом базы данных итоговой постоянной ошибки.</span><span class="sxs-lookup"><span data-stu-id="b8452-130">In these cases, the time-out delay increases the time between a failure and when database mirroring receive the resulting hard error.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="b8452-131">Единственным случаем, когда для сеанса зеркального отображения базы данных выполняется активная проверка на ошибки, являются кратковременные ошибки.</span><span class="sxs-lookup"><span data-stu-id="b8452-131">The only active error checking performed for database mirroring occurs for soft error cases.</span></span> <span data-ttu-id="b8452-132">Дополнительные сведения см. в подразделе «Сбои из-за кратковременных ошибок» далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="b8452-132">For more information, see "Failures Due to Soft Errors," later in this topic.</span></span>  
  
 <span data-ttu-id="b8452-133">Чтобы помочь интерпретировать условия возникновения ошибок в сети, спросите у инженера сети, какие сообщения об ошибках отправляются на порт перед возникновением следующих событий в соединении TCP.</span><span class="sxs-lookup"><span data-stu-id="b8452-133">To help you interpret the error conditions that occur on the network, ask a network engineer what error messages are sent to a port when the following events occur on a TCP connection:</span></span>  
  
-   <span data-ttu-id="b8452-134">DNS не работает.</span><span class="sxs-lookup"><span data-stu-id="b8452-134">DNS is not working.</span></span>  
  
-   <span data-ttu-id="b8452-135">Выдернуты кабели.</span><span class="sxs-lookup"><span data-stu-id="b8452-135">Cables are unplugged.</span></span>  
  
-   [!INCLUDE[msCoName](../../includes/msconame-md.md)] <span data-ttu-id="b8452-136">Windows, блокирующий указанный порт.</span><span class="sxs-lookup"><span data-stu-id="b8452-136">Windows has a firewall that blocks a specific port.</span></span>  
  
-   <span data-ttu-id="b8452-137">Ошибка приложения, наблюдающего за портом.</span><span class="sxs-lookup"><span data-stu-id="b8452-137">The application that is monitoring a port fails.</span></span>  
  
-   <span data-ttu-id="b8452-138">Переименован сервер Windows.</span><span class="sxs-lookup"><span data-stu-id="b8452-138">A Windows-based server is renamed.</span></span>  
  
-   <span data-ttu-id="b8452-139">Перезагружен сервер Windows.</span><span class="sxs-lookup"><span data-stu-id="b8452-139">A Windows-based server is rebooted.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="b8452-140">Зеркальное отображение не защищает от проблем, связанных с доступом клиентов к серверу.</span><span class="sxs-lookup"><span data-stu-id="b8452-140">Mirroring does not protect against problems specific to client accessing the servers.</span></span> <span data-ttu-id="b8452-141">Например, рассмотрите ситуацию, в которой публичный сетевой адаптер обрабатывает подключения клиентов к экземпляру основного сервера, в то время как частная сетевая карта обрабатывает весь трафик зеркального отображения между экземплярами серверов.</span><span class="sxs-lookup"><span data-stu-id="b8452-141">For example, consider a case in which a public network adapter handles client connections to the principal server instance, while a private network interface card handles all mirroring traffic among server instances.</span></span> <span data-ttu-id="b8452-142">В этом случае сбой публичного сетевого адаптера приведет к запрету доступа к базе данных, в то время как зеркалирование базы данных будет продолжать работать.</span><span class="sxs-lookup"><span data-stu-id="b8452-142">In this case, failure of the public network adapter would prevent clients from accessing the database, though the database would continue to be mirrored.</span></span>  
  
## <a name="failures-due-to-soft-errors"></a><span data-ttu-id="b8452-143">Сбои из-за кратковременных ошибок</span><span class="sxs-lookup"><span data-stu-id="b8452-143">Failures Due to Soft Errors</span></span>  
 <span data-ttu-id="b8452-144">Условия, приводящие к превышению времени ожидания при зеркальном отображении, могут быть вызваны следующими причинами (но не ограничиваются ими).</span><span class="sxs-lookup"><span data-stu-id="b8452-144">Conditions that might cause mirroring time-outs include (but are not limited to) the following:</span></span>  
  
-   <span data-ttu-id="b8452-145">Сетевые ошибки (истечение времени ожидания канала связи TCP, пропущенные или искаженные пакеты, поступление пакетов в неверном порядке).</span><span class="sxs-lookup"><span data-stu-id="b8452-145">Network errors such as TCP link time-outs, dropped or corrupted packets, or packets that are in an incorrect order.</span></span>  
  
-   <span data-ttu-id="b8452-146">Операционная система, сервер или база данных не отвечает на запросы.</span><span class="sxs-lookup"><span data-stu-id="b8452-146">An operating system, server, or database that is not responding.</span></span>  
  
-   <span data-ttu-id="b8452-147">Время ожидания сервера Windows.</span><span class="sxs-lookup"><span data-stu-id="b8452-147">A Windows server timing out.</span></span>  
  
-   <span data-ttu-id="b8452-148">Нехватка вычислительных ресурсов (например, из-за перегрузки ЦП или диска, переполнения журнала транзакций, переполнения памяти или превышения числа потоков).</span><span class="sxs-lookup"><span data-stu-id="b8452-148">Insufficient computing resources, such as a CPU or disk overload, the transaction log filling up, or the system is running out of memory or threads.</span></span> <span data-ttu-id="b8452-149">В таких случаях необходимо увеличить время ожидания, снизить рабочую нагрузку или сменить оборудование, чтобы оно соответствовало задачам, выполняемым системой.</span><span class="sxs-lookup"><span data-stu-id="b8452-149">In these cases, you must increase the time-out period, reduce the workload, or change the hardware to handle the workload.</span></span>  
  
### <a name="the-mirroring-time-out-mechanism"></a><span data-ttu-id="b8452-150">Механизм ожидания при зеркальном отображении</span><span class="sxs-lookup"><span data-stu-id="b8452-150">The Mirroring Time-Out Mechanism</span></span>  
 <span data-ttu-id="b8452-151">Так как экземпляр сервера не в состоянии выявить кратковременные ошибки, они потенциально могут заставить экземпляр сервера бесконечно ожидать ответа.</span><span class="sxs-lookup"><span data-stu-id="b8452-151">Because soft errors are not detectable directly by a server instance, a soft error could potentially cause a server instance to wait indefinitely.</span></span> <span data-ttu-id="b8452-152">Для предотвращения такого поведения в сеансе зеркального отображения базы данных используется механизм ожидания, основанный на том, что каждый экземпляр сервера, участвующий в сеансе, через заданный промежуток времени посылает сообщение PING по всем открытым соединениям.</span><span class="sxs-lookup"><span data-stu-id="b8452-152">To prevent this, database mirroring implements its own time-out mechanism, based on each server instance in a mirroring session sending out a ping on each open connection at a fixed interval.</span></span>  
  
 <span data-ttu-id="b8452-153">Чтобы поддерживать соединение открытым, экземпляр сервера должен получить по нему сообщение PING в течение времени ожидания, заданного интервалом ожидания в сеансе зеркального отображения базы данных, плюс время, необходимое для отправки еще одного сообщения PING.</span><span class="sxs-lookup"><span data-stu-id="b8452-153">To keep a connection open, a server instance must receive a ping on that connection in the time-out period defined, plus the time that is required to send one more ping.</span></span> <span data-ttu-id="b8452-154">Получение сообщения PING до истечения интервала ожидания указывает на то, что соединение все еще открыто, и что экземпляры сервера поддерживают связь по нему.</span><span class="sxs-lookup"><span data-stu-id="b8452-154">Receiving a ping during the time-out period indicates that the connection is still open and that the server instances are communicating over it.</span></span> <span data-ttu-id="b8452-155">При получении сообщения PING экземпляр сервера сбрасывает таймер ожидания для этого соединения.</span><span class="sxs-lookup"><span data-stu-id="b8452-155">On receiving a ping, a server instance resets its time-out counter on that connection.</span></span>  
  
 <span data-ttu-id="b8452-156">Если до истечения интервала ожидания сообщение PING не пришло, экземпляр сервера считает, что для соединения наступил тайм-аут. После этого экземпляр сервера закрывает соединение, для которого время ожидания истекло, и обрабатывает событие истечения времени ожидания в соответствии с состоянием и режимом работы сеанса.</span><span class="sxs-lookup"><span data-stu-id="b8452-156">If no ping is received on a connection during the time-out period, a server instance considers the connection to have timed out. The server instance closes the timed-out connection and handles the time-out event according to the state and operating mode of the session.</span></span>  
  
 <span data-ttu-id="b8452-157">Истечение времени ожидания будет считаться сбоем даже в том случае, если фактически другой сервер работает нормально.</span><span class="sxs-lookup"><span data-stu-id="b8452-157">Even if the other server is actually proceeding correctly, a time-out is considered a failure.</span></span> <span data-ttu-id="b8452-158">Если время ожидания для сеанса установлено слишком коротким и не позволяет поддерживать нормальное реагирование какого-либо из участников, возникают ложные сбои.</span><span class="sxs-lookup"><span data-stu-id="b8452-158">If the time-out value for a session is too short for the regular responsiveness of either partner, false failures can occur.</span></span> <span data-ttu-id="b8452-159">Ложные сбои возникают, когда один экземпляр сервера успешно обращается к другому, время отклика которого настолько велико, что его сообщения PING не успевают дойти до истечения времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="b8452-159">A false failure occurs when one server instance successfully contacts another whose response time is so slow that its pings are not received before the time-out period expires.</span></span>  
  
 <span data-ttu-id="b8452-160">В сеансах высокопроизводительного режима тайм-аут всегда равен 10 секундам.</span><span class="sxs-lookup"><span data-stu-id="b8452-160">In high-performance mode sessions, the time-out period is always 10 seconds.</span></span> <span data-ttu-id="b8452-161">Обычно этого достаточно для избегания ложных сбоев.</span><span class="sxs-lookup"><span data-stu-id="b8452-161">This is generally enough to avoid false failures.</span></span> <span data-ttu-id="b8452-162">В сеансах режима высокой безопасности установленный по умолчанию тайм-аут равен 10 секундам, но его длительность можно изменить.</span><span class="sxs-lookup"><span data-stu-id="b8452-162">In high-safety mode sessions, the default time-out period is 10 seconds, but you can change the duration.</span></span> <span data-ttu-id="b8452-163">Во избежание ложных сбоев рекомендуется установить тайм-аут зеркалирование равным 1- секундам или выше.</span><span class="sxs-lookup"><span data-stu-id="b8452-163">To avoid false failures, we recommend that the mirroring time-out period always be 10 seconds or more.</span></span>  
  
 <span data-ttu-id="b8452-164">**Изменение величины тайм-аута (только в режиме высокой безопасности)**</span><span class="sxs-lookup"><span data-stu-id="b8452-164">**To change the time-out value (high-safety mode only)**</span></span>  
  
-   <span data-ttu-id="b8452-165">Используйте инструкцию [ALTER DATABASE \<database> SET PARTNER TIMEOUT \<integer>](/sql/t-sql/statements/alter-database-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="b8452-165">Use the [ALTER DATABASE \<database> SET PARTNER TIMEOUT \<integer>](/sql/t-sql/statements/alter-database-transact-sql) statement.</span></span>  
  
 <span data-ttu-id="b8452-166">**Просмотр текущего значения времени ожидания**</span><span class="sxs-lookup"><span data-stu-id="b8452-166">**To view the current time-out value**</span></span>  
  
-   <span data-ttu-id="b8452-167">Запрос **mirroring_connection_timeout** в [sys.database_mirroring](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="b8452-167">Query **mirroring_connection_timeout** in [sys.database_mirroring](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
## <a name="responding-to-an-error"></a><span data-ttu-id="b8452-168">Реакция на ошибку</span><span class="sxs-lookup"><span data-stu-id="b8452-168">Responding to an Error</span></span>  
 <span data-ttu-id="b8452-169">Независимо от типа ошибки, экземпляр сервера, который обнаружил ее, реагирует в соответствии со своей ролью, режимом работы сеанса и состоянием других соединений того же сеанса.</span><span class="sxs-lookup"><span data-stu-id="b8452-169">Regardless of the type of error, a server instance that detects an error responds appropriately based on the role of the instance, the operating mode of the session, and the state of any other connection in the session.</span></span> <span data-ttu-id="b8452-170">Сведения о том, что происходит при потере участника, см. в разделе [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span><span class="sxs-lookup"><span data-stu-id="b8452-170">For information about what occurs on the loss of a partner, see [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="b8452-171">См. также:</span><span class="sxs-lookup"><span data-stu-id="b8452-171">See Also</span></span>  
 <span data-ttu-id="b8452-172">[Оценка прерывания обслуживания во время переключения ролей (зеркальное отображение базы данных)](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md) </span><span class="sxs-lookup"><span data-stu-id="b8452-172">[Estimate the Interruption of Service During Role Switching &#40;Database Mirroring&#41;](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md) </span></span>  
 <span data-ttu-id="b8452-173">[Режимы работы зеркального отображения базы данных](database-mirroring-operating-modes.md) </span><span class="sxs-lookup"><span data-stu-id="b8452-173">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) </span></span>  
 <span data-ttu-id="b8452-174">[Переключение ролей во время сеанса зеркального отображения базы данных (SQL Server)](role-switching-during-a-database-mirroring-session-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="b8452-174">[Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) </span></span>  
 [<span data-ttu-id="b8452-175">Зеркальное отображение базы данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="b8452-175">Database Mirroring &#40;SQL Server&#41;</span></span>](database-mirroring-sql-server.md)  
  
  
