---
title: Подключение клиентов к сеансу зеркального отображения базы данных (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- partners [SQL Server], connecting clients to
- database mirroring [SQL Server], connecting clients to
- client connections [SQL Server], database mirroring
- connections [SQL Server], database mirroring
ms.assetid: 0d5d2742-2614-43de-9ab9-864addb6299b
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 16faa8d02a22fba3e4cfa4cbe0bd6558fc140fdd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87657290"
---
# <a name="connect-clients-to-a-database-mirroring-session-sql-server"></a><span data-ttu-id="3a988-102">Подключение клиентов к сеансу зеркального отображения базы данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="3a988-102">Connect Clients to a Database Mirroring Session (SQL Server)</span></span>
  <span data-ttu-id="3a988-103">Чтобы подключиться к сеансу зеркального отображения базы данных, клиент может использовать либо программу собственного клиента [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , либо поставщика данных .NET Framework для [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="3a988-103">To connect to a database mirroring session, a client can use either [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client or .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="3a988-104">Если эти поставщики доступа к данным настроены для использования базы данных [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] , то они поддерживают зеркальное отображение базы данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-104">When configured for a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database, these data access providers both fully support database mirroring.</span></span> <span data-ttu-id="3a988-105">Дополнительные сведения о замечаниях по программированию при использовании зеркальной базы данных см. в разделе [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="3a988-105">For information about programming considerations for using a mirrored database, see [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md).</span></span> <span data-ttu-id="3a988-106">Кроме того, текущий экземпляр основного сервера должен быть доступен, и имя входа клиента должно быть создано на экземпляре сервера.</span><span class="sxs-lookup"><span data-stu-id="3a988-106">In addition, the current principal server instance must be available and the login of the client must have been created on the server instance.</span></span> <span data-ttu-id="3a988-107">Дополнительные сведения см. в статье [Диагностика пользователей, утративших связь с учетной записью (SQL Server)](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3a988-107">For more information, see [Troubleshoot Orphaned Users &#40;SQL Server&#41;](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md).</span></span> <span data-ttu-id="3a988-108">Клиентские соединения с сеансом зеркального отображения базы данных не задействуют экземпляр следящего сервера, если он существует.</span><span class="sxs-lookup"><span data-stu-id="3a988-108">Client connections to a database mirroring session do not involve the witness server instance, if one exists.</span></span>  
  
 ##  <a name="making-the-initial-connection-to-a-database-mirroring-session"></a><a name="InitialConnection"></a> <span data-ttu-id="3a988-109">Установка первоначального соединения с сеансом зеркального отображения базы данных</span><span class="sxs-lookup"><span data-stu-id="3a988-109">Making the Initial Connection to a Database Mirroring Session</span></span>  
 <span data-ttu-id="3a988-110">Чтобы выполнить первоначальное соединение с отображаемой базой данных, клиент должен предоставить строку соединения, которая обязательно содержит имя экземпляра сервера.</span><span class="sxs-lookup"><span data-stu-id="3a988-110">For the initial connection to a mirrored database, a client must supply a connection string that minimally supplies the name of a server instance.</span></span> <span data-ttu-id="3a988-111">Это необходимое имя сервера должно идентифицировать текущий экземпляр основного сервера, и называется *имя изначального участника*.</span><span class="sxs-lookup"><span data-stu-id="3a988-111">This required server name should identify the current principal server instance and is known as the *initial partner name*.</span></span>  
  
 <span data-ttu-id="3a988-112">При необходимости строка соединения может также содержать имя другого экземпляра сервера, которое идентифицирует текущий экземпляр зеркального сервера, используемого в том случае, когда изначальный участник недоступен во время первой попытки соединения.</span><span class="sxs-lookup"><span data-stu-id="3a988-112">Optionally, the connection string can also supply the name of another server instance, which should identify the current mirror server instance, for use if the initial partner is unavailable during the first connection attempt.</span></span> <span data-ttu-id="3a988-113">Второе имя называется *именем партнера по обеспечению отработки отказа*.</span><span class="sxs-lookup"><span data-stu-id="3a988-113">The second name is known as the *failover partner name*.</span></span>  
  
 <span data-ttu-id="3a988-114">В строке соединения должно также содержаться имя базы данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-114">The connection string must also supply a database name.</span></span> <span data-ttu-id="3a988-115">Это необходимо, чтобы предоставить возможность поставщику доступа к данным пытаться совершать отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-115">This is necessary to enable failover attempts by the data access provider.</span></span>  
  
 <span data-ttu-id="3a988-116">После получения строки соединения поставщик доступа к данным сохраняет имя изначального участника и имя партнера по обеспечению отработки отказа (если оно приведено) в кэше в энергозависимой памяти (для управляемого кода кэш содержится в домене приложения).</span><span class="sxs-lookup"><span data-stu-id="3a988-116">On receiving a connection string, the data access provider stores the initial partner name and the failover partner name, if supplied, in a cache in the client's volatile memory (for managed code, the cache is scoped to the application domain).</span></span> <span data-ttu-id="3a988-117">После кэширования имя изначального участника поставщиком доступа к данным не обновляется.</span><span class="sxs-lookup"><span data-stu-id="3a988-117">Once cached, the initial partner name is never updated by the data access provider.</span></span> <span data-ttu-id="3a988-118">Если клиент предоставляет имя участника отработки отказа, то в случае, если поставщик доступа к данным не может подключиться с использованием имени изначального участника, поставщик также сохраняет имя партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-118">When the client supplies the failover partner name, the data access provider also stores this failover partner name temporarily in case the provider cannot connect using the initial partner name.</span></span>  
  
 <span data-ttu-id="3a988-119">Сеанс зеркального отображения базы данных не обеспечивает защиты от проблем, связанных с доступом клиента к серверам, например если компьютер клиента испытывает проблемы во взаимодействии с сетью.</span><span class="sxs-lookup"><span data-stu-id="3a988-119">A database mirroring session does not protect against server-access problems that are specific to clients, such as when a client computer is having a problems communicating with the network.</span></span> <span data-ttu-id="3a988-120">Попытка соединения с отображаемой базой может завершиться неудачно по множеству причин, не относящихся к поставщику доступа к данным, например попытка соединения может оказаться неудачной, если экземпляр основного сервера неактивен; это происходит, когда выполняется переход на другую базу данных, или по причине ошибки в сети.</span><span class="sxs-lookup"><span data-stu-id="3a988-120">A connection attempt to a mirrored database can also fail for a variety of reasons that are unrelated to the data-access provider; for example, a connection attempt can fail because the principal server instance is inactive, as occurs when the database is failing over, or because of a network error.</span></span>  
  
 <span data-ttu-id="3a988-121">При попытке подключения поставщик доступа к данным пытается подключиться сначала с помощью имени изначального участника.</span><span class="sxs-lookup"><span data-stu-id="3a988-121">When attempting to connect, the data access provider begins by using the initial partner name.</span></span> <span data-ttu-id="3a988-122">Если указанный экземпляр сервера доступен и является текущим экземпляром основного сервера, то попытка соединения обычно завершается успешно.</span><span class="sxs-lookup"><span data-stu-id="3a988-122">If the specified server instance is available and is the current principal server instance, the connection attempt typically succeeds.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-123">Если сеанс зеркального отображения приостановлен, то клиент обычно подключается к основному серверу и загружает имя участника.</span><span class="sxs-lookup"><span data-stu-id="3a988-123">If the mirroring session is paused, the client typically connects to the principal server and the downloads the partner name.</span></span> <span data-ttu-id="3a988-124">Однако база данных не будет доступна клиенту до тех пор, пока не возобновится процесс зеркального отображения.</span><span class="sxs-lookup"><span data-stu-id="3a988-124">However, the database is unavailable to the client until mirroring resumes.</span></span>  
  
 <span data-ttu-id="3a988-125">Если попытка завершилась неудачей, поставщик доступа к данным пытается подключиться с помощью имени партнера по обеспечению отработки отказа, если оно доступно.</span><span class="sxs-lookup"><span data-stu-id="3a988-125">If that attempt does not work, the data access provider tries the failover partner name, if available.</span></span> <span data-ttu-id="3a988-126">Если имя другого участника правильно идентифицирует текущий основной сервер, то поставщику доступа к данным обычно удается открыть первоначальное соединение.</span><span class="sxs-lookup"><span data-stu-id="3a988-126">If either partner name correctly identifies the current principal server, the data access provider normally succeeds in opening the initial connection.</span></span> <span data-ttu-id="3a988-127">После завершения данного соединения поставщик доступа к данным загружает имя экземпляра текущего зеркального сервера.</span><span class="sxs-lookup"><span data-stu-id="3a988-127">On completing this connection, the data access provider downloads the server instance name of the current mirror server.</span></span> <span data-ttu-id="3a988-128">Это имя сохраняется в кэше как имя партнера по обеспечению отработки отказа, при этом предоставленное клиентом имя партнера по обеспечению отработки отказа, если оно существует, перезаписывается.</span><span class="sxs-lookup"><span data-stu-id="3a988-128">This name is stored in the cache as the failover partner name, overwriting the client-supplied failover partner name, if any.</span></span> <span data-ttu-id="3a988-129">После этого поставщик данных .NET Framework Data Provider для [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не обновляет имя партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-129">Thereafter, the .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] does not update the failover partner name.</span></span> <span data-ttu-id="3a988-130">Однако, собственный клиент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] обновляет кэш каждый раз, когда последующее соединение или переустановка соединения возвращает другое имя участника.</span><span class="sxs-lookup"><span data-stu-id="3a988-130">In contrast, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client updates the cache whenever a subsequent connection or connection reset returns a different partner name.</span></span>  
  
 <span data-ttu-id="3a988-131">На приведенной ниже схеме показано соединение клиента с изначальным участником **Участник А**для отображаемой базы данных **Db_1**.</span><span class="sxs-lookup"><span data-stu-id="3a988-131">The following figure illustrates a client connection to the initial partner, **Partner_A**, for a mirrored database named **Db_1**.</span></span> <span data-ttu-id="3a988-132">Схема иллюстрирует случай, когда имя изначального участника, предоставленное клиентом, верно идентифицирует текущий основной сервер **Участник А**.</span><span class="sxs-lookup"><span data-stu-id="3a988-132">This figure shows a case in which the initial partner name supplied by the client correctly identifies the current principal server, **Partner_A**.</span></span> <span data-ttu-id="3a988-133">Первоначально соединение завершается успешно, и поставщик доступа к данным сохраняет имя текущего зеркального сервера ( **Участник Б**) в локальном кэше в качестве имени участника по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-133">The initial connection attempt succeeds, and the data access provider stores the name of the mirror server (currently **Partner_B**) as the failover partner name in the local cache.</span></span> <span data-ttu-id="3a988-134">Наконец, клиент подключается к основной копии базы данных **Db_1** .</span><span class="sxs-lookup"><span data-stu-id="3a988-134">Finally, the client connects to the principal copy of the **Db_1** database.</span></span>  
  
 <span data-ttu-id="3a988-135">![Клиентское соединение для случая, если начальный участник является основным](../media/dbm-initial-connection.gif "Клиентское соединение для случая, если начальный участник является основным")</span><span class="sxs-lookup"><span data-stu-id="3a988-135">![Client connection if initial partner is principal](../media/dbm-initial-connection.gif "Client connection if initial partner is principal")</span></span>  
  
 <span data-ttu-id="3a988-136">Попытка первоначального соединения может завершиться неудачно, например в результате ошибки сети или из-за того, что экземпляр сервера неактивен.</span><span class="sxs-lookup"><span data-stu-id="3a988-136">The initial connection attempt may fail, for example, because of a network error or an inactive server instance.</span></span> <span data-ttu-id="3a988-137">Так как изначальный участник недоступен, клиент должен предоставить имя партнера по обеспечению отработки отказа в строке соединения, чтобы поставщик доступа к данным попытался подключиться к партнеру по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-137">Because the initial partner is unavailable, for the data access provider to attempt to connect to the failover partner, the client must have supplied the failover partner name in the connection string.</span></span>  
  
 <span data-ttu-id="3a988-138">В случае если имя партнера по обеспечению отработки отказа недоступно, попытки первоначального подключения продолжаются до тех пор, пока не истечет время ожидания подключения к сети или не будет возвращена ошибка (аналогично подключению к неотображаемой базе данных).</span><span class="sxs-lookup"><span data-stu-id="3a988-138">In that case, if the failover partner name is unavailable, the original connection attempt continues until the network connection timeout or an error is returned (just as for a non-mirrored database).</span></span>  
  
 <span data-ttu-id="3a988-139">Если в строке подключения приведено имя партнера по обеспечению отработки отказа, то поведение поставщика доступа к данным зависит от сетевого протокола и операционной системы клиента следующим образом:</span><span class="sxs-lookup"><span data-stu-id="3a988-139">When the failover partner name is supplied in the connection string, the behavior of the data access provider depends on the network protocol and operating system of the client, as follows:</span></span>  
  
-   <span data-ttu-id="3a988-140">Для протокола TCP/IP попытки соединения регулируются алгоритмом повторения подключений, специфичным для зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-140">For TCP/IP, the connection attempts are regulated by a connection retry algorithm that is specific to database mirroring.</span></span> <span data-ttu-id="3a988-141">*Алгоритм повторного соединения* определяет максимальное время ( *время повтора*), отведенное для открытия соединения в рамках данной попытки соединения.</span><span class="sxs-lookup"><span data-stu-id="3a988-141">The *connection retry algorithm* determines the maximum time (the *retry time*) allotted for opening a connection in a given connection attempt.</span></span>  
  
-   <span data-ttu-id="3a988-142">Для других сетевых протоколов</span><span class="sxs-lookup"><span data-stu-id="3a988-142">For other network protocols</span></span>  
  
     <span data-ttu-id="3a988-143">Если возникла ошибка или изначальный участник недоступен, то попытки первоначального соединения продолжаются до тех пор, пока не истечет время ожидания сетевого подключения либо не истечет время ожидания входа на поставщике доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="3a988-143">If an error occurs or if the initial partner is unavailable, the initial connection attempt waits until the network connection timeout period expires or the login timeout period expires on the data access provider.</span></span> <span data-ttu-id="3a988-144">Обычно это время ожидания составляет примерно 20—30 секунд.</span><span class="sxs-lookup"><span data-stu-id="3a988-144">Typically, this wait is on the order of 20 to 30 seconds.</span></span> <span data-ttu-id="3a988-145">После этого, если время ожидания поставщика доступа к данным не истекло, поставщик пытается подключиться к партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-145">Thereafter, if the data access provider has not timed out, it attempts to connect to the failover partner.</span></span> <span data-ttu-id="3a988-146">Если время ожидания соединения истекло до успешного завершения подключения или партнер по обеспечению отработки отказа недоступен, попытка подключения завершается неудачно.</span><span class="sxs-lookup"><span data-stu-id="3a988-146">If the connection timeout period expires before the connection succeeds or the failover partner is unavailable, the connection attempt fails.</span></span> <span data-ttu-id="3a988-147">Если до окончания времени ожидания входа партнер по обеспечению отработки отказа доступен и в данный момент является основным сервером, попытка соединения обычно завершается успешно.</span><span class="sxs-lookup"><span data-stu-id="3a988-147">If failover partner is available within the login timeout period and is now the principal server, the connection attempt normally succeeds.</span></span>  

  
### <a name="connection-strings-for-a-mirrored-database"></a><span data-ttu-id="3a988-148">Строки подключения с зеркальной базой данных</span><span class="sxs-lookup"><span data-stu-id="3a988-148">Connection Strings for a Mirrored Database</span></span>  
 <span data-ttu-id="3a988-149">Сообщаемая клиентом строка подключения содержит сведения, используемые поставщиком доступа к данным для подключения к базе данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-149">The connection string supplied by the client contains information that the data access provider uses to connect to the database.</span></span> <span data-ttu-id="3a988-150">В этом разделе описаны ключевые слова, относящиеся к соединению с зеркальной базой данных с помощью драйвера Native Client ODBC [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="3a988-150">This section discusses the keywords that are specifically relevant for connecting to a mirrored database using a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC Driver Connection.</span></span>  
  
#### <a name="network-attribute"></a><span data-ttu-id="3a988-151">Атрибут Network</span><span class="sxs-lookup"><span data-stu-id="3a988-151">Network Attribute</span></span>  
 <span data-ttu-id="3a988-152">Строка подключения должна содержать атрибут **Network** , указывающий сетевой протокол.</span><span class="sxs-lookup"><span data-stu-id="3a988-152">The connection string should contain the **Network** attribute to specify the network protocol.</span></span> <span data-ttu-id="3a988-153">Это гарантирует сохранение указанного сетевого протокола при соединении с разными участниками.</span><span class="sxs-lookup"><span data-stu-id="3a988-153">This ensures that the specified network protocol persists between connections to different partners.</span></span> <span data-ttu-id="3a988-154">Протокол TCP/IP — наилучший протокол для соединения с отображаемой базой данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-154">The best protocol for connecting to a mirrored database is TCP/IP.</span></span> <span data-ttu-id="3a988-155">Чтобы гарантировать запрос протокола TCP/IP клиентом при каждом подключении к участникам, необходимо включить в строку соединения следующий атрибут:</span><span class="sxs-lookup"><span data-stu-id="3a988-155">To ensure that the client requests TCP/IP for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbmssocn;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="3a988-156">Рекомендуется, чтобы протокол TCP/IP был указан в самой верхней строке списка протоколов клиента.</span><span class="sxs-lookup"><span data-stu-id="3a988-156">We recommend keeping TCP/IP at the top of a client's protocol list.</span></span> <span data-ttu-id="3a988-157">Однако, если в строке подключения указан атрибут **Network** , то он переопределяет порядок элементов списка.</span><span class="sxs-lookup"><span data-stu-id="3a988-157">However, if the connection string specifies the **Network** attribute, this overrides the list order.</span></span>  
  
 <span data-ttu-id="3a988-158">С другой стороны, чтобы гарантировать запрос именованных каналов клиентом каждый раз при подключении к участникам, необходимо включить в строку подключения следующий атрибут:</span><span class="sxs-lookup"><span data-stu-id="3a988-158">Alternatively, to ensure that the client requests named pipes for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbnmpntw;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="3a988-159">Так как именованные каналы не используют алгоритм повторения протокола TCP/IP, во многих случаях время попытки подключения с помощью именованных каналов истекает до соединения с отображаемой базой данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-159">Because named pipes does not use the TCP/IP retry algorithm, in many cases, a named pipes connection attempt may time out before connecting to a mirrored database.</span></span>  
  
#### <a name="server-attribute"></a><span data-ttu-id="3a988-160">Атрибут Server</span><span class="sxs-lookup"><span data-stu-id="3a988-160">Server Attribute</span></span>  
 <span data-ttu-id="3a988-161">В строке соединения должен присутствовать атрибут `Server`, предоставляющий исходное имя участника, которое должно определять текущий экземпляр основного сервера.</span><span class="sxs-lookup"><span data-stu-id="3a988-161">The connection string must contain a `Server` attribute that supplies the initial partner name, which should identify the current principal server instance.</span></span>  
  
 <span data-ttu-id="3a988-162">Самый простой способ идентифицировать экземпляр сервера — это указать его имя, *<имя_сервера>* [ **\\** _<имя_экземпляра_SQL_Server>_ ].</span><span class="sxs-lookup"><span data-stu-id="3a988-162">The simplest way to identify the server instance is by specifying its name , *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span> <span data-ttu-id="3a988-163">Пример:</span><span class="sxs-lookup"><span data-stu-id="3a988-163">For example:</span></span>  
  
 `Server=Partner_A;`  
  
 <span data-ttu-id="3a988-164">или диспетчер конфигурации служб</span><span class="sxs-lookup"><span data-stu-id="3a988-164">or</span></span>  
  
 `Server=Partner_A\Instance_2;`  
  
 <span data-ttu-id="3a988-165">Однако, если используется системное имя, то клиент должен выполнить уточняющий запрос к DNS, чтобы получить IP-адрес сервера и запрос к браузеру SQL Server, чтобы получить номер порта сервера, на котором расположен участник.</span><span class="sxs-lookup"><span data-stu-id="3a988-165">However, when the system name is used, the client must perform a DNS lookup to obtain the IP address of the server and a SQL Server Browser query to obtain the port number of the server on which the partner resides.</span></span> <span data-ttu-id="3a988-166">Эти уточняющие запросы можно обойти, если указать IP-адрес и номер порта участника в атрибуте `Server` вместо указания имени сервера.</span><span class="sxs-lookup"><span data-stu-id="3a988-166">Those lookups and queries can be bypassed by specifying the IP address and port number of the partner in the `Server` attribute, rather than specifying the server name.</span></span> <span data-ttu-id="3a988-167">Это рекомендуется для сведения к минимуму возможности внешних задержек при соединении с участником.</span><span class="sxs-lookup"><span data-stu-id="3a988-167">This is recommended to minimize the possibility of external delays while connecting to that partner.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-168">Запрос к браузеру SQL Server необходим, если в строке подключения указано имя именованного экземпляра, а не порт.</span><span class="sxs-lookup"><span data-stu-id="3a988-168">A SQL Server Browser query is necessary if the connection string specifies the named instance name and not the port.</span></span>  
  
 <span data-ttu-id="3a988-169">Чтобы указать IP-адрес и порт, `Server` атрибут принимает следующую форму, `Server=` *<ip_address>* `,` *\<port>* , например:</span><span class="sxs-lookup"><span data-stu-id="3a988-169">To specify the IP address and port, the `Server` attribute takes the following form, `Server=`*<ip_address>*`,`*\<port>*, for example:</span></span>  
  
```  
Server=123.34.45.56,4724;   
```  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-170">IP-адреса бывают версии 4 (IPv4) или 6 (IPv6).</span><span class="sxs-lookup"><span data-stu-id="3a988-170">The IP address can be IP Version 4 (IPv4) or IP Version 6 (IPv6).</span></span>  
  
#### <a name="database-attribute"></a><span data-ttu-id="3a988-171">Атрибут Database</span><span class="sxs-lookup"><span data-stu-id="3a988-171">Database Attribute</span></span>  
 <span data-ttu-id="3a988-172">Кроме того, в строке соединения должен содержаться атрибут `Database`, который предоставляет имя зеркальной базы данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-172">In addition, the connection string must specify the `Database` attribute to supply the name of the mirrored database.</span></span> <span data-ttu-id="3a988-173">Если база данных во время клиентской попытки соединения недоступна, инициируется исключение.</span><span class="sxs-lookup"><span data-stu-id="3a988-173">If the database is unavailable when the client attempts to connect, an exception is raised.</span></span>  
  
 <span data-ttu-id="3a988-174">Например, чтобы явным образом установить соединение с базой данных **AdventureWorks** на основном сервере Partner_A, клиент должен указать следующую строку подключения:</span><span class="sxs-lookup"><span data-stu-id="3a988-174">For example, to expressly connect to the **AdventureWorks** database on the principal server Partner_A, a client uses the following connection string:</span></span>  
  
 `" Server=Partner_A; Database=AdventureWorks "`  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-175">В данной строке пропущены сведения для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="3a988-175">This string omits authentication information.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="3a988-176">Объединение префикса протокола с `Server` атрибутом ( `Server=tcp:` *\<servername>* ) несовместимо с **сетевым** атрибутом, и указание протокола в обоих местах скорее всего приведет к ошибке.</span><span class="sxs-lookup"><span data-stu-id="3a988-176">Bundling the protocol prefix with the `Server` attribute (`Server=tcp:`*\<servername>*) is incompatible with the **Network** attribute, and specifying the protocol in both places will likely result in an error.</span></span> <span data-ttu-id="3a988-177">Поэтому рекомендуется указать протокол в строке подключения, используя атрибут **Network** , и указать только имя сервера в `Server` атрибуте ( `"Network=dbmssocn; Server=` *\<servername>* `"` ).</span><span class="sxs-lookup"><span data-stu-id="3a988-177">Therefore, we recommend that a connection string specify the protocol using the **Network** attribute and specify only the server name in the `Server` attribute (`"Network=dbmssocn; Server=`*\<servername>*`"`).</span></span>  
  
#### <a name="failover-partner-attribute"></a><span data-ttu-id="3a988-178">Атрибут Failover Partner</span><span class="sxs-lookup"><span data-stu-id="3a988-178">Failover Partner Attribute</span></span>  
 <span data-ttu-id="3a988-179">В дополнение к имени изначального участника клиент может также указать имя партнера по обеспечению отработки отказа, являющегося резервным сервером, которое должно идентифицировать текущий экземпляр зеркального сервера.</span><span class="sxs-lookup"><span data-stu-id="3a988-179">In addition to the initial partner name, the client can also specify failover partner name, which should identify the current mirror server instance.</span></span> <span data-ttu-id="3a988-180">Участник отработки отказа задается в одном из ключевых слов для атрибута партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-180">The failover partner is specified by one of the keywords for the failover partner attribute.</span></span> <span data-ttu-id="3a988-181">Ключевое слово для этого атрибута зависит от используемого API-интерфейса.</span><span class="sxs-lookup"><span data-stu-id="3a988-181">The keyword for this attribute depends on the API that you are using.</span></span> <span data-ttu-id="3a988-182">В следующей таблице перечислены эти ключевые слова.</span><span class="sxs-lookup"><span data-stu-id="3a988-182">The following table lists these keywords:</span></span>  
  
|<span data-ttu-id="3a988-183">API</span><span class="sxs-lookup"><span data-stu-id="3a988-183">API</span></span>|<span data-ttu-id="3a988-184">Ключевое слово для атрибута партнера по обеспечению отработки отказа</span><span class="sxs-lookup"><span data-stu-id="3a988-184">Keyword for failover partner attribute</span></span>|  
|---------|--------------------------------------------|  
|<span data-ttu-id="3a988-185">Поставщик OLE DB</span><span class="sxs-lookup"><span data-stu-id="3a988-185">OLE DB Provider</span></span>|`FailoverPartner`|  
|<span data-ttu-id="3a988-186">Драйвер ODBC</span><span class="sxs-lookup"><span data-stu-id="3a988-186">ODBC Driver</span></span>|`Failover_Partner`|  
|<span data-ttu-id="3a988-187">Объекты ADO</span><span class="sxs-lookup"><span data-stu-id="3a988-187">ActiveX Data Objects (ADO)</span></span>|`Failover Partner`|  
  
 <span data-ttu-id="3a988-188">Самый простой способ идентифицировать экземпляр сервера — это указать его системное имя, *<имя_сервера>* [ **\\** _<имя_экземпляра_SQL_Server>_ ].</span><span class="sxs-lookup"><span data-stu-id="3a988-188">The simplest way to identify the server instance is by its system name, *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span>  
  
 <span data-ttu-id="3a988-189">Можно также указать IP-адрес и порт в атрибуте `Failover Partner`.</span><span class="sxs-lookup"><span data-stu-id="3a988-189">Alternatively, the IP address and port number can be supplied in the `Failover Partner` attribute.</span></span> <span data-ttu-id="3a988-190">В случае неудачи первоначальной попытки подключения во время первого соединения с базой данных попытка соединения с партнером по обеспечению отработки отказа, являющимся резервным сервером, не будет более зависеть от DNS и браузера SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3a988-190">If the initial connection attempt fails during the first connection to the database, the attempt to connect to the failover partner will be freed from relying on DNS and SQL Server Browser.</span></span> <span data-ttu-id="3a988-191">После того как соединение установлено, имя партнера по обеспечению отработки отказа перезаписывается именем партнера по обеспечению отработки отказа, являющегося резервным севером; таким образом, в случае сбоя перенаправленные соединения потребуют DNS и браузер SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3a988-191">Once a connection is established, the failover partner name will be overwritten with the failover partner name, so if a failover occurs, the redirected connections will require DNS and SQL Server Browser.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-192">Если указано только имя изначального участника, разработчикам приложения нет необходимости предпринимать какие-либо действия или писать какой-либо код, кроме кода, предназначенного для повторного соединения.</span><span class="sxs-lookup"><span data-stu-id="3a988-192">When only the initial partner name is provided, application developers do not need to take any action or write any code except about how to reconnect.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-193">Разработчики приложений с управляемым кодом указывают имя партнера по обеспечению отработки отказа в свойстве `ConnectionString` объекта `SqlConnection`.</span><span class="sxs-lookup"><span data-stu-id="3a988-193">Managed code application developers supply the failover partner name in the `ConnectionString` of the `SqlConnection` object.</span></span> <span data-ttu-id="3a988-194">Дополнительные сведения об использовании данной строки соединения см. в разделе «Поддержка зеркального отображения баз данных в поставщике данных .NET Framework для SQL Server» документации по ADO.NET, являющейся частью пакета [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK.</span><span class="sxs-lookup"><span data-stu-id="3a988-194">For information on using this connection string, see "Database Mirroring Support in the .NET Framework Data Provider for SQL Server" in the ADO.NET documentation, which is part of the [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK.</span></span>  
  
#### <a name="example-connection-string"></a><span data-ttu-id="3a988-195">Пример строки соединения</span><span class="sxs-lookup"><span data-stu-id="3a988-195">Example Connection String</span></span>  
 <span data-ttu-id="3a988-196">Например, чтобы явно подключиться к базе данных **AdventureWorks** с помощью протокола TCP/IP на сервере "Участник А" или "Участник Б", клиентское приложение, использующее драйвер ODBC, должно указать следующую строку соединения:</span><span class="sxs-lookup"><span data-stu-id="3a988-196">For example, to explicitly connect using TCP/IP to the **AdventureWorks** database on either Partner_A or Partner_B, a client application that uses the ODBC Driver could supply the following connection string:</span></span>  
  
```  
"Server=Partner_A; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
 <span data-ttu-id="3a988-197">Либо клиент может использовать IP-адрес и номер порта, чтобы идентифицировать изначального участника Участник А; например для IP-адреса 250.65.43.21 и номера порта 4734 строка подключения может быть следующей:</span><span class="sxs-lookup"><span data-stu-id="3a988-197">Alternatively, the client could use the IP address and port number to identify the initial partner, Partner_A; for example, if the IP address is 250.65.43.21 and the port number is 4734, the connection string would be:</span></span>  
  
```  
"Server=250.65.43.21,4734; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
##  <a name="connection-retry-algorithm-for-tcpip-connections"></a><a name="RetryAlgorithm"></a> <span data-ttu-id="3a988-198">Алгоритм повторного соединения (для соединений по протоколу TCP/IP)</span><span class="sxs-lookup"><span data-stu-id="3a988-198">Connection Retry Algorithm (for TCP/IP Connections)</span></span>  
 <span data-ttu-id="3a988-199">Для соединения по протоколу TCP/IP, когда имена обоих участников находятся в кэше, поставщик доступа к данным устанавливает соединение по алгоритму повторного соединения.</span><span class="sxs-lookup"><span data-stu-id="3a988-199">For a TCP/IP connection, when both partner names are in the cache, the data access provider adheres to a connection retry algorithm.</span></span> <span data-ttu-id="3a988-200">Это справедливо как для начального соединения с сеансом, так и для повторного соединения после потери связи.</span><span class="sxs-lookup"><span data-stu-id="3a988-200">This is true both for making the initial connection to the session and for reconnecting after losing an established connection.</span></span> <span data-ttu-id="3a988-201">После установки соединения выполнение предварительных и основных шагов подключения требует дополнительного времени.</span><span class="sxs-lookup"><span data-stu-id="3a988-201">Once a connection has been opened, completing the pre-login and login steps takes additional time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-202">Время, затраченное на создание соединения, может превышать время повтора по причине внешних факторов, таких как медленные уточняющие запросы DNS, медленный контроллер домена или KDC, время, затраченное на связь с браузером SQL Server, загруженность сети и так далее.</span><span class="sxs-lookup"><span data-stu-id="3a988-202">The time spent in opening a connection can exceed the retry time because of external factors, such as slow DNS lookups, slow domain controller/Kerberos Key Distribution Center (KDC), time spent contacting SQL Server Browser, network congestion, and so forth.</span></span> <span data-ttu-id="3a988-203">Такие внешние факторы могут препятствовать подключению клиента к зеркально отображаемой базе данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-203">Such external factors can prevent a client from connecting to a mirrored database.</span></span> <span data-ttu-id="3a988-204">Также внешние факторы могут сделать время создания соединения большим, чем установленное время повтора.</span><span class="sxs-lookup"><span data-stu-id="3a988-204">Also, external factors can cause a connection to take longer to open than the allotted retry time.</span></span> <span data-ttu-id="3a988-205">Дополнительные сведения об обходе DNS и браузера SQL Server при подключении к исходному участнику см. в разделе [Установка первоначального соединения с сеансом зеркального отображения базы данных](#InitialConnection)выше в данной теме.</span><span class="sxs-lookup"><span data-stu-id="3a988-205">For information on bypassing DNS and SQL Server Browser for connection attempt to the initial partner, see [Making the Initial Connection to a Database Mirroring Session](#InitialConnection), earlier in this topic.</span></span>  
  
 <span data-ttu-id="3a988-206">Если попытка соединения не удается или время повтора истекает до успешного создания соединения, поставщик данных пытается подключиться к другому участнику.</span><span class="sxs-lookup"><span data-stu-id="3a988-206">If a connection attempt fails or the retry time expires before it succeeds, the data access provider tries the other partner.</span></span> <span data-ttu-id="3a988-207">Если создать соединение не удалось, поставщик пытается менять имена исходного участника и партнера по обеспечению отработки отказа, пока не установится соединение или не истечет время входа. По умолчанию период ожидания входа составляет 15 секунд.</span><span class="sxs-lookup"><span data-stu-id="3a988-207">If a connection is not opened by this point, the provider alternately tries the initial and failover partner names, until a connection is opened or the login period times out. The default login time-out period is 15 seconds.</span></span> <span data-ttu-id="3a988-208">Рекомендуется устанавливать значение интервала времени ожидания не менее 5 секунд.</span><span class="sxs-lookup"><span data-stu-id="3a988-208">We recommend that the login time-out period be at least 5 seconds.</span></span> <span data-ttu-id="3a988-209">Задание меньшего интервала времени ожидания может препятствовать успешному выполнению любых попыток соединения.</span><span class="sxs-lookup"><span data-stu-id="3a988-209">Specifying a smaller time-out period might prevent any of the connection attempts from succeeding.</span></span>  
  
 <span data-ttu-id="3a988-210">Время повтора — это процент от времени входа.</span><span class="sxs-lookup"><span data-stu-id="3a988-210">The retry time is a percentage of the login period.</span></span> <span data-ttu-id="3a988-211">Время повтора для попытки соединения увеличивается при каждом успешном цикле.</span><span class="sxs-lookup"><span data-stu-id="3a988-211">The retry time for a connection attempt is larger in each successive round.</span></span> <span data-ttu-id="3a988-212">В первом цикле время повтора для каждой из двух попыток составляет 8 процентов от общего времени входа.</span><span class="sxs-lookup"><span data-stu-id="3a988-212">In the first round, the retry time for each of the two attempts is 8 percent of the total login period.</span></span> <span data-ttu-id="3a988-213">При каждом успешном цикле алгоритм повтора увеличивает максимальное время повтора на то же число.</span><span class="sxs-lookup"><span data-stu-id="3a988-213">In each successive round, the retry algorithm increases the maximum retry time by the same amount.</span></span> <span data-ttu-id="3a988-214">Следовательно, время повтора для первых восьми попыток соединения будет следующим:</span><span class="sxs-lookup"><span data-stu-id="3a988-214">Thus, the retry times for the first eight connection attempts is as follows:</span></span>  
  
 <span data-ttu-id="3a988-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span><span class="sxs-lookup"><span data-stu-id="3a988-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span></span>  
  
 <span data-ttu-id="3a988-216">Время повтора рассчитывается при помощи следующей формулы:</span><span class="sxs-lookup"><span data-stu-id="3a988-216">The retry time is calculated using the following formula:</span></span>  
  
 <span data-ttu-id="3a988-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;** _LoginTimeout_ **)**</span><span class="sxs-lookup"><span data-stu-id="3a988-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;**_LoginTimeout_**)**</span></span>  
  
 <span data-ttu-id="3a988-218">где *PreviousRetryTime* изначально равно 0.</span><span class="sxs-lookup"><span data-stu-id="3a988-218">Where *PreviousRetryTime* is initially 0.</span></span>  
  
 <span data-ttu-id="3a988-219">Например, при использовании времени ожидания входа 15 секунд *LoginTimeout* *= 15*.</span><span class="sxs-lookup"><span data-stu-id="3a988-219">For example, if using the default login time-out period of 15 seconds, *LoginTimeout* *= 15*.</span></span> <span data-ttu-id="3a988-220">В этом случае время повтора, назначенное на первые три цикла, будет следующим:</span><span class="sxs-lookup"><span data-stu-id="3a988-220">In this case, the retry times allotted in the first three rounds are as follows:</span></span>  
  
|<span data-ttu-id="3a988-221">Round</span><span class="sxs-lookup"><span data-stu-id="3a988-221">Round</span></span>|<span data-ttu-id="3a988-222">Вычисление*RetryTime*</span><span class="sxs-lookup"><span data-stu-id="3a988-222">*RetryTime* calculation</span></span>|<span data-ttu-id="3a988-223">Время повтора на попытку</span><span class="sxs-lookup"><span data-stu-id="3a988-223">Retry time per attempt</span></span>|  
|-----------|-----------------------------|----------------------------|  
|<span data-ttu-id="3a988-224">1</span><span class="sxs-lookup"><span data-stu-id="3a988-224">1</span></span>|<span data-ttu-id="3a988-225">0 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="3a988-225">0 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="3a988-226">1,2 с</span><span class="sxs-lookup"><span data-stu-id="3a988-226">1.2 seconds</span></span>|  
|<span data-ttu-id="3a988-227">2</span><span class="sxs-lookup"><span data-stu-id="3a988-227">2</span></span>|<span data-ttu-id="3a988-228">1.2 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="3a988-228">1.2 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="3a988-229">2,4 с</span><span class="sxs-lookup"><span data-stu-id="3a988-229">2.4 seconds</span></span>|  
|<span data-ttu-id="3a988-230">3</span><span class="sxs-lookup"><span data-stu-id="3a988-230">3</span></span>|<span data-ttu-id="3a988-231">2.4 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="3a988-231">2.4 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="3a988-232">3,6 с</span><span class="sxs-lookup"><span data-stu-id="3a988-232">3.6 seconds</span></span>|  
|<span data-ttu-id="3a988-233">4</span><span class="sxs-lookup"><span data-stu-id="3a988-233">4</span></span>|<span data-ttu-id="3a988-234">3.6 **+(** 0.08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="3a988-234">3.6 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="3a988-235">4,8 с</span><span class="sxs-lookup"><span data-stu-id="3a988-235">4.8 seconds</span></span>|   
  
 <span data-ttu-id="3a988-236">На следующем рисунке показаны периоды повторов для успешных попыток соединения, время ожидания каждой из которых истекает.</span><span class="sxs-lookup"><span data-stu-id="3a988-236">The following figure illustrates these retry times for successive connection attempts, each of which times out.</span></span>  
  
 <span data-ttu-id="3a988-237">![Максимальная задержка перед повтором при 15-секундном времени ожидании входа](../media/dbm-retry-algorithm.gif "Максимальная задержка перед повтором при 15-секундном времени ожидании входа")</span><span class="sxs-lookup"><span data-stu-id="3a988-237">![Maximum retry delays for 15 second login timeout](../media/dbm-retry-algorithm.gif "Maximum retry delays for 15 second login timeout")</span></span>  
  
 <span data-ttu-id="3a988-238">Для времени ожидания периода входа, установленного по умолчанию, максимальное время, назначенное на первые три цикла попыток соединения, составляет 14,4 секунды.</span><span class="sxs-lookup"><span data-stu-id="3a988-238">For the default login time-out period, the maximum time allotted to the first three rounds of connection attempts is 14.4 seconds.</span></span> <span data-ttu-id="3a988-239">Если бы каждая попытка использовала все свое назначенное время, то оставалось бы всего 0,6 секунды до истечения времени входа. В этом случае четвертый цикл будет сокращен, допуская только последнюю быструю попытку соединения с использованием имени исходного участника.</span><span class="sxs-lookup"><span data-stu-id="3a988-239">If every attempt were to use all of its allotted time, only 0.6 seconds of time would remain before the login period times out. In that case, the fourth round would be curtailed, allowing only a final quick attempt to connect using the initial partner name.</span></span> <span data-ttu-id="3a988-240">Однако попытка соединения может не удаться за время повтора, меньше назначенного, особенно в последующих циклах.</span><span class="sxs-lookup"><span data-stu-id="3a988-240">However, a connection attempt may fail in less than its allotted retry time, particularly in later rounds.</span></span> <span data-ttu-id="3a988-241">Например, возникновение ошибки сети может привести к прекращению попытки до истечения времени повтора.</span><span class="sxs-lookup"><span data-stu-id="3a988-241">For example, receiving a network error can cause an attempt to end before the retry time expires.</span></span> <span data-ttu-id="3a988-242">Если предыдущие попытки не удались из-за ошибки сети, для четвертого и, возможно, дополнительных циклов будет доступно дополнительное время.</span><span class="sxs-lookup"><span data-stu-id="3a988-242">If earlier attempts fail due to a network error, additional time would be available for the fourth round and, perhaps, additional rounds.</span></span>  
  
 <span data-ttu-id="3a988-243">Другая причина неудавшихся попыток — неактивный экземпляр сервера, что случается при переводе экземпляром сервера на другой ресурс своей базы данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-243">Another cause of a failed attempt is an inactive server instance, as occurs when a server instance is engaged in failing over its database.</span></span> <span data-ttu-id="3a988-244">В этом случае выполняется задержка повтора для предотвращения перегрузки участников быстрым выполнением попыток соединения.</span><span class="sxs-lookup"><span data-stu-id="3a988-244">In this case, a retry delay is imposed to prevent clients from overloading the partners with a rapid succession of connection attempts.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-245">Если доступны имена обоих участников, а время ожидания входа бесконечно, клиент пытается подключиться к серверам непрерывно, переключаясь между именем исходного участника и именем партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-245">When both partner names are available, if the login time-out period is infinite, the client attempts to reconnect to the servers indefinitely, alternating between the initial partner name and the failover partner name.</span></span>  
<span data-ttu-id="3a988-246">)</span><span class="sxs-lookup"><span data-stu-id="3a988-246">)</span></span>  
  
### <a name="retry-delays-during-failover"></a><span data-ttu-id="3a988-247">Задержки повторов во время отработки отказа</span><span class="sxs-lookup"><span data-stu-id="3a988-247">Retry Delays During Failover</span></span>  
 <span data-ttu-id="3a988-248">Если клиент пытается подключиться к участнику, переходящему на другой ресурс, участник немедленно отвечает, что он недоступен.</span><span class="sxs-lookup"><span data-stu-id="3a988-248">If a client attempts to connect to a partner that is failing over, the partner immediately responds that it is inactive.</span></span> <span data-ttu-id="3a988-249">В этом случае каждый цикл попыток соединения будет значительно короче назначенного времени повтора.</span><span class="sxs-lookup"><span data-stu-id="3a988-249">In this case, each round of connection attempts are much briefer than the allotted retry time.</span></span> <span data-ttu-id="3a988-250">Это означает, что до истечения времени входа может возникнуть множество циклов попыток подключения. Чтобы избежать перегрузки участников быстрыми сериями попыток соединения во время отработки отказа, поставщик доступа к данным добавляет краткую задержку повтора после каждого цикла повтора.</span><span class="sxs-lookup"><span data-stu-id="3a988-250">This means that many rounds of connection attempts could happen before the login period times out. To avoid overloading the partners with a rapid series of connection attempts during a failover, the data access provider adds a brief retry delay after each retry cycle.</span></span> <span data-ttu-id="3a988-251">Продолжительность заданной задержки повтора определяется алгоритмом задержки повтора.</span><span class="sxs-lookup"><span data-stu-id="3a988-251">The length of a given retry delay is determined by the retry-delay algorithm.</span></span> <span data-ttu-id="3a988-252">После первого цикла задержка составляет 100 миллисекунд.</span><span class="sxs-lookup"><span data-stu-id="3a988-252">After the first round, the delay is 100 milliseconds.</span></span> <span data-ttu-id="3a988-253">После каждого из следующих трех раундов задержка повтора удваивается — до 200, 400 и 800.</span><span class="sxs-lookup"><span data-stu-id="3a988-253">After each of the next three rounds, the retry delay doubles-to 200, 400, and 800.</span></span> <span data-ttu-id="3a988-254">Для всех последующих циклов задержка повтора составляет 1 секунду вплоть до успешного выполнения попытки соединения или истечения времени.</span><span class="sxs-lookup"><span data-stu-id="3a988-254">For all later rounds, the retry delay is 1 second until the connection attempt succeeds or times out.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-255">Если экземпляр сервера остановлен, запрос на подключение прекращается немедленно.</span><span class="sxs-lookup"><span data-stu-id="3a988-255">If the server instance is stopped, then the connection request fails immediately.</span></span>  
  
 <span data-ttu-id="3a988-256">На следующем рисунке показано, как задержки повторов влияют на попытки подключения во время перехода на другой ресурс вручную, при котором партнеры переключают свои роли.</span><span class="sxs-lookup"><span data-stu-id="3a988-256">The following figure illustrates how the retry delay affects connection attempts during a manual failover, in which the partners switch their roles.</span></span> <span data-ttu-id="3a988-257">Период ожидания составляет 15 секунд.</span><span class="sxs-lookup"><span data-stu-id="3a988-257">The login time-out period is 15 seconds.</span></span>  
  
 <span data-ttu-id="3a988-258">![Алгоритм повтор-задержка](../media/dbm-retry-delay-algorithm.gif "Алгоритм повтор-задержка")</span><span class="sxs-lookup"><span data-stu-id="3a988-258">![Retry-delay algorithm](../media/dbm-retry-delay-algorithm.gif "Retry-delay algorithm")</span></span>  
  
##  <a name="reconnecting-to-a-database-mirroring-session"></a><a name="Reconnecting"></a> <span data-ttu-id="3a988-259">Повторное подключение к сеансу зеркального отображения базы данных</span><span class="sxs-lookup"><span data-stu-id="3a988-259">Reconnecting to a Database Mirroring Session</span></span>  
 <span data-ttu-id="3a988-260">Если установленное соединение с сеансом зеркального отображения базы данных по какой-то причине разрывается — например вследствие отработки отказа с переходом с основной базы данных на зеркальную, — и приложение пытается подключиться к исходному серверу, поставщик доступа к данным может повторно подключиться, используя имя партнера по обеспечению отработки отказа, хранящееся в клиентском кэше.</span><span class="sxs-lookup"><span data-stu-id="3a988-260">If an established connection to a database mirroring session fails for any reason, for example, due to a database mirroring failover, and the application attempts to reconnect to the initial server, the data access provider can attempt to reconnect using the failover partner name stored in the client's cache.</span></span> <span data-ttu-id="3a988-261">Однако повторное подключение не выполняется автоматически.</span><span class="sxs-lookup"><span data-stu-id="3a988-261">Reconnecting is not automatic, however.</span></span> <span data-ttu-id="3a988-262">Приложение должно распознать ошибку.</span><span class="sxs-lookup"><span data-stu-id="3a988-262">The application must become aware of the error.</span></span> <span data-ttu-id="3a988-263">Затем приложению необходимо закрыть сбойное соединение и открыть новое, используя те же атрибуты строки соединения.</span><span class="sxs-lookup"><span data-stu-id="3a988-263">Then, the application needs to close the failed connection and open a new connection using the same connection string attributes.</span></span> <span data-ttu-id="3a988-264">В этом случае поставщик доступа к данным перенаправляет соединение на партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-264">At this point, the data access provider redirects the connection to the failover partner.</span></span> <span data-ttu-id="3a988-265">Если экземпляр сервера, определяемый именем отказоустойчивого участника, является в настоящий момент основным сервером, попытка соединения обычно завершается успешно.</span><span class="sxs-lookup"><span data-stu-id="3a988-265">If the server instance identified by this name is currently the principal server, the connection attempt usually succeeds.</span></span> <span data-ttu-id="3a988-266">Если неясно, была ли транзакция зафиксирована или произошел ее откат, приложение должно проверить состояние транзакции таким же образом, как при подключении к автономному экземпляру сервера.</span><span class="sxs-lookup"><span data-stu-id="3a988-266">If it is unclear whether a transaction was committed or rolled back, the application must check on the state of the transaction, in the same way as when reconnecting to a stand-alone server instance.</span></span>  
  
 <span data-ttu-id="3a988-267">Повторное подключение напоминает первоначальное, в строке соединения которого указано имя партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-267">Reconnecting resembles an initial connection for which the connection string supplied a failover partner name.</span></span> <span data-ttu-id="3a988-268">Если первая попытка соединения завершается неудачно, соединение поочередно пытается подключиться к исходному имени участника и имени партнера по обеспечению отработки отказа, пока не произойдет соединение клиента с основным сервером или не истечет время ожидания поставщика доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="3a988-268">If the first connection attempt fails, connection attempts alternate back and forth between the initial partner name and failover partner name until either the client connects to the  principal server or the data access provider times out.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-269">Собственный клиент [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] проверяет, подключился ли он к экземпляру основного сервера, но не проверяет, является ли этот экземпляр участником экземпляра сервера, заданного в качестве имени первоначального участника в строке подключения.</span><span class="sxs-lookup"><span data-stu-id="3a988-269">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client verifies that it connects to a principal server instance but not whether this instance is the partner of server instance specified in the initial partner name of the connection string.</span></span>  
  
 <span data-ttu-id="3a988-270">Если соединение использует протокол TCP/IP, алгоритм повторного соединения определяет количество времени, отведенного на подключение при каждой попытке.</span><span class="sxs-lookup"><span data-stu-id="3a988-270">If the connections use TCP/IP, the connection retry algorithm determines the amount of time allotted to the connection attempts in each round.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="3a988-271">Если клиент отключается от базы данных, поставщик доступа к данным не будет пытаться возобновить соединение.</span><span class="sxs-lookup"><span data-stu-id="3a988-271">If the client gets disconnected from the database, the data access provider does not attempt to reconnect.</span></span> <span data-ttu-id="3a988-272">Клиент должен выдать новый запрос на соединение.</span><span class="sxs-lookup"><span data-stu-id="3a988-272">The client must issue a new connection request.</span></span> <span data-ttu-id="3a988-273">Кроме того, если приложение закрывается при потере соединения, оно также теряет кэшированные имена участников.</span><span class="sxs-lookup"><span data-stu-id="3a988-273">Also, if an application shuts down on losing the connection, it will lose the cached partner names.</span></span> <span data-ttu-id="3a988-274">Если соединение было потеряно в результате недоступности основного сервера, единственным способом, с помощью которого приложение может подключиться к зеркальному серверу, является предоставление имени партнера по обеспечению отработки отказа в строке подключения.</span><span class="sxs-lookup"><span data-stu-id="3a988-274">If the connection was lost because the principal server became unavailable, the only way that the application can reconnect to the mirror server is by supplying the failover partner name in its connection string.</span></span>  
  
  
### <a name="impact-of-redirection-on-a-client-application"></a><span data-ttu-id="3a988-275">Влияние перенаправления на клиентское приложение</span><span class="sxs-lookup"><span data-stu-id="3a988-275">Impact of Redirection on a Client Application</span></span>  
 <span data-ttu-id="3a988-276">После отработки отказа поставщик доступа к данным перенаправляет соединение на текущий экземпляр основного сервера.</span><span class="sxs-lookup"><span data-stu-id="3a988-276">After a failover, the data access provider redirects the connection to the current principal server instance.</span></span> <span data-ttu-id="3a988-277">Однако это перенаправление является прозрачным для клиентов.</span><span class="sxs-lookup"><span data-stu-id="3a988-277">However, the redirection is transparent to clients.</span></span> <span data-ttu-id="3a988-278">Для клиента перенаправленное соединение выглядит как соединение с экземпляром сервера, определяемым именем изначального участника.</span><span class="sxs-lookup"><span data-stu-id="3a988-278">To a client, a redirected connection appears to be a connection to the server instance identified by the initial partner name.</span></span> <span data-ttu-id="3a988-279">Если первоначальный участник является в настоящее время зеркальным сервером, то клиент считает, что он подключен к зеркальному серверу и обновляет зеркальную базу данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-279">When the initial partner is currently the mirror server, the client can appear to be connected to the mirror server and updating the mirror database.</span></span> <span data-ttu-id="3a988-280">В действительности же клиент перенаправлен к партнеру по обеспечению отработки отказа, который является текущей основной базой данных, и обновляет новую основную базу данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-280">Actually, however, the client has been redirected to the failover partner, which is the current principal database, and the client is updating the new principal database.</span></span>  
  
 <span data-ttu-id="3a988-281">После перенаправления к партнеру по обеспечению отработки отказа клиент может получать непредвиденные результаты, если использует инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)] USE для работы в другой базе данных.</span><span class="sxs-lookup"><span data-stu-id="3a988-281">After being redirected to the failover partner, a client can experience unexpected results when using a [!INCLUDE[tsql](../../includes/tsql-md.md)] USE statement to use a different database.</span></span> <span data-ttu-id="3a988-282">Это может случиться в том случае, если в текущем экземпляре основного сервера (партнера по обеспечению отработки отказа) имеется набор баз данных, отличающийся от набора баз данных изначального участника.</span><span class="sxs-lookup"><span data-stu-id="3a988-282">This can happen if the current principal server instance (the failover partner) has a different set of databases than the original principal server (the initial partner).</span></span>  
  
##  <a name="the-impact-of-a-stale-failover-partner-name"></a><a name="StalePartnerName"></a> <span data-ttu-id="3a988-283">Влияние устаревшего имени партнера по обеспечению отработки отказа</span><span class="sxs-lookup"><span data-stu-id="3a988-283">The Impact of a Stale Failover Partner Name</span></span>  
 <span data-ttu-id="3a988-284">Администратор базы данных может в любой момент изменить имя участника, являющегося сервером партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-284">The database administrator can change the failover partner at any time.</span></span> <span data-ttu-id="3a988-285">Следовательно, предоставленное клиентом имя участника обеспечению отработки отказа может оказаться неактуальным или *устаревшим*.</span><span class="sxs-lookup"><span data-stu-id="3a988-285">Therefore, a client-supplied failover partner name might be out of date, or *stale*.</span></span> <span data-ttu-id="3a988-286">Например, рассмотрим ситуацию, когда партнер по обеспечению отработки отказа Partner_B заменяется другим экземпляром сервера, Partner_C.</span><span class="sxs-lookup"><span data-stu-id="3a988-286">For example, consider a failover partner named Partner_B that is replaced by another server instance, Partner_C.</span></span> <span data-ttu-id="3a988-287">В этом случае, если клиент укажет Partner_B в качестве имени партнера по обеспечению отработки отказа, это имя уже является устаревшим.</span><span class="sxs-lookup"><span data-stu-id="3a988-287">Now, if a client supplies Partner_B as the failover partner name, that name is stale.</span></span> <span data-ttu-id="3a988-288">Если указанное клиентом имя партнера по обеспечению отработки отказа устарело, то поведение поставщика доступа к данным будет равнозначно ситуации, когда клиент не сообщил этого имени.</span><span class="sxs-lookup"><span data-stu-id="3a988-288">When the client-supplied failover partner name is stale, the behavior of the data access provider equates to the case in which a failover partner name is not supplied by the client.</span></span>  
  
 <span data-ttu-id="3a988-289">Например, клиент использует одну строку соединения для последовательности из четырех попыток соединения:</span><span class="sxs-lookup"><span data-stu-id="3a988-289">For example, consider situation in which a client uses one connection string for a series of four connection attempts.</span></span> <span data-ttu-id="3a988-290">В строке соединения имя начального участника — Partner_A, а имя партнера по обеспечению отработки отказа — Partner_B:</span><span class="sxs-lookup"><span data-stu-id="3a988-290">In the connection string, the initial partner name is Partner_A, and the failover partner name is Partner_B:</span></span>  
  
```  
"Server=Partner_A; Failover Partner=Partner_B; Database=AdventureWorks"  
```  
  
 <span data-ttu-id="3a988-291">В следующей таблице показаны четыре конфигурации участников и указано, будет ли работать данная строка соединения при подключении клиента в первый раз.</span><span class="sxs-lookup"><span data-stu-id="3a988-291">The following table shows four partner configurations and indicates for each whether this connection string works for connecting the client for the first time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3a988-292">Приложение может следить за изменениями конфигурации и изменять строку соединения соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="3a988-292">An application can track configuration changes and change its connection string accordingly.</span></span> <span data-ttu-id="3a988-293">Это требует дополнительного кода, но снимает с администратора часть забот.</span><span class="sxs-lookup"><span data-stu-id="3a988-293">This requires extra code but reduces the administrative burden.</span></span>  
  
|<span data-ttu-id="3a988-294">Конфигурация</span><span class="sxs-lookup"><span data-stu-id="3a988-294">Configuration</span></span>|<span data-ttu-id="3a988-295">Основной сервер</span><span class="sxs-lookup"><span data-stu-id="3a988-295">Principal server</span></span>|<span data-ttu-id="3a988-296">Зеркальный сервер</span><span class="sxs-lookup"><span data-stu-id="3a988-296">Mirror server</span></span>|<span data-ttu-id="3a988-297">Поведение при попытке подключиться с указанием серверов Partner_A и Partner_B?</span><span class="sxs-lookup"><span data-stu-id="3a988-297">Behavior when attempting to connect specifying Partner_A and Partner_B</span></span>|  
|-------------------|----------------------|-------------------|------------------------------------------------------------------------------|  
|<span data-ttu-id="3a988-298">Исходная зеркальная конфигурация.</span><span class="sxs-lookup"><span data-stu-id="3a988-298">Original mirroring configuration.</span></span>|<span data-ttu-id="3a988-299">Участник А</span><span class="sxs-lookup"><span data-stu-id="3a988-299">Partner_A</span></span>|<span data-ttu-id="3a988-300">Участник Б</span><span class="sxs-lookup"><span data-stu-id="3a988-300">Partner_B</span></span>|<span data-ttu-id="3a988-301">Partner_A сохраняется в кэше в качестве имени изначального участника.</span><span class="sxs-lookup"><span data-stu-id="3a988-301">Partner_A is cached as the initial partner name.</span></span> <span data-ttu-id="3a988-302">Клиент успешно соединяется с сервером Partner_A.</span><span class="sxs-lookup"><span data-stu-id="3a988-302">The client succeeds in connecting to Partner_A.</span></span> <span data-ttu-id="3a988-303">Затем клиент загружает имя зеркального сервера, Partner_B, и кэширует его, не учитывая указанное клиентом имя партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-303">The client downloads the name of mirror server, Partner_B, and caches it, ignoring the client-supplied failover partner name.</span></span>|  
|<span data-ttu-id="3a988-304">На сервере Partner_A происходит сбой оборудования и начинается отработка отказа (с отключением клиентов).</span><span class="sxs-lookup"><span data-stu-id="3a988-304">Partner_A experiences a hardware failure, and failover occurs (disconnecting clients).</span></span>|<span data-ttu-id="3a988-305">Участник Б</span><span class="sxs-lookup"><span data-stu-id="3a988-305">Partner_B</span></span>|<span data-ttu-id="3a988-306">none</span><span class="sxs-lookup"><span data-stu-id="3a988-306">none</span></span>|<span data-ttu-id="3a988-307">В качестве имени изначального участника в кэше все еще указан Partner_A, но сообщенное клиентом имя партнера по обеспечению отработки отказа, Partner_B, позволяет клиенту соединиться с текущим основным сервером.</span><span class="sxs-lookup"><span data-stu-id="3a988-307">The Partner_A is still cached as the initial partner name, but the client-supplied failover partner name, Partner_B, permits the client to connect to the current principal server.</span></span>|  
|<span data-ttu-id="3a988-308">Администратор баз данных прекращает зеркальное отображение (отключая клиентов), заменяет Partner_A на Partner_C и перезапускает зеркальное отображение.</span><span class="sxs-lookup"><span data-stu-id="3a988-308">The database administrator stops mirroring (disconnecting clients), replaces Partner_A with Partner_C, and restarts mirroring.</span></span>|<span data-ttu-id="3a988-309">Участник Б</span><span class="sxs-lookup"><span data-stu-id="3a988-309">Partner_B</span></span>|<span data-ttu-id="3a988-310">Partner_C</span><span class="sxs-lookup"><span data-stu-id="3a988-310">Partner_C</span></span>|<span data-ttu-id="3a988-311">Клиент пытается соединиться с сервером Partner_A и это не удается; затем клиент пытается соединиться с Partner_B (текущему основному серверу) и это завершается успешно.</span><span class="sxs-lookup"><span data-stu-id="3a988-311">The client attempts to connect to Partner_A and fails; then the client tries Partner_B (the current principal server) and succeeds.</span></span> <span data-ttu-id="3a988-312">Поставщик доступа к данным загружает имя текущего зеркального сервера, Partner_C, и кэширует его в качестве текущего имени партнера по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3a988-312">The data access provider downloads the name of the current mirror server, Partner_C, and caches it as the current failover partner name.</span></span>|  
|<span data-ttu-id="3a988-313">Переход службы на сервер Partner_C производится вручную (с отключением клиентов).</span><span class="sxs-lookup"><span data-stu-id="3a988-313">Service is manually failed over to Partner_C (disconnecting clients).</span></span>|<span data-ttu-id="3a988-314">Partner_C</span><span class="sxs-lookup"><span data-stu-id="3a988-314">Partner_C</span></span>|<span data-ttu-id="3a988-315">Участник Б</span><span class="sxs-lookup"><span data-stu-id="3a988-315">Partner_B</span></span>|<span data-ttu-id="3a988-316">Клиент изначально пытается подключиться к серверу Partner_A, а затем к серверу Partner_B.</span><span class="sxs-lookup"><span data-stu-id="3a988-316">Client attempts to connect to Partner_A initially, and then to Partner_B.</span></span> <span data-ttu-id="3a988-317">Обе попытки завершаются неудачно, в результате время ожидания соединения истекает и соединение завершается неудачно.</span><span class="sxs-lookup"><span data-stu-id="3a988-317">Both names fail, and eventually the connection request times out and fails.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="3a988-318">См. также:</span><span class="sxs-lookup"><span data-stu-id="3a988-318">See Also</span></span>  
 <span data-ttu-id="3a988-319">[Зеркальное отображение базы данных (SQL Server)](database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="3a988-319">[Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="3a988-320">Возможные неполадки при зеркальном отображении базы данных</span><span class="sxs-lookup"><span data-stu-id="3a988-320">Possible Failures During Database Mirroring</span></span>](possible-failures-during-database-mirroring.md)  
  
  
