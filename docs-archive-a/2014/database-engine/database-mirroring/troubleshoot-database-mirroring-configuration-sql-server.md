---
title: Диагностика конфигурации зеркального отображения базы данных (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- database mirroring [SQL Server], deployment
- endpoints [SQL Server], database mirroring
- database mirroring [SQL Server], troubleshooting
- troubleshooting [SQL Server], database mirroring
ms.assetid: 87d3801b-dc52-419e-9316-8b1f1490946c
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0dafd98f721bfc2d2d0dd64a9f97689466529407
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658401"
---
# <a name="troubleshoot-database-mirroring-configuration-sql-server"></a><span data-ttu-id="9ef48-102">Диагностика конфигурации зеркального отображения базы данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="9ef48-102">Troubleshoot Database Mirroring Configuration (SQL Server)</span></span>
  <span data-ttu-id="9ef48-103">В этом разделе приводятся сведения об устранении неполадок при установке сеанса зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="9ef48-103">This topic provides information to help you troubleshoot problems in setting up a database mirroring session.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9ef48-104"> Убедитесь, что выполняются все [предварительные условия для зеркального отображения базы данных](prerequisites-restrictions-and-recommendations-for-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-104">Ensure that you are meeting all the [prerequisites for database mirroring](prerequisites-restrictions-and-recommendations-for-database-mirroring.md).</span></span>  
  
|<span data-ttu-id="9ef48-105">Проблема</span><span class="sxs-lookup"><span data-stu-id="9ef48-105">Issue</span></span>|<span data-ttu-id="9ef48-106">Итоги</span><span class="sxs-lookup"><span data-stu-id="9ef48-106">Summary</span></span>|  
|-----------|-------------|  
|<span data-ttu-id="9ef48-107">Сообщение об ошибке 1418</span><span class="sxs-lookup"><span data-stu-id="9ef48-107">Error Message 1418</span></span>|<span data-ttu-id="9ef48-108">Данное сообщение [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] указывает на то, что сетевой адрес сервера недоступен или не существует, и предполагает выполнение проверки имени сетевого адреса и повторное выполнение команды.</span><span class="sxs-lookup"><span data-stu-id="9ef48-108">This [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] message indicates that the server network address cannot be reached or does not exist, and it suggests that you verify the network address name and reissue the command.</span></span> <span data-ttu-id="9ef48-109">Дополнительные сведения см. в разделе [MSSQLSERVER_1418](../../relational-databases/errors-events/mssqlserver-1418-database-engine-error.md) .</span><span class="sxs-lookup"><span data-stu-id="9ef48-109">For more information, see the [MSSQLSERVER_1418](../../relational-databases/errors-events/mssqlserver-1418-database-engine-error.md) topic.</span></span>|  
|[<span data-ttu-id="9ef48-110">Измерение счетов</span><span class="sxs-lookup"><span data-stu-id="9ef48-110">Accounts</span></span>](#Accounts)|<span data-ttu-id="9ef48-111">Обсуждаются требования к правильной настройке учетных записей, под которыми работает [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="9ef48-111">Discusses requirements for correctly configuring the accounts under which [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is running.</span></span>|  
|[<span data-ttu-id="9ef48-112">Конечные точки</span><span class="sxs-lookup"><span data-stu-id="9ef48-112">Endpoints</span></span>](#Endpoints)|<span data-ttu-id="9ef48-113">Обсуждаются требования к правильной настройке конечной точки зеркального отображения базы данных для каждого экземпляра сервера.</span><span class="sxs-lookup"><span data-stu-id="9ef48-113">Discusses requirements for correctly configuring the database mirroring endpoint of each server instance.</span></span>|  
|[<span data-ttu-id="9ef48-114">SystemAddress</span><span class="sxs-lookup"><span data-stu-id="9ef48-114">SystemAddress</span></span>](#SystemAddress)|<span data-ttu-id="9ef48-115">Обобщаются альтернативы указанию системного имени экземпляра сервера в конфигурации зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="9ef48-115">Summarizes the alternatives for specifying the system name of a server instance in a database mirroring configuration.</span></span>|  
|[<span data-ttu-id="9ef48-116">Сетевой доступ</span><span class="sxs-lookup"><span data-stu-id="9ef48-116">Network access</span></span>](#NetworkAccess)|<span data-ttu-id="9ef48-117">Документирует требования, согласно которым каждому экземпляру сервера разрешается доступ к портам других экземпляров сервера по протоколу TCP.</span><span class="sxs-lookup"><span data-stu-id="9ef48-117">Documents the requirement that each the server instance be able to access the ports of the other server instance or instances over TCP.</span></span>|  
|[<span data-ttu-id="9ef48-118">Подготовка зеркальной базы данных</span><span class="sxs-lookup"><span data-stu-id="9ef48-118">Mirror database preparation</span></span>](#MirrorDbPrep)|<span data-ttu-id="9ef48-119">Обобщаются требования к подготовке зеркальной базы данных для включения зеркального отображения.</span><span class="sxs-lookup"><span data-stu-id="9ef48-119">Summarizes the requirements for preparing the mirror database to enable mirroring to start.</span></span>|  
|[<span data-ttu-id="9ef48-120">Ошибка операции по созданию файла</span><span class="sxs-lookup"><span data-stu-id="9ef48-120">Failed create-file operation</span></span>](#FailedCreateFileOp)|<span data-ttu-id="9ef48-121">Описывается обработка сбоев при выполнении операции создания файла.</span><span class="sxs-lookup"><span data-stu-id="9ef48-121">Describes how to respond to a failed create-file operation.</span></span>|  
|[<span data-ttu-id="9ef48-122">Запуск зеркального отображения (язык Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="9ef48-122">Starting mirroring by Using Transact-SQL</span></span>](#StartDbm)|<span data-ttu-id="9ef48-123">Описывается, в каком порядке должны выполняться инструкции ALTER DATABASE *имя_базы_данных* SET PARTNER **='***сервер_участник***'** .</span><span class="sxs-lookup"><span data-stu-id="9ef48-123">Describes the required order for ALTER DATABASE *database_name* SET PARTNER **='***partner_server***'** statements.</span></span>|  
|[<span data-ttu-id="9ef48-124">Межбазовые транзакции</span><span class="sxs-lookup"><span data-stu-id="9ef48-124">Cross-Database Transactions</span></span>](#CrossDbTxns)|<span data-ttu-id="9ef48-125">Автоматический переход на другой ресурс может привести к автоматическому и, возможно, неверному разрешению проблемных транзакций.</span><span class="sxs-lookup"><span data-stu-id="9ef48-125">An automatic failover could lead to automatic and possibly incorrect resolution of in-doubt transactions.</span></span> <span data-ttu-id="9ef48-126">По этой причине зеркальное отображение базы данных не поддерживает транзакции между базами данных.</span><span class="sxs-lookup"><span data-stu-id="9ef48-126">For this reason database mirroring does not support cross-database transactions.</span></span>|  
  
##  <a name="accounts"></a><a name="Accounts"></a> <span data-ttu-id="9ef48-127">Измерение счетов</span><span class="sxs-lookup"><span data-stu-id="9ef48-127">Accounts</span></span>  
 <span data-ttu-id="9ef48-128">Учетные записи, под которыми работает [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , должны быть правильно настроены.</span><span class="sxs-lookup"><span data-stu-id="9ef48-128">The accounts under which [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is running must be correctly configured.</span></span>  
  
1.  <span data-ttu-id="9ef48-129">Имеют ли учетные записи нужные разрешения?</span><span class="sxs-lookup"><span data-stu-id="9ef48-129">Do the accounts have the correct permissions?</span></span>  
  
    1.  <span data-ttu-id="9ef48-130">Если учетные записи выполняются в одном домене, шанс неправильной настройки уменьшается.</span><span class="sxs-lookup"><span data-stu-id="9ef48-130">If the accounts are running in the same domain accounts, the chances of misconfiguration are reduced.</span></span>  
  
    2.  <span data-ttu-id="9ef48-131">Если учетные записи работают в разных доменах или не являются учетными записями домена, то в базе данных **master** на другом компьютере необходимо создать имя входа для учетной записи и предоставить ему разрешение CONNECT на конечную точку.</span><span class="sxs-lookup"><span data-stu-id="9ef48-131">If the accounts are running in different domains or are not domain accounts, the login of one account must be created in **master** on the other computer, and that login must be granted CONNECT permissions on the endpoint.</span></span> <span data-ttu-id="9ef48-132">Дополнительные сведения см. в статье [Управление метаданными при обеспечении доступности базы данных на другом экземпляре сервера (SQL Server)](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-132">For more information, see [Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span></span> <span data-ttu-id="9ef48-133">Эти требования распространяются на учетную запись сетевой службы.</span><span class="sxs-lookup"><span data-stu-id="9ef48-133">This includes the Network Service account.</span></span>  
  
2.  <span data-ttu-id="9ef48-134">Если [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняется как служба под локальной системной учетной записью, то для проверки подлинности необходимо использование сертификатов.</span><span class="sxs-lookup"><span data-stu-id="9ef48-134">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is running as a service that is using the local system account, you must use certificates for authentication.</span></span> <span data-ttu-id="9ef48-135">Дополнительные сведения см. в разделе [Использование сертификатов для конечной точки зеркального отображения базы данных (Transact-SQL)](use-certificates-for-a-database-mirroring-endpoint-transact-sql.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-135">For more information, see [Use Certificates for a Database Mirroring Endpoint &#40;Transact-SQL&#41;](use-certificates-for-a-database-mirroring-endpoint-transact-sql.md).</span></span>  
  
##  <a name="endpoints"></a><a name="Endpoints"></a> <span data-ttu-id="9ef48-136">Конечные точки</span><span class="sxs-lookup"><span data-stu-id="9ef48-136">Endpoints</span></span>  
 <span data-ttu-id="9ef48-137">Конечные точки должны быть правильно настроены.</span><span class="sxs-lookup"><span data-stu-id="9ef48-137">Endpoints must be correctly configured.</span></span>  
  
1.  <span data-ttu-id="9ef48-138">Убедитесь, что в каждом экземпляре сервера (основного, зеркального и следящего, если он есть) есть конечная точка зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="9ef48-138">Make sure that each server instance (the principal server, mirror server, and witness, if any) has a database mirroring endpoint.</span></span> <span data-ttu-id="9ef48-139">Дополнительные сведения см. в разделе [sys.database_mirroring_endpoints (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql), а также в зависимости от режима проверки подлинности в разделе [Создание конечной точки зеркального отображения базы данных с проверкой подлинности Windows (Transact-SQL)](create-a-database-mirroring-endpoint-for-windows-authentication-transact-sql.md) или [Использование сертификатов для конечной точки зеркального отображения базы данных (Transact-SQL)](use-certificates-for-a-database-mirroring-endpoint-transact-sql.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-139">For more information, see [sys.database_mirroring_endpoints &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql) and, depending on the form of authentication, either [Create a Database Mirroring Endpoint for Windows Authentication &#40;Transact-SQL&#41;](create-a-database-mirroring-endpoint-for-windows-authentication-transact-sql.md) or [Use Certificates for a Database Mirroring Endpoint &#40;Transact-SQL&#41;](use-certificates-for-a-database-mirroring-endpoint-transact-sql.md).</span></span>  
  
2.  <span data-ttu-id="9ef48-140">Убедитесь, что номера портов правильны.</span><span class="sxs-lookup"><span data-stu-id="9ef48-140">Check that the port numbers are correct.</span></span>  
  
     <span data-ttu-id="9ef48-141">Определить порт, в настоящее время связанный с конечной точкой зеркального отображения базы данных экземпляра сервера, можно через представления каталога [sys.database_mirroring_endpoints](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql) и [sys.tcp_endpoints](/sql/relational-databases/system-catalog-views/sys-tcp-endpoints-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="9ef48-141">To identify the port currently associated with database mirroring endpoint of a server instance, use the [sys.database_mirroring_endpoints](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql) and [sys.tcp_endpoints](/sql/relational-databases/system-catalog-views/sys-tcp-endpoints-transact-sql) catalog views.</span></span>  
  
3.  <span data-ttu-id="9ef48-142">Если при зеркальном отображении базы данных возникают труднообъяснимые неполадки, рекомендуется на каждом экземпляре сервера проверить, правильный ли порт он прослушивает.</span><span class="sxs-lookup"><span data-stu-id="9ef48-142">For database mirroring setup issues that are difficult to explain, we recommend that you inspect each server instance to determine whether it is listening on the correct ports.</span></span> <span data-ttu-id="9ef48-143">Сведения о проверке доступности порта см. в разделе [MSSQLSERVER_1418](../../relational-databases/errors-events/mssqlserver-1418-database-engine-error.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-143">For information about verifying port availability, see [MSSQLSERVER_1418](../../relational-databases/errors-events/mssqlserver-1418-database-engine-error.md).</span></span>  
  
4.  <span data-ttu-id="9ef48-144">Убедитесь, что конечные точки запущены (STATE=STARTED).</span><span class="sxs-lookup"><span data-stu-id="9ef48-144">Make sure that the endpoints are started (STATE=STARTED).</span></span> <span data-ttu-id="9ef48-145">На каждом экземпляре сервера выполните следующую инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="9ef48-145">On each server instance, use the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement.</span></span>  
  
    ```  
    SELECT state_desc FROM sys.database_mirroring_endpoints  
    ```  
  
     <span data-ttu-id="9ef48-146">Дополнительные сведения о столбце **state_desc** см. в разделе [sys.database_mirroring_endpoints (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="9ef48-146">For more information about the **state_desc** column, see [sys.database_mirroring_endpoints &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql).</span></span>  
  
     <span data-ttu-id="9ef48-147">Чтобы запустить конечную точку, выполните следующую инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="9ef48-147">To start an endpoint, use the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement.</span></span>  
  
    ```  
    ALTER ENDPOINT Endpoint_Mirroring   
    STATE = STARTED   
    AS TCP (LISTENER_PORT = <port_number>)  
    FOR database_mirroring (ROLE = ALL);  
    GO  
    ```  
  
     <span data-ttu-id="9ef48-148">Дополнительные сведения см. в статье [ALTER ENDPOINT (Transact-SQL)](/sql/t-sql/statements/alter-endpoint-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="9ef48-148">For more information, see [ALTER ENDPOINT &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-endpoint-transact-sql).</span></span>  
  
5.  <span data-ttu-id="9ef48-149">Убедитесь, что роль выбрана правильно.</span><span class="sxs-lookup"><span data-stu-id="9ef48-149">Check that the ROLE is correct.</span></span> <span data-ttu-id="9ef48-150">На каждом из экземпляров сервера выполните следующую инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="9ef48-150">On each server instance use the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement.</span></span>  
  
    ```  
    SELECT role FROM sys.database_mirroring_endpoints;  
    GO  
    ```  
  
     <span data-ttu-id="9ef48-151">Дополнительные сведения см. в статье [sys.database_mirroring_endpoints (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="9ef48-151">For more information, see [sys.database_mirroring_endpoints &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql).</span></span>  
  
6.  <span data-ttu-id="9ef48-152">Применение имени входа для учетной записи службы от другого экземпляра сервера требует наличия разрешения CONNECT.</span><span class="sxs-lookup"><span data-stu-id="9ef48-152">The login for the service account from the other server instance requires CONNECT permission.</span></span> <span data-ttu-id="9ef48-153">Убедитесь, что имени входа на другом сервере предоставлено разрешение CONNECT.</span><span class="sxs-lookup"><span data-stu-id="9ef48-153">Make sure that the login from the other server has CONNECT permission.</span></span> <span data-ttu-id="9ef48-154">Чтобы узнать, кто имеет разрешение CONNECT для конечной точки, выполните следующую инструкцию [!INCLUDE[tsql](../../includes/tsql-md.md)] на каждом экземпляре сервера:</span><span class="sxs-lookup"><span data-stu-id="9ef48-154">To determine who has CONNECT permission for an endpoint, on each server instance use the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement.</span></span>  
  
    ```  
    SELECT 'Metadata Check';  
    SELECT EP.name, SP.STATE,   
       CONVERT(nvarchar(38), suser_name(SP.grantor_principal_id))   
          AS GRANTOR,   
       SP.TYPE AS PERMISSION,  
       CONVERT(nvarchar(46),suser_name(SP.grantee_principal_id))   
          AS GRANTEE   
       FROM sys.server_permissions SP , sys.endpoints EP  
       WHERE SP.major_id = EP.endpoint_id  
       ORDER BY Permission,grantor, grantee;   
    GO  
  
    ```  
  
##  <a name="system-address"></a><a name="SystemAddress"></a> <span data-ttu-id="9ef48-155">Системный адрес</span><span class="sxs-lookup"><span data-stu-id="9ef48-155">System Address</span></span>  
 <span data-ttu-id="9ef48-156">В качестве системного имени экземпляра сервера в конфигурации зеркального отображения базы данных можно использовать любое имя, которое однозначно идентифицирует систему.</span><span class="sxs-lookup"><span data-stu-id="9ef48-156">For the system name of a server instance in a database mirroring configuration, you can use any name that unambiguously identifies the system.</span></span> <span data-ttu-id="9ef48-157">Адрес сервера может представлять собой системное имя (если системы находятся в одном), полное доменное имя или IP-адрес (желательно статический).</span><span class="sxs-lookup"><span data-stu-id="9ef48-157">The server address can be a system name (if the systems are in the same domain), a fully qualified domain name, or an IP address (preferably, a static IP address).</span></span> <span data-ttu-id="9ef48-158">Полное доменное имя будет работать гарантированно.</span><span class="sxs-lookup"><span data-stu-id="9ef48-158">Using the fully qualified domain name is guaranteed to work.</span></span> <span data-ttu-id="9ef48-159">Дополнительные сведения см. в разделе [Указание сетевого адреса сервера (зеркальное отображение базы данных)](specify-a-server-network-address-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-159">For more information, see [Specify a Server Network Address &#40;Database Mirroring&#41;](specify-a-server-network-address-database-mirroring.md).</span></span>  
  
##  <a name="network-access"></a><a name="NetworkAccess"></a> <span data-ttu-id="9ef48-160">Network Access</span><span class="sxs-lookup"><span data-stu-id="9ef48-160">Network Access</span></span>  
 <span data-ttu-id="9ef48-161">Каждому экземпляру сервера требуется доступ к портам других экземпляров сервера по протоколу TCP.</span><span class="sxs-lookup"><span data-stu-id="9ef48-161">Each server instance must be able to access the ports of the other server instance or instances over TCP.</span></span> <span data-ttu-id="9ef48-162">Это особенно важно, если экземпляры сервера находятся в разных доменах, не имеющих доверительных отношений друг с другом (домены без доверия).</span><span class="sxs-lookup"><span data-stu-id="9ef48-162">This is especially important if the server instances are in different domains that do not trust each other (untrusted domains).</span></span> <span data-ttu-id="9ef48-163">Это во многом ограничивает связь между экземплярами сервера.</span><span class="sxs-lookup"><span data-stu-id="9ef48-163">This restricts much of the communication between the server instances.</span></span>  
  
##  <a name="mirror-database-preparation"></a><a name="MirrorDbPrep"></a><span data-ttu-id="9ef48-164">Подготовка зеркальной базы данных</span><span class="sxs-lookup"><span data-stu-id="9ef48-164">Mirror Database Preparation</span></span>  
 <span data-ttu-id="9ef48-165">При первом запуске зеркального отображения или повторном запуске после удаления зеркального отображения убедитесь, что зеркальная база данных подготовлена.</span><span class="sxs-lookup"><span data-stu-id="9ef48-165">Whether starting mirroring for the first time or starting it again after mirroring was removed, verify that the mirror database is prepared for mirroring.</span></span>  
  
 <span data-ttu-id="9ef48-166">При создании зеркальной базы данных на зеркальном сервере убедитесь, что резервная копия основной базы данных восстановлена. Для этого укажите имя базы данных в предложении WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="9ef48-166">When you create the mirror database on the mirror server, make sure that you restore the backup of the principal database specifying the same database name WITH NORECOVERY.</span></span> <span data-ttu-id="9ef48-167">Кроме того, все резервные копии журналов, созданные после резервного копирования этой базы данных, также должны быть созданы с использованием предложения WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="9ef48-167">Also, all log backups created after that backup was taken must also be applied, again WITH NORECOVERY.</span></span>  
  
 <span data-ttu-id="9ef48-168">Кроме того, рекомендуется, чтобы путь к файлу зеркальной базы данных (включая имя диска) по возможности совпадал с путем к основной базе данных.</span><span class="sxs-lookup"><span data-stu-id="9ef48-168">Also, we recommend that, if it is possible, the file path (including the drive letter) of the mirror database be identical to the path of the principal database.</span></span> <span data-ttu-id="9ef48-169">Если пути к файлам должны различаться, например если основная база данных расположена на диске «F:», а в зеркальной системе нет диска «F:», необходимо включить в инструкцию RESTORE параметр MOVE.</span><span class="sxs-lookup"><span data-stu-id="9ef48-169">If the file paths must differ, for example, if the principal database is on drive 'F:' but the mirror system lacks an F: drive, you must include the MOVE option in the RESTORE statement.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="9ef48-170">Если при создании зеркальной базы данных переносятся файлы базы данных, то последующее добавление файлов к базе данных не всегда возможно без прекращения зеркального отображения.</span><span class="sxs-lookup"><span data-stu-id="9ef48-170">If you move the database files when you are creating the mirror database, you might be unable to add files to the database later without mirroring being suspended.</span></span>  
  
 <span data-ttu-id="9ef48-171">Если зеркальное отображение базы данных остановлено, то перед его повторным запуском к зеркальной базе данных необходимо применить все последующие резервные копии журналов, полученные с основной базы данных.</span><span class="sxs-lookup"><span data-stu-id="9ef48-171">If database mirroring has been stopped, all subsequent log backups taken on the principal database must be applied to the mirror database before mirroring can be restarted.</span></span>  
  
 <span data-ttu-id="9ef48-172">Дополнительные сведения см. в статье [Prepare a Mirror Database for Mirroring &#40;SQL Server&#41;](prepare-a-mirror-database-for-mirroring-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-172">For more information, see [Prepare a Mirror Database for Mirroring &#40;SQL Server&#41;](prepare-a-mirror-database-for-mirroring-sql-server.md).</span></span>  
  
##  <a name="failed-create-file-operation"></a><a name="FailedCreateFileOp"></a> <span data-ttu-id="9ef48-173">Failed Create-File Operation</span><span class="sxs-lookup"><span data-stu-id="9ef48-173">Failed Create-File Operation</span></span>  
 <span data-ttu-id="9ef48-174">Чтобы добавление файла не повлияло на сеанс зеркального отображения, путь к файлам должен существовать на обоих серверах.</span><span class="sxs-lookup"><span data-stu-id="9ef48-174">Adding a file without impacting a mirroring session requires that the path of the file exist on both servers.</span></span> <span data-ttu-id="9ef48-175">Поэтому перемещение файлов базы данных во время создания зеркального отображения может привести к его ошибке или остановке при выполнении операции добавления файла.</span><span class="sxs-lookup"><span data-stu-id="9ef48-175">Therefore, if you move the database files when creating the mirror database, a later add-file operation might fail on the mirror database and cause mirroring to be suspended.</span></span>  
  
 <span data-ttu-id="9ef48-176">Чтобы решить эту проблему, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="9ef48-176">To fix the problem:</span></span>  
  
1.  <span data-ttu-id="9ef48-177">Владелец базы данных должен удалить сеанс зеркального отображения и восстановить полную резервную копию файловой группы, содержащей добавленный файл.</span><span class="sxs-lookup"><span data-stu-id="9ef48-177">The database owner must remove the mirroring session and restore a full backup of the filegroup that contains the added file.</span></span>  
  
2.  <span data-ttu-id="9ef48-178">Затем необходимо создать резервную копию журналов, содержащего операцию добавления файла, на основном сервере и вручную восстановить резервную копию на зеркальной базе данных с помощью параметров WITH NORECOVERY и WITH MOVE.</span><span class="sxs-lookup"><span data-stu-id="9ef48-178">The owner must then back up the log containing the add-file operation on the principal server and manually restore the log backup on the mirror database using the WITH NORECOVERY and WITH MOVE options.</span></span> <span data-ttu-id="9ef48-179">Эти действия приведут к созданию указанного пути к файлу на зеркальном сервере и восстановлению нового файла по этому пути.</span><span class="sxs-lookup"><span data-stu-id="9ef48-179">Doing this creates the specified file path on the mirror server and restores the new file to that location.</span></span>  
  
3.  <span data-ttu-id="9ef48-180">Чтобы подготовить базу данных для нового сеанса зеркального отображения, владельцу также необходимо восстановить с параметром WITH NO RECOVERY все необработанные резервные копии журналов с основного сервера.</span><span class="sxs-lookup"><span data-stu-id="9ef48-180">To prepare the database for a new mirroring session, the owner must also restore WITH NO RECOVERY any other outstanding log backups from the principal server.</span></span>  
  
 <span data-ttu-id="9ef48-181">Дополнительные сведения см. в разделе [Удаление зеркального отображения базы данных (SQL Server)](database-mirroring-sql-server.md), [Подготовка зеркальной базы данных к зеркальному отображению (SQL Server)](prepare-a-mirror-database-for-mirroring-sql-server.md), [Создание сеанса зеркального отображения базы данных с использованием проверки подлинности Windows (Transact-SQL)](database-mirroring-establish-session-windows-authentication.md), [Использование сертификатов для конечной точки зеркального отображения базы данных (Transact-SQL)](use-certificates-for-a-database-mirroring-endpoint-transact-sql.md) или [Создание сеанса зеркального отображения базы данных с использованием проверки подлинности Windows (среда SQL Server Management Studio)](establish-database-mirroring-session-windows-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-181">For more information, see [Removing Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md), [Prepare a Mirror Database for Mirroring &#40;SQL Server&#41;](prepare-a-mirror-database-for-mirroring-sql-server.md), [Establish a Database Mirroring Session Using Windows Authentication &#40;Transact-SQL&#41;](database-mirroring-establish-session-windows-authentication.md), [Use Certificates for a Database Mirroring Endpoint &#40;Transact-SQL&#41;](use-certificates-for-a-database-mirroring-endpoint-transact-sql.md), or [Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md).</span></span>  
  
##  <a name="starting-mirroring-by-using-transact-sql"></a><a name="StartDbm"></a><span data-ttu-id="9ef48-182">Запуск зеркального отображения с помощью Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="9ef48-182">Starting mirroring by Using Transact-SQL</span></span>  
 <span data-ttu-id="9ef48-183">Порядок выполнения инструкций ALTER DATABASE *имя_базы_данных* SET PARTNER **='***сервер_участник***'** очень важен.</span><span class="sxs-lookup"><span data-stu-id="9ef48-183">The order in which the ALTER DATABASE *database_name* SET PARTNER **='***partner_server***'** statements are issued is very important.</span></span>  
  
1.  <span data-ttu-id="9ef48-184">Первая инструкция должна выполняться на зеркальном сервере.</span><span class="sxs-lookup"><span data-stu-id="9ef48-184">The first statement must be run on the mirror server.</span></span> <span data-ttu-id="9ef48-185">В этот момент зеркальный сервер не пытается соединиться с каким бы то ни было другим экземпляром сервера.</span><span class="sxs-lookup"><span data-stu-id="9ef48-185">When this statement is issued, the mirror server does not try to contact any other server instance.</span></span> <span data-ttu-id="9ef48-186">Вместо этого он предписывает своей базе данных ждать, пока основной сервер не свяжется с зеркальным сервером.</span><span class="sxs-lookup"><span data-stu-id="9ef48-186">Instead, the mirror server instructs its database to wait until the mirror server has been contacted by the principal server.</span></span>  
  
2.  <span data-ttu-id="9ef48-187">Вторая инструкция ALTER DATABASE должна выполняться на основном сервере.</span><span class="sxs-lookup"><span data-stu-id="9ef48-187">The second ALTER DATABASE statement must be run on the principal server.</span></span> <span data-ttu-id="9ef48-188">Она предписывает основному серверу подключиться к зеркальному.</span><span class="sxs-lookup"><span data-stu-id="9ef48-188">This statement causes the principal server to try to connect to the mirror server.</span></span> <span data-ttu-id="9ef48-189">После создания этого соединения зеркальный сервер пытается подключиться к основному серверу через другое соединение.</span><span class="sxs-lookup"><span data-stu-id="9ef48-189">After that connection is created, the mirror then tries to connect to the principal server on another connection.</span></span>  
  
 <span data-ttu-id="9ef48-190">Дополнительные сведения см. в разделе [ALTER DATABASE (Transact-SQL)](/sql/t-sql/statements/alter-database-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="9ef48-190">For more information, see [ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9ef48-191">Сведения о запуске зеркального отображения в среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] см. в разделе [Создание сеанса зеркального отображения базы данных с использованием проверки подлинности Windows (среда SQL Server Management Studio)](establish-database-mirroring-session-windows-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-191">For information about using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] to start mirroring, see [Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md).</span></span>  
  
##  <a name="cross-database-transactions"></a><a name="CrossDbTxns"></a><span data-ttu-id="9ef48-192">Транзакции между базами данных</span><span class="sxs-lookup"><span data-stu-id="9ef48-192">Cross-Database Transactions</span></span>  
 <span data-ttu-id="9ef48-193">Если база данных зеркально отображается в режиме высокого уровня безопасности с автоматической отработкой отказа, то она может привести к неверному разрешению проблемных транзакций.</span><span class="sxs-lookup"><span data-stu-id="9ef48-193">When a database is being mirrored in high-safety mode with automatic failover, an automatic failover could lead to automatic and possibly incorrect resolution of in-doubt transactions.</span></span> <span data-ttu-id="9ef48-194">Если автоматическая отработка отказа на зеркальную базу данных происходит во время фиксации межбазовой транзакции, то между этими базами данных может возникнуть логическая несогласованность.</span><span class="sxs-lookup"><span data-stu-id="9ef48-194">If an automatic failover occurs on either database while a cross-database transaction is being committed, logical inconsistencies can occur between the databases.</span></span>  
  
 <span data-ttu-id="9ef48-195">Межбазовые транзакции, на которые может повлиять автоматическая отработка отказа, могут относиться к следующим типам:</span><span class="sxs-lookup"><span data-stu-id="9ef48-195">The types of cross-database transactions that can be affected by an automatic failover include the following:</span></span>  
  
-   <span data-ttu-id="9ef48-196">транзакции, обновляющие несколько баз данных в одном экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)];</span><span class="sxs-lookup"><span data-stu-id="9ef48-196">A transaction that is updating multiple databases in the same instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="9ef48-197">Транзакции, использующие координатор распределенных транзакций [!INCLUDE[msCoName](../../includes/msconame-md.md)] (MS DTC).</span><span class="sxs-lookup"><span data-stu-id="9ef48-197">Transactions that use a [!INCLUDE[msCoName](../../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC).</span></span>  
  
 <span data-ttu-id="9ef48-198">Дополнительные сведения см. в разделе [Транзакции между базами данных не поддерживаются при зеркальном отображении баз данных или в группах доступности AlwaysOn (SQL Server)](../availability-groups/windows/transactions-always-on-availability-and-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="9ef48-198">For more information, see [Cross-Database Transactions Not Supported For Database Mirroring or AlwaysOn Availability Groups &#40;SQL Server&#41;](../availability-groups/windows/transactions-always-on-availability-and-database-mirroring.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="9ef48-199">См. также:</span><span class="sxs-lookup"><span data-stu-id="9ef48-199">See Also</span></span>  
 <span data-ttu-id="9ef48-200">[Настройка зеркального отображения базы данных (SQL Server)](setting-up-database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="9ef48-200">[Setting Up Database Mirroring &#40;SQL Server&#41;](setting-up-database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="9ef48-201">Безопасность транспорта для зеркального отображения базы данных и группы доступности AlwaysOn &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="9ef48-201">Transport Security for Database Mirroring and AlwaysOn Availability Groups &#40;SQL Server&#41;</span></span>](transport-security-database-mirroring-always-on-availability.md)  
  
  
