---
title: Уменьшение времени простоя зеркальных баз данных при обновлении экземпляров сервера | Документация Майкрософт
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- upgrading SQL Server, rolling upgrade of mirrored databases
- database mirroring [SQL Server], upgrading system
- rolling upgrades [SQL Server]
ms.assetid: 0e73bd23-497d-42f1-9e81-8d5314bcd597
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0a343e6b9e93aa1910c82f436f3a50daf00d57bc
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658400"
---
# <a name="minimize-downtime-for-mirrored-databases-when-upgrading-server-instances"></a>Снижение времени простоя зеркальных баз данных при обновлении экземпляров сервера
  При обновлении экземпляров сервера до [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] можно сократить время простоя для каждой зеркально отображаемой базы данных на отработку отказа вручную, выполнив последовательное обновление, которое называется последовательным *обновлением*. Последовательное обновление является многоэтапным процессом, который в самом простом случае заключается в обновлении экземпляра сервера, который выступает в роли зеркального сервера в сеансе зеркального отображения, и последующего перехода на зеркальную базу данных вручную, обновления сервера, бывшего основным, и возобновления зеркального отображения. Набор операций, фактически применяемый на практике, будет зависеть от режима работы, а также от количества и структуры сеансов зеркального отображения, активных в обновляемых экземплярах сервера.  
  
> [!NOTE]  
>  Сведения о выполнении последовательного обновления для установки пакета обновления или исправления см. в статье [Установка пакета обновления в системе с минимальным временем простоя для зеркальных баз данных](../install-a-service-pack-on-a-system-with-minimal-downtime-for-mirrored-databases.md).  
  
 **Рекомендуемые подготовительные действия (рекомендации)**  
  
 Перед запуском последовательного обновления рекомендуется выполнить следующие действия.  
  
1.  Выполните пробную отработку отказа вручную по крайней мере в одном из сеансов зеркального отображения:  
  
    -   [Переключение сеанса зеркального отображения базы данных на другой ресурс вручную (среда SQL Server Management Studio)](manually-fail-over-a-database-mirroring-session-sql-server-management-studio.md)  
  
    -   [Переключение сеанса зеркального отображения базы данных на другой ресурс вручную (язык Transact-SQL)](manually-fail-over-a-database-mirroring-session-transact-sql.md).  
  
    > [!NOTE]  
    >  Дополнительные сведения об отработке отказа вручную см. в разделе [Переключение ролей во время сеанса зеркального отображения базы данных (SQL Server)](role-switching-during-a-database-mirroring-session-sql-server.md).  
  
2.  Обеспечьте защиту данных.  
  
    1.  Создайте полную резервную копию каждой основной базы данных.  
  
         [Создание полной резервной копии базы данных (SQL Server)](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md)  
  
    2.  Выполните команду [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) в каждой основной базе данных.  
  
 **Этапы последовательного обновления**  
  
 Конкретная последовательность действий в ходе последовательного обновления зависит от режима работы конфигурации зеркального отображения. Однако основные этапы остаются одинаковыми.  
  
> [!NOTE]  
>  Сведения о режимах работы см. в разделе [Режимы работы зеркального отображения базы данных](database-mirroring-operating-modes.md).  
  
 Блок-схема на следующем рисунке показывает основные этапы последовательного обновления для каждого режима работы. После рисунка описаны соответствующие процедуры.  
  
 ![Блок-схема, показывающая шаги последовательного обновления](../media/dbm-rolling-upgrade.gif "Блок-схема, показывающая шаги последовательного обновления")  
  
> [!IMPORTANT]  
>  Экземпляр сервера может одновременно исполнять различные роли зеркального отображения (основной сервер, зеркальный сервер или следящий сервер) в параллельных сеансах зеркального отображения. В этом случае придется соответствующим образом адаптировать процесс последовательного обновления. Дополнительные сведения см. в статье [Переключение ролей во время сеанса зеркального отображения базы данных (SQL Server)](role-switching-during-a-database-mirroring-session-sql-server.md).  
  
### <a name="to-change-a-session-from-high-performance-mode-to-high-safety-mode"></a>Изменение режима сеанса с высокопроизводительного на режим высокой безопасности  
  
1.  Если сеанс зеркального отображения выполняется в высокопроизводительном режиме, перед выполнением последовательного обновления измените его на режим высокой безопасности без автоматической отработки отказа.  
  
    > [!IMPORTANT]  
    >  Если зеркальный сервер географически удален от основного, то последовательное обновление может оказаться неподходящим вариантом.  
  
    -   В [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]: измените параметр **Режим работы** на **Высокая безопасность без автоматической отработки отказа (синхронный)** с помощью страницы [Зеркальное отображение](../../relational-databases/databases/database-properties-mirroring-page.md) диалогового окна **Свойства базы данных**. Дополнительные сведения о доступе к этой странице см. в разделе [Запуск мастер настройки безопасности зеркального отображения баз данных (среда SQL Server Management Studio)](start-the-configuring-database-mirroring-security-wizard.md).  
  
    -   В [!INCLUDE[tsql](../../includes/tsql-md.md)]: установите безопасность транзакций как FULL. Дополнительные сведения см. в разделе [Изменение безопасности транзакций в сеансах зеркального отображения базы данных (Transact-SQL)](change-transaction-safety-in-a-database-mirroring-session-transact-sql.md).  
  
### <a name="to-remove-a-witness-from-a-session"></a>Удаление следящего сервера из сеанса  
  
1.  Если сеанс зеркального отображения включает следящий сервер, рекомендуется удалить его перед выполнением последовательного обновления. В противном случае при обновлении экземпляра зеркального сервера доступность базы данных будет зависеть от следящего сервера, остающегося подключенным к экземпляру основного сервера. После удаления следящего сервера его можно обновить в любой момент во время последовательного обновления, без дополнительного простоя базы данных.  
  
    > [!NOTE]  
    >  Дополнительные сведения см. в статье [Кворум. Как следящий сервер влияет на доступность базы данных &#40;зеркальное отображение базы данных&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).  
  
    -   [Удаление следящего сервера из сеанса зеркального отображения базы данных (SQL Server)](remove-the-witness-from-a-database-mirroring-session-sql-server.md)  
  
### <a name="to-perform-the-rolling-upgrade"></a>Выполнение последовательного обновления  
  
1.  Чтобы свести к минимуму время простоя, необходимо выполнить следующие рекомендации. Начните пошаговое обновление с обновления участника зеркального отображения, который в настоящий момент является зеркальным сервером во всех сеансах зеркального отображения. На этом этапе, возможно, придется обновить несколько экземпляров сервера.  
  
    > [!NOTE]  
    >  Следящий сервер можно обновить в любой момент пошагового обновления. Например, если экземпляр сервера является зеркальным сервером в сеансе 1 и следящим сервером в сеансе 2, этот сервер можно обновить сразу.  
  
     Экземпляр сервера, который следует обновлять в первую очередь, зависит от текущей конфигурации сеансов зеркального отображения следующим образом.  
  
    -   Если какой-либо экземпляр сервера уже является зеркальным сервером во всех сеансах зеркального отображения, обновите его до новой версии.  
  
    -   Если все экземпляры сервера в настоящий момент являются основным сервером в одном из сеансов зеркального отображения, выберите для обновления один экземпляр сервера. Затем вручную переведите на другой ресурс каждую из его основных баз данных и обновите экземпляр сервера.  
  
     После обновления экземпляр сервера автоматически подключится к сеансам зеркального отображения.  
  
2.  В каждом сеансе зеркального отображения, зеркальный сервер которого был обновлен, дождитесь окончания синхронизации сеанса. Затем подключитесь к экземпляру основного сервера и вручную переведите этот сеанс на другой ресурс. При отработки отказа обновленный сервер становится основным сервером для этого сеанса, а бывший основной сервер становится зеркальным.  
  
     Цель этого этапа — сделать другой экземпляр сервера зеркальным во всех сеансах зеркального отображения, в которых он участвует.  
  
     **Ограничения, возникающие после перехода на обновленную отработку отказа сервера.**  
  
     После перехода с более ранней версии экземпляра сервера на экземпляр сервера [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] сеанс зеркального отображения базы данных приостанавливается. Его нельзя возобновить, пока не будет обновлен другой участник. Однако основной сервер принимает подключения и разрешает доступ и изменение данных в основной базе данных.  
  
    > [!NOTE]  
    >  Для установки нового сеанса зеркального отображения требуется, чтобы на всех участниках работала одинаковая версия [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  
  
3.  После отработки отказа рекомендуется выполнить команду [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) в базе данных сепринЦипал.  
  
4.  Обновите каждый экземпляр сервера, который в настоящий момент является зеркальным сервером во всех сеансах зеркального отображения, в которых он участвует. На этом этапе, возможно, придется обновить несколько серверов.  
  
    > [!IMPORTANT]  
    >  В сложной конфигурации зеркального отображения некоторые экземпляры сервера могут все еще исполнять роль основного сервера в одном или нескольких сеансах зеркального отображения. Повторите шаги 2–4 для этих экземпляров серверов, пока не будут обновлены все вовлеченные в этот процесс экземпляры.  
  
5.  Возобновление сеанса зеркального отображения.  
  
    > [!NOTE]  
    >  Автоматическая отработка отказа не будет работать, пока следящий сервер не будет обновлен и возвращен в сеанс зеркального отображения.  
  
6.  Обновите все оставшиеся экземпляры сервера, являющиеся следящими во всех сеансах зеркального отображения. После подключения обновленного следящего сервера к сеансу зеркального отображения становится возможным автоматическая отработка отказа. На этом этапе, возможно, придется обновить несколько серверов.  
  
### <a name="to-return-a-session-to-high-performance-mode"></a>Возвращение сеанса в высокопроизводительный режим  
  
1.  При необходимости вернитесь в высокопроизводительный режим, используя один из следующих методов.  
  
    -   В [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]: измените параметр **Режим работы** на **Высокая производительность (асинхронный)** с помощью страницы [Зеркальное отображение](../../relational-databases/databases/database-properties-mirroring-page.md) диалогового окна **Свойства базы данных**.  
  
    -   В [!INCLUDE[tsql](../../includes/tsql-md.md)]: с помощью команды [ALTER DATABASE](/sql/t-sql/statements/alter-database-transact-sql-database-mirroring) установите безопасность транзакций в значение OFF.  
  
### <a name="to-add-a-witness-back-into-a-mirroring-session"></a>Возвращение следящего сервера в сеанс зеркального отображения  
  
1.  При необходимости в режиме высокой безопасности повторно соедините следящий сервер со всеми сеансами зеркального отображения.  
  
     **Возврат следящего сервера**  
  
    -   [Добавление или замена следящего сервера зеркального отображения базы данных (среда SQL Server Management Studio)](add-or-replace-a-database-mirroring-witness-sql-server-management-studio.md)  
  
    -   [Добавление следящего сервера для зеркального отображения базы данных с использованием проверки подлинности Windows (Transact-SQL)](add-a-database-mirroring-witness-using-windows-authentication-transact-sql.md)  
  
## <a name="see-also"></a>См. также:  
 [Зеркальное отображение базы данных ALTER DATABASE (Transact-SQL)](/sql/t-sql/statements/alter-database-transact-sql-database-mirroring)   
 [BACKUP (Transact-SQL)](/sql/t-sql/statements/backup-transact-sql)   
 [Просмотр состояния зеркального отображения базы данных (среда SQL Server Management Studio)](view-the-state-of-a-mirrored-database-sql-server-management-studio.md)   
 [Зеркальное отображение базы данных (SQL Server)](database-mirroring-sql-server.md)   
 [Установка пакета обновления в системе с минимальным временем простоя для зеркальных баз данных](../install-a-service-pack-on-a-system-with-minimal-downtime-for-mirrored-databases.md)   
 [Переключение ролей во время сеанса зеркального отображения базы данных (SQL Server)](role-switching-during-a-database-mirroring-session-sql-server.md)   
 [Принудительный запуск службы в сеансе зеркального отображения базы данных (Transact-SQL)](force-service-in-a-database-mirroring-session-transact-sql.md)   
 [Запуск монитора зеркального отображения баз данных (среда SQL Server Management Studio)](start-database-mirroring-monitor-sql-server-management-studio.md)   
 [Режимы работы зеркального отображения базы данных](database-mirroring-operating-modes.md)  
  
  
