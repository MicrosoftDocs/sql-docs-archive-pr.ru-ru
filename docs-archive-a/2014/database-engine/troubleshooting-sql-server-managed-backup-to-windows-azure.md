---
title: Устранение неполадок SQL Server управляемого резервного копирования в Azure | Документация Майкрософт
description: В этой статье описываются задачи и средства, которые можно использовать для устранения ошибок, которые могут возникнуть во время SQL Server управляемого резервного копирования для Microsoft Azure операций.
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: a34d35b0-48eb-4ed1-9f19-ea14754650da
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: 9c7ed5dd25ed2b02445bfae5eb78ac03b2270552
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87732894"
---
# <a name="troubleshooting-sql-server-managed--backup-to-azure"></a>Устранение неполадок с управляемым резервным копированием SQL Server в Azure
  В этом разделе описываются задачи и средства, позволяющие устранять ошибки, которые могут возникнуть при выполнении операций [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
## <a name="overview"></a>Обзор  
 В [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] есть встроенные проверки и процедуры устранения неполадок, поэтому во многих случаях внутренними сбоями занимается сам процесс [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
 Примером такого случая является удаление файла резервной копии, что привело к разрыву цепочки журналов, влияющей на возможность восстановления [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] . будет определять перерыв в цепочке журналов и планировать резервное копирование немедленно. Однако рекомендуется отслеживать состояние и устранять все ошибки, требующие вмешательства пользователя.  
  
 В журналы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] записываются события и ошибки с использованием системных хранимых процедур, системных представлений и расширенных событий. Системные представления и хранимые процедуры предоставляют данные конфигурации [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], состояние запланированных операций резервного копирования, а также ошибки, зарегистрированные расширенными событиями. [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] использует расширенные события для регистрации событий и последующего устранения неполадок. Помимо регистрации событий политики SQL Server Smart Admin предоставляют состояние работоспособности, используемое заданием уведомления по электронной почте для отправки уведомлений об ошибках и проблемах. Дополнительные сведения см. [в статье мониторинг SQL Server управляемого резервного копирования в Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).  
  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]также использует то же ведение журнала, которое используется при ручном резервном копировании в службу хранилища Azure (SQL Server резервное копирование на URL-адрес). Дополнительные сведения о проблемах резервного копирования по URL-адресу см. в разделе Устранение неполадок статьи [SQL Server резервное копирование в URL-адрес рекомендации и устранение неполадок](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md) .  
  
### <a name="general-troubleshooting-steps"></a>Основные шаги диагностики  
  
1.  Включите уведомление по электронной почте, чтобы получать сообщения с ошибками и предупреждениями.  
  
     Кроме того, можно периодически выполнять `smart_admin.fn_get_health_status` для проверки статистических ошибок и счетчиков. Например, `number_of_invalid_credential_errors` указывает, сколько раз резервное копирование Smart Backup завершилось с ошибкой из-за неверных учетных данных. `Number_of_backup_loops` и `number_of_retention_loops` не являются ошибками, но указывают, сколько раз поток резервного копирования и поток хранения сканировали список баз данных. Как правило, когда @begin_time и @end_time не предоставляется, функция отображает сведения за последние 30 минут, а затем обычно для этих двух столбцов должны отображаться ненулевые значения. Если они равны нулю, это означает, что система перегружена или даже не отвечает. Дополнительные сведения см. в подразделе **Устранение неполадок системы** далее в этом разделе.  
  
2.  Изучите журналы расширенных событий, чтобы получить дополнительные сведения об ошибках и связанных событиях.  
  
3.  Данные в журналах помогут устранить проблему.  В случае системной проблемы или ошибки, возможно, придется перезапустить службу или агент SQL Server.  
  
### <a name="common-causes-of-errors"></a>Распространенные причины появления ошибок  
 Далее представлен список распространенных причин, приводящих к сбоям.  
  
1.  **Изменения в учетных данных SQL:** Если имя учетных данных, используемое, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] изменилось или удалено, то [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не сможет создавать резервные копии. Изменение должно быть применено к параметрам конфигурации [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
2.  **Изменения в значениях ключа доступа к хранилищу:** Если значения ключа хранилища изменены для учетной записи Azure, но учетные данные SQL не обновляются новыми значениями, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] будут завершаться ошибкой при проверке подлинности в хранилище и не смогут создать резервные копии баз данных, настроенных для использования этой учетной записи.  
  
3.  **Изменения в учетной записи хранения Azure:** Удаление или переименование учетной записи хранения без соответствующих изменений учетных данных SQL приведет [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] к сбою и резервные копии не будут выполняться. При удалении учетной записи хранения убедитесь, что в настройки баз данных будут внесены сведения о действительной учетной записи хранения. Если учетная запись хранения переименована или меняются значения ключей, убедитесь в том, что эти изменения отражены в учетных данных SQL, используемых [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
4.  **Изменения в свойствах базы данных:** Внесение изменений в модели восстановления или изменение имени может привести к сбою резервного копирования.  
  
5.  **Изменения в модели восстановления:** Если модель восстановления базы данных изменена на Simple с полной или с неполным протоколированием, резервные копии будут прекращаться, а базы данных будут пропущены [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] . Дополнительные сведения см [. в статье SQL Server управляемое резервное копирование в Azure: взаимодействие и сосуществование.](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-interoperability-and-coexistence.md)  
  
### <a name="most-common-error-messages-and-solutions"></a>Самые распространенные сообщения об ошибках и способы их устранения  
  
1.  **Ошибки при включении или настройке [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] :**  
  
     Ошибка: "не удалось получить доступ к URL-адресу хранилища... Укажите допустимые учетные данные SQL... ": вы можете увидеть эту и другие аналогичные ошибки, ссылающиеся на учетные данные SQL.  В таких случаях проверьте имя предоставленных учетных данных SQL, а также сведения, хранящиеся в учетных данных SQL — имя учетной записи хранения и ключ доступа к хранилищу, и убедитесь, что они являются актуальными и допустимыми.  
  
     Ошибка: "... не удается настроить базу данных... так как это системная база данных ": вы увидите эту ошибку при попытке включить [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для системной базы данных.  [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не поддерживает резервные копии для системных баз данных.  Чтобы настроить резервное копирование для системных баз данных, используйте другие технологии резервного копирования SQL Server, например планы обслуживания.  
  
     Ошибка: "... Укажите срок хранения.... ": вы можете столкнуться с ошибками, связанными с сроком хранения, если вы не указали срок хранения для базы данных или экземпляра при первой настройке этих значений. Ошибка также может возникнуть в том случае, если указано значение, не входящее в диапазон от 1 до 30. Допустимые значения срока хранения — число от 1 до 30.  
  
2.  **Сообщения с уведомлениями по электронной почте**  
  
     Ошибка: "Database Mail не включена..." — вы увидите эту ошибку, если включаете уведомления по электронной почте, но Database Mail не настроена в экземпляре. Необходимо настроить компонент Database Mail в экземпляре, чтобы получать уведомление о состоянии работоспособности [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]. Сведения о том, как включить компонент Database Mail, см. в разделе [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md). Чтобы использовать Database Mail для уведомлений, также необходимо включить агент SQL Server. Дополнительные сведения см. в разделе [перед началом](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md#BeforeYouBegin).  
  
     Ниже приведен список кодов возможных ошибок, связанных с уведомлениями по электронной почте.  
  
    -   Номер ошибки: 45209  
  
    -   Номер ошибки: 45210  
  
    -   Номер ошибки: 45211  
  
3.  **Ошибки подключения:**  
  
    -   **Ошибки, связанные с подключением SQL:** Эти ошибки возникают при возникновении проблем с подключением к SQL Server экземпляру. Расширенные события предоставляют тип ошибок в канале администратора. Далее приведены два расширенных события, которые можно видеть в связи с возникновением ошибок подключения.  
  
         FileRetentionAdminXEvent with event_type = SqlError. Сведения о данной ошибке см. в параметрах error_code, error_message и stack_trace данного события. Error_code — номер ошибки SqlException.  
  
         SmartBackupAdminXevent со следующими префиксами сообщения:  
  
         *"Произошла внутренняя ошибка при настройке SQL Server управляемого резервного копирования в параметры Azure по умолчанию для экземпляра. Ошибка может быть временной. "*  
  
         *"Возможно, возникли проблемы с подключением к SQL Server. Пропуск базы данных в текущей итерации ".*  
  
         *"Не удалось запросить сведения об использовании журнала. Сбой может быть временным. Пропуск базы данных в текущей итерации ".*  
  
         *"При загрузке метаданных агента SSMBackup2WA возникло исключение SQL. Сбой может быть временным. Операция будет повторена. "*  
  
         *"SSMBackup2WA обнаружил исключение SQL while... "*  
  
    -   **Ошибки при подключении к учетной записи хранения**  
  
         Исключения хранилища в событии FileRetentionAdminXEvent с event_type = XstoreError. Сведения о данной ошибке см. в параметрах error_message и stack_trace данного события.  
  
         В управляемом резервном копировании SQL Server используется нижележащий компонент «Резервное копирование на URL-адрес», поэтому ошибки, связанные с подключением к хранилищу, относятся к обоим компонентам. Дополнительные сведения об устранении неполадок см. в **разделе "Устранение неполадок** " статьи [рекомендации по SQL Server резервного копирования на URL-адреса и инструкции по устранению неполадок](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md) .  
  
### <a name="troubleshooting-system-issues"></a>Проблемы системы диагностики  
 Ниже приведены некоторые сценарии, описывающие проблему с системой (SQL Server, агент SQL Server) и ее влияние на [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
-   **Sqlservr.exe перестает отвечать на запросы или прекращает работу при [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] выполнении:** если SQL Server перестанет работать, работа агента SQL Server будет остановлена, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] также прекращается и события регистрируются в файле агента SQL. out.  
  
     Если SQL Server прекращает отвечать, события записываются в канал администратора.  Пример журнала событий.  
  
     *Ошибка SQL (модуль не отвечает или Get sqlException: SqlException:*   
     *код ошибки, сообщение и StackTrace будут отображаться в XEvent на канале администрирования, а также некоторые дополнительные сведения, например:*   
    *"Возможно, возникли проблемы с подключением к SQL Server. Пропуск базы данных в текущей итерации "*  
  
-   **Агент SQL Server перестает отвечать на запросы или перестает работать при [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] выполнении:**  
  
     Если агент SQL Server прекращает работу, то службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] также останавливаются, а события записываются в канал администратора. Это аналогично сценариям, когда SQL Server прекращает отвечать.  
  
     Если агент SQL Server прекращает отвечать, то службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не смогут продолжать операции резервного копирования, а события будут записаны в канал администратора. Пример журнала событий.  
  
     *Зависание задания: см. канал администратора XEvents*   
    *"Не было получено обновление хода выполнения SQL Server более чем" + констант. Дббаккупинфомсгмаксваиттиме + "часов для резервного копирования базы данных.   SSM облачное резервное копирование будет продолжать ждать ".*  
  
 Если вы включили уведомления по электронной почте, вы получите уведомление, которое включает **число циклов резервного копирования** и **число циклов хранения**. Если значения, возвращенные в уведомлении для одного или обоих этих столбцов, равны нулю, это может указывать на то, что система не отвечает.  
  
> [!WARNING]  
>  Внутренние процессы, которые формируют результаты для отчета, предполагают, что журналы диагностики ядра находятся в одном расположении с журналом ошибок агента SQL, который по умолчанию находится в той же папке, что и журналы ошибок экземпляра SQL Server. Если в журналах диагностики ядра перемещаются в каталог, который отличается от места хранения журнала ошибок агента SQL Server, то система не может найти журналы диагностики интеллектуального резервного копирования, что в свою очередь ведет к тому, что отчет, приведенный в отправляемом по электронной почте уведомлении, может быть неправильным. Например, вы можете увидеть значение **0** во всех полях, включая количество циклов резервного копирования и число циклов хранения. В этом случае, когда журналы диагностики перемещены в другое расположение, это может означать не то, что система не отвечает, а то, что система не может найти журналы. Прежде всего убедитесь в том, что журналы диагностики и журналы ошибок агента SQL Server находятся в одном расположении. Чтобы проверить текущее расположение журналов диагностики, можно использовать представление [sys. dm_os_server_diagnostics_log_configurations](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-server-diagnostics-log-configurations). `path`Столбец возвращает текущее расположение журналов диагностики подсистемы.  Он должен находиться в той же папке, что и журналы ошибок агента SQL. Получить путь к журналам ошибок агента SQL Server можно с помощью хранимой процедуры `dbo.sp_get_sqlagent_properties`.  
  
 Проверьте журналы расширенных событий, чтобы просмотреть подробные сведения об ошибках. исправьте ошибки или перезапустите агент SQL Server, чтобы исправить ситуацию.  
  
  
