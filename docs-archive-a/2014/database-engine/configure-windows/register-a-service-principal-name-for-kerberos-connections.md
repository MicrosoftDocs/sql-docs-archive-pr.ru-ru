---
title: Регистрация имени участника-службы для соединений Kerberos | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- connections [SQL Server], SPNs
- network connections [SQL Server], SPNs
- registering SPNs
- Server Principal Names
- SPNs [SQL Server]
ms.assetid: e38d5ce4-e538-4ab9-be67-7046e0d9504e
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: f4db1e8b86fca057acbce29491be9c2be91f0748
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87667396"
---
# <a name="register-a-service-principal-name-for-kerberos-connections"></a><span data-ttu-id="14104-102">Регистрация имени участника-службы для соединений Kerberos</span><span class="sxs-lookup"><span data-stu-id="14104-102">Register a Service Principal Name for Kerberos Connections</span></span>
  <span data-ttu-id="14104-103">Чтобы использовать проверку подлинности Kerberos с [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , необходимо наличие следующих условий.</span><span class="sxs-lookup"><span data-stu-id="14104-103">To use Kerberos authentication with [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] requires both the following conditions to be true:</span></span>  
  
-   <span data-ttu-id="14104-104">Компьютеры клиента и сервера должны быть частью одного домена Windows или доверенных доменов.</span><span class="sxs-lookup"><span data-stu-id="14104-104">The client and server computers must be part of the same Windows domain, or in trusted domains.</span></span>  
  
-   <span data-ttu-id="14104-105">Имя участника-службы (SPN) должно быть зарегистрировано в службе каталогов Active Directory, которая играет роль центра распределения ключей в домене Windows.</span><span class="sxs-lookup"><span data-stu-id="14104-105">A Service Principal Name (SPN) must be registered with Active Directory, which assumes the role of the Key Distribution Center in a Windows domain.</span></span> <span data-ttu-id="14104-106">Имя участника-службы после регистрации сопоставляется учетной записи Windows, запустившей экземпляр службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="14104-106">The SPN, after it is registered, maps to the Windows account that started the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance service.</span></span> <span data-ttu-id="14104-107">Если регистрация имени участника-службы не была выполнена или завершилась неудачно, уровень безопасности Windows не может определить учетную запись, связанную с именем участника-службы, и проверка подлинности Kerberos не может быть использована.</span><span class="sxs-lookup"><span data-stu-id="14104-107">If the SPN registration has not been performed or fails, the Windows security layer cannot determine the account associated with the SPN, and Kerberos authentication will not be used.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="14104-108">Если сервер не может автоматически зарегистрировать имя участника-службы, оно должно быть зарегистрировано вручную.</span><span class="sxs-lookup"><span data-stu-id="14104-108">If the server cannot automatically register the SPN, the SPN must be registered manually.</span></span> <span data-ttu-id="14104-109">См. раздел [Регистрация имени участника-службы вручную](#Manual).</span><span class="sxs-lookup"><span data-stu-id="14104-109">See [Manual SPN Registration](#Manual).</span></span>  
  
 <span data-ttu-id="14104-110">Можно определить, что соединение использует протокол Kerberos, запросив динамическое административное представление sys.dm_exec_connections.</span><span class="sxs-lookup"><span data-stu-id="14104-110">You can verify that a connection is using Kerberos by querying the sys.dm_exec_connections dynamic management view.</span></span> <span data-ttu-id="14104-111">Выполните следующий запрос и проверьте значение в столбце auth_scheme, которое будет равно «KERBEROS», если включен протокол Kerberos.</span><span class="sxs-lookup"><span data-stu-id="14104-111">Run the following query and check the value of the auth_scheme column, which will be "KERBEROS" if Kerberos is enabled.</span></span>  
  
```  
SELECT auth_scheme FROM sys.dm_exec_connections WHERE session_id = @@spid ;  
```  
  
> [!TIP]  
>  <span data-ttu-id="14104-112">**[!INCLUDE[msCoName](../../includes/msconame-md.md)] диспетчер конфигурации Kerberos для [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** — это диагностическое средство, которое помогает расследовать проблемы Kerberos со связью при использовании [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="14104-112">**[!INCLUDE[msCoName](../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** is a diagnostic tool that helps troubleshoot Kerberos related connectivity issues with [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="14104-113">Дополнительные сведения см. в разделе [Диспетчер конфигурации Microsoft Kerberos для SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).</span><span class="sxs-lookup"><span data-stu-id="14104-113">For more information, see [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).</span></span>  
  
##  <a name="the-role-of-the-spn-in-authentication"></a><a name="Role"></a> <span data-ttu-id="14104-114">Роль имени участника-службы при проверке подлинности</span><span class="sxs-lookup"><span data-stu-id="14104-114">The Role of the SPN in Authentication</span></span>  
 <span data-ttu-id="14104-115">Когда приложение открывает соединение и использует проверку подлинности Windows, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client передает [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имя компьютера, имя экземпляра и имя участника-службы (необязательно).</span><span class="sxs-lookup"><span data-stu-id="14104-115">When an application opens a connection and uses Windows Authentication, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client passes the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] computer name, instance name and, optionally, an SPN.</span></span> <span data-ttu-id="14104-116">Если соединение передает имя участника-службы, то имя используется без изменений.</span><span class="sxs-lookup"><span data-stu-id="14104-116">If the connection passes an SPN it is used without any changes.</span></span>  
  
 <span data-ttu-id="14104-117">Если соединение не передает имя участника-службы, создается имя участника-службы по умолчанию, основанное на используемом протоколе, имени сервера и имени экземпляра.</span><span class="sxs-lookup"><span data-stu-id="14104-117">If the connection does not pass an SPN, a default SPN is constructed based on the protocol used, server name, and the instance name.</span></span>  
  
 <span data-ttu-id="14104-118">В обоих предыдущих сценариях имя участника-службы отправляется в центр распределения ключей, чтобы получить токен безопасности для проверки подлинности соединения.</span><span class="sxs-lookup"><span data-stu-id="14104-118">In both of the preceding scenarios, the SPN is sent to the Key Distribution Center to obtain a security token for authenticating the connection.</span></span> <span data-ttu-id="14104-119">Если токен безопасности не может быть получен, используется проверка подлинности NTLM.</span><span class="sxs-lookup"><span data-stu-id="14104-119">If a security token cannot be obtained, authentication uses NTLM.</span></span>  
  
 <span data-ttu-id="14104-120">Имя участника-службы (service primary name, SPN) — это имя, по которому клиент единственным образом распознает экземпляр службы.</span><span class="sxs-lookup"><span data-stu-id="14104-120">A service principal name (SPN) is the name by which a client uniquely identifies an instance of a service.</span></span> <span data-ttu-id="14104-121">Служба проверки подлинности Kerberos может использовать основное имя для проверки подлинности служб.</span><span class="sxs-lookup"><span data-stu-id="14104-121">The Kerberos authentication service can use an SPN to authenticate a service.</span></span> <span data-ttu-id="14104-122">Когда клиент хочет подключиться к службе, он определяет местонахождение экземпляра службы, составляет для него основное имя, подключается к службе и представляет ей это имя для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="14104-122">When a client wants to connect to a service, it locates an instance of the service, composes an SPN for that instance, connects to the service, and presents the SPN for the service to authenticate.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="14104-123">Сведения, приводимые в этом разделе, применимы также в конфигурациях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , использующих кластеризацию.</span><span class="sxs-lookup"><span data-stu-id="14104-123">The information that is provided in this topic also applies to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] configurations that use clustering.</span></span>  
  
 <span data-ttu-id="14104-124">Для входа на SQL Server рекомендуется использовать проверку подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="14104-124">Windows Authentication is the preferred method for users to authenticate to SQL Server.</span></span> <span data-ttu-id="14104-125">Проверка подлинности клиентов с проверкой подлинности Windows осуществляется при помощи протоколов NTLM или Kerberos.</span><span class="sxs-lookup"><span data-stu-id="14104-125">Clients that use Windows Authentication are authenticated by either using NTLM or Kerberos.</span></span> <span data-ttu-id="14104-126">В среде Active Directory сначала всегда выполняется проверка подлинности по протоколу Kerberos.</span><span class="sxs-lookup"><span data-stu-id="14104-126">In an Active Directory environment, Kerberos authentication is always attempted first.</span></span> <span data-ttu-id="14104-127">Проверка подлинности Kerberos не поддерживается клиентами [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] с именованными каналами.</span><span class="sxs-lookup"><span data-stu-id="14104-127">Kerberos authentication is not available for [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] clients using named pipes.</span></span>  
  
##  <a name="permissions"></a><a name="Permissions"></a> <span data-ttu-id="14104-128">Permissions</span><span class="sxs-lookup"><span data-stu-id="14104-128">Permissions</span></span>  
 <span data-ttu-id="14104-129">При запуске службы компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)] она пытается зарегистрировать имя участника-службы (SPN).</span><span class="sxs-lookup"><span data-stu-id="14104-129">When the [!INCLUDE[ssDE](../../includes/ssde-md.md)] service starts, it attempts to register the Service Principal Name (SPN).</span></span> <span data-ttu-id="14104-130">Если у учетной записи, с которой запускается SQL Server, нет права регистрировать имя участника-службы в службах домена Active Directory, вызов завершится ошибкой и в журнал событий приложений, а также в журнал ошибок SQL Server будет добавлено предупреждение.</span><span class="sxs-lookup"><span data-stu-id="14104-130">If the account starting SQL Server doesn't have permission to register a SPN in Active Directory Domain Services, this call will fail and a warning message will be logged in the Application event log as well as the SQL Server error log.</span></span> <span data-ttu-id="14104-131">Для регистрации имени участника-службы компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] должен выполняться от имени встроенной учетной записи, например Local System (не рекомендуется) или NETWORK SERVICE, либо от имени учетной записи, обладающей разрешением на регистрацию имен участников-служб, например учетной записи администратора домена.</span><span class="sxs-lookup"><span data-stu-id="14104-131">To register the SPN, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] must be running under a built-in account, such as Local System (not recommended), or NETWORK SERVICE, or an account that has permission to register an SPN, such as a domain administrator account.</span></span> <span data-ttu-id="14104-132">Если [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняется в ОС  [!INCLUDE[win7](../../includes/win7-md.md)] или  [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] , можно выполнить [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] с помощью виртуальной учетной записи или управляемой учетной записи службы.</span><span class="sxs-lookup"><span data-stu-id="14104-132">When [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is running on the  [!INCLUDE[win7](../../includes/win7-md.md)] or  [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] operating system, you can run [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] using a virtual account or a managed service account (MSA).</span></span> <span data-ttu-id="14104-133">Виртуальные счета и управляемые учетные записи службы могут зарегистрировать имя участника-службы.</span><span class="sxs-lookup"><span data-stu-id="14104-133">Both virtual accounts and MSA's can register an SPN.</span></span> <span data-ttu-id="14104-134">Если [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняется под другой учетной записью, то имя участника-службы не регистрируется при запуске, и администратору домена необходимо произвести его регистрацию вручную.</span><span class="sxs-lookup"><span data-stu-id="14104-134">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is not running under one of these accounts, the SPN is not registered at startup and the domain administrator must register the SPN manually.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="14104-135">Если домен Windows настроен для выполнения в режиме работы ниже [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] Windows Server 2008 R2, то управляемая учетная запись службы не будет иметь необходимых разрешений для регистрации имен участника-службы для службы [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="14104-135">When the Windows domain is configured to run at less than the [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] Windows Server 2008 R2 functional level, then the Managed Service Account will not have the necessary permissions to register the SPNs for the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] service.</span></span> <span data-ttu-id="14104-136">Если требуется проверка подлинности по протоколу Kerberos, администратор домена должен вручную зарегистрировать [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имена участников-службы в управляемой учетной записи службы.</span><span class="sxs-lookup"><span data-stu-id="14104-136">If Kerberos authentication is required, the Domain Administrator should manually register the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] SPNs on the Managed Service Account.</span></span>  
  
 <span data-ttu-id="14104-137">В статье базы знаний [Использование проверки подлинности протокола Kerberos в SQL Server](https://support.microsoft.com/kb/319723)содержатся сведения о том, как предоставить разрешения на чтение или запись имен участника-службы учетным записям, не являющимся администраторами домена.</span><span class="sxs-lookup"><span data-stu-id="14104-137">The KB article, [How to use Kerberos authentication in SQL Server](https://support.microsoft.com/kb/319723), contains information about how to grant read or write permission to an SPN for an account that is not a Domain Administrator.</span></span>  
  
 <span data-ttu-id="14104-138">Дополнительные сведения см. в разделе [Реализация ограниченного делегирования Kerberos в SQL Server 2008](https://technet.microsoft.com/library/ee191523.aspx)</span><span class="sxs-lookup"><span data-stu-id="14104-138">Additional information is available at [How to Implement Kerberos Constrained Delegation with SQL Server 2008](https://technet.microsoft.com/library/ee191523.aspx)</span></span>  
  
##  <a name="spn-formats"></a><a name="Formats"></a> <span data-ttu-id="14104-139">Форматы имени участника-службы</span><span class="sxs-lookup"><span data-stu-id="14104-139">SPN Formats</span></span>  
 <span data-ttu-id="14104-140">Начиная с версии [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], формат имени участника-службы был изменен для обеспечения поддержки проверки подлинности протокола Kerberos для TCP/IP, именованных каналов и общей памяти.</span><span class="sxs-lookup"><span data-stu-id="14104-140">Beginning with [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], the SPN format is changed in order to support Kerberos authentication on TCP/IP, named pipes, and shared memory.</span></span> <span data-ttu-id="14104-141">Для именованных экземпляров и экземпляров по умолчанию поддерживаются следующие форматы имени участника-службы.</span><span class="sxs-lookup"><span data-stu-id="14104-141">The supported SPN formats for named and default instances are as follows.</span></span>  
  
 <span data-ttu-id="14104-142">**Именованный экземпляр**</span><span class="sxs-lookup"><span data-stu-id="14104-142">**Named instance**</span></span>  
  
-   <span data-ttu-id="14104-143">*MSSQLSvc/FQDN*:[_port_**|**_instancename_], где:</span><span class="sxs-lookup"><span data-stu-id="14104-143">*MSSQLSvc/FQDN*:[_port_**|**_instancename_], where:</span></span>  
  
    -   <span data-ttu-id="14104-144">*MSSQLSvc* — регистрируемая служба;</span><span class="sxs-lookup"><span data-stu-id="14104-144">*MSSQLSvc* is the service that is being registered.</span></span>  
  
    -   <span data-ttu-id="14104-145">*FQDN* — полное доменное имя сервера.</span><span class="sxs-lookup"><span data-stu-id="14104-145">*FQDN* is the fully qualified domain name of the server.</span></span>  
  
    -   <span data-ttu-id="14104-146">*Port* — номер TCP-порта.</span><span class="sxs-lookup"><span data-stu-id="14104-146">*port* is the TCP port number.</span></span>  
  
    -   <span data-ttu-id="14104-147">*instanceName* — имя [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] экземпляра.</span><span class="sxs-lookup"><span data-stu-id="14104-147">*instancename* is the name of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span>  
  
 <span data-ttu-id="14104-148">**Экземпляр по умолчанию**</span><span class="sxs-lookup"><span data-stu-id="14104-148">**Default instance**</span></span>  
  
-   <span data-ttu-id="14104-149">*MSSQLSvc/FQDN*:_Port_ **|** _MSSQLSvc/FQDN_, где:</span><span class="sxs-lookup"><span data-stu-id="14104-149">*MSSQLSvc/FQDN*:_port_**|**_MSSQLSvc/FQDN_, where:</span></span>  
  
    -   <span data-ttu-id="14104-150">*MSSQLSvc* — регистрируемая служба;</span><span class="sxs-lookup"><span data-stu-id="14104-150">*MSSQLSvc* is the service that is being registered.</span></span>  
  
    -   <span data-ttu-id="14104-151">*FQDN* — полное доменное имя сервера.</span><span class="sxs-lookup"><span data-stu-id="14104-151">*FQDN* is the fully qualified domain name of the server.</span></span>  
  
    -   <span data-ttu-id="14104-152">*Port* — номер TCP-порта.</span><span class="sxs-lookup"><span data-stu-id="14104-152">*port* is the TCP port number.</span></span>  
  
 <span data-ttu-id="14104-153">Новый формат имени участника-службы не требует наличия номера порта.</span><span class="sxs-lookup"><span data-stu-id="14104-153">The new SPN format does not require a port number.</span></span> <span data-ttu-id="14104-154">В результате этого серверы с несколькими портами и протоколы, не использующие номера портов, смогут использовать проверку подлинности Kerberos.</span><span class="sxs-lookup"><span data-stu-id="14104-154">This means that a multiple-port server or a protocol that does not use port numbers can use Kerberos authentication.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="14104-155">В случае соединения по TCP/IP, когда TCP-порт является частью имени участника-службы, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] должен включить протокол TCP, чтобы пользователь мог подключиться с проверкой подлинности протокола Kerberos.</span><span class="sxs-lookup"><span data-stu-id="14104-155">In the case of a TCP/IP connection, where the TCP port is included in the SPN, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] must enable the TCP protocol for a user to connect by using Kerberos authentication.</span></span>  
  
|||  
|-|-|  
|<span data-ttu-id="14104-156">MSSQLSvc/*FQDN: порт*</span><span class="sxs-lookup"><span data-stu-id="14104-156">MSSQLSvc/*fqdn:port*</span></span>|<span data-ttu-id="14104-157">Сформированное поставщиком имя участника-службы для экземпляра по умолчанию, когда используется протокол TCP.</span><span class="sxs-lookup"><span data-stu-id="14104-157">The provider-generated, default SPN when TCP is used.</span></span> <span data-ttu-id="14104-158">*port* — номер TCP-порта.</span><span class="sxs-lookup"><span data-stu-id="14104-158">*port* is a TCP port number.</span></span>|  
|<span data-ttu-id="14104-159">MSSQLSvc/*полное доменное имя*</span><span class="sxs-lookup"><span data-stu-id="14104-159">MSSQLSvc/*fqdn*</span></span>|<span data-ttu-id="14104-160">Сформированное поставщиком имя участника-службы для экземпляра по умолчанию, когда используется протокол, отличный от TCP.</span><span class="sxs-lookup"><span data-stu-id="14104-160">The provider-generated, default SPN for a default instance when a protocol other than TCP is used.</span></span> <span data-ttu-id="14104-161">полное *доменное имя является полным* доменным именем.</span><span class="sxs-lookup"><span data-stu-id="14104-161">*fqdn* is a fully-qualified domain name.</span></span>|  
|<span data-ttu-id="14104-162">MSSQLSvc/*FQDN: instancename*</span><span class="sxs-lookup"><span data-stu-id="14104-162">MSSQLSvc/*fqdn:InstanceName*</span></span>|<span data-ttu-id="14104-163">Сформированное поставщиком имя участника-службы (по умолчанию) для именованного экземпляра, когда используется протокол, отличный от TCP.</span><span class="sxs-lookup"><span data-stu-id="14104-163">The provider-generated, default SPN for a named instance when a protocol other than TCP is used.</span></span> <span data-ttu-id="14104-164">*InstanceName* — имя экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="14104-164">*InstanceName* is the name of an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>|  
  
##  <a name="automatic-spn-registration"></a><a name="Auto"></a> <span data-ttu-id="14104-165">Автоматическая регистрация имени участника-службы</span><span class="sxs-lookup"><span data-stu-id="14104-165">Automatic SPN Registration</span></span>  
 <span data-ttu-id="14104-166">Когда запускается экземпляр компонента [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] , [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] пытается зарегистрировать имя участника-службы (SPN) для службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="14104-166">When an instance of the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] starts, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tries to register the SPN for the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] service.</span></span> <span data-ttu-id="14104-167">Когда экземпляр остановлен, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] пытается отменить регистрацию имени участника-службы (SPN).</span><span class="sxs-lookup"><span data-stu-id="14104-167">When the instance is stopped, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tries to unregister the SPN.</span></span> <span data-ttu-id="14104-168">Для соединений TCP/IP имя участника-службы регистрируется в формате *MSSQLSvc/\<FQDN>* : *\<tcpport>* . Оба именованных экземпляра и экземпляр по умолчанию регистрируются как служба *MSSQLSvc*, чтобы различить экземпляры по значению *\<tcpport>* .</span><span class="sxs-lookup"><span data-stu-id="14104-168">For a TCP/IP connection the SPN is registered in the format *MSSQLSvc/\<FQDN>*:*\<tcpport>*.Both named instances and the default instance are registered as *MSSQLSvc*, relying on the *\<tcpport>* value to differentiate the instances.</span></span>  
  
 <span data-ttu-id="14104-169">Для других соединений, поддерживающих протокол Kerberos, имя субъекта-службы регистрируется в формате \*MSSQLSvc/ \<FQDN> \*: *\<instancename>* для именованного экземпляра.</span><span class="sxs-lookup"><span data-stu-id="14104-169">For other connections that support Kerberos the SPN is registered in the format *MSSQLSvc/\<FQDN>*:*\<instancename>* for a named instance.</span></span> <span data-ttu-id="14104-170">Форматом регистрации экземпляра по умолчанию является *MSSQLSvc/\<FQDN>* .</span><span class="sxs-lookup"><span data-stu-id="14104-170">The format for registering the default instance is *MSSQLSvc/\<FQDN>*.</span></span>  
  
 <span data-ttu-id="14104-171">Если учетная запись службы не обладает разрешениями на регистрацию и отмену регистрации имени участника-службы, возможно, эти действия придется выполнить вручную.</span><span class="sxs-lookup"><span data-stu-id="14104-171">Manual intervention might be required to register or unregister the SPN if the service account lacks the permissions that are required for these actions.</span></span>  
  
##  <a name="manual-spn-registration"></a><a name="Manual"></a> <span data-ttu-id="14104-172">Регистрация имени участника-службы вручную</span><span class="sxs-lookup"><span data-stu-id="14104-172">Manual SPN Registration</span></span>  
 <span data-ttu-id="14104-173">Для регистрации имени участника-службы вручную администратор должен запустить средство Setspn.exe, поставляемое со средствами поддержки Microsoft [!INCLUDE[winxpsvr](../../includes/winxpsvr-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="14104-173">To register the SPN manually, the administrator must use the Setspn.exe tool that is provided with the Microsoft [!INCLUDE[winxpsvr](../../includes/winxpsvr-md.md)] Support Tools.</span></span> <span data-ttu-id="14104-174">Дополнительные сведения см. в статье базы знаний [Средства поддержки Windows Server 2003 с пакетом обновления 1 (SP1)](https://support.microsoft.com/kb/892777) .</span><span class="sxs-lookup"><span data-stu-id="14104-174">For more information, see the [Windows Server 2003 Service Pack 1 Support Tools](https://support.microsoft.com/kb/892777) KB article.</span></span>  
  
 <span data-ttu-id="14104-175">Setspn.exe — это средство командной строки, позволяющее считывать, изменять и удалять свойство каталога имен участников-служб (SPN).</span><span class="sxs-lookup"><span data-stu-id="14104-175">Setspn.exe is a command line tool that enables you to read, modify, and delete the Service Principal Names (SPN) directory property.</span></span> <span data-ttu-id="14104-176">Это средство также позволяет просматривать текущие имена участников-служб, устанавливать значения по умолчанию для имен участников-служб учетных записей и добавлять или удалять дополнительные имена участников-служб.</span><span class="sxs-lookup"><span data-stu-id="14104-176">This tool also enables you to view the current SPNs, reset the account's default SPNs, and add or delete supplemental SPNs.</span></span>  
  
 <span data-ttu-id="14104-177">В следующем примере показывается синтаксис, используемый для регистрации вручную имени участника-службы для соединения TCP/IP.</span><span class="sxs-lookup"><span data-stu-id="14104-177">The following example illustrates the syntax used to register manually register an SPN for a TCP/IP connection.</span></span>  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com:1433 accountname  
```  
  
 <span data-ttu-id="14104-178">**Примечание.** Если имя участника-службы уже существует, то перед повторной регистрацией его необходимо удалить.</span><span class="sxs-lookup"><span data-stu-id="14104-178">**Note** If an SPN already exists, it must be deleted before it can be reregistered.</span></span> <span data-ttu-id="14104-179">Это можно сделать, используя команду `setspn` с параметром `-D` .</span><span class="sxs-lookup"><span data-stu-id="14104-179">You do this by using the `setspn` command together with the `-D` switch.</span></span> <span data-ttu-id="14104-180">В следующих примерах демонстрируется регистрация вручную нового имени участника-службы, основанного на экземпляре.</span><span class="sxs-lookup"><span data-stu-id="14104-180">The following examples illustrate how to manually register a new instance-based SPN.</span></span> <span data-ttu-id="14104-181">Для экземпляра по умолчанию следует использовать:</span><span class="sxs-lookup"><span data-stu-id="14104-181">For a default instance, use:</span></span>  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com accountname  
```  
  
 <span data-ttu-id="14104-182">Для именованного экземпляра следует использовать:</span><span class="sxs-lookup"><span data-stu-id="14104-182">For a named instance, use:</span></span>  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com:instancename accountname  
```  
  
##  <a name="client-connections"></a><a name="Client"></a> <span data-ttu-id="14104-183">Клиентские соединения</span><span class="sxs-lookup"><span data-stu-id="14104-183">Client Connections</span></span>  
 <span data-ttu-id="14104-184">Указанные пользователями имена участников-служб поддерживаются клиентскими драйверами.</span><span class="sxs-lookup"><span data-stu-id="14104-184">User-specified SPNs are supported in client drivers.</span></span> <span data-ttu-id="14104-185">Однако имя участника-службы не предоставляется, оно будет автоматически сформировано, основываясь на типе клиентского соединения.</span><span class="sxs-lookup"><span data-stu-id="14104-185">However, if an SPN is not provided, it will be generated automatically based on the type of a client connection.</span></span> <span data-ttu-id="14104-186">Для соединений TCP, именованных экземпляров и экземпляров по умолчанию используется имя участника-службы в формате *MSSQLSvc*/*FQDN*:[*port*].</span><span class="sxs-lookup"><span data-stu-id="14104-186">For a TCP connection, an SPN in the format *MSSQLSvc*/*FQDN*:[*port*] is used for both the named and default instances.</span></span>  
  
 <span data-ttu-id="14104-187">Для именованных каналов и подключений общей памяти имя участника-службы в формате *MSSQLSvc* / *FQDN*:*instanceName* используется для именованного экземпляра, *MSSQLSvc*а / для экземпляра по умолчанию используется*полное доменное имя* MSSQLSvc.</span><span class="sxs-lookup"><span data-stu-id="14104-187">For named pipes and shared memory connections, an SPN in the format *MSSQLSvc*/*FQDN*:*instancename* is used for a named instance and *MSSQLSvc*/*FQDN* is used for the default instance.</span></span>  
  
 <span data-ttu-id="14104-188">**Использование учетной записи службы в качестве имени участника-службы**</span><span class="sxs-lookup"><span data-stu-id="14104-188">**Using a service account as an SPN**</span></span>  
  
 <span data-ttu-id="14104-189">Учетные записи служб могут быть использованы в качестве имен участников-служб.</span><span class="sxs-lookup"><span data-stu-id="14104-189">Service accounts can be used as an SPN.</span></span> <span data-ttu-id="14104-190">Они указываются с помощью атрибута соединения для проверки подлинности протокола Kerberos и имеют следующие форматы:</span><span class="sxs-lookup"><span data-stu-id="14104-190">They are specified through the connection attribute for the Kerberos authentication and take the following formats:</span></span>  
  
-   <span data-ttu-id="14104-191">**username@domain**или **домен \ имя_пользователя** для учетной записи пользователя домена</span><span class="sxs-lookup"><span data-stu-id="14104-191">**username@domain** or **domain\username** for a domain user account</span></span>  
  
-   <span data-ttu-id="14104-192">**machine$@domain** или **host\FQDN** для учетной записи домена, такой как "Local System" или "NETWORK SERVICES".</span><span class="sxs-lookup"><span data-stu-id="14104-192">**machine$@domain** or **host\FQDN** for a computer domain account such as Local System or NETWORK SERVICES.</span></span>  
  
 <span data-ttu-id="14104-193">Чтобы определить метод проверки подлинности соединения, выполните следующий запрос.</span><span class="sxs-lookup"><span data-stu-id="14104-193">To determine the authentication method of a connection, execute the following query.</span></span>  
  
```sql  
SELECT net_transport, auth_scheme   
FROM sys.dm_exec_connections   
WHERE session_id = @@SPID;  
```  
  
##  <a name="authentication-defaults"></a><a name="Defaults"></a> <span data-ttu-id="14104-194">Значения по умолчанию для проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="14104-194">Authentication Defaults</span></span>  
 <span data-ttu-id="14104-195">В следующей таблице описываются значения по умолчанию для проверки подлинности, используемые, основываясь на сценариях регистрации имен участника-службы.</span><span class="sxs-lookup"><span data-stu-id="14104-195">The following table describes the authentication defaults that are used based on SPN registration scenarios.</span></span>  
  
|<span data-ttu-id="14104-196">Сценарий</span><span class="sxs-lookup"><span data-stu-id="14104-196">Scenario</span></span>|<span data-ttu-id="14104-197">Метод проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="14104-197">Authentication method</span></span>|  
|--------------|---------------------------|  
|<span data-ttu-id="14104-198">Имя участника-службы сопоставляется с правильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы или встроенной учетной записью.</span><span class="sxs-lookup"><span data-stu-id="14104-198">The SPN maps to the correct domain account, virtual account, MSA, or built-in account.</span></span> <span data-ttu-id="14104-199">Например, «Local System» или «NETWORK SERVICE».</span><span class="sxs-lookup"><span data-stu-id="14104-199">For example, Local System or NETWORK SERVICE.</span></span><br /><br /> <span data-ttu-id="14104-200">Примечание. правильное значение означает, что учетная запись, сопоставленная зарегистрированным именем субъекта-службы, является учетной записью, под которой выполняется служба SQL Server.</span><span class="sxs-lookup"><span data-stu-id="14104-200">Note: Correct means that the account mapped by the registered SPN is the account that the SQL Server service is running under.</span></span>|<span data-ttu-id="14104-201">Локальные соединения используют протокол NTLM, удаленные — протокол Kerberos.</span><span class="sxs-lookup"><span data-stu-id="14104-201">Local connections use NTLM, remote connections use Kerberos.</span></span>|  
|<span data-ttu-id="14104-202">Имя участника-службы является правильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы или встроенной учетной записью.</span><span class="sxs-lookup"><span data-stu-id="14104-202">The SPN is the correct domain account, virtual account, MSA, or built-in account.</span></span><br /><br /> <span data-ttu-id="14104-203">Примечание. правильное значение означает, что учетная запись, сопоставленная зарегистрированным именем субъекта-службы, является учетной записью, под которой выполняется служба SQL Server.</span><span class="sxs-lookup"><span data-stu-id="14104-203">Note: Correct means that the account mapped by the registered SPN is the account that the SQL Server service is running under.</span></span>|<span data-ttu-id="14104-204">Локальные соединения используют протокол NTLM, удаленные — протокол Kerberos.</span><span class="sxs-lookup"><span data-stu-id="14104-204">Local connections use NTLM, remote connections use Kerberos.</span></span>|  
|<span data-ttu-id="14104-205">Имя участника-службы сопоставляется с неправильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы или встроенной учетной записью.</span><span class="sxs-lookup"><span data-stu-id="14104-205">The SPN maps to an incorrect domain account, virtual account, MSA, or built-in account</span></span>|<span data-ttu-id="14104-206">Проверка подлинности не пройдена.</span><span class="sxs-lookup"><span data-stu-id="14104-206">Authentication fails.</span></span>|  
|<span data-ttu-id="14104-207">Поиск имени участника-службы завершается неудачно или не сопоставляется с правильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы, встроенной учетной записью, либо оно не является правильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы или встроенной учетной записью.</span><span class="sxs-lookup"><span data-stu-id="14104-207">The SPN lookup fails or does not map to a correct domain account, virtual account, MSA, or built-in account, or is not a correct domain account, virtual account, MSA, or built-in account.</span></span>|<span data-ttu-id="14104-208">Протокол NTLM используется в локальных и удаленных соединениях.</span><span class="sxs-lookup"><span data-stu-id="14104-208">Local and remote connections use NTLM.</span></span>|  
  
##  <a name="comments"></a><a name="Comments"></a> <span data-ttu-id="14104-209">Комментарии</span><span class="sxs-lookup"><span data-stu-id="14104-209">Comments</span></span>  
 <span data-ttu-id="14104-210">В выделенном административном соединении (DAC) используется имя участника-службы, основанное на имени экземпляра.</span><span class="sxs-lookup"><span data-stu-id="14104-210">The Dedicated Administrator Connection (DAC) uses an instance name based SPN.</span></span> <span data-ttu-id="14104-211">Проверку подлинности по протоколу Kerberos можно использовать, если имя участника-службы было успешно зарегистрировано.</span><span class="sxs-lookup"><span data-stu-id="14104-211">Kerberos authentication can be used with a DAC if that SPN is registered successfully.</span></span> <span data-ttu-id="14104-212">В качестве альтернативы пользователь может указать в качестве имени участника-службы имя учетной записи.</span><span class="sxs-lookup"><span data-stu-id="14104-212">As an alternative a user can specify the account name as an SPN.</span></span>  
  
 <span data-ttu-id="14104-213">Если во время запуска происходит ошибка регистрации имени участника-службы, она заносится в журнал ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , после чего установка продолжается.</span><span class="sxs-lookup"><span data-stu-id="14104-213">If SPN registration fails during startup, this failure is recorded in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log, and startup continues.</span></span>  
  
 <span data-ttu-id="14104-214">Если во время выключения происходит ошибка отмены регистрации имени участника-службы, она заносится в журнал ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , после чего выключение продолжается.</span><span class="sxs-lookup"><span data-stu-id="14104-214">If SPN de-registration fails during shutdown, this failure is recorded in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log, and shutdown continues.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="14104-215">См. также:</span><span class="sxs-lookup"><span data-stu-id="14104-215">See Also</span></span>  
 <span data-ttu-id="14104-216">[Поддержка имени участника-службы (SPN) в клиентских соединениях](../../relational-databases/native-client/features/service-principal-name-spn-support-in-client-connections.md) </span><span class="sxs-lookup"><span data-stu-id="14104-216">[Service Principal Name &#40;SPN&#41; Support in Client Connections](../../relational-databases/native-client/features/service-principal-name-spn-support-in-client-connections.md) </span></span>  
 <span data-ttu-id="14104-217">[Имена участника-службы (SPN) в клиентских соединениях (OLE DB)](../../relational-databases/native-client/ole-db/service-principal-names-spns-in-client-connections-ole-db.md) </span><span class="sxs-lookup"><span data-stu-id="14104-217">[Service Principal Names &#40;SPNs&#41; in Client Connections &#40;OLE DB&#41;](../../relational-databases/native-client/ole-db/service-principal-names-spns-in-client-connections-ole-db.md) </span></span>  
 <span data-ttu-id="14104-218">[Имена участника-службы (SPN) в клиентских соединениях (ODBC)](../../relational-databases/native-client/odbc/service-principal-names-spns-in-client-connections-odbc.md) </span><span class="sxs-lookup"><span data-stu-id="14104-218">[Service Principal Names &#40;SPNs&#41; in Client Connections &#40;ODBC&#41;](../../relational-databases/native-client/odbc/service-principal-names-spns-in-client-connections-odbc.md) </span></span>  
 <span data-ttu-id="14104-219">[Компоненты собственного клиента SQL Server](../../relational-databases/native-client/features/sql-server-native-client-features.md) </span><span class="sxs-lookup"><span data-stu-id="14104-219">[SQL Server Native Client Features](../../relational-databases/native-client/features/sql-server-native-client-features.md) </span></span>  
 [<span data-ttu-id="14104-220">Управление проблемами проверки подлинности по протоколу Kerberos в средах служб Reporting Service</span><span class="sxs-lookup"><span data-stu-id="14104-220">Manage Kerberos Authentication Issues in a Reporting Services Environment</span></span>](https://technet.microsoft.com/library/ff679930.aspx)  
  
  
