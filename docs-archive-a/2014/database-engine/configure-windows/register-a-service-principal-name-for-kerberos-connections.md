---
title: Регистрация имени участника-службы для соединений Kerberos | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- connections [SQL Server], SPNs
- network connections [SQL Server], SPNs
- registering SPNs
- Server Principal Names
- SPNs [SQL Server]
ms.assetid: e38d5ce4-e538-4ab9-be67-7046e0d9504e
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: f4db1e8b86fca057acbce29491be9c2be91f0748
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87667396"
---
# <a name="register-a-service-principal-name-for-kerberos-connections"></a>Регистрация имени участника-службы для соединений Kerberos
  Чтобы использовать проверку подлинности Kerberos с [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , необходимо наличие следующих условий.  
  
-   Компьютеры клиента и сервера должны быть частью одного домена Windows или доверенных доменов.  
  
-   Имя участника-службы (SPN) должно быть зарегистрировано в службе каталогов Active Directory, которая играет роль центра распределения ключей в домене Windows. Имя участника-службы после регистрации сопоставляется учетной записи Windows, запустившей экземпляр службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Если регистрация имени участника-службы не была выполнена или завершилась неудачно, уровень безопасности Windows не может определить учетную запись, связанную с именем участника-службы, и проверка подлинности Kerberos не может быть использована.  
  
    > [!NOTE]  
    >  Если сервер не может автоматически зарегистрировать имя участника-службы, оно должно быть зарегистрировано вручную. См. раздел [Регистрация имени участника-службы вручную](#Manual).  
  
 Можно определить, что соединение использует протокол Kerberos, запросив динамическое административное представление sys.dm_exec_connections. Выполните следующий запрос и проверьте значение в столбце auth_scheme, которое будет равно «KERBEROS», если включен протокол Kerberos.  
  
```  
SELECT auth_scheme FROM sys.dm_exec_connections WHERE session_id = @@spid ;  
```  
  
> [!TIP]  
>  **[!INCLUDE[msCoName](../../includes/msconame-md.md)] диспетчер конфигурации Kerberos для [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** — это диагностическое средство, которое помогает расследовать проблемы Kerberos со связью при использовании [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Дополнительные сведения см. в разделе [Диспетчер конфигурации Microsoft Kerberos для SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).  
  
##  <a name="the-role-of-the-spn-in-authentication"></a><a name="Role"></a> Роль имени участника-службы при проверке подлинности  
 Когда приложение открывает соединение и использует проверку подлинности Windows, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client передает [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имя компьютера, имя экземпляра и имя участника-службы (необязательно). Если соединение передает имя участника-службы, то имя используется без изменений.  
  
 Если соединение не передает имя участника-службы, создается имя участника-службы по умолчанию, основанное на используемом протоколе, имени сервера и имени экземпляра.  
  
 В обоих предыдущих сценариях имя участника-службы отправляется в центр распределения ключей, чтобы получить токен безопасности для проверки подлинности соединения. Если токен безопасности не может быть получен, используется проверка подлинности NTLM.  
  
 Имя участника-службы (service primary name, SPN) — это имя, по которому клиент единственным образом распознает экземпляр службы. Служба проверки подлинности Kerberos может использовать основное имя для проверки подлинности служб. Когда клиент хочет подключиться к службе, он определяет местонахождение экземпляра службы, составляет для него основное имя, подключается к службе и представляет ей это имя для проверки подлинности.  
  
> [!NOTE]  
>  Сведения, приводимые в этом разделе, применимы также в конфигурациях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , использующих кластеризацию.  
  
 Для входа на SQL Server рекомендуется использовать проверку подлинности Windows. Проверка подлинности клиентов с проверкой подлинности Windows осуществляется при помощи протоколов NTLM или Kerberos. В среде Active Directory сначала всегда выполняется проверка подлинности по протоколу Kerberos. Проверка подлинности Kerberos не поддерживается клиентами [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] с именованными каналами.  
  
##  <a name="permissions"></a><a name="Permissions"></a> Permissions  
 При запуске службы компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)] она пытается зарегистрировать имя участника-службы (SPN). Если у учетной записи, с которой запускается SQL Server, нет права регистрировать имя участника-службы в службах домена Active Directory, вызов завершится ошибкой и в журнал событий приложений, а также в журнал ошибок SQL Server будет добавлено предупреждение. Для регистрации имени участника-службы компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] должен выполняться от имени встроенной учетной записи, например Local System (не рекомендуется) или NETWORK SERVICE, либо от имени учетной записи, обладающей разрешением на регистрацию имен участников-служб, например учетной записи администратора домена. Если [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняется в ОС  [!INCLUDE[win7](../../includes/win7-md.md)] или  [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] , можно выполнить [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] с помощью виртуальной учетной записи или управляемой учетной записи службы. Виртуальные счета и управляемые учетные записи службы могут зарегистрировать имя участника-службы. Если [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] выполняется под другой учетной записью, то имя участника-службы не регистрируется при запуске, и администратору домена необходимо произвести его регистрацию вручную.  
  
> [!NOTE]  
>  Если домен Windows настроен для выполнения в режиме работы ниже [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] Windows Server 2008 R2, то управляемая учетная запись службы не будет иметь необходимых разрешений для регистрации имен участника-службы для службы [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] . Если требуется проверка подлинности по протоколу Kerberos, администратор домена должен вручную зарегистрировать [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] имена участников-службы в управляемой учетной записи службы.  
  
 В статье базы знаний [Использование проверки подлинности протокола Kerberos в SQL Server](https://support.microsoft.com/kb/319723)содержатся сведения о том, как предоставить разрешения на чтение или запись имен участника-службы учетным записям, не являющимся администраторами домена.  
  
 Дополнительные сведения см. в разделе [Реализация ограниченного делегирования Kerberos в SQL Server 2008](https://technet.microsoft.com/library/ee191523.aspx)  
  
##  <a name="spn-formats"></a><a name="Formats"></a> Форматы имени участника-службы  
 Начиная с версии [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], формат имени участника-службы был изменен для обеспечения поддержки проверки подлинности протокола Kerberos для TCP/IP, именованных каналов и общей памяти. Для именованных экземпляров и экземпляров по умолчанию поддерживаются следующие форматы имени участника-службы.  
  
 **Именованный экземпляр**  
  
-   *MSSQLSvc/FQDN*:[_port_**|**_instancename_], где:  
  
    -   *MSSQLSvc* — регистрируемая служба;  
  
    -   *FQDN* — полное доменное имя сервера.  
  
    -   *Port* — номер TCP-порта.  
  
    -   *instanceName* — имя [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] экземпляра.  
  
 **Экземпляр по умолчанию**  
  
-   *MSSQLSvc/FQDN*:_Port_ **|** _MSSQLSvc/FQDN_, где:  
  
    -   *MSSQLSvc* — регистрируемая служба;  
  
    -   *FQDN* — полное доменное имя сервера.  
  
    -   *Port* — номер TCP-порта.  
  
 Новый формат имени участника-службы не требует наличия номера порта. В результате этого серверы с несколькими портами и протоколы, не использующие номера портов, смогут использовать проверку подлинности Kerberos.  
  
> [!NOTE]  
>  В случае соединения по TCP/IP, когда TCP-порт является частью имени участника-службы, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] должен включить протокол TCP, чтобы пользователь мог подключиться с проверкой подлинности протокола Kerberos.  
  
|||  
|-|-|  
|MSSQLSvc/*FQDN: порт*|Сформированное поставщиком имя участника-службы для экземпляра по умолчанию, когда используется протокол TCP. *port* — номер TCP-порта.|  
|MSSQLSvc/*полное доменное имя*|Сформированное поставщиком имя участника-службы для экземпляра по умолчанию, когда используется протокол, отличный от TCP. полное *доменное имя является полным* доменным именем.|  
|MSSQLSvc/*FQDN: instancename*|Сформированное поставщиком имя участника-службы (по умолчанию) для именованного экземпляра, когда используется протокол, отличный от TCP. *InstanceName* — имя экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .|  
  
##  <a name="automatic-spn-registration"></a><a name="Auto"></a> Автоматическая регистрация имени участника-службы  
 Когда запускается экземпляр компонента [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] , [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] пытается зарегистрировать имя участника-службы (SPN) для службы [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . Когда экземпляр остановлен, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] пытается отменить регистрацию имени участника-службы (SPN). Для соединений TCP/IP имя участника-службы регистрируется в формате *MSSQLSvc/\<FQDN>* : *\<tcpport>* . Оба именованных экземпляра и экземпляр по умолчанию регистрируются как служба *MSSQLSvc*, чтобы различить экземпляры по значению *\<tcpport>* .  
  
 Для других соединений, поддерживающих протокол Kerberos, имя субъекта-службы регистрируется в формате *MSSQLSvc/ \<FQDN> *: *\<instancename>* для именованного экземпляра. Форматом регистрации экземпляра по умолчанию является *MSSQLSvc/\<FQDN>* .  
  
 Если учетная запись службы не обладает разрешениями на регистрацию и отмену регистрации имени участника-службы, возможно, эти действия придется выполнить вручную.  
  
##  <a name="manual-spn-registration"></a><a name="Manual"></a> Регистрация имени участника-службы вручную  
 Для регистрации имени участника-службы вручную администратор должен запустить средство Setspn.exe, поставляемое со средствами поддержки Microsoft [!INCLUDE[winxpsvr](../../includes/winxpsvr-md.md)] . Дополнительные сведения см. в статье базы знаний [Средства поддержки Windows Server 2003 с пакетом обновления 1 (SP1)](https://support.microsoft.com/kb/892777) .  
  
 Setspn.exe — это средство командной строки, позволяющее считывать, изменять и удалять свойство каталога имен участников-служб (SPN). Это средство также позволяет просматривать текущие имена участников-служб, устанавливать значения по умолчанию для имен участников-служб учетных записей и добавлять или удалять дополнительные имена участников-служб.  
  
 В следующем примере показывается синтаксис, используемый для регистрации вручную имени участника-службы для соединения TCP/IP.  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com:1433 accountname  
```  
  
 **Примечание.** Если имя участника-службы уже существует, то перед повторной регистрацией его необходимо удалить. Это можно сделать, используя команду `setspn` с параметром `-D` . В следующих примерах демонстрируется регистрация вручную нового имени участника-службы, основанного на экземпляре. Для экземпляра по умолчанию следует использовать:  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com accountname  
```  
  
 Для именованного экземпляра следует использовать:  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com:instancename accountname  
```  
  
##  <a name="client-connections"></a><a name="Client"></a> Клиентские соединения  
 Указанные пользователями имена участников-служб поддерживаются клиентскими драйверами. Однако имя участника-службы не предоставляется, оно будет автоматически сформировано, основываясь на типе клиентского соединения. Для соединений TCP, именованных экземпляров и экземпляров по умолчанию используется имя участника-службы в формате *MSSQLSvc*/*FQDN*:[*port*].  
  
 Для именованных каналов и подключений общей памяти имя участника-службы в формате *MSSQLSvc* / *FQDN*:*instanceName* используется для именованного экземпляра, *MSSQLSvc*а / для экземпляра по умолчанию используется*полное доменное имя* MSSQLSvc.  
  
 **Использование учетной записи службы в качестве имени участника-службы**  
  
 Учетные записи служб могут быть использованы в качестве имен участников-служб. Они указываются с помощью атрибута соединения для проверки подлинности протокола Kerberos и имеют следующие форматы:  
  
-   **username@domain**или **домен \ имя_пользователя** для учетной записи пользователя домена  
  
-   **machine$@domain** или **host\FQDN** для учетной записи домена, такой как "Local System" или "NETWORK SERVICES".  
  
 Чтобы определить метод проверки подлинности соединения, выполните следующий запрос.  
  
```sql  
SELECT net_transport, auth_scheme   
FROM sys.dm_exec_connections   
WHERE session_id = @@SPID;  
```  
  
##  <a name="authentication-defaults"></a><a name="Defaults"></a> Значения по умолчанию для проверки подлинности  
 В следующей таблице описываются значения по умолчанию для проверки подлинности, используемые, основываясь на сценариях регистрации имен участника-службы.  
  
|Сценарий|Метод проверки подлинности|  
|--------------|---------------------------|  
|Имя участника-службы сопоставляется с правильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы или встроенной учетной записью. Например, «Local System» или «NETWORK SERVICE».<br /><br /> Примечание. правильное значение означает, что учетная запись, сопоставленная зарегистрированным именем субъекта-службы, является учетной записью, под которой выполняется служба SQL Server.|Локальные соединения используют протокол NTLM, удаленные — протокол Kerberos.|  
|Имя участника-службы является правильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы или встроенной учетной записью.<br /><br /> Примечание. правильное значение означает, что учетная запись, сопоставленная зарегистрированным именем субъекта-службы, является учетной записью, под которой выполняется служба SQL Server.|Локальные соединения используют протокол NTLM, удаленные — протокол Kerberos.|  
|Имя участника-службы сопоставляется с неправильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы или встроенной учетной записью.|Проверка подлинности не пройдена.|  
|Поиск имени участника-службы завершается неудачно или не сопоставляется с правильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы, встроенной учетной записью, либо оно не является правильной учетной записью домена, виртуальной учетной записью, управляемой учетной записью службы или встроенной учетной записью.|Протокол NTLM используется в локальных и удаленных соединениях.|  
  
##  <a name="comments"></a><a name="Comments"></a> Комментарии  
 В выделенном административном соединении (DAC) используется имя участника-службы, основанное на имени экземпляра. Проверку подлинности по протоколу Kerberos можно использовать, если имя участника-службы было успешно зарегистрировано. В качестве альтернативы пользователь может указать в качестве имени участника-службы имя учетной записи.  
  
 Если во время запуска происходит ошибка регистрации имени участника-службы, она заносится в журнал ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , после чего установка продолжается.  
  
 Если во время выключения происходит ошибка отмены регистрации имени участника-службы, она заносится в журнал ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , после чего выключение продолжается.  
  
## <a name="see-also"></a>См. также:  
 [Поддержка имени участника-службы (SPN) в клиентских соединениях](../../relational-databases/native-client/features/service-principal-name-spn-support-in-client-connections.md)   
 [Имена участника-службы (SPN) в клиентских соединениях (OLE DB)](../../relational-databases/native-client/ole-db/service-principal-names-spns-in-client-connections-ole-db.md)   
 [Имена участника-службы (SPN) в клиентских соединениях (ODBC)](../../relational-databases/native-client/odbc/service-principal-names-spns-in-client-connections-odbc.md)   
 [Компоненты собственного клиента SQL Server](../../relational-databases/native-client/features/sql-server-native-client-features.md)   
 [Управление проблемами проверки подлинности по протоколу Kerberos в средах служб Reporting Service](https://technet.microsoft.com/library/ff679930.aspx)  
  
  
