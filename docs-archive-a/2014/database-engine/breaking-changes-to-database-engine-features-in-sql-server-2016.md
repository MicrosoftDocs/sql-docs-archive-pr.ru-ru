---
title: Критические изменения в функциях ядро СУБД в SQL Server 2014 | Документация Майкрософт
ms.custom: ''
ms.date: 01/19/2019
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: release-landing
ms.topic: conceptual
helpviewer_keywords:
- Database Engine [SQL Server], what's new
- breaking changes [SQL Server]
ms.assetid: 47edefbd-a09b-4087-937a-453cd5c6e061
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: bf1a25aabde1e684407218da7365ae7a2b4265a7
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87751483"
---
# <a name="breaking-changes-to-database-engine-features-in-sql-server-2014"></a>Критические изменения в функциях компонента ядра СУБД в SQL Server 2014
  В этом разделе описаны критические изменения в [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] [!INCLUDE[ssDE](../includes/ssde-md.md)] и более ранних версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] . Эти изменения могут нарушать работу приложений, скриптов или механизмов, основанных на более ранних версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. При обновлении могут возникнуть следующие проблемы. Дополнительные сведения см. в разделе [Use Upgrade Advisor to Prepare for Upgrades](../sql-server/install/use-upgrade-advisor-to-prepare-for-upgrades.md).  
  
##  <a name="breaking-changes-in-sssql14"></a><a name="SQL14"></a> Критические изменения в [!INCLUDE[ssSQL14](../includes/sssql14-md.md)]  
 Новые версии отсутствуют.  
  
##  <a name="breaking-changes-in-sssql11"></a><a name="Denali"></a>Критические изменения в[!INCLUDE[ssSQL11](../includes/sssql11-md.md)]  
  
### <a name="transact-sql"></a>Transact-SQL  
  
|Компонент|Описание|  
|-------------|-----------------|  
|Выбор в столбцах и таблицах с именем NEXT|Последовательности используют функцию ANSI NEXT VALUE FOR стандарта ANSI. Если таблица или столбец имеют имя NEXT, а таблица или столбец имеет псевдоним в виде значения, и если стандарт ANSI опущен, то результирующая инструкция может вызвать ошибку. Чтобы избежать этой проблемы, используйте ключевое слово AS по стандарту ANSI. Например, запрос `SELECT NEXT VALUE FROM Table` следует переписать в виде `SELECT NEXT AS VALUE FROM Table`, а запрос `SELECT Col1 FROM NEXT VALUE` ― в виде `SELECT Col1 FROM NEXT AS VALUE`.|  
|Оператор PIVOT|Оператор PIVOT запрещен в запросах рекурсивного обобщенного табличного выражения (CTE), если уровень совместимости базы данных установлен в значение 110. Перепишите запрос или измените уровень совместимости на 100 или ниже. Использование оператора PIVOT в запросах рекурсивного обобщенного табличного выражения (CTE) приводит к неверным результатам, если на каждое группирование приходится больше одной строки.|  
|sp_setapprole и sp_unsetapprole|Параметр `OUTPUT` куки-файла для `sp_setapprole` в настоящее время описан в документации как `varbinary(8000)`, что верно определяет его максимальную длину. Однако текущая реализация возвращает `varbinary(50)`. Дальнейшее резервирование `varbinary(8000)` в приложениях необходимо для обеспечения правильного продолжения работы в случае увеличения размера куки-файлов в последующих выпусках. Дополнительные сведения см. в разделе [sp_setapprole (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-setapprole-transact-sql).|  
|EXECUTE AS|Параметр OUTPUT куки-файла для инструкции EXECUTE AS в настоящее время описан в документации как `varbinary(8000)`, что верно определяет его максимальную длину. Однако текущая реализация возвращает `varbinary(100)`. Дальнейшее резервирование `varbinary(8000)` в приложениях необходимо для обеспечения правильного продолжения работы в случае увеличения размера куки-файлов в последующих выпусках. Дополнительные сведения см. в разделе [EXECUTE AS (Transact-SQL)](/sql/t-sql/statements/execute-as-transact-sql).|  
|sys.fn_get_audit_file, функция|Для поддержки пользовательских событий аудита были добавлены два дополнительных столбца (**user_defined_event_id** и **user_defined_information**). Приложения, не выбирающие столбцы по имени, могут возвращать больше столбцов, чем ожидается. Либо выбирайте столбцы по имени, либо доработайте приложение, чтобы оно принимало эти дополнительные столбцы.|  
|Зарезервированное ключевое слово WITHIN|WITHIN теперь является зарезервированным ключевым словом. Ссылки на объекты или столбцы с именем «within» работать не будут. Переименуйте объект или столбец либо заключите имя столбца в разграничители с помощью квадратных скобок или кавычек.  Например, `SELECT * FROM [within]`.|  
|Операции CAST и CONVERT над вычисляемыми столбцами типа `time` или `datetime2`|В предыдущих версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] используемый по умолчанию стиль для операций CAST и CONVERT над типами данных `time` и `datetime2` — 121, кроме случая, когда любой из типов используется в выражении вычисляемого столбца. Для вычисляемых столбцов используемый по умолчанию стиль — 0. Это поведение влияет на вычисляемые столбцы при их создании и использовании в запросах с автоматической параметризацией, а также при использовании в определениях ограничений.<br /><br /> При уровне совместимости 110 стиль по умолчанию для операций CAST и CONVERT над типами данных `time` и `datetime2` всегда имеет значение 121. Если запрос основан на прежнем поведении, следует использовать уровень совместимости ниже 110, либо явно задать в затрагиваемом запросе стиль 0.<br /><br /> Обновление базы данных до уровня совместимости 110 не приведет к изменению пользовательских данных, сохраненных на диске. Следует исправить эти данных соответствующим образом вручную. Например, если бы вы использовали предложение SELECT INTO для создания таблицы на основе источника, содержащего описанное выше выражение вычисляемого столбца, то сохранялись бы данные (благодаря стилю 0), а не само определение вычисляемого столбца. Потребовалось бы вручную обновлять эти данные в соответствии со стилем 121.|  
|ALTER TABLE|В инструкции ALTER TABLE разрешается использовать только имена таблиц, составленные из двух частей (схема.объект). Указание имени таблицы в следующих форматах теперь завершается ошибкой во время компиляции с ошибкой 117:<br /><br /> «сервер.база_данных.схема.таблица»<br /><br /> «.база_данных.схема.таблица»<br /><br /> «..схема.таблица»<br /><br /> В предыдущих версиях при задании формата «сервер.база_данных.схема.таблица» возникала ошибка 4902. Формат «.база_данных.схема.таблица» или «..схема.таблица» обрабатывался успешно. Чтобы устранить эту проблему, используйте четырехкомпонентный префикс.|  
|Просмотр метаданных|Запросы к представлению с помощью предложения FOR BROWSE или SET NO_BROWSETABLE ON теперь возвращают метаданные представления, а не метаданные базового объекта. Это поведение теперь такое же, как и у других методов просмотра метаданных.|  
|SOUNDEX|При уровне совместимости базы данных 110 функция SOUNDEX реализует новые правила, при применении которых значения, вычисляемые функцией, могут отличаться от тех значений, которые были вычислены при другом уровне совместимости. После обновления до уровня совместимости 110, возможно, придется перестроить индексы, кучи или ограничения CHECK, в которых используется функция SOUNDEX. Дополнительные сведения см. в статье [SOUNDEX (Transact-SQL)](/sql/t-sql/functions/soundex-transact-sql)
|Сообщение о количестве строк для инструкций DML, завершившихся ошибкой|В [!INCLUDE[ssSQL11](../includes/sssql11-md.md)][!INCLUDE[ssDE](../includes/ssde-md.md)] будет постоянно отправлять клиентам токен TDS DONE со значением «RowCount: 0» при неуспешном завершении инструкции DML. В предыдущих версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] клиенту отправляется неверное значение -1, когда инструкция DML, завершившаяся ошибкой, содержится в блоке TRY-CATCH и либо автопараметризуется компонентом [!INCLUDE[ssDE](../includes/ssde-md.md)], либо блок TRY-CATCH находится на разных уровнях с инструкцией, завершившейся ошибкой. Например, если блок TRY-CATCH вызывает хранимую процедуру и инструкция DML в процедуре завершается ошибкой, клиент получит ошибочное значение -1.<br /><br /> Приложения, работа которых зависит от этого неверного поведения, будут завершены с ошибками.|  
|SERVERPROPERTY (' выпуск ')|Установленный выпуск экземпляра [!INCLUDE[ssSQL11](../includes/sssql11-md.md)]. Используйте значения этого свойства для определения возможностей и ограничений, таких как максимальное количество процессоров, которые поддерживаются установленным продуктом.<br /><br /> В зависимости от установленного выпуска Enterprise Edition это может вернуть "Enterprise Edition" или "Enterprise Edition: лицензирование на основе ядра". Выпуски Enterprise Edition различаются по максимальной вычислительной мощности на один экземпляр [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. Дополнительные сведения об ограничениях на вычисление емкости в см [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] . в разделе [ограничения емкости вычислений по выпуску SQL Server](../sql-server/compute-capacity-limits-by-edition-of-sql-server.md).|  
|CREATE LOGIN|Параметр `CREATE LOGIN WITH PASSWORD = '` *Password* `' HASHED` не может использоваться с хэшами, созданными [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] 7 или более ранними версиями.|  
|Для операций CAST и CONVERT `datetimeoffset`|При преобразовании типов даты и времени в `datetimeoffset` поддерживаются только стили 0 и 1. Все другие стили преобразования возвращают ошибку 9809. Например, следующий код возвращает ошибку 9809.<br /><br /> `SELECT CONVERT(date, CAST('7070-11-25 16:25:01.00986 -02:07' as datetimeoffset(5)), 107);`|  
  
### <a name="dynamic-management-views"></a>Динамические административные представления  
  
|Просмотр|Описание|  
|----------|-----------------|  
|sys.dm_exec_requests|Тип столбца command меняется с `nvarchar(16)` на `nvarchar(32)`.|  
|sys.dm_os_memory_cache_counters|Следующие столбцы были переименованы:<br /><br /> single_pages_kb теперь: <br />                          pages_kb<br /><br /> multi_pages_kb<br />                           Теперь: pages_in_use_kb|  
|sys.dm_os_memory_cache_entries|Столбец pages_allocated_count столбца был переименован pages_kb.|  
|sys.dm_os_memory_clerks|Столбец multi_pages_kb был удален.<br /><br /> Столбец single_pages_kb столбца был переименован pages_kb.|  
|sys.dm_os_memory_nodes|Следующие столбцы были переименованы:<br /><br /> single_pages_kb теперь: <br />                            pages_kb<br /><br /> multi_pages_kb теперь: <br />                            foreign_committed_kb|  
|sys.dm_os_memory_objects|Следующие столбцы были переименованы.<br /><br /> pages_allocated_count теперь:<br />                            pages_in_bytes<br /><br /> max_pages_allocated_count теперь: max_pages_in_bytes|  
|sys.dm_os_sys_info|Следующие столбцы были переименованы:<br /><br /> physical_memory_in_bytes теперь: <br />                            physical_memory_kb<br /><br /> bpool_commit_target теперь: <br />                            committed_target_kb<br /><br /> bpool_visible теперь: <br />                            visible_target_kb<br /><br /> virtual_memory_in_bytes теперь: <br />                            virtual_memory_kb<br /><br /> bpool_commited теперь:<br />                            committed_kb|  
|sys.dm_os_workers|Столбец локали был удален.|  
  
### <a name="catalog-views"></a>Представления каталога  
  
|Просмотр|Описание|  
|----------|-----------------|  
|sys.data_spaces<br /><br /> sys.partition_schemes<br /><br /> sys.filegroups<br /><br /> sys.partition_functions|В функции sys.data_spaces и sys.partition_functions добавлен новый столбец is_system. (sys.partition_schemes и sys.filegroups наследуют столбцы от sys.data_spaces.)<br /><br /> Значение 1 в этом столбце показывает, что объект используется для фрагментов полнотекстового индекса.<br /><br /> В sys.partition_functions, sys.partition_schemes и sys.filegroups новый столбец не является последним. Проверьте существующие запросы, в которых большое значение имеет порядок столбцов, возвращаемых из этих представлений каталогов.|  
  
### <a name="sql-clr-data-types-geometry-geography-and-hierarchyid"></a>Типы данных среды CLR в SQL (geometry, geography и hierarchyid)  
 Сборка **Microsoft.SqlServer.Types.dll**, содержащая типы пространственных данных и тип hierarchyid, была обновлена с версии 10,0 до версии 11,0. Пользовательские приложения, ссылающиеся на эту сборку, могут завершаться с ошибками, если выполняются следующие условия.  
  
-   При перемещении пользовательского приложения с компьютера, на котором установлено приложение [!INCLUDE[ssKilimanjaro](../includes/sskilimanjaro-md.md)] , на компьютер, на котором [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] установлено только приложение, произойдет сбой приложения из-за отсутствия ссылки на версию 10,0 для сборки **sqltypes** . Может отображаться следующее сообщение об ошибке: `"Could not load file or assembly 'Microsoft.SqlServer.Types, Version=10.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91' or one of its dependencies. The system cannot find the file specified."`  
  
-   Если также установлена ссылка на сборку **sqltypes** версии 11,0 и версия 10,0, может появиться следующее сообщение об ошибке:`"System.InvalidCastException: Unable to cast object of type 'Microsoft.SqlServer.Types.SqlGeometry' to type 'Microsoft.SqlServer.Types.SqlGeometry'."`  
  
-   При ссылке на сборку **sqltypes** версии 11,0 из пользовательского приложения, предназначенного для .NET 3,5, 4 или 4,5, происходит сбой приложения, так как SqlClient по проектированию загружает версию 10,0 сборки. Эта ошибка возникает, когда приложение вызывает один из следующих методов:  
  
    -   Метод `GetValue` класса `SqlDataReader`.  
  
    -   Метод `GetValues` класса `SqlDataReader`.  
  
    -   индексный оператор квадратных скобок [] из класса `SqlDataReader`  
  
    -   Метод `ExecuteScalar` класса `SqlCommand`.  
  
 Для разрешения этой проблемы можно воспользоваться одним из следующих методов:  
  
-   Для разрешения этой проблемы в коде можно вызвать метод `GetSqlBytes` вместо перечисленных выше методов Get для получения системных типов CLR [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], как показано в следующем примере.  
  
    ```csharp  
    string query = "SELECT [SpatialColumn] FROM [SpatialTable]";  
          using (SqlConnection conn = new SqlConnection("..."))  
          {  
                SqlCommand cmd = new SqlCommand(query, conn);  
  
                conn.Open();  
                SqlDataReader reader = cmd.ExecuteReader();  
  
                while (reader.Read())  
                {  
                      // In version 11.0 only  
                      SqlGeometry g =   
    SqlGeometry.Deserialize(reader.GetSqlBytes(0));  
  
                      // In version 10.0 or 11.0  
                      SqlGeometry g2 = new SqlGeometry();  
                      g.Read(new BinaryReader(reader.GetSqlBytes(0).Stream));  
                }  
          }  
    ```  
  
-   Для разрешения этой проблемы можно воспользоваться перенаправлением сборок в файле конфигурации, как показано в следующем примере.  
  
    ```xml  
    <runtime>  
    <assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">  
        ...  
        <dependentAssembly>  
            <assemblyIdentity name="Microsoft.SqlServer.Types" publicKeyToken="89845dcd8080cc91" culture="neutral" />  
            <bindingRedirect oldVersion="10.0.0.0" newVersion="11.0.0.0" />  
        </dependentAssembly>  
        ...  
    </assemblyBinding>  
    <runtime>  
    ```  
  
-   Для разрешения этой проблемы в строке подключения можно указать значение «SQL Server 2012» для атрибута «Type System Version», что обеспечивает в SqlClient принудительную загрузку версии 11.0 сборки. Этот атрибут строки подключения доступен только в платформе .NET 4.5 и выше.  
  
-   Тег `assemblyBinding` должен быть заключен в тег `runtime`.  
  
### <a name="support-for-awe"></a>Поддержка AWE  
 Поддержка 32-разрядных расширений AWE прекращена. Это может приводить к снижению производительности в 32-разрядных операционных системах. Для установок, где используется большой объем памяти, следует выполнить переход на 64-разрядную операционную систему.  
  
### <a name="xquery-functions-are-surrogate-aware"></a>В функциях XQuery учитываются суррогаты  
 Рекомендация W3C для функций и операторов XQuery требует, чтобы суррогатная пара в них, представляющая символ Юникода из старших диапазонов, считалась единым глифом в кодировке UTF-16. Однако в версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] до [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] строковые функции не определяли суррогатные пары как один символ. Некоторые операции со строками, такие как вычисления длины строки и извлечения подстрок, возвращают неверные результаты. Теперь [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] полностью поддерживает UTF-16 и правильную обработку суррогатных пар.  
  
 Для типа данных XML в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] разрешены только суррогатные пары правильного формата. Однако некоторые функции все еще могут в некоторых обстоятельствах возвращать неопределенные или непредвиденные результаты, поскольку может оказаться, что в функцию XQuery в качестве строковых значений переданы неправильные или неполные суррогатные пары. Рассмотрим следующие методы создания строковых значений при использовании XQuery в [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:  
  
-   Предоставление константного строкового значения в качестве двоичного значения. При использовании этого метода по-прежнему остается возможность передачи недопустимых или неполных суррогатных пар.  
  
-   Предоставление константного строкового значения путем передачи сущностей-символов. При использовании этого метода передача недопустимых суррогатных пар становится невозможной. В функциях XQuery для каждого символа верхнего диапазона требуется одна сущность-символ. Эти функции вызывают ошибку, если символы-сущности предоставляются для символов суррогатных пар.  
  
-   Импортируйте внешние значения с помощью **SQL: column** или **SQL: variable**. При использовании этих методов по-прежнему остается возможность введения недопустимых или неполных суррогатных пар.  
  
#### <a name="affected-xquery-functions-and-operators"></a>Затрагиваемые функции и операторы XQuery  
 Следующие функции и операторы XQuery теперь правильно обрабатывают суррогатные пары UTF-16 в [!INCLUDE[ssSQL11](../includes/sssql11-md.md)]:  
  
-   **fn: длина строки**. Однако если в качестве аргумента передается Недопустимая или неполная суррогатная пара, поведение **строки String** не определено.  
  
-   **fn: подстрока**.  
  
-   **fn: содержит**. Однако если в качестве значения передается частичная суррогатная пара, то **содержит** может возвращать непредвиденные результаты, так как она может найти частичную суррогатную пару, содержащуюся в суррогатной паре правильного формата.  
  
-   **fn: Concat**. Однако если в качестве значения передается частичная суррогатная пара, то **concat** может создать неверные суррогатные пары или частичные суррогатные пары.  
  
-   Операторы сравнения и предложение **ORDER BY** . Операторы сравнения включают +, \<, > , \<=, > =, `eq` , `lt` , `gt` , `le` и `ge` .  
  
#### <a name="distributed-query-calls-to-a-system-procedure"></a>Вызовы распределенных запросов к системной процедуре  
 Вызовы распределенных запросов через `OPENQUERY` к некоторым системным процедурам завершаются ошибкой, если они выполняются от одного сервера [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] к другому. Это происходит тогда, когда компоненту [!INCLUDE[ssDE](../includes/ssde-md.md)] не удается обнаружить метаданные для процедуры. Например, `SELECT * FROM OPENQUERY(..., 'EXEC xp_loginfo')`.  
  
#### <a name="isolation-level-and-sp_reset_connection"></a>Уровень изоляции и sp_reset_connection  
 Уровень изоляции для подключений обрабатывается драйверами клиента следующим образом:  
  
-   Все собственные драйверы (SNAC, MDAC, ODBC) задают уровень изоляции (на основании параметров приложения) при sp_reset_connection.  
  
-   Для ADO.NET можно по сути получить случайный уровень изоляции в зависимости от того, какое подключение можно получить из пула (и того, использует ли приложение другой уровень изоляции). Так как пул ADO.NET может повторно использовать подключения внутренне и незаметно для пользователей, невозможно предсказать результат работы пула.  
  
-   Для драйвера JDBC характерно такое же поведение, что и для ADO.NET  
  
     Приложение должно всегда явно задавать уровень изоляции после открытия соединения, чтобы получить необходимое.  
  
     Подключение JDBC может быть в составе пула, поэтому приложение может получить случайный уровень изоляции и не узнать об этом.  
  
 Для сохранения обратной совместимости это новое поведение применяется только для последних клиентов, начиная с TDS 7.4.  
  
#### <a name="backward-compatibility"></a>Backward Compatibility  
 **Применение нового поведения зависит от уровня совместимости**  
  
 Следующие функции и операторы ведут себя описанным выше образом (по-новому) только при уровне совместимости 110 и выше.  
  
-   **fn: содержит**.  
  
-   **fn: Concat**.  
  
-   операторы сравнения и предложение **ORDER BY**  
  
 **Применение нового поведения зависит от URI-кода пространства имен по умолчанию для функций**  
  
 Следующие функции демонстрируют новое поведение, описанное выше, только когда URI пространства имен по умолчанию соответствует пространству имен в конечной рекомендации, то есть [http://www.w3.org/2005/xpath-functions](http://www.w3.org/2005/xpath-functions) . Если уровень совместимости составляет 110 или выше, [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] по умолчанию привязывает стандартное пространство имен функции к этому пространству имен. Однако, если используется это пространство имен, функции ведут себя по-новому, независимо от уровня совместимости.  
  
-   **FN: длина строки**  
  
-   **FN: подстрока**  
  
##  <a name="breaking-changes-in-sql-server-2008sql-server-2008r2"></a><a name="KJKatmai"></a>Критические изменения в SQL Server 2008 и SQL Server 2008R2  
 Этот раздел содержит описание критических изменений, внесенных в [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)]. В [!INCLUDE[ssKilimanjaro](../includes/sskilimanjaro-md.md)] не были внесены никакие изменения.  
  
### <a name="collations"></a>Параметры сортировки  
  
|Компонент|Описание|  
|-------------|-----------------|  
|Новые параметры сортировки|В [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] были добавлены новые параметры сортировки, полностью согласованные с параметрами, предоставляемыми в Windows Server 2008. Эти 80 новых параметров сортировки имеют улучшенную точность индексирования и отмечены пометками версии *_100. При выборе новых параметров сортировки для сервера или базы данных помните, что они могут не распознаваться клиентами со старыми драйверами. Нераспознанные параметры сортировки могут привести к возвращению ошибок и сбою приложения. Рассмотрите следующие решения.<br /><br /> Обновление клиентской операционной системы, что приведет к обновлению базовых параметров сортировки.<br /><br /> Если у клиента установлено клиентское программное обеспечение базы данных, рекомендуется применить обновление службы к данному программному обеспечению.<br /><br /> Выберите существующие параметры сортировки, сопоставленные с кодовой страницей клиента.|  
  
### <a name="common-language-runtime-clr"></a>Среда CLR  
  
|Компонент|Описание|  
|-------------|-----------------|  
|Сборки среды CLR|При обновлении базы данных до версии [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] для поддержки новых типов данных автоматически устанавливается сборка `Microsoft.SqlServer.Types`. Правила помощника по обновлению обнаружат все пользовательские типы данных или сборки с конфликтующими именами. Помощник по обновлению посоветует переименовать все конфликтующие сборки и либо переименовать все конфликтующие типы данных, либо использовать в программном коде двухкомпонентные имена для ссылок на существующие определяемые пользователем типы данных.<br /><br /> Если при обновлении базы данных обнаружится пользовательская сборка с конфликтующим именем, эта сборка автоматически переименуется, а база данных переведется в подозрительный режим.<br /><br /> Если во время обновления обнаруживается пользовательский тип данных с конфликтующим именем, никаких специальных шагов не предпринимается. После обновления будут существовать как старый пользовательский тип, так и новый системный тип данных. Пользовательский тип данных будет доступен только с применением двухкомпонентных имен.|  
|Сборки среды CLR|[!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] устанавливает платформу .NET Framework 3.5 с пакетом обновления 1 (SP1), которая обновляет библиотеки в глобальном кэше сборок. При наличии неподдерживаемых библиотек, зарегистрированных в базе данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], приложение [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] может прекратить работу после обновления до версии [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)]. Это происходит вследствие того, что обслуживание или обновление библиотек в глобальном кэше сборок не обновляет сборки внутри [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]. Если сборка существует как в базе данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], так и в глобальном кэше сборок, обе копии сборки должны полностью совпадать. Если они не совпадают, то при использовании сборки с интеграцией со средой [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] CLR возникает ошибка. Дополнительные сведения см. в разделе [supported .NET Framework librarys](../relational-databases/clr-integration/database-objects/supported-net-framework-libraries.md).<br /><br /> После обновления базы данных следует выполнить обслуживание или обновление копии сборки внутри баз данных [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] с помощью инструкции ALTER ASSEMBLY. Дополнительные сведения см. в [статье базы знаний 949080](https://go.microsoft.com/fwlink/?LinkId=154563).<br /><br /> Чтобы определить, используется ли в приложении неподдерживаемая библиотека платформы .NET Framework, в базе данных следует выполнить следующий запрос:<br /><br /> `SELECT name FROM sys.assemblies WHERE clr_name LIKE '%publickeytoken=b03f5f7f11d50a3a,%';`|  
|Подпрограммы CLR|Использование олицетворения в определяемых пользователем функциях CLR, определяемых пользователем статистических функциях CLR или определяемых пользователем типах CLR после обновления до [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] может вызвать завершение приложений с ошибкой 6522. Следующие сценарии выполняются успешно в [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)], но завершаются ошибкой в [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)]. Для каждого сценария указаны способы разрешения.<br /><br /> Определяемая пользователем функция CLR, определяемая пользователем статистическая обработка или метод определяемого пользователем типа, использующий олицетворение, имеет параметр типа,,,,, `nvarchar(max)` `varchar(max)` `varbinary(max)` `ntext` `text` `image` или большого определяемого пользователем типа и не имеет атрибута **DataAccessKind. Read** в методе. Чтобы устранить эту проблему, добавьте атрибут **DataAccessKind. Read** в метод, перекомпилируйте сборку и повторно разверните подпрограммы и сборку.<br /><br /> Возвращающая табличное значение функция CLR, которая имеет метод **init** , выполняющий олицетворение. Чтобы устранить эту проблему, добавьте атрибут **DataAccessKind. Read** в метод, перекомпилируйте сборку и повторно разверните подпрограммы и сборку.<br /><br /> Возвращающая табличное значение функция CLR, которая имеет метод **FillRow** , выполняющий олицетворение. Чтобы устранить эту проблему, удалите олицетворение из метода **FillRow** . Не используйте доступ к внешним ресурсам с помощью метода **FillRow** . Вместо этого следует обращаться к внешним ресурсам из метода **init** .|  
  
### <a name="dynamic-management-views"></a>Динамические административные представления  
  
|Просмотр|Описание|  
|----------|-----------------|  
|sys.dm_os_sys_info|Удалены столбцы cpu_ticks_in_ms и sqlserver_start_time_cpu_ticks.|  
|sys. dm_exec_query_resource_semaphoressys. dm_exec_query_memory_grants|Столбец resource_semaphore_id не является уникальным идентификатором в [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)]. Данное изменение может повлиять на устранение проблем в запросах. Дополнительные сведения см. в разделе [sys. dm_exec_query_resource_semaphores &#40;&#41;Transact-SQL ](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-resource-semaphores-transact-sql).|  
  
### <a name="errors-and-events"></a>Ошибки и события  
  
|Компонент|Описание|  
|-------------|-----------------|  
|Ошибки имени входа|В [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] ошибка 18452 возвращается при использовании имени входа SQL для соединения с сервером, настроенным для использования проверки подлинности Windows. В [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] вместо этого возвращается ошибка 18456.|  
  
### <a name="showplan"></a>Showplan  
  
|Компонент|Описание|  
|-------------|-----------------|  
|Схема XML Showplan|В XML-схему Showplan добавляется новый элемент **SeekPredicateNew** , а включающая XSD-последовательность (**склпредикатестипе**) преобразуется в **\<xsd:choice>** элемент. Вместо одного или нескольких элементов **сикпредикате** может появиться один или несколько элементов **SeekPredicateNew** в инструкции Showplan XML. Эти два элемента являются взаимоисключающими. **Сикпредикате** поддерживается в схеме Showplan XML для обеспечения обратной совместимости; Однако планы запросов, созданные в, [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] могут содержать элемент **SeekPredicateNew** . Приложения, которые предполагают получение только дочернего элемента **сикпредикате** с узла ShowPlanXML/Батчсекуенце/Batch/операторы/StmtSimple/Куериплан/RelOp/Индексскан/сикпредикатес, могут завершиться ошибкой, если элемент **сикпредикате** не существует. Перепишите приложение, чтобы в нем можно было бы использовать элемент **сикпредикате** или **SeekPredicateNew** . Дополнительные сведения см. в разделе .|  
|Схема XML Showplan|Новый атрибут **индекскинд** добавляется в сложный тип **ObjectType** в схеме XML Showplan. Работа приложений, выполняющих строгую проверку планов [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] по отношению к схеме [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)], будет завершаться с ошибкой.|  
  
### <a name="transact-sql"></a>Transact-SQL  
  
|Компонент|Описание|  
|-------------|-----------------|  
|DDL-событие ALTER_AUTHORIZATION_DATABASE|В [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] при срабатывании ALTER_AUTHORIZATION_DATABASE события DDL значение "Object" возвращается в элементе **ObjectType** XML-файла EVENTDATA для данного события, если тип сущности защищаемого объекта в операции языка DDL является объектом. В [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] возвращается действительный тип (например, «table» или «function»).|  
|CONVERT|Если в функцию CONVERT передан недопустимый стиль, при преобразовании двоичного типа в символьный или символьного в двоичный возвращается ошибка. В предыдущих версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] недопустимый стиль устанавливается на стиль по умолчанию для преобразований «двоичный в символьный» и «символьный в двоичный».|  
|Разрешения GRANT/DENY/REVOKE EXECUTE для сборок|Для сборок разрешение EXECUTE нельзя предоставить, запретить или отменить. Это разрешение не оказывает влияния и вызывает ошибку. Вместо этого можно предоставить, запретить или отменить разрешение EXECUTE для хранимых процедур или функций, ссылающихся на метод сборки.|  
|Разрешения GRANT/DENY/REVOKE на системные типы|Разрешения на системные типы нельзя предоставить, запретить или отменить. В предыдущих версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] данные инструкции завершаются успешно, но не оказывают влияния. В [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] возвращается ошибка.|  
|GROUP BY|Предложение GROUP BY не может содержать вложенный запрос в выражении, используемом для списка group by. В предыдущих версиях [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] это допускалось. В [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] возвращается ошибка 144.<br /><br /> Например, следующий код будет выполнен успешно в SQL Server 2005 и завершится с ошибкой в SQL Server 2008.<br /><br /> `DECLARE @Test TABLE(a int NOT NULL);` <br /> `INSERT INTO @Test SELECT 1 union ALL SELECT 2;` <br /> `SELECT COUNT(*)` <br /> `FROM @Test` <br /> `GROUP BY CASE WHEN a IN (SELECT t.a FROM @Test AS t)` <br /> `THEN 1 ELSE 0` <br /> `END;`|  
|OUTPUT, предложение|Во избежание недетерминированного поведения в предложении OUTPUT запрещено ссылаться на столбец из представления или встроенной функции, возвращающей табличное значение, если этот столбец определен одним из следующих методов.<br /><br /> вложенный запрос.<br /><br /> Определяемая пользователем функция, которая осуществляет или может осуществлять доступ к пользовательским или системным данным.<br /><br /> Вычисляемый столбец, содержащий в своем определении определяемую пользователем функцию, которая осуществляет доступ к пользовательским или системным данным.<br /><br /> <br /><br /> При обнаружении [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] такого столбца в предложении OUTPUT возвращается ошибка 4186. Дополнительные сведения см. в разделе [MSSQLSERVER_4186](../relational-databases/errors-events/mssqlserver-4186-database-engine-error.md).|  
|Предложение OUTPUT INTO|Целевая таблица предложения OUTPUT INTO не может иметь какие-либо включенные триггеры.|  
|Параметр уровня сервера precompute rank|Этот параметр не поддерживается в [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)]. Как можно скорее измените приложения, в настоящее время использующие эту функцию.|  
|Табличное указание READPAST|Нельзя задавать указание READPAST при изоляции моментальных снимков.<br /><br /> Если параметру базы данных ALLOW_SNAPSHOT_ISOLATION или READ_COMMITTED_SNAPSHOT, либо обоим этим параметрам присвоено значение ON, то указание READPAST пропускается. Однако если указание READPAST применяется совместно с READCOMMITTEDLOCK, то READPAST будет работать таким же образом, как и при использовании блокирующего указания READCOMMITTED.|  
|sp_helpuser|Следующие имена столбцов, возвращаемые в результирующем наборе хранимой процедуры sp_helpuser, были изменены:<br /><br /> GroupName теперь:<br />                            RoleName<br /><br /> Group_name теперь:<br />                            Role_name<br /><br /> Group_id теперь:<br />                            Role_id<br /><br /> Users_in_group теперь:<br />                            Users_in_role|  
|прозрачное шифрование данных.|Прозрачное шифрование данных (TDE) выполняется на уровне ввода-вывода: структура страницы остается в памяти незашифрованной и шифруется только при записи страницы на диск. Шифруются как файлы базы данных, так и файлы журнала. Приложения сторонних производителей, которые обходят обычный механизм [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] при доступе к страницам (например, путем прямого просмотра данных или файлов журнала), будут завершены с ошибкой при использовании базой данных прозрачного шифрования данных, так как данные в файлах зашифрованы. Для таких приложений можно эффективно использовать API-интерфейс шифрования Window, чтобы разработать решения для расшифровки данных за пределами [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].|  
  
### <a name="xquery"></a>XQuery  
  
|Компонент|Описание|  
|-------------|-----------------|  
|Поддержка типа данных datetime|В [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] типы данных, `xs:time` `xs:date` и `xs:dateTime` не поддерживают часовой пояс. Данные часового пояса сопоставляются с часовым поясом времени в формате UTC. [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] обеспечивает соответствующее стандартное поведение, приводящее к следующим изменениям.<br /><br /> Данные без часового пояса проходят проверку.<br /><br /> Предоставленный часовой пояс или его отсутствие сохраняются.<br /><br /> Изменяется внутреннее представление хранилища.<br /><br /> Увеличивается разрешение хранимых значений.<br /><br /> Отрицательные значения года запрещены.<br /><br /> <br /><br /> Примечание. измените приложения и выражения XQuery для учета новых значений типа.|  
|Выражения XQuery и Xpath|В в [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] выражениях XQuery или XPath, которые начинаются с двоеточия (":"), допускаются шаги. Например, следующая инструкция содержит в пределах выражения пути проверку имени (`CTR02)`, которое начинается с двоеточия.<br /><br /> `SELECT FileContext.query('for n$ in //CTR return <C>{data )(n$/:CTR02)} </C>) AS Files FROM dbo.MyTable;`<br /><br /> В [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] такое использование не допускается, поскольку это не соответствует стандартам XML. Возвращена ошибка 9341. Удалите начальное двоеточие или укажите префикс для проверки имени, например (n$/CTR02) или (n$/p1:CTR02).|  
  
### <a name="connecting"></a>Соединение  
  
|Компонент|Описание|  
|-------------|-----------------|  
|Соединение с Native Client [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] по протоколу SSL|При соединении через Native Client [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] те приложения, которые используют параметр "SERVER=shortname; FORCE ENCRYPTION=true" с сертификатом, где в субъекте указано полное доменное имя (FQDN), раньше подключались благодаря ослабленной проверке. SQL Server 2008 R2 расширяет защиту за счет включения в сертификаты предмета FQDN. В приложениях, где используется ослабленная проверка, необходимо предпринять следующие меры.<br /><br /> Используйте полное доменное имя в строке подключения.<br /><br /> — Этот параметр не требует перекомпиляции приложения, если ключевое слово SERVER в строке подключения настроено вне приложения.<br /><br /> — Этот параметр не работает для приложений, для которых строки подключения жестко закодированы.<br /><br /> — Этот параметр не работает для приложений, использующих зеркальное отображение базы данных, так как зеркальный сервер отвечает простым именем.|  
||Чтобы обеспечить соответствие полного доменного имени, добавьте для короткого имени псевдоним.<br /><br /> — Этот параметр работает даже для приложений, для которых строки подключения жестко закодированы.<br /><br /> — Этот параметр не работает для приложений, использующих зеркальное отображение базы данных, так как поставщики не ищут псевдонимы для получения имен партнеров по обеспечению отработки отказа.|  
||Получите сертификат для короткого имени.<br /><br /> — Этот параметр работает для всех приложений.|  

## <a name="breaking-changes-in-sql-server-2005"></a><a name="Yukon"></a>Критические изменения в SQL Server 2005  

[!INCLUDE[Archived documentation for very old versions of SQL Server](../includes/paragraph-content/previous-versions-archive-documentation-sql-server.md)]

## <a name="see-also"></a>См. также:  
 [Устаревшие функции ядро СУБД в SQL Server 2014](deprecated-database-engine-features-in-sql-server-2016.md?view=sql-server-2014)   
 [Изменения в работе функций ядро СУБД в SQL Server 2014](../../2014/database-engine/behavior-changes-to-database-engine-features-in-sql-server-2014.md?view=sql-server-2014)   
 [Неподдерживаемые функции ядро СУБД в SQL Server 2014](discontinued-database-engine-functionality-in-sql-server-2016.md?view=sql-server-2014)   
 [Обратная совместимость компонента ядра СУБД SQL Server](sql-server-database-engine-backward-compatibility.md)   
 [Уровень совместимости инструкции ALTER DATABASE (Transact-SQL)](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level)  
 [Критические изменения в функциях средств управления в SQL Server 2014](breaking-changes-to-management-tools-features-in-sql-server-2014.md?view=sql-server-2014)  
  
