---
title: Выполнение принудительного перехода на другой ресурс вручную для группы доступности (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 06/14/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
f1_keywords:
- sql12.swb.availabilitygroup.forcefailover.f1
helpviewer_keywords:
- Availability Groups [SQL Server], failover
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 222288fe-ffc0-4567-b624-5d91485d70f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: f36908102a09eb1ef1f7a485898da715deb4253b
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658411"
---
# <a name="perform-a-forced-manual-failover-of-an-availability-group-sql-server"></a><span data-ttu-id="d6cc5-102">Выполнение принудительного перехода на другой ресурс вручную для группы доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-102">Perform a Forced Manual Failover of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="d6cc5-103">В этом разделе описывается выполнение принудительной отработки отказа (с возможной потерей данных) в группе доступности AlwaysOn с использованием [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)] или PowerShell в [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6cc5-103">This topic describes how to perform a forced failover (with possible data loss) on an AlwaysOn availability group by using [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)], or PowerShell in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="d6cc5-104">Принудительная отработка отказа — это форма перехода на другой ресурс вручную, предназначенная исключительно для аварийного восстановления в случаях, когда невозможно выполнить [запланированную отработку отказа вручную](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md) .</span><span class="sxs-lookup"><span data-stu-id="d6cc5-104">A forced failover is a form of manual failover that is intended strictly for disaster recovery, when a [planned manual failover](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md) is not possible.</span></span> <span data-ttu-id="d6cc5-105">Если выполняется принудительный переход на несинхронизированную вторичную реплику, возможна потеря данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-105">If you force failover to an unsynchronized secondary replica, some data loss is possible.</span></span> <span data-ttu-id="d6cc5-106">Поэтому мы настоятельно рекомендуем выполнять принудительную отработку отказа только в том случае, если необходимо немедленно возобновить работу группы доступности и вы готовы пойти на риск потери данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-106">Therefore, we strongly recommend that you force failover only if you must restore service to the availability group immediately and you are willing to risk losing data.</span></span>  
  
 <span data-ttu-id="d6cc5-107">После принудительной отработки отказа цель перехода, на которую перешла группа доступности, становится новой первичной репликой.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-107">After a forced failover, the failover target to which the availability group was failed over becomes the new primary replica.</span></span> <span data-ttu-id="d6cc5-108">Базы данных-получатели на оставшихся вторичных репликах приостанавливаются и должны быть восстановлены вручную.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-108">The secondary databases in the remaining secondary replicas are suspended and must be manually resumed.</span></span> <span data-ttu-id="d6cc5-109">Если прежняя первичная реплика станет доступной, то она переключится в роль вторичной, в связи с чем бывшие базы данных-источники станут базами данных-получателями и перейдут в состояние SUSPENDED.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-109">When the former primary replica becomes available, it transitions to the secondary role, causing the former primary databases to become secondary databases and transition into the SUSPENDED state.</span></span> <span data-ttu-id="d6cc5-110">Перед возобновлением работы данной базы данных-получателя можно попробовать восстановить ее потерянные данные.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-110">Before you resume a given secondary database, you might be able to recover lost data from it.</span></span> <span data-ttu-id="d6cc5-111">Однако обратите внимание, что, если хотя бы одна из баз данных-получателей приостановлена, усечение журнала транзакций в данной базе данных-источнике откладывается.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-111">However, notice that transaction log truncation is delayed on a given primary database while any of its secondary databases is suspended.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="d6cc5-112">Синхронизация данных с базы данных-источника не будет выполняться, пока работа база данных-получатель не будет возобновлена.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-112">Data synchronization with the primary database will not occur until the secondary database is resumed.</span></span> <span data-ttu-id="d6cc5-113">Сведения о возобновлении работы базы данных-получателя см. в разделе [Дальнейшие действия. Основные задачи после принудительной отработки отказа](#FollowUp) далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-113">For information about resuming a secondary database, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp) later in this article.</span></span>  
  
 <span data-ttu-id="d6cc5-114">Выполнение принудительной отработки отказа требуется в следующих аварийных случаях.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-114">Performing a forced failover is necessary in the following emergency situations:</span></span>  
  
-   <span data-ttu-id="d6cc5-115">После принудительного создания кворума в кластере WSFC (*принудительный кворум*) необходимо выполнить принудительную отработку отказа для каждой группы доступности (с возможной потерей данных).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-115">After forcing quorum on the WSFC cluster (*forced quorum*), you need to force failover each availability group (with possible data loss).</span></span> <span data-ttu-id="d6cc5-116">Принудительная отработка отказа необходима, поскольку реальное состояние значений кластера WSFC могло быть потеряно.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-116">Forcing failover is required because the real state of the WSFC cluster values might have been lost.</span></span> <span data-ttu-id="d6cc5-117">Однако вы можете избежать потери данных, если удалось выполнить принудительный переход на экземпляр сервера, на котором размещалась реплика, которая была первичной репликой перед принудительным созданием кворума, или на вторичную реплику, которая была синхронизирована перед принудительным созданием кворума.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-117">However, you can avoid data loss, if are able to force failover on the server instance that was hosting the replica that was the primary replica before you forced quorum or to a secondary replica that was synchronized before you forced quorum.</span></span> <span data-ttu-id="d6cc5-118">Дополнительные сведения см. в подразделе [Потенциальные методы избежания потери данных после принудительного создания кворума](#WaysToAvoidDataLoss)далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-118">For more information, see [Potential Ways to Avoid Data Loss After Quorum is Forced](#WaysToAvoidDataLoss), later in this topic.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="d6cc5-119">Если кворум был восстановлен естественными средствами, а не принудительно, для реплик доступности будет выполнено обычное восстановление.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-119">If quorum is regained by natural means instead of being forced, the availability replicas will go through normal recovery.</span></span> <span data-ttu-id="d6cc5-120">Если первичная реплика остается недоступной после восстановления кворума, вы можете выполнить запланированный переход на другой ресурс вручную на синхронизированную вторичную реплику.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-120">If the primary replica is still unavailable after quorum is regained, you can perform a planned manual failover to a synchronized secondary replica.</span></span>  
  
     <span data-ttu-id="d6cc5-121">Дополнительные сведения о принудительном создании кворума см. в статье [Аварийное восстановление WSFC через принудительный кворум (SQL Server)](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-121">For information about forcing quorum, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span> <span data-ttu-id="d6cc5-122">Дополнительные сведения о причинах потребности в выполнении принудительной отработки отказа после принудительного создания кворума см. в разделе [Отработка отказа и режимы отработки отказа (группы доступности AlwaysOn)](failover-and-failover-modes-always-on-availability-groups.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-122">For information about why forcing failover is required after forcing quorum, see [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
-   <span data-ttu-id="d6cc5-123">Если первичная реплика становится недоступной, когда кластер WSFC имеет работоспособный кворум, вы можете выполнить принудительный переход (с возможной потерей данных) на любую реплику, роль которой находится в состоянии SECONDARY или RESOLVING.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-123">If the primary replica becomes unavailable when the WSFC cluster has a healthy quorum, you can force failover (with possible data loss), to any replica whose role is in the SECONDARY or RESOLVING state.</span></span> <span data-ttu-id="d6cc5-124">Если возможно, выполните принудительный переход на вторичную реплику с синхронной фиксацией, которая была синхронизирована в момент потери первичной реплики.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-124">If possible, force failover to a synchronous-commit secondary replica that was synchronized when the primary replica was lost.</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="d6cc5-125">Если кластер WSFC имеет работоспособный кворум, при выполнении команды принудительного перехода на синхронизированную вторичную реплику реплика фактически выполнит запланированный переход на другой ресурс вручную.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-125">When the WSFC cluster has a healthy quorum, if you issue a force failover command on a synchronized secondary replica, the replica actually performs a planned manual failover.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="d6cc5-126">Дополнительные сведения о требованиях и рекомендациях для принудительной отработки отказа, а также пример использования принудительного перехода на другой ресурс для восстановления из ситуации критического сбоя см. в подразделе [Пример сценария: использование принудительной отработки отказа для восстановления после критического сбоя](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#ExampleRecoveryFromCatastrophy) далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-126">For more information about the prerequisites and recommendations for forcing failover and for an example scenario that uses a forced failover to recover from a catastrophic failure, see [Example Scenario: Using a Forced Failover to Recover from a Catastrophic Failure](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#ExampleRecoveryFromCatastrophy), later in this topic.</span></span>  
  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> <span data-ttu-id="d6cc5-127">Перед началом</span><span class="sxs-lookup"><span data-stu-id="d6cc5-127">Before You Begin</span></span>  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> <span data-ttu-id="d6cc5-128">Ограничения</span><span class="sxs-lookup"><span data-stu-id="d6cc5-128">Limitations and Restrictions</span></span>  
  
-   <span data-ttu-id="d6cc5-129">Единственный случай, когда нельзя выполнить принудительную отработку отказа, — кластер отказоустойчивого кластера Windows Server (WSFC) нет имеет кворума.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-129">The only time that you cannot perform a forced failover is when Windows Server Failover Clustering (WSFC) cluster lacks quorum.</span></span>  
  
-   <span data-ttu-id="d6cc5-130">В ходе принудительной отработки отказа группой доступности возможна потеря данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-130">Data loss is possible during the forced failover of an availability group.</span></span> <span data-ttu-id="d6cc5-131">Помимо этого, если первичная реплика работает во время запуска принудительной отработки отказа, клиенты могут сохранить соединение с прежними базами данных-источниками.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-131">In addition, if the primary replica is running when you initiate a forced failover, clients might still be connected to former primary databases.</span></span> <span data-ttu-id="d6cc5-132">Поэтому настоятельно рекомендуется выполнять принудительную отработку отказа только в том случае, если первичная реплика уже не работает, и риск потери данных является приемлемым, чтобы восстановить доступ к базам данных в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-132">Therefore, we strongly recommend that you force failover only if the primary replica is no longer running and if you are willing to risk losing data in order to restore access to databases in the availability group.</span></span>  
  
-   <span data-ttu-id="d6cc5-133">Если база данных-получатель находится в состоянии REVERTING или INITIALIZING, принудительная отработка отказа приведет к тому, что базе данных не удастся запуститься в качестве базы данных-источника.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-133">When a secondary database in the REVERTING or INITIALIZING state, forcing failover would cause the database to fail to start as a primary database.</span></span> <span data-ttu-id="d6cc5-134">Если база данных находилась в состоянии INTIAILIZGING, то потребуется применить отсутствующие записи журнала из резервной копии базы данных либо полностью восстановить базу данных с нуля.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-134">If the database was in the INTIAILIZGING state the you will need to apply the missing log records from a database backup or fully restore the database from scratch.</span></span> <span data-ttu-id="d6cc5-135">Если база данных находилась в состоянии REVERTING, потребуется полностью восстановить ее из резервных копий.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-135">If the database was in the REVERTING state you will need to fully restore the database from backups.</span></span>  
  
-   <span data-ttu-id="d6cc5-136">Команда отработки отказа завершает работу сразу после того, как цель перехода принимает команду.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-136">A failover command returns as soon as the failover target has accepted the command.</span></span> <span data-ttu-id="d6cc5-137">Однако восстановление базы данных происходит асинхронно после того, как группа доступности закончит отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-137">However, database recovery occurs asynchronously after the availability group has finished failing over.</span></span>  
  
-   <span data-ttu-id="d6cc5-138">Целостность данных между базами данных в рамках группы доступности во время отработки отказа не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-138">Cross-database consistency across databases within the availability group is not maintained on failover.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="d6cc5-139">Транзакции между базами данных и распределенные транзакции не поддерживаются в [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span><span class="sxs-lookup"><span data-stu-id="d6cc5-139">Cross-database transactions and distributed transactions are not supported by [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="d6cc5-140">Дополнительные сведения см. в разделе [Транзакции между базами данных не поддерживаются при зеркальном отображении баз данных или в группах доступности AlwaysOn (SQL Server)](transactions-always-on-availability-and-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-140">For more information, see [Cross-Database Transactions Not Supported For Database Mirroring or AlwaysOn Availability Groups &#40;SQL Server&#41;](transactions-always-on-availability-and-database-mirroring.md).</span></span>  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a> <span data-ttu-id="d6cc5-141">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="d6cc5-141">Prerequisites</span></span>  
  
-   <span data-ttu-id="d6cc5-142">В кластере WSFC есть кворум.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-142">The WSFC cluster has quorum.</span></span> <span data-ttu-id="d6cc5-143">Если у кластера нет кворума, см. статью [Аварийное восстановление WSFC через принудительный кворум (SQL Server)](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-143">If the cluster lacks quorum, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span>  
  
-   <span data-ttu-id="d6cc5-144">Необходимо иметь возможность подключения к экземпляру сервера, на котором размещена реплика, роль которой находится в состоянии SECONDARY или RESOLVING.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-144">You must be able to connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state.</span></span>  
  
###  <a name="recommendations"></a><a name="Recommendations"></a> <span data-ttu-id="d6cc5-145">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="d6cc5-145">Recommendations</span></span>  
  
-   <span data-ttu-id="d6cc5-146">Не выполняйте принудительную отработку отказа, если первичная реплика все еще работает.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-146">Do not force failover while the primary replica is still running.</span></span>  
  
-   <span data-ttu-id="d6cc5-147">Если это возможно, выполняйте принудительный переход только на те цели перехода, базы данных-получатели которых имеют состояние NOT SYNCHRONIZED, SYNCHRONIZED или SYNCHRONIZING.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-147">If possible, force failover only to a failover target whose secondary databases are either in the NOT SYNCHRONIZED, SYNCHRONIZED, or SYNCHRONIZING state.</span></span> <span data-ttu-id="d6cc5-148">Сведения о последствиях принудительной отработки отказа, когда база данных-получатель находится в состоянии INTIAILIZING или REVERTING, см. в разделе [Ограничения](#Restrictions)ранее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-148">For information about the implications of forcing failover when a secondary database is in the INTIAILIZGING or REVERTING state, see [Limitations and Restrictions](#Restrictions), earlier in this topic.</span></span>  
  
-   <span data-ttu-id="d6cc5-149">Как правило, задержка определенной базы данных-получателя относительно базы данных-источника должна быть одинаковой в разных вторичных репликах с асинхронной фиксацией.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-149">Typically, the latency of a given secondary database, relative to the primary database, should be similar on different asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="d6cc5-150">Тем не менее, принудительная отработка отказа может привести к значительной потере данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-150">However, when forcing failover, data loss can be a significant concern.</span></span> <span data-ttu-id="d6cc5-151">В связи с этим можно потратить время на определение относительной задержки копий баз данных в разных вторичных репликах.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-151">Therefore, consider taking time to determine the relative latency of the copies of the databases on different secondary replicas.</span></span> <span data-ttu-id="d6cc5-152">Чтобы определить, какая из копий базы данных-получателя имеет наименьшую задержку, сравните их номера LSN в конце журнала.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-152">To determine which copy of a given secondary database has the least latency, compare their end-of-log LSNs.</span></span> <span data-ttu-id="d6cc5-153">Чем выше номер LSN конца журнала, тем меньше задержка.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-153">A higher the end-of-log LSN indicates less latency.</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="d6cc5-154">Для сравнения значений номеров LSN конца журнала подключитесь по очереди к каждой работающей вторичной реплике и определите значение [end_of_log_lsn](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) каждой локальной базы данных-получателя, отправив запрос **sys.dm_hadr_database_replica_states** .</span><span class="sxs-lookup"><span data-stu-id="d6cc5-154">To compare end-of-log LSNs, connect to each online secondary replica, in turn, and query [sys.dm_hadr_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) for the **end_of_log_lsn** value of each local secondary database.</span></span> <span data-ttu-id="d6cc5-155">Затем сравните значения номеров LSN конца журнала для различных копий каждой базы данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-155">Then, compare the end-of-log LSNs of the different copies of each database.</span></span> <span data-ttu-id="d6cc5-156">Обратите внимание: высшие значения номеров LSN для разных баз данных могут находиться на разных вторичных репликах.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-156">Note that different databases might have their highest LSNs on different secondary replicas.</span></span> <span data-ttu-id="d6cc5-157">В этом случае выбор целевого места для отработки отказа зависит от относительной важности данных в различных базах данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-157">In this case, the most appropriate failover target depends on the relative importance that you place on the data in the different databases.</span></span> <span data-ttu-id="d6cc5-158">Другими словами, следует определить, для какой базы данных нужнее всего минимизировать возможность потери данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-158">That is, for which of these databases would you most want to minimize possible data loss?</span></span>  
  
-   <span data-ttu-id="d6cc5-159">Если клиенты могут подключаться к оригинальной первичной реплике, то принудительная отработка отказа может привести к риску разбиения в работе баз данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-159">If clients are able to connect to the original primary, a forced failover incurs some risk of split brain behavior.</span></span> <span data-ttu-id="d6cc5-160">Перед выполнением принудительной отработки отказа рекомендуется предотвратить возможность соединения клиентов с первичной главной репликой.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-160">Before you force failover, we strongly recommend that you prevent clients from accessing the original primary replica.</span></span> <span data-ttu-id="d6cc5-161">В противном случае после запуска принудительной отработки отказа исходные и текущие базы данных-источники могут обновляться независимо друг от друга.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-161">Otherwise, after failover is forced, the original primary databases and the current primary databases could be updated independently of the other.</span></span>  
  
###  <a name="potential-ways-to-avoid-data-loss-after-quorum-is-forced"></a><a name="WaysToAvoidDataLoss"></a> <span data-ttu-id="d6cc5-162">Потенциальные методы избежания потери данных после принудительного создания кворума</span><span class="sxs-lookup"><span data-stu-id="d6cc5-162">Potential Ways to Avoid Data Loss After Quorum is Forced</span></span>  
 <span data-ttu-id="d6cc5-163">При некоторых условиях сбоя после потери кворума вы можете избежать потери данных следующим образом.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-163">Under some failure conditions after quorum is lost, you can avoid prevent data loss, as follows:</span></span>  
  
-   <span data-ttu-id="d6cc5-164">**Если исходная первичная реплика станет доступной в сети**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-164">**If the original primary replica comes online**</span></span>  
  
     <span data-ttu-id="d6cc5-165">Если кворум теряется и принудительное восстановление кворума WSFC восстанавливает узел кластера, на котором размещена первичная реплика группы доступности, вы можете предотвратить потерю данных для этой группы доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-165">If quorum is lost and forcing WSFC quorum restores the cluster node that hosts the primary replica of an availability group, you can prevent data loss for this availability group.</span></span> <span data-ttu-id="d6cc5-166">Подключитесь к первичной реплике и выполните принудительную отработку отказа (FAILOVER_ALLOW_DATA_LOSS).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-166">Connect to the primary replica and perform a forced failover (FAILOVER_ALLOW_DATA_LOSS).</span></span> <span data-ttu-id="d6cc5-167">Это переведет первичную реплику в режим «в сети».</span><span class="sxs-lookup"><span data-stu-id="d6cc5-167">This brings the primary replica back online.</span></span> <span data-ttu-id="d6cc5-168">Поскольку выполняется принудительный переход на исходную первичную реплику, потери данных нет.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-168">Because you perform the forced failover to the original primary replica, there is no data loss.</span></span>  
  
-   <span data-ttu-id="d6cc5-169">**Если синхронизированная вторичная реплика с синхронной фиксацией переходит в режим «в сети»**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-169">**If a synchronized synchronous-commit secondary replica comes online**</span></span>  
  
     <span data-ttu-id="d6cc5-170">Если кворум потерян и принудительное восстановление кворума WSFC приводит к восстановлению узла кластера, на котором размещена синхронизированная вторичная реплика группы доступности, то потерю данных для этой группы доступности можно предотвратить.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-170">If quorum is lost and forcing WSFC quorum restores a cluster node that hosts a synchronized secondary replica for an availability group, you should be able to prevent data loss for this availability group.</span></span> <span data-ttu-id="d6cc5-171">Если восстановленный узел был в рабочем состоянии во время потери кворума, вы можете определить, произошла ли потеря данных в указанной базе данных, с помощью запроса к столбцу **is_failover_ready** динамического административного представления [sys.dm_hadr_database_replica_cluster_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-cluster-states-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="d6cc5-171">If the restored node was up at the time that quorum was lost, you can determine whether data loss could occur on a given database by querying the **is_failover_ready** column of the [sys.dm_hadr_database_replica_cluster_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-cluster-states-transact-sql) dynamic management view.</span></span> <span data-ttu-id="d6cc5-172">Например, для экземпляра сервера с именем `sql108w2k8r22`, выполните следующий запрос:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-172">For example, for a server instance named `sql108w2k8r22`, issue the following query:</span></span>  
  
    ```  
    SELECT * FROM sys.dm_hadr_database_replica_cluster_states  
       WHERE replica_id=(SELECT replica_id FROM sys.availability_replicas   
          WHERE replica_server_name ='sql108w2k8r22')  
    ```  
  
    > [!CAUTION]  
    >  <span data-ttu-id="d6cc5-173">Если восстановленный узел не был в рабочем состоянии в момент потери кворума, столбец **is_failover_ready** может не отражать действительного состояния кластера в момент перехода первичной реплики в режим "вне сети".</span><span class="sxs-lookup"><span data-stu-id="d6cc5-173">If the restored node was not up at the time quorum was lost, **is_failover_ready** may not reflect the cluster's actual state at the time the primary replica went offline.</span></span> <span data-ttu-id="d6cc5-174">Поэтому значение **is_failover_ready** надлежащее, только если узел размещения на момент сбоя был в рабочем состоянии.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-174">Therefore, the **is_failover_ready** value is only good if the host node at the time of the failure.</span></span> <span data-ttu-id="d6cc5-175">Дополнительные сведения см. в разделе "Почему принудительная отработка отказа требуется после принудительного создания кворума" статьи [Отработка отказа и режимы отработки отказа (группы доступности AlwaysOn)](failover-and-failover-modes-always-on-availability-groups.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-175">For more information, see "Why Forced Failover is Required After Forcing Quorum" in [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
     <span data-ttu-id="d6cc5-176">Если **is_failover_ready** = 1, база данных помечена в кластере как синхронизированная и готовая к отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-176">If **is_failover_ready** = 1, the database is marked as synchronized in the cluster and is ready for a failover.</span></span> <span data-ttu-id="d6cc5-177">Если **is_failover_ready** = 1 для всех баз данных данной вторичной реплики, вы можете выполнить принудительный переход на эту вторичную реплику (FORCE_FAILOVER_ALLOW_DATA_LOSS) без потери данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-177">If **is_failover_ready** = 1 on every database on a given secondary replica, you can perform a forced failover (FORCE_FAILOVER_ALLOW_DATA_LOSS) without data loss on this secondary replica.</span></span> <span data-ttu-id="d6cc5-178">Синхронизированная вторичная реплика перейдет в режим «в сети» в первичной роли как новая первичная реплика с неповрежденными данными.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-178">The synchronized secondary replica comes online in the primary role, that is, as the new primary replica, with all the data intact.</span></span>  
  
     <span data-ttu-id="d6cc5-179">Если **is_failover_ready** = 0, база данных не помечена в кластере как синхронизированная и *не* готова к запланированному переходу на другой ресурс вручную.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-179">If **is_failover_ready** = 0, the database is not marked as synchronized in the cluster and is *not* ready for a planned manual failover.</span></span> <span data-ttu-id="d6cc5-180">При выполнении принудительного перехода на вторичную реплику размещения в этой базе данных будут потеряны данные.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-180">If you force failover to the host secondary replica, data will be lost on this database.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="d6cc5-181">При выполнении принудительного перехода на вторичную реплику объем потерянных данных зависит от того, насколько сильно цель перехода отстает от первичной реплики.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-181">When you force failover to a secondary replica, the amount of data loss will depend on how far the failover target is lagging behind the primary replica.</span></span> <span data-ttu-id="d6cc5-182">К сожалению, если у кластера WSFC нет кворума или если был обеспечен принудительный кворум, нельзя определить объем возможной потери данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-182">Unfortunately, when the WSFC cluster lacks quorum or quorum has been forced, you cannot assess the amount of potential data loss.</span></span> <span data-ttu-id="d6cc5-183">Однако после восстановления работоспособности кворума кластера WSFC можно начать отслеживать возможную потерю данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-183">Note, however, that once the WSFC cluster regains a healthy quorum, you could begin to track potential data loss.</span></span> <span data-ttu-id="d6cc5-184">Дополнительные сведения см. в разделе "Отслеживание возможной потери данных" статьи [Отработка отказа и режимы отработки отказа (группы доступности AlwaysOn)](failover-and-failover-modes-always-on-availability-groups.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-184">For more information, see "Tracking Potential Data Loss" in [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
###  <a name="security"></a><a name="Security"></a> <span data-ttu-id="d6cc5-185">безопасность</span><span class="sxs-lookup"><span data-stu-id="d6cc5-185">Security</span></span>  
  
####  <a name="permissions"></a><a name="Permissions"></a> <span data-ttu-id="d6cc5-186">Permissions</span><span class="sxs-lookup"><span data-stu-id="d6cc5-186">Permissions</span></span>  
 <span data-ttu-id="d6cc5-187">Необходимо разрешение ALTER AVAILABILITY GROUP для группы доступности, разрешение CONTROL AVAILABILITY GROUP, разрешение ALTER ANY AVAILABILITY GROUP или разрешение CONTROL SERVER.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-187">Requires ALTER AVAILABILITY GROUP permission on the availability group, CONTROL AVAILABILITY GROUP permission, ALTER ANY AVAILABILITY GROUP permission, or CONTROL SERVER permission.</span></span>  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> <span data-ttu-id="d6cc5-188">Использование среды SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="d6cc5-188">Using SQL Server Management Studio</span></span>  
 <span data-ttu-id="d6cc5-189">**Принудительная отработка отказа (с возможной потерей данных)**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-189">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="d6cc5-190">В обозревателе объектов подключитесь к экземпляру сервера, на котором размещена реплика группы доступности, роль которой находится в состоянии SECONDARY или RESOLVING и на которую нужно выполнить переход, и разверните дерево сервера.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-190">In Object Explorer, connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over, and expand the server tree.</span></span>  
  
2.  <span data-ttu-id="d6cc5-191">Разверните узел **Высокий уровень доступности AlwaysOn** и узел **Группы доступности** .</span><span class="sxs-lookup"><span data-stu-id="d6cc5-191">Expand the **AlwaysOn High Availability** node and the **Availability Groups** node.</span></span>  
  
3.  <span data-ttu-id="d6cc5-192">Щелкните правой кнопкой мыши группу доступности для выполнения отработки отказа и выберите команду **Отработка отказа** .</span><span class="sxs-lookup"><span data-stu-id="d6cc5-192">Right-click the availability group to be failed over, and select the **Failover** command.</span></span>  
  
4.  <span data-ttu-id="d6cc5-193">Будет запущен мастер отработки отказа группой доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-193">This launches the Failover Availability Group Wizard.</span></span> <span data-ttu-id="d6cc5-194">Дополнительные сведения см. в подразделе [Использование мастера отработки отказа группы доступности (среда SQL Server Management Studio)](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-194">For more information, see [Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md).</span></span>  
  
5.  <span data-ttu-id="d6cc5-195">После принудительной отработки отказа группой доступности выполните необходимые дополнительные действия.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-195">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="d6cc5-196">Дополнительные сведения см. в разделе [Дальнейшие действия. Основные задачи после принудительной отработки отказа](#FollowUp) далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-196">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> <span data-ttu-id="d6cc5-197">Использование Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="d6cc5-197">Using Transact-SQL</span></span>  
 <span data-ttu-id="d6cc5-198">**Принудительная отработка отказа (с возможной потерей данных)**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-198">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="d6cc5-199">Подключитесь к экземпляру сервера, на котором размещена реплика группы доступности, роль которой находится в состоянии SECONDARY или RESOLVING и для которой нужно выполнить отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-199">Connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over.</span></span>  
  
2.  <span data-ttu-id="d6cc5-200">Инструкция [ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) используется следующим образом:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-200">Use the [ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) statement, as follows:</span></span>  
  
     <span data-ttu-id="d6cc5-201">ALTER AVAILABILITY GROUP *имя_группы* FORCE_FAILOVER_ALLOW_DATA_LOSS</span><span class="sxs-lookup"><span data-stu-id="d6cc5-201">ALTER AVAILABILITY GROUP *group_name* FORCE_FAILOVER_ALLOW_DATA_LOSS</span></span>  
  
     <span data-ttu-id="d6cc5-202">где *имя_группы* — это имя группы доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-202">where *group_name* is the name of the availability group.</span></span>  
  
     <span data-ttu-id="d6cc5-203">В следующем примере выполняется принудительная отработка отказа группы доступности `AccountsAG` с переходом на локальную вторичную реплику.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-203">The following example forces the `AccountsAG` availability group to fail over to the local secondary replica.</span></span>  
  
    ```sql
    ALTER AVAILABILITY GROUP AccountsAG FORCE_FAILOVER_ALLOW_DATA_LOSS;  
    ```  
  
3.  <span data-ttu-id="d6cc5-204">После принудительной отработки отказа группой доступности выполните необходимые дополнительные действия.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-204">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="d6cc5-205">Дополнительные сведения см. в разделе [Дальнейшие действия. Основные задачи после принудительной отработки отказа](#FollowUp) далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-205">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> <span data-ttu-id="d6cc5-206">Использование PowerShell</span><span class="sxs-lookup"><span data-stu-id="d6cc5-206">Using PowerShell</span></span>  
 <span data-ttu-id="d6cc5-207">**Принудительная отработка отказа (с возможной потерей данных)**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-207">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="d6cc5-208">Измените каталог ( `cd` ) на экземпляр сервера, на котором размещена реплика, роль которой находится в дополнительном или разрешении состояния в группе доступности, для которой необходимо выполнить отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-208">Change directory (`cd`) to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over.</span></span>  
  
2.  <span data-ttu-id="d6cc5-209">Используйте командлет `Switch-SqlAvailabilityGroup` с параметром `AllowDataLoss` в одной из следующих форм:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-209">Use the `Switch-SqlAvailabilityGroup` cmdlet with the `AllowDataLoss` parameter in one of the following forms:</span></span>  
  
    -   `-AllowDataLoss`  
  
         <span data-ttu-id="d6cc5-210">По умолчанию применение параметра `-AllowDataLoss` приводит к тому, что `Switch-SqlAvailabilityGroup` подскажет, что принудительная отработка отказа может вызвать потерю незавершенных транзакций, и запросит подтверждение.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-210">By default `-AllowDataLoss` parameter causes `Switch-SqlAvailabilityGroup` to prompt you to remind you that forcing failover might result in the loss of uncommitted transactions and to request confirmation.</span></span> <span data-ttu-id="d6cc5-211">Чтобы продолжить, введите букву `Y`; чтобы отменить операцию, введите букву `N`.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-211">To continue, enter `Y`; to cancel the operation, enter `N`.</span></span>  
  
         <span data-ttu-id="d6cc5-212">В следующем примере выполняется принудительная отработка отказа (с возможной потерей данных) группой доступности `MyAg` на вторичную реплику на экземпляре сервера с именем `SecondaryServer\InstanceName`.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-212">The following example performs a forced failover (with possible data loss) of the availability group `MyAg` to the secondary replica on the server instance named `SecondaryServer\InstanceName`.</span></span> <span data-ttu-id="d6cc5-213">Будет предложено подтвердить эту операцию.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-213">You will be prompted to confirm this operation.</span></span>  
  
        ```powershell
        Switch-SqlAvailabilityGroup -Path SQLSERVER:\Sql\SecondaryServer\InstanceName\AvailabilityGroups\MyAg -AllowDataLoss  
        ```  
  
    -   <span data-ttu-id="d6cc5-214">**-AllowDataLoss-Force**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-214">**-AllowDataLoss-Force**</span></span>  
  
         <span data-ttu-id="d6cc5-215">Чтобы инициировать принудительную отработку отказа без подтверждения, укажите оба параметра, `-AllowDataLoss` и `-Force`.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-215">To initiate a forced failover without confirmation, specify both the `-AllowDataLoss` and `-Force` parameters.</span></span> <span data-ttu-id="d6cc5-216">Это полезно, если нужно включить команду в скрипт и запустить ее без взаимодействия с пользователем.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-216">This is useful if you want to include the command in a script and run it without user interaction.</span></span>  <span data-ttu-id="d6cc5-217">Но пользуйтесь параметром `-Force` осмотрительно, так как принудительная отработка отказа может привести к потере данных в базах данных, участвующих в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-217">However, use the `-Force` option with caution, because a forced failover might result in the loss of data from databases participating the availability group.</span></span>  
  
         <span data-ttu-id="d6cc5-218">В следующем примере выполняется принудительная отработка отказа (с возможной потерей данных) группой доступности `MyAg` на экземпляр сервера с именем `SecondaryServer\InstanceName`.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-218">The following example performs a forced failover (with possible data loss) of the availability group `MyAg` to the server instance named `SecondaryServer\InstanceName`.</span></span> <span data-ttu-id="d6cc5-219">Параметр `-Force` запрещает подтверждение этой операции.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-219">The `-Force` option suppresses confirmation of this operation.</span></span>  
  
        ```powershell
        Switch-SqlAvailabilityGroup -Path SQLSERVER:\Sql\SecondaryServer\InstanceName\AvailabilityGroups\MyAg -AllowDataLoss -Force  
        ```  
  
    > [!NOTE]  
    >  <span data-ttu-id="d6cc5-220">Чтобы просмотреть синтаксис командлета, воспользуйтесь командлетом `Get-Help` в среде [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-220">To view the syntax of a cmdlet, use the `Get-Help` cmdlet in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell environment.</span></span> <span data-ttu-id="d6cc5-221">Дополнительные сведения см. в разделе [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-221">For more information, see [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span></span>  
  
3.  <span data-ttu-id="d6cc5-222">После принудительной отработки отказа группой доступности выполните необходимые дополнительные действия.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-222">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="d6cc5-223">Дополнительные сведения см. в разделе [Дальнейшие действия. Основные задачи после принудительной отработки отказа](#FollowUp) далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-223">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
 <span data-ttu-id="d6cc5-224">**Настройка и использование поставщика SQL Server PowerShell**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-224">**To set up and use the SQL Server PowerShell provider**</span></span>  
  
-   [<span data-ttu-id="d6cc5-225">Поставщик SQL Server PowerShell</span><span class="sxs-lookup"><span data-stu-id="d6cc5-225">SQL Server PowerShell Provider</span></span>](../../../powershell/sql-server-powershell-provider.md)  
  
##  <a name="follow-up-essential-tasks-after-a-forced-failover"></a><a name="FollowUp"></a> <span data-ttu-id="d6cc5-226">Дальнейшие действия. Основные задачи после принудительной отработки отказа</span><span class="sxs-lookup"><span data-stu-id="d6cc5-226">Follow Up: Essential Tasks After a Forced Failover</span></span>  
  
1.  <span data-ttu-id="d6cc5-227">После принудительной отработки отказа вторичная реплика, на которую перешла группа доступности, становится новой первичной репликой.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-227">After a forced failover, the secondary replica to which you failed over becomes the new primary replica.</span></span> <span data-ttu-id="d6cc5-228">Однако, чтобы сделать эту реплику доступности доступной клиентам, может потребоваться повторная настройка WSFC-кворума или регулировка конфигурации режима доступности для группы доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-228">However, to make that availability replica accessible to clients, you might need to reconfigure the WSFC quorum or adjust the availability-mode configuration of the availability group, as follows:</span></span>  
  
    -   <span data-ttu-id="d6cc5-229">**Если отработка отказа выполнена за пределами [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)]**  Отрегулируйте голоса кворума WSFC-узлов так, чтобы они соответствовали новой конфигурации группы доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-229">**If you failed over outside of the [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)]:**  Adjust the quorum votes of the WSFC nodes to reflect your new availability group configuration.</span></span> <span data-ttu-id="d6cc5-230">Если WSFC-узел, на котором размещена целевая вторичная реплика, не имеет голоса WSFC-кворума, может потребоваться получить WSFC-кворум принудительно.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-230">If the WSFC node that hosts the target secondary replica does not have a WSFC quorum vote, you might need to force WSFC quorum.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="d6cc5-231">[!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] существует, только если две реплики доступности (включая прежнюю первичную реплику) настроены на режим синхронной фиксации с автоматическим переходом на другой ресурс.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-231">An [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] exists only if two availability replicas (including the previous primary replica) are configured for synchronous-commit mode with automatic failover.</span></span>  
  
         <span data-ttu-id="d6cc5-232">**Настройка голосов кворума**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-232">**To adjust quorum votes**</span></span>  
  
        -   [<span data-ttu-id="d6cc5-233">Просмотр параметров NodeWeight кворума кластера</span><span class="sxs-lookup"><span data-stu-id="d6cc5-233">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
        -   [<span data-ttu-id="d6cc5-234">Настройка параметров NodeWeight для кворума кластера</span><span class="sxs-lookup"><span data-stu-id="d6cc5-234">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
        -   [<span data-ttu-id="d6cc5-235">Принудительный запуск кластера WSFC без кворума</span><span class="sxs-lookup"><span data-stu-id="d6cc5-235">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
    -   <span data-ttu-id="d6cc5-236">**Если отработка отказа выполнена за пределами [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)]** Рекомендуется регулировка режима доступности и отработки отказа на новой первичной реплике и на оставшихся вторичных репликах так, чтобы они соответствовали нужной конфигурации синхронной фиксации и автоматического перехода на другой ресурс.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-236">**If you failed over outside of the [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)]:** We recommend that you consider adjusting the availability mode and failover mode on the new primary replica and on remaining secondary replicas to reflect your desired synchronous-commit and automatic failover configuration.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="d6cc5-237">[!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] существует только в том случае, если текущая первичная реплика настроена для работы в режиме синхронной фиксации.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-237">A [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] exists only if the current primary replica is configured for synchronous-commit mode.</span></span>  
  
         <span data-ttu-id="d6cc5-238">**Изменение режима доступности и режима отработки отказа**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-238">**To change the availability mode and failover mode**</span></span>  
  
        -   [<span data-ttu-id="d6cc5-239">Смена режима доступности для реплики доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-239">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)  
  
        -   [<span data-ttu-id="d6cc5-240">Смена режима отработки отказа для реплики доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-240">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
2.  <span data-ttu-id="d6cc5-241">После принудительной отработки отказа приостанавливаются все базы данных-получатели.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-241">After a forced failover, all secondary databases are suspended.</span></span> <span data-ttu-id="d6cc5-242">Это относится к бывшим базам данных-источникам, для которых бывшая первичная реплика вновь переходит в режим «в сети» и обнаруживает, что отныне является вторичной репликой.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-242">This includes the former primary databases, after the former primary replica comes back online and discovers that it is now a secondary replica.</span></span> <span data-ttu-id="d6cc5-243">Необходимо вручную возобновить работу каждой приостановленной базы данных во вторичной реплике.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-243">You must manually resume each suspended database individually on each secondary replica.</span></span>  
  
     <span data-ttu-id="d6cc5-244">При возобновлении база данных-получатель инициирует синхронизацию данных с соответствующей базой данных-источником.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-244">When a secondary database is resumed, it initiates data synchronization with the corresponding primary database.</span></span> <span data-ttu-id="d6cc5-245">База данных-получатель откатывает все записи журнала, которые не были зафиксированы в новой базе данных-источнике. Поэтому во избежание потери данных в базах данных-источниках после отработки отказа следует попытаться создать моментальный снимок приостановленных баз данных в одной из баз данных-получателей с синхронной фиксацией.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-245">The secondary database rolls back any log records that were never committed on the new primary database.Therefore, if you are concerned about possible data loss on the post-failover primary databases, you should attempt to create a database snapshot on the suspended databases on one of the synchronous-commit secondary databases.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="d6cc5-246">Если хотя бы одна из баз данных-получателей приостановлена, усечение журнала транзакций в базе данных-источнике откладывается.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-246">Transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="d6cc5-247">Кроме того, во время приостановки любой локальной базы данных невозможен переход состояния вторичной реплики с синхронной фиксацией в HEALTHY.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-247">Also the synchronization health of a synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>  
  
     <span data-ttu-id="d6cc5-248">**Создание моментального снимка базы данных**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-248">**To create a database snapshot**</span></span>  
  
    -   [<span data-ttu-id="d6cc5-249">Создание моментального снимка базы данных (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-249">Create a Database Snapshot &#40;Transact-SQL&#41;</span></span>](../../../relational-databases/databases/create-a-database-snapshot-transact-sql.md)  
  
     <span data-ttu-id="d6cc5-250">**Возобновление базы данных доступности**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-250">**To resume an availability database**</span></span>  
  
    -   [<span data-ttu-id="d6cc5-251">Возобновление базы данных доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-251">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)  
  
    > [!CAUTION]  
    >  <span data-ttu-id="d6cc5-252">После восстановления всех баз данных-получателей перед повторной попыткой отработки отказа этой группы необходимо дождаться, пока все базы данных-получатели на следующей резервной группе будут переведены в состояние SYNCHRONIZING.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-252">After resuming all the secondary databases, before attempting to fail over the group again, wait for every secondary database on the next failover target to enter the SYNCHRONIZING state.</span></span> <span data-ttu-id="d6cc5-253">Если какая-либо база данных еще не находится в состоянии SYNCHRONIZING, эта база данных не сможет выйти в сеть в качестве базы данных-источника, а для восстановления синхронизации данных с ней может потребоваться восстановление журналов транзакций, полное резервное восстановление базы данных или откат к прежней первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-253">If any database is not yet SYNCHRONIZING, that database will be prevented from coming online as a primary database, and re-establishing data synchronization for the database might require restoring transaction logs, restoring a full database backup, or failing over back to the previous primary replica.</span></span>  
  
3.  <span data-ttu-id="d6cc5-254">Если реплика доступности, которая дала сбой, не вернется на место реплики доступности или вернется слишком поздно и усечение журнала транзакций для новой базы данных-источника будет задержано, рекомендуется удалить из группы доступности реплику, давшую сбой, чтобы избежать исчерпания места на диске для файлов журнала.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-254">If an availability replica that failed will not be returning to the availability replica or will return too late for you to delay transaction log truncation on the new primary database, consider removing the failed replica from the availability group to avoid running out of disk space for your log files.</span></span>  
  
     <span data-ttu-id="d6cc5-255">**Удаление вторичной реплики**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-255">**To remove a secondary replica**</span></span>  
  
    -   [<span data-ttu-id="d6cc5-256">Удаление вторичной реплики из группы доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-256">Remove a Secondary Replica from an Availability Group &#40;SQL Server&#41;</span></span>](remove-a-secondary-replica-from-an-availability-group-sql-server.md)  
  
4.  <span data-ttu-id="d6cc5-257">Если необходима принудительная отработка отказа с одной или несколькими дополнительными принудительными отработками отказа, выполняйте резервное копирование журналов после каждой дополнительной принудительной отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-257">If you follow a forced failover with one or more additional forced failovers, perform a log backup after each additional forced failover in the series.</span></span> <span data-ttu-id="d6cc5-258">Для того чтобы узнать, по каким причинам это необходимо, см. пункт "Риск использования принудительной отработки отказа" в разделе "Принудительный переход на другой ресурс вручную (с возможной потерей данных)" статьи [Отработка отказа и режимы отработки отказа (группы доступности AlwaysOn)](failover-and-failover-modes-always-on-availability-groups.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-258">For information about the reason for this, see "Risks of Forcing Failover" in the "Forced Manual Failover (with Possible Data Loss)" section of [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
     <span data-ttu-id="d6cc5-259">**Создание резервной копии журнала**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-259">**To perform a log backup**</span></span>  
  
    -   [<span data-ttu-id="d6cc5-260">Создание резервной копии журнала транзакций (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-260">Back Up a Transaction Log &#40;SQL Server&#41;</span></span>](../../../relational-databases/backup-restore/back-up-a-transaction-log-sql-server.md)  
  
##  <a name="example-scenario-using-a-forced-failover-to-recover-from-a-catastrophic-failure"></a><a name="ExampleRecoveryFromCatastrophy"></a> <span data-ttu-id="d6cc5-261">Пример сценария. Использование принудительной отработки отказа для восстановления после разрушительного сбоя</span><span class="sxs-lookup"><span data-stu-id="d6cc5-261">Example Scenario: Using a Forced Failover to Recover from a Catastrophic Failure</span></span>  
 <span data-ttu-id="d6cc5-262">В случае отказа первичной реплики при отсутствии синхронизированной вторичной реплики может оказаться целесообразной принудительная отработка отказа группы доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-262">If the primary replica fails and no synchronized secondary replica is available, forcing the availability group to fail over might be an appropriate response.</span></span> <span data-ttu-id="d6cc5-263">Целесообразность принудительной отработки отказа зависит от следующего: 1) ожидается ли остановка первичной реплики на время, превышающее допустимое время простоя в соглашении об уровне обслуживания (SLA), и 2) есть ли смысл рисковать возможной потерей данных для обеспечения быстрого доступа к базе данных-источнику.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-263">The appropriateness of forcing a failover depends on: (1) whether you expect the primary replica to be offline for longer than your service level agreement (SLA) tolerates, and (2) whether you are willing to risk potential data loss in order to make primary databases available quickly.</span></span> <span data-ttu-id="d6cc5-264">Если принято решение о принудительной отработке отказа группы доступности, сама принудительная отработка отказа является лишь одним этапом многошагового процесса.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-264">If you decide that an availability group requires a forced failover, the actual forced failover is but one step of a multi-step process.</span></span>  
  
 <span data-ttu-id="d6cc5-265">Для иллюстрации шагов, необходимых для восстановления после разрушительного сбоя с помощью принудительной отработки отказа, в данном разделе представлен один из возможных сценариев восстановления.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-265">To illustrate the steps that are required to use a forced failover to recover from a catastrophic failure, this topic presents one possible disaster recovery scenario.</span></span> <span data-ttu-id="d6cc5-266">Данный сценарий подразумевает наличие группы доступности, изначальная топология которой состоит из основного центра обработки данных, где размещены три реплики доступности с синхронной фиксацией (в том числе первичная реплика), и удаленного центра обработки данных, где размещены две вторичные реплики с асинхронной фиксацией.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-266">The example scenario considers an availability group whose original topology consists of a main data center that hosts three synchronous-commit availability replicas, including the primary replica, and a remote data center that hosts two asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="d6cc5-267">На следующем рисунке изображена изначальная топология группы доступности в данном примере:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-267">The following figure illustrates the original topology of this example availability group.</span></span> <span data-ttu-id="d6cc5-268">Группа доступности размещается в кластере WSFC со несколькими подсетями; три узла находятся в основном центре обработки данных (**Node 01**, **Node 02**и **Node 03**), и два узла в удаленном центре обработки данных (**Node 04** и **Node 05**).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-268">The availability group is hosted by a multi-subnet WSFC cluster with three nodes in the main data center (**Node 01**, **Node 02**, and **Node 03**) and two nodes in a remote data center (**Node 04** and **Node 05**).</span></span>  
  
 <span data-ttu-id="d6cc5-269">![Изначальная топология группы доступности](../../media/aoag-failurerecovery-origtopology.gif "Изначальная топология группы доступности")</span><span class="sxs-lookup"><span data-stu-id="d6cc5-269">![Original topology of availability group](../../media/aoag-failurerecovery-origtopology.gif "Original topology of availability group")</span></span>  
  
 <span data-ttu-id="d6cc5-270">Основной центр обработки данных неожиданно выключается.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-270">The main data center shuts down unexpectedly.</span></span> <span data-ttu-id="d6cc5-271">Находящиеся там три реплики доступности переходят в состояние «вне сети», соответствующие базы данных становятся недоступны.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-271">Its three availability replicas to go offline, and their databases become unavailable.</span></span> <span data-ttu-id="d6cc5-272">Влияние данного сбоя на топологию группы доступности показано на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-272">The following figure illustrates the impact of this failure on the topology of the availability group.</span></span>  
  
 <span data-ttu-id="d6cc5-273">![Топология после сбоя основного центра обработки данных](../../media/aoag-failurerecovery-catastrophy.gif "Топология после сбоя основного центра обработки данных")</span><span class="sxs-lookup"><span data-stu-id="d6cc5-273">![Topology after failure of main data center](../../media/aoag-failurerecovery-catastrophy.gif "Topology after failure of main data center")</span></span>  
  
 <span data-ttu-id="d6cc5-274">Администратор баз данных (DBA) принимает решение о принудительной отработке отказа группы доступности с использованием одной из удаленных вторичных реплик с асинхронной фиксацией.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-274">The database administrator (DBA) determines that the best possible response is to force failover of the availability group to one of the remote, asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="d6cc5-275">В данном примере приведены типичные шаги для принудительной отработки отказа с использованием удаленной реплики и последующего восстановления изначальной топологии группы доступности.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-275">This example illustrates the typical steps involved when you force failover of the availability group to a remote replica and, eventually, return the availability group to its original topology.</span></span>  
  
  
###  <a name="responding-to-the-catastrophic-failure-of-the-main-data-center"></a><a name="FailureResponse"></a> <span data-ttu-id="d6cc5-276">Responding to the Catastrophic Failure of the Main Data Center</span><span class="sxs-lookup"><span data-stu-id="d6cc5-276">Responding to the Catastrophic Failure of the Main Data Center</span></span>  
 <span data-ttu-id="d6cc5-277">На следующем рисунке показана последовательность действий, осуществляемых в удаленном центре обработки данных после разрушительного сбоя в основном центре обработки данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-277">The following figure illustrates the series of actions performed at the remote data center in response a catastrophic failure at the main data center.</span></span>  
  
 <span data-ttu-id="d6cc5-278">![Действия по обработке сбоя на основном центре обработки данных](../../media/aoag-failurerecovery-actions-part1.gif "Действия по обработке сбоя на основном центре обработки данных")</span><span class="sxs-lookup"><span data-stu-id="d6cc5-278">![Steps for responding to failure of main data cente](../../media/aoag-failurerecovery-actions-part1.gif "Steps for responding to failure of main data cente")</span></span>  
  
 <span data-ttu-id="d6cc5-279">На данном рисунке указаны следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-279">The steps in this figure indicate the following steps:</span></span>  
  
|<span data-ttu-id="d6cc5-280">Шаг</span><span class="sxs-lookup"><span data-stu-id="d6cc5-280">Step</span></span>|<span data-ttu-id="d6cc5-281">Действие</span><span class="sxs-lookup"><span data-stu-id="d6cc5-281">Action</span></span>|<span data-ttu-id="d6cc5-282">Ссылки</span><span class="sxs-lookup"><span data-stu-id="d6cc5-282">Links</span></span>|  
|----------|------------|-----------|  
|<span data-ttu-id="d6cc5-283">**1.**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-283">**1.**</span></span>|<span data-ttu-id="d6cc5-284">Администратор баз данных (DBA) или администратор локальной сети убеждается, что в кластере соблюдается кворум.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-284">The DBA or network administrator ensures that the WSFC cluster has a healthy quorum.</span></span> <span data-ttu-id="d6cc5-285">В данном примере необходим принудительный кворум.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-285">In this example, quorum needs to be forced.</span></span>|[<span data-ttu-id="d6cc5-286">Режим кворума и участвующая в голосовании конфигурация WSFC (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-286">WSFC Quorum Modes and Voting Configuration &#40;SQL Server&#41;</span></span>](../../../sql-server/failover-clusters/windows/wsfc-quorum-modes-and-voting-configuration-sql-server.md)<br /><br /> [<span data-ttu-id="d6cc5-287">Аварийное восстановление WSFC через принудительный кворум (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-287">WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;</span></span>](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)|  
|<span data-ttu-id="d6cc5-288">**2.**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-288">**2.**</span></span>|<span data-ttu-id="d6cc5-289">DBA подключается к экземпляру сервера с наименьшей задержкой ( **Node 04**) и осуществляет принудительный переход на другой ресурс вручную.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-289">The DBA connects to the server instance with the least latency (on **Node 04**) and performs a forced manual failover.</span></span> <span data-ttu-id="d6cc5-290">В результате принудительной отработки отказа эта вторичная реплика становится первичной, а базы данных-получатели в оставшейся вторичной реплике ( **Node 05**) приостанавливаются.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-290">The forced failover transitions this secondary replica to the primary role and suspends the secondary databases on the remaining secondary replica (on **Node 05**).</span></span>|<span data-ttu-id="d6cc5-291">[sys.dm_hadr_database_replica_states (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) (Запрос столбца **sys.dm_hadr_database_replica_states** .</span><span class="sxs-lookup"><span data-stu-id="d6cc5-291">[sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) (Query the **end_of_log_lsn** column.</span></span> <span data-ttu-id="d6cc5-292">Дополнительные сведения см. в подразделе [Рекомендации](#Recommendations)ранее в этом разделе.)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-292">For more information, see [Recommendations](#Recommendations), earlier in this topic.)</span></span>|  
|<span data-ttu-id="d6cc5-293">**3.**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-293">**3.**</span></span>|<span data-ttu-id="d6cc5-294">DBA вручную возобновляет работу каждой базы данных-получателя в оставшейся вторичной реплике.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-294">The DBA manually resumes each of the secondary databases on the remaining secondary replica.</span></span>|[<span data-ttu-id="d6cc5-295">Возобновление базы данных доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-295">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)|  
  
###  <a name="returning-the-availability-group-to-its-original-topology"></a><a name="ReturnToOrigTopology"></a> <span data-ttu-id="d6cc5-296">Восстановление изначальной топологии группы доступности</span><span class="sxs-lookup"><span data-stu-id="d6cc5-296">Returning the Availability Group to its Original Topology</span></span>  
 <span data-ttu-id="d6cc5-297">На следующем рисунке показана последовательность действий для восстановления изначальной топологии группы доступности после возобновления работы основного центра обработки данных и восстановления связи узлов WSFC с кластером WSFC.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-297">The following figure illustrates the series of actions that return the availability group to its original topology after the main data center comes back online and the WSFC nodes re-establish communication with the WSFC cluster.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="d6cc5-298">Если ранее в кластере WSFC был обеспечен принудительный кворум, вновь запускающиеся узлы могут сформировать новый кворум в случае одновременного соблюдения следующих двух условий: (a) отсутствует сетевая связь между любыми двумя узлами, участвовавшими в принудительном кворуме, и (б) вновь запускающиеся узлы составляют большинство из всех узлов кластера.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-298">If the WSFC cluster quorum has been forced, as the offline nodes restart they could form a new quorum if the following conditions both exist: (a) there is no network connectivity between any of the nodes in the forced-quorum set, and (b) the restarting nodes are the majority of the cluster nodes.</span></span> <span data-ttu-id="d6cc5-299">Это приведет к состоянию «двух голов», при котором в группе доступности появятся две независимые первичные реплики, каждая в своем центре обработки данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-299">This would result in a "split brain" condition in which the availability group would possess two independent primary replicas, one at each data center.</span></span> <span data-ttu-id="d6cc5-300">Прежде чем создавать кворумное меньшинство с помощью принудительного кворума, см. статью [Аварийное восстановление WSFC через принудительный кворум (SQL Server)](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="d6cc5-300">Before forcing quorum to create a minority quorum set, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span>  
  
 <span data-ttu-id="d6cc5-301">![Действия по восстановлению группы к ее изначальной топологии](../../media/aoag-failurerecovery-actions-part2.gif "Действия по восстановлению группы к ее изначальной топологии")</span><span class="sxs-lookup"><span data-stu-id="d6cc5-301">![Steps to return the group to its original topology](../../media/aoag-failurerecovery-actions-part2.gif "Steps to return the group to its original topology")</span></span>  
  
 <span data-ttu-id="d6cc5-302">На данном рисунке указаны следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-302">The steps in this figure indicate the following steps:</span></span>  
  
||<span data-ttu-id="d6cc5-303">Шаг</span><span class="sxs-lookup"><span data-stu-id="d6cc5-303">Step</span></span>|<span data-ttu-id="d6cc5-304">Ссылки</span><span class="sxs-lookup"><span data-stu-id="d6cc5-304">Links</span></span>|  
|-|----------|-----------|  
|<span data-ttu-id="d6cc5-305">**1.**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-305">**1.**</span></span>|<span data-ttu-id="d6cc5-306">Узлы в основном центре обработки данных вновь запускаются и восстанавливают связь с кластером WSFC.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-306">The nodes in the main data center come back online and re-establish communication with the WSFC cluster.</span></span> <span data-ttu-id="d6cc5-307">Их реплики доступности переходят в режим «в сети» в качестве вторичных реплик с приостановленными базами данных; DBA предстоит вручную возобновить работу каждой из этих баз данных.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-307">Their availability replicas come online as secondary replicas with suspended databases, and the DBA will need to manually resume each of these databases soon.</span></span>|[<span data-ttu-id="d6cc5-308">Возобновление базы данных доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-308">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)<br /><br /> <span data-ttu-id="d6cc5-309">Совет. Во избежание потери данных в базах данных, ставших источниками после отработки отказа, следует попытаться создать моментальный снимок приостановленных баз данных в одной из баз данных-получателей с синхронной фиксацией.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-309">Tip: If you are concerned about possible data loss on the post-failover primary databases, you should attempt to create a database snapshot on the suspended databases on one the synchronous-commit secondary database.</span></span> <span data-ttu-id="d6cc5-310">Следует помнить, что если хотя бы одна из баз данных-получателей приостановлена, усечение журнала транзакций в базе данных-источнике откладывается.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-310">Keep in mind that the transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="d6cc5-311">Кроме того, во время приостановки любой локальной базы данных невозможен переход состояния вторичной реплики с синхронной фиксацией в HEALTHY.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-311">Also the synchronization health of the synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>|  
|<span data-ttu-id="d6cc5-312">**2.**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-312">**2.**</span></span>|<span data-ttu-id="d6cc5-313">После возобновления работы баз данных DBA временно изменяет режим фиксации первичной реплики на синхронный.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-313">Once the databases are resumed, the DBA changes the new primary replica to synchronous-commit mode temporarily.</span></span> <span data-ttu-id="d6cc5-314">Данное действие состоит из следующих шагов:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-314">This involves two steps:</span></span><br /><br /> <span data-ttu-id="d6cc5-315">1) Изменение режима фиксации одной из реплик доступности в режиме "вне сети" на асинхронный.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-315">1) Change one offline availability replica to asynchronous-commit mode.</span></span> <br /><span data-ttu-id="d6cc5-316">2) Изменение режима фиксации новой первичной реплики на синхронный.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-316">2) Change the new primary replica to synchronous-commit mode.</span></span><br /><span data-ttu-id="d6cc5-317">Примечание. Данное действие позволяет базам данных-получателям с синхронной фиксацией перейти в состояние SYNCHRONIZED.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-317">Note: This step enables resumed synchronous-commit secondary databases to become SYNCHRONIZED.</span></span>|[<span data-ttu-id="d6cc5-318">Смена режима доступности для реплики доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-318">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)|  
|<span data-ttu-id="d6cc5-319">**3.**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-319">**3.**</span></span>|<span data-ttu-id="d6cc5-320">После перехода вторичной реплики с синхронной фиксацией на **Node 03** (изначальная первичная реплика) в состояние HEALTHY, DBA вручную осуществляет запланированную отработку отказа с использованием этой реплики, чтобы вновь сделать ее первичной.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-320">Once the synchronous-commit secondary replica on **Node 03** (the original primary replica) enters the HEALTHY synchronization state, the DBA performs a planned manual failover to that replica, to make it the primary replica again.</span></span> <span data-ttu-id="d6cc5-321">Реплика на узле **Node 04** вновь становится вторичной.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-321">The replica on **Node 04** returns to being a secondary replica.</span></span>|[<span data-ttu-id="d6cc5-322">sys.dm_hadr_database_replica_states (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-322">sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql)<br /><br /> [<span data-ttu-id="d6cc5-323">Используйте политики AlwaysOn для просмотра работоспособности группы доступности &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="d6cc5-323">Use AlwaysOn Policies to View the Health of an Availability Group &#40;SQL Server&#41;</span></span>](use-always-on-policies-to-view-the-health-of-an-availability-group-sql-server.md)<br /><br /> [<span data-ttu-id="d6cc5-324">Выполнение запланированного перехода на другой ресурс вручную для группы доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-324">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)|  
|<span data-ttu-id="d6cc5-325">**4.**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-325">**4.**</span></span>|<span data-ttu-id="d6cc5-326">DBA подключается к новой первичной реплике и делает следующее:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-326">The DBA connects to the new primary replica and:</span></span><br /><br /> <span data-ttu-id="d6cc5-327">1) Изменяет режим фиксации бывшей первичной реплики (в удаленном центре обработки данных) на асинхронный.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-327">1) Changes the former primary replica (in the remote center) back to asynchronous-commit mode.</span></span><br /><span data-ttu-id="d6cc5-328">2) Изменяет режим фиксации вторичной реплики в основном центре обработки данных обратно на синхронный.</span><span class="sxs-lookup"><span data-stu-id="d6cc5-328">2) Changes the asynchronous-commit secondary replica in the main data center back to synchronous-commit mode.</span></span>|[<span data-ttu-id="d6cc5-329">Смена режима доступности для реплики доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-329">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)|  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="d6cc5-330">Связанные задачи</span><span class="sxs-lookup"><span data-stu-id="d6cc5-330">Related Tasks</span></span>  
 <span data-ttu-id="d6cc5-331">**Настройка голосов кворума**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-331">**To adjust quorum votes**</span></span>  
  
-   [<span data-ttu-id="d6cc5-332">Просмотр параметров NodeWeight кворума кластера</span><span class="sxs-lookup"><span data-stu-id="d6cc5-332">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="d6cc5-333">Настройка параметров NodeWeight для кворума кластера</span><span class="sxs-lookup"><span data-stu-id="d6cc5-333">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="d6cc5-334">Принудительный запуск кластера WSFC без кворума</span><span class="sxs-lookup"><span data-stu-id="d6cc5-334">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
 <span data-ttu-id="d6cc5-335">**Запланированный переход на другой ресурс вручную:**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-335">**Planned manual failover:**</span></span>  
  
-   [<span data-ttu-id="d6cc5-336">Выполнение запланированного перехода на другой ресурс вручную для группы доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-336">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)  
  
-   [<span data-ttu-id="d6cc5-337">Использование мастера отработки отказа группы доступности (среда SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="d6cc5-337">Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;</span></span>](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md)  
  
 <span data-ttu-id="d6cc5-338">**Сведения для поиска и устранения неполадок**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-338">**To troubleshoot:**</span></span>  
  
-   [<span data-ttu-id="d6cc5-339">Устранение неполадок SQL Server &#40;конфигурации группы доступности AlwaysOn&#41;</span><span class="sxs-lookup"><span data-stu-id="d6cc5-339">Troubleshoot AlwaysOn Availability Groups Configuration &#40;SQL Server&#41;</span></span>](troubleshoot-always-on-availability-groups-configuration-sql-server.md) 
  
-   [<span data-ttu-id="d6cc5-340">Устранение неполадок при &#40;операции добавления файла группы доступности AlwaysOn&#41;</span><span class="sxs-lookup"><span data-stu-id="d6cc5-340">Troubleshoot a Failed Add-File Operation &#40;AlwaysOn Availability Groups&#41;</span></span>](troubleshoot-a-failed-add-file-operation-always-on-availability-groups.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="d6cc5-341">См. также</span><span class="sxs-lookup"><span data-stu-id="d6cc5-341">Related Content</span></span>  
  
-   <span data-ttu-id="d6cc5-342">**Блоги**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-342">**Blogs:**</span></span>  
  
     [<span data-ttu-id="d6cc5-343">Блоги команды разработчиков SQL Server AlwaysOn: официальный блог по SQL Server AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="d6cc5-343">SQL Server AlwaysOn Team Blogs: The official SQL Server AlwaysOn Team Blog</span></span>](https://blogs.msdn.com/b/sqlalwayson/)  
  
     [<span data-ttu-id="d6cc5-344">Блоги инженеров CSS SQL Server</span><span class="sxs-lookup"><span data-stu-id="d6cc5-344">CSS SQL Server Engineers Blogs</span></span>](https://blogs.msdn.com/b/psssql/)  
  
-   <span data-ttu-id="d6cc5-345">**Технические документы**</span><span class="sxs-lookup"><span data-stu-id="d6cc5-345">**Whitepapers:**</span></span>  
  
     [<span data-ttu-id="d6cc5-346">Руководство по решениям режима AlwaysOn в Microsoft SQL Server для обеспечения высокой доступности и аварийного восстановления</span><span class="sxs-lookup"><span data-stu-id="d6cc5-346">Microsoft SQL Server AlwaysOn Solutions Guide for High Availability and Disaster Recovery</span></span>](https://go.microsoft.com/fwlink/?LinkId=227600)  
  
     [<span data-ttu-id="d6cc5-347">Технические документы Майкрософт Microsoft по SQL Server 2012</span><span class="sxs-lookup"><span data-stu-id="d6cc5-347">Microsoft White Papers for SQL Server 2012</span></span>](https://msdn.microsoft.com/library/hh403491.aspx)  
  
     [<span data-ttu-id="d6cc5-348">Технические документы группы консультантов по SQL Server</span><span class="sxs-lookup"><span data-stu-id="d6cc5-348">SQL Server Customer Advisory Team Whitepapers</span></span>](http://sqlcat.com/)  
  
## <a name="see-also"></a><span data-ttu-id="d6cc5-349">См. также:</span><span class="sxs-lookup"><span data-stu-id="d6cc5-349">See Also</span></span>  
 <span data-ttu-id="d6cc5-350">[Общие сведения о группы доступности AlwaysOn &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="d6cc5-350">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="d6cc5-351">[Режимы доступности &#40;группы доступности AlwaysOn&#41;](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="d6cc5-351">[Availability Modes &#40;AlwaysOn Availability Groups&#41;](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="d6cc5-352">[Отказоустойчивость и режимы отработки отказа &#40;группы доступности AlwaysOn&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="d6cc5-352">[Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="d6cc5-353">[Сведения о доступе клиентского подключения к репликам доступности (SQL Server)](about-client-connection-access-to-availability-replicas-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="d6cc5-353">[About Client Connection Access to Availability Replicas &#40;SQL Server&#41;](about-client-connection-access-to-availability-replicas-sql-server.md) </span></span>  
 <span data-ttu-id="d6cc5-354">[Отслеживание групп доступности (SQL Server)](monitoring-of-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="d6cc5-354">[Monitoring of Availability Groups &#40;SQL Server&#41;](monitoring-of-availability-groups-sql-server.md) </span></span>  
 [<span data-ttu-id="d6cc5-355">Отказоустойчивая кластеризация Windows Server (WSFC) с SQL Server</span><span class="sxs-lookup"><span data-stu-id="d6cc5-355">Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server</span></span>](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md)  
  
  
