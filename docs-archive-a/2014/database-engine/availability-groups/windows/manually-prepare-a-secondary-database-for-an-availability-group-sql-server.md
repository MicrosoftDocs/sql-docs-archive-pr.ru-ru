---
title: Ручная подготовка базы данных-получателя для присоединения к группе доступности (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
f1_keywords:
- sql12.swb.availabilitygroup.configsecondarydbs.f1
- sql12.swb.availabilitygroup.preparedbs.f1
helpviewer_keywords:
- secondary databases [SQL Server], in availability group
- secondary databases [SQL Server]
- Availability Groups [SQL Server], configuring
- Availability Groups [SQL Server], databases
ms.assetid: 9f2feb3c-ea9b-4992-8202-2aeed4f9a6dd
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 3da3f7332bdabce65785b2844157dd4639389254
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87657902"
---
# <a name="manually-prepare-a-secondary-database-for-an-availability-group-sql-server"></a>Ручная подготовка базы данных-получателя для присоединения к группе доступности (SQL Server)
  В этом разделе описывается подготовка базы данных-получателя для группы доступности AlwaysOn в [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] при помощи среды [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)]или PowerShell. Подготовка базы данных-получателя выполняется в два этапа: (1) восстановление базы данных из последней резервной копии базы данных-источника и соответствующих резервных копий журнала на каждом экземпляре сервера, где размещена вторичная реплика доступности, с помощью инструкции RESTORE WITH NORECOVERY и (2) присоединение восстановленной базы данных к группе доступности.  
  
> [!TIP]  
>  Если имеется существующая конфигурация доставки журналов, можно будет преобразовать базу данных-источник доставки журналов вместе с одной или более базой данных-получателем в базу данных-источник AlwaysOn и одну или более баз данных-получателей AlwaysOn. Дополнительные сведения см. [в разделе Предварительные требования для миграции из доставки журналов в группы доступности AlwaysOn &#40;SQL Server&#41;](prereqs-migrating-log-shipping-to-always-on-availability-groups.md).  
  
-   **Перед началом работы**  
  
     [Требования и ограничения](#Prerequisites)  
  
     [Рекомендации](#Recommendations)  
  
     [Безопасность](#Security)  
  
-   **Подготовка базы данных-получателя с помощью различных средств.**  
  
     [Среда SQL Server Management Studio](#SSMSProcedure)  
  
     [Transact-SQL](#TsqlProcedure)  
  
     [PowerShell](#PowerShellProcedure)  
  
-   [Связанные задачи резервного копирования и восстановления](#RelatedTasks)  
  
-   **Дальнейшие действия.** [После подготовки базы данных-получателя](#FollowUp)  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> Перед началом  
  
###  <a name="prerequisites-and-restrictions"></a><a name="Prerequisites"></a> Требования и ограничения  
  
-   Убедитесь, что в системе, в которой предполагается разместить базу данных, есть жесткий диск, на котором достаточно свободного места для баз данных-получателей.  
  
-   Имя базы данных-получателя должно совпадать с именем базы данных-источника.  
  
-   Для каждой операции восстановления используйте инструкцию RESTORE WITH NORECOVERY.  
  
-   Если необходимо, чтобы путь к файлам базы данных-получателя отличался от пути к базе данных-источнику (в т. ч. буквой диска), в команду восстановления необходимо добавить параметр WITH MOVE для каждого файла базы данных, чтобы указать для них путь к базе данных-получателю.  
  
-   При восстановлении файловой группы базы данных по файловой группе следует восстановить базу данных целиком.  
  
-   После восстановления базы данных необходимо восстановить (с параметром WITH NORECOVERY) каждую резервную копию журнала, созданную с момента последнего восстановления данных из резервной копии.  
  
###  <a name="recommendations"></a><a name="Recommendations"></a> Рекомендации  
  
-   Для автономных экземпляров [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]рекомендуется, чтобы по возможности путь к файлам (в том числе буква диска) базы данных-получателя совпадал с путем к соответствующей базе данных-источнику. Такой подход рекомендуется, поскольку если при создании базы данных-получателя переместить ее файлы, то последующее добавление в нее файлов может завершиться ошибкой, в результате чего ее работа будет приостановлена.  
  
-   Перед подготовкой баз данных-получателей настоятельно рекомендуется приостановить резервное копирование журнала по расписанию для всех баз данных в группе доступности до завершения инициализации вторичных реплик.  
  
###  <a name="security"></a><a name="Security"></a> безопасность  
 При резервном копировании базы данных [свойство TRUSTWORTHY](../../../relational-databases/security/trustworthy-database-property.md) устанавливается в значение OFF. Поэтому свойство TRUSTWORTHY всегда имеет значение OFF во всех только что восстановленных базах данных.  
  
####  <a name="permissions"></a><a name="Permissions"></a> Permissions  
 Разрешения BACKUP DATABASE и BACKUP LOG назначены по умолчанию членам предопределенной роли сервера **sysadmin** и предопределенным ролям базы данных **db_owner** и **db_backupoperator** . Дополнительные сведения см. в разделе [BACKUP (Transact-SQL)](/sql/t-sql/statements/backup-transact-sql).  
  
 Если восстанавливаемая база данных не существует на нужном экземпляре сервера, для выполнения инструкции RESTORE требуются разрешения CREATE DATABASE. Дополнительные сведения см. в разделе [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql)невозможно.  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> Использование среды SQL Server Management Studio  
  
> [!NOTE]  
>   Если пути для файлов резервного копирования и восстановления на экземпляре сервера, размещающем первичную реплику, и на каждом экземпляре, на которых размещена вторичная реплика, идентичны, есть возможность создания баз данных-получателей с помощью [Мастера создания группы доступности](use-the-availability-group-wizard-sql-server-management-studio.md), [Мастер добавления реплики в группу доступности](use-the-add-replica-to-availability-group-wizard-sql-server-management-studio.md)или [Мастера добавления базы данных в группу доступности](availability-group-add-database-to-group-wizard.md).  
  
 **Подготовка базы данных-получателя**  
  
1.  Создайте новую полную или разностную резервную копию базы данных, если у вас еще нет недавней резервной копии базы данных-источника. Настоятельно рекомендуется поместить эту резервную копию и все последующие резервные копии журналов в указанную общую сетевую папку.  
  
2.  Создайте минимум одну новую резервную копию журнала базы данных-источника.  
  
3.  Выполните восстановление из полной резервной копии базы данных-источника на том экземпляре сервера, на котором размещена вторичная реплика (можно также восстановить разностную резервную копию), после чего восстановите все последующие резервные копии журнала.  
  
     На странице **Параметры RESTORE DATABASE** выберите параметр **Оставить базу данных в неработающем состоянии и не выполнять откат незафиксированных транзакций. Можно восстановить дополнительные журналы транзакций. (RESTORE WITH NORECOVERY)**.  
  
     Если пути к файлам базы данных-источника и базы данных-получателя отличаются, например если соответствующие основные базы данных находятся на диске «F:», но на экземпляре сервера, на котором размещена дополнительная реплика, нет диска «F:», используйте параметр MOVE в предложении WITH.  
  
4.  Чтобы завершить настройку базы данных-получателя, необходимо присоединить ее к группе доступности. Дополнительные сведения см. в разделе [Присоединение базы данных-получателя к группе доступности (SQL Server)](join-a-secondary-database-to-an-availability-group-sql-server.md).  
  
> [!NOTE]  
>   Дополнительные сведения о выполнении этих операций резервного копирования и восстановления см. в подразделе [Связанные задачи резервного копирования и восстановления](#RelatedTasks)далее в этом разделе.  
  
###  <a name="related-backup-and-restore-tasks"></a><a name="RelatedTasks"></a>Связанные задачи резервного копирования и восстановления  
 **Создание резервной копии базы данных**  
  
-   [Создание полной резервной копии базы данных (SQL Server)](../../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md)  
  
-   [Создание разностной резервной копии базы данных (SQL Server)](../../../relational-databases/backup-restore/create-a-differential-database-backup-sql-server.md)  
  
 **Создание резервной копии журнала**  
  
-   [Создание резервной копии журнала транзакций (SQL Server)](../../../relational-databases/backup-restore/back-up-a-transaction-log-sql-server.md)  
  
 **Восстановление резервных копий**  
  
-   [Восстановление резервной копии базы данных &#40;SQL Server Management Studio&#41;](../../../relational-databases/backup-restore/restore-a-database-backup-using-ssms.md)  
  
-   [Восстановление разностной резервной копии базы данных (SQL Server)](../../../relational-databases/backup-restore/restore-a-differential-database-backup-sql-server.md)  
  
-   [Восстановление резервной копии журнала транзакций (SQL Server)](../../../relational-databases/backup-restore/restore-a-transaction-log-backup-sql-server.md)  
  
-   [Восстановление базы данных в новом расположении (SQL Server)](../../../relational-databases/backup-restore/restore-a-database-to-a-new-location-sql-server.md)  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> Использование Transact-SQL  
 **Подготовка базы данных-получателя**  
  
> [!NOTE]  
>  Пример этой процедуры см. в подразделе [Пример (Transact-SQL)](#ExampleTsql)ранее в этом разделе.  
  
1.  Если у вас нет недавней полной резервной копии базы данных-источника, выполните подключение к экземпляру сервера, на котором размещена первичная реплика, и создайте полную резервную копию базы данных. Настоятельно рекомендуется поместить эту резервную копию и все последующие резервные копии журналов в указанную общую сетевую папку.  
  
2.  В экземпляре сервера, на котором размещена вторичная реплика доступности, выполните восстановление из полной резервной копии базы данных-источника (также можно восстановить и разностную копию), после чего восстановите последующие копии журнала. Для каждой операции восстановления используйте параметр WITH NORECOVERY.  
  
     Если пути к файлам базы данных-источника и базы данных-получателя отличаются, например если соответствующие основные базы данных находятся на диске «F:», но на экземпляре сервера, на котором размещена дополнительная реплика, нет диска «F:», используйте параметр MOVE в предложении WITH.  
  
3.  Если с момента последнего обязательного резервного копирования журнала было выполнено резервное копирование журнала базы данных-источника, эти копии также необходимо скопировать на тот экземпляр сервера, на котором размещена вторичная реплика, и применить все эти резервные копии журнала к базе данных-получателю, начиная с самой ранней. При этом необходимо всегда использовать инструкцию RESTORE WITH NORECOVERY.  
  
    > [!NOTE]  
    >  Резервной копии журнала может не быть в том случае, если база данных-источник только что создана и в ней еще не было создано ни одной резервной копии журналов либо если модель восстановления только что изменена с SIMPLE на FULL.  
  
4.  Чтобы завершить настройку базы данных-получателя, необходимо присоединить ее к группе доступности. Дополнительные сведения см. в разделе [Присоединение базы данных-получателя к группе доступности (SQL Server)](join-a-secondary-database-to-an-availability-group-sql-server.md).  
  
> [!NOTE]  
>   Дополнительные сведения о выполнении этих операций резервного копирования и восстановления см. в подразделе [Связанные задачи резервного копирования и восстановления](#RelatedTasks)далее в этом разделе.  
  
###  <a name="transact-sql-example"></a><a name="ExampleTsql"></a>Пример Transact-SQL  
 В следующем примере показана подготовка базы данных-получателя. В этом примере используется образец базы данных [!INCLUDE[ssSampleDBobject](../../../includes/sssampledbobject-md.md)] , в котором по умолчанию применяется простая модель восстановления.  
  
1.  Чтобы использовать базу данных [!INCLUDE[ssSampleDBobject](../../../includes/sssampledbobject-md.md)] , следует ее изменить так, чтобы использовалась модель полного восстановления:  
  
    ```sql
    USE master;  
    GO  
    ALTER DATABASE MyDB1   
    SET RECOVERY FULL;  
    GO  
    ```  
  
2.  После изменения модели восстановления с SIMPLE на FULL создайте полную резервную копию, с помощью которой затем можно будет создать базу данных-получатель. Так как модель восстановления только что была изменена, указывается параметр WITH FORMAT для создания нового набора носителей. Это полезно для отделения резервных копий при модели полного восстановления от резервных копий, сделанных при простой модели восстановления. В данном примере файл резервной копии (C:\\[!INCLUDE[ssSampleDBobject](../../../includes/sssampledbobject-md.md)].bak) создается на том же диске, что и база данных.  
  
    > [!NOTE]  
    >  Для производственной базы данных необходимо всегда делать резервные копии на разные устройства.  
  
     На экземпляре сервера, на котором размещена основная реплика (`INSTANCE01`), создайте полную резервную копию базы данных-источника, выполнив следующие действия.  
  
    ```sql
    BACKUP DATABASE MyDB1   
        TO DISK = 'C:\MyDB1.bak'   
        WITH FORMAT  
    GO  
    ```  
  
3.  Скопируйте полную резервную копию на экземпляр сервера, на котором размещается вторичная реплика.  
  
4.  На сервере, на котором размещена вторичная реплика, восстановите полную резервную копию с помощью инструкции RESTORE WITH NORECOVERY. Команда восстановления зависит от того, идентичны ли пути к базе данных-источнику и базе данных-получателю.  
  
    -   **Если пути идентичны:**  
  
         На компьютере, на котором размещена вторичная реплика, выполните восстановление полной резервной копии следующим образом.  
  
        ```sql
        RESTORE DATABASE MyDB1   
            FROM DISK = 'C:\MyDB1.bak'   
            WITH NORECOVERY  
        GO  
        ```  
  
    -   **Если пути отличаются:**  
  
         Если путь к базе данных-получателю отличается от пути к базе данных-источнику (например, отличаются имена дисков), то для создания базы данных-получателя в операцию восстановления нужно будет добавить предложение MOVE.  
  
        > [!IMPORTANT]  
        >  Если пути к базе данных-источнику и базе данных-получателю отличаются, то добавлять файлы нельзя. Обусловлено это тем, что при получении журнала для выполнения операции добавления файла экземпляр сервера, на котором размещена вторичная реплика, пытается поместить новый файл в местоположение, указанное для базы данных-источника.  
  
         Например, следующая команда восстанавливает базу данных-источник из резервной копии, размещенной в каталоге данных экземпляра [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)]по умолчанию, C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA. Операция восстановления базы данных должна переместить базу данных в каталог данных удаленного экземпляра [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] с именем (*AlwaysOn1*), на котором размещается вторичная реплика на другом узле кластера. Там файлы данных и журналов восстанавливаются в папку *C:\Program FILES\MICROSOFT SQL Server\MSSQL12. Каталог ALWAYSON1\MSSQL\DATA* . Операция восстановления использует параметр WITH NORECOVERY, чтобы оставить базу данных-получатель в восстанавливающейся базе данных.  
  
        ```sql
        RESTORE DATABASE MyDB1  
          FROM DISK='C:\MyDB1.bak'  
         WITH NORECOVERY,   
            MOVE 'MyDB1_Data' TO   
             'C:\Program Files\Microsoft SQL Server\MSSQL12.ALWAYSON1\MSSQL\DATA\MyDB1_Data.mdf',   
            MOVE 'MyDB1_Log' TO  
             'C:\Program Files\Microsoft SQL Server\MSSQL12.ALWAYSON1\MSSQL\DATA\MyDB1_Data.ldf';  
        GO  
        ```  
  
5.  После того как полная резервная копия базы данных будет восстановлена, необходимо создать резервную копию журнала базы данных-источника. Например, следующая инструкция [!INCLUDE[tsql](../../../includes/tsql-md.md)] выполняет резервное копирование журнала в файл резервной копии с именем *E:\MyDB1_log.bak*:  
  
    ```sql
    BACKUP LOG MyDB1   
      TO DISK = 'E:\MyDB1_log.bak'   
    GO  
    ```  
  
6.  Перед присоединением базы данных к вторичной реплике необходимо применить эту обязательную резервную копию журнала (и все последующие резервные копии журнала).  
  
     Например, следующая инструкция [!INCLUDE[tsql](../../../includes/tsql-md.md)] восстанавливает первый журнал из файла *C:\MyDB1.bak*:  
  
    ```sql
    RESTORE LOG MyDB1   
      FROM DISK = 'E:\MyDB1_log.bak'   
        WITH FILE=1, NORECOVERY  
    GO  
    ```  
  
7.  Если перед присоединением базы данных-получателя будут созданы любые дополнительные резервные копии журнала, необходимо будет последовательно восстановить все эти резервные копии журналов на том экземпляре сервера, на котором размещена вторичная реплика. При этом необходимо использовать инструкцию RESTORE WITH NORECOVERY.  
  
     Например, следующая инструкция [!INCLUDE[tsql](../../../includes/tsql-md.md)] восстанавливает два дополнительных журнала из файла *E:\MyDB1_log.bak*:  
  
    ```sql
    RESTORE LOG MyDB1   
      FROM DISK = 'E:\MyDB1_log.bak'   
        WITH FILE=2, NORECOVERY  
    GO  
    RESTORE LOG MyDB1   
      FROM DISK = 'E:\MyDB1_log.bak'   
        WITH FILE=3, NORECOVERY  
    GO  
    ```  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> Использование PowerShell  
 **Подготовка базы данных-получателя**  
  
1.  В случае если резервная копия базы данных-источника отсутствует и вы создаете ее самостоятельно, перейдите в каталог (`cd`) экземпляра сервера, на котором размещена первичная реплика.  
  
2.  Используйте командлет `Backup-SqlDatabase`, чтобы создать каждую их этих резервных копий.  
  
3.  Перейдите в каталог (`cd`) экземпляра сервера, на котором размещается вторичная реплика.  
  
4.  Чтобы восстановить резервные копии базы данных и журналов для каждой базы данных-источника, используйте командлет `restore-SqlDatabase`, указывая параметр восстановления `NoRecovery`. Если пути к файлам различны на компьютерах, на которых размещена основная реплика и целевая вторичная реплика, также следует использовать параметр восстановления `RelocateFile`.  
  
    > [!NOTE]  
    >  Чтобы просмотреть синтаксис командлета, воспользуйтесь командлетом `Get-Help` в среде [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell. Дополнительные сведения см. в разделе [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).  
  
5.  Чтобы завершить настройку базы данных-получателя, необходимо присоединить ее к группе доступности. Дополнительные сведения см. в разделе [Присоединение базы данных-получателя к группе доступности (SQL Server)](join-a-secondary-database-to-an-availability-group-sql-server.md).  
  
 **Настройка и использование поставщика SQL Server PowerShell**  
  
-   [Поставщик SQL Server PowerShell](../../../powershell/sql-server-powershell-provider.md)  
  
###  <a name="sample-backup-and-restore-script-and-command"></a><a name="ExamplePSscript"></a>Пример сценария и команды резервного копирования и восстановления  
 Следующие команды PowerShell создают полную резервную копию базы данных и журнала транзакций в общей сетевой папке и восстанавливают базу данных из этой папки. В этом примере предполагается, что путь к файлам, в которые выполняется восстановление базы данных, такой же, как и путь к файлам базы данных, резервная копия которых была создана.  
  
```powershell
# Create database backup  
Backup-SqlDatabase -Database "MyDB1" -BackupFile "\\share\backups\MyDB1.bak" -ServerInstance "SourceMachine\Instance"  
# Create log backup  
Backup-SqlDatabase -Database "MyDB1" -BackupAction "Log" -BackupFile "\\share\backups\MyDB1.trn" -ServerInstance "SourceMachine\Instance"  
# Restore database backup
Restore-SqlDatabase -Database "MyDB1" -BackupFile "\\share\backups\MyDB1.bak" -NoRecovery -ServerInstance "DestinationMachine\Instance"  
# Restore log backup
Restore-SqlDatabase -Database "MyDB1" -BackupFile "\\share\backups\MyDB1.trn" -RestoreAction "Log" -NoRecovery -ServerInstance "DestinationMachine\Instance"
```  
  
##  <a name="follow-up-after-preparing-a-secondary-database"></a><a name="FollowUp"></a>Дальнейшие действия. После подготовки базы данных-получателя  
 Чтобы завершить настройку базы данных-получателя, необходимо присоединить только что восстановленную базу данных к группе доступности. Дополнительные сведения см. в статье [Присоединение базы данных-получателя к группе доступности (SQL Server)](join-a-secondary-database-to-an-availability-group-sql-server.md).  
  
## <a name="see-also"></a>См. также:  
 [Общие сведения о группы доступности AlwaysOn &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md)   
 [BACKUP (Transact-SQL)](/sql/t-sql/statements/backup-transact-sql)   
 [Аргументы инструкции RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-arguments-transact-sql)   
 [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql)   
 [Устранение неполадок при &#40;операции добавления файла группы доступности AlwaysOn&#41;](troubleshoot-a-failed-add-file-operation-always-on-availability-groups.md)  
