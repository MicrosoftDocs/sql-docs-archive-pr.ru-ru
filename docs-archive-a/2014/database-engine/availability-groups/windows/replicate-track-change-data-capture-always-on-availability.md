---
title: Репликация, Отслеживание изменений, система отслеживания измененных данных и группы доступности AlwaysOn (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- change tracking [SQL Server], AlwaysOn Availability Groups
- change data capture [SQL Server], AlwaysOn Availability Groups
- Availability Groups [SQL Server], interoperability
- replication [SQL Server], AlwaysOn Availability Groups
ms.assetid: e17a9ca9-dd96-4f84-a85d-60f590da96ad
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e8ea6257cb906177b9eb224d718eecf54fb94119
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87657308"
---
# <a name="replication-change-tracking-change-data-capture-and-alwayson-availability-groups-sql-server"></a><span data-ttu-id="77a8d-102">Репликация, отслеживание изменений, изменение данных и группы доступности AlwaysOn (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="77a8d-102">Replication, Change Tracking, Change Data Capture, and AlwaysOn Availability Groups (SQL Server)</span></span>
  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="77a8d-103">Репликация, отслеживание измененных данных (CDC) и отслеживание изменений (CT) поддерживаются в [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span><span class="sxs-lookup"><span data-stu-id="77a8d-103">Replication, change data capture (CDC), and change tracking (CT) are supported on [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] <span data-ttu-id="77a8d-104">помогает обеспечивать высокий уровень доступности и дополнительные возможности восстановления баз данных.</span><span class="sxs-lookup"><span data-stu-id="77a8d-104">helps provide high availability and additional database recovery capabilities.</span></span>  
  
 
  
##  <a name="overview-of-replication-on-alwayson-availability-groups"></a><a name="Overview"></a><span data-ttu-id="77a8d-105">Общие сведения о репликации на группы доступности AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="77a8d-105">Overview of Replication on AlwaysOn Availability Groups</span></span>  
  
###  <a name="publisher-redirection"></a><a name="PublisherRedirect"></a> <span data-ttu-id="77a8d-106">Перенаправление издателя</span><span class="sxs-lookup"><span data-stu-id="77a8d-106">Publisher Redirection</span></span>  
 <span data-ttu-id="77a8d-107">Если опубликованная база данных умеет работать в режиме [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], то распространитель, который предоставляет агенту доступ к базе данных публикации, настраивается с помощью записей redirected_publishers.</span><span class="sxs-lookup"><span data-stu-id="77a8d-107">When a published database is aware of [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], the distributor that provides agent access to the publishing database is configured with redirected_publishers entries.</span></span> <span data-ttu-id="77a8d-108">Эти записи перенаправляют первоначально настроенные пары «издатель-база данных», позволяя при соединении издателя с базой данных публикации указывать имя прослушивателя группы доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-108">These entries redirect the originally configured publisher/database pair, making use of an availability group listener name to connect to the publisher and publishing database.</span></span> <span data-ttu-id="77a8d-109">Соединения, установленные по именам прослушивателей группы доступности, будут разорваны при отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="77a8d-109">Established connections through the availability group listener name will fail on failover.</span></span> <span data-ttu-id="77a8d-110">Но после перезапуска агента репликации и отработки отказа соединение будет автоматически перенаправлено на новую базу данных-источник.</span><span class="sxs-lookup"><span data-stu-id="77a8d-110">When the replication agent restarts after failover, the connection will automatically be redirected to the new primary.</span></span>  
  
 <span data-ttu-id="77a8d-111">В группе доступности AlwaysOn база данных-получатель не может быть издателем.</span><span class="sxs-lookup"><span data-stu-id="77a8d-111">In an AlwaysOn availability group a secondary database cannot be a publisher.</span></span> <span data-ttu-id="77a8d-112">Повторная публикация не поддерживается, если репликация сочетается с [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span><span class="sxs-lookup"><span data-stu-id="77a8d-112">Republishing is not supported when replication is combined with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span>  
  
 <span data-ttu-id="77a8d-113">Если опубликованная база данных является членом группы доступности, а издатель перенаправляется, то он должен перенаправляться на имя прослушивателя группы доступности, связанное с группой доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-113">If a published database is a member of an availability group and the publisher is redirected, it must be redirected to an availability group listener name associated with the availability group.</span></span> <span data-ttu-id="77a8d-114">Он не может быть перенаправлен на отдельный узел.</span><span class="sxs-lookup"><span data-stu-id="77a8d-114">It may not be redirected to an explicit node.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="77a8d-115">После отработки отказа на вторичной реплике монитор репликации не сможет изменить имя экземпляра публикации [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] и будет продолжать отображать сведения о репликации по имени исходного первичного экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="77a8d-115">After failover to a secondary replica, Replication Monitor is unable to adjust the name of the publishing instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and will continue to display replication information under the name of the original primary instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="77a8d-116">После отработки отказа нельзя ввести трассировочный токен с помощью монитора репликации, но трассировочный токен, введенный в новый издатель с помощью [!INCLUDE[tsql](../../../includes/tsql-md.md)], отображается в мониторе репликации.</span><span class="sxs-lookup"><span data-stu-id="77a8d-116">After failover, a tracer token cannot be entered by using the Replication Monitor, however a tracer token entered on the new publisher by using [!INCLUDE[tsql](../../../includes/tsql-md.md)], is visible in Replication Monitor.</span></span>  
  
###  <a name="general-changes-to-replication-agents-to-support-alwayson-availability-groups"></a><a name="Changes"></a><span data-ttu-id="77a8d-117">Общие изменения в агентах репликации для поддержки группы доступности AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="77a8d-117">General Changes to Replication Agents to Support AlwaysOn Availability Groups</span></span>  
 <span data-ttu-id="77a8d-118">Для поддержки [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]были внесены изменения в три агента репликации.</span><span class="sxs-lookup"><span data-stu-id="77a8d-118">Three replication agents were modified to support [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="77a8d-119">Агенты средства чтения журналов, моментального снимка и слияния теперь опрашивают базу данных распространителя на наличие перенаправленного издателя и используют возвращенное имя прослушивателя группы доступности, если был объявлен перенаправленный издатель, для соединения с издателем базы данных.</span><span class="sxs-lookup"><span data-stu-id="77a8d-119">The Log Reader, Snapshot, and Merge agents were modified to query the distribution database for the redirected publisher and to use the returned availability group listener name, if a redirected publisher was declared, to connect to the database publisher.</span></span>  
  
 <span data-ttu-id="77a8d-120">Если по умолчанию агенты направляют запрос к распространителю, чтобы определить, был ли перенаправлен исходный издатель, то соответствие текущей цели или перенаправления будет проверено до возврата перенаправленного сервера агенту.</span><span class="sxs-lookup"><span data-stu-id="77a8d-120">By default, when the agents query the distributor to determine whether the original publisher has been redirected, the suitability of the current target or redirection will be verified prior to returning the redirected host to the agent.</span></span> <span data-ttu-id="77a8d-121">Рекомендуется пользоваться этим режимом.</span><span class="sxs-lookup"><span data-stu-id="77a8d-121">This is recommended behavior.</span></span> <span data-ttu-id="77a8d-122">Но если запуск агента происходит слишком часто, то нагрузка, связанная с хранимой процедурой проверки, может занимать слишком много ресурсов.</span><span class="sxs-lookup"><span data-stu-id="77a8d-122">However, if agent start up occurs very frequently the overhead associated with the validation stored procedure may be deemed too costly.</span></span> <span data-ttu-id="77a8d-123">В агенты чтения журнала, моментальных снимков и слияния был добавлен новый параметр командной строки *BypassPublisherValidation*.</span><span class="sxs-lookup"><span data-stu-id="77a8d-123">A new command line switch, *BypassPublisherValidation*, has been added to the Logreader, Snapshot, and Merge agents.</span></span> <span data-ttu-id="77a8d-124">Если указан этот параметр, то перенаправляемый издатель сразу возвращается агенту, при этом хранимая процедура проверки не выполняется.</span><span class="sxs-lookup"><span data-stu-id="77a8d-124">When the switch is used, the redirected publisher is returned immediately to the agent and execution of the validation stored procedure is bypassed.</span></span>  
  
 <span data-ttu-id="77a8d-125">Ошибки, возвращаемые хранимыми процедурами проверки, записываются в журналы агента.</span><span class="sxs-lookup"><span data-stu-id="77a8d-125">Failures returned from the validation stored procedure are logged in the agent history logs.</span></span> <span data-ttu-id="77a8d-126">Ошибки с уровнем серьезности 16 и выше приводят к прекращению работы агента.</span><span class="sxs-lookup"><span data-stu-id="77a8d-126">Those errors with severity greater than or equal to 16 will cause the agents to terminate.</span></span> <span data-ttu-id="77a8d-127">Агенты имеют специальное средство повтора, которое позволяет им обрабатывать отключение от опубликованной базы данных, когда она перемещается на новый первичный источник.</span><span class="sxs-lookup"><span data-stu-id="77a8d-127">Some retry capabilities have been built in to the agents to handle the expected disconnect from a published database when it fails over to a new primary.</span></span>  
  
#### <a name="log-reader-agent-modifications"></a><span data-ttu-id="77a8d-128">Изменения в агенте чтения журнала</span><span class="sxs-lookup"><span data-stu-id="77a8d-128">Log Reader Agent Modifications</span></span>  
 <span data-ttu-id="77a8d-129">В агент чтения журналов внесены следующие изменения.</span><span class="sxs-lookup"><span data-stu-id="77a8d-129">The Logreader Agent has the following changes.</span></span>  
  
-   <span data-ttu-id="77a8d-130">**Согласованность реплицированной базы данных**</span><span class="sxs-lookup"><span data-stu-id="77a8d-130">**Replicated Database Consistency**</span></span>  
  
     <span data-ttu-id="77a8d-131">Когда опубликованная база данных является членом группы доступности AlwaysOn, средство чтения журналов по умолчанию не будет обрабатывать записи журнала, которые еще не были записаны на диск во всех вторичных репликах группы доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-131">When a published database is a member of an AlwaysOn availability group, by default the log reader will not process log records that have not already been hardened at all availability group secondary replicas.</span></span> <span data-ttu-id="77a8d-132">Это гарантирует, что при отработке отказа все строки, реплицированные на подписчик, также будут присутствовать в новой базе данных-источнике.</span><span class="sxs-lookup"><span data-stu-id="77a8d-132">This insures that on failover, all rows replicated to a subscriber also are present at the new primary.</span></span>  
  
     <span data-ttu-id="77a8d-133">Если у издателя есть только две реплики доступности в состоянии AlwaysOn (одна первичная и одна вторичная) и происходит отработка отказа, то изначальная первичная реплика останется в отключенном состоянии, так как модуль чтения журналов не продвинется вперед до тех пор, пока все базы данных-получатели не будут вновь в сети или отказавшие вторичные реплики не будут удалены из группы доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-133">When the publisher has only two AlwaysOn availability replicas (one primary and one secondary) and a failover happens, the original primary replica remains down because the logreader does not move forward until all secondary databases are brought back online or until the failing secondary replicas are removed from the availability group.</span></span> <span data-ttu-id="77a8d-134">Модуль чтения журналов, работающий теперь со вторичной базой данных, не будет продвигаться вперед, так как состояние AlwaysOn не может фиксировать изменения в базе данных-получателе.</span><span class="sxs-lookup"><span data-stu-id="77a8d-134">The logreader, now running against the secondary database, will not proceed forward since AlwaysOn cannot harden any changes to any secondary database.</span></span> <span data-ttu-id="77a8d-135">Чтобы позволить модулю чтения журналов продвинуться вперед и сохранить возможность аварийного восстановления, удалите изначальную первичную реплику из группы доступности с помощью инструкции ALTER AVAILABITY GROUP <имя_группы> REMOVE REPLICA.</span><span class="sxs-lookup"><span data-stu-id="77a8d-135">To allow the logreader to proceed further and still have disaster recovery capacity, remove the original primary replica from the availability group using ALTER AVAILABITY GROUP <group_name> REMOVE REPLICA.</span></span> <span data-ttu-id="77a8d-136">Затем добавьте новую вторичную реплику к группе доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-136">Then add a new secondary replica to the availability group.</span></span>  
  
-   <span data-ttu-id="77a8d-137">**Флаг трассировки 1448**</span><span class="sxs-lookup"><span data-stu-id="77a8d-137">**Trace flag 1448**</span></span>  
  
     <span data-ttu-id="77a8d-138">Флаг трассировки 1448 разрешает средству чтения журнала репликации перемещаться вперед даже в том случае, если асинхронные вторичные реплики не подтвердили получение изменения.</span><span class="sxs-lookup"><span data-stu-id="77a8d-138">Trace flag 1448 enables the replication log reader to move forward even if the asynchronous secondary replicas have not acknowledged the reception of a change.</span></span> <span data-ttu-id="77a8d-139">Средство чтения журнала всегда ожидает синхронные вторичные реплики, даже если установлен флаг трассировки.</span><span class="sxs-lookup"><span data-stu-id="77a8d-139">Even with this trace flag enabled,, the log reader always waits for the synchronous secondary replicas.</span></span> <span data-ttu-id="77a8d-140">Средство чтения журнала не будет превышать минимальное время ожидания для синхронных вторичных реплик.</span><span class="sxs-lookup"><span data-stu-id="77a8d-140">The log reader will not go beyond the min ack of the synchronous secondary replicas.</span></span> <span data-ttu-id="77a8d-141">Флаг трассировки применяется к экземпляру [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], а не только к группе доступности, базе данных доступности или экземпляру средства чтения журнала.</span><span class="sxs-lookup"><span data-stu-id="77a8d-141">This trace flag applies to the instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], not just to an availability group, an availability database, or a log reader instance.</span></span> <span data-ttu-id="77a8d-142">Этот флаг трассировки вступает в силу немедленно, без перезагрузки.</span><span class="sxs-lookup"><span data-stu-id="77a8d-142">This trace flag takes effect immediately without a restart.</span></span> <span data-ttu-id="77a8d-143">Он не может быть активирован раньше времени или при сбое асинхронной вторичной реплики.</span><span class="sxs-lookup"><span data-stu-id="77a8d-143">It can be activated ahead of time or when an asynchronous secondary replica fails.</span></span>  
  
###  <a name="stored-procedures-supporting-alwayson"></a><a name="StoredProcs"></a><span data-ttu-id="77a8d-144">Хранимые процедуры, поддерживающие AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="77a8d-144">Stored Procedures Supporting AlwaysOn</span></span>  
  
-   <span data-ttu-id="77a8d-145">**sp_redirect_publisher**</span><span class="sxs-lookup"><span data-stu-id="77a8d-145">**sp_redirect_publisher**</span></span>  
  
     <span data-ttu-id="77a8d-146">Хранимая процедура **sp_redirect_publisher** служит для указания перенаправленного издателя для существующей пары "издатель-база данных".</span><span class="sxs-lookup"><span data-stu-id="77a8d-146">The stored procedure **sp_redirect_publisher** is used to specify a redirected publisher for an existing publisher/database pair.</span></span> <span data-ttu-id="77a8d-147">Если база данных издателя входит в группу доступности, то перенаправленный издатель — это имя прослушивателя группы доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-147">If the publisher database belongs to an availability group, the redirected publisher is the availability group listener name.</span></span>  
  
-   <span data-ttu-id="77a8d-148">**sp_get_redirected_publisher**</span><span class="sxs-lookup"><span data-stu-id="77a8d-148">**sp_get_redirected_publisher**</span></span>  
  
     <span data-ttu-id="77a8d-149">Хранимая процедура **sp_get_redirected_publisher** используется агентами репликации для опроса распространителя и определения наличия для пары "издатель-база данных" заданного перенаправленного издателя.</span><span class="sxs-lookup"><span data-stu-id="77a8d-149">The stored procedure **sp_get_redirected_publisher** is used by replication agents to query a distributor to determine whether a publisher/database pair has a defined redirected publisher.</span></span> <span data-ttu-id="77a8d-150">Эта хранимая процедура служит двум целям.</span><span class="sxs-lookup"><span data-stu-id="77a8d-150">This stored procedure serves two purposes.</span></span> <span data-ttu-id="77a8d-151">Во-первых, она позволяет агенту определить, был ли перенаправлен исходный издатель.</span><span class="sxs-lookup"><span data-stu-id="77a8d-151">First, it allows the agent to determine whether the original publisher has been redirected.</span></span> <span data-ttu-id="77a8d-152">Во-вторых, она может также инициировать вызов хранимой процедуры проверки на распространителе (**sp_validate_redirected_publisher**), которая выполняет проверку пригодности целевого узла перенаправления для использования в качестве издателя указанной базы данных.</span><span class="sxs-lookup"><span data-stu-id="77a8d-152">Second, it may also initiate a validation stored procedure run at the distributor (**sp_validate_redirected_publisher**) that verifies the suitability of the target node of the redirection to serve as a publisher for the named database.</span></span>  
  
     <span data-ttu-id="77a8d-153">Для выполнения этой хранимой процедуры необходимо членство в роли сервера **sysadmin** , роли базы данных **db_owner** распространителя или в **списке доступа к публикации** для конкретной публикации, связанной с базой данных издателя.</span><span class="sxs-lookup"><span data-stu-id="77a8d-153">To execute this stored procedure the caller must either be a member of the **sysadmin** server role, the **db_owner** database role for the distribution database, or a member of a **Publication Access List** for a defined publication associated with the publisher database.</span></span>  
  
-   <span data-ttu-id="77a8d-154">**sp_validate_redirected_publisher**</span><span class="sxs-lookup"><span data-stu-id="77a8d-154">**sp_validate_redirected_publisher**</span></span>  
  
     <span data-ttu-id="77a8d-155">Эта хранимая процедура пытается проверить, что текущий издатель способен к размещению опубликованной базы данных.</span><span class="sxs-lookup"><span data-stu-id="77a8d-155">This stored procedure attempts to validate that the current publisher is capable of hosting the published database.</span></span> <span data-ttu-id="77a8d-156">Ее можно вызвать в любое время, чтобы проверить, способен ли текущий узел поддерживать репликацию.</span><span class="sxs-lookup"><span data-stu-id="77a8d-156">It can be called at any time to verify that the current host for the published database is capable of supporting replication.</span></span>  
  
-   <span data-ttu-id="77a8d-157">**sp_validate_replicate_hosts_as_publishers**</span><span class="sxs-lookup"><span data-stu-id="77a8d-157">**sp_validate_replicate_hosts_as_publishers**</span></span>  
  
     <span data-ttu-id="77a8d-158">В то время как для агентов полезно убедиться в том, что текущая база данных-источник может функционировать в качестве издателя репликации для базы данных издателя, для установки действительности всей топологии репликации в базе данных доступности AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="77a8d-158">While it is useful for the agents to insure that the current primary can function as the replication publisher for a publisher database, a more general validation capability is needed to establish the validity of an entire replication topology on an AlwaysOn availability database.</span></span> <span data-ttu-id="77a8d-159">Хранимая процедура **sp_validate_replica_hosts_as_publishers** предназначена для выполнения этой задачи.</span><span class="sxs-lookup"><span data-stu-id="77a8d-159">The stored procedure **sp_validate_replica_hosts_as_publishers** is designed to fill this need.</span></span>  
  
     <span data-ttu-id="77a8d-160">Эта хранимая процедура всегда запускается вручную.</span><span class="sxs-lookup"><span data-stu-id="77a8d-160">This stored procedure is always run manually.</span></span> <span data-ttu-id="77a8d-161">Для вызова этой процедуры необходимо членство в роли **sysadmin** на распространителе, роли **dbowner** базы данных распространителя или в **списке доступа к публикации** для публикации базы данных издателя.</span><span class="sxs-lookup"><span data-stu-id="77a8d-161">The caller must either be **sysadmin** at the distributor, **dbowner** of the distribution database, or a member of the **Publication Access List** of a publication of the publisher database.</span></span> <span data-ttu-id="77a8d-162">Кроме того, имя входа вызывающего должно быть действительным именем входа для всех узлов реплик доступности и обладать особыми правами для базы данных доступности, связанной с базой данных издателя.</span><span class="sxs-lookup"><span data-stu-id="77a8d-162">In addition, the login of the caller must be a valid login for all of the availability replica hosts, and have select privileges on the availability database associated with the publisher database.</span></span>  
  
###  <a name="change-data-capture"></a><a name="CDC"></a> <span data-ttu-id="77a8d-163">Система отслеживания измененных данных</span><span class="sxs-lookup"><span data-stu-id="77a8d-163">Change Data Capture</span></span>  
 <span data-ttu-id="77a8d-164">Базы данных, предназначенные для использования с системой отслеживания измененных данных (CDC), могут использовать [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] для обеспечения не только доступности данных в будущем, но и возможности отслеживания и сохранения в таблицах изменений CDC, вносимых в таблицы базы данных.</span><span class="sxs-lookup"><span data-stu-id="77a8d-164">Databases enabled for change data capture (CDC) are able to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] in order to insure not only that the database remains available in the event of failure, but that changes to the database tables continue to be monitored and deposited in the CDC change tables.</span></span> <span data-ttu-id="77a8d-165">Порядок, в котором настраиваются CDC и [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] , не имеет значения.</span><span class="sxs-lookup"><span data-stu-id="77a8d-165">The order in which CDC and [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] are configured is not important.</span></span> <span data-ttu-id="77a8d-166">Базы данных с поддержкой CDC можно добавлять в [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], а базы данных, входящие в группу доступности AlwaysOn, можно включать для CDC.</span><span class="sxs-lookup"><span data-stu-id="77a8d-166">CDC enabled databases can be added to [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], and databases that are members of an AlwaysOn availability group can be enabled for CDC.</span></span> <span data-ttu-id="77a8d-167">В обоих случаях настройка CDC всегда выполняется в текущей или целевой первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="77a8d-167">In both cases, however, CDC configuration is always performed on the current or intended primary replica.</span></span> <span data-ttu-id="77a8d-168">CDC использует агент чтения журнала и имеет те же ограничения, которые были описаны в подразделе **Изменения в агенте чтения журнала** ранее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="77a8d-168">CDC uses the log reader agent and has the same limitations as described in the **Log Reader Agent Modifications** section earlier in this topic.</span></span>  
  
-   <span data-ttu-id="77a8d-169">**Система отслеживания измененных данных без репликации**</span><span class="sxs-lookup"><span data-stu-id="77a8d-169">**Harvesting Changes for Change Data Capture Without Replication**</span></span>  
  
     <span data-ttu-id="77a8d-170">Если в базе данных включена функция захвата изменений данных, однако не предусмотрена ее репликация, процесс захвата, используемый для сбора изменений из журнала и их сохранения в таблицах изменений CDC, работает на узле CDC в качестве собственного задания агента SQL.</span><span class="sxs-lookup"><span data-stu-id="77a8d-170">If CDC is enabled for a database, but replication is not, the capture process used to harvest changes from the log and deposit them in CDC change tables runs at the CDC host as its own SQL Agent job.</span></span>  
  
     <span data-ttu-id="77a8d-171">Чтобы возобновить сбор изменений после отработки отказа, хранимую процедуру **sp_cdc_add_job** необходимо запустить в новой базе данных-источнике и создать локальное задание отслеживания.</span><span class="sxs-lookup"><span data-stu-id="77a8d-171">In order to resume the harvesting of changes after failover, the stored procedure **sp_cdc_add_job** must be run at the new primary to create the local capture job.</span></span>  
  
     <span data-ttu-id="77a8d-172">В следующем примере создается задание отслеживания.</span><span class="sxs-lookup"><span data-stu-id="77a8d-172">The following example creates the capture job.</span></span>  
  
    ```  
    EXEC sys.sp_cdc_add_job @job_type = 'capture';  
    ```  
  
-   <span data-ttu-id="77a8d-173">**Система отслеживания измененных данных с репликацией**</span><span class="sxs-lookup"><span data-stu-id="77a8d-173">**Harvesting Changes for Change Data Capture With Replication**</span></span>  
  
     <span data-ttu-id="77a8d-174">Если для базы данных включены функции репликации и отслеживания изменений данных, средство чтения журнала выполняет процесс заполнения таблиц изменений CDC.</span><span class="sxs-lookup"><span data-stu-id="77a8d-174">If both CDC and replication are enabled for a database, the log reader handles the population of the CDC change tables.</span></span> <span data-ttu-id="77a8d-175">В этом случае методы, применяемые в процессе репликации для использования [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] , обеспечат сбор данных об изменениях из журнала и их сохранение в таблице изменений CDC после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="77a8d-175">In this case, the techniques used by replication to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] will insure that changes continue to be harvested from the log and deposited in CDC change tables after failover.</span></span> <span data-ttu-id="77a8d-176">Чтобы CDC в этой конфигурации заполнял таблицы изменений, больше ничего делать не нужно.</span><span class="sxs-lookup"><span data-stu-id="77a8d-176">Nothing additional needs to be done for CDC in this configuration to insure that the change tables are populated.</span></span>  
  
-   <span data-ttu-id="77a8d-177">**Очистка системы отслеживания измененных данных**</span><span class="sxs-lookup"><span data-stu-id="77a8d-177">**Change Data Capture Cleanup**</span></span>  
  
     <span data-ttu-id="77a8d-178">Чтобы обеспечить соответствующую очистку в новой базе данных-источнике, необходимо также создать локальное задание очистки.</span><span class="sxs-lookup"><span data-stu-id="77a8d-178">To insure that appropriate cleanup occurs at the new primary database, a local cleanup job should always be created.</span></span> <span data-ttu-id="77a8d-179">В следующем примере создается задание очистки.</span><span class="sxs-lookup"><span data-stu-id="77a8d-179">The following example creates the cleanup job.</span></span>  
  
    ```  
    EXEC sys.sp_cdc_add_job @job_type = 'cleanup';  
    ```  
  
    > [!NOTE]  
    >  <span data-ttu-id="77a8d-180">Рекомендуется создавать задания для всех возможных целей отработки отказа и отключить их, пока одна из реплик доступности на узле не станет новой первичной репликой.</span><span class="sxs-lookup"><span data-stu-id="77a8d-180">You should create the jobs at all of the possible failover targets before failover, and mark them as disabled until the availability replica at a host becomes the new primary replica.</span></span> <span data-ttu-id="77a8d-181">Задания CDC, запущенные в старой базе данных-источнике, также должны быть отключены, когда локальная база данных становится базой данных-получателем.</span><span class="sxs-lookup"><span data-stu-id="77a8d-181">The CDC jobs running at the old primary database should be also disabled when the local database becomes a secondary database.</span></span> <span data-ttu-id="77a8d-182">Чтобы отключить и включить задания, используйте *@enabled* параметр [Sp_update_job &#40;TRANSACT-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-update-job-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="77a8d-182">To disable and enable jobs, use the *@enabled* option of [sp_update_job &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-update-job-transact-sql).</span></span> <span data-ttu-id="77a8d-183">Дополнительные сведения о создании заданий CDC см. в разделе [sys.sp_cdc_add_job (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="77a8d-183">For more information about creating CDC jobs, see [sys.sp_cdc_add_job &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql).</span></span>  
  
-   <span data-ttu-id="77a8d-184">**Добавление ролей CDC для первичной реплики базы данных AlwaysOn**</span><span class="sxs-lookup"><span data-stu-id="77a8d-184">**Adding CDC Roles to an AlwaysOn Primary Database Replica**</span></span>  
  
     <span data-ttu-id="77a8d-185">Если для CDC включена таблица, то можно связать роль базы данных с экземпляром отслеживания.</span><span class="sxs-lookup"><span data-stu-id="77a8d-185">When a table is enabled for CDC, it is possible to associate a database role with the capture instance.</span></span> <span data-ttu-id="77a8d-186">Если указана роль, то пользователь, который будет использовать функции с табличным значением CDC для доступа к изменениям, должен иметь не только права доступа к столбцам отслеживаемой таблицы, но и быть членом именованной роли.</span><span class="sxs-lookup"><span data-stu-id="77a8d-186">If a role is specified, the user wishing to use the CDC table-valued functions to access changes for the table must not only have select access to the tracked table columns, but must also be a member of the named role.</span></span> <span data-ttu-id="77a8d-187">Если указанная роль еще не существует, то она будет создана.</span><span class="sxs-lookup"><span data-stu-id="77a8d-187">If the specified role does not already exist, the role will be created.</span></span> <span data-ttu-id="77a8d-188">Если роли баз данных автоматически добавляются в базу данных-источник AlwaysOn, то роли также добавляются в базы данных -получатели группы доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-188">When database roles are automatically added to an AlwaysOn primary database, the roles are also propagated to the secondary databases of the availability group.</span></span>  
  
-   <span data-ttu-id="77a8d-189">**Клиентские приложения, использующие информацию об изменениях CDC и режим Always On**</span><span class="sxs-lookup"><span data-stu-id="77a8d-189">**Client Applications Accessing CDC Change Data and Always On**</span></span>  
  
     <span data-ttu-id="77a8d-190">Клиентским приложениям, которые вызывают функции с табличными значениями или обращаются к связанным серверам, для доступа к данным таблицы изменений также необходима возможность обнаружения соответствующего CDC-хоста после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="77a8d-190">Client applications that use the table-valued functions (TVFs) or linked servers to access change table data also need the ability to locate an appropriate CDC host after failover.</span></span> <span data-ttu-id="77a8d-191">Имя прослушивателя группы доступности — это предусмотренный в [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] механизм для прозрачного разрешения перенаправления соединения на другой узел.</span><span class="sxs-lookup"><span data-stu-id="77a8d-191">The availability group listener name is the mechanism provided by [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] to transparently allow a connection to be retargeted to a different host.</span></span> <span data-ttu-id="77a8d-192">Как только имя прослушивателя группы доступности связано с группой доступности, оно становится доступным для строк подключения TCP.</span><span class="sxs-lookup"><span data-stu-id="77a8d-192">Once an availability group listener name is associated with an availability group, it is available to be used in TCP connection strings.</span></span> <span data-ttu-id="77a8d-193">Через имя прослушивателя группы доступности поддерживаются два разных сценария соединений.</span><span class="sxs-lookup"><span data-stu-id="77a8d-193">Two different connection scenarios are supported through the availability group listener name.</span></span>  
  
    -   <span data-ttu-id="77a8d-194">Один гарантирует, чтобы запросы на соединение всегда направлялись на активную первичную реплику.</span><span class="sxs-lookup"><span data-stu-id="77a8d-194">One insures that connection requests are always directed to the current primary replica.</span></span>  
  
    -   <span data-ttu-id="77a8d-195">Второй — чтобы запросы на соединение направлялись на вторичную реплику только для чтения.</span><span class="sxs-lookup"><span data-stu-id="77a8d-195">One insures that connection requests are directed to a read-only secondary replica.</span></span>  
  
     <span data-ttu-id="77a8d-196">При использовании для поиска вторичной реплики в режиме только для чтения необходимо определить список маршрутизации для группы доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-196">If used to locate a read-only secondary replica, a read-only routing list must also be defined for the availability group.</span></span> <span data-ttu-id="77a8d-197">Дополнительные сведения см. ниже в подразделе [Настройка реплик доступности для маршрутизации только для чтения](../../listeners-client-connectivity-application-failover.md#ConfigureARsForROR).</span><span class="sxs-lookup"><span data-stu-id="77a8d-197">For more information about routing access to readable secondaries, see [To Configure Availability Replicas for Read-Only Routing](../../listeners-client-connectivity-application-failover.md#ConfigureARsForROR).</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="77a8d-198">Существует задержка распространения, связанная с созданием имени прослушивателя группы доступности и его использованием клиентскими приложениями для доступа к реплике базы данных группы доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-198">There is some propagation delay associated with the creation of an availability group listener name and its use by client applications to access an availability group database replica.</span></span>  
  
     <span data-ttu-id="77a8d-199">Воспользуйтесь следующим запросом, чтобы определить, было ли имя прослушивателя группы доступности определено для размещения CDC-базы данных группой доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-199">Use the following query to determine whether an availability group listener name has been defined for the availability group hosting a CDC database.</span></span> <span data-ttu-id="77a8d-200">Запрос возвращает имя прослушивателя группы доступности, если оно уже создано.</span><span class="sxs-lookup"><span data-stu-id="77a8d-200">The query will return the availability group listener name if one has been created.</span></span>  
  
    ```  
    SELECT dns_name   
    FROM sys.availability_group_listeners AS l  
    INNER JOIN sys.availability_databases_cluster AS d  
        ON l.group_id = d.group_id  
    WHERE d.database_name = N'MyCDCDB';  
    ```  
  
-   <span data-ttu-id="77a8d-201">**Перенаправление нагрузки по запросам на вторичные реплики для чтения**</span><span class="sxs-lookup"><span data-stu-id="77a8d-201">**Redirecting the Query Load to a Readable Secondary Replica**</span></span>  
  
     <span data-ttu-id="77a8d-202">Несмотря на то что во многих случаях клиентское приложение желает подключиться к текущей первичной реплике, это не единственный способ использования групп доступности [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span><span class="sxs-lookup"><span data-stu-id="77a8d-202">While in many cases a client application will always want to connect to the current primary replica that is not the only way to leverage [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="77a8d-203">Если группа доступности определяется с доступными для чтения репликами-получателями, то информацию об изменениях также можно собирать с вторичных узлов.</span><span class="sxs-lookup"><span data-stu-id="77a8d-203">If an availability group is configured to support readable secondary replicas, change data can also be gathered from secondary nodes.</span></span>  
  
     <span data-ttu-id="77a8d-204">Во время настройки группы доступности атрибут ALLOW_CONNECTIONS, связанный с SECONDARY_ROLE, используется для указания типа поддерживаемого вторичного доступа.</span><span class="sxs-lookup"><span data-stu-id="77a8d-204">When an availability group is configured, the ALLOW_CONNECTIONS attribute associated with the SECONDARY_ROLE is used to specify the type of secondary access supported.</span></span> <span data-ttu-id="77a8d-205">При настройке с параметром ALL все соединения с получателем будут разрешены, но только соединения с доступом только для чтения будут завершаться успешно.</span><span class="sxs-lookup"><span data-stu-id="77a8d-205">If configured as ALL, all connections to the secondary will be allowed, but only those requiring read only access will succeed.</span></span> <span data-ttu-id="77a8d-206">При настройке с параметром READ_ONLY необходимо указать цель только для чтения при соединении с базой данных-получателем, чтобы соединение завершилось успешно.</span><span class="sxs-lookup"><span data-stu-id="77a8d-206">If configured as READ_ONLY, it is necessary to specify read only intent when making the connection to the secondary database in order for the connection to succeed.</span></span> <span data-ttu-id="77a8d-207">Дополнительные сведения см. в разделе [Настройка доступа только для чтения в реплике доступности (SQL Server)](configure-read-only-access-on-an-availability-replica-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="77a8d-207">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
     <span data-ttu-id="77a8d-208">Чтобы определить, требуется ли намерение только для чтения для подключения к вторичной реплике, доступной для чтения, воспользуйтесь следующим запросом.</span><span class="sxs-lookup"><span data-stu-id="77a8d-208">The following query can be used to determine whether read-only intent is needed to connect to a readable secondary replica.</span></span>  
  
    ```  
    SELECT g.name AS AG, replica_server_name, secondary_role_allow_connections_desc  
    FROM sys.availability_replicas AS r  
    JOIN sys.availability_groups AS g  
        ON r.group_id = g.group_id  
    WHERE g.name = N'MY_AG_NAME;  
    ```  
  
     <span data-ttu-id="77a8d-209">Для поиска вторичной реплики можно использовать имя прослушивателя группы доступности или явное имя узла.</span><span class="sxs-lookup"><span data-stu-id="77a8d-209">Either the availability group listener name or the explicit node name can be used to locate the secondary replica.</span></span> <span data-ttu-id="77a8d-210">Если используется имя прослушивателя группы доступности, то доступ будет перенаправлен любой подходящей вторичной реплике.</span><span class="sxs-lookup"><span data-stu-id="77a8d-210">If the availability group listener name is used, access will be directed to any suitable secondary replica.</span></span>  
  
     <span data-ttu-id="77a8d-211">Если `sp_addlinkedserver` используется для создания связанного сервера для доступа к базе-получателю, *@datasrc* параметр используется для имени прослушивателя группы доступности или явного имени сервера, а *@provstr* параметр используется для указания намерения только для чтения.</span><span class="sxs-lookup"><span data-stu-id="77a8d-211">When `sp_addlinkedserver` is used to create a linked server to access the secondary, the *@datasrc* parameter is used for the availability group listener name or the explicit server name, and the *@provstr* parameter is used to specify read-only intent.</span></span>  
  
    ```  
    EXEC sp_addlinkedserver   
    @server = N'linked_svr',   
    @srvproduct=N'SqlServer',  
    @provider=N'SQLNCLI11',   
    @datasrc=N'AG_Listener_Name',   
    @provstr=N'ApplicationIntent=ReadOnly',   
    @catalog=N'MY_DB_NAME';  
    ```  
  
-   <span data-ttu-id="77a8d-212">**Клиентский доступ к информации об изменениях CDC и доменным именам входа**</span><span class="sxs-lookup"><span data-stu-id="77a8d-212">**Client Access to CDC Change Data and Domain Logins**</span></span>  
  
     <span data-ttu-id="77a8d-213">Рекомендуется использовать доменные имена входа для клиентского доступа к информации об изменениях в базах данных, которые являются членами групп доступности AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="77a8d-213">In general, you should use domain logins for client access to change data residing in databases that are members of AlwaysOn availability groups.</span></span> <span data-ttu-id="77a8d-214">Чтобы обеспечить непрерывный доступ к информации об изменениях после отработки отказа, пользователь домена должен иметь привилегии доступа на всех хостах, поддерживающих реплики в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="77a8d-214">To insure continued access to change data after failover, the domain user will need access privileges on all of the hosts supporting availability group replicas.</span></span> <span data-ttu-id="77a8d-215">Если пользователь базы данных добавляется в базу данных первичной реплики и пользователь связан с доменным именем входа, пользователь базы данных распространяется на базу данных-получателя и продолжает быть связанным с указанным доменным именем входа.</span><span class="sxs-lookup"><span data-stu-id="77a8d-215">If a database user is added to a database in a primary replica, and the user is associated with a domain login, the database user is propagated to secondary databases and continues to be associated with the specified domain login.</span></span> <span data-ttu-id="77a8d-216">Если новый пользователь базы данных связан с именем входа SQL Server, пользователь базы данных-получателя будет распространен без имени входа.</span><span class="sxs-lookup"><span data-stu-id="77a8d-216">If the new database user is associated with a SQL Server authentication login, the user at the secondary databases will be propagated without a login.</span></span> <span data-ttu-id="77a8d-217">Несмотря на то что связанное с проверкой имя входа [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] может быть использовано для доступа к данным изменений в источнике, где пользователь был определен изначально, пользователь может получить доступ только к этому узлу.</span><span class="sxs-lookup"><span data-stu-id="77a8d-217">While the associated [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] authentication login could be used to access change data at the primary where the database user was originally defined, that node is the only one where access would be possible.</span></span> <span data-ttu-id="77a8d-218">Проверка подлинности имени входа [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] не сможет получить доступ к данным из какой-либо базы данных-получателя или из новой базы данных-источника, которая отличается от исходной базы данных, где пользователь был определен.</span><span class="sxs-lookup"><span data-stu-id="77a8d-218">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] authentication login would not be able to access data from any secondary database, nor from any new primary databases other than the original database where the database user was defined.</span></span>  
  
###  <a name="change-tracking"></a><a name="CT"></a> <span data-ttu-id="77a8d-219">Отслеживание изменений</span><span class="sxs-lookup"><span data-stu-id="77a8d-219">Change Tracking</span></span>  
 <span data-ttu-id="77a8d-220">Базы данных с включенной функцией отслеживания изменений могут быть частью группы доступности AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="77a8d-220">A database enabled for change tracking (CT) can be part of an AlwaysOn availability group.</span></span> <span data-ttu-id="77a8d-221">Никаких дополнительных настроек не требуется.</span><span class="sxs-lookup"><span data-stu-id="77a8d-221">No additional configuration is needed.</span></span> <span data-ttu-id="77a8d-222">Клиентские приложения по отслеживанию изменений, использующие функции с табличными значениями (возвращающие табличное значение функции) или связанные серверы, для доступа к данным таблицы изменений также требуют возможность обнаружения первичной реплики после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="77a8d-222">Change tracking client applications that use the CDC table-valued functions (TVFs) to access change data will need the ability to locate the primary replica after failover.</span></span> <span data-ttu-id="77a8d-223">Если клиентское приложение подключается посредством имени прослушивателя группы доступности, запросы на соединение всегда направляются на текущую первичную реплику.</span><span class="sxs-lookup"><span data-stu-id="77a8d-223">If the client application connects through the availability group listener name, connection requests will always be appropriately directed to the current primary replica.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="77a8d-224">Данные отслеживания изменений должны получаться из первичной реплики.</span><span class="sxs-lookup"><span data-stu-id="77a8d-224">Change tracking data must always be obtained from the primary replica.</span></span> <span data-ttu-id="77a8d-225">Попытка доступа к информации об изменениях из вторичной реплики приведет к следующей ошибке.</span><span class="sxs-lookup"><span data-stu-id="77a8d-225">An attempt to access change data from a secondary replica will result in the following error:</span></span>  
>   
>  <span data-ttu-id="77a8d-226">Сообщение 22117, уровень 16, состояние 1, строка 1</span><span class="sxs-lookup"><span data-stu-id="77a8d-226">Msg 22117, Level 16, State 1, Line1</span></span>  
>   
>  <span data-ttu-id="77a8d-227">Для баз данных, которые являются членами вторичной реплики (то есть баз данных-получателей), отслеживание изменений не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="77a8d-227">For databases that are members of a secondary replica (that is, for secondary databases), change tracking is not supported.</span></span> <span data-ttu-id="77a8d-228">Запускайте запросы отслеживания изменений для баз данных в первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="77a8d-228">Run change tracking queries on the databases in the primary replica.</span></span>  
  
##  <a name="prerequisites-restrictions-and-considerations-for-using-replication"></a><a name="Prereqs"></a> <span data-ttu-id="77a8d-229">Условия, ограничения и вопросы использования репликации</span><span class="sxs-lookup"><span data-stu-id="77a8d-229">Prerequisites, Restrictions, and Considerations for Using Replication</span></span>  
 <span data-ttu-id="77a8d-230">В этом разделе описаны вопросы развертывания репликации при помощи [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], в том числе предварительные условия, ограничения и рекомендации.</span><span class="sxs-lookup"><span data-stu-id="77a8d-230">This section describes considerations for deploying replication with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], including prerequisites, restrictions, and recommendations.</span></span>  
  
### <a name="prerequisites"></a><span data-ttu-id="77a8d-231">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="77a8d-231">Prerequisites</span></span>  
  
-   <span data-ttu-id="77a8d-232">При использовании репликации транзакций и базы данных публикации в группе доступности издатель и распространитель должны иметь версию не ниже [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span><span class="sxs-lookup"><span data-stu-id="77a8d-232">When using transactional replication and the publishing database is in an availability group both the publisher and the distributor must run at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span> <span data-ttu-id="77a8d-233">Подписчик может использовать [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]более низкого уровня.</span><span class="sxs-lookup"><span data-stu-id="77a8d-233">The subscriber can be using a lower level of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="77a8d-234">При использовании репликации слиянием и базы данных публикации в группе доступности:</span><span class="sxs-lookup"><span data-stu-id="77a8d-234">When using merge replication and the publishing database is in an availability group:</span></span>  
  
    -   <span data-ttu-id="77a8d-235">Принудительная подписка: издатель и распространитель должны иметь версию не ниже [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span><span class="sxs-lookup"><span data-stu-id="77a8d-235">Push subscription: Both the publisher and the distributor must run at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span>  
  
    -   <span data-ttu-id="77a8d-236">Подписка по запросу: базы данных издателя, распространителя и подписчика должны находиться на экземпляре с версией не ниже [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span><span class="sxs-lookup"><span data-stu-id="77a8d-236">Pull subscription: The publisher, distributor, and subscriber databases must be on at least [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)].</span></span> <span data-ttu-id="77a8d-237">Это связано с тем, что агент слияния на подписчике должен иметь сведения о том, как группа доступности может выполнить отработку отказа на базу данных-получатель.</span><span class="sxs-lookup"><span data-stu-id="77a8d-237">This is because the merge agent on the subscriber must understand how an availability group can fail over to its secondary.</span></span>  
  
-   <span data-ttu-id="77a8d-238">Размещение базы данных распространителя в группе доступности не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="77a8d-238">Placing the distribution database on an availability group is not supported.</span></span>  
  
-   <span data-ttu-id="77a8d-239">Экземпляры издателя должны удовлетворять всем предварительным условиям, необходимым для участия в группе доступности AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="77a8d-239">The Publisher instances satisfy all the prerequisites required to participate in an AlwaysOn availability group.</span></span> <span data-ttu-id="77a8d-240">Дополнительные сведения см. в разделе [Предварительные требования, ограничения и рекомендации для группы доступности AlwaysOn &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md).</span><span class="sxs-lookup"><span data-stu-id="77a8d-240">For more information see [Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md).</span></span>  
  
### <a name="restrictions"></a><span data-ttu-id="77a8d-241">Ограничения</span><span class="sxs-lookup"><span data-stu-id="77a8d-241">Restrictions</span></span>  
 <span data-ttu-id="77a8d-242">Поддерживаемые сочетания репликации в [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="77a8d-242">Supported combinations of replication on [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]:</span></span>  
  
|||||  
|-|-|-|-|  
||<span data-ttu-id="77a8d-243">**Издатель**</span><span class="sxs-lookup"><span data-stu-id="77a8d-243">**Publisher**</span></span>|<span data-ttu-id="77a8d-244">**Распространитель** <sup>3</sup></span><span class="sxs-lookup"><span data-stu-id="77a8d-244">**Distributor** <sup>3</sup></span></span>|<span data-ttu-id="77a8d-245">**Подписчик**</span><span class="sxs-lookup"><span data-stu-id="77a8d-245">**Subscriber**</span></span>|  
|<span data-ttu-id="77a8d-246">**Транзакционная**</span><span class="sxs-lookup"><span data-stu-id="77a8d-246">**Transactional**</span></span>|<span data-ttu-id="77a8d-247">Да<sup>1</sup></span><span class="sxs-lookup"><span data-stu-id="77a8d-247">Yes<sup>1</sup></span></span>|<span data-ttu-id="77a8d-248">Нет</span><span class="sxs-lookup"><span data-stu-id="77a8d-248">No</span></span>|<span data-ttu-id="77a8d-249">Да<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="77a8d-249">Yes<sup>2</sup></span></span>|  
|<span data-ttu-id="77a8d-250">**P2P**</span><span class="sxs-lookup"><span data-stu-id="77a8d-250">**P2P**</span></span>|<span data-ttu-id="77a8d-251">Нет</span><span class="sxs-lookup"><span data-stu-id="77a8d-251">No</span></span>|<span data-ttu-id="77a8d-252">Нет</span><span class="sxs-lookup"><span data-stu-id="77a8d-252">No</span></span>|<span data-ttu-id="77a8d-253">Нет</span><span class="sxs-lookup"><span data-stu-id="77a8d-253">No</span></span>|  
|<span data-ttu-id="77a8d-254">**Объединить**</span><span class="sxs-lookup"><span data-stu-id="77a8d-254">**Merge**</span></span>|<span data-ttu-id="77a8d-255">Да</span><span class="sxs-lookup"><span data-stu-id="77a8d-255">Yes</span></span>|<span data-ttu-id="77a8d-256">Нет</span><span class="sxs-lookup"><span data-stu-id="77a8d-256">No</span></span>|<span data-ttu-id="77a8d-257">Да<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="77a8d-257">Yes<sup>2</sup></span></span>|  
|<span data-ttu-id="77a8d-258">**Моментальный снимок**</span><span class="sxs-lookup"><span data-stu-id="77a8d-258">**Snapshot**</span></span>|<span data-ttu-id="77a8d-259">Да</span><span class="sxs-lookup"><span data-stu-id="77a8d-259">Yes</span></span>|<span data-ttu-id="77a8d-260">Нет</span><span class="sxs-lookup"><span data-stu-id="77a8d-260">No</span></span>|<span data-ttu-id="77a8d-261">Да<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="77a8d-261">Yes<sup>2</sup></span></span>|  
  
 <span data-ttu-id="77a8d-262"><sup>1</sup> не включает поддержку двунаправленной и обратной репликации транзакций.</span><span class="sxs-lookup"><span data-stu-id="77a8d-262"><sup>1</sup> Does not include support for bi-directional and reciprocal transactional replication.</span></span>  
  
 <span data-ttu-id="77a8d-263"><sup>2</sup> отработка отказа в базу данных реплики является процедурой, выполняемой вручную.</span><span class="sxs-lookup"><span data-stu-id="77a8d-263"><sup>2</sup> Failover to the replica database is a manual procedure.</span></span> <span data-ttu-id="77a8d-264">Автоматический переход на другой ресурс не предоставляется.</span><span class="sxs-lookup"><span data-stu-id="77a8d-264">Automatic failover is not provided.</span></span>  
  
 <span data-ttu-id="77a8d-265"><sup>3</sup> база данных распространителя не поддерживается для использования с [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] или зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="77a8d-265"><sup>3</sup> The Distributor database is not supported for use with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] or database mirroring.</span></span>  
  
### <a name="considerations"></a><span data-ttu-id="77a8d-266">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="77a8d-266">Considerations</span></span>  
  
-   <span data-ttu-id="77a8d-267">База данных распространителя не поддерживается в сочетании с [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] или с зеркальным отображением базы данных.</span><span class="sxs-lookup"><span data-stu-id="77a8d-267">The distribution database is not supported for use with [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] or database mirroring.</span></span> <span data-ttu-id="77a8d-268">Конфигурация репликации работает совместно с экземпляром SQL Server, на котором настроен распространитель. Именно по этой причине база данных распространителя не может участвовать в репликации или зеркальном отображении.</span><span class="sxs-lookup"><span data-stu-id="77a8d-268">Replication configuration is coupled to the SQL Server instance where the Distributor is configured; therefore the distribution database cannot be mirrored or replicated.</span></span> <span data-ttu-id="77a8d-269">Чтобы обеспечить высокий уровень доступности для распространителя, используйте отказоустойчивый кластер SQL Server.</span><span class="sxs-lookup"><span data-stu-id="77a8d-269">To provide high availability for the Distributor, use a SQL Server failover cluster.</span></span> <span data-ttu-id="77a8d-270">Дополнительные сведения см. в статье [Экземпляры отказоустойчивого кластера (режим AlwaysOn) (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="77a8d-270">For more information, see [AlwaysOn Failover Cluster Instances (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md).</span></span>  
  
-   <span data-ttu-id="77a8d-271">Отработка отказа подписчика на базу данных-получателя — сравнительно сложная процедура, выполняемая вручную.</span><span class="sxs-lookup"><span data-stu-id="77a8d-271">Subscriber failover to a secondary database, while supported, is a relatively complex manual procedure.</span></span> <span data-ttu-id="77a8d-272">Процедура, по существу, идентична методу, используемому для переключения на зеркальную базу данных подписчика.</span><span class="sxs-lookup"><span data-stu-id="77a8d-272">The procedure is essentially identical to the method used to fail over a mirrored subscriber database.</span></span> <span data-ttu-id="77a8d-273">Чтобы подписчики могли участвовать в группе доступности, они должны использовать [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)] или более позднюю версию.</span><span class="sxs-lookup"><span data-stu-id="77a8d-273">Subscribers must be running [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)] or later to participate in an availability group.</span></span>  
  
-   <span data-ttu-id="77a8d-274">Метаданные и объекты, которые существуют за пределами базы данных, не распространяются на вторичные реплики. Это касается имен входа, заданий, связанных серверов и так далее.</span><span class="sxs-lookup"><span data-stu-id="77a8d-274">Metadata and objects that exist outside the database are not propagated to the secondary replicas, including logins, jobs, linked servers.</span></span> <span data-ttu-id="77a8d-275">Если после отработки отказа в базе данных-источнике нужны метаданные и объекты, их необходимо скопировать вручную.</span><span class="sxs-lookup"><span data-stu-id="77a8d-275">If you require the metadata and objects at the new primary database after failover, you must copy them manually.</span></span> <span data-ttu-id="77a8d-276">Дополнительные сведения см. в разделе [Управление именами входа и заданиями для баз данных группы доступности (SQL Server)](../../logins-and-jobs-for-availability-group-databases.md).</span><span class="sxs-lookup"><span data-stu-id="77a8d-276">For more information, see [Management of Logins and Jobs for the Databases of an Availability Group &#40;SQL Server&#41;](../../logins-and-jobs-for-availability-group-databases.md).</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="77a8d-277">Связанные задачи</span><span class="sxs-lookup"><span data-stu-id="77a8d-277">Related Tasks</span></span>  
 <span data-ttu-id="77a8d-278">**Репликация**</span><span class="sxs-lookup"><span data-stu-id="77a8d-278">**Replication**</span></span>  
  
-   [<span data-ttu-id="77a8d-279">Настройка репликации для групп доступности AlwaysOn (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="77a8d-279">Configure Replication for AlwaysOn Availability Groups (SQL Server)</span></span>](always-on-availability-groups-sql-server.md)  
  
-   [<span data-ttu-id="77a8d-280">Обслуживание базы данных публикации AlwaysOn &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="77a8d-280">Maintaining an AlwaysOn Publication Database &#40;SQL Server&#41;</span></span>](maintaining-an-always-on-publication-database-sql-server.md)  
  
-   [<span data-ttu-id="77a8d-281">Вопросы и ответы об администрировании репликации</span><span class="sxs-lookup"><span data-stu-id="77a8d-281">Replication Administration FAQ</span></span>](../../../relational-databases/replication/administration/frequently-asked-questions-for-replication-administrators.md)  
  
 <span data-ttu-id="77a8d-282">**Запись измененных данных**</span><span class="sxs-lookup"><span data-stu-id="77a8d-282">**Change data capture**</span></span>  
  
-   [<span data-ttu-id="77a8d-283">Включение и отключение отслеживания измененных данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="77a8d-283">Enable and Disable Change Data Capture &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server.md)  
  
-   [<span data-ttu-id="77a8d-284">Администрирование и наблюдение за отслеживанием измененных данных (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="77a8d-284">Administer and Monitor Change Data Capture &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/administer-and-monitor-change-data-capture-sql-server.md)  
  
-   [<span data-ttu-id="77a8d-285">Работа с информацией об изменениях (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="77a8d-285">Work with Change Data &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/work-with-change-data-sql-server.md)  
  
 <span data-ttu-id="77a8d-286">**Change tracking**</span><span class="sxs-lookup"><span data-stu-id="77a8d-286">**Change tracking**</span></span>  
  
-   [<span data-ttu-id="77a8d-287">Включение и отключение отслеживания изменений (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="77a8d-287">Enable and Disable Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/enable-and-disable-change-tracking-sql-server.md)  
  
-   [<span data-ttu-id="77a8d-288">Управление отслеживанием изменений (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="77a8d-288">Manage Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/manage-change-tracking-sql-server.md)  
  
-   [<span data-ttu-id="77a8d-289">Работа с отслеживанием изменений (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="77a8d-289">Work with Change Tracking &#40;SQL Server&#41;</span></span>](../../../relational-databases/track-changes/work-with-change-tracking-sql-server.md)  
  
## <a name="see-also"></a><span data-ttu-id="77a8d-290">См. также:</span><span class="sxs-lookup"><span data-stu-id="77a8d-290">See Also</span></span>  
 <span data-ttu-id="77a8d-291">[Подписчики репликации и группы доступности AlwaysOn &#40;SQL Server&#41;](replication-subscribers-and-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="77a8d-291">[Replication Subscribers and AlwaysOn Availability Groups &#40;SQL Server&#41;](replication-subscribers-and-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="77a8d-292">[Предварительные требования, ограничения и рекомендации для группы доступности AlwaysOn &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md) </span><span class="sxs-lookup"><span data-stu-id="77a8d-292">[Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md) </span></span>  
 <span data-ttu-id="77a8d-293">[Общие сведения о группы доступности AlwaysOn &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="77a8d-293">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="77a8d-294">[Группы доступности AlwaysOn:](always-on-availability-groups-interoperability-sql-server.md) [экземпляры отказоустойчивого кластера AlwaysOn (SQL Server) (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="77a8d-294">[AlwaysOn Availability Groups: Interoperability (SQL Server)](always-on-availability-groups-interoperability-sql-server.md) [AlwaysOn Failover Cluster Instances (SQL Server)](../../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md) </span></span>  
 <span data-ttu-id="77a8d-295">[О фиксации измененных данных (SQL Server)](../../../relational-databases/track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="77a8d-295">[About Change Data Capture &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="77a8d-296">[Об отслеживании изменений (SQL Server)](../../../relational-databases/track-changes/about-change-tracking-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="77a8d-296">[About Change Tracking &#40;SQL Server&#41;](../../../relational-databases/track-changes/about-change-tracking-sql-server.md) </span></span>  
 <span data-ttu-id="77a8d-297">[Репликация SQL Server](../../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="77a8d-297">[SQL Server Replication](../../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="77a8d-298">[Отслеживание измененных данных (SQL Server)](../../../relational-databases/track-changes/track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="77a8d-298">[Track Data Changes &#40;SQL Server&#41;](../../../relational-databases/track-changes/track-data-changes-sql-server.md) </span></span>  
 [<span data-ttu-id="77a8d-299">sys.sp_cdc_add_job (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="77a8d-299">sys.sp_cdc_add_job &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql)  
  
  
