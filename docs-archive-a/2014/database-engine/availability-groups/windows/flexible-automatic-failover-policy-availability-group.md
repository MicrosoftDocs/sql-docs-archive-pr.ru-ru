---
title: Гибкая политика отработки отказа для автоматической отработки отказа группы доступности (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], flexible failover policy
- Availability Groups [SQL Server], failover
- flexible failover policy
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 8c504c7f-5c1d-4124-b697-f735ef0084f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: cd4dd62d8b30e2041415e0b9be5682ce4b01d1f6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87658988"
---
# <a name="flexible-failover-policy-for-automatic-failover-of-an-availability-group-sql-server"></a>Гибкая политика отработки отказа для автоматического перехода на другой ресурс группы доступности (SQL Server)
  Гибкая политика отработки отказа обеспечивает детальный контроль над условиями, которые приводят к [автоматическому переходу на другой ресурс](failover-and-failover-modes-always-on-availability-groups.md) для группы доступности. Изменяя условия отказа, которые инициируют автоматический переход на другой ресурс, и частоту проверки исправности, вы можете увеличить или уменьшить вероятность автоматического перехода на другой ресурс и добиться высокого уровня доступности соглашения об уровне обслуживания.  
  
 Гибкая политика отработки отказа группы доступности определяется уровнем условий сбоя и пороговым значением времени ожидания проверки работоспособности. При обнаружении, что группа доступности превысила уровень условий сбоя или пороговое значение проверки времени ожидания работоспособности, DLL-ресурс группы доступности ответит WSFC-кластеру. После этого WSFC-кластер инициирует автоматический переход на вторичную реплику.  
  
> [!IMPORTANT]  
>  Если в группе доступности превышен порог сбоя WSFC, то кластер WSFC не выполняет автоматический переход на другой ресурс для этой группы доступности. Более того, группа ресурсов WSFC для группы доступности остается в состоянии сбоя, пока администратор кластера вручную не переведет сбойную группу ресурсов в режим «в сети» или пока администратор базы данных вручную не выполнит переход группы доступности на другой ресурс. *Порог сбоя WSFC* определяется как максимальное число сбоев, которые могут произойти в группе доступности за заданный период времени. По умолчанию используется период в шесть часов, а максимальное число сбоев за этот период по умолчанию равно *n*-1, где *n* — число узлов WSFC. Чтобы изменить пороговые значения сбоя для заданной группы доступности, используйте консоль диспетчера отработки отказа WSFC.  
  
  
  
##  <a name="health-check-timeout-threshold"></a><a name="HCtimeout"></a> Пороговое значение времени ожидания проверки работоспособности  
 Библиотека ресурсов группы доступности в WSFC-кластере выполняет *проверку исправности* первичной реплики путем вызова хранимой процедуры [sp_server_diagnostics](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) для экземпляра SQL Server, на котором располагается первичная реплика. **sp_server_diagnostics** возвращает результаты с интервалом, равным 1/3 порогового значения времени ожидания при проверке работоспособности для группы доступности. Пороговое значение времени ожидания при проверке работоспособности по умолчанию составляет 30 секунд, то есть **sp_server_diagnostics** возвращает сведения с интервалом в 10 секунд. Если **sp_server_diagnostics** работает медленно или не возвращает сведения, библиотека ресурсов ожидает, пока истечет полный интервал для описанного порогового значения, и только затем определяет, что первичная реплика не отвечает. Если первичная реплика не отвечает, инициируется автоматический переход на другой ресурс, если она поддерживается.  
  
> [!IMPORTANT]  
>  **sp_server_diagnostics** не выполняет проверку работоспособности на уровне базы данных.  
  
##  <a name="failure-condition-level"></a><a name="FClevel"></a> Уровень условий сбоя  
 Уровень условий сбоя для группы доступности определяет, обеспечат ли диагностические данные и сведения о работоспособности, возвращенные командой **sp_server_diagnostics** , автоматический переход на другой ресурс. *Уровень условия сбоя* определяет, какие условия сбоя инициируют автоматический переход на другой ресурс. Существует пять уровней условий сбоя, которые варьируются от наименее ограничительного (уровень 1) до наиболее ограничительного (уровень 5). Заданный уровень включает в себя ограничения всех предыдущих уровней. Таким образом, наиболее строгий уровень 5 включает в себя менее строгие уровни ограничений с 1 по 4 и т. д.  
  
> [!IMPORTANT]  
>  Ни на одном из уровней условий сбоя не обнаружено поврежденных и подозрительных баз данных. Следовательно, поврежденная или подозрительная база данных (из-за ошибки оборудования, повреждения данных или по другой причине) никогда не вызывает автоматического перехода на другой ресурс.  
  
 В следующей таблице описываются условия сбоя, которые соответствуют каждому уровню.  
  
|Level|Условия сбоя|Значение [!INCLUDE[tsql](../../../includes/tsql-md.md)]|Значение PowerShell|  
|-----------|-----------------------|------------------------------|----------------------|  
|Один|При остановке работы сервера. Это наименее ограничительный уровень. Указывает, что автоматический переход на другой ресурс инициируется при возникновении любой из следующих ситуаций:<br /><br /> Служба [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] остановлена.<br /><br /> Аренда группы доступности для подключения к кластеру WSFC истекла, поскольку от экземпляра сервера не было получено сообщение ACK. Дополнительные сведения см. в статье [Как это работает: время ожидания аренды AlwaysOn SQL Server](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx).|1|`OnServerDown`|  
|Два|При отсутствии ответа от сервера. Указывает, что автоматический переход на другой ресурс инициируется при возникновении любой из следующих ситуаций:<br /><br /> Экземпляр [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] не подключается к кластеру, а определяемый пользователем порог времени ожидания проверки исправности для группы доступности превышен.<br /><br /> Реплика доступности находится в неисправном состоянии.|2|`OnServerUnresponsive`|  
|Три|В случае критической ошибки сервера. Указывает, что автоматический переход на другой ресурс инициируется в случае появления критических внутренних ошибок [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , таких как потерянные спин-блокировки, серьезные нарушения доступа для записи или формирование слишком больших дампов. Это уровень, заданный по умолчанию.|3|`OnCriticalServerError`|  
|Четыре|В случае ошибки сервера средней значимости. Указывает, что автоматический переход на другой ресурс инициируется в случае появления умеренных внутренних ошибок [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , например устойчивое состояние нехватки памяти в пуле внутренних ресурсов [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .|4|`OnModerateServerError`|  
|Пять|При любых подходящих условиях сбоя. Это наиболее ограничительный уровень. Указывает, что автоматический переход на другой ресурс инициируется при любом удовлетворяющем условиям состоянии сбоя, включая:<br /><br /> Исчерпание рабочих потоков SQL Engine.<br /><br /> Обнаружение неразрешимой взаимоблокировки.|5|`OnAnyQualifiedFailureConditions`|  
  
> [!NOTE]  
>  Отсутствие ответа экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] на клиентские запросы не является существенным для групп доступности.  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> Связанные задачи  
 **To configure automatic failover**  
  
-   [Изменение режима доступности реплики доступности (SQL Server)](change-the-availability-mode-of-an-availability-replica-sql-server.md) (автоматический переход на другой ресурс требует использовать режим доступности с синхронной фиксацией)  
  
-   [Смена режима отработки отказа для реплики доступности (SQL Server)](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
-   [Настройка гибкой политики отработки отказа для обеспечения контроля над автоматическим переходом на другой ресурс (группы доступности AlwaysOn)](configure-flexible-automatic-failover-policy.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> См. также  
  
-   [How It Works: SQL Server AlwaysOn Lease Timeout (Как это работает: время ожидания аренды AlwaysOn SQL Server)](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx)  
  
## <a name="see-also"></a>См. также:  
 [Общие сведения о группы доступности AlwaysOn &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md)   
 [Режимы доступности (группы доступности AlwaysOn)](availability-modes-always-on-availability-groups.md)   
 [Отказоустойчивость и режимы отработки отказа &#40;группы доступности AlwaysOn&#41;](failover-and-failover-modes-always-on-availability-groups.md)   
 [Отказоустойчивая кластеризация Windows Server (WSFC) с SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md)   
 [Политика отработки отказа для экземпляров откзоустойчивого кластера](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md)   
 [sp_server_diagnostics (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql)  
  
  
