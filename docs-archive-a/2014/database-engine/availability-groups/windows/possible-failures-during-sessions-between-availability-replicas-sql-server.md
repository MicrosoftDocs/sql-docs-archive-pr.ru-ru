---
title: Возможные сбои во время сеансов между репликами доступности (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- troubleshooting [SQL Server, HADR]
- Availability Groups [SQL Server], availability replicas
- Availability Groups [SQL Server], troubleshooting
ms.assetid: cd613898-82d9-482f-a255-0230a6c7d6fe
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 4cfacb7f7c75875d4f5d0b0b435d282b3f537cc7
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87734462"
---
# <a name="possible-failures-during-sessions-between-availability-replicas-sql-server"></a><span data-ttu-id="8c2e9-102">Возможные сбои во время сеансов между репликами доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="8c2e9-102">Possible Failures During Sessions Between Availability Replicas (SQL Server)</span></span>
  <span data-ttu-id="8c2e9-103">Физические неисправности, неполадки операционной системы или проблемы с [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] могут привести к сбою сеанса между двумя репликами доступности.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-103">Physical, operating system, or [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] problems can cause a failure in a session between two availability replicas.</span></span> <span data-ttu-id="8c2e9-104">Реплика доступности не выполняет регулярных проверок компонентов, которые использует процесс Sqlservr.exe, и не контролирует правильность их работы.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-104">An availability replica does not regularly check the components on which Sqlservr.exe relies to verify whether they are functioning correctly or have failed.</span></span> <span data-ttu-id="8c2e9-105">Однако при сбоях некоторых типов затронутый компонент сообщает приложению Sqlservr.exe об ошибке.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-105">However, for some types of failures, the affected component reports an error to Sqlservr.exe.</span></span> <span data-ttu-id="8c2e9-106">Ошибка, о которой сообщил другой компонент, называется *постоянной ошибкой*.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-106">An error reported by another component is called a *hard error*.</span></span> <span data-ttu-id="8c2e9-107">Чтобы обнаружить другие сбои, которые в противном случае могли бы быть не замечены, в [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] реализован собственный механизм времени ожидания сеанса.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-107">To detect other failures that would otherwise go unnoticed, [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] implements its own session-timeout mechanism.</span></span> <span data-ttu-id="8c2e9-108">Указывает интервал времени ожидания сеанса в секундах.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-108">Specifies the session-timeout period in seconds.</span></span> <span data-ttu-id="8c2e9-109">Данный интервал времени ожидания — это максимальное время, в течение которого экземпляр сервера ожидает получение сообщения PING от другого экземпляра перед тем, как сделать вывод о том, что другой экземпляр отключен.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-109">This time-out period is the maximum time that a server instance waits to receive a PING message from another instance before considering that other instance to be disconnected.</span></span> <span data-ttu-id="8c2e9-110">По истечении времени ожидания сеанса между двумя репликами доступности эти реплики доступности предполагают наличие сбоя и объявляют о *программной ошибке*.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-110">When a session timeout occurs between two availability replicas, the availability replicas assume that a failure has occurred and declares a *soft error*.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="8c2e9-111">Сбои в базах данных, отличных от баз данных-источников, не обнаруживаются.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-111">Failures in databases other than the primary database are not detectable.</span></span> <span data-ttu-id="8c2e9-112">Более того, весьма проблематично будет обнаружить сбой диска данных, если только вследствие такого сбоя база данных не перезапускается.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-112">Moreover, a data disk failure is unlikely to be detected unless the database is restarted because of a data disk failure.</span></span>  
  
 <span data-ttu-id="8c2e9-113">Время обнаружения и, следовательно, время реакции на сбой зависят от того, какой это сбой, аппаратный или программный.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-113">The speed of error detection and, therefore, the reaction time to a failure, depends on whether the error is hard or soft.</span></span> <span data-ttu-id="8c2e9-114">Отчеты о некоторых постоянных ошибках, таких как сбои в сети, отправляются немедленно.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-114">Some hard errors, such as network failures are reported immediately.</span></span> <span data-ttu-id="8c2e9-115">Однако в некоторых случаях зависящие от компонента периоды ожидания могут отложить отправку отчета о некоторых постоянных ошибках.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-115">However, in some cases, component-specific time-out periods can delay the reporting of some hard errors.</span></span> <span data-ttu-id="8c2e9-116">В случае программных ошибок продолжительность времени ожидания сеанса определяет скорость обнаружения ошибки.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-116">For soft errors, the length of the session-timeout period determines the speed of error detection.</span></span> <span data-ttu-id="8c2e9-117">По умолчанию, это период равен 10 секундам.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-117">By default, this period is 10 seconds.</span></span> <span data-ttu-id="8c2e9-118">Это минимальное рекомендуемое значение.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-118">This is the minimum recommended value.</span></span>  
  
## <a name="failures-due-to-hard-errors"></a><span data-ttu-id="8c2e9-119">Сбои из-за постоянных ошибок</span><span class="sxs-lookup"><span data-stu-id="8c2e9-119">Failures Due to Hard Errors</span></span>  
 <span data-ttu-id="8c2e9-120">Постоянные ошибки могут быть вызваны следующими причинами (но не ограничиваются ими):</span><span class="sxs-lookup"><span data-stu-id="8c2e9-120">Possible causes of hard errors include (but are not limited to) the following conditions:</span></span>  
  
-   <span data-ttu-id="8c2e9-121">физический разрыв соединения или кабеля;</span><span class="sxs-lookup"><span data-stu-id="8c2e9-121">A broken connection or wire</span></span>  
  
-   <span data-ttu-id="8c2e9-122">неисправная сетевая плата;</span><span class="sxs-lookup"><span data-stu-id="8c2e9-122">A bad network card</span></span>  
  
-   <span data-ttu-id="8c2e9-123">изменение настроек маршрутизатора;</span><span class="sxs-lookup"><span data-stu-id="8c2e9-123">A router change</span></span>  
  
-   <span data-ttu-id="8c2e9-124">изменения в конфигурации брандмауэра;</span><span class="sxs-lookup"><span data-stu-id="8c2e9-124">Changes in the firewall</span></span>  
  
-   <span data-ttu-id="8c2e9-125">изменения в конфигурации конечной точки;</span><span class="sxs-lookup"><span data-stu-id="8c2e9-125">Endpoint reconfiguration</span></span>  
  
-   <span data-ttu-id="8c2e9-126">выход из строя накопителя, на котором находятся журналы транзакций;</span><span class="sxs-lookup"><span data-stu-id="8c2e9-126">Loss of the drive where the transaction log resides</span></span>  
  
-   <span data-ttu-id="8c2e9-127">сбой операционной системы или процесса.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-127">Operating system or process failure</span></span>  
  
 <span data-ttu-id="8c2e9-128">Например, если устройство, на котором ведется журнал базы данных-источника, не отвечает и отказывает, операционная система сообщает процессу Sqlservr.exe о возникновении серьезной ошибки.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-128">For example, when the log drive on the primary database becomes unresponsive and fails, the operating system informs Sqlservr.exe that a serious error has occurred.</span></span>  
  
 <span data-ttu-id="8c2e9-129">Некоторые компоненты, например сетевые компоненты и ряд подсистем ввода-вывода, имеют собственные интервалы ожидания, предназначенные для выявления отказов.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-129">Some components, such as network components and some IO subsystems, have their own time-outs to determine failures.</span></span> <span data-ttu-id="8c2e9-130">Такие интервалы ожидания не зависят от [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], у которого совершенно нет сведений ни о них, ни об их поведении.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-130">Such time-outs are independent of [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], which has no knowledge of them and is completely unaware of their behavior.</span></span> <span data-ttu-id="8c2e9-131">В подобных случаях интервал ожидания увеличивает время между возникновением сбоя и получением репликой доступности сообщения об аппаратном сбое.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-131">In these cases, the time-out delay increases the time between a failure and when the availability replica receives the resulting hard error.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="8c2e9-132">Единственным случаем, когда для реплик доступности выполняется активная проверка на ошибки, являются случаи программных ошибок.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-132">The only active error checking performed for availability replicas occurs for soft error cases.</span></span> <span data-ttu-id="8c2e9-133">Дополнительные сведения см. в подразделе «Сбои из-за кратковременных ошибок» далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-133">For more information, see "Failures Due to Soft Errors," later in this topic.</span></span>  
  
 <span data-ttu-id="8c2e9-134">Чтобы помочь интерпретировать условия возникновения ошибок в сети, спросите у инженера сети, какие сообщения об ошибках отправляются на порт перед возникновением следующих событий в соединении TCP.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-134">To help you interpret the error conditions that occur on the network, ask a network engineer what error messages are sent to a port when the following events occur on a TCP connection:</span></span>  
  
-   <span data-ttu-id="8c2e9-135">DNS не работает.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-135">DNS is not working.</span></span>  
  
-   <span data-ttu-id="8c2e9-136">Выдернуты кабели.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-136">Cables are unplugged.</span></span>  
  
-   [!INCLUDE[msCoName](../../../includes/msconame-md.md)] <span data-ttu-id="8c2e9-137">Windows, блокирующий указанный порт.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-137">Windows has a firewall that blocks a specific port.</span></span>  
  
-   <span data-ttu-id="8c2e9-138">Ошибка приложения, наблюдающего за портом.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-138">The application that is monitoring a port fails.</span></span>  
  
-   <span data-ttu-id="8c2e9-139">Переименован сервер Windows.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-139">A Windows-based server is renamed.</span></span>  
  
-   <span data-ttu-id="8c2e9-140">Перезагружен сервер Windows.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-140">A Windows-based server is rebooted.</span></span>  
  
> [!NOTE]  
>  [!INCLUDE[ssHADRc](../../../includes/sshadrc-md.md)] <span data-ttu-id="8c2e9-141">не защищает от проблем, связанных с доступом клиентов к серверу.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-141">does not protect against problems specific to client accessing the servers.</span></span> <span data-ttu-id="8c2e9-142">Например, рассмотрите ситуацию, в которой публичный сетевой адаптер обрабатывает подключения клиентов к первичной реплике, в то время как частный сетевой интерфейс обрабатывает весь трафик экземпляров сервера, на которых размещены реплики группы доступности.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-142">For example, consider a case in which a public network adapter handles client connections to the primary replica, while a private network interface card handles traffic among the server instances that are hosting the replicas of an availability group.</span></span> <span data-ttu-id="8c2e9-143">В этом случае сбой публичного сетевого адаптера приведет к тому, что клиенты не смогут получать доступ к базе данных.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-143">In this case, failure of the public network adapter would prevent clients from accessing the databases.</span></span>  
  
## <a name="failures-due-to-soft-errors"></a><span data-ttu-id="8c2e9-144">Сбои из-за кратковременных ошибок</span><span class="sxs-lookup"><span data-stu-id="8c2e9-144">Failures Due to Soft Errors</span></span>  
 <span data-ttu-id="8c2e9-145">Условия, приводящие к превышению времени ожидания сеансов, могут быть вызваны следующими причинами (но не ограничиваться ими).</span><span class="sxs-lookup"><span data-stu-id="8c2e9-145">Conditions that might cause session timeouts include (but are not limited to) the following:</span></span>  
  
-   <span data-ttu-id="8c2e9-146">Сетевые ошибки (истечение времени ожидания канала связи TCP, пропущенные или искаженные пакеты, поступление пакетов в неверном порядке).</span><span class="sxs-lookup"><span data-stu-id="8c2e9-146">Network errors such as TCP link time-outs, dropped or corrupted packets, or packets that are in an incorrect order.</span></span>  
  
-   <span data-ttu-id="8c2e9-147">Операционная система, сервер или база данных не отвечает на запросы.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-147">An operating system, server, or database that is not responding.</span></span>  
  
-   <span data-ttu-id="8c2e9-148">Время ожидания сервера Windows.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-148">A Windows server timing out.</span></span>  
  
-   <span data-ttu-id="8c2e9-149">Нехватка вычислительных ресурсов (например, из-за перегрузки ЦП или диска, переполнения журнала транзакций, переполнения памяти или превышения числа потоков).</span><span class="sxs-lookup"><span data-stu-id="8c2e9-149">Insufficient computing resources, such as a CPU or disk overload, the transaction log filling up, or the system is running out of memory or threads.</span></span> <span data-ttu-id="8c2e9-150">В таких случаях необходимо увеличить время ожидания, снизить рабочую нагрузку или сменить оборудование, чтобы оно соответствовало задачам, выполняемым системой.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-150">In these cases, you must increase the time-out period, reduce the workload, or change the hardware to handle the workload.</span></span>  
  
### <a name="the-session-timeout-mechanism"></a><span data-ttu-id="8c2e9-151">Механизм превышения времени ожидания</span><span class="sxs-lookup"><span data-stu-id="8c2e9-151">The Session-Timeout Mechanism</span></span>  
 <span data-ttu-id="8c2e9-152">Так как экземпляр сервера не в состоянии непосредственно обнаружить программные ошибки, они потенциально могут заставить реплику доступности бесконечно ожидать ответа от другой реплики доступности в рамках сеанса.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-152">Because soft errors are not detectable directly by a server instance, a soft error could potentially cause an availability replica to wait indefinitely for a response from the other availability replica in a session.</span></span> <span data-ttu-id="8c2e9-153">Для предотвращения такого поведения в [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] используется механизм времени ожидания сеанса, основанный на том, что через определенный интервал подключенные реплики доступности отправляют команду PING по всем открытым соединениям.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-153">To prevent this, [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] implements a session time-out mechanism, based on the connected availability replicas sending out a ping on each open connection at a fixed interval.</span></span> <span data-ttu-id="8c2e9-154">Получение сообщения PING до истечения интервала ожидания указывает на то, что соединение все еще открыто, и что экземпляры сервера поддерживают связь по нему.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-154">Receiving a ping during the time-out period indicates that the connection is still open and that the server instances are communicating over it.</span></span> <span data-ttu-id="8c2e9-155">При получении сообщения PING реплика сбрасывает таймер ожидания для этого соединения.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-155">On receiving a ping, a replica resets its time-out counter on that connection.</span></span> <span data-ttu-id="8c2e9-156">Сведения о связи режима доступности и времени ожидания сеанса см. в разделе [режимы доступности (группы доступности AlwaysOn)](availability-modes-always-on-availability-groups.md).</span><span class="sxs-lookup"><span data-stu-id="8c2e9-156">For information about the relationship of availability mode and session timeouts, see [Availability Modes (AlwaysOn Availability Groups)](availability-modes-always-on-availability-groups.md).</span></span>  
  
 <span data-ttu-id="8c2e9-157">Первичная и вторичная реплики отправляют друг другу сообщения проверки связи, чтобы подтвердить свою активность, а ограничение времени ожидания сеанса исключает неограниченное ожидание одной репликой ответа от другой.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-157">The primary and secondary replicas ping each other to signal that they are still active, and a session-timeout limit prevents either replica from waiting indefinitely to receive a ping from the other replica.</span></span> <span data-ttu-id="8c2e9-158">Предельное время ожидания сеанса — это настраиваемое пользователем свойство реплики со значением по умолчанию в 10 секунд.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-158">The session-timeout limit is a user-configurable replica property with a default value of 10 seconds.</span></span> <span data-ttu-id="8c2e9-159">Получение сообщения PING до истечения интервала ожидания указывает на то, что соединение все еще открыто, и что экземпляры сервера поддерживают связь по нему.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-159">Receiving a ping during the time-out period indicates that the connection is still open and that the server instances are communicating over it.</span></span> <span data-ttu-id="8c2e9-160">После получения сообщения проверки связи реплика доступности сбрасывает счетчик времени ожидания для данного соединения.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-160">On receiving a ping, an availability replica resets its time-out counter on that connection.</span></span>  
  
 <span data-ttu-id="8c2e9-161">Если для другой реплики в течение периода ожидания сеанса не получена проверка связи, время ожидания соединения истекает. Соединение закрывается, а реплика времени ожидания переходит в ОТКЛЮЧЕНное состояние.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-161">If no ping is received from the other replica within the session-timeout period, the connection times out. The connection is closed, and the timed-out replica enters the DISCONNECTED state.</span></span> <span data-ttu-id="8c2e9-162">Даже если для отключенной реплики настроен режим синхронной фиксации, транзакции не будут ожидать ее повторного подключения и повторной синхронизации.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-162">Even if a disconnected replica is configured for synchronous-commit mode, transactions will not wait for that replica to reconnect and resynchronize.</span></span>  
  
## <a name="responding-to-an-error"></a><span data-ttu-id="8c2e9-163">Реакция на ошибку</span><span class="sxs-lookup"><span data-stu-id="8c2e9-163">Responding to an Error</span></span>  
 <span data-ttu-id="8c2e9-164">Независимо от типа ошибки, экземпляр сервера, который обнаружил ее, реагирует в соответствии с ролью экземпляра, режимом доступности сеанса и состоянием других подключений этого сеанса.</span><span class="sxs-lookup"><span data-stu-id="8c2e9-164">Regardless of the type of error, a server instance that detects an error responds appropriately based on the role of the instance, the availability mode of the session, and the state of any other connection in the session.</span></span> <span data-ttu-id="8c2e9-165">Сведения о том, что происходит при потере партнера, см. в разделе [режимы доступности (группы доступности AlwaysOn)](availability-modes-always-on-availability-groups.md).</span><span class="sxs-lookup"><span data-stu-id="8c2e9-165">For information about what occurs on the loss of a partner, see [Availability Modes (AlwaysOn Availability Groups)](availability-modes-always-on-availability-groups.md).</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="8c2e9-166">Связанные задачи</span><span class="sxs-lookup"><span data-stu-id="8c2e9-166">Related Tasks</span></span>  
 <span data-ttu-id="8c2e9-167">**Изменение значения времени ожидания (только в режиме синхронной фиксации)**</span><span class="sxs-lookup"><span data-stu-id="8c2e9-167">**To change the time-out value (synchronous-commit availability mode only)**</span></span>  
  
-   [<span data-ttu-id="8c2e9-168">Изменение периода ожидания сеанса для реплики доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="8c2e9-168">Change the Session-Timeout Period for an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-session-timeout-period-for-an-availability-replica-sql-server.md)  
  
 <span data-ttu-id="8c2e9-169">**Просмотр текущего значения времени ожидания**</span><span class="sxs-lookup"><span data-stu-id="8c2e9-169">**To view the current time-out value**</span></span>  
  
-   <span data-ttu-id="8c2e9-170">Запрос **session_timeout** в [sys.availability_replicas (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-availability-replicas-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="8c2e9-170">Query **session_timeout** in [sys.availability_replicas &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-availability-replicas-transact-sql).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="8c2e9-171">См. также:</span><span class="sxs-lookup"><span data-stu-id="8c2e9-171">See Also</span></span>  
 [<span data-ttu-id="8c2e9-172">Общие сведения о группы доступности AlwaysOn &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="8c2e9-172">Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;</span></span>](overview-of-always-on-availability-groups-sql-server.md)  
  
  
