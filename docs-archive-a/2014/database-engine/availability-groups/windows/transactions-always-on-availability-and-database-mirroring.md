---
title: Межбазовые транзакции не поддерживаются для зеркального отображения базы данных или группы доступности AlwaysOn (SQL Server) | Документация Майкрософт
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- database mirroring [SQL Server], interoperability
- cross-database transactions [SQL Server]
- transactions [database mirroring]
- Availability Groups [SQL Server], interoperability
- troubleshooting [SQL Server], cross-database transactions
ms.assetid: 9f7ed895-ad65-43e3-ba08-00d7bff1456d
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: a0e23e073375c8f00317003635df8ec0b69883cd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87750180"
---
# <a name="cross-database-transactions-not-supported-for-database-mirroring-or-alwayson-availability-groups-sql-server"></a><span data-ttu-id="6312c-102">Транзакции между базами данных не поддерживаются при зеркальном отображении баз данных или в группах доступности AlwaysOn (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="6312c-102">Cross-Database Transactions Not Supported For Database Mirroring or AlwaysOn Availability Groups (SQL Server)</span></span>
  <span data-ttu-id="6312c-103">Транзакции между базами данных и распределенные транзакции не поддерживаются ни [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], ни зеркальным отображением баз данных.</span><span class="sxs-lookup"><span data-stu-id="6312c-103">Cross-database transactions and distributed transactions are not supported by [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] or by database mirroring.</span></span> <span data-ttu-id="6312c-104">вследствие того, что атомарность/целостность транзакции не может быть гарантирована по следующим причинам.</span><span class="sxs-lookup"><span data-stu-id="6312c-104">This is because transaction atomicity/integrity cannot be guaranteed for the following reasons:</span></span>  
  
-   <span data-ttu-id="6312c-105">Для транзакций между базами данных: каждая база данных фиксируется независимо друг от друга.</span><span class="sxs-lookup"><span data-stu-id="6312c-105">For cross-database transactions: Each database commits independently.</span></span> <span data-ttu-id="6312c-106">Поэтому даже в случае с базами данных в одной группе доступности, отработка отказа может произойти после того как одна база данных применит транзакцию, а в другой базе данных она еще не была применена.</span><span class="sxs-lookup"><span data-stu-id="6312c-106">Therefore, even for databases in a single availability group, a failover could occur after one database commits a transaction but before the other database does.</span></span> <span data-ttu-id="6312c-107">В случае с зеркальным отображением баз данных этот вопрос вызывает сложности, поскольку при отработке отказа отображаемая база данных обычно находится на другом экземпляре сервера, и даже если обе базы данных зеркально отображаются между двумя одинаковыми партнерами, нет гарантии, что обе базы данных будут переключены на резервный ресурс в одно и то же время.</span><span class="sxs-lookup"><span data-stu-id="6312c-107">For database mirroring this issue is compounded because after a failover, the mirrored database is typically on a different server instance from the other database, and  even if both databases are mirrored between the same two partners, there is no guarantee that both databases will fail over at the same time.</span></span>  
  
-   <span data-ttu-id="6312c-108">Для распределенных транзакций: после отработки отказа новому основному серверу или первичной реплике не удается подключиться к координатору распределенных транзакций на предыдущем основном сервере или первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="6312c-108">For distributed transactions: After a failover, the new principal server/primary replica is unable to connect to the distributed transaction coordinator on the previous principal server/primary replica.</span></span> <span data-ttu-id="6312c-109">Поэтому новый основной сервер/основная реплика не сможет получить состояние транзакции.</span><span class="sxs-lookup"><span data-stu-id="6312c-109">Therefore, the new principal server/primary replica cannot obtain the transaction status.</span></span>  
  
 <span data-ttu-id="6312c-110">В следующем примере зеркального отображения базы данных показано, как возникает логическое несоответствие.</span><span class="sxs-lookup"><span data-stu-id="6312c-110">The following database mirroring example illustrates how a logical inconsistency could occur.</span></span> <span data-ttu-id="6312c-111">В этом примере приложение использует межбазовую транзакцию для вставки двух строк данных: одна строка вставляется в таблицу зеркально отображаемой базы данных A, другая — в таблицу второй базы данных, B. База данных A зеркально отображается в режиме высокого уровня безопасности с автоматической отработкой отказа.</span><span class="sxs-lookup"><span data-stu-id="6312c-111">In this example, an application uses a cross-database transaction to insert two rows of data: one row is inserted into a table in a mirrored database, A, and the other row is inserted into a table in another database, B. Database A is being mirrored in high-safety mode with automatic failover.</span></span> <span data-ttu-id="6312c-112">При фиксации транзакции база данных A становится недоступной, и сеанс зеркального отображения автоматически переходит на зеркальное отображение базы данных A.</span><span class="sxs-lookup"><span data-stu-id="6312c-112">While the transaction is being committed, database A becomes unavailable, and the mirroring session automatically fails over to the mirror of database A.</span></span>  
  
 <span data-ttu-id="6312c-113">После автоматической отработки отказа межбазовая транзакция может успешно зафиксироваться в базе данных B, но не в базе данных, с которой выполнен автоматический переход.</span><span class="sxs-lookup"><span data-stu-id="6312c-113">After the failover, the cross-database transaction might be successfully committed on database B but not on the failed-over database.</span></span> <span data-ttu-id="6312c-114">Это случится, если исходный основной сервер для базы данных А перед переходом не отправил журнал межбазовых транзакций на зеркальный сервер.</span><span class="sxs-lookup"><span data-stu-id="6312c-114">This would occur if the original principal server for database A had not sent the log for the cross-database transaction to the mirror server before the failure.</span></span> <span data-ttu-id="6312c-115">После автоматической отработки отказа эта транзакция не будет существовать на новом основном сервере.</span><span class="sxs-lookup"><span data-stu-id="6312c-115">After the failover, that transaction would not exist on the new principal server.</span></span> <span data-ttu-id="6312c-116">Базы данных A и B станут несогласованными, поскольку вставленные данные в базе данных B останутся нетронутыми, в то время как вставленные данные в базе данных A будут потеряны.</span><span class="sxs-lookup"><span data-stu-id="6312c-116">Databases A and B would become inconsistent, because the data inserted in database B remains intact, but the data inserted in database A has been lost.</span></span>  
  
 <span data-ttu-id="6312c-117">Похожее может произойти при использовании транзакций MS DTC.</span><span class="sxs-lookup"><span data-stu-id="6312c-117">A similar scenario can occur while using a MS DTC transaction.</span></span> <span data-ttu-id="6312c-118">Например, после автоматической отработки отказа новая основная база данных обращается к MS DTC.</span><span class="sxs-lookup"><span data-stu-id="6312c-118">For example, after failover, the new principal contacts MS DTC.</span></span> <span data-ttu-id="6312c-119">Но MS DTC не знает о новом основном сервере и завершает все транзакции, готовящиеся к фиксации, которые считаются зафиксированными в других базах данных.</span><span class="sxs-lookup"><span data-stu-id="6312c-119">But MS DTC has no knowledge of the new principal server, and it terminates any transactions that are "preparing to commit," which are considered committed in other databases.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6312c-120">Использование зеркального отображения базы данных или групп доступности вместе с DTC не приводит к неподдерживаемой установке SQL Server.</span><span class="sxs-lookup"><span data-stu-id="6312c-120">Using Database Mirroring or Availability Groups together with DTC does not result in an unsupported SQL Server installation.</span></span> <span data-ttu-id="6312c-121">Однако, если база данных является частью сеанса зеркального отображения базы данных или группы доступности и в базе данных также используется DTC, проблемы поддержки будут исследованы Microsoft только в случае, если они не имеют отношения к совместному использованию зеркального отображения базы данных или групп доступности вместе с DTC.</span><span class="sxs-lookup"><span data-stu-id="6312c-121">If, however, a database is part of a Database Mirroring session or an Availability Group and DTC is also used in the database, support issues will be investigated by Microsoft only if unrelated to the combined use of Database Mirroring or Availability Groups with DTC.</span></span>  
  
  
