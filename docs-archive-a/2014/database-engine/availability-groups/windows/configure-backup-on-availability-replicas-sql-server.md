---
title: Настройка резервного копирования в репликах доступности (SQL Server) | Документы Майкрософт
ms.custom: ''
ms.date: 06/14/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- backup priority
- backup on secondary replicas
- Availability Groups [SQL Server], availability replicas
- Availability Groups [SQL Server], backup on secondary replicas
- active secondary replicas [SQL Server], backup on
- automated backup preference
- Availability Groups [SQL Server], active secondary replicas
ms.assetid: 74bc40bb-9f57-44e4-8988-1d69c0585eb6
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 91a781d957eb2f5a81d323fc3c65c93e34945c12
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87750207"
---
# <a name="configure-backup-on-availability-replicas-sql-server"></a><span data-ttu-id="4a435-102">Настройка резервного копирования в репликах доступности (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="4a435-102">Configure Backup on Availability Replicas (SQL Server)</span></span>
  <span data-ttu-id="4a435-103">В этом разделе описывается настройка резервной копии вторичной реплики для группы доступности AlwaysOn с помощью среды [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)]или PowerShell в [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="4a435-103">This topic describes how to configure backup on secondary replicas for an AlwaysOn availability group by using [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)], or PowerShell in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="4a435-104">Общие сведения о резервном копировании на вторичных репликах см. [в статье Active Secondary: резервное копирование во вторичных репликах (группы доступности AlwaysOn)](active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md).</span><span class="sxs-lookup"><span data-stu-id="4a435-104">For an introduction to backup on secondary replicas, see [Active Secondaries: Backup on Secondary Replicas (AlwaysOn Availability Groups)](active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md).</span></span>  
  
 
  

  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> <span data-ttu-id="4a435-105">Перед началом</span><span class="sxs-lookup"><span data-stu-id="4a435-105">Before You Begin</span></span>  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a> <span data-ttu-id="4a435-106">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="4a435-106">Prerequisites</span></span>  
 <span data-ttu-id="4a435-107">Необходимо подключиться к экземпляру сервера, на котором размещена первичная реплика.</span><span class="sxs-lookup"><span data-stu-id="4a435-107">You must be connected to the server instance that hosts the primary replica.</span></span>  
  
###  <a name="security"></a><a name="Security"></a> <span data-ttu-id="4a435-108">безопасность</span><span class="sxs-lookup"><span data-stu-id="4a435-108">Security</span></span>  
  
####  <a name="permissions"></a><a name="Permissions"></a> <span data-ttu-id="4a435-109">Permissions</span><span class="sxs-lookup"><span data-stu-id="4a435-109">Permissions</span></span>  
  
|<span data-ttu-id="4a435-110">Задача</span><span class="sxs-lookup"><span data-stu-id="4a435-110">Task</span></span>|<span data-ttu-id="4a435-111">Разрешения</span><span class="sxs-lookup"><span data-stu-id="4a435-111">Permissions</span></span>|  
|----------|-----------------|  
|<span data-ttu-id="4a435-112">Настройка резервного копирования во вторичных репликах при создании группы доступности</span><span class="sxs-lookup"><span data-stu-id="4a435-112">To configure backup on secondary replicas when creating an availability group</span></span>|<span data-ttu-id="4a435-113">Требуется членство в фиксированной роли сервера **sysadmin** и одно из разрешений: CREATE AVAILABILITY GROUP, ALTER ANY AVAILABILITY GROUP или CONTROL SERVER.</span><span class="sxs-lookup"><span data-stu-id="4a435-113">Requires membership in the **sysadmin** fixed server role and either CREATE AVAILABILITY GROUP server permission, ALTER ANY AVAILABILITY GROUP permission, or CONTROL SERVER permission.</span></span>|  
|<span data-ttu-id="4a435-114">Изменение группы доступности или реплики доступности</span><span class="sxs-lookup"><span data-stu-id="4a435-114">To modify an availability group or availability replica</span></span>|<span data-ttu-id="4a435-115">Необходимо разрешение ALTER AVAILABILITY GROUP для группы доступности, разрешение CONTROL AVAILABILITY GROUP, разрешение ALTER ANY AVAILABILITY GROUP или разрешение CONTROL SERVER.</span><span class="sxs-lookup"><span data-stu-id="4a435-115">Requires ALTER AVAILABILITY GROUP permission on the availability group, CONTROL AVAILABILITY GROUP permission, ALTER ANY AVAILABILITY GROUP permission, or CONTROL SERVER permission.</span></span>|  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> <span data-ttu-id="4a435-116">Использование среды SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="4a435-116">Using SQL Server Management Studio</span></span>  
 <span data-ttu-id="4a435-117">**Настройка резервного копирования во вторичных репликах**</span><span class="sxs-lookup"><span data-stu-id="4a435-117">**To configure backup on secondary replicas**</span></span>  
  
1.  <span data-ttu-id="4a435-118">В обозревателе объектов подключитесь к экземпляру сервера, на котором размещена первичная реплика, и щелкните имя сервера, чтобы развернуть его дерево.</span><span class="sxs-lookup"><span data-stu-id="4a435-118">In Object Explorer, connect to the server instance that hosts the primary replica, and click the server name to expand the server tree.</span></span>  
  
2.  <span data-ttu-id="4a435-119">Разверните узел **Высокий уровень доступности AlwaysOn** и узел **Группы доступности** .</span><span class="sxs-lookup"><span data-stu-id="4a435-119">Expand the **AlwaysOn High Availability** node and the **Availability Groups** node.</span></span>  
  
3.  <span data-ttu-id="4a435-120">Щелкните группу доступности, для которой нужно задать параметры резервного копирования, и выберите команду **Свойства** .</span><span class="sxs-lookup"><span data-stu-id="4a435-120">Click the availability group whose backup preferences you want to configure, and select the **Properties** command.</span></span>  
  
4.  <span data-ttu-id="4a435-121">В диалоговом окне **Свойства групп доступности** перейдите на страницу **Настройки резервного копирования** .</span><span class="sxs-lookup"><span data-stu-id="4a435-121">In the **Availability Group Properties** dialog box, select **Backup Preferences** page.</span></span>  
  
5.  <span data-ttu-id="4a435-122">На панели **Где должно происходить резервное копирование?** выберите один из способов автоматизированного резервного копирования для группы доступности:</span><span class="sxs-lookup"><span data-stu-id="4a435-122">On the **Where should backups occur?** panel, select the automated backup preference for the availability group, one of:</span></span>  
  
     <span data-ttu-id="4a435-123">**Предпочтение вторичной**</span><span class="sxs-lookup"><span data-stu-id="4a435-123">**Prefer Secondary**</span></span>  
     <span data-ttu-id="4a435-124">Указывает, что резервное копирование должно выполняться на вторичной реплике, за исключением тех случаев, когда в режиме «в сети» находится только первичная реплика.</span><span class="sxs-lookup"><span data-stu-id="4a435-124">Specifies that backups should occur on a secondary replica except when the primary replica is the only replica online.</span></span> <span data-ttu-id="4a435-125">В этом случае резервное копирование будет выполняться на первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="4a435-125">In that case, the backup should occur on the primary replica.</span></span> <span data-ttu-id="4a435-126">Это параметр по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="4a435-126">This is the default option.</span></span>  
  
     <span data-ttu-id="4a435-127">**Только вторичная**</span><span class="sxs-lookup"><span data-stu-id="4a435-127">**Secondary only**</span></span>  
     <span data-ttu-id="4a435-128">Указывает, что резервное копирование никогда не выполняется на первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="4a435-128">Specifies that backups should never be performed on the primary replica.</span></span> <span data-ttu-id="4a435-129">Если первичная реплика является единственной репликой, находящейся в режиме «в сети», резервное копирование не будет выполняться.</span><span class="sxs-lookup"><span data-stu-id="4a435-129">If the primary replica is the only replica online, the backup should not occur.</span></span>  
  
     `Primary`  
     <span data-ttu-id="4a435-130">Указывает, что резервное копирования должно всегда выполняться на первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="4a435-130">Specifies that the backups should always occur on the primary replica.</span></span> <span data-ttu-id="4a435-131">Данный параметр является полезным, если вам требуются такие функции резервного копирования, как создание разностных резервных копий, которые не поддерживаются при выполнении резервного копирования на вторичной реплике.</span><span class="sxs-lookup"><span data-stu-id="4a435-131">This option is useful if you need backup features, such as creating differential backups, that are not supported when backup is run on a secondary replica.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="4a435-132">Если планируется использовать доставку журналов для подготовки баз данных-получателей для группы доступности, задайте параметру автоматизированного резервного копирования значение `Primary` до тех пор, пока все базы данные-получатели не будут подготовлены и присоединены к группе доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-132">If you plan to use log shipping to prepare any secondary databases for an availability group, set the automated backup preference to `Primary` until all the secondary databases have been prepared and joined to the availability group.</span></span>  
  
     <span data-ttu-id="4a435-133">**Любая реплика**</span><span class="sxs-lookup"><span data-stu-id="4a435-133">**Any Replica**</span></span>  
     <span data-ttu-id="4a435-134">Указывает, что вы предпочитаете, чтобы задания резервного копирования пропускали реплики доступности при выборе реплики для создания резервных копий.</span><span class="sxs-lookup"><span data-stu-id="4a435-134">Specifies that you prefer that backup jobs ignore the role of the availability replicas when choosing the replica to perform backups.</span></span> <span data-ttu-id="4a435-135">Примечание. Задания резервного копирования могут учитывать другие факторы, например приоритет резервного копирования каждой реплики доступности в сочетании с ее состоянием работоспособности и подключения.</span><span class="sxs-lookup"><span data-stu-id="4a435-135">Note backup jobs might evaluate other factors such as backup priority of each availability replica in combination with its operational state and connected state.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="4a435-136">Принудительного применения параметра автоматического резервного копирования не существует.</span><span class="sxs-lookup"><span data-stu-id="4a435-136">There is no enforcement of the automated backup preference setting.</span></span> <span data-ttu-id="4a435-137">Интерпретация данного приоритета зависит от логики (при ее наличии), которая внесена в задания резервного копирования для баз данных в указанной группе доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-137">The interpretation of this preference depends on the logic, if any, that you script into backup jobs for the databases in a given availability group.</span></span> <span data-ttu-id="4a435-138">Параметр автоматического резервного копирования не влияет на выполнение нерегламентированного резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4a435-138">The automated backup preference setting has no impact on ad-hoc backups.</span></span> <span data-ttu-id="4a435-139">Дополнительные сведения см. далее в разделе [Дальнейшие действия. После настройки резервного копирования во вторичных репликах](#FollowUp) .</span><span class="sxs-lookup"><span data-stu-id="4a435-139">For more information, see [Follow Up: After Configuring Backup on Secondary Replicas](#FollowUp) later in this topic.</span></span>  
  
6.  <span data-ttu-id="4a435-140">Сетка **Настройки резервного копирования реплики** позволяет изменить приоритет резервного копирования для группы доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-140">Use the **Replica backup priorities** grid to change the backup priority of the availability replicas.</span></span> <span data-ttu-id="4a435-141">В этой сетке отображается текущий приоритет резервного копирования каждого экземпляра сервера, на котором размещена реплика, входящая в данную группу доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-141">This grid displays the current backup priority of each server instance that hosts a replica for the availability group.</span></span> <span data-ttu-id="4a435-142">Сетка содержит следующие столбцы.</span><span class="sxs-lookup"><span data-stu-id="4a435-142">The grid columns are as follows:</span></span>  
  
     <span data-ttu-id="4a435-143">**Экземпляр сервера**</span><span class="sxs-lookup"><span data-stu-id="4a435-143">**Server Instance**</span></span>  
     <span data-ttu-id="4a435-144">Имя экземпляра [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , в котором размещается группа доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-144">The name of the instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] that hosts the availability replica.</span></span>  
  
     <span data-ttu-id="4a435-145">**Приоритет резервного копирования (низкий = 1, высокий = 100)**</span><span class="sxs-lookup"><span data-stu-id="4a435-145">**Backup Priority (Lowest=1, Highest=100)**</span></span>  
     <span data-ttu-id="4a435-146">Указывает приоритет выполнения резервного копирования на данной реплике по отношению к другим репликам из той же группы доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-146">Specifies your priority for performing backups on this replica relative to the other replicas in the same availability group.</span></span> <span data-ttu-id="4a435-147">Значение представляет собой целое число в диапазоне от 0 до 100.</span><span class="sxs-lookup"><span data-stu-id="4a435-147">The value is an integer in the range of 0..100.</span></span> <span data-ttu-id="4a435-148">1 указывает минимальный приоритет, 100 — наивысший приоритет.</span><span class="sxs-lookup"><span data-stu-id="4a435-148">1 indicates the lowest priority, and 100 indicates the highest priority.</span></span> <span data-ttu-id="4a435-149">Если **Backup Priority** = 1, реплика доступности будет выбрана для создания резервных копий только в случае, если реплики доступности с более высоким приоритетом отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="4a435-149">If **Backup Priority** = 1, the availability replica would be chosen for performing backups only if no higher priority availability replicas are currently available.</span></span>  
  
     <span data-ttu-id="4a435-150">**Исключить реплику**</span><span class="sxs-lookup"><span data-stu-id="4a435-150">**Exclude Replica**</span></span>  
     <span data-ttu-id="4a435-151">Установите этот параметр, чтобы реплика никогда не выбиралась для выполнения резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4a435-151">Select if you never want this availability replica to be chosen for performing backups.</span></span> <span data-ttu-id="4a435-152">Этот параметр может быть полезным, например, для исключения удаленной реплики доступности, создание резервных копий на которой нежелательно.</span><span class="sxs-lookup"><span data-stu-id="4a435-152">This is useful, for example, for a remote availability replica to which you never want backups to fail over.</span></span>  
  
7.  <span data-ttu-id="4a435-153">Для фиксации изменений нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="4a435-153">To commit your changes, click **OK**.</span></span>  
  
 <span data-ttu-id="4a435-154">**Альтернативные пути доступа к странице настройки резервного копирования**</span><span class="sxs-lookup"><span data-stu-id="4a435-154">**Alternative ways to access the Backup Preferences page**</span></span>  
  
-   [<span data-ttu-id="4a435-155">Использование диалогового окна "Создание группы доступности" (среда SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="4a435-155">Use the New Availability Group Dialog Box &#40;SQL Server Management Studio&#41;</span></span>](use-the-new-availability-group-dialog-box-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="4a435-156">Использование мастера добавления реплики в группу доступности (среда SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="4a435-156">Use the Add Replica to Availability Group Wizard &#40;SQL Server Management Studio&#41;</span></span>](use-the-add-replica-to-availability-group-wizard-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="4a435-157">Использование диалогового окна "Создание группы доступности" (среда SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="4a435-157">Use the New Availability Group Dialog Box &#40;SQL Server Management Studio&#41;</span></span>](use-the-new-availability-group-dialog-box-sql-server-management-studio.md)  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> <span data-ttu-id="4a435-158">Использование Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="4a435-158">Using Transact-SQL</span></span>  
 <span data-ttu-id="4a435-159">**Настройка резервного копирования во вторичных репликах**</span><span class="sxs-lookup"><span data-stu-id="4a435-159">**To configure backup on secondary replicas**</span></span>  
  
1.  <span data-ttu-id="4a435-160">Подключитесь к экземпляру сервера, на котором находится первичная реплика.</span><span class="sxs-lookup"><span data-stu-id="4a435-160">Connect to the server instance that hosts the primary replica.</span></span>  
  
2.  <span data-ttu-id="4a435-161">Для новой группы доступности используйте инструкцию [CREATE AVAILABILITY GROUP (Transact-SQL)](/sql/t-sql/statements/create-availability-group-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4a435-161">For a new availability group, use the [CREATE AVAILABILITY GROUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-availability-group-transact-sql) statement.</span></span> <span data-ttu-id="4a435-162">При добавлении или изменении существующей группы доступности воспользуйтесь инструкцией [ALTER AVAILABILITY GROUP (Transact-SQL)](/sql/t-sql/statements/alter-availability-group-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4a435-162">If you are modifying an existing availability group, use the [ALTER AVAILABILITY GROUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-availability-group-transact-sql) statement.</span></span>  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> <span data-ttu-id="4a435-163">Использование PowerShell</span><span class="sxs-lookup"><span data-stu-id="4a435-163">Using PowerShell</span></span>  

### <a name="to-configure-backup-on-secondary-replicas"></a><span data-ttu-id="4a435-164">Настройка резервного копирования во вторичных репликах</span><span class="sxs-lookup"><span data-stu-id="4a435-164">To configure backup on secondary replicas</span></span>
  
1.  <span data-ttu-id="4a435-165">Установите значение по умолчанию (`cd`) равным серверу экземпляра, на котором размещена первичная реплика.</span><span class="sxs-lookup"><span data-stu-id="4a435-165">Set default (`cd`) to the server instance that hosts the primary replica.</span></span>  
  
2.  <span data-ttu-id="4a435-166">При необходимости настройте приоритет каждой реплики доступности, которую необходимо добавить или изменить.</span><span class="sxs-lookup"><span data-stu-id="4a435-166">Optionally, configure the backup priority of each availability replica that you are adding or modifying.</span></span> <span data-ttu-id="4a435-167">Этот приоритет используется экземпляром сервера, на котором размещается первичная реплика, при принятии решения о том, какая реплика должна обработать запрос автоматического резервного копирования для базы данных в группе доступности (выбирается реплика с максимальным приоритетом).</span><span class="sxs-lookup"><span data-stu-id="4a435-167">This priority is used by the server instance that hosts the primary replica to decide which replica should service an automated backup request on a database in the availability group (the replica with highest priority is chosen).</span></span> <span data-ttu-id="4a435-168">Значением приоритета может быть любое целое число от 0 до 100 включительно.</span><span class="sxs-lookup"><span data-stu-id="4a435-168">This priority can be any number between 0 and 100, inclusive.</span></span> <span data-ttu-id="4a435-169">Приоритет 0 указывает, что реплика не должна считаться кандидатом на обработку запросов резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4a435-169">A priority of 0 indicates that the replica should not be considered as a candidate for servicing backup requests.</span></span>  <span data-ttu-id="4a435-170">Значение по умолчанию — 50.</span><span class="sxs-lookup"><span data-stu-id="4a435-170">The default setting is 50.</span></span>  
  
     <span data-ttu-id="4a435-171">При добавлении реплики доступности в группу доступности воспользуйтесь командлетом `New-SqlAvailabilityReplica`.</span><span class="sxs-lookup"><span data-stu-id="4a435-171">When adding an availability replica to an availability group, use the `New-SqlAvailabilityReplica` cmdlet.</span></span> <span data-ttu-id="4a435-172">При изменении существующей реплики доступности воспользуйтесь командлетом `Set-SqlAvailabilityReplica`.</span><span class="sxs-lookup"><span data-stu-id="4a435-172">When modifying an existing availability replica, use the `Set-SqlAvailabilityReplica` cmdlet.</span></span> <span data-ttu-id="4a435-173">В любом случае укажите `BackupPriority` параметр *n* , где *n* — значение от 0 до 100.</span><span class="sxs-lookup"><span data-stu-id="4a435-173">In either case, specify the `BackupPriority`*n* parameter, where *n* is a value from 0 to 100.</span></span>  
  
     <span data-ttu-id="4a435-174">Например, следующая команда присваивает приоритету резервного копирования реплики доступности `MyReplica` значение `60`.</span><span class="sxs-lookup"><span data-stu-id="4a435-174">For example, the following command sets the backup priority of the availability replica `MyReplica` to `60`.</span></span>  
  
    ```powershell
    Set-SqlAvailabilityReplica -BackupPriority 60 -Path SQLSERVER:\Sql\Computer\Instance\AvailabilityGroups\MyAg\AvailabilityReplicas\MyReplica  
    ```  
  
3.  <span data-ttu-id="4a435-175">Также настройте приоритет автоматического резервного копирования для группы доступности, которая создается или изменяется.</span><span class="sxs-lookup"><span data-stu-id="4a435-175">Optionally, configure the automated backup preference for the availability group that you are creating  or modifying.</span></span> <span data-ttu-id="4a435-176">Этот параметр указывает, как задание резервного копирования вычисляет первичную реплику при выборе места для создания резервных копий.</span><span class="sxs-lookup"><span data-stu-id="4a435-176">This preference indicates how a backup job should evaluate the primary replica when choosing where to perform backups.</span></span> <span data-ttu-id="4a435-177">Значение по умолчанию предпочитают вторичные реплики.</span><span class="sxs-lookup"><span data-stu-id="4a435-177">The default setting is to prefer secondary replicas.</span></span>  
  
     <span data-ttu-id="4a435-178">При создании группы доступности используйте командлет `New-SqlAvailabilityGroup`.</span><span class="sxs-lookup"><span data-stu-id="4a435-178">When creating an availability group, use the `New-SqlAvailabilityGroup` cmdlet.</span></span> <span data-ttu-id="4a435-179">При изменении существующей группы доступности воспользуйтесь командлетом `Set-SqlAvailabilityGroup`.</span><span class="sxs-lookup"><span data-stu-id="4a435-179">When modifying an existing availability group, use the `Set-SqlAvailabilityGroup` cmdlet.</span></span> <span data-ttu-id="4a435-180">В любом случае укажите параметр `AutomatedBackupPreference`.</span><span class="sxs-lookup"><span data-stu-id="4a435-180">In either case, specify the `AutomatedBackupPreference` parameter.</span></span>  
  
     <span data-ttu-id="4a435-181">где</span><span class="sxs-lookup"><span data-stu-id="4a435-181">where,</span></span>  
  
     `Primary`  
     <span data-ttu-id="4a435-182">Указывает, что резервное копирования должно всегда выполняться на первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="4a435-182">Specifies that the backups should always occur on the primary replica.</span></span> <span data-ttu-id="4a435-183">Данный параметр является полезным, если вам требуются такие функции резервного копирования, как создание разностных резервных копий, которые не поддерживаются при выполнении резервного копирования на вторичной реплике.</span><span class="sxs-lookup"><span data-stu-id="4a435-183">This option is useful if you need backup features, such as creating differential backups, that are not supported when backup is run on a secondary replica.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="4a435-184">Если планируется использовать доставку журналов для подготовки баз данных-получателей для группы доступности, задайте параметру автоматизированного резервного копирования значение `Primary` до тех пор, пока все базы данные-получатели не будут подготовлены и присоединены к группе доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-184">If you plan to use log shipping to prepare any secondary databases for an availability group, set the automated backup preference to `Primary` until all the secondary databases have been prepared and joined to the availability group.</span></span>  
  
     `SecondaryOnly`  
     <span data-ttu-id="4a435-185">Указывает, что резервное копирование никогда не выполняется на первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="4a435-185">Specifies that backups should never be performed on the primary replica.</span></span> <span data-ttu-id="4a435-186">Если первичная реплика является единственной репликой, находящейся в режиме «в сети», резервное копирование не будет выполняться.</span><span class="sxs-lookup"><span data-stu-id="4a435-186">If the primary replica is the only replica online, the backup should not occur.</span></span>  
  
     `Secondary`  
     <span data-ttu-id="4a435-187">Указывает, что резервное копирование должно выполняться на вторичной реплике, за исключением тех случаев, когда в режиме «в сети» находится только первичная реплика.</span><span class="sxs-lookup"><span data-stu-id="4a435-187">Specifies that backups should occur on a secondary replica except when the primary replica is the only replica online.</span></span> <span data-ttu-id="4a435-188">В этом случае резервное копирование будет выполняться на первичной реплике.</span><span class="sxs-lookup"><span data-stu-id="4a435-188">In that case, the backup should occur on the primary replica.</span></span> <span data-ttu-id="4a435-189">Это поведение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="4a435-189">This is the default behavior.</span></span>  
  
     `None`  
     <span data-ttu-id="4a435-190">Указывает, что вы предпочитаете, чтобы задания резервного копирования пропускали реплики доступности при выборе реплики для создания резервных копий.</span><span class="sxs-lookup"><span data-stu-id="4a435-190">Specifies that you prefer that backup jobs ignore the role of the availability replicas when choosing the replica to perform backups.</span></span> <span data-ttu-id="4a435-191">Примечание. Задания резервного копирования могут учитывать другие факторы, например приоритет резервного копирования каждой реплики доступности в сочетании с ее состоянием работоспособности и соединения.</span><span class="sxs-lookup"><span data-stu-id="4a435-191">Note backup jobs might evaluate other factors such as backup priority of each availability replica in combination with its operational state and  connected state.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="4a435-192">Параметр `AutomatedBackupPreference` не вводится в действие принудительно.</span><span class="sxs-lookup"><span data-stu-id="4a435-192">There is no enforcement of `AutomatedBackupPreference`.</span></span> <span data-ttu-id="4a435-193">Интерпретация данного приоритета зависит от логики (при ее наличии), которая внесена в задания резервного копирования для баз данных в указанной группе доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-193">The interpretation of this preference depends on the logic, if any, that you script into backup jobs for the databases in a given availability group.</span></span> <span data-ttu-id="4a435-194">Параметр автоматического резервного копирования не влияет на выполнение нерегламентированного резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4a435-194">The automated backup preference setting has no impact on ad-hoc backups.</span></span> <span data-ttu-id="4a435-195">Дополнительные сведения см. далее в разделе [Дальнейшие действия. После настройки резервного копирования во вторичных репликах](#FollowUp) .</span><span class="sxs-lookup"><span data-stu-id="4a435-195">For more information, see [Follow Up: After Configuring Backup on Secondary Replicas](#FollowUp) later in this topic.</span></span>  
  
     <span data-ttu-id="4a435-196">Например, следующая команда задает свойству `AutomatedBackupPreference` группы доступности `MyAg` значение `SecondaryOnly`.</span><span class="sxs-lookup"><span data-stu-id="4a435-196">For example, the following command sets the `AutomatedBackupPreference` property on the availability group `MyAg` to `SecondaryOnly`.</span></span> <span data-ttu-id="4a435-197">Автоматическое резервное копирование баз данных в этой группе доступности никогда не будет выполняться в первичной реплике, а будет перенаправляться на вторичную реплику с наивысшим приоритетом резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4a435-197">Automated backups of databases in this availability group will never occur on the primary replica, but will be redirected to the secondary replica with the highest backup priority setting.</span></span>  
  
    ```powershell
    Set-SqlAvailabilityGroup -Path SQLSERVER:\Sql\PrimaryServer\InstanceName\AvailabilityGroups\MyAg `  
     -AutomatedBackupPreference SecondaryOnly  
    ```  
  
> [!NOTE]  
>  <span data-ttu-id="4a435-198">Чтобы просмотреть синтаксис командлета, воспользуйтесь командлетом `Get-Help` в среде [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell.</span><span class="sxs-lookup"><span data-stu-id="4a435-198">To view the syntax of a cmdlet, use the `Get-Help` cmdlet in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell environment.</span></span> <span data-ttu-id="4a435-199">Дополнительные сведения см. в разделе [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span><span class="sxs-lookup"><span data-stu-id="4a435-199">For more information, see [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span></span>  
  
<span data-ttu-id="4a435-200">Чтобы настроить и использовать поставщик SQL Server PowerShell, см. статью [SQL Server PowerShell Provider](../../../powershell/sql-server-powershell-provider.md) и [Получение справки SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span><span class="sxs-lookup"><span data-stu-id="4a435-200">To set up and use the SQL Server PowerShell provider, see [SQL Server PowerShell Provider](../../../powershell/sql-server-powershell-provider.md) and [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span></span>
  
##  <a name="follow-up-after-configuring-backup-on-secondary-replicas"></a><a name="FollowUp"></a><span data-ttu-id="4a435-201">Дальнейшие действия. После настройки резервного копирования во вторичных репликах</span><span class="sxs-lookup"><span data-stu-id="4a435-201">Follow Up: After Configuring Backup on Secondary Replicas</span></span>  
 <span data-ttu-id="4a435-202">Чтобы настройка автоматического резервного копирования учитывалась для данной группы доступности на каждом экземпляре сервера, где размещена реплика доступности, приоритет резервного копирования которой больше нуля (>0), необходимо создать скрипты заданий резервного копирования для баз данных в группе доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-202">To take the automated backup preference into account for a given availability group, on each server instance that hosts an availability replica whose backup priority is greater than zero (>0), you need to script backup jobs for the databases in the availability group.</span></span> <span data-ttu-id="4a435-203">Чтобы определить, является ли текущая реплика предпочитаемой репликой резервного копирования, выполните функцию [sys.fn_hadr_backup_is_preferred_replica](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) в скрипте резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4a435-203">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function in your backup script.</span></span> <span data-ttu-id="4a435-204">Если реплика доступности, размещенная на текущем экземпляре сервера, является предпочтительной для резервного копирования, эта функция возвращает значение 1.</span><span class="sxs-lookup"><span data-stu-id="4a435-204">If the availability replica that is hosted by the current server instance is the preferred replica for backups, this function returns 1.</span></span> <span data-ttu-id="4a435-205">В противном случае функция возвращает значение 0.</span><span class="sxs-lookup"><span data-stu-id="4a435-205">If not, the function returns 0.</span></span> <span data-ttu-id="4a435-206">С помощью простого скрипта для каждой реплики доступности, который запрашивает эту функцию, можно определить, какая реплика должна выполнять данное задание резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="4a435-206">By running a simple script on each availability replica that queries this function, you can determine which replica should run a given backup job.</span></span> <span data-ttu-id="4a435-207">Например, типичный фрагмент скрипта задания резервного копирования выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="4a435-207">For example, a typical snippet of a backup-job script would look like:</span></span>  
  
```  
IF (NOT sys.fn_hadr_backup_is_preferred_replica(@DBNAME))  
BEGIN  
      Select 'This is not the preferred replica, exiting with success';  
      RETURN 0 - This is a normal, expected condition, so the script returns success  
END  
BACKUP DATABASE @DBNAME TO DISK=<disk>  
   WITH COPY_ONLY;  
```  
  
 <span data-ttu-id="4a435-208">Написание скрипта с подобной логикой для задания резервного копирования позволяет планировать запуск задания на каждой реплике доступности по одинаковому расписанию.</span><span class="sxs-lookup"><span data-stu-id="4a435-208">Scripting a backup job with this logic enables you to schedule the job to run on every availability replica on the same schedule.</span></span> <span data-ttu-id="4a435-209">Каждое из данных заданий обращается к одним и тем же данным для определения того, какие задания следует выполнить, поэтому для создания резервной копии фактически обрабатывается только одно запланированное задание.</span><span class="sxs-lookup"><span data-stu-id="4a435-209">Each of these jobs looks at the same data to determine which job should run, so only one of the scheduled job actually proceeds to the backup stage.</span></span>  <span data-ttu-id="4a435-210">В случае отработки отказа не приходится изменять ни один из скриптов или заданий.</span><span class="sxs-lookup"><span data-stu-id="4a435-210">In the event of a failover, none of the scripts or jobs needs to be modified.</span></span> <span data-ttu-id="4a435-211">Кроме того, если перенастроить группу доступности для добавления реплики доступности, то для управления заданиями резервного копирования потребуется просто скопировать или запланировать задание.</span><span class="sxs-lookup"><span data-stu-id="4a435-211">Also, if you reconfigure an availability group to add an availability replica, managing the backup job requires simply copying or scheduling the backup job.</span></span> <span data-ttu-id="4a435-212">В случае удаления реплики доступности просто удалите задание резервного копирования с экземпляра сервера, на котором размещалась эта реплика.</span><span class="sxs-lookup"><span data-stu-id="4a435-212">If you remove an availability replica, simply delete the backup job from the server instance that hosted that replica.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="4a435-213">Если задание резервного копирования создается в[мастере планов обслуживания](../../../relational-databases/maintenance-plans/use-the-maintenance-plan-wizard.md), то в это задание автоматически включается логика скрипта, которая вызывает и проверяет функцию **sys.fn_hadr_backup_is_preferred_replica** .</span><span class="sxs-lookup"><span data-stu-id="4a435-213">If you use the[Maintenance Plan Wizard](../../../relational-databases/maintenance-plans/use-the-maintenance-plan-wizard.md)to create a given backup job, the job will automatically include the scripting logic that calls and checks the **sys.fn_hadr_backup_is_preferred_replica** function.</span></span> <span data-ttu-id="4a435-214">Однако задание резервного копирования не будет возвращать сообщение "Это не предпочтительная реплика...". Необходимо создать задания для каждой базы данных доступности на каждом экземпляре сервера, на котором размещена реплика доступности этой группы доступности.</span><span class="sxs-lookup"><span data-stu-id="4a435-214">However, the backup job will not return the "This is not the preferred replica..." message.Be sure to create the job(s) for each availability database on every server instance that hosts an availability replica for the availability group.</span></span>  
  
##  <a name="to-obtain-information-about-backup-preference-settings"></a><a name="ForInfoAboutBuPref"></a><span data-ttu-id="4a435-215">Получение сведений о параметрах настройки резервного копирования</span><span class="sxs-lookup"><span data-stu-id="4a435-215">To Obtain Information About Backup Preference Settings</span></span>  
 <span data-ttu-id="4a435-216">Ниже приводятся способы получения информации, имеющей отношение к резервному копированию во вторичных репликах.</span><span class="sxs-lookup"><span data-stu-id="4a435-216">The following are useful for obtaining information that is relevant for backup on secondary.</span></span>  
  
|<span data-ttu-id="4a435-217">Просмотр</span><span class="sxs-lookup"><span data-stu-id="4a435-217">View</span></span>|<span data-ttu-id="4a435-218">Сведения</span><span class="sxs-lookup"><span data-stu-id="4a435-218">Information</span></span>|<span data-ttu-id="4a435-219">Соответствующие столбцы</span><span class="sxs-lookup"><span data-stu-id="4a435-219">Relevant Columns</span></span>|  
|----------|-----------------|----------------------|  
|[<span data-ttu-id="4a435-220">sys.fn_hadr_backup_is_preferred_replica</span><span class="sxs-lookup"><span data-stu-id="4a435-220">sys.fn_hadr_backup_is_preferred_replica</span></span>](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql)|<span data-ttu-id="4a435-221">Является ли текущая реплика предпочитаемой репликой резервного копирования?</span><span class="sxs-lookup"><span data-stu-id="4a435-221">Is the current replica the preferred backup replica?</span></span>|<span data-ttu-id="4a435-222">Не применяется</span><span class="sxs-lookup"><span data-stu-id="4a435-222">Not applicable.</span></span>|  
|[<span data-ttu-id="4a435-223">sys.availability_groups</span><span class="sxs-lookup"><span data-stu-id="4a435-223">sys.availability_groups</span></span>](/sql/relational-databases/system-catalog-views/sys-availability-groups-transact-sql)|<span data-ttu-id="4a435-224">параметр автоматического резервного копирования</span><span class="sxs-lookup"><span data-stu-id="4a435-224">Automated backup preference</span></span>|<span data-ttu-id="4a435-225">**automated_backup_preference**</span><span class="sxs-lookup"><span data-stu-id="4a435-225">**automated_backup_preference**</span></span><br /><br /> <span data-ttu-id="4a435-226">**automated_backup_preference_desc**</span><span class="sxs-lookup"><span data-stu-id="4a435-226">**automated_backup_preference_desc**</span></span>|  
|[<span data-ttu-id="4a435-227">sys.availability_replicas</span><span class="sxs-lookup"><span data-stu-id="4a435-227">sys.availability_replicas</span></span>](/sql/relational-databases/system-catalog-views/sys-availability-replicas-transact-sql)|<span data-ttu-id="4a435-228">Приоритет резервного копирования данной реплики доступности</span><span class="sxs-lookup"><span data-stu-id="4a435-228">Backup priority of a given availability replica</span></span>|<span data-ttu-id="4a435-229">**backup_priority**</span><span class="sxs-lookup"><span data-stu-id="4a435-229">**backup_priority**</span></span>|  
|[<span data-ttu-id="4a435-230">sys.dm_hadr_availability_replica_states</span><span class="sxs-lookup"><span data-stu-id="4a435-230">sys.dm_hadr_availability_replica_states</span></span>](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-availability-replica-states-transact-sql)|<span data-ttu-id="4a435-231">Является реплика локальной по отношению к экземпляру сервера?</span><span class="sxs-lookup"><span data-stu-id="4a435-231">Is replica local to the server instance?</span></span><br /><br /> <span data-ttu-id="4a435-232">Текущая роль.</span><span class="sxs-lookup"><span data-stu-id="4a435-232">Current role</span></span><br /><br /> <span data-ttu-id="4a435-233">Состояние работы</span><span class="sxs-lookup"><span data-stu-id="4a435-233">Operational state</span></span><br /><br /> <span data-ttu-id="4a435-234">Состояние подключения</span><span class="sxs-lookup"><span data-stu-id="4a435-234">Connected state</span></span><br /><br /> <span data-ttu-id="4a435-235">Исправность синхронизации реплики доступности</span><span class="sxs-lookup"><span data-stu-id="4a435-235">Synchronization health of an availability replica</span></span>|<span data-ttu-id="4a435-236">**is_local**</span><span class="sxs-lookup"><span data-stu-id="4a435-236">**is_local**</span></span><br /><br /> <span data-ttu-id="4a435-237">**role**, **role_desc**</span><span class="sxs-lookup"><span data-stu-id="4a435-237">**role**, **role_desc**</span></span><br /><br /> <span data-ttu-id="4a435-238">**operational_state**, **operational_state_desc**</span><span class="sxs-lookup"><span data-stu-id="4a435-238">**operational_state**, **operational_state_desc**</span></span><br /><br /> <span data-ttu-id="4a435-239">**connected_state**, **connected_state_desc**</span><span class="sxs-lookup"><span data-stu-id="4a435-239">**connected_state**, **connected_state_desc**</span></span><br /><br /> <span data-ttu-id="4a435-240">**synchronization_health**, **synchronization_health_desc**</span><span class="sxs-lookup"><span data-stu-id="4a435-240">**synchronization_health**, **synchronization_health_desc**</span></span>|  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="4a435-241">См. также</span><span class="sxs-lookup"><span data-stu-id="4a435-241">Related Content</span></span>  
  
-   [<span data-ttu-id="4a435-242">Руководство по решениям режима AlwaysOn в Microsoft SQL Server для обеспечения высокой доступности и аварийного восстановления</span><span class="sxs-lookup"><span data-stu-id="4a435-242">Microsoft SQL Server AlwaysOn Solutions Guide for High Availability and Disaster Recovery</span></span>](https://go.microsoft.com/fwlink/?LinkId=227600)  
  
-   [<span data-ttu-id="4a435-243">Блог группы разработчиков SQL Server AlwaysOn: официальный блог группы разработчиков SQL Server AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="4a435-243">SQL Server AlwaysOn Team Blog: The official SQL Server AlwaysOn Team Blog</span></span>](https://blogs.msdn.com/b/sqlalwayson/)  
  
## <a name="see-also"></a><span data-ttu-id="4a435-244">См. также:</span><span class="sxs-lookup"><span data-stu-id="4a435-244">See Also</span></span>  
 <span data-ttu-id="4a435-245">[Общие сведения о группы доступности AlwaysOn &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="4a435-245">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 [<span data-ttu-id="4a435-246">Активные вторичные реплики, резервное копирование на вторичных репликах (группы доступности AlwaysOn)</span><span class="sxs-lookup"><span data-stu-id="4a435-246">Active Secondaries: Backup on Secondary Replicas (AlwaysOn Availability Groups)</span></span>](active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md) 
