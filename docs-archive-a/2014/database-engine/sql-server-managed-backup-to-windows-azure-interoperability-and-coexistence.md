---
title: 'SQL Server управляемого резервного копирования в Azure: взаимодействие и сосуществование | Документация Майкрософт'
description: В этой статье описывается SQL Server управляемого резервного копирования для Microsoft Azure взаимодействия и сосуществования с несколькими функциями в SQL Server 2014.
ms.custom: ''
ms.date: 03/07/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 78fb78ed-653f-45fe-a02a-a66519bfee1b
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: 2e2839fc4755fe47504e42e5058a5da117888900
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/04/2020
ms.locfileid: "87732893"
---
# <a name="sql-server-managed-backup-to-azure-interoperability-and-coexistence"></a><span data-ttu-id="3f39d-103">Управляемое резервное копирование SQL Server в Azure: Возможности взаимодействия и совместной работы</span><span class="sxs-lookup"><span data-stu-id="3f39d-103">SQL Server Managed Backup to Azure: Interoperability and Coexistence</span></span>
  <span data-ttu-id="3f39d-104">В этом разделе описываются вопросы взаимодействия и совместной работы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] с некоторыми функциями в [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="3f39d-104">This topic describes [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] interoperability and coexistence with several features in [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="3f39d-105">К таким функциям относятся следующие: группы доступности AlwaysOn, зеркальное отображение базы данных, планы обслуживания резервного копирования, Доставка журналов, нерегламентированные резервные копии, отсоединение базы данных и удаление базы данных.</span><span class="sxs-lookup"><span data-stu-id="3f39d-105">These features include the following: AlwaysOn Availability Groups, Database Mirroring, Backup Maintenance Plans, Log Shipping, Ad hoc backups, Detach Database, and Drop Database.</span></span>  
  
### <a name="alwayson-availability-groups"></a><span data-ttu-id="3f39d-106">Группы доступности AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="3f39d-106">AlwaysOn Availability Groups</span></span>  
 <span data-ttu-id="3f39d-107">Группы доступности AlwaysOn, настроенные как решение только для Azure, поддерживаемое для [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="3f39d-107">AlwaysOn Availability Groups that are configured as an Azure-only solution supported for [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="3f39d-108">Не поддерживаются только локальные либо гибридные конфигурации групп доступности AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="3f39d-108">On-premises only, or Hybrid AlwaysOn Availability Group configurations are not supported.</span></span> <span data-ttu-id="3f39d-109">Дополнительные сведения и другие рекомендации см. [в разделе Настройка управляемого резервного копирования SQL Server в Azure для групп доступности](../../2014/database-engine/setting-up-sql-server-managed-backup-to-windows-azure-for-availability-groups.md) .</span><span class="sxs-lookup"><span data-stu-id="3f39d-109">For more information and other considerations, see [Setting up SQL Server Managed Backup to Azure for Availability Groups](../../2014/database-engine/setting-up-sql-server-managed-backup-to-windows-azure-for-availability-groups.md)</span></span>  
  
### <a name="database-mirroring"></a><span data-ttu-id="3f39d-110">Зеркальное отображение базы данных</span><span class="sxs-lookup"><span data-stu-id="3f39d-110">Database Mirroring</span></span>  
 <span data-ttu-id="3f39d-111">Службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] поддерживаются только в основной базе данных.</span><span class="sxs-lookup"><span data-stu-id="3f39d-111">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is supported only on the principal database.</span></span> <span data-ttu-id="3f39d-112">Если использование [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] настроено как на основной, так и на зеркальной базе данных, зеркальная база данных будет пропущена и ее резервное копирование выполнено не будет.</span><span class="sxs-lookup"><span data-stu-id="3f39d-112">If both the principal and the mirror are configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], the mirrored database is skipped and will not be backed up.</span></span> <span data-ttu-id="3f39d-113">Однако в случае отработки отказа [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] запустит процесс резервного копирования, после того как зеркальный сервер завершит переключение ролей и подключится к сети.</span><span class="sxs-lookup"><span data-stu-id="3f39d-113">However, in the event of a failover, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will start the backup process after the mirror has completed role switching and is online.</span></span> <span data-ttu-id="3f39d-114">В этом случае резервные копии будут сохраняться в новом контейнере.</span><span class="sxs-lookup"><span data-stu-id="3f39d-114">The backups will be stored in a new container in this case.</span></span> <span data-ttu-id="3f39d-115">Если зеркальный сервер не настроен для использования [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], при отработке отказа резервное копирование производиться не будет.</span><span class="sxs-lookup"><span data-stu-id="3f39d-115">If the mirror is not configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], in the event of a failover, no backups are taken.</span></span> <span data-ttu-id="3f39d-116">Рекомендуется настраивать [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] и в основной и в зеркальной базе данных, чтобы резервное копирование продолжалось и в случае отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="3f39d-116">We recommend that you configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] on both the principal and the mirror so backups continue in the event of a failover.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="3f39d-117">При создании зеркальной базы данных на экземпляре с параметрами [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] по умолчанию может быть целесообразно отключить настройки [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] по умолчанию для экземпляра, чтобы они не применялись к зеркальной базе данных, а затем включить настройки по умолчанию для экземпляра после настройки основной и зеркальной баз данных.</span><span class="sxs-lookup"><span data-stu-id="3f39d-117">If you are creating a mirrored database on an instance with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] default settings, it may be preferable to disable [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] instance defaults, so they are not applied to the mirrored database, and then re-enable the instance defaults after configuring the Principal and the Mirror.</span></span>  
  
### <a name="maintenance-plan"></a><span data-ttu-id="3f39d-118">План обслуживания</span><span class="sxs-lookup"><span data-stu-id="3f39d-118">Maintenance Plan</span></span>  
 <span data-ttu-id="3f39d-119">Применение планов обслуживания для создания резервных копий для базы данных при включенном [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="3f39d-119">Using Maintenance Plans for creating backups for a database when [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is enabled is not supported.</span></span> <span data-ttu-id="3f39d-120">Планы обслуживания приведут к разрывам цепочки журналов, и [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], возможно, не обеспечит гарантируемую восстанавливаемость базы данных во время восстановления.</span><span class="sxs-lookup"><span data-stu-id="3f39d-120">Maintenance plans will cause broken log chain and [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] may not be able to support a guaranteed recoverability of the database during restore.</span></span> <span data-ttu-id="3f39d-121">Это также актуально, если службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] включены на уровне экземпляра.</span><span class="sxs-lookup"><span data-stu-id="3f39d-121">This also applies when [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is enabled at the instance level.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="3f39d-122">Планы обслуживания с резервными копиями только для копирования поддерживаются для [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], настроенного для той же базы данных или экземпляра.</span><span class="sxs-lookup"><span data-stu-id="3f39d-122">Maintenance Plans with Copy Only backups is supported with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configured for the same database or instance.</span></span>  
  
### <a name="log-shipping"></a><span data-ttu-id="3f39d-123">Доставка журналов</span><span class="sxs-lookup"><span data-stu-id="3f39d-123">Log Shipping</span></span>  
 <span data-ttu-id="3f39d-124">Нельзя настроить одновременно доставку журналов и [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для одной базы данных.</span><span class="sxs-lookup"><span data-stu-id="3f39d-124">You cannot configure Log Shipping and [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the same database at the same time.</span></span> <span data-ttu-id="3f39d-125">Это может повлиять на восстанавливаемость базы данных с помощью любой из функций.</span><span class="sxs-lookup"><span data-stu-id="3f39d-125">Doing so will affect the recoverability of the database using either functionality.</span></span>  
  
### <a name="ad-hoc-backups-using-transact-sql-and-sql-server-management-studio"></a><span data-ttu-id="3f39d-126">Нерегламентированное резервное копирование с помощью Transact-SQL и SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="3f39d-126">Ad Hoc Backups Using Transact-SQL and SQL Server Management Studio</span></span>  
 <span data-ttu-id="3f39d-127">Нерегламентированные или разовые резервные копии, созданные не в [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] с помощью Transact-SQL или SQL Server Management Studio, могут влиять на [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] в зависимости от типа резервной копии и используемого носителя хранения.</span><span class="sxs-lookup"><span data-stu-id="3f39d-127">Ad hoc or one time backups created outside [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] using Transact-SQL or SQL Server Management Studio may affect the [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] process depending on the type of backup and the storage media used.</span></span> <span data-ttu-id="3f39d-128">Резервные копии журналов в учетной записи хранения Azure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] , отличной от используемой, или других назначений, отличных от службы хранилища BLOB-объектов Azure, приведут к разрыву цепочки журналов.</span><span class="sxs-lookup"><span data-stu-id="3f39d-128">Log backups to a different Azure storage account than what [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is using, or any other destination than the Azure Blob storage service, will cause a log chain break.</span></span> <span data-ttu-id="3f39d-129">Для запуска резервного копирования в включенных базах данных рекомендуется использовать хранимую процедуру [smart_admin. sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql) [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="3f39d-129">We recommend that you use the [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql) stored procedure to initiate a backup on databases that have [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] enabled.</span></span> <span data-ttu-id="3f39d-130">С помощью этой хранимой процедуры можно инициировать резервное копирование либо всей базы данных, либо только журнала.</span><span class="sxs-lookup"><span data-stu-id="3f39d-130">You can initiate either a full database or log backup using this stored procedure.</span></span>  
  
### <a name="drop-database-and-detach-database"></a><span data-ttu-id="3f39d-131">Удаление и отсоединение базы данных</span><span class="sxs-lookup"><span data-stu-id="3f39d-131">Drop Database and Detach Database</span></span>  
 <span data-ttu-id="3f39d-132">При удалении или отсоединении базы данных с включенным [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] предыдущие резервные копии остаются в хранилище до истечения срока хранения (после чего они удаляются), хотя создание дополнительных резервных копий невозможно.</span><span class="sxs-lookup"><span data-stu-id="3f39d-132">If a database that has [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] enabled is detached or dropped, although no additional backups are possible, the previous backups remain in the storage until the retention period has elapsed, at which point the backups will be purged.</span></span>  
  
### <a name="changes-to-recovery-model"></a><span data-ttu-id="3f39d-133">Изменение модели восстановления</span><span class="sxs-lookup"><span data-stu-id="3f39d-133">Changes to Recovery Model</span></span>  
  
-   <span data-ttu-id="3f39d-134">При изменении модели восстановления базы данных с **Simple** на **полная** или с **неполным**протоколированием можно настроить [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для базы данных.</span><span class="sxs-lookup"><span data-stu-id="3f39d-134">If you change the recovery model of a database from **Simple** to **Full** or **Bulk-Logged**, you have the option of configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the database.</span></span> <span data-ttu-id="3f39d-135">Со стороны [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] это будет рассматриваться как новая база данных.</span><span class="sxs-lookup"><span data-stu-id="3f39d-135">This will be considered like a new database from [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] perspective.</span></span>  
  
-   <span data-ttu-id="3f39d-136">Если изменить модель восстановления базы данных с **полной** на **простую**или с **неполным** протоколированием на Simple, то [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] операции резервного копирования больше не будут планироваться.</span><span class="sxs-lookup"><span data-stu-id="3f39d-136">If you change the recovery model of a database from **Full** or **Bulk-Logged** to **Simple**, that has [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] enabled, backup operations will no longer be scheduled.</span></span> <span data-ttu-id="3f39d-137">Параметр срока хранения останется активным, а файлы резервной копии останутся в учетной записи хранения до истечения срока хранения.</span><span class="sxs-lookup"><span data-stu-id="3f39d-137">The retention period setting will still be active and backup files will remain in the storage account until the retention period has elapsed.</span></span> <span data-ttu-id="3f39d-138">Если нужно сохранить резервные копии, рекомендуется загрузить файлы в другую учетную запись хранения или в локальное местоположение.</span><span class="sxs-lookup"><span data-stu-id="3f39d-138">If you want to retain the backups, we recommend that you download the files either to a different storage account or to an on-premises location.</span></span> <span data-ttu-id="3f39d-139">Параметры конфигурации сохраняются, и их можно использовать повторно, если для модели восстановления установлено значение **Full** или с **неполным протоколированием** .</span><span class="sxs-lookup"><span data-stu-id="3f39d-139">The configuration settings are retained and can be reused if the recovery model is set back to **Full** or **Bulk-Logged** again.</span></span>  
  
### <a name="log-backups-using-other-backup-tools-or-custom-scripts"></a><span data-ttu-id="3f39d-140">Резервное копирование журнала с применением других средств резервного копирования или пользовательских скриптов</span><span class="sxs-lookup"><span data-stu-id="3f39d-140">Log Backups Using Other Backup Tools or Custom Scripts</span></span>  
 <span data-ttu-id="3f39d-141">Любые две операции резервного копирования, настроенные для выполнения резервного копирования журналов на одной базе данных, вызовут разрыв в цепочке копирования журналов.</span><span class="sxs-lookup"><span data-stu-id="3f39d-141">Any two backups that are configured to perform log backups on the same database will cause break in the backup log chain.</span></span> <span data-ttu-id="3f39d-142">Безусловно, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] попытается обойти разрыв в цепочке резервного копирования, запланировав полное резервное копирование при его обнаружении, но это не устранит разрывы, периодически возникающие при копировании журнала двумя конкурирующими средствами.</span><span class="sxs-lookup"><span data-stu-id="3f39d-142">Although [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will attempt to remedy the break in the backup chain by scheduling full backups when a break in chain is detected, this means keeping up continuously with periodic breaks and log backups performed by two competing tools.</span></span> <span data-ttu-id="3f39d-143">Это также может повлиять на восстановимость базы данных, поскольку не гарантируется, что какой-либо из инструментов будет всегда иметь полный набор последовательных резервных копий.</span><span class="sxs-lookup"><span data-stu-id="3f39d-143">This can also potentially affect the recoverability of the database since no one tool can be expected to have a full set of backup in sequence.</span></span> <span data-ttu-id="3f39d-144">Хоть это и относится к любым двум компонентам или инструментам, выполняющим резервное копирование журналов, будет полезно рассмотреть конкретные примеры, описанные ниже.</span><span class="sxs-lookup"><span data-stu-id="3f39d-144">Although this applies to any two features or tools performing log backups,, it is useful to call out specific examples as described below.</span></span> <span data-ttu-id="3f39d-145">Это также относится к проблемам, связанным с настройкой планов обслуживания или доставкой журналов, которые описаны в предыдущих подразделах данного раздела.</span><span class="sxs-lookup"><span data-stu-id="3f39d-145">This is also the basis for the issues with configuring maintenance plans or log shipping as described in earlier sections of this topic.</span></span>  
  
 <span data-ttu-id="3f39d-146">**Резервные копии на основе Data Protection Manager (DPM):** Microsoft Data Protection Manager позволяет выполнять полное и добавочное резервное копирование.</span><span class="sxs-lookup"><span data-stu-id="3f39d-146">**Data Protection Manager (DPM) based backups:** Microsoft Data Protection Manager allows you to do full and incremental backups.</span></span> <span data-ttu-id="3f39d-147">Добавочные резервные копии — это копии журнала, которые выполняют усечение журнала после создания резервной копии T-журнала.</span><span class="sxs-lookup"><span data-stu-id="3f39d-147">The incremental backups are log backups that do perform a log truncation after creating a T-log backup.</span></span> <span data-ttu-id="3f39d-148">Поэтому не поддерживается настройка и DPM и [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для одной и той же базы данных.</span><span class="sxs-lookup"><span data-stu-id="3f39d-148">So configuring both DPM and [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the same database is not supported.</span></span>  
  
 <span data-ttu-id="3f39d-149">**Сторонние средства или скрипты:** Любые сторонние средства или сценарии, выполняющие резервное копирование журналов, которые вызывают усечение журнала, несовместимы с [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] , и не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="3f39d-149">**Third Party Tools or Scripts:** Any third party tool or scripts that perform log backups causing log truncation is incompatible with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], and is not supported.</span></span>  
  
 <span data-ttu-id="3f39d-150">Если вы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] включили экземпляр базы данных и хотите создать нерегламентированную резервную копию, можно использовать [smart_admin. sp_backup_on_demand &#40;хранимую процедуру TRANSACT-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql) , как описано в предыдущем разделе.</span><span class="sxs-lookup"><span data-stu-id="3f39d-150">If you have [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] enabled for a database instance, and you want to take an ad hoc backup you can either use the [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql) stored procedure as described in the earlier section.</span></span> <span data-ttu-id="3f39d-151">Если требуется также периодически делать резервные копии вне пределов [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], можно использовать функции резервного копирования только с копированием.</span><span class="sxs-lookup"><span data-stu-id="3f39d-151">If you also have a need to schedule or un backups periodically outside of [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], you can use the Copy Only Backup.</span></span>  <span data-ttu-id="3f39d-152">Дополнительные сведения см. в разделе [Резервные копии только для копирования (SQL Server)](../relational-databases/backup-restore/copy-only-backups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3f39d-152">For more information, see [Copy-Only Backups &#40;SQL Server&#41;](../relational-databases/backup-restore/copy-only-backups-sql-server.md).</span></span>  
  
  
